<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fire_injection</title>
  <meta name="keywords" content="fire_injection">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="#">machine</a> &gt; <a href="#">Soleil</a> &gt; <a href="../index.html">common</a> &gt; <a href="index.html">synchro</a> &gt; fire_injection.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for machine/Soleil/common/synchro&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>fire_injection
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [r1,r2]=fire_injection(handles) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="get_start_clk_rafale.html" class="code" title="function [clk1,clk2]=get_start_clk_rafale">get_start_clk_rafale</a>	</li><li><a href="getcharge.html" class="code" title="function  [q1,q2,n]=getcharge(q1,q2,n)">getcharge</a>	calcul efficacité</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="synchro_injecteur7_rafale.html" class="code" title="function varargout = synchro_injecteur7_rafale(varargin)">synchro_injecteur7_rafale</a>	SYNCHRO_INJECTEUR7_RAFALE M-file for synchro_injecteur7_rafale.fig</li><li><a href="synchro_injecteur8_rafale.html" class="code" title="function varargout = synchro_injecteur8_rafale(varargin)">synchro_injecteur8_rafale</a>	SYNCHRO_INJECTEUR8_RAFALE M-file for synchro_injecteur8_rafale.fig</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [r1,r2]=fire_injection(handles)</a>
0002 
0003 set(handles.button_injection_soft,<span class="string">'Enable'</span>,<span class="string">'inactive'</span>);
0004 
0005 offset_linac=10*str2double(get(handles.lin_canon_spm_fin,<span class="string">'String'</span>));     <span class="comment">% dÃ©lai fin de rÃ©glage en pas de 100 ps</span>
0006 <span class="comment">%modeinj=get(get(handles.uipanel_mode,'SelectedObject'),'Tag');           % mode soft ou 3Hz</span>
0007 modeinj=<span class="string">'togglebutton_3Hz'</span>;
0008 modecent=get(get(handles.uipanel_central_mode,<span class="string">'SelectedObject'</span>),<span class="string">'Tag'</span>);  <span class="comment">% mode rafale ou continu (cas 3Hz)</span>
0009 modefill=get(handles.listbox_fillingmode,<span class="string">'Value'</span>);
0010 pattern= get(handles.listbox_fillingmode,<span class="string">'String'</span>);                      <span class="comment">% mode de remplissage</span>
0011 [clk1,clk2]=<a href="get_start_clk_rafale.html" class="code" title="function [clk1,clk2]=get_start_clk_rafale">get_start_clk_rafale</a>;                                        <span class="comment">% get clk spare et soft initiaux</span>
0012 table=handles.table;                                                     <span class="comment">% table de dÃ©lais</span>
0013 
0014 
0015 <span class="comment">%FileName = fullfile(getfamilydata('Directory', 'Synchro'), 'table.mat');</span>
0016 FileName = [handles.DirName <span class="string">'table.mat'</span>];
0017 load(FileName, <span class="string">'table'</span>);     <span class="comment">% pour palier aux handles via timer non mis Ã  jour !!!!!!</span>
0018 nb=table(1) ;                <span class="comment">% Nombre de paq</span>
0019 dtour=table(2:1+nb);         <span class="comment">% delais associÃ©s extraction, tour booster</span>
0020 paq  =table(2+nb:1+2*nb);    <span class="comment">% delais associÃ©s linac, saut de paquets</span>
0021 
0022 
0023 dt=1.5; <span class="comment">% dÃ©lais pour acquisitions rendements</span>
0024 
0025 <span class="comment">%Initialise data pour les rendements</span>
0026 <span class="keyword">try</span>
0027     q1=0;q2=0;n=0;
0028     temp=tango_read_attribute2(<span class="string">'ANS/DG/DCCT-CTRL'</span>,<span class="string">'current'</span>);anscur0=temp.value;
0029     <span class="comment">%temp=tango_read_attribute2('ANS-C14/DG/DCCT','current');anscur0=temp.value;</span>
0030 <span class="keyword">catch</span>
0031     disp(<span class="string">'Erreur lecture DCCT, skipped'</span>)
0032     anscur0=0;
0033 <span class="keyword">end</span>
0034 
0035 boucle=int16(str2double(get(handles.edit_Ncycle,<span class="string">'String'</span>)));
0036 Ncoup=str2double(get(handles.edit_Ncoup,<span class="string">'String'</span>));
0037 
0038 <span class="keyword">if</span> strcmp(modeinj,<span class="string">'togglebutton_soft'</span>)
0039     modeinj=<span class="string">'Injection soft'</span>;
0040     <span class="keyword">for</span> k=1:boucle
0041         <span class="keyword">for</span> i=1:nb
0042             clk_spare  =int32(clk1+dtour(i));
0043             clk_soft=int32(clk2+dtour(i));
0044             table0=int32([1 0 paq(i)]);
0045             tango_command_inout2(<span class="string">'ANS/SY/CENTRAL'</span>,<span class="string">'SetTables'</span>,table0); pause(0.2)  ;
0046             tango_write_attribute2(<span class="string">'ANS/SY/CENTRAL'</span>, <span class="string">'TSprStepDelay'</span>,clk_spare);
0047             tango_write_attribute2(<span class="string">'ANS/SY/CENTRAL'</span>, <span class="string">'TSoftStepDelay'</span>,clk_soft);
0048             tango_command_inout2(<span class="string">'ANS/SY/CENTRAL'</span>,<span class="string">'FireSoftEvent'</span>);
0049             pause(dt)
0050             [q1,q2,n]=<a href="getcharge.html" class="code" title="function  [q1,q2,n]=getcharge(q1,q2,n)">getcharge</a>(q1,q2,n);
0051         <span class="keyword">end</span>
0052     <span class="keyword">end</span>
0053 
0054     <span class="comment">% retour dÃ©lais initiaux</span>
0055     tango_write_attribute2(<span class="string">'ANS/SY/CENTRAL'</span>, <span class="string">'TSprStepDelay'</span>,clk1);
0056     tango_write_attribute2(<span class="string">'ANS/SY/CENTRAL'</span>, <span class="string">'TSoftStepDelay'</span>,clk2);
0057 
0058 <span class="keyword">elseif</span> strcmp(modeinj,<span class="string">'togglebutton_3Hz'</span>)
0059 
0060     <span class="keyword">if</span> strcmp(modecent,<span class="string">'continuous_mode'</span>)
0061 
0062         <span class="comment">%             modelinac=get(get(handles.uipanel_lpm_spm_mode,'SelectedObject'),'Tag');</span>
0063         <span class="comment">%             switch modelinac  % Get Tag of selected object</span>
0064         <span class="comment">%                 case 'no_mode'</span>
0065         <span class="comment">%                     event=[0 0];</span>
0066         <span class="comment">%                 case 'lpm_mode'</span>
0067         <span class="comment">%                     event=[2 0];</span>
0068         <span class="comment">%                 case 'spm_mode'</span>
0069         <span class="comment">%                     event=[0 2];</span>
0070         <span class="comment">%             end</span>
0071         <span class="comment">%</span>
0072         <span class="comment">%             modeinj='Injection 3 Hz';</span>
0073         <span class="comment">%             start_3Hz(event)</span>
0074         <span class="comment">%             pause(Ncoup*0.340 + 0.340)</span>
0075         <span class="comment">%             stop_3Hz</span>
0076 
0077     <span class="keyword">elseif</span> strcmp(modecent,<span class="string">'burst_mode'</span>)
0078 
0079         modeinj=<span class="string">'Injection rafale'</span>;
0080         tango_command_inout2(<span class="string">'ANS/SY/CENTRAL'</span>,<span class="string">'FireBurstEvent'</span>);
0081         dtt=Ncoup*boucle*0.340 + 5;
0082         pause(dtt) <span class="comment">% durée rafale + pause lecture DCCT</span>
0083         [q1,q2,n]=<a href="getcharge.html" class="code" title="function  [q1,q2,n]=getcharge(q1,q2,n)">getcharge</a>(q1,q2,n);
0084     <span class="keyword">end</span>
0085 <span class="keyword">end</span>
0086 
0087 <span class="comment">% Calcul des rendements</span>
0088 <span class="comment">%pause(dt);</span>
0089 <span class="keyword">try</span>
0090     temp=tango_read_attribute2(<span class="string">'ANS/DG/DCCT-CTRL'</span>,<span class="string">'current'</span>);anscur=temp.value;
0091     <span class="comment">%temp=tango_read_attribute2('ANS-C14/DG/DCCT','current');anscur=temp.value;</span>
0092 <span class="keyword">catch</span>
0093     disp(<span class="string">'Erreur lecture DCCT, skipped'</span>)
0094     anscur=0;
0095 <span class="keyword">end</span>
0096 <span class="comment">%modeinj=get(get(handles.uipanel_mode,'SelectedObject'),'Tag');</span>
0097 modinj=<span class="string">'togglebutton_3Hz'</span>;
0098 dcur=anscur-anscur0;
0099 <span class="keyword">if</span> strcmp(modeinj,<span class="string">'togglebutton_soft'</span>)
0100     <span class="comment">% moyenne sur chaque tirs</span>
0101     r1=0;<span class="keyword">if</span> (q1~=0);r1=q2/q1*100;<span class="keyword">end</span>
0102     r2=0;<span class="keyword">if</span> (q2~=0);r2=dcur/q2*0.524*416/184*100;<span class="keyword">end</span>
0103     <span class="keyword">if</span>(r1&lt;0);r1=0;<span class="keyword">elseif</span>(r1&gt;100);r1=100;<span class="keyword">end</span>
0104     <span class="keyword">if</span>(r2&lt;0);r2=0;<span class="keyword">elseif</span>(r2&gt;100);r2=100;<span class="keyword">end</span>
0105     q1=q1/n;q2=q2/n;dcur=dcur/n;
0106 <span class="keyword">else</span>
0107     <span class="comment">% estime sur dernier tir</span>
0108     r1=0;<span class="keyword">if</span> (q1~=0);r1=q2/q1*100;<span class="keyword">end</span>
0109     r2=0;<span class="keyword">if</span> (q2~=0);r2=dcur/Ncoup/double(boucle)/q2*0.524*416/184*100;<span class="keyword">end</span>
0110     <span class="keyword">if</span>(r1&lt;0);r1=0;<span class="keyword">elseif</span>(r1&gt;100);r1=100;<span class="keyword">end</span>
0111     <span class="keyword">if</span>(r2&lt;0);r2=0;<span class="keyword">elseif</span>(r2&gt;100);r2=100;<span class="keyword">end</span>
0112     q1=q1/n;q2=q2/n;dcur=dcur/n;
0113 <span class="keyword">end</span>
0114 
0115 set(handles.edit_qlt1,<span class="string">'String'</span>,num2str(q1,<span class="string">'%5.2f'</span>));
0116 set(handles.edit_iboo,<span class="string">'String'</span>,num2str(q2/0.524,<span class="string">'%5.2f'</span>));
0117 set(handles.edit_dians,<span class="string">'String'</span>,num2str(dcur,<span class="string">'%5.2f'</span>));
0118 set(handles.edit_rboo,<span class="string">'String'</span>,num2str(int16(r1)));
0119 set(handles.edit_rans,<span class="string">'String'</span>,num2str(int16(r2)));
0120 set(handles.edit_cycle,<span class="string">'String'</span>,num2str(n,<span class="string">'%g'</span>));
0121 set(handles.edit_dians1,<span class="string">'String'</span>,num2str(dcur,<span class="string">'%5.2f'</span>));
0122 set(handles.edit_courant_total,<span class="string">'String'</span>, num2str(anscur,<span class="string">'%5.2f'</span>));
0123 
0124 <span class="keyword">try</span>
0125     temp=tango_read_attribute2(<span class="string">'ANS/DG/BPM-tunex'</span>,<span class="string">'Nu'</span>); nux=temp.value;
0126     temp=tango_read_attribute2(<span class="string">'ANS/DG/BPM-tunez'</span>,<span class="string">'Nu'</span>); nuz=temp.value;
0127     temp=tango_read_attribute2(<span class="string">'ANS-C03/RF/lle.1'</span>,<span class="string">'voltageRF'</span>);v1=temp.value(1);
0128     temp=tango_read_attribute2(<span class="string">'ANS-C03/RF/lle.2'</span>,<span class="string">'voltageRF'</span>);v2=temp.value(1);
0129     temp=tango_read_attribute2(<span class="string">'ANS-C02/RF/lle.3'</span>,<span class="string">'voltageRF'</span>);v3=temp.value(1);
0130     temp=tango_read_attribute2(<span class="string">'ANS-C02/RF/lle.4'</span>,<span class="string">'voltageRF'</span>);v4=temp.value(1);
0131     vrf=(v1+v2+v3+v4)/1000;
0132 <span class="keyword">catch</span>
0133     disp(<span class="string">'Erreur lecture tunes voltage : skipped'</span>)
0134     nux = NaN;
0135     nuz = NaN;
0136     vrf = NaN;
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">% renseigne les rendements</span>
0140 <span class="keyword">try</span>
0141     tango_write_attribute2(<span class="string">'ANS/DG/PUB-FillingMode'</span>, <span class="string">'rendement_BOO'</span>,r1)
0142     tango_write_attribute2(<span class="string">'ANS/DG/PUB-FillingMode'</span>, <span class="string">'rendement_ANS'</span>,r2)
0143 <span class="keyword">catch</span>
0144 
0145 <span class="keyword">end</span>
0146 
0147 txt=modeinj;
0148 txt(1:13)=<span class="string">''</span>;
0149 fprintf(<span class="string">'%s  /  %s  %d Coups  %s  /  R=%5.2f %5.2f   I=%5.3f A  /  Tunes=%5.3f %5.3f  Vrf=%5.2f MV\n'</span>,<span class="keyword">...</span>
0150     datestr(clock),txt,Ncoup*boucle,pattern{modefill},r1,r2,anscur, nux,nuz,vrf);
0151 
0152 
0153 set(handles.button_injection_soft,<span class="string">'Enable'</span>,<span class="string">'On'</span>);
0154</pre></div>
<hr><address>Generated on Fri 23-Jul-2010 00:42:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>