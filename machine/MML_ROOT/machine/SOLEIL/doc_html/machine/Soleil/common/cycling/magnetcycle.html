<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of magnetcycle</title>
  <meta name="keywords" content="magnetcycle">
  <meta name="description" content="MAGNETCYCLE - Standardize machine magnets">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="#">machine</a> &gt; <a href="#">Soleil</a> &gt; <a href="../index.html">common</a> &gt; <a href="index.html">cycling</a> &gt; magnetcycle.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for machine/Soleil/common/cycling&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>magnetcycle
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>MAGNETCYCLE - Standardize machine magnets</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function magnetcycle(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MAGNETCYCLE - Standardize machine magnets

  INPUTS
  1. LatticeFile -'Present' {Default} - cycle to present setpoints
                  'Golden'  - cycle to the golden lattice setpoints
                  'UserSelect' - cycle to a selected file (a pop up to choose will be displayed)
                   LatticeFilename - cycle to the ConfigSetpoint in that file

  Optional input arguments
  2. Cells of Families - for instance {'CH','CV'} or {'QP'}
  3. 'Display' or 'NoDisplay' - to verify before standardizing and display results (or not)
  4. Machine type - 'LT1', 'LT2', 'StorageRing', 'Booster'
                     Default is given by mml via getfamilydata('SubMachine')
  5. 'NoApply' - just configure but does not start cycling

  EXAMPLES
  1. magnetcycle('Golden')
  2. magnetcycle('Golden',{'CH'}) % cycle only CH family to golden
  values

 See Also <a href="setcyclecurve.html" class="code" title="function setcyclecurve(dev_name, curve)">setcyclecurve</a>, getcyclingcurve, <a href="plotcyclingcurve.html" class="code" title="function plotcyclecurve(curve)">plotcyclingcurve</a>, LT1cycling</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="cyclingcommand.html" class="code" title="function varargout= cyclecommand(varargin)">cyclingcommand</a>	CYCLINGCOMMAND - Cyclage control for magnet</li><li><a href="plotcyclingcurve.html" class="code" title="function plotcyclecurve(curve)">plotcyclingcurve</a>	</li><li><a href="setcyclecurve.html" class="code" title="function setcyclecurve(dev_name, curve)">setcyclecurve</a>	SETCYCLECURVE - Set curve for cycling magnet in Dserver</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function curve = makecyclingcurve(Inom,Imax,MagnetType,varargin)</a></li><li><a href="#_sub2" class="code">function CyclingEnd = anacycling(Families)</a></li><li><a href="#_sub3" class="code">function cyclingconfiguration(Lattice, Family, varargin);</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function magnetcycle(varargin)</a>
0002 <span class="comment">%MAGNETCYCLE - Standardize machine magnets</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  INPUTS</span>
0005 <span class="comment">%  1. LatticeFile -'Present' {Default} - cycle to present setpoints</span>
0006 <span class="comment">%                  'Golden'  - cycle to the golden lattice setpoints</span>
0007 <span class="comment">%                  'UserSelect' - cycle to a selected file (a pop up to choose will be displayed)</span>
0008 <span class="comment">%                   LatticeFilename - cycle to the ConfigSetpoint in that file</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  Optional input arguments</span>
0011 <span class="comment">%  2. Cells of Families - for instance {'CH','CV'} or {'QP'}</span>
0012 <span class="comment">%  3. 'Display' or 'NoDisplay' - to verify before standardizing and display results (or not)</span>
0013 <span class="comment">%  4. Machine type - 'LT1', 'LT2', 'StorageRing', 'Booster'</span>
0014 <span class="comment">%                     Default is given by mml via getfamilydata('SubMachine')</span>
0015 <span class="comment">%  5. 'NoApply' - just configure but does not start cycling</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  EXAMPLES</span>
0018 <span class="comment">%  1. magnetcycle('Golden')</span>
0019 <span class="comment">%  2. magnetcycle('Golden',{'CH'}) % cycle only CH family to golden</span>
0020 <span class="comment">%  values</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% See Also setcyclecurve, getcyclingcurve, plotcyclingcurve, LT1cycling</span>
0023 
0024 <span class="comment">%</span>
0025 <span class="comment">%  Written by Laurent S. Nadolski</span>
0026 
0027 <span class="comment">% TODO: Display part, cycle single element, cycle set of families (not</span>
0028 <span class="comment">% all)</span>
0029 
0030 DisplayFlag = 1;
0031 ApplyFlag = 1;
0032 
0033 LatticeFileDefault = <span class="string">'Present'</span>;
0034 ConfigFlag = 1; <span class="comment">% confirm before modifying cycling ramp</span>
0035 
0036 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0037 <span class="comment">% Input parsing and checking %</span>
0038 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0039 
0040 <span class="keyword">for</span> i = length(varargin):-1:1
0041     <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'Present'</span>)
0042         LatticeFile = <span class="string">'Present'</span>;
0043         varargin(i) = [];
0044     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Golden'</span>)
0045         LatticeFile = <span class="string">'Golden'</span>;
0046         varargin(i) = [];
0047     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'UserSelect'</span>)
0048         LatticeFile = <span class="string">'UserSelect'</span>;
0049         varargin(i) = [];
0050     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0051         DisplayFlag = 1;
0052         varargin(i) = [];
0053     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0054         DisplayFlag = 0;
0055         varargin(i) = [];
0056     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'LT1'</span>)
0057         Machine = <span class="string">'LT1'</span>;
0058         varargin(i) = [];
0059     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Booster'</span>)
0060         Machine = <span class="string">'Booster'</span>;
0061         varargin(i) = [];
0062     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'LT2'</span>)
0063         Machine = <span class="string">'LT2'</span>;
0064         varargin(i) = [];
0065     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'StorageRing'</span>)
0066         Machine = <span class="string">'StorageRing'</span>;
0067         varargin(i) = [];
0068     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoConfig'</span>)
0069         ConfigFlag = 0;
0070     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Config'</span>)
0071         ConfigFlag = 1;
0072     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Apply'</span>)
0073         ApplyFlag = 1;
0074     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoApply'</span>)
0075         ApplyFlag = 0;        
0076     <span class="keyword">elseif</span> iscell(varargin{i})
0077         Magnet = varargin{i};
0078         varargin(i) = [];
0079     <span class="keyword">end</span>
0080 <span class="keyword">end</span>
0081 
0082 <span class="keyword">if</span> ~exist(<span class="string">'LatticeFile'</span>,<span class="string">'var'</span>)
0083     LatticeFile = LatticeFileDefault;
0084 <span class="keyword">end</span>
0085 
0086 <span class="keyword">if</span> ~exist(<span class="string">'Machine'</span>,<span class="string">'var'</span>)
0087     Machine = getfamilydata(<span class="string">'SubMachine'</span>);
0088 <span class="keyword">end</span>
0089 
0090 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0091 <span class="comment">% Get the proper lattice %</span>
0092 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0093 <span class="keyword">if</span> strcmpi(LatticeFile, <span class="string">'UserSelect'</span>)
0094     [FileName, DirectoryName, FilterIndex] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a Machine Configuration File for Standardization'</span>, getfamilydata(<span class="string">'Directory'</span>, <span class="string">'ConfigData'</span>));
0095     <span class="keyword">if</span> FilterIndex == 0
0096         <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0097             fprintf(<span class="string">'   %s standardization cancelled\n'</span>, Machine);
0098         <span class="keyword">end</span>
0099         <span class="keyword">return</span>
0100     <span class="keyword">end</span>
0101     <span class="keyword">try</span>
0102         load([DirectoryName FileName]);
0103         Lattice = ConfigSetpoint;
0104     <span class="keyword">catch</span>
0105         error(<span class="string">'Problem getting data from machine configuration file\n%s'</span>,lasterr);
0106     <span class="keyword">end</span>
0107     <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0108         fprintf(<span class="string">'   Standardizing to the lattice file %s\n'</span>, [DirectoryName FileName]);
0109     <span class="keyword">end</span>
0110 <span class="keyword">elseif</span> strcmpi(LatticeFile, <span class="string">'Present'</span>)
0111     <span class="comment">% Present lattice</span>
0112     Lattice = getmachineconfig;
0113     <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0114         fprintf(<span class="string">'   Standardizing to the present lattice\n'</span>);
0115     <span class="keyword">end</span>
0116 <span class="keyword">elseif</span> strcmpi(LatticeFile, <span class="string">'Golden'</span>)
0117     <span class="comment">% Golden lattice</span>
0118     FileName = getfamilydata(<span class="string">'OpsData'</span>, <span class="string">'LatticeFile'</span>);
0119     DirectoryName = getfamilydata(<span class="string">'Directory'</span>, <span class="string">'OpsData'</span>);
0120     load([DirectoryName FileName]);
0121 
0122     Lattice = ConfigSetpoint;
0123     <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0124         fprintf(<span class="string">'   Standardizing to the golden lattice %s\n'</span>, [DirectoryName FileName]);
0125     <span class="keyword">end</span>
0126 <span class="keyword">elseif</span> ischar(LatticeFile)
0127     load(LatticeFile);
0128     Lattice = ConfigSetpoint;
0129     <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0130         fprintf(<span class="string">'   Standardizing to lattice file %s\n'</span>, LatticeFile);
0131     <span class="keyword">end</span>
0132 <span class="keyword">else</span>
0133     error(<span class="string">'Not sure what lattice to cycle to!'</span>);
0134 <span class="keyword">end</span>
0135 
0136 
0137 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0138 <span class="comment">% Query to begin measurement %</span>
0139 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0140 <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0141     tmp = questdlg([<span class="string">'Begin '</span> getfamilydata(<span class="string">'Machine'</span>) <span class="string">' standardization?'</span>], <span class="keyword">...</span>
0142         <span class="string">'MAGNETCYCLE'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0143     <span class="keyword">if</span> strcmpi(tmp,<span class="string">'No'</span>)
0144         fprintf(<span class="string">'   Lattice standardization cancelled\n'</span>);
0145         <span class="keyword">return</span>
0146     <span class="keyword">end</span>
0147 <span class="keyword">end</span>
0148 
0149 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0150 <span class="comment">% Set cycling curves</span>
0151 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0152 Family = fieldnames(Lattice);
0153 
0154 <span class="comment">% select only asked families</span>
0155 <span class="keyword">if</span> exist(<span class="string">'Magnet'</span>,<span class="string">'var'</span>) &amp;&amp; ~isempty(Magnet)
0156     <span class="keyword">if</span> iscell(Magnet)
0157         <span class="keyword">for</span> k = 1:length(Magnet),
0158             <span class="comment">% For C13 Family special trick to reconstruct the family</span>
0159             <span class="keyword">if</span> strcmpi(Magnet{k},<span class="string">'QC13'</span>)
0160                 LatticeN.QC13.Setpoint.Data = [
0161                     Lattice.Q1.Setpoint.Data(7)
0162                     Lattice.Q2.Setpoint.Data(7)
0163                     Lattice.Q3.Setpoint.Data(7)
0164                     Lattice.Q4.Setpoint.Data(13)
0165                     Lattice.Q5.Setpoint.Data(13:14)
0166                     Lattice.Q4.Setpoint.Data(14)
0167                     Lattice.Q6.Setpoint.Data(19)
0168                     Lattice.Q7.Setpoint.Data(19)
0169                     Lattice.Q8.Setpoint.Data(19)
0170                     ];
0171                 LatticeN.QC13.Setpoint.FamilyName = <span class="string">'QC13'</span>;
0172                 FamilyN{k} = Magnet{k};
0173             <span class="keyword">end</span>
0174             [temp flag] = findkeyword(Family,Magnet{k});
0175             <span class="keyword">if</span> flag
0176                 LatticeN.(Magnet{k})  = Lattice.(Magnet{k});
0177                 FamilyN{k} = Magnet{k};
0178             <span class="keyword">end</span>
0179         <span class="keyword">end</span>
0180     <span class="keyword">end</span>    
0181     Lattice = LatticeN;
0182     Family  = FamilyN';
0183     <a href="#_sub3" class="code" title="subfunction cyclingconfiguration(Lattice, Family, varargin);">cyclingconfiguration</a>(Lattice, Family, varargin{:});
0184 <span class="keyword">else</span>
0185     disp(<span class="string">'Select first a magnet!'</span>);
0186     <span class="keyword">return</span>;
0187 <span class="keyword">end</span>
0188 
0189 
0190 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
0191 <span class="comment">% Start the cycle %</span>
0192 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
0193 <span class="keyword">if</span> ApplyFlag
0194 
0195     disp(<span class="string">'  *****************************************************************'</span>);
0196     disp(<span class="string">'  **  Cycling will start!                                        **'</span>);
0197     disp(<span class="string">'  **  Are you sure to start cycling magnet                       **'</span>);
0198     disp(<span class="string">'  **                                                             **'</span>);
0199     disp(<span class="string">'  *****************************************************************'</span>);
0200 
0201     tmp = questdlg(<span class="string">'Start cycling magnet ?'</span>,<span class="string">'MAGNETCYCLE'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0202     <span class="keyword">if</span> strcmpi(tmp,<span class="string">'No'</span>)
0203         disp(<span class="string">'Cycling cancelled'</span>)
0204     <span class="keyword">else</span>
0205         disp(<span class="string">'  ** Cycling starting                                     **'</span>);
0206         Families = Family;
0207         <span class="comment">% Machine switchyard</span>
0208         <span class="keyword">switch</span> Machine
0209             <span class="keyword">case</span> {<span class="string">'LT1'</span>,<span class="string">'StorageRing'</span>,<span class="string">'LT2'</span>}
0210                 <span class="comment">% start all selected families for cycling</span>
0211                 h = waitbar(0,sprintf(<span class="string">'Starting cycling on magnets: %2d %%'</span>,0));
0212                 <span class="keyword">for</span> k1 = 1:length(Families),
0213                     Family = Families{k1};
0214                     <span class="comment">% check if family is valid and return it in AO</span>
0215                     CycleFamily = [<span class="string">'Cycle'</span> Family];
0216                     <a href="cyclingcommand.html" class="code" title="function varargout= cyclecommand(varargin)">cyclingcommand</a>(CycleFamily,<span class="string">'Start'</span>);
0217                     waitbar(k1/length(Families), h, sprintf(<span class="string">'Cycling configuration progression: %2d %%'</span>, k1/length(Families)*100))
0218                 <span class="keyword">end</span>
0219                 close(h);
0220 
0221                 CyclingEnd = 1;
0222                 <span class="comment">% Cycling</span>
0223                 <span class="keyword">while</span> ~CyclingEnd
0224                     fprintf(<span class="string">'Cycling running, %s'</span>,datestr(now));
0225                     pause(5); <span class="comment">%seconds</span>
0226                     CyclingEnd = <a href="#_sub2" class="code" title="subfunction CyclingEnd = anacycling(Families)">anacycling</a>(Families);
0227                 <span class="keyword">end</span>
0228 
0229             <span class="keyword">case</span> <span class="string">'Booster'</span>
0230                 disp(<span class="string">'Not implemented yet'</span>);
0231                 <span class="keyword">return</span>;
0232 
0233             <span class="keyword">otherwise</span>
0234                 error(<span class="string">'Unknown machine %s'</span>,Machine);
0235         <span class="keyword">end</span>
0236 
0237         <span class="keyword">if</span> strcmpi(DisplayFlag, <span class="string">'Display'</span>)
0238             fprintf(<span class="string">'   %s standardization complete\n'</span>, Machine);
0239         <span class="keyword">end</span>
0240     <span class="keyword">end</span>
0241 
0242 
0243 <span class="keyword">end</span>
0244 
0245 <span class="comment">%==========================================================================</span>
0246 <a name="_sub1" href="#_subfunctions" class="code">function curve = makecyclingcurve(Inom,Imax,MagnetType,varargin)</a>
0247 <span class="comment">% makecyclingcurve - Generates cycling curve used by Cycling Dserver</span>
0248 <span class="comment">%</span>
0249 <span class="comment">%  INPUTS</span>
0250 <span class="comment">%  1. Inom - Value at the end of cycling</span>
0251 <span class="comment">%  2. Imax - Maximum value</span>
0252 <span class="comment">%  3. MagnetType - Type of magnet ('BEND', 'Q1', 'CH', ...)</span>
0253 <span class="comment">%  Optionals parameters</span>
0254 <span class="comment">%  4. CyclingMode - Type of cycling process</span>
0255 <span class="comment">%                   'Simple' {default}</span>
0256 <span class="comment">%                   'Full'</span>
0257 <span class="comment">%                   'Startup' - after shutdown</span>
0258 <span class="comment">%  5. Machine type - 'LT1', 'LT2', 'StorageRing', 'Booster'</span>
0259 <span class="comment">%                     Default is given by mml via getfamilydata('Machine')</span>
0260 <span class="comment">%</span>
0261 <span class="comment">%</span>
0262 <span class="comment">%  OUTPUTS</span>
0263 <span class="comment">%  1. curve - 2D array discribing the cycling curve</span>
0264 <span class="comment">%             Structure of 2D array in multiple inputs</span>
0265 <span class="comment">%</span>
0266 <span class="comment">%  EXAMPLES</span>
0267 <span class="comment">%  1. makecurve(10,120,'CH')</span>
0268 <span class="comment">%  2. makecurve([10 12],[120 130],'CH')</span>
0269 <span class="comment">%</span>
0270 <span class="comment">%  NOTES</span>
0271 <span class="comment">%  1. MagnetType has to be the same for all vectorial inputs</span>
0272 <span class="comment">%</span>
0273 <span class="comment">%</span>
0274 <span class="comment">%  See Also plotcyclecurve</span>
0275 
0276 <span class="comment">%</span>
0277 <span class="comment">% Written by Laurent S. Nadolski</span>
0278 
0279 <span class="comment">% modification mars 2006 marie</span>
0280 <span class="comment">%CyclingMode = 'Simple';</span>
0281 DisplayFlag = 0;
0282 
0283 <span class="comment">%% INPUT PARSER</span>
0284 <span class="keyword">for</span> i = length(varargin):-1:1
0285     <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'Simple'</span>)
0286         CyclingMode = <span class="string">'Simple'</span>;
0287         <span class="comment">% modification mars 2006 marie</span>
0288         <span class="comment">% se justifie par le fait que varargin n'a qu'un seul argument</span>
0289         <span class="comment">%varargin(i) = [];</span>
0290     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Full'</span>)
0291         CyclingMode = <span class="string">'Full'</span>;
0292         <span class="comment">% modification mars 2006 marie</span>
0293         <span class="comment">%varargin(i) = [];</span>
0294     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Startup'</span>)
0295         CyclingMode = <span class="string">'Startup'</span>;
0296         <span class="comment">% modification mars 2006 marie</span>
0297         <span class="comment">%varargin(i) = [];</span>
0298     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'LT1'</span>)
0299         Machine = <span class="string">'LT1'</span>;
0300         varargin(i) = [];
0301     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Booster'</span>)
0302         Machine = <span class="string">'Booster'</span>;
0303         varargin(i) = [];
0304     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'LT2'</span>)
0305         Machine = <span class="string">'LT2'</span>;
0306         varargin(i) = [];
0307     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'StorageRing'</span>)
0308         Machine = <span class="string">'StorageRing'</span>;
0309         varargin(i) = [];
0310     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0311         DisplayFlag = 1;
0312         varargin(i) = [];
0313     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0314         DisplayFlag = 0;
0315         varargin(i) = [];
0316     <span class="keyword">end</span>
0317 <span class="keyword">end</span>
0318 
0319 <span class="keyword">if</span> ~ischar(MagnetType)
0320     error(<span class="string">'Magnet Type sould be a string'</span>)
0321 <span class="keyword">end</span>
0322 
0323 <span class="keyword">if</span> ~exist(<span class="string">'Machine'</span>,<span class="string">'var'</span>)
0324     Machine = getfamilydata(<span class="string">'Machine'</span>);
0325 <span class="keyword">end</span>
0326 
0327 <span class="comment">% if not a single element</span>
0328 <span class="keyword">if</span> length(Inom) &gt; 1
0329     <span class="keyword">for</span> k = 1:length(Inom)
0330         curve{k} = <a href="#_sub1" class="code" title="subfunction curve = makecyclingcurve(Inom,Imax,MagnetType,varargin)">makecyclingcurve</a>(Inom(k),Imax(k),MagnetType,varargin{:});
0331     <span class="keyword">end</span>
0332 <span class="keyword">else</span>
0333 
0334     <span class="comment">%% Main part</span>
0335     <span class="keyword">switch</span> Machine
0336         <span class="keyword">case</span> <span class="string">'LT1'</span>
0337             <span class="keyword">switch</span> MagnetType
0338                 <span class="keyword">case</span> {<span class="string">'BEND'</span>}
0339                     <span class="keyword">switch</span> CyclingMode
0340                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0341                             curve = [[0 1] <span class="comment">% current time</span>
0342                                 [Imax 30]
0343                                 [Inom 1] ];
0344                         <span class="keyword">case</span> <span class="string">'Full'</span>
0345                             <span class="comment">%curve = [[0 10] % current time</span>
0346                             <span class="comment">%[Imax 180]</span>
0347                             <span class="comment">%[0.95*Inom 180]</span>
0348                             <span class="comment">%[1.05*Inom 180]</span>
0349                             <span class="comment">%[0.95*Inom 180]</span>
0350                             <span class="comment">%[1.05*Inom 180]</span>
0351                             <span class="comment">%[Inom 180] ];</span>
0352                             curve = [[0 10] <span class="comment">% test !</span>
0353                                 [Imax 10]
0354                                 [0.95*Inom 10]
0355                                 [1.05*Inom 10]
0356                                 [0.95*Inom 10]
0357                                 [1.05*Inom 10]
0358                                 [Inom 10] ];
0359                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0360                             curve = [[0 10] <span class="comment">% current time</span>
0361                                 [Imax 1800] <span class="comment">% temps de chauffe 30 min</span>
0362                                 [0.95*Inom 180]
0363                                 [1.05*Inom 180]
0364                                 [0.95*Inom 180]
0365                                 [1.05*Inom 180]
0366                                 [Inom 180] ];
0367                         <span class="keyword">otherwise</span>
0368                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0369                     <span class="keyword">end</span>
0370                 <span class="keyword">case</span> {<span class="string">'QP'</span>}
0371                     <span class="keyword">switch</span> CyclingMode
0372                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0373                             <span class="comment">% test avec temps plus courts mars 2006</span>
0374                             curve = [[0 1] <span class="comment">% current time</span>
0375                                 [Imax 10]
0376                                 [Inom 1] ];
0377                             <span class="comment">%                             curve = [[0 1] % current time</span>
0378                             <span class="comment">%                                 [Imax 30]</span>
0379                             <span class="comment">%                                 [Inom 1] ];</span>
0380                         <span class="keyword">case</span> <span class="string">'Full'</span>
0381                             <span class="comment">% on raccourcit les temps pour tests mars 2006</span>
0382                             curve = [[0 10] <span class="comment">% current time</span>
0383                                 [Imax 40]
0384                                 [0.95*Inom 10]
0385                                 [1.05*Inom 10]
0386                                 [0.95*Inom 10]
0387                                 [1.05*Inom 10]
0388                                 [Inom 10] ];
0389                             <span class="comment">%                             curve = [[0 10] % current time</span>
0390                             <span class="comment">%                                 [Imax 180]</span>
0391                             <span class="comment">%                                 [0.95*Inom 180]</span>
0392                             <span class="comment">%                                 [1.05*Inom 180]</span>
0393                             <span class="comment">%                                 [0.95*Inom 180]</span>
0394                             <span class="comment">%                                 [1.05*Inom 180]</span>
0395                             <span class="comment">%                                 [Inom 10] ];</span>
0396                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0397                             <span class="comment">% test avec temps courts mars 2006</span>
0398                             curve = [[0 10] <span class="comment">% current time</span>
0399                                 [Imax 20] <span class="comment">% temps de chauffe 10 min</span>
0400                                 [0.95*Inom 10]
0401                                 [1.05*Inom 10]
0402                                 [0.95*Inom 10]
0403                                 [1.05*Inom 10]
0404                                 [Inom 20] ];
0405                             <span class="comment">%                             curve = [[0 10] % current time</span>
0406                             <span class="comment">%                                 [Imax 600] % temps de chauffe 10 min</span>
0407                             <span class="comment">%                                 [0.95*Inom 180]</span>
0408                             <span class="comment">%                                 [1.05*Inom 180]</span>
0409                             <span class="comment">%                                 [0.95*Inom 180]</span>
0410                             <span class="comment">%                                 [1.05*Inom 180]</span>
0411                             <span class="comment">%                                 [Inom 180] ];</span>
0412                         <span class="keyword">otherwise</span>
0413                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0414                     <span class="keyword">end</span>
0415                 <span class="keyword">case</span> {<span class="string">'CH'</span>,<span class="string">'CV'</span>}
0416                     <span class="keyword">switch</span> CyclingMode
0417                         <span class="keyword">case</span> {<span class="string">'Simple'</span>, <span class="string">'Full'</span>,<span class="string">'Startup'</span>}
0418                             curve = [[0 1] <span class="comment">% current time</span>
0419                                 [Imax 30]
0420                                 [Inom 1] ];
0421                         <span class="keyword">otherwise</span>
0422                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0423                     <span class="keyword">end</span>
0424 
0425                 <span class="keyword">otherwise</span>
0426                     error(<span class="string">'Unknown magnet type: %s'</span>, MagnetType)
0427             <span class="keyword">end</span>
0428         <span class="keyword">case</span> <span class="string">'LT2'</span>
0429              <span class="keyword">switch</span> MagnetType
0430                 <span class="keyword">case</span> {<span class="string">'BEND'</span>}
0431                     <span class="keyword">switch</span> CyclingMode
0432                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0433                             curve = [[0 10] <span class="comment">% current time</span>
0434                                 [Imax 30]
0435                                 [Inom 10] ];
0436                         <span class="keyword">case</span> <span class="string">'Full'</span>
0437                             <span class="comment">%curve = [[0 10] % current time</span>
0438                             <span class="comment">%[Imax 180]</span>
0439                             <span class="comment">%[0.95*Inom 180]</span>
0440                             <span class="comment">%[1.05*Inom 180]</span>
0441                             <span class="comment">%[0.95*Inom 180]</span>
0442                             <span class="comment">%[1.05*Inom 180]</span>
0443                             <span class="comment">%[Inom 180] ];</span>
0444                             
0445                             curve = [[0 10] <span class="comment">%</span>
0446                                 [Imax 60]
0447                                 [0.95*Inom 60]
0448                                 [1.05*Inom 60]
0449                                 [Inom 10] ];
0450   
0451                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0452                             curve = [[0 10] <span class="comment">% current time</span>
0453                                 [Imax 1800] <span class="comment">% temps de chauffe 30 min</span>
0454                                 [0.95*Inom 180]
0455                                 [1.05*Inom 180]
0456                                 [0.95*Inom 180]
0457                                 [1.05*Inom 180]
0458                                 [Inom 180] ];
0459                         <span class="keyword">otherwise</span>
0460                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0461                     <span class="keyword">end</span>
0462                 <span class="keyword">case</span> {<span class="string">'QP'</span>}
0463                     <span class="keyword">switch</span> CyclingMode
0464                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0465                             <span class="comment">% test avec temps plus courts mars 2006</span>
0466                             curve = [[0 1] <span class="comment">% current time</span>
0467                                 [Imax 10]
0468                                 [Inom 1] ];
0469                             <span class="comment">%                             curve = [[0 1] % current time</span>
0470                             <span class="comment">%                                 [Imax 30]</span>
0471                             <span class="comment">%                                 [Inom 1] ];</span>
0472                         <span class="keyword">case</span> <span class="string">'Full'</span>
0473                             <span class="comment">% on raccourcit les temps pour tests mars 2006</span>
0474                             curve = [[0 10] <span class="comment">% current time</span>
0475                                 [Imax 40]
0476                                 [0.95*Inom 10]
0477                                 [1.05*Inom 10]
0478                                 [0.95*Inom 10]
0479                                 [1.05*Inom 10]
0480                                 [Inom 10] ];
0481                             <span class="comment">%                             curve = [[0 10] % current time</span>
0482                             <span class="comment">%                                 [Imax 180]</span>
0483                             <span class="comment">%                                 [0.95*Inom 180]</span>
0484                             <span class="comment">%                                 [1.05*Inom 180]</span>
0485                             <span class="comment">%                                 [0.95*Inom 180]</span>
0486                             <span class="comment">%                                 [1.05*Inom 180]</span>
0487                             <span class="comment">%                                 [Inom 10] ];</span>
0488                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0489                             <span class="comment">% test avec temps courts mars 2006</span>
0490                             curve = [[0 10] <span class="comment">% current time</span>
0491                                 [Imax 20] <span class="comment">% temps de chauffe 10 min</span>
0492                                 [0.95*Inom 10]
0493                                 [1.05*Inom 10]
0494                                 [0.95*Inom 10]
0495                                 [1.05*Inom 10]
0496                                 [Inom 20] ];
0497                             <span class="comment">%                             curve = [[0 10] % current time</span>
0498                             <span class="comment">%                                 [Imax 600] % temps de chauffe 10 min</span>
0499                             <span class="comment">%                                 [0.95*Inom 180]</span>
0500                             <span class="comment">%                                 [1.05*Inom 180]</span>
0501                             <span class="comment">%                                 [0.95*Inom 180]</span>
0502                             <span class="comment">%                                 [1.05*Inom 180]</span>
0503                             <span class="comment">%                                 [Inom 180] ];</span>
0504                         <span class="keyword">otherwise</span>
0505                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0506                     <span class="keyword">end</span>
0507                 <span class="keyword">case</span> {<span class="string">'CH'</span>,<span class="string">'CV'</span>}
0508                     <span class="keyword">switch</span> CyclingMode
0509                         <span class="keyword">case</span> {<span class="string">'Simple'</span>, <span class="string">'Full'</span>,<span class="string">'Startup'</span>}
0510                             curve = [[0 1] <span class="comment">% current time</span>
0511                                 [Imax 30]
0512                                 [Inom 1] ];
0513                         <span class="keyword">otherwise</span>
0514                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0515                     <span class="keyword">end</span>
0516 
0517                 <span class="keyword">otherwise</span>
0518                     error(<span class="string">'Unknown magnet type: %s'</span>, MagnetType)
0519             <span class="keyword">end</span>
0520            
0521         <span class="keyword">case</span> <span class="string">'Booster'</span>
0522             error(<span class="string">'%s: Not implemented yet'</span>, Machine)
0523         <span class="keyword">case</span> <span class="string">'StorageRing'</span>
0524 
0525             <span class="keyword">switch</span> MagnetType
0526                 <span class="keyword">case</span> {<span class="string">'BEND'</span>}
0527                     <span class="keyword">switch</span> CyclingMode
0528                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0529                             <span class="comment">%                             curve = [[0 1] % current time</span>
0530                             <span class="comment">%                                 [Imax 30]</span>
0531                             <span class="comment">%                                 [Inom 1] ];</span>
0532                         <span class="keyword">case</span> <span class="string">'Full'</span>
0533                             <span class="comment">% valeur initiale différente de zéro car zéro</span>
0534                             <span class="comment">% impossible</span>
0535                             curve = [[20 10] <span class="comment">%</span>
0536                                 [Imax 60]
0537                                 [0.95*Inom 60]
0538                                 [1.05*Inom 60]
0539                                 [Inom 10] ];
0540                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0541                             curve = [[20 10] <span class="comment">% current time</span>
0542                                 [Imax 1800] <span class="comment">% temps de chauffe 30 min</span>
0543                                 [0.95*Inom 180]
0544                                 [1.05*Inom 180]
0545                                 [0.95*Inom 180]
0546                                 [1.05*Inom 180]
0547                                 [Inom 180] ];
0548                         <span class="keyword">otherwise</span>
0549                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0550                     <span class="keyword">end</span>
0551                 <span class="keyword">case</span> {<span class="string">'Q1'</span>,<span class="string">'Q2'</span>,<span class="string">'Q3'</span>,<span class="string">'Q4'</span>,<span class="string">'Q5'</span>,<span class="string">'Q6'</span>,<span class="string">'Q7'</span>,<span class="string">'Q8'</span>,<span class="string">'Q9'</span>,<span class="string">'Q10'</span>,<span class="string">'QC13'</span>}
0552                     <span class="keyword">switch</span> CyclingMode
0553                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0554                             <span class="comment">% test avec temps plus courts</span>
0555                             curve = [[sign(Imax)*20 5] <span class="comment">% current time non zero consigne</span>
0556                                 [Imax 30]
0557                                 [Inom 5] ];
0558                         <span class="keyword">case</span> <span class="string">'Full'</span>
0559                             <span class="comment">%</span>
0560                             curve = [[sign(Imax)*20 10] <span class="comment">% current time non zero consigne</span>
0561                                 [Imax 30]
0562                                 [0.90*Inom 30]
0563                                 [1.10*Inom 30]
0564                                 [Inom 10] ];
0565                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0566                             <span class="comment">% test avec temps courts mars 2006</span>
0567                             curve = [[sign(Imax)*20 10] <span class="comment">% current time non zero consigne</span>
0568                                 [Imax 20] 
0569                                 [0.90*Inom 10]
0570                                 [1.10*Inom 10]
0571                                 [0.90*Inom 10]
0572                                 [1.10*Inom 10]
0573                                 [Inom 20] ];
0574                         <span class="keyword">otherwise</span>
0575                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0576                     <span class="keyword">end</span>
0577                 <span class="keyword">case</span> {<span class="string">'S1'</span>,<span class="string">'S2'</span>,<span class="string">'S3'</span>,<span class="string">'S4'</span>,<span class="string">'S5'</span>,<span class="string">'S6'</span>,<span class="string">'S7'</span>,<span class="string">'S8'</span>,<span class="string">'S9'</span>,<span class="string">'S10'</span>}
0578                     <span class="keyword">switch</span> CyclingMode
0579                         <span class="keyword">case</span> <span class="string">'Simple'</span>
0580                             <span class="comment">% test avec temps plus courts mars 2006</span>
0581                             curve = [[0 1] <span class="comment">% current time</span>
0582                                 [Imax 10]
0583                                 [Inom 1] ];
0584                         <span class="keyword">case</span> <span class="string">'Full'</span>
0585                             <span class="comment">%</span>
0586                             curve = [[0 10] <span class="comment">% current time</span>
0587                                 [Imax 30]
0588                                 [0.90*Inom 30]
0589                                 [1.10*Inom 30]
0590                                 [Inom 10] ];
0591                         <span class="keyword">case</span> <span class="string">'Startup'</span>
0592                             <span class="comment">% test avec temps courts mars 2006</span>
0593                             curve = [[0 10] <span class="comment">% current time</span>
0594                                 [Imax 20] <span class="comment">% temps de chauffe 10 min</span>
0595                                 [0.90*Inom 10]
0596                                 [1.10*Inom 10]
0597                                 [0.90*Inom 10]
0598                                 [1.10*Inom 10]
0599                                 [Inom 20] ];
0600                         <span class="keyword">otherwise</span>
0601                             error(<span class="string">'Unknown Mode: %s'</span>, CyclingMode);
0602                     <span class="keyword">end</span>
0603                 <span class="keyword">otherwise</span>
0604                     error(<span class="string">'Unknown magnet type: %s'</span>, MagnetType)
0605             <span class="keyword">end</span>
0606         <span class="keyword">otherwise</span>
0607             error(<span class="string">'Unknown machine: %s'</span>, Machine);
0608     <span class="keyword">end</span>
0609 
0610     <span class="keyword">if</span> DisplayFlag
0611         fprintf(1,<span class="string">'%s : Inom = %f Imax= %f \n'</span>, <span class="keyword">...</span>
0612             CycleAO.DeviceName, CycleAO.Inom, CycleAO.Imax);
0613         <a href="plotcyclingcurve.html" class="code" title="function plotcyclecurve(curve)">plotcyclingcurve</a>(curve);
0614     <span class="keyword">end</span>
0615 <span class="keyword">end</span>
0616 <span class="comment">%==========================================================================</span>
0617 <a name="_sub2" href="#_subfunctions" class="code">function CyclingEnd = anacycling(Families)</a>
0618 <span class="comment">%</span>
0619 <span class="comment">%</span>
0620 <span class="comment">%</span>
0621 
0622 <span class="comment">%</span>
0623 <span class="comment">% Written by Laurent S. Nadolski</span>
0624 
0625 <span class="keyword">for</span> k1=1:length(Families),
0626     CycleFamily = [<span class="string">'Cycle'</span> Families{k1}];
0627     [CycleIndex, CycleAO] = isfamily(CycleFamily);
0628 
0629     rep = tango_group_command_inout2(CycleAO.GroupId,<span class="string">'State'</span>,1,0);
0630     Status = rep.replies.obj_name;
0631     rep = tango_group_read_attribute(CycleAO.GroupId,<span class="string">'totalProgression'</span>);
0632     totalProgression = rep.replies.value;
0633 <span class="keyword">end</span>
0634 
0635 <span class="comment">% look whether all cycling precessus are done</span>
0636 <span class="keyword">if</span> min(totalProgression) ~= 100
0637     CyclingEnd = 0;
0638 <span class="keyword">else</span>
0639     CylclingEnd = 1;
0640 <span class="keyword">end</span>
0641 
0642 <span class="comment">% look for States and error</span>
0643 totalProgression;
0644 
0645 <span class="comment">%==========================================================================</span>
0646 <a name="_sub3" href="#_subfunctions" class="code">function cyclingconfiguration(Lattice, Family, varargin);</a>
0647 <span class="comment">% cyclingconfiguration</span>
0648 <span class="comment">%</span>
0649 <span class="comment">%  INPUTS</span>
0650 <span class="comment">%  1. Lattice - Structure of setpoints</span>
0651 <span class="comment">%  2. Family - Families to cycle to</span>
0652 <span class="comment">%</span>
0653 <span class="comment">%  See Also magnetcycle, setcyclecurve</span>
0654 
0655 <span class="comment">%</span>
0656 <span class="comment">% Written by Laurent S. Nadolski</span>
0657 
0658 <span class="comment">%TODO if not a tango group --&gt; treat single case</span>
0659 
0660 DisplayFlag = 1;
0661 ConfigFlag  = 1;
0662 
0663 
0664 <span class="keyword">if</span> iscell(Family)
0665     <span class="comment">% Build input line</span>
0666     h = waitbar(0,sprintf(<span class="string">'Cycling configuration progression: %2d %%'</span>,0))
0667     <span class="keyword">for</span> k = 1:length(Family)
0668         <a href="#_sub3" class="code" title="subfunction cyclingconfiguration(Lattice, Family, varargin);">cyclingconfiguration</a>(Lattice,Family{k},varargin{:})
0669         waitbar(k/length(Family), h, sprintf(<span class="string">'Cycling configuration progression: %2d %%'</span>,k/length(Family)*100))
0670     <span class="keyword">end</span>
0671     close(h);
0672 <span class="keyword">else</span>
0673     <span class="comment">%% INPUT PARSER</span>
0674     <span class="keyword">for</span> i = length(varargin):-1:1
0675         <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0676             DisplayFlag = 1;
0677             varargin(i) = [];
0678         <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0679             DisplayFlag = 0;
0680             varargin(i) = [];
0681         <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoConfig'</span>)
0682             ConfigFlag = 0;
0683             varargin(i) = [];
0684         <span class="keyword">end</span>
0685     <span class="keyword">end</span>
0686     <span class="comment">% Build Cycling configuration name</span>
0687     CycleFamily = [<span class="string">'Cycle'</span> Family];
0688 
0689     <span class="comment">% Check whether CyclingFamily exists</span>
0690     <span class="keyword">if</span> ismemberof(CycleFamily,<span class="string">'Cyclage'</span>)
0691         [CycleIndex, CycleAO] = isfamily(CycleFamily);
0692         CycleAO.Inom = Lattice.(Family).Setpoint.Data;
0693         <span class="comment">%% create cycling curve for each element of the group</span>
0694         curve = <a href="#_sub1" class="code" title="subfunction curve = makecyclingcurve(Inom,Imax,MagnetType,varargin)">makecyclingcurve</a>(CycleAO.Inom,CycleAO.Imax,Family,varargin{:});
0695 
0696         <span class="comment">% upload cycling curve</span>
0697         <span class="keyword">if</span> ConfigFlag
0698             reply = input([<span class="string">'Apply to Dserver new cycling curve to '</span>, Family, <span class="string">'? (y/n)'</span>],<span class="string">'s'</span>);
0699         <span class="keyword">else</span>
0700             reply = <span class="string">'yes'</span>;
0701         <span class="keyword">end</span>
0702 
0703         <span class="keyword">switch</span> lower(reply)
0704             <span class="keyword">case</span> {<span class="string">'y'</span>,<span class="string">'yes'</span>}
0705                 dev_name = CycleAO.DeviceName;
0706                 <a href="setcyclecurve.html" class="code" title="function setcyclecurve(dev_name, curve)">setcyclecurve</a>(dev_name,curve);
0707             <span class="keyword">otherwise</span>
0708                 disp(<span class="string">'Parameter not set to dserver'</span>)
0709         <span class="keyword">end</span>
0710     <span class="keyword">else</span>
0711         warning(<span class="string">'Family %s not cycled'</span>,Family)
0712     <span class="keyword">end</span>
0713 <span class="keyword">end</span>
0714</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:35:27 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>