<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of plotfamily</title>
  <meta name="keywords" content="plotfamily">
  <meta name="description" content="PLOTFAMILY - Plots by family name">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../index.html">Home</a> &gt;  <a href="#">machine</a> &gt; <a href="#">Soleil</a> &gt; <a href="../index.html">common</a> &gt; <a href="index.html">plotfamily</a> &gt; plotfamily.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../index.html"><img alt="<" border="0" src="../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for machine/Soleil/common/plotfamily&nbsp;<img alt=">" border="0" src="../../../../right.png"></a></td></tr></table>-->

<h1>plotfamily
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>PLOTFAMILY - Plots by family name</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function varargout = plotfamily(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">PLOTFAMILY - Plots by family name
  Runs as a stand-alone application as well

  To restrict the families to certain MemberOf group use:
  plotfamily MemberName

  FACTS
  1. Clicking on a data point in the plot will select the device in the
     listbox.  Clicking in the listbox will allow for a setpoint change.

  2. The lattice plot can also be used to change the setpoint.
     Just click on an object in the lattice drawing.  To remove the 
     setpoint widget click on a drift pass or BPM.  Note that HCMs are
     drawn above the axis and VCMs below.

  3. The &quot;Common Tasks&quot; menu is a launch pad menu.  It actually has nothing
     to do with of the plotfamily application.  Many of the typical
     tasks for setup of storage rings are listed in this menu. 

  4. Use plotfamilystartup to customize it for a particular accelerator.
     (Look at the ALS for an example.)

  5. This application can be compiled to run standalone.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>	PLOTFAMILY - Plots by family name</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>	PLOTFAMILY - Plots by family name</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub2" class="code">function plotfamily_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub3" class="code">function varargout = plotfamily_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub4" class="code">function EditMiddleLayer_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub5" class="code">function Delete_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub6" class="code">function Timer_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub7" class="code">function OnOff_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub8" class="code">function OneShot_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub9" class="code">function plotappdatalocal(handles)</a></li><li><a href="#_sub10" class="code">function RawOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function GoldenOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub12" class="code">function OffsetOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub13" class="code">function SaveOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub14" class="code">function FileOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub15" class="code">function RawOrbit2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub16" class="code">function GoldenOrbit2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub17" class="code">function OffsetOrbit2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub18" class="code">function SaveOrbit2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub19" class="code">function FileOrbit2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub20" class="code">function SaveOrbit1Now_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub21" class="code">function LoadOrbit1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub22" class="code">function UpdateFileDisplayLocal(handles)</a></li><li><a href="#_sub23" class="code">function Display1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub24" class="code">function Display2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub25" class="code">function DisplayDiff_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub26" class="code">function Trace2A_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub27" class="code">function Trace2B_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub28" class="code">function Trace2A_B_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub29" class="code">function Trace2Off_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub30" class="code">function DataList1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub31" class="code">function DataList2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub32" class="code">function PopPlot_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub33" class="code">function PopPlot1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub34" class="code">function PopPlot2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub35" class="code">function Axis1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub36" class="code">function Axis2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub37" class="code">function HorizontalAxis_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub38" class="code">function HorizontalAxisSector_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub39" class="code">function YScaleLog1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub40" class="code">function YScaleLinear1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub41" class="code">function YScaleLog2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub42" class="code">function YScaleLinear2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub43" class="code">function BPMxFamily_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub44" class="code">function BPMyFamily_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub45" class="code">function BPMxList_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub46" class="code">function BPMyList_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub47" class="code">function UpdatePeriod_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub48" class="code">function PhysicsUnits_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub49" class="code">function HardwareUnits_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub50" class="code">function MicronFlag_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub51" class="code">function SaveOrbitToFile_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub52" class="code">function Online_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub53" class="code">function Simulate_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub54" class="code">function Sim2Machine_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub55" class="code">function Machine2Sim_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub56" class="code">function AddPlot_Nothing_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub57" class="code">function DrawLattice_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub58" class="code">function AddPlot1_LatticeAxes_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub59" class="code">function AddPlot2_LatticeAxes_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub60" class="code">function AddPlot_Beta_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub61" class="code">function AddPlot_Dispersion_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub62" class="code">function Graph1_ButtonDown(hObject, eventdata, handles)</a></li><li><a href="#_sub63" class="code">function Graph2_ButtonDown(hObject, eventdata, handles)</a></li><li><a href="#_sub64" class="code">function AutoScaleH_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub65" class="code">function AutoScale1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub66" class="code">function AutoScale2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub67" class="code">function AutoScaleYLocal(handles)</a></li><li><a href="#_sub68" class="code">function Graph1ZoomInVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub69" class="code">function Graph1ZoomOutVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub70" class="code">function Graph2ZoomInVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub71" class="code">function Graph2ZoomOutVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub72" class="code">function Graph1OffsetDownVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub73" class="code">function Graph1OffsetUpVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub74" class="code">function Graph2OffsetDownVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub75" class="code">function Graph2OffsetUpVertical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub76" class="code">function HorizontalOffsetLeft_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub77" class="code">function HorizontalOffsetRight_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub78" class="code">function Graph1ZoomInHorizontal_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub79" class="code">function Graph1ZoomOutHorizontal_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub80" class="code">function supercell_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub81" class="code">function all_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub82" class="code">function superperiod1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub83" class="code">function superperiod2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub84" class="code">function superperiod3_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub85" class="code">function superperiod4_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub86" class="code">function Closinggui(obj, event, handles, figure1)</a></li><li><a href="#_sub87" class="code">function ReloadGoldenOrbit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub88" class="code">function Switch2HW_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub89" class="code">function Switch2Physics_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub90" class="code">function Switch2Online_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub91" class="code">function Switch2Sim_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub92" class="code">function Lattice_ButtonDown(hObject, eventdata, handles)</a></li><li><a href="#_sub93" class="code">function SetpointGUI_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub94" class="code">function SetpointRange_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub95" class="code">function SetpointSlider_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub96" class="code">function SetpointEditBox_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub97" class="code">function SetpointPushButton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub98" class="code">function ChangeSetpointPlotfamily(hObject, eventdata, handles)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = plotfamily(varargin)</a>
0002 <span class="comment">%PLOTFAMILY - Plots by family name</span>
0003 <span class="comment">%  Runs as a stand-alone application as well</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%  To restrict the families to certain MemberOf group use:</span>
0006 <span class="comment">%  plotfamily MemberName</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%  FACTS</span>
0009 <span class="comment">%  1. Clicking on a data point in the plot will select the device in the</span>
0010 <span class="comment">%     listbox.  Clicking in the listbox will allow for a setpoint change.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%  2. The lattice plot can also be used to change the setpoint.</span>
0013 <span class="comment">%     Just click on an object in the lattice drawing.  To remove the</span>
0014 <span class="comment">%     setpoint widget click on a drift pass or BPM.  Note that HCMs are</span>
0015 <span class="comment">%     drawn above the axis and VCMs below.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  3. The &quot;Common Tasks&quot; menu is a launch pad menu.  It actually has nothing</span>
0018 <span class="comment">%     to do with of the plotfamily application.  Many of the typical</span>
0019 <span class="comment">%     tasks for setup of storage rings are listed in this menu.</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%  4. Use plotfamilystartup to customize it for a particular accelerator.</span>
0022 <span class="comment">%     (Look at the ALS for an example.)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%  5. This application can be compiled to run standalone.</span>
0025 
0026 <span class="comment">%</span>
0027 <span class="comment">%  Written by Gregory Portmann</span>
0028 <span class="comment">%  Adapted and enhanced for SOLEIL by Laurent S. Nadolski</span>
0029 
0030 
0031 <span class="comment">% Last Modified by GUIDE v2.5 17-May-2007 14:16:05</span>
0032 
0033 
0034 <span class="comment">% For the compiler</span>
0035 <span class="comment">%#function plotfamilystartup</span>
0036 <span class="comment">%#function aoinit setao setoperationalmode srinit</span>
0037 <span class="comment">%#function srcycle getmachineconfig setmachineconfig</span>
0038 <span class="comment">%#function setorbitdefault findrf findrf2 rmdisp setgolden setoffset</span>
0039 <span class="comment">%#function settune steptune setchro stepchro</span>
0040 <span class="comment">%#function plotorbit plotorbitdata plotcm plotgoldenorbit plotoffsetorbit</span>
0041 <span class="comment">%#function plotorbit plotdata plotbpmresp plotbpmrespsym</span>
0042 <span class="comment">%#function plotlattice plotdisp plotchro</span>
0043 <span class="comment">%#function monbpm getbpm monmags</span>
0044 <span class="comment">%#function gettune</span>
0045 <span class="comment">%#function measchro plotchro</span>
0046 <span class="comment">%#function measdisp plotdisp</span>
0047 <span class="comment">%#function measbpmresp meastuneresp quadcenter</span>
0048 <span class="comment">%#function copybpmrespfile</span>
0049 <span class="comment">%#function copybpmsigmafile</span>
0050 <span class="comment">%#function copychrorespfile</span>
0051 <span class="comment">%#function copydispersionfile</span>
0052 <span class="comment">%#function copydisprespfile</span>
0053 <span class="comment">%#function copyinjectionconfigfile</span>
0054 <span class="comment">%#function copymachineconfigfile</span>
0055 <span class="comment">%#function copytunerespfile</span>
0056 <span class="comment">%#function measlocodata locogui buildlocoinput buildloco buildlocofitparameters</span>
0057 
0058 <span class="comment">%</span>
0059 <span class="comment">%  Written by Gregory J. Portmann</span>
0060 <span class="comment">%  Modified by Laurent S. Nadolski</span>
0061 
0062 <span class="comment">% Edit the above text to modify the response to help plotfamily</span>
0063 
0064 
0065 <span class="comment">% Last modifications</span>
0066 <span class="comment">% 13 mars 2005: returns an error if LT1 or LT2 is loaded</span>
0067 
0068 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0069 gui_Singleton = 0;
0070 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0071     <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0072     <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub2" class="code" title="subfunction plotfamily_OpeningFcn(hObject, eventdata, handles, varargin)">plotfamily_OpeningFcn</a>, <span class="keyword">...</span>
0073     <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub3" class="code" title="subfunction varargout = plotfamily_OutputFcn(hObject, eventdata, handles)">plotfamily_OutputFcn</a>, <span class="keyword">...</span>
0074     <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0075     <span class="string">'gui_Callback'</span>,   []);
0076 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0077     gui_State.gui_Callback = str2func(varargin{1});
0078 <span class="keyword">end</span>
0079 
0080 <span class="keyword">if</span> nargout
0081     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0082 <span class="keyword">else</span>
0083     gui_mainfcn(gui_State, varargin{:});
0084 <span class="keyword">end</span>
0085 <span class="comment">% End initialization code - DO NOT EDIT</span>
0086 
0087 
0088 <span class="comment">% --- Executes when user attempts to close figure1.</span>
0089 <a name="_sub1" href="#_subfunctions" class="code">function figure1_CloseRequestFcn(hObject, eventdata, handles)</a>
0090 <span class="comment">% hObject    handle to figure1 (see GCBO)</span>
0091 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0092 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0093 
0094 <span class="comment">% Hint: delete(hObject) closes the figure</span>
0095 delete(hObject);
0096 
0097 
0098 <span class="comment">% --- Executes just before plotfamily is made visible.</span>
0099 <a name="_sub2" href="#_subfunctions" class="code">function plotfamily_OpeningFcn(hObject, eventdata, handles, varargin)</a>
0100 <span class="comment">% This function has no output args, see OutputFcn.</span>
0101 <span class="comment">% hObject    handle to figure</span>
0102 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0103 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0104 <span class="comment">% varargin   command line arguments to plotfamily (see VARARGIN)</span>
0105 
0106 <span class="comment">% Choose default command line output for plotfamily</span>
0107 handles.output = hObject;
0108 
0109 <span class="comment">% Update handles structure</span>
0110 guidata(hObject, handles);
0111 
0112 <span class="comment">% UIWAIT makes plotfamily wait for user response (see UIRESUME)</span>
0113 <span class="comment">% uiwait(handles.figure1);</span>
0114 
0115 <span class="comment">% Set defaults</span>
0116 UpdatePeriod = 0.2;
0117 set(handles.UpdatePeriod,<span class="string">'Label'</span>, sprintf(<span class="string">'Update Period = %.2f s'</span>,UpdatePeriod));
0118 setappdata(handles.figure1, <span class="string">'UpdatePeriod'</span>, UpdatePeriod);
0119 
0120 <span class="comment">% Units  (This should get over written by the default for the BPM family)</span>
0121 setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, 2); <span class="comment">% Hardware</span>
0122 set(handles.PhysicsUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0123 set(handles.HardwareUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0124 set(handles.MicronFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0125 
0126 setappdata(handles.figure1,<span class="string">'ChannelA'</span>,1); <span class="comment">% Monitor values</span>
0127 setappdata(handles.figure1,<span class="string">'ChannelB'</span>,2); <span class="comment">% Golden values</span>
0128 
0129 <span class="comment">% Set the trace 1 defaults</span>
0130 <span class="comment">%setappdata(handles.figure1,'Trace1',1);</span>
0131 set(handles.DisplayDiff,<span class="string">'Value'</span>, 0);
0132 set(handles.Display1,<span class="string">'Value'</span>, 1);
0133 set(handles.Display2,<span class="string">'Value'</span>, 0);
0134 setappdata(handles.figure1,<span class="string">'Trace1'</span>, 1); <span class="comment">% Plot A</span>
0135 
0136 setappdata(handles.figure1,<span class="string">'Trace2'</span>, 4); <span class="comment">% Plotting Off</span>
0137 
0138 <span class="comment">% Run initialization if it has not been run (like standalone)</span>
0139 checkforao;
0140 
0141 <span class="comment">% Run initialization if it has not been run (like standalone)</span>
0142 <span class="comment">% Define Machine Name: Booster or Storage Ring</span>
0143 Machine = getfamilydata(<span class="string">'SubMachine'</span>);
0144 
0145 <span class="keyword">if</span> isempty(Machine)
0146     error(<span class="string">'No Machine loaded'</span>);
0147 <span class="keyword">elseif</span> strcmpi(Machine,<span class="string">'StorageRing'</span>)
0148     namestr = <span class="string">'Storage Ring'</span>;
0149 <span class="keyword">elseif</span> strcmpi(Machine,<span class="string">'Booster'</span>)
0150     namestr = <span class="string">'Booster'</span>;
0151 <span class="keyword">elseif</span> strcmpi(Machine,<span class="string">'LT1'</span>) || strcmpi(Machine,<span class="string">'LT2'</span>)
0152     error(<span class="string">'Not working for LT1 or LT2'</span>);
0153 <span class="keyword">else</span>
0154     error(<span class="string">'Unknown machine\n exiting ...'</span>);
0155 <span class="keyword">end</span>
0156 
0157 set(handles.accelerator_name,<span class="string">'String'</span>,namestr);
0158 
0159 <span class="keyword">if</span> isempty(varargin)
0160     MemberofField = <span class="string">'PlotFamily'</span>;
0161 <span class="keyword">else</span>
0162     MemberofField = varargin{1};
0163 <span class="keyword">end</span>
0164 
0165 <span class="comment">% Build Family menu</span>
0166 FoundOne = 0;
0167 FamilyName = getfamilylist;
0168 <span class="keyword">for</span> i = 1:size(FamilyName,1)
0169     Family = deblank(FamilyName(i,:));
0170     
0171     <span class="keyword">try</span>
0172         spos = getspos(Family);
0173     <span class="keyword">catch</span>
0174         spos = [];
0175     <span class="keyword">end</span>
0176     
0177     <span class="comment">% Only include if there are S-position for the family</span>
0178     <span class="keyword">if</span> ~isempty(spos)
0179         FieldList = <span class="string">''</span>;
0180         <span class="keyword">if</span> ismemberof(Family, MemberofField)
0181             <span class="comment">%if ismemberof(Family, 'PlotFamily') | ismemberof(Family, 'MachineConfig') | ismemberof(Family, 'BPM') | ...</span>
0182             <span class="comment">%        ismemberof(Family, 'COR') | ismemberof(Family, 'QUAD') | ...</span>
0183             <span class="comment">%        ismemberof(Family, 'HCM') | ismemberof(Family, 'VCM') | ...</span>
0184             <span class="comment">%        ismemberof(Family, 'SEXT') | ismemberof(Family, 'BEND') | ...</span>
0185             <span class="comment">%        ismemberof(Family, 'SkewQuad') | ismemberof(Family, 'SQSF') | ismemberof(Family, 'SQSD')</span>
0186             FieldList = <span class="string">'Monitor'</span>;
0187             FoundOne = 1;
0188         <span class="keyword">end</span>
0189         
0190         <span class="comment">% Look if any other fields are part of the MachineConfig</span>
0191         AOFamily = getfamilydata(Family);
0192         FieldNameCell = fieldnames(AOFamily);
0193         <span class="keyword">for</span> j = 1:size(FieldNameCell,1)
0194             <span class="keyword">if</span> isfield(AOFamily.(FieldNameCell{j}),<span class="string">'MemberOf'</span>)
0195                 <span class="keyword">if</span> any(strcmpi(AOFamily.(FieldNameCell{j}).MemberOf, MemberofField))
0196                     <span class="comment">%if any(strcmpi(AOFamily.(FieldNameCell{j}).MemberOf, MemberofField)) | any(strcmpi(AOFamily.(FieldNameCell{j}).MemberOf, 'MachineConfig'))</span>
0197                     FieldList = strvcat(FieldList,FieldNameCell{j});
0198                     FoundOne = 1;
0199                 <span class="keyword">end</span>
0200             <span class="keyword">end</span>
0201         <span class="keyword">end</span>
0202         
0203         <span class="comment">% Remove repeats but keep the row order</span>
0204         [FieldListUnique, ii, jj] = unique(FieldList, <span class="string">'rows'</span>);
0205         jj(find(diff(jj)==0)) = [];
0206         FieldList = FieldListUnique(jj,:);
0207         
0208         <span class="keyword">if</span> size(FieldList,1) == 1
0209             Menu1 = handles.BPMxFamily;
0210             Menu2 = handles.BPMyFamily;
0211             h1 = uimenu(Menu1, <span class="string">'Label'</span>,sprintf(<span class="string">'%s'</span>,Family), <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMxFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0212             h2 = uimenu(Menu2, <span class="string">'Label'</span>,sprintf(<span class="string">'%s'</span>,Family), <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMyFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0213             set(h1, <span class="string">'UserData'</span>, family2datastruct(Family, deblank(FieldList)));
0214             set(h2, <span class="string">'UserData'</span>, family2datastruct(Family, deblank(FieldList)));
0215             
0216         <span class="keyword">elseif</span> size(FieldList,1) &gt; 1
0217             <span class="comment">% Build off an extra menu</span>
0218             Menu1 = handles.BPMxFamily;
0219             Menu2 = handles.BPMyFamily;
0220             Menu1 = uimenu(Menu1, <span class="string">'Label'</span>, Family);
0221             Menu2 = uimenu(Menu2, <span class="string">'Label'</span>, Family);
0222             
0223             <span class="keyword">for</span> iField = 1:size(FieldList,1)
0224                 h1 = uimenu(Menu1, <span class="string">'Label'</span>,sprintf(<span class="string">'%s.%s'</span>,Family,deblank(FieldList(iField,:))), <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMxFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0225                 h2 = uimenu(Menu2, <span class="string">'Label'</span>,sprintf(<span class="string">'%s.%s'</span>,Family,deblank(FieldList(iField,:))), <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMyFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0226                 set(h1, <span class="string">'UserData'</span>, family2datastruct(Family, deblank(FieldList(iField,:))));
0227                 set(h2, <span class="string">'UserData'</span>, family2datastruct(Family, deblank(FieldList(iField,:))));
0228             <span class="keyword">end</span>
0229         <span class="keyword">else</span>
0230             <span class="comment">% Skip family</span>
0231         <span class="keyword">end</span>
0232     <span class="keyword">end</span>
0233 <span class="keyword">end</span>
0234 
0235 
0236 <span class="keyword">if</span> ~FoundOne
0237     <span class="comment">% if MemberOf came up empty, then put all the families in the menu</span>
0238     <span class="keyword">for</span> i = 1:size(FamilyName,1)
0239         <span class="keyword">try</span>
0240             Family = deblank(FamilyName(i,:));
0241             FamilyStruct = family2datastruct(Family,<span class="string">'Monitor'</span>);
0242             spos = getspos(FamilyStruct);
0243             <span class="keyword">if</span> ~isempty(spos)
0244                 h1 = uimenu(handles.BPMxFamily, <span class="string">'Label'</span>,Family, <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMxFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0245                 h2 = uimenu(handles.BPMyFamily, <span class="string">'Label'</span>,Family, <span class="string">'Callback'</span>,<span class="string">'plotfamily(''BPMyFamily_Callback'',gcbo,[],guidata(gcbo))'</span>);
0246                 set(h1, <span class="string">'UserData'</span>, FamilyStruct);
0247                 set(h2, <span class="string">'UserData'</span>, FamilyStruct);
0248             <span class="keyword">end</span>
0249         <span class="keyword">catch</span>
0250             <span class="comment">% Skip family</span>
0251             <span class="comment">%fprintf('Skipping family %s',Family);</span>
0252         <span class="keyword">end</span>
0253     <span class="keyword">end</span>
0254 <span class="keyword">end</span>
0255 
0256 
0257 <span class="comment">% Initial families</span>
0258 <span class="keyword">try</span>
0259     BPMFamilyCell = findmemberof(<span class="string">'BPM'</span>);
0260     <span class="keyword">if</span> length(BPMFamilyCell) &gt;= 2
0261         BPMxFamily = BPMFamilyCell{1};
0262         BPMyFamily = BPMFamilyCell{2};
0263     <span class="keyword">else</span>
0264         Hope <span class="keyword">for</span> the best on a family name
0265         BPMxFamily = gethbpmfamily;
0266         BPMyFamily = getvbpmfamily;
0267     <span class="keyword">end</span>
0268     BPMxField = <span class="string">'Monitor'</span>;
0269     BPMyField = <span class="string">'Monitor'</span>;
0270     BPMxList = family2dev(BPMxFamily, 1);
0271     BPMyList = family2dev(BPMyFamily, 1);
0272     
0273     set(handles.BPMxFamily,<span class="string">'Label'</span>,sprintf(<span class="string">'Family = %s'</span>, BPMxFamily));
0274     set(handles.BPMyFamily,<span class="string">'Label'</span>,sprintf(<span class="string">'Family = %s'</span>, BPMyFamily));
0275     
0276     <span class="comment">% Base on first 2 families</span>
0277     FamilyHandles = get(handles.BPMxFamily,<span class="string">'Children'</span>);
0278     <span class="keyword">if</span> length(FamilyHandles) &gt;= 1
0279         RawX = get(FamilyHandles(end),<span class="string">'UserData'</span>);
0280         <span class="keyword">if</span> isempty(RawX)
0281             FamilyHandles2 = get(FamilyHandles(end),<span class="string">'Children'</span>);
0282             RawX = get(FamilyHandles2(end),<span class="string">'UserData'</span>);
0283         <span class="keyword">end</span>
0284         BPMxFamily = RawX.FamilyName;
0285     <span class="keyword">else</span>
0286         fprintf(<span class="string">'   No families in the MML.\n'</span>);
0287     <span class="keyword">end</span>
0288     <span class="keyword">if</span> length(FamilyHandles) &gt;= 2
0289         RawY = get(FamilyHandles(end-1),<span class="string">'UserData'</span>);
0290         <span class="keyword">if</span> isempty(RawY)
0291             FamilyHandles2 = get(FamilyHandles(end-1),<span class="string">'Children'</span>);
0292             RawY = get(FamilyHandles2(end),<span class="string">'UserData'</span>);
0293         <span class="keyword">end</span>
0294         BPMyFamily = RawY.FamilyName;
0295     <span class="keyword">else</span>
0296         RawY = RawX;
0297         BPMyFamily = RawX.FamilyName;
0298     <span class="keyword">end</span>
0299 
0300     <span class="comment">% Initialize Mode</span>
0301     <span class="comment">% if strcmpi(get(handles.Simulate,'Checked'),'On')</span>
0302     <span class="comment">%     Mode = 'Simulator';</span>
0303     <span class="comment">% else</span>
0304     <span class="comment">%     Mode = 'Online';</span>
0305     <span class="comment">% end</span>
0306     <span class="keyword">if</span> strcmpi(RawX.Mode,<span class="string">'SIMULATOR'</span>)
0307         set(handles.Online,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0308         set(handles.Simulate,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0309         set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'%s, Plot Family Data (Model)'</span>, getfamilydata(<span class="string">'SubMachine'</span>)));
0310         Mode = <span class="string">'Simulator'</span>;
0311         ModeString = <span class="string">'Model'</span>;
0312     <span class="keyword">else</span>
0313         set(handles.Online,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0314         set(handles.Simulate,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0315         set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'%s, Plot Family Data (Online)'</span>, getfamilydata(<span class="string">'SubMachine'</span>)));
0316         Mode = <span class="string">'Online'</span>;
0317         ModeString = <span class="string">'Online'</span>;
0318     <span class="keyword">end</span>
0319     
0320     MachineName     = getfamilydata(<span class="string">'Machine'</span>);
0321     SubMachineName  = getfamilydata(<span class="string">'SubMachine'</span>);
0322     OperationalMode = getfamilydata(<span class="string">'OperationalMode'</span>);
0323     <span class="comment">%set(handles.figure1,'Name',sprintf('Plot Family:  %s %s (%s)', MachineName, SubMachineName, ModeString));</span>
0324     set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Plot Family:  %s  -  %s  -  %s  (%s)'</span>, MachineName, SubMachineName, OperationalMode, ModeString));
0325 
0326 
0327     <span class="comment">% Initialize Units</span>
0328     <span class="keyword">if</span> strcmpi(RawX.Units,<span class="string">'Physics'</span>)
0329         setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, 1);
0330         set(handles.(<span class="string">'PhysicsUnitsFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0331         set(handles.(<span class="string">'HardwareUnitsFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0332         set(handles.(<span class="string">'MicronFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0333         UnitsFlag = <span class="string">'Physics'</span>;
0334     <span class="keyword">else</span>
0335         setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, 2);
0336         set(handles.(<span class="string">'PhysicsUnitsFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0337         set(handles.(<span class="string">'HardwareUnitsFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0338         set(handles.(<span class="string">'MicronFlag'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0339         UnitsFlag = <span class="string">'Hardware'</span>;
0340     <span class="keyword">end</span>
0341 
0342     set(handles.(<span class="string">'BPMxFamily'</span>),<span class="string">'Label'</span>,sprintf(<span class="string">'Plot: %s'</span>, BPMxFamily));
0343     set(handles.(<span class="string">'BPMyFamily'</span>),<span class="string">'Label'</span>,sprintf(<span class="string">'Plot: %s'</span>, BPMyFamily));
0344 
0345     setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, RawX);
0346     setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, RawY);
0347 
0348     setappdata(handles.figure1,<span class="string">'RawX'</span>, RawX);
0349     setappdata(handles.figure1,<span class="string">'RawY'</span>, RawY);
0350 
0351     setappdata(handles.figure1,<span class="string">'SaveX'</span>, RawX);
0352     setappdata(handles.figure1,<span class="string">'SaveY'</span>, RawY);
0353     set(handles.SaveTime,<span class="string">'String'</span>, <span class="string">'Not saved'</span>);
0354 
0355     setappdata(handles.figure1,<span class="string">'FileX'</span>, RawX);
0356     setappdata(handles.figure1,<span class="string">'FileY'</span>, RawY);
0357 
0358     setappdata(handles.figure1,<span class="string">'FileNameX'</span>,<span class="string">''</span>);
0359     set(handles.FileNameX,<span class="string">'String'</span>, <span class="string">''</span>);
0360     set(handles.FileNameY,<span class="string">'String'</span>, <span class="string">''</span>);
0361     p = get(handles.FileName,<span class="string">'Position'</span>);
0362     <span class="comment">%set(handles.('FileName'),'Position', [p(1) 4 p(3) p(4)]);   % Points</span>
0363     set(handles.FileNameX,<span class="string">'Position'</span>, [p(1) .8 p(3) p(4)]);   <span class="comment">% Characters</span>
0364     p = get(handles.SaveTime,<span class="string">'Position'</span>);
0365     <span class="comment">%set(handles.SaveTime,'Position', [p(1) 16.5 p(3) p(4)]); % Points</span>
0366     set(handles.SaveTime,<span class="string">'Position'</span>, [p(1) 1.6 p(3) p(4)]);   <span class="comment">% Characters</span>
0367     
0368     <span class="comment">% Look to see it the AT model needs to be changed for this family</span>
0369     ATModelNumber = getfamilydata(BPMxFamily, <span class="string">'AT'</span>, <span class="string">'ATModel'</span>);
0370     <span class="keyword">if</span> ~isempty(ATModelNumber)
0371         <span class="keyword">global</span> THERING THERINGCELL
0372         THERING = THERINGCELL{ATModelNumber};
0373         setfamilydata(findspos(THERING,length(THERING)+1), <span class="string">'Circumference'</span>);
0374     <span class="keyword">end</span>
0375 
0376 <span class="keyword">catch</span>
0377 
0378     <span class="comment">% Starting units</span>
0379     UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
0380     <span class="keyword">if</span> UnitMenu == 1
0381         UnitsFlag = <span class="string">'Physics'</span>;
0382     <span class="keyword">else</span>
0383         UnitsFlag = <span class="string">'Hardware'</span>;
0384     <span class="keyword">end</span>
0385 
0386     <span class="comment">% Initialize Mode</span>
0387     <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
0388         Mode = <span class="string">'Simulator'</span>;
0389     <span class="keyword">else</span>
0390         Mode = <span class="string">'Online'</span>;
0391     <span class="keyword">end</span>
0392 
0393 <span class="keyword">end</span>
0394 
0395 
0396 <span class="comment">% % Look for the golden values</span>
0397 <span class="comment">% try</span>
0398 <span class="comment">%     GoldenValues = getgolden(BPMxFamily, BPMxList, 'Struct');</span>
0399 <span class="comment">%     setappdata(handles.figure1,'GoldenX', GoldenValues);</span>
0400 <span class="comment">% catch</span>
0401 <span class="comment">%     setappdata(handles.figure1,'GoldenX', RawX);</span>
0402 <span class="comment">% end</span>
0403 <span class="comment">%</span>
0404 <span class="comment">% % Look for the offset values</span>
0405 <span class="comment">% try</span>
0406 <span class="comment">%     OffsetValues = getoffset(BPMxFamily, BPMxList, 'Struct');</span>
0407 <span class="comment">%     setappdata(handles.figure1,'OffsetX', OffsetValues);</span>
0408 <span class="comment">% catch</span>
0409 <span class="comment">%     if isempty(OffsetValues)</span>
0410 <span class="comment">%         try</span>
0411 <span class="comment">%             % If and offset does not exist than try using the setpoint</span>
0412 <span class="comment">%             setappdata(handles.figure1,'OffsetX', getsp(BPMxFamily, BPMxList, Mode, 'Struct'));</span>
0413 <span class="comment">%         catch</span>
0414 <span class="comment">%             % Use zeros</span>
0415 <span class="comment">%             setappdata(handles.figure1,'OffsetX', RawX);</span>
0416 <span class="comment">%         end</span>
0417 <span class="comment">%     end</span>
0418 <span class="comment">% end</span>
0419 <span class="comment">%</span>
0420 <span class="comment">% % Look for the golden values</span>
0421 <span class="comment">% try</span>
0422 <span class="comment">%     GoldenValues = getgolden(BPMyFamily, BPMyList, 'Struct');</span>
0423 <span class="comment">%     setappdata(handles.figure1,'GoldenY', GoldenValues);</span>
0424 <span class="comment">% catch</span>
0425 <span class="comment">%     setappdata(handles.figure1,'GoldenY', RawY);</span>
0426 <span class="comment">% end</span>
0427 <span class="comment">%</span>
0428 <span class="comment">% % Look for the offset values</span>
0429 <span class="comment">% try</span>
0430 <span class="comment">%     OffsetValues = getoffset(BPMyFamily, BPMyList, 'Struct');</span>
0431 <span class="comment">%     setappdata(handles.figure1,'OffsetY', OffsetValues);</span>
0432 <span class="comment">% catch</span>
0433 <span class="comment">%     try</span>
0434 <span class="comment">%         % If and offset does not exist than try using the setpoint</span>
0435 <span class="comment">%         setappdata(handles.figure1,'OffsetY', getsp(BPMyFamily, BPMyList, Mode, 'Struct'));</span>
0436 <span class="comment">%     catch</span>
0437 <span class="comment">%         % Use zeros</span>
0438 <span class="comment">%         setappdata(handles.figure1,'OffsetY', RawY);</span>
0439 <span class="comment">%     end</span>
0440 <span class="comment">% end</span>
0441 
0442 <span class="comment">%% Sets axes for Graph1</span>
0443 L = getfamilydata(<span class="string">'Circumference'</span>);
0444 
0445 <span class="keyword">try</span>
0446     s = getspos(RawX);
0447     setappdata(handles.figure1, <span class="string">'SPosX'</span>, s);
0448     <span class="keyword">if</span> isempty(L)
0449         L = max(s);
0450     <span class="keyword">end</span>
0451     <span class="comment">%setappdata(handles.figure1, 'AxisRange1X', [min(s) max(s)]);</span>
0452 <span class="keyword">catch</span>
0453     <span class="comment">%setappdata(handles.figure1, 'SPosX', 1:size(RawX.DeviceList,1));</span>
0454 <span class="keyword">end</span>
0455 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, [0 L]);
0456 
0457 <span class="comment">%% Sets axes for Graph2</span>
0458 <span class="keyword">try</span>
0459     s = getspos(RawY);
0460     setappdata(handles.figure1, <span class="string">'SPosY'</span>, s);
0461     <span class="comment">%setappdata(handles.figure1, 'AxisRange2X', [min(s) max(s)]);</span>
0462 <span class="keyword">catch</span>
0463     <span class="comment">%setappdata(handles.figure1, 'SPosY', 1:size(RawY.DeviceList,1));</span>
0464 <span class="keyword">end</span>
0465 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, [0 L]);
0466 
0467 
0468 <span class="comment">% Update time</span>
0469 set(handles.Time, <span class="string">'String'</span>, <span class="string">''</span>);
0470 
0471 
0472 <span class="comment">% Initialize plots</span>
0473 set(handles.Graph1, <span class="string">'XLim'</span>, [0 L]);
0474 set(handles.Graph2, <span class="string">'XLim'</span>, [0 L]);
0475 
0476 p1 = [0.07    0.66    0.69    0.28];
0477 set(handles.Graph1, <span class="string">'Position'</span>, p1);
0478 set(handles.Graph3, <span class="string">'Position'</span>, p1);
0479 
0480 p2 = [0.07    0.26    0.69    0.28];
0481 set(handles.Graph2, <span class="string">'Position'</span>, p2);
0482 set(handles.Graph4, <span class="string">'Position'</span>, p2);
0483 
0484 plot(handles.Graph3, NaN, NaN);
0485 set(handles.Graph3, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0486 set(handles.Graph3, <span class="string">'color'</span>, <span class="string">'none'</span>);
0487 set(handles.Graph3, <span class="string">'XLim'</span>, [0 L]);
0488 
0489 plot(handles.Graph4, NaN,NaN);
0490 set(handles.Graph4, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0491 set(handles.Graph4, <span class="string">'color'</span>, <span class="string">'none'</span>);
0492 set(handles.Graph4, <span class="string">'XLim'</span>, [0 L]);
0493 
0494 
0495 <span class="comment">%axes(handles.LatticeAxes);</span>
0496 <span class="keyword">try</span>
0497     drawlattice(0, 1.1, handles.LatticeAxes);
0498 <span class="keyword">catch</span>
0499     d = .01;
0500     p1 = [0.07    0.65-d    0.74    0.29+d];
0501     set(handles.Graph1, <span class="string">'Position'</span>, p1);
0502     set(handles.Graph3, <span class="string">'Position'</span>, p1);
0503 
0504     p2 = [0.07    0.27    0.74    0.29+d];
0505     set(handles.Graph2, <span class="string">'Position'</span>, p2);
0506     set(handles.Graph4, <span class="string">'Position'</span>, p2);
0507 
0508     set(handles.DrawLattice, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
0509     set(get(handles.LatticeAxes,<span class="string">'Children'</span>), <span class="string">'Visible'</span> , <span class="string">'Off'</span>);
0510 <span class="keyword">end</span>
0511 
0512 <span class="keyword">try</span>
0513     set(handles.LatticeAxes,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
0514     set(handles.LatticeAxes,<span class="string">'Color'</span>,<span class="string">'None'</span>);
0515     set(handles.LatticeAxes,<span class="string">'XMinorTick'</span>,<span class="string">'Off'</span>);
0516     set(handles.LatticeAxes,<span class="string">'XMinorGrid'</span>,<span class="string">'Off'</span>);
0517     set(handles.LatticeAxes,<span class="string">'YMinorTick'</span>,<span class="string">'Off'</span>);
0518     set(handles.LatticeAxes,<span class="string">'YMinorGrid'</span>,<span class="string">'Off'</span>);
0519     set(handles.LatticeAxes,<span class="string">'XTickLabel'</span>,[]);
0520     set(handles.LatticeAxes,<span class="string">'YTickLabel'</span>,[]);
0521     set(handles.LatticeAxes,<span class="string">'XLim'</span>, [0 L]);
0522     set(handles.LatticeAxes,<span class="string">'YLim'</span>, [-1.5 1.5]);
0523 
0524 
0525     <span class="comment">% Add callback on each lattice element</span>
0526     <span class="comment">% set(handles.LatticeAxes ,'ButtonDownFcn','plotfamily(''Lattice_ButtonDown'',gcbo,[],guidata(gcbo))');</span>
0527     h = get(handles.LatticeAxes,<span class="string">'Children'</span>);
0528     <span class="keyword">for</span> i = 1:length(h)
0529         <span class="comment">%ATIndex = get(h(i), 'UserData');</span>
0530         set(h(i), <span class="string">'ButtonDownFcn'</span>, <span class="string">'plotfamily(''Lattice_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
0531     <span class="keyword">end</span>
0532 <span class="keyword">catch</span>
0533 <span class="keyword">end</span>
0534 
0535 
0536 
0537 
0538 <span class="comment">% % Build middle layer edit menus</span>
0539 <span class="comment">% %h = addmenuao(handles.('EditMiddleLayerAO'));</span>
0540 <span class="comment">% %set(h, 'Label', 'Middle Layer Family Setup');</span>
0541 <span class="comment">%</span>
0542 <span class="comment">% hmenu = handles.('EditMiddleLayerAO');</span>
0543 <span class="comment">% LabelString = 'Middle Layer Family Setup';</span>
0544 <span class="comment">% ParentLabelString = 'MiddleLayer';</span>
0545 <span class="comment">% DataStructure0 = getao;</span>
0546 <span class="comment">% if isempty(DataStructure0)</span>
0547 <span class="comment">%     aoinit;</span>
0548 <span class="comment">% end</span>
0549 <span class="comment">%</span>
0550 <span class="comment">%</span>
0551 <span class="comment">% % Build middle menu tree</span>
0552 <span class="comment">% DataStructFieldName1 = fieldnames(DataStructure0);</span>
0553 <span class="comment">% for i = 1:length(DataStructFieldName1)</span>
0554 <span class="comment">%     DataStructure1 = DataStructure0.(DataStructFieldName1{i});</span>
0555 <span class="comment">%     if isstruct(DataStructure1)</span>
0556 <span class="comment">%         hmenu1 = uimenu(hmenu, 'Label',DataStructFieldName1{i}, 'Callback','');</span>
0557 <span class="comment">%         DataStructFieldName2 = fieldnames(DataStructure1);</span>
0558 <span class="comment">%         for j = 1:length(DataStructFieldName2)</span>
0559 <span class="comment">%             DataStructure2 = DataStructure1.(DataStructFieldName2{j});</span>
0560 <span class="comment">%             if isstruct(DataStructure2)</span>
0561 <span class="comment">%                 hmenu2 = uimenu(hmenu1, 'Label',DataStructFieldName2{j}, 'Callback','');</span>
0562 <span class="comment">%                 DataStructFieldName3 = fieldnames(DataStructure2);</span>
0563 <span class="comment">%                 for k = 1:length(DataStructFieldName3)</span>
0564 <span class="comment">%                     DataStructure3 = DataStructure2.(DataStructFieldName3{k});</span>
0565 <span class="comment">%                     if isstruct(DataStructure3)</span>
0566 <span class="comment">%                         hmenu3 = uimenu(hmenu2, 'Label',DataStructFieldName3{k}, 'Callback','');</span>
0567 <span class="comment">%                         DataStructFieldName4 = fieldnames(DataStructure3);</span>
0568 <span class="comment">%                         for l = 1:length(DataStructFieldName4)</span>
0569 <span class="comment">%                             hmenu4 = uimenu(hmenu3, 'Label', DataStructFieldName4{l});</span>
0570 <span class="comment">%                             set(hmenu4,'UserData', {DataStructure3.(DataStructFieldName4{l}) , DataStructFieldName1{l}, DataStructFieldName2{k}, DataStructFieldName3{k}, DataStructFieldName4{i}});</span>
0571 <span class="comment">%                             set(hmenu4,'Callback', 'plotfamily(''EditMiddleLayer_Callback'',gcbo,[],guidata(gcbo))');</span>
0572 <span class="comment">%                         end</span>
0573 <span class="comment">%                     else</span>
0574 <span class="comment">%                         hmenu3 = uimenu(hmenu2, 'Label',DataStructFieldName3{k});</span>
0575 <span class="comment">%                         set(hmenu3,'UserData', {DataStructure3, DataStructFieldName1{i}, DataStructFieldName2{j}, DataStructFieldName3{k}});</span>
0576 <span class="comment">%                         set(hmenu3,'Callback', 'plotfamily(''EditMiddleLayer_Callback'',gcbo,[],guidata(gcbo))');</span>
0577 <span class="comment">%                     end</span>
0578 <span class="comment">%                 end</span>
0579 <span class="comment">%             else</span>
0580 <span class="comment">%                 hmenu2 = uimenu(hmenu1, 'Label',DataStructFieldName2{j});</span>
0581 <span class="comment">%                 set(hmenu2,'UserData', {DataStructure2, DataStructFieldName1{i}, DataStructFieldName2{j}});</span>
0582 <span class="comment">%                 set(hmenu2,'Callback', 'plotfamily(''EditMiddleLayer_Callback'',gcbo,[],guidata(gcbo))');</span>
0583 <span class="comment">%             end</span>
0584 <span class="comment">%         end</span>
0585 <span class="comment">%     else</span>
0586 <span class="comment">%         hmenu1 = uimenu(hmenu, 'Label', DataStructFieldName1{i});</span>
0587 <span class="comment">%         set(hmenu1,'UserData', {DataStructure1, DataStructFieldName1{i}});</span>
0588 <span class="comment">%         set(hmenu1,'Callback', 'plotfamily(''EditMiddleLayer_Callback'',gcbo,[],guidata(gcbo))');</span>
0589 <span class="comment">%     end</span>
0590 <span class="comment">% end</span>
0591 
0592 
0593 <span class="comment">% % Build the AD menu</span>
0594 <span class="comment">% set(addmenuad(handles.EditMiddleLayerAD), 'Label', 'Middle Layer Parameter Setup');</span>
0595 set(handles.EditMiddleLayerAO, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0596 set(handles.EditMiddleLayerAD, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0597 
0598 
0599 <span class="comment">% Machine specific startup function</span>
0600 <span class="keyword">if</span> exist(<span class="string">'plotfamilystartup'</span>, <span class="string">'file'</span>)
0601     plotfamilystartup(handles);
0602 <span class="keyword">end</span>
0603 
0604 
0605 <span class="comment">% Refresh once</span>
0606 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
0607 
0608 
0609 
0610 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0611 <a name="_sub3" href="#_subfunctions" class="code">function varargout = plotfamily_OutputFcn(hObject, eventdata, handles)</a>
0612 <span class="comment">% varargout  cell array for returning output args (see VARARGOUT);</span>
0613 <span class="comment">% hObject    handle to figure</span>
0614 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0615 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0616 
0617 <span class="comment">% Get default command line output from handles structure</span>
0618 <span class="keyword">if</span> isfield(handles,<span class="string">'output'</span>)
0619     varargout{1} = handles.output;
0620 <span class="keyword">end</span>
0621 
0622 
0623 <span class="comment">% --- Executes onoff button press in OnOff.</span>
0624 <a name="_sub4" href="#_subfunctions" class="code">function EditMiddleLayer_Callback(hObject, eventdata, handles)</a>
0625 
0626 Data = get(hObject, <span class="string">'UserData'</span>);
0627 
0628 <span class="comment">% Get up-to-date data</span>
0629 Data{1} = getfamilydata(Data{2:end});
0630 TitleString = sprintf(<span class="string">'%s '</span>,Data{2:end});
0631 AddOpts.Resize=<span class="string">'on'</span>;
0632 AddOpts.WindowStyle=<span class="string">'normal'</span>;
0633 AddOpts.Interpreter=<span class="string">'tex'</span>;
0634 
0635 <span class="keyword">if</span> length(Data) &gt;= 3 &amp;&amp; (strcmpi(deblank(Data{3}),<span class="string">'Status'</span>) || strcmpi(deblank(Data{3}),<span class="string">'DeviceList'</span>) || strcmpi(deblank(Data{3}),<span class="string">'ElementList'</span>)) 
0636     <span class="keyword">if</span> strcmpi(deblank(Data{3}),<span class="string">'ElementList'</span>)
0637         DeviceList = getfamilydata(deblank(Data{2}), <span class="string">'ElementList'</span>);
0638     <span class="keyword">else</span>
0639         DeviceList = getfamilydata(deblank(Data{2}), <span class="string">'DeviceList'</span>);
0640     <span class="keyword">end</span>
0641     Status = getfamilydata(deblank(Data{2}), <span class="string">'Status'</span>);
0642     DeviceListNew = editlist(DeviceList, deblank(Data{2}), Status);
0643     
0644     [i, iNotFound] = findrowindex(DeviceListNew, DeviceList);
0645     
0646     <span class="keyword">if</span> size(Status,1) == 1
0647         DeviceListTotal = family2dev(Data{2}, 0);
0648         Status = zeros(size(DeviceListTotal,1),1);
0649     <span class="keyword">else</span>
0650         Status = 0 * Status;
0651     <span class="keyword">end</span>
0652     Status(i) = 1;
0653     setfamilydata(Status, deblank(Data{2}), <span class="string">'Status'</span>); 
0654     
0655 <span class="keyword">elseif</span> isnumeric(Data{1})
0656     answer = inputdlg({sprintf(<span class="string">'Change %s '</span>,TitleString)}, <span class="string">'Edit Middle Layer Family'</span>, size(Data{1},1), {num2str(Data{1})}, AddOpts);
0657     <span class="keyword">if</span> isempty(answer)
0658         <span class="keyword">return</span>
0659     <span class="keyword">end</span>
0660     Data{1} = str2num(answer{1});
0661     set(hObject, <span class="string">'UserData'</span>, Data);
0662     setfamilydata(Data{1:end});
0663 <span class="keyword">elseif</span> strcmpi(Data{2},<span class="string">'Directory'</span>)
0664     answer = uigetdir(Data{1}, sprintf(<span class="string">'Change directory location for %s'</span>, Data{3}));
0665     <span class="keyword">if</span> answer == 0
0666         <span class="keyword">return</span>
0667     <span class="keyword">end</span>
0668     Data{1} = answer;
0669     set(hObject, <span class="string">'UserData'</span>, Data);
0670     setfamilydata(Data{1:end});    
0671     
0672 <span class="keyword">elseif</span> ischar(Data{1})
0673     answer = inputdlg({sprintf(<span class="string">'Change %s '</span>,TitleString)}, <span class="string">'Edit Middle Layer Family'</span>, size(Data{1},1), {num2str(Data{1})}, AddOpts);
0674     <span class="keyword">if</span> isempty(answer)
0675         <span class="keyword">return</span>
0676     <span class="keyword">end</span>
0677     Data{1} = answer{1};
0678     set(hObject, <span class="string">'UserData'</span>, Data);
0679     setfamilydata(Data{1:end});
0680 <span class="keyword">end</span>
0681 
0682 
0683 <span class="comment">% Reset graphs</span>
0684 <a href="#_sub43" class="code" title="subfunction BPMxFamily_Callback(hObject, eventdata, handles)">BPMxFamily_Callback</a>([], eventdata, handles);
0685 <a href="#_sub44" class="code" title="subfunction BPMyFamily_Callback(hObject, eventdata, handles)">BPMyFamily_Callback</a>([], eventdata, handles);
0686 
0687 
0688 <span class="comment">% --- Executes on delete</span>
0689 <a name="_sub5" href="#_subfunctions" class="code">function Delete_Callback(hObject, eventdata, handles)</a>
0690 
0691 <span class="comment">% If timer is on, then turn it off by deleting the timer handle</span>
0692 <span class="keyword">try</span>
0693     <span class="comment">%h = get(gcbf, 'UserData');</span>
0694     h = get(handles.figure1, <span class="string">'UserData'</span>);
0695     <span class="keyword">if</span> isfield(h,<span class="string">'TimerHandle'</span>)
0696         stop(h.TimerHandle);
0697         delete(h.TimerHandle);
0698     <span class="keyword">end</span>
0699 <span class="keyword">catch</span>
0700     fprintf(<span class="string">'   Trouble stopping the timer on exit.\n'</span>);
0701 <span class="keyword">end</span>
0702 
0703 
0704 
0705 <span class="comment">% --- Executes onoff button press in OnOff.</span>
0706 <a name="_sub6" href="#_subfunctions" class="code">function Timer_Callback(hObject, eventdata, handles)</a>
0707 <span class="comment">% Timer method</span>
0708 
0709 <span class="comment">%disp('Timer executed.');</span>
0710 <span class="comment">%handles = get(eventdata, 'UserData');</span>
0711 handles = get(hObject, <span class="string">'UserData'</span>);
0712 <a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>(<span class="string">'OneShot_Callback'</span>, hObject, [], handles);
0713 
0714 
0715 <span class="comment">% --- Executes onoff button press in OnOff.</span>
0716 <a name="_sub7" href="#_subfunctions" class="code">function OnOff_Callback(hObject, eventdata, handles)</a>
0717 <span class="comment">% Timer method</span>
0718 
0719 <span class="comment">% % Update the title bar</span>
0720 <span class="comment">% MachineName     = getfamilydata('Machine');</span>
0721 <span class="comment">% SubMachineName  = getfamilydata('SubMachine');</span>
0722 <span class="comment">% OperationalMode = getfamilydata('OperationalMode');</span>
0723 <span class="comment">% if strcmpi(get(handles.Simulate,'Checked'),'On')</span>
0724 <span class="comment">%     set(handles.figure1,'Name',sprintf('Plot Family:  %s  -  %s  -  %s  (%s)', MachineName, SubMachineName, OperationalMode, 'Model'));</span>
0725 <span class="comment">% else</span>
0726 <span class="comment">%     set(handles.figure1,'Name',sprintf('Plot Family:  %s  -  %s  -  %s  (%s)', MachineName, SubMachineName, OperationalMode, 'Online'));</span>
0727 <span class="comment">% end</span>
0728 
0729 OnFlag = get(handles.OnOff, <span class="string">'Value'</span>);
0730 
0731 <span class="keyword">if</span> OnFlag
0732     <span class="comment">% Turn on updates</span>
0733     set(handles.OnOff, <span class="string">'String'</span>, <span class="string">'Running'</span>);    
0734         
0735     <span class="comment">% Turn LatticeAxes menu back off</span>
0736     set(handles.LatticeMenu,<span class="string">'enable'</span>,<span class="string">'off'</span>);
0737 
0738     <span class="comment">% Setup timer</span>
0739     UpdatePeriod = getappdata(handles.figure1, <span class="string">'UpdatePeriod'</span>);    
0740     t = timer;
0741     set(t,<span class="string">'StartDelay'</span>,0);
0742     set(t,<span class="string">'Period'</span>, UpdatePeriod);
0743     <span class="comment">%set(t,'TimerFcn', 'plotfamily(''OneShot_Callback'', getfield(get(timerfind(''Tag'',''PlotFamilyTimer''),''Userdata''),''figure1''), [], get(timerfind(''Tag'',''PlotFamilyTimer''),''Userdata''));');</span>
0744     set(t,<span class="string">'TimerFcn'</span>, [<span class="string">'plotfamily(''Timer_Callback'','</span>, sprintf(<span class="string">'%.30f'</span>,handles.figure1), <span class="string">','</span>,sprintf(<span class="string">'%.30f'</span>,handles.figure1), <span class="string">', [])'</span>]);
0745     set(t,<span class="string">'UserData'</span>, handles);   
0746     set(t,<span class="string">'BusyMode'</span>, <span class="string">'drop'</span>);  <span class="comment">%'queue'</span>
0747     set(t,<span class="string">'TasksToExecute'</span>, Inf);
0748     set(t,<span class="string">'ExecutionMode'</span>, <span class="string">'FixedRate'</span>);
0749     set(t,<span class="string">'Tag'</span>, <span class="string">'PlotFamilyTimer'</span>);
0750 
0751     handles.TimerHandle = t;
0752     set(handles.figure1, <span class="string">'UserData'</span>, handles);
0753 
0754     <span class="comment">% Change Color</span>
0755     set(handles.OnOff, <span class="string">'String'</span>, <span class="string">'Running'</span>, <span class="string">'BackgroundColor'</span>,[0 1 0]);
0756 
0757     start(t);
0758     
0759 <span class="keyword">else</span>
0760     <span class="keyword">try</span>
0761         <span class="comment">% Turn off updating by deleting timer handle</span>
0762         h = get(handles.figure1, <span class="string">'UserData'</span>);
0763         stop(h.TimerHandle);
0764         delete(h.TimerHandle);
0765         h = rmfield(h, <span class="string">'TimerHandle'</span>);
0766         set(handles.figure1, <span class="string">'UserData'</span>, h);
0767         
0768         <span class="comment">% Delete all timers</span>
0769         <span class="comment">%h = timerfind('Tag','PlotFamilyTimer');</span>
0770         <span class="comment">%for i = 1:length(h)</span>
0771         <span class="comment">%    stop(h(i));</span>
0772         <span class="comment">%    delete(h(i));</span>
0773         <span class="comment">%end</span>
0774 
0775         <span class="comment">% Change OnOff label string</span>
0776         set(handles.OnOff, <span class="string">'String'</span>, <span class="string">'Continuous'</span>, <span class="string">'BackgroundColor'</span>,[0.81 0.81 0.81]);
0777         <span class="comment">% Turn LatticeAxes menu back on</span>
0778         set(handles.LatticeMenu,<span class="string">'enable'</span>,<span class="string">'on'</span>);
0779 
0780     <span class="keyword">catch</span>
0781         fprintf(<span class="string">'   Trouble stopping the timer.\n'</span>);
0782     <span class="keyword">end</span>
0783 <span class="keyword">end</span>
0784 
0785 
0786 <span class="comment">% % --- Executes onoff button press in OnOff.</span>
0787 <span class="comment">% function OnOff_Callback(hObject, eventdata, handles)</span>
0788 <span class="comment">% % Uses delay (not Timer)</span>
0789 <span class="comment">%</span>
0790 <span class="comment">% OrbitFeedbackFlag = 0;</span>
0791 <span class="comment">%</span>
0792 <span class="comment">% % Turn latticeaxes menu back off</span>
0793 <span class="comment">% set(handles.('LatticeMenu'),'enable','off');</span>
0794 <span class="comment">%</span>
0795 <span class="comment">% if strcmpi(get(handles.Simulate,'Checked'),'On')</span>
0796 <span class="comment">%     Mode = 'Simulator';</span>
0797 <span class="comment">% else</span>
0798 <span class="comment">%     Mode = 'Online';</span>
0799 <span class="comment">% end</span>
0800 <span class="comment">%</span>
0801 <span class="comment">% BPMxFamily = getappdata(handles.figure1, 'BPMxFamily');</span>
0802 <span class="comment">% BPMxList = getappdata(handles.figure1, 'BPMxList');</span>
0803 <span class="comment">% BPMyFamily = getappdata(handles.figure1, 'BPMyFamily');</span>
0804 <span class="comment">% BPMyList = getappdata(handles.figure1, 'BPMyList');</span>
0805 <span class="comment">%</span>
0806 <span class="comment">% OnFlag = get(handles.('OnOff'),'Value');</span>
0807 <span class="comment">% if OnFlag</span>
0808 <span class="comment">%     % Turn on updates</span>
0809 <span class="comment">%     set(handles.('OnOff'), 'String', 'Running')</span>
0810 <span class="comment">% end</span>
0811 <span class="comment">%</span>
0812 <span class="comment">% if OrbitFeedbackFlag</span>
0813 <span class="comment">%     [Nbpm, Tbpm] = getbpmaverages;</span>
0814 <span class="comment">%     Tbpm = max(Tbpm);</span>
0815 <span class="comment">% end</span>
0816 <span class="comment">%</span>
0817 <span class="comment">% while OnFlag</span>
0818 <span class="comment">%     t0 = gettime;</span>
0819 <span class="comment">%     OnFlag = get(handles.('OnOff'),'Value');</span>
0820 <span class="comment">%     UpdatePeriod = getappdata(handles.figure1, 'UpdatePeriod');</span>
0821 <span class="comment">%</span>
0822 <span class="comment">%     if OnFlag</span>
0823 <span class="comment">%         % Get new data</span>
0824 <span class="comment">%         try</span>
0825 <span class="comment">%             RawX = getam(BPMxFamily, BPMxList, Mode, 'Struct');</span>
0826 <span class="comment">%         catch</span>
0827 <span class="comment">%             RawX.Data = NaN*zeros(size(BPMxList,1),1);</span>
0828 <span class="comment">%             RawX.Units = 'Hardware';</span>
0829 <span class="comment">%             RawX.TimeStamp = clock;</span>
0830 <span class="comment">%             fprintf('   %s, GETAM trouble in family %s\n', sprintf('%s',datestr(RawX.TimeStamp,14)), BPMxFamily);</span>
0831 <span class="comment">%         end</span>
0832 <span class="comment">%         setappdata(handles.figure1, 'RawX', RawX);</span>
0833 <span class="comment">%</span>
0834 <span class="comment">%         try</span>
0835 <span class="comment">%             RawY = getam(BPMyFamily, BPMyList, Mode, 'Struct');</span>
0836 <span class="comment">%         catch</span>
0837 <span class="comment">%             RawY.Data = NaN*zeros(size(BPMyList,1),1);</span>
0838 <span class="comment">%             RawY.Units = 'Hardware';</span>
0839 <span class="comment">%             RawY.TimeStamp = clock;</span>
0840 <span class="comment">%             fprintf('   %s, GETAM trouble in family %s\n', sprintf('%s',datestr(RawY.TimeStamp,14)), BPMyFamily);</span>
0841 <span class="comment">%         end</span>
0842 <span class="comment">%         setappdata(handles.figure1, 'RawY', RawY);</span>
0843 <span class="comment">%</span>
0844 <span class="comment">%         % For non-BPM the offset (ie, the setpoint) may have changed</span>
0845 <span class="comment">%         if ~ismemberof(BPMxFamily,'BPM')</span>
0846 <span class="comment">%             % Update the offset to the setpoint</span>
0847 <span class="comment">%             setappdata(handles.figure1,'OffsetX', getsp(BPMxFamily, BPMxList, Mode));</span>
0848 <span class="comment">%         end</span>
0849 <span class="comment">%         if ~ismemberof(BPMyFamily,'BPM')</span>
0850 <span class="comment">%             % Update the offset to the setpoint</span>
0851 <span class="comment">%             setappdata(handles.figure1,'OffsetY', getsp(BPMyFamily, BPMyList, Mode));</span>
0852 <span class="comment">%         end</span>
0853 <span class="comment">%</span>
0854 <span class="comment">%         % Update time</span>
0855 <span class="comment">%         set(handles.('Time'),'String', sprintf('%s',datestr(RawY.TimeStamp,14)));</span>
0856 <span class="comment">%</span>
0857 <span class="comment">%         plotappdatalocal(handles);</span>
0858 <span class="comment">%         drawnow;</span>
0859 <span class="comment">%</span>
0860 <span class="comment">%</span>
0861 <span class="comment">%         if OrbitFeedbackFlag</span>
0862 <span class="comment">%             % One could easily add a orbit feedback step</span>
0863 <span class="comment">%             setorbitdefault([], 1, [], 'NoDisplay');</span>
0864 <span class="comment">%             pause(2.2*Tbpm);</span>
0865 <span class="comment">%         end</span>
0866 <span class="comment">%</span>
0867 <span class="comment">%     else</span>
0868 <span class="comment">%         set(handles.('OnOff'), 'String', 'Continuous');</span>
0869 <span class="comment">%</span>
0870 <span class="comment">%         % Turn latticeaxes menu back on</span>
0871 <span class="comment">%         set(handles.('LatticeMenu'),'enable','on');</span>
0872 <span class="comment">%</span>
0873 <span class="comment">%         break</span>
0874 <span class="comment">%     end</span>
0875 <span class="comment">%</span>
0876 <span class="comment">%     % Pause</span>
0877 <span class="comment">%     T = UpdatePeriod-(gettime-t0);</span>
0878 <span class="comment">%     if T &gt; 0</span>
0879 <span class="comment">%         pause(T);</span>
0880 <span class="comment">%     end</span>
0881 <span class="comment">% end</span>
0882 
0883 
0884 
0885 <span class="comment">% --- Executes on button press in OneShot.</span>
0886 <a name="_sub8" href="#_subfunctions" class="code">function OneShot_Callback(hObject, eventdata, handles)</a>
0887 
0888 <span class="comment">% To break out of the continuous loop (if in it)</span>
0889 <span class="comment">%set(handles.('OnOff'),'Value', 0);  % Not turned off with timer!</span>
0890 
0891 
0892 <span class="comment">% UnitMenu = getappdata(handles.figure1,'UnitsFlag');</span>
0893 <span class="comment">% if UnitMenu == 1</span>
0894 <span class="comment">%     UnitsFlag = 'Physics';</span>
0895 <span class="comment">% else</span>
0896 <span class="comment">%     UnitsFlag = 'Hardware';</span>
0897 <span class="comment">% end</span>
0898 
0899 
0900 <span class="comment">% Get Mode and update the title bar</span>
0901 MachineName     = getfamilydata(<span class="string">'Machine'</span>);
0902 SubMachineName  = getfamilydata(<span class="string">'SubMachine'</span>);
0903 OperationalMode = getfamilydata(<span class="string">'OperationalMode'</span>);
0904 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
0905     Mode = <span class="string">'Simulator'</span>;
0906     set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Plot Family:  %s  -  %s  -  %s  (%s)'</span>, MachineName, SubMachineName, OperationalMode, <span class="string">'Model'</span>));
0907 <span class="keyword">else</span>
0908     Mode = <span class="string">'Online'</span>;
0909     set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Plot Family:  %s  -  %s  -  %s  (%s)'</span>, MachineName, SubMachineName, OperationalMode, <span class="string">'Online'</span>));
0910 <span class="keyword">end</span>
0911 
0912 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
0913 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
0914 
0915 <span class="comment">% Get new data</span>
0916 <span class="keyword">try</span>
0917     RawX = getpv(DataStruct1, Mode, <span class="string">'Struct'</span>);
0918     <span class="comment">%RawX = getpv(DataStruct1, Mode, UnitsFlag, 'Struct');</span>
0919 <span class="keyword">catch</span>
0920     RawX.Data = NaN*zeros(size(DataStruct1.Data,1),1);
0921     RawX.Units = DataStruct1.Units;
0922     RawX.UnitsString = DataStruct1.UnitsString;
0923     RawX.Mode = Mode;
0924     RawX.TimeStamp = clock;
0925     fprintf(<span class="string">'\n%s\n'</span>, lasterr);
0926     fprintf(<span class="string">'   %s, GETPV trouble in family %s\n'</span>, sprintf(<span class="string">'%s'</span>,datestr(RawX.TimeStamp,13)), DataStruct1.FamilyName);
0927 <span class="keyword">end</span>
0928 setappdata(handles.figure1, <span class="string">'RawX'</span>, RawX);
0929 
0930 <span class="keyword">try</span>
0931     RawY = getpv(DataStruct2, Mode, <span class="string">'Struct'</span>);
0932     <span class="comment">%RawY = getpv(DataStruct2, Mode, UnitsFlag, 'Struct');</span>
0933 <span class="keyword">catch</span>
0934     RawY.Data = NaN*zeros(size(DataStruct2.Data,1),1);
0935     RawY.Units = DataStruct2.Units;
0936     RawY.UnitsString = DataStruct2.UnitsString;
0937     RawY.Mode = Mode;
0938     RawY.TimeStamp = clock;
0939     fprintf(<span class="string">'\n%s\n'</span>, lasterr);
0940     fprintf(<span class="string">'   %s, GETPV trouble in family %s\n'</span>, sprintf(<span class="string">'%s'</span>,datestr(RawY.TimeStamp,13)), DataStruct2.FamilyName);
0941 <span class="keyword">end</span>
0942 setappdata(handles.figure1, <span class="string">'RawY'</span>, RawY);
0943 
0944 
0945 <span class="comment">% % For non-BPM the offset (ie, the setpoint) may have changed</span>
0946 <span class="comment">% if ~isempty(getfamilydata(DataStruct1.FamilyName,'Setpoint'))</span>
0947 <span class="comment">%     % Update the offset to the setpoint</span>
0948 <span class="comment">%     setappdata(handles.figure1,'OffsetX', getsp(DataStruct1.FamilyName, Mode, DataStruct1.Units, 'Struct'));</span>
0949 <span class="comment">% end</span>
0950 <span class="comment">% if ~isempty(getfamilydata(DataStruct2.FamilyName,'Setpoint'))</span>
0951 <span class="comment">%     % Update the offset to the setpoint</span>
0952 <span class="comment">%     setappdata(handles.figure1,'OffsetY', getsp(DataStruct2.FamilyName, Mode, DataStruct2.Units, 'Struct'));</span>
0953 <span class="comment">% end</span>
0954 
0955 
0956 <span class="comment">% Update time</span>
0957 set(handles.Time, <span class="string">'String'</span>, sprintf(<span class="string">'%s'</span>,datestr(RawY.TimeStamp,13)));
0958 
0959 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
0960 drawnow;
0961 
0962 
0963 
0964 <a name="_sub9" href="#_subfunctions" class="code">function plotappdatalocal(handles)  </a>
0965 
0966 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
0967     Mode = <span class="string">'Simulator'</span>;
0968 <span class="keyword">else</span>
0969     Mode = <span class="string">'Online'</span>;
0970 <span class="keyword">end</span>
0971 
0972 
0973 <span class="comment">% Get data from appdata</span>
0974 Trace1 = getappdata(handles.figure1,<span class="string">'Trace1'</span>);
0975 Trace2 = getappdata(handles.figure1,<span class="string">'Trace2'</span>);
0976 UnitsFlag = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
0977 
0978 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
0979 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
0980 
0981 RawX = getappdata(handles.figure1, <span class="string">'RawX'</span>);
0982 RawY = getappdata(handles.figure1, <span class="string">'RawY'</span>);
0983 
0984 sx = getappdata(handles.figure1, <span class="string">'SPosX'</span>);
0985 sy = getappdata(handles.figure1, <span class="string">'SPosY'</span>);
0986 
0987 <span class="keyword">if</span> isempty(sx)
0988     error(sprintf(<span class="string">'Position along ring information not available for %s family.'</span>, RawX.FamilyName));
0989     <span class="comment">%sx = 1:size(RawX.Data,1);</span>
0990 <span class="keyword">end</span>
0991 <span class="keyword">if</span> isempty(sy)
0992     error(sprintf(<span class="string">'Position along ring information not available for %s family.'</span>, RawY.FamilyName));
0993     <span class="comment">%sy = 1:size(RawY.Data,1);</span>
0994 <span class="keyword">end</span>
0995 
0996 ChannelA = getappdata(handles.figure1, <span class="string">'ChannelA'</span>);
0997 ChannelB = getappdata(handles.figure1, <span class="string">'ChannelB'</span>);
0998 
0999 <span class="comment">% Make the BPM string matrix (this takes ~.09 sec! but it's easier to update every time)</span>
1000 BPMxMAT = [];
1001 <span class="keyword">for</span> i = 1:size(DataStruct1.DeviceList,1)
1002     BPMxMAT = strvcat(BPMxMAT, sprintf(<span class="string">'%s(%d,%d) = '</span>, DataStruct1.FamilyName, DataStruct1.DeviceList(i,1), DataStruct1.DeviceList(i,2)));
1003 <span class="keyword">end</span>
1004 BPMyMAT = [];
1005 <span class="keyword">for</span> i = 1:size(DataStruct2.DeviceList,1)
1006     BPMyMAT = strvcat(BPMyMAT, sprintf(<span class="string">'%s(%d,%d) = '</span>, DataStruct2.FamilyName, DataStruct2.DeviceList(i,1), DataStruct2.DeviceList(i,2)));
1007 <span class="keyword">end</span>
1008 
1009 <span class="keyword">if</span> Trace1 == 1 || Trace1 == 3 || Trace2 == 1 || Trace2 == 3
1010     <span class="keyword">if</span> ChannelA == 1
1011         DataA1 = RawX.Data;
1012         DataA2 = RawY.Data;
1013     <span class="keyword">elseif</span> ChannelA == 2 <span class="comment">%File</span>
1014         <span class="comment">%DataA1 = getappdata(handles.figure1,'GoldenX');</span>
1015         <span class="comment">%DataA1 = DataA1.Data;</span>
1016         <span class="comment">%DataA2 = getappdata(handles.figure1,'GoldenY');</span>
1017         <span class="comment">%DataA2 = DataA2.Data;</span>
1018 
1019         <span class="keyword">if</span> strcmpi(DataStruct1.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct1.FamilyName,<span class="string">'Setpoint'</span>))
1020             <span class="comment">% Display the setpoint golden value</span>
1021             DataA1 = getgolden(DataStruct1, <span class="string">'Setpoint'</span>, DataStruct1.Units, <span class="string">'Numeric'</span>);
1022         <span class="keyword">else</span>
1023             DataA1 = getgolden(DataStruct1, DataStruct1.Units, <span class="string">'Numeric'</span>);
1024         <span class="keyword">end</span>
1025 
1026         <span class="keyword">if</span> strcmpi(DataStruct2.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct2.FamilyName,<span class="string">'Setpoint'</span>))
1027             <span class="comment">% Display the setpoint golden value</span>
1028             DataA2 = getgolden(DataStruct2, <span class="string">'Setpoint'</span>, DataStruct2.Units, <span class="string">'Numeric'</span>);
1029         <span class="keyword">else</span>
1030             DataA2 = getgolden(DataStruct2, DataStruct2.Units, <span class="string">'Numeric'</span>);
1031         <span class="keyword">end</span>
1032 
1033     <span class="keyword">elseif</span> ChannelA == 3 <span class="comment">%File</span>
1034         <span class="comment">%DataA1 = getappdata(handles.figure1,'OffsetX');</span>
1035         <span class="comment">%DataA1 = DataA1.Data;</span>
1036         <span class="comment">%DataA2 = getappdata(handles.figure1,'OffsetY');</span>
1037         <span class="comment">%DataA2 = DataA2.Data;</span>
1038         
1039         <span class="keyword">if</span> strcmpi(DataStruct1.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct1.FamilyName,<span class="string">'Setpoint'</span>))
1040             <span class="comment">% Update the offset to the setpoint</span>
1041             DataA1 = getsp(DataStruct1, Mode, DataStruct1.Units, <span class="string">'Numeric'</span>);
1042         <span class="keyword">else</span>
1043             DataA1 = getoffset(DataStruct1, DataStruct1.Units, <span class="string">'Numeric'</span>);
1044         <span class="keyword">end</span>
1045         
1046         <span class="keyword">if</span> strcmpi(DataStruct2.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct2.FamilyName,<span class="string">'Setpoint'</span>))
1047             <span class="comment">% Update the offset to the setpoint</span>
1048             DataA2 = getsp(DataStruct2, Mode, DataStruct2.Units, <span class="string">'Numeric'</span>);
1049         <span class="keyword">else</span>
1050             DataA2 = getoffset(DataStruct2, DataStruct2.Units, <span class="string">'Numeric'</span>);
1051         <span class="keyword">end</span>
1052 
1053     <span class="keyword">elseif</span> ChannelA == 4 <span class="comment">%Saved</span>
1054         DataA1 = getappdata(handles.figure1,<span class="string">'SaveX'</span>);
1055         DataA1 = DataA1.Data;
1056         DataA2 = getappdata(handles.figure1,<span class="string">'SaveY'</span>);
1057         DataA2 = DataA2.Data;
1058     <span class="keyword">elseif</span> ChannelA == 5 <span class="comment">%File</span>
1059         DataA1 = getappdata(handles.figure1,<span class="string">'FileX'</span>);
1060         DataA1 = DataA1.Data;
1061         DataA2 = getappdata(handles.figure1,<span class="string">'FileY'</span>);
1062         DataA2 = DataA2.Data;
1063     <span class="keyword">else</span> 
1064         DataA1 = zeros(size(BPMxList,1),1);
1065         DataA2 = zeros(size(BPMyList,1),1);
1066     <span class="keyword">end</span>
1067 <span class="keyword">end</span>
1068 
1069 <span class="keyword">if</span> Trace1 == 2 || Trace1 == 3 || Trace2 == 2 || Trace2 == 3
1070     <span class="keyword">if</span> ChannelB == 1 <span class="comment">%File</span>
1071         DataB1 = RawX.Data;
1072         DataB2 = RawY.Data;
1073     <span class="keyword">elseif</span> ChannelB == 2 <span class="comment">%Golden</span>
1074         <span class="comment">%DataB1 = getappdata(handles.figure1,'GoldenX');</span>
1075         <span class="comment">%DataB1 = DataB1.Data;</span>
1076         <span class="comment">%DataB2 = getappdata(handles.figure1,'GoldenY');</span>
1077         <span class="comment">%DataB2 = DataB2.Data;</span>
1078 
1079         <span class="keyword">if</span> strcmpi(DataStruct1.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct1.FamilyName,<span class="string">'Setpoint'</span>))
1080             <span class="comment">% Display the setpoint golden value</span>
1081             DataB1 = getgolden(DataStruct1, <span class="string">'Setpoint'</span>, DataStruct1.Units, <span class="string">'Numeric'</span>);
1082         <span class="keyword">else</span>
1083             DataB1 = getgolden(DataStruct1, DataStruct1.Units, <span class="string">'Numeric'</span>);
1084         <span class="keyword">end</span>
1085 
1086         <span class="keyword">if</span> strcmpi(DataStruct2.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct2.FamilyName,<span class="string">'Setpoint'</span>))
1087             <span class="comment">% Display the setpoint golden value</span>
1088             DataB2 = getgolden(DataStruct2, <span class="string">'Setpoint'</span>, DataStruct2.Units, <span class="string">'Numeric'</span>);
1089         <span class="keyword">else</span>
1090             DataB2 = getgolden(DataStruct2, DataStruct2.Units, <span class="string">'Numeric'</span>);
1091         <span class="keyword">end</span>
1092 
1093     <span class="keyword">elseif</span> ChannelB == 3 <span class="comment">%Offset</span>
1094         <span class="comment">%DataB1 = getappdata(handles.figure1,'OffsetX');</span>
1095         <span class="comment">%DataB1 = DataB1.Data;</span>
1096         <span class="comment">%DataB2 = getappdata(handles.figure1,'OffsetY');</span>
1097         <span class="comment">%DataB2 = DataB2.Data;</span>
1098 
1099         <span class="keyword">if</span> strcmpi(DataStruct1.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct1.FamilyName,<span class="string">'Setpoint'</span>))
1100             <span class="comment">% Update the offset to the setpoint</span>
1101             DataB1 = getsp(DataStruct1.FamilyName, DataStruct1.DeviceList, Mode, DataStruct1.Units, <span class="string">'Numeric'</span>);
1102         <span class="keyword">else</span>
1103             DataB1 = getoffset(DataStruct1, DataStruct1.DeviceList, DataStruct1.Units, <span class="string">'Numeric'</span>);
1104         <span class="keyword">end</span>
1105 
1106         <span class="keyword">if</span> strcmpi(DataStruct2.Field, <span class="string">'Monitor'</span>) &amp;&amp; ~isempty(getfamilydata(DataStruct2.FamilyName,<span class="string">'Setpoint'</span>))
1107             <span class="comment">% Update the offset to the setpoint</span>
1108             DataB2 = getsp(DataStruct2, Mode, DataStruct2.Units, <span class="string">'Numeric'</span>);
1109         <span class="keyword">else</span>
1110             DataB2 = getoffset(DataStruct2, DataStruct2.Units, <span class="string">'Numeric'</span>);
1111         <span class="keyword">end</span>
1112     <span class="keyword">elseif</span> ChannelB == 4 <span class="comment">%Saved</span>
1113         DataB1 = getappdata(handles.figure1,<span class="string">'SaveX'</span>);
1114         DataB1 = DataB1.Data;
1115         
1116         DataB2 = getappdata(handles.figure1,<span class="string">'SaveY'</span>);
1117         DataB2 = DataB2.Data;
1118 
1119     <span class="keyword">elseif</span> ChannelB == 5 <span class="comment">%File</span>
1120         DataB1 = getappdata(handles.figure1,<span class="string">'FileX'</span>);
1121         DataB1 = DataB1.Data;
1122         DataB2 = getappdata(handles.figure1,<span class="string">'FileY'</span>);
1123         DataB2 = DataB2.Data;
1124     <span class="keyword">else</span>
1125         DataB1 = zeros(size(BPMxList,1),1);
1126         DataB2 = zeros(size(BPMyList,1),1);
1127     <span class="keyword">end</span>
1128 <span class="keyword">end</span>
1129 
1130 
1131 <span class="comment">% First line</span>
1132 <span class="keyword">if</span> Trace1 == 1
1133     Data1 = DataA1;
1134     Data2 = DataA2;
1135 <span class="keyword">elseif</span> Trace1 == 2
1136     Data1 = DataB1;
1137     Data2 = DataB2;
1138 <span class="keyword">elseif</span> Trace1 == 3
1139     Data1 = DataA1 - DataB1;
1140     Data2 = DataA2 - DataB2;
1141 <span class="keyword">end</span>
1142 
1143 
1144 <span class="comment">% Second line</span>
1145 <span class="keyword">if</span> Trace2 == 4 <span class="comment">% Nothing</span>
1146     Data3 = NaN * Data1;
1147     Data4 = NaN * Data2;
1148 <span class="keyword">else</span>
1149     <span class="keyword">if</span> Trace2 == 1 <span class="comment">% channel A</span>
1150         Data3 = DataA1;
1151         Data4 = DataA2;
1152     <span class="keyword">elseif</span> Trace2 == 2 <span class="comment">% channel B</span>
1153         Data3 = DataB1;
1154         Data4 = DataB2;
1155     <span class="keyword">elseif</span> Trace2 == 3 <span class="comment">% A-B</span>
1156         Data3 = DataA1 - DataB1;
1157         Data4 = DataA2 - DataB2;
1158     <span class="keyword">end</span>
1159 <span class="keyword">end</span>
1160 
1161 
1162 
1163 <span class="comment">% if UnitsFlag == 1 &amp;&amp; strcmpi(RawX.Units,'Hardware')</span>
1164 <span class="comment">%     % Physics units requested, data is in Hardware units</span>
1165 <span class="comment">%     Data1 = hw2physics(BPMxFamily, 'Monitor', Data1);</span>
1166 <span class="comment">%     Data2 = hw2physics(BPMyFamily, 'Monitor', Data2);</span>
1167 <span class="comment">%     Data3 = hw2physics(BPMxFamily, 'Monitor', Data3);</span>
1168 <span class="comment">%     Data4 = hw2physics(BPMyFamily, 'Monitor', Data4);</span>
1169 <span class="comment">% elseif (UnitsFlag==2 | UnitsFlag==3) &amp;&amp; strcmpi(RawX.Units,'Physics')</span>
1170 <span class="comment">%     % Hardware units requested, data is in Physics units</span>
1171 <span class="comment">%     Data1 = physics2hw(BPMxFamily, 'Monitor', Data1);</span>
1172 <span class="comment">%     Data2 = physics2hw(BPMyFamily, 'Monitor', Data2);</span>
1173 <span class="comment">%     Data3 = physics2hw(BPMxFamily, 'Monitor', Data3);</span>
1174 <span class="comment">%     Data4 = physics2hw(BPMyFamily, 'Monitor', Data4);</span>
1175 <span class="comment">% end</span>
1176 
1177 UnitsString1 = DataStruct1.UnitsString;
1178 UnitsString2 = DataStruct2.UnitsString;
1179 <span class="comment">% if UnitsFlag == 1</span>
1180 <span class="comment">%     % Physics units</span>
1181 <span class="comment">%     UnitsString1 = getfamilydata(DataStruct1.FamilyName, DataStruct1.Field, 'PhysicsUnits');</span>
1182 <span class="comment">%     UnitsString2 = getfamilydata(DataStruct2.FamilyName, DataStruct2.Field, 'PhysicsUnits');</span>
1183 <span class="comment">% elseif UnitsFlag == 2</span>
1184 <span class="comment">%     % Hardware units</span>
1185 <span class="comment">%     UnitsString1 = getfamilydata(DataStruct1.FamilyName, DataStruct1.Field, 'HWUnits');</span>
1186 <span class="comment">%     UnitsString2 = getfamilydata(DataStruct2.FamilyName, DataStruct2.Field, 'HWUnits');</span>
1187 <span class="keyword">if</span> UnitsFlag == 3
1188     <span class="comment">% Hardware units time 1000</span>
1189     Data1 = 1000 * Data1;
1190     Data2 = 1000 * Data2;
1191     Data3 = 1000 * Data3;
1192     Data4 = 1000 * Data4;
1193     <span class="comment">%UnitsString1 = getfamilydata(DataStruct1.FamilyName, DataStruct1.Field, 'HWUnits');</span>
1194     <span class="comment">%UnitsString2 = getfamilydata(DataStruct2.FamilyName, DataStruct2.Field, 'HWUnits');</span>
1195     <span class="keyword">if</span> strcmpi(UnitsString1,<span class="string">'mm'</span>)
1196         UnitsString1 = <span class="string">'\mum'</span>;
1197     <span class="keyword">else</span>
1198         <span class="comment">%UnitsString1 = ['1000x', UnitsString1];</span>
1199         UnitsString1 = [<span class="string">'milli'</span>, UnitsString1];
1200     <span class="keyword">end</span>
1201     <span class="keyword">if</span> strcmpi(UnitsString2,<span class="string">'mm'</span>)
1202         UnitsString2 = <span class="string">'\mum'</span>;
1203     <span class="keyword">else</span>
1204         <span class="comment">%UnitsString2 = ['1000x', UnitsString2];</span>
1205         UnitsString2 = [<span class="string">'milli'</span>, UnitsString2];
1206     <span class="keyword">end</span>
1207 <span class="keyword">end</span>
1208 
1209 
1210 <span class="comment">% Axes 1</span>
1211 h = get(handles.Graph1,<span class="string">'Children'</span>);
1212 hbar  = findobj(h,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'bar[1,3]'</span>);
1213 hline = findobj(h,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'line[1,3]'</span>);
1214 
1215 AxisRange1X = getappdata(handles.figure1, <span class="string">'AxisRange1X'</span>);
1216 
1217 <span class="comment">% Don't change the axis (unless it's the first time)</span>
1218 <span class="keyword">if</span> isempty(hline)
1219     cla(handles.Graph1)
1220     axes(handles.Graph1);
1221     plot(handles.Graph1, sx, Data3,<span class="string">'.-r'</span>,<span class="string">'Tag'</span>,<span class="string">'line3'</span>);
1222     hold on
1223     h0 = bar(handles.Graph1, sx, Data3,<span class="string">'Tag'</span>,<span class="string">'bar3'</span>,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1224     set(h0, <span class="string">'FaceColor'</span>,<span class="string">'r'</span>); <span class="comment">% for unknown reason color has to be specified outside to work</span>
1225     plot(handles.Graph1, sx, Data1,<span class="string">'.-b'</span>,<span class="string">'Tag'</span>,<span class="string">'line1'</span>);
1226     bar(handles.Graph1, sx, Data1,<span class="string">'FaceColor'</span>,<span class="string">'b'</span>,<span class="string">'Tag'</span>,<span class="string">'bar1'</span>,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1227     hold off
1228 
1229     <span class="comment">% Set defaults</span>
1230     set(handles.Graph1, <span class="string">'Nextplot'</span>,<span class="string">'Add'</span>);
1231     set(handles.Graph1, <span class="string">'YGrid'</span>,<span class="string">'On'</span>);
1232     set(handles.Graph1, <span class="string">'YMinorTick'</span>,<span class="string">'On'</span>);
1233     set(handles.Graph1, <span class="string">'XMinorTick'</span>,<span class="string">'On'</span>);
1234     set(handles.Graph1, <span class="string">'XAxisLocation'</span>,<span class="string">'Bottom'</span>);
1235     set(handles.Graph1, <span class="string">'XTickLabel'</span>,<span class="string">''</span>);
1236 
1237     set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);   
1238     
1239     <span class="keyword">if</span> strcmpi(get(handles.(<span class="string">'YScaleLog1'</span>),<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1240         set(handles.Graph1,<span class="string">'YScale'</span>,<span class="string">'Log'</span>);
1241     <span class="keyword">else</span>
1242         set(handles.Graph1,<span class="string">'YScale'</span>,<span class="string">'Linear'</span>);
1243     <span class="keyword">end</span>
1244     
1245     set(handles.Graph1 ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
1246     h = get(handles.Graph1,<span class="string">'Children'</span>);
1247     <span class="keyword">for</span> i = 1:length(h)
1248         set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
1249     <span class="keyword">end</span>
1250 <span class="keyword">else</span>
1251     <span class="comment">% This fixes a weird error with srcontrol</span>
1252     h = h(end-1:end);
1253     
1254     <span class="keyword">if</span> ~isempty(findstr(DataStruct1.FamilyName,<span class="string">'BPM'</span>)) <span class="comment">% BPM case: lineplot</span>
1255         set(hline(1),<span class="string">'XData'</span>, sx, <span class="string">'YData'</span>, Data1,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1256         set(hline(2),<span class="string">'XData'</span>, sx, <span class="string">'YData'</span>, Data3,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1257         set(hbar(1), <span class="string">'XData'</span>, sx, <span class="string">'YData'</span>, Data1*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1258         set(hbar(2), <span class="string">'XData'</span>, sx, <span class="string">'YData'</span>, Data3*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1259     <span class="keyword">else</span> <span class="comment">% not BPM case: barplot</span>
1260         set(hline(1),<span class="string">'XData'</span>, sx, <span class="string">'Ydata'</span>, Data1*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1261         set(hline(2),<span class="string">'XData'</span>, sx, <span class="string">'Ydata'</span>, Data3*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1262         set(hbar(1), <span class="string">'XData'</span>, sx, <span class="string">'Ydata'</span>, Data1,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1263         set(hbar(2), <span class="string">'XData'</span>, sx, <span class="string">'Ydata'</span>, Data3,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1264 
1265     <span class="keyword">end</span>
1266     set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
1267 <span class="keyword">end</span>
1268 
1269 h_label=get(handles.Graph1,<span class="string">'ylabel'</span>);
1270 
1271 
1272 <span class="keyword">if</span> strcmpi(DataStruct1.Field,<span class="string">'Monitor'</span>)
1273     <span class="keyword">if</span> isempty(UnitsString1)
1274         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s'</span>, DataStruct1.FamilyName), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1275     <span class="keyword">else</span>
1276         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s [%s]'</span>, DataStruct1.FamilyName, UnitsString1), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1277     <span class="keyword">end</span>
1278 <span class="keyword">else</span>
1279     <span class="keyword">if</span> isempty(UnitsString1)
1280         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s.%s'</span>, DataStruct1.FamilyName, DataStruct1.Field), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1281     <span class="keyword">else</span>
1282         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s.%s [%s]'</span>, DataStruct1.FamilyName, DataStruct1.Field, UnitsString1), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1283     <span class="keyword">end</span>
1284 <span class="keyword">end</span>
1285 
1286 
1287 <span class="comment">% Graph 3</span>
1288 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1289     <span class="comment">% Bring Graph 3 forward</span>
1290     axes(handles.Graph3);
1291     set(handles.Graph3,<span class="string">'color'</span>,<span class="string">'none'</span>);
1292     p1 = get(handles.Graph1,<span class="string">'Position'</span>);
1293     p3 = get(handles.Graph3,<span class="string">'Position'</span>);
1294     set(handles.Graph3,<span class="string">'Position'</span>, [p1(1) p1(2) p3(3) p3(4)]);
1295 <span class="keyword">end</span>
1296 
1297 <span class="comment">% Set the list box</span>
1298 Value = get(handles.DataList1,<span class="string">'Value'</span>);
1299 set(handles.DataList1,<span class="string">'Value'</span>, Value);
1300 ListBoxTop = get(handles.DataList1,<span class="string">'ListBoxTop'</span>);
1301 set(handles.DataList1,<span class="string">'String'</span>, [BPMxMAT, num2str(Data1(:),<span class="string">'%+.4e'</span>)]);
1302 set(handles.Trace1max,<span class="string">'String'</span>,<span class="keyword">...</span>
1303     sprintf(<span class="string">'rms = %.4e     mean = %.4e     min = %.4e     max = %.4e       [%s]'</span>, <span class="keyword">...</span>
1304     std(Data1), mean(Data1), min(Data1),  max(Data1),  <span class="keyword">...</span>
1305     UnitsString1));
1306 set(handles.DataList1,<span class="string">'ListBoxTop'</span>, ListBoxTop);
1307 
1308 <span class="comment">% Axes 2</span>
1309 h = get(handles.Graph2,<span class="string">'Children'</span>);
1310 hbar  = findobj(h,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'bar[2,4]'</span>);
1311 hline = findobj(h,<span class="string">'-regexp'</span>,<span class="string">'Tag'</span>,<span class="string">'line[2,4]'</span>);
1312 AxisRange2X = getappdata(handles.figure1, <span class="string">'AxisRange2X'</span>);
1313         
1314 <span class="keyword">if</span> isempty(hline)
1315     cla(handles.Graph2)
1316     axes(handles.Graph2)
1317     plot(handles.Graph2, sy, Data4,<span class="string">'.-r'</span>,<span class="string">'Tag'</span>,<span class="string">'line4'</span>);
1318     hold on
1319     h0 = bar(handles.Graph2, sy, Data4,<span class="string">'Tag'</span>,<span class="string">'bar4'</span>,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1320     set(h0, <span class="string">'FaceColor'</span>,<span class="string">'r'</span>); <span class="comment">% for unknown reason color has to be specified outside to work</span>
1321     plot(handles.Graph2, sy, Data2,<span class="string">'.-b'</span>,<span class="string">'Tag'</span>,<span class="string">'line2'</span>);
1322     bar(handles.Graph2, sy, Data2,<span class="string">'FaceColor'</span>,<span class="string">'b'</span>,<span class="string">'Tag'</span>,<span class="string">'bar2'</span>,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1323     hold off
1324     
1325     <span class="comment">% Set defaults</span>
1326     set(handles.Graph2, <span class="string">'Nextplot'</span>,<span class="string">'Add'</span>);
1327     set(handles.Graph2, <span class="string">'YGrid'</span>,<span class="string">'On'</span>);
1328     set(handles.Graph2, <span class="string">'YMinorTick'</span>,<span class="string">'On'</span>);
1329     set(handles.Graph2, <span class="string">'XMinorTick'</span>,<span class="string">'On'</span>);
1330     
1331     set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange2X)
1332     
1333     <span class="keyword">if</span> strcmpi(get(handles.(<span class="string">'YScaleLog2'</span>),<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1334         set(handles.Graph2,<span class="string">'YScale'</span>,<span class="string">'Log'</span>);
1335     <span class="keyword">else</span>
1336         set(handles.Graph2,<span class="string">'YScale'</span>,<span class="string">'Linear'</span>);
1337     <span class="keyword">end</span>
1338 
1339     set(handles.Graph2 ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
1340     h = get(handles.Graph2,<span class="string">'Children'</span>);
1341     <span class="keyword">for</span> i = 1:length(h)
1342         set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
1343     <span class="keyword">end</span>
1344 <span class="keyword">else</span>
1345     <span class="comment">% This fixes a weird error with srcontrol</span>
1346     h = h(end-1:end);
1347 
1348     <span class="keyword">if</span> ~isempty(findstr(DataStruct2.FamilyName,<span class="string">'BPM'</span>)) <span class="comment">% BPM case: lineplot</span>
1349         set(hline(1),<span class="string">'XData'</span>, sy, <span class="string">'YData'</span>, Data2,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1350         set(hline(2),<span class="string">'XData'</span>, sy, <span class="string">'YData'</span>, Data4,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1351         set(hbar(1), <span class="string">'XData'</span>, sy, <span class="string">'YData'</span>, Data2*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1352         set(hbar(2), <span class="string">'XData'</span>, sy, <span class="string">'YData'</span>, Data4*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1353     <span class="keyword">else</span> <span class="comment">% not BPM case: barplot</span>
1354         set(hline(1),<span class="string">'XData'</span>, sy, <span class="string">'Ydata'</span>, Data2*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1355         set(hline(2),<span class="string">'XData'</span>, sy, <span class="string">'Ydata'</span>, Data4*0,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1356         set(hbar(1), <span class="string">'XData'</span>, sy, <span class="string">'Ydata'</span>, Data2,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1357         set(hbar(2), <span class="string">'XData'</span>, sy, <span class="string">'Ydata'</span>, Data4,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1358     <span class="keyword">end</span>
1359     set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange2X);
1360 <span class="keyword">end</span>
1361 
1362 h_label = get(handles.Graph2,<span class="string">'ylabel'</span>);
1363 <span class="keyword">if</span> strcmpi(DataStruct2.Field,<span class="string">'Monitor'</span>)
1364     <span class="keyword">if</span> isempty(UnitsString2)
1365         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s'</span>, DataStruct2.FamilyName), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1366     <span class="keyword">else</span>
1367         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s [%s]'</span>, DataStruct2.FamilyName, UnitsString2), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1368     <span class="keyword">end</span>
1369 <span class="keyword">else</span>
1370     <span class="keyword">if</span> isempty(UnitsString2)
1371         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s.%s'</span>, DataStruct2.FamilyName, DataStruct2.Field), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1372     <span class="keyword">else</span>
1373         set(h_label,<span class="string">'String'</span>,sprintf(<span class="string">'%s.%s [%s]'</span>, DataStruct2.FamilyName, DataStruct2.Field, UnitsString2), <span class="string">'Interpreter'</span>,<span class="string">'None'</span>);
1374     <span class="keyword">end</span>
1375 <span class="keyword">end</span>
1376 
1377 
1378 <span class="comment">% Graph 4</span>
1379 <span class="keyword">if</span> strcmpi(get(handles.(<span class="string">'AddPlot2_Nothing'</span>),<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1380     <span class="comment">% Bring Graph 4 forward</span>
1381     axes(handles.Graph4);
1382     set(handles.Graph4,<span class="string">'color'</span>,<span class="string">'none'</span>);
1383     p2 = get(handles.Graph2,<span class="string">'Position'</span>);
1384     p4 = get(handles.Graph4,<span class="string">'Position'</span>);
1385     set(handles.Graph4,<span class="string">'Position'</span>, [p2(1) p2(2) p4(3) p4(4)]);
1386 <span class="keyword">end</span>
1387 
1388 drawnow;
1389 
1390 <span class="comment">% Set the list box</span>
1391 Value = get(handles.DataList2,<span class="string">'Value'</span>);
1392 set(handles.DataList2,<span class="string">'Value'</span>, Value);
1393 ListBoxTop = get(handles.DataList2,<span class="string">'ListBoxTop'</span>);
1394 set(handles.DataList2,<span class="string">'String'</span>, [BPMyMAT, num2str(Data2(:),<span class="string">'%+.4e'</span>)]);
1395 set(handles.Trace2max,<span class="string">'String'</span>, <span class="keyword">...</span>
1396     sprintf(<span class="string">'rms = %.4e     mean = %.4e     min = %.4e     max = %.4e       [%s]'</span>, <span class="keyword">...</span>
1397     std(Data2), mean(Data2), min(Data2),  max(Data2),  <span class="keyword">...</span>
1398     UnitsString2));
1399 set(handles.DataList2, <span class="string">'ListBoxTop'</span>, ListBoxTop);
1400 <span class="comment">% toc</span>
1401 
1402 <span class="comment">% --- Executes on button press in RawOrbit1.</span>
1403 <a name="_sub10" href="#_subfunctions" class="code">function RawOrbit1_Callback(hObject, eventdata, handles)</a>
1404 set(handles.RawOrbit1,<span class="string">'Value'</span>, 1);
1405 set(handles.GoldenOrbit1,<span class="string">'Value'</span>, 0);
1406 set(handles.OffsetOrbit1,<span class="string">'Value'</span>, 0);
1407 set(handles.SaveOrbit1,<span class="string">'Value'</span>, 0);
1408 set(handles.FileOrbit1,<span class="string">'Value'</span>, 0);
1409 setappdata(handles.figure1, <span class="string">'ChannelA'</span>, 1);
1410 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1411 <span class="comment">%AutoScaleYLocal(handles);</span>
1412 
1413 <span class="comment">% --- Executes on button press in GoldenOrbit1.</span>
1414 <a name="_sub11" href="#_subfunctions" class="code">function GoldenOrbit1_Callback(hObject, eventdata, handles)</a>
1415 set(handles.RawOrbit1,<span class="string">'Value'</span>, 0);
1416 set(handles.GoldenOrbit1,<span class="string">'Value'</span>, 1);
1417 set(handles.OffsetOrbit1,<span class="string">'Value'</span>, 0);
1418 set(handles.SaveOrbit1,<span class="string">'Value'</span>, 0);
1419 set(handles.FileOrbit1,<span class="string">'Value'</span>, 0);
1420 setappdata(handles.figure1, <span class="string">'ChannelA'</span>, 2);
1421 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1422 <span class="comment">%AutoScaleYLocal(handles);</span>
1423 
1424 <span class="comment">% --- Executes on button press in OffsetOrbit1.</span>
1425 <a name="_sub12" href="#_subfunctions" class="code">function OffsetOrbit1_Callback(hObject, eventdata, handles)</a>
1426 set(handles.RawOrbit1,<span class="string">'Value'</span>, 0);
1427 set(handles.GoldenOrbit1,<span class="string">'Value'</span>, 0);
1428 set(handles.OffsetOrbit1,<span class="string">'Value'</span>, 1);
1429 set(handles.SaveOrbit1,<span class="string">'Value'</span>, 0);
1430 set(handles.FileOrbit1,<span class="string">'Value'</span>, 0);
1431 setappdata(handles.figure1, <span class="string">'ChannelA'</span>, 3);
1432 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1433 <span class="comment">%AutoScaleYLocal(handles);</span>
1434 
1435 <span class="comment">% --- Executes on button press in SaveOrbit1.</span>
1436 <a name="_sub13" href="#_subfunctions" class="code">function SaveOrbit1_Callback(hObject, eventdata, handles)</a>
1437 set(handles.RawOrbit1,<span class="string">'Value'</span>, 0);
1438 set(handles.GoldenOrbit1,<span class="string">'Value'</span>, 0);
1439 set(handles.OffsetOrbit1,<span class="string">'Value'</span>, 0);
1440 set(handles.SaveOrbit1,<span class="string">'Value'</span>, 1);
1441 set(handles.FileOrbit1,<span class="string">'Value'</span>, 0);
1442 setappdata(handles.figure1, <span class="string">'ChannelA'</span>, 4);
1443 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1444 <span class="comment">%AutoScaleYLocal(handles);</span>
1445 
1446 <span class="comment">% --- Executes on button press in FileOrbit1.</span>
1447 <a name="_sub14" href="#_subfunctions" class="code">function FileOrbit1_Callback(hObject, eventdata, handles)</a>
1448 set(handles.RawOrbit1,<span class="string">'Value'</span>, 0);
1449 set(handles.GoldenOrbit1,<span class="string">'Value'</span>, 0);
1450 set(handles.OffsetOrbit1,<span class="string">'Value'</span>, 0);
1451 set(handles.SaveOrbit1,<span class="string">'Value'</span>, 0);
1452 set(handles.FileOrbit1,<span class="string">'Value'</span>, 1);
1453 setappdata(handles.figure1, <span class="string">'ChannelA'</span>, 5);
1454 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1455 <span class="comment">%AutoScaleYLocal(handles);</span>
1456 
1457 
1458 <span class="comment">% --- Executes on button press in RawOrbit2.</span>
1459 <a name="_sub15" href="#_subfunctions" class="code">function RawOrbit2_Callback(hObject, eventdata, handles)</a>
1460 set(handles.RawOrbit2,<span class="string">'Value'</span>, 1);
1461 set(handles.GoldenOrbit2,<span class="string">'Value'</span>, 0);
1462 set(handles.OffsetOrbit2,<span class="string">'Value'</span>, 0);
1463 set(handles.SaveOrbit2,<span class="string">'Value'</span>, 0);
1464 set(handles.FileOrbit2,<span class="string">'Value'</span>, 0);
1465 setappdata(handles.figure1, <span class="string">'ChannelB'</span>, 1);
1466 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1467 <span class="comment">%AutoScaleYLocal(handles);</span>
1468 
1469 <span class="comment">% --- Executes on button press in GoldenOrbit2.</span>
1470 <a name="_sub16" href="#_subfunctions" class="code">function GoldenOrbit2_Callback(hObject, eventdata, handles)</a>
1471 set(handles.RawOrbit2,<span class="string">'Value'</span>, 0);
1472 set(handles.GoldenOrbit2,<span class="string">'Value'</span>, 1);
1473 set(handles.OffsetOrbit2,<span class="string">'Value'</span>, 0);
1474 set(handles.SaveOrbit2,<span class="string">'Value'</span>, 0);
1475 set(handles.FileOrbit2,<span class="string">'Value'</span>, 0);
1476 setappdata(handles.figure1, <span class="string">'ChannelB'</span>, 2);
1477 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1478 <span class="comment">%AutoScaleYLocal(handles);</span>
1479 
1480 <span class="comment">% --- Executes on button press in OffsetOrbit2.</span>
1481 <a name="_sub17" href="#_subfunctions" class="code">function OffsetOrbit2_Callback(hObject, eventdata, handles)</a>
1482 set(handles.RawOrbit2,<span class="string">'Value'</span>, 0);
1483 set(handles.GoldenOrbit2,<span class="string">'Value'</span>, 0);
1484 set(handles.OffsetOrbit2,<span class="string">'Value'</span>, 1);
1485 set(handles.SaveOrbit2,<span class="string">'Value'</span>, 0);
1486 set(handles.FileOrbit2,<span class="string">'Value'</span>, 0);
1487 setappdata(handles.figure1, <span class="string">'ChannelB'</span>, 3);
1488 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1489 <span class="comment">%AutoScaleYLocal(handles);</span>
1490 
1491 <span class="comment">% --- Executes on button press in SaveOrbit2.</span>
1492 <a name="_sub18" href="#_subfunctions" class="code">function SaveOrbit2_Callback(hObject, eventdata, handles)</a>
1493 set(handles.RawOrbit2,<span class="string">'Value'</span>, 0);
1494 set(handles.GoldenOrbit2,<span class="string">'Value'</span>, 0);
1495 set(handles.OffsetOrbit2,<span class="string">'Value'</span>, 0);
1496 set(handles.SaveOrbit2,<span class="string">'Value'</span>, 1);
1497 set(handles.FileOrbit2,<span class="string">'Value'</span>, 0);
1498 setappdata(handles.figure1, <span class="string">'ChannelB'</span>, 4);
1499 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1500 <span class="comment">%AutoScaleYLocal(handles);</span>
1501 
1502 <span class="comment">% --- Executes on button press in FileOrbit2.</span>
1503 <a name="_sub19" href="#_subfunctions" class="code">function FileOrbit2_Callback(hObject, eventdata, handles)</a>
1504 set(handles.RawOrbit2,<span class="string">'Value'</span>, 0);
1505 set(handles.GoldenOrbit2,<span class="string">'Value'</span>, 0);
1506 set(handles.OffsetOrbit2,<span class="string">'Value'</span>, 0);
1507 set(handles.SaveOrbit2,<span class="string">'Value'</span>, 0);
1508 set(handles.FileOrbit2,<span class="string">'Value'</span>, 1);
1509 setappdata(handles.figure1, <span class="string">'ChannelB'</span>, 5);
1510 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1511 <span class="comment">%AutoScaleYLocal(handles);</span>
1512 
1513 <span class="comment">% --- Executes on button press in SaveOrbit1Now.</span>
1514 <a name="_sub20" href="#_subfunctions" class="code">function SaveOrbit1Now_Callback(hObject, eventdata, handles)</a>
1515 RawX = getappdata(handles.figure1,<span class="string">'RawX'</span>);
1516 RawY = getappdata(handles.figure1,<span class="string">'RawY'</span>);
1517 setappdata(handles.figure1,<span class="string">'SaveX'</span>, RawX);
1518 setappdata(handles.figure1,<span class="string">'SaveY'</span>, RawY);
1519 <span class="keyword">if</span> isfield(RawY,<span class="string">'TimeStamp'</span>)
1520     set(handles.SaveTime,<span class="string">'String'</span>, sprintf(<span class="string">'%s'</span>,datestr(RawY.TimeStamp,0)));
1521 <span class="keyword">else</span>
1522     set(handles.SaveTime,<span class="string">'String'</span>, sprintf(<span class="string">'%s'</span>,datestr(clock,0)));
1523 <span class="keyword">end</span>
1524 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1525 <span class="comment">%AutoScaleYLocal(handles);</span>
1526 
1527 
1528 <span class="comment">% --- Executes on button press in LoadOrbit1.</span>
1529 <a name="_sub21" href="#_subfunctions" class="code">function LoadOrbit1_Callback(hObject, eventdata, handles)</a>
1530 UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
1531 <span class="keyword">if</span> UnitMenu == 1
1532     UnitsFlag = <span class="string">'Physics'</span>;
1533 <span class="keyword">else</span>
1534     UnitsFlag = <span class="string">'Hardware'</span>;
1535 <span class="keyword">end</span>
1536 
1537 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
1538 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
1539 
1540 
1541 <span class="comment">% DirectoryName = getfamilydata('Directory','DataRoot');</span>
1542 DirectoryName = getfamilydata(<span class="string">'Directory'</span>, <span class="string">'BPMData'</span>);
1543 [FileName, DirectoryName] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a File'</span>, [DirectoryName]);
1544 <span class="keyword">if</span> FileName == 0 
1545     <span class="keyword">return</span>
1546 <span class="keyword">end</span>
1547 
1548 <span class="comment">% Remove .mat</span>
1549 <span class="comment">%if strcmpi(FileName(end-3:end), '.mat')</span>
1550 <span class="comment">%    FileName = FileName(1:end-4);</span>
1551 <span class="comment">%end</span>
1552 
1553 <span class="comment">% Graph 1</span>
1554 <span class="keyword">try</span>
1555     DataStruct = getdata(DataStruct1.FamilyName, DataStruct1.DeviceList, [DirectoryName FileName], <span class="string">'Struct'</span>);
1556     <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(DataStruct.Units,<span class="string">'Hardware'</span>)
1557         <span class="comment">% Physics units requested</span>
1558         DataStruct = hw2physics(DataStruct);
1559     <span class="keyword">elseif</span> (UnitMenu==2 || UnitMenu==3) &amp;&amp; strcmpi(DataStruct.Units,<span class="string">'Physics'</span>)
1560         <span class="comment">% Hardware units requested, data is in Physics units</span>
1561         DataStruct = physics2hw(DataStruct);
1562     <span class="keyword">end</span>
1563     setappdata(handles.figure1, <span class="string">'FileX'</span>, DataStruct);
1564     setappdata(handles.figure1, <span class="string">'FileNameX'</span>, [DirectoryName FileName]);
1565 <span class="keyword">end</span>
1566 
1567 <span class="comment">% Graph 2</span>
1568 <span class="keyword">try</span>
1569     DataStruct = getdata(DataStruct2.FamilyName, DataStruct1.DeviceList, [DirectoryName FileName], <span class="string">'Struct'</span>);
1570     <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(DataStruct.Units,<span class="string">'Hardware'</span>)
1571         <span class="comment">% Physics units requested</span>
1572         DataStruct = hw2physics(DataStruct);
1573     <span class="keyword">elseif</span> (UnitMenu==2 || UnitMenu==3) &amp;&amp; strcmpi(DataStruct.Units,<span class="string">'Physics'</span>)
1574         <span class="comment">% Hardware units requested, data is in Physics units</span>
1575         DataStruct = physics2hw(DataStruct);
1576     <span class="keyword">end</span>
1577     setappdata(handles.figure1, <span class="string">'FileY'</span>, DataStruct);
1578     setappdata(handles.figure1, <span class="string">'FileNameY'</span>, [DirectoryName FileName]);
1579 <span class="keyword">catch</span>
1580 <span class="keyword">end</span>
1581 
1582 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1583 <span class="comment">%AutoScaleYLocal(handles);</span>
1584 <a href="#_sub22" class="code" title="subfunction UpdateFileDisplayLocal(handles)">UpdateFileDisplayLocal</a>(handles);
1585 
1586 
1587 <span class="comment">% --- local function to update filename on the display.</span>
1588 <a name="_sub22" href="#_subfunctions" class="code">function UpdateFileDisplayLocal(handles)</a>
1589 
1590 FileNameX = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
1591 FileNameY = getappdata(handles.figure1, <span class="string">'FileNameY'</span>);
1592 
1593 <span class="keyword">if</span> isempty(FileNameX) &amp;&amp; isempty(FileNameY)
1594     set(handles.FileNameX,<span class="string">'String'</span>, <span class="string">'File X: not loaded'</span>);
1595     set(handles.FileNameY,<span class="string">'String'</span>, <span class="string">'File Z: not loaded'</span>);
1596     drawnow;
1597     <span class="keyword">return</span>;
1598 <span class="keyword">end</span>
1599 
1600 <span class="keyword">if</span> ~isempty(FileNameX)
1601     <span class="comment">% Remove directories</span>
1602     i = findstr(FileNameX, filesep);
1603     <span class="keyword">if</span> ~isempty(i)
1604         FileNameX = FileNameX(i(end)+1:end);
1605     <span class="keyword">end</span>
1606     
1607     <span class="comment">% Shorten length</span>
1608     <span class="keyword">if</span> length(FileNameX) &gt;= 31
1609         <span class="comment">% Remove .mat</span>
1610         <span class="keyword">if</span> strcmpi(FileNameX(end-3:end),<span class="string">'.mat'</span>)
1611             FileNameX = FileNameX(1:end-4);  <span class="comment">% remove .mat</span>
1612         <span class="keyword">end</span>
1613         
1614         <span class="keyword">if</span> length(FileNameX) &gt;= 31
1615             FileNameX = FileNameX(1:31);
1616         <span class="keyword">end</span>
1617     <span class="keyword">end</span>
1618 
1619     set(handles.FileNameX,<span class="string">'String'</span>, sprintf(<span class="string">'File X: %s'</span>, FileNameX));
1620 <span class="keyword">else</span>
1621     set(handles.FileNameX,<span class="string">'String'</span>, <span class="string">'File 1: no data'</span>);
1622 <span class="keyword">end</span>
1623 
1624 <span class="keyword">if</span> ~isempty(FileNameY)
1625     <span class="comment">% Remove directories</span>
1626     i = findstr(FileNameY,filesep);
1627     <span class="keyword">if</span> ~isempty(i)
1628         FileNameY = FileNameY(i(end)+1:end);
1629     <span class="keyword">end</span>
1630     
1631     <span class="comment">% Shorten length</span>
1632     <span class="keyword">if</span> length(FileNameY) &gt;= 31
1633         <span class="comment">% Remove .mat</span>
1634         <span class="keyword">if</span> strcmpi(FileNameY(end-3:end),<span class="string">'.mat'</span>)
1635             FileNameY = FileNameY(1:end-4);  <span class="comment">% remove .mat</span>
1636         <span class="keyword">end</span>
1637         <span class="keyword">if</span> length(FileNameY) &gt;= 31
1638             FileNameY = FileNameY(1:31);
1639         <span class="keyword">end</span>
1640     <span class="keyword">end</span>
1641     
1642     <span class="comment">%set(handles.FileNameY,'String', sprintf('File 2: %s', FileNameY));</span>
1643     set(handles.FileNameY,<span class="string">'String'</span>, sprintf(<span class="string">'File Y: %s'</span>, FileNameY));
1644 <span class="keyword">else</span>
1645     set(handles.FileNameY,<span class="string">'String'</span>, <span class="string">'File 2: no data'</span>);
1646 <span class="keyword">end</span>
1647 
1648 <span class="keyword">if</span> strcmpi(FileNameX, FileNameY) &amp;&amp; ~isempty(FileNameX)
1649     set(handles.FileNameY,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
1650     set(handles.FileNameX,<span class="string">'String'</span>, sprintf(<span class="string">'%s'</span>, FileNameX));
1651     <span class="comment">%p = get(handles.FileNameX,'Position');</span>
1652     <span class="comment">%set(handles.FileName,'Position', [p(1) 4 p(3) p(4)]);   % Points</span>
1653     <span class="comment">%set(handles.FileNameX,'Position', [p(1) .4 p(3) p(4)]);   % Characters</span>
1654     <span class="comment">%p = get(handles.SaveTime,'Position');</span>
1655     <span class="comment">%set(handles.SaveTime,'Position', [p(1) 16.5 p(3) p(4)]);  % Points</span>
1656     <span class="comment">%set(handles.SaveTime,'Position', [p(1) 1.6 p(3) p(4)]);    % Characters</span>
1657 <span class="keyword">else</span>
1658     <span class="comment">%p = get(handles.FileNameX,'Position');</span>
1659     <span class="comment">%set(handles.FileName,'Position', [p(1) 10 p(3) p(4)]);  % Points</span>
1660     <span class="comment">%set(handles.FileNameX,'Position', [p(1) 1.1 p(3) p(4)]);  % Characters</span>
1661     <span class="comment">%set(handles.FileNameY,'Visible','on');</span>
1662     <span class="comment">%p = get(handles.SaveTime,'Position');</span>
1663     <span class="comment">%set(handles.SaveTime,'Position', [p(1) 20 p(3) p(4)]);  % Points</span>
1664     <span class="comment">%set(handles.SaveTime,'Position', [p(1) 2.0 p(3) p(4)]);  % Characters</span>
1665 <span class="keyword">end</span>
1666 
1667 drawnow;
1668 
1669 
1670 <span class="comment">% --- Executes on button press in Display1.</span>
1671 <a name="_sub23" href="#_subfunctions" class="code">function Display1_Callback(hObject, eventdata, handles)</a>
1672 set(handles.DisplayDiff,<span class="string">'Value'</span>, 0);
1673 set(handles.Display1,<span class="string">'Value'</span>, 1);
1674 set(handles.Display2,<span class="string">'Value'</span>, 0);
1675 setappdata(handles.figure1,<span class="string">'Trace1'</span>,1);
1676 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1677 <span class="comment">%AutoScaleYLocal(handles);</span>
1678 
1679 <span class="comment">% --- Executes on button press in Display2.</span>
1680 <a name="_sub24" href="#_subfunctions" class="code">function Display2_Callback(hObject, eventdata, handles)</a>
1681 set(handles.DisplayDiff,<span class="string">'Value'</span>, 0);
1682 set(handles.Display1,<span class="string">'Value'</span>, 0);
1683 set(handles.Display2,<span class="string">'Value'</span>, 1);
1684 setappdata(handles.figure1,<span class="string">'Trace1'</span>,2);
1685 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1686 <span class="comment">%AutoScaleYLocal(handles);</span>
1687 
1688 <span class="comment">% --- Executes on button press in DisplayDiff.</span>
1689 <a name="_sub25" href="#_subfunctions" class="code">function DisplayDiff_Callback(hObject, eventdata, handles)</a>
1690 set(handles.DisplayDiff,<span class="string">'Value'</span>, 1);
1691 set(handles.Display1,<span class="string">'Value'</span>, 0);
1692 set(handles.Display2,<span class="string">'Value'</span>, 0);
1693 setappdata(handles.figure1,<span class="string">'Trace1'</span>,3);
1694 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1695 <span class="comment">%AutoScaleYLocal(handles);</span>
1696 
1697 
1698 <span class="comment">% --- Executes on button press in Trace2A.</span>
1699 <a name="_sub26" href="#_subfunctions" class="code">function Trace2A_Callback(hObject, eventdata, handles)</a>
1700 set(handles.Trace2A,<span class="string">'Value'</span>, 1);
1701 set(handles.Trace2B,<span class="string">'Value'</span>, 0);
1702 set(handles.Trace2A_B,<span class="string">'Value'</span>, 0);
1703 set(handles.Trace2Off,<span class="string">'Value'</span>, 0);
1704 setappdata(handles.figure1,<span class="string">'Trace2'</span>,1);
1705 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1706 <span class="comment">%AutoScaleYLocal(handles);</span>
1707 
1708 <span class="comment">% --- Executes on button press in Trace2B.</span>
1709 <a name="_sub27" href="#_subfunctions" class="code">function Trace2B_Callback(hObject, eventdata, handles)</a>
1710 set(handles.Trace2A,<span class="string">'Value'</span>, 0);
1711 set(handles.Trace2B,<span class="string">'Value'</span>, 1);
1712 set(handles.Trace2A_B,<span class="string">'Value'</span>, 0);
1713 set(handles.Trace2Off,<span class="string">'Value'</span>, 0);
1714 setappdata(handles.figure1,<span class="string">'Trace2'</span>,2);
1715 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1716 <span class="comment">%AutoScaleYLocal(handles);</span>
1717 
1718 <span class="comment">% --- Executes on button press in Trace2A_B.</span>
1719 <a name="_sub28" href="#_subfunctions" class="code">function Trace2A_B_Callback(hObject, eventdata, handles)</a>
1720 set(handles.Trace2A,<span class="string">'Value'</span>, 0);
1721 set(handles.Trace2B,<span class="string">'Value'</span>, 0);
1722 set(handles.Trace2A_B,<span class="string">'Value'</span>, 1);
1723 set(handles.Trace2Off,<span class="string">'Value'</span>, 0);
1724 setappdata(handles.figure1,<span class="string">'Trace2'</span>,3);
1725 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1726 <span class="comment">%AutoScaleYLocal(handles);</span>
1727 
1728 <span class="comment">% --- Executes on button press in Trace2Off.</span>
1729 <a name="_sub29" href="#_subfunctions" class="code">function Trace2Off_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;DEFNU&gt;</span>
1730 set(handles.Trace2A,<span class="string">'Value'</span>, 0);
1731 set(handles.Trace2B,<span class="string">'Value'</span>, 0);
1732 set(handles.Trace2A_B,<span class="string">'Value'</span>, 0);
1733 set(handles.Trace2Off,<span class="string">'Value'</span>, 1);
1734 setappdata(handles.figure1,<span class="string">'Trace2'</span>,4);
1735 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
1736 <span class="comment">%AutoScaleYLocal(handles);</span>
1737 
1738 
1739 <span class="comment">% --- Executes on selection change in DataList1.</span>
1740 <a name="_sub30" href="#_subfunctions" class="code">function DataList1_Callback(hObject, eventdata, handles)</a>
1741 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1742     Mode = <span class="string">'Simulator'</span>;
1743 <span class="keyword">else</span>
1744     Mode = <span class="string">'Online'</span>;
1745 <span class="keyword">end</span>
1746 
1747 i = get(hObject,<span class="string">'Value'</span>);
1748 DataStruct = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
1749 
1750 Family = DataStruct.FamilyName;
1751 Field = DataStruct.Field;
1752 List = DataStruct.DeviceList;
1753 [tmp,ao] = isfamily(Family);
1754 
1755 <span class="keyword">if</span> strcmpi(Field, <span class="string">'Monitor'</span>)
1756     Field = <span class="string">'Setpoint'</span>;
1757 <span class="keyword">end</span>
1758 
1759 set(handles.DataList1, <span class="string">'TooltipString'</span>, cell2mat(family2tangodev(Family,List(i,:))));
1760 
1761 <span class="keyword">if</span> isfield(ao, Field)
1762     <span class="keyword">if</span> getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>) == 1
1763         UnitsFlag = <span class="string">'Physics'</span>;
1764     <span class="keyword">else</span>
1765         UnitsFlag = <span class="string">'Hardware'</span>;
1766     <span class="keyword">end</span>
1767 
1768     <span class="comment">% Get/save the present setpoint then call the GUI for setpoint changes</span>
1769     <span class="keyword">try</span>
1770         SP = getpv(Family, Field, List(i,:), Mode, UnitsFlag, <span class="string">'Struct'</span>);
1771         set(handles.SetpointSlider,     <span class="string">'UserData'</span>, SP);
1772         set(handles.SetpointPushButton, <span class="string">'UserData'</span>, SP);
1773 
1774         <a href="#_sub93" class="code" title="subfunction SetpointGUI_Callback(hObject, eventdata, handles)">SetpointGUI_Callback</a>(hObject, eventdata, handles);
1775     <span class="keyword">catch</span>
1776         fprintf(<span class="string">'   Trouble finding the present value of %s.%s(%d,%d)\n'</span>,Family, Field, List(i,:));
1777     <span class="keyword">end</span>
1778 <span class="keyword">end</span>
1779 
1780 
1781 <span class="comment">% --- Executes on selection change in DataList2.</span>
1782 <a name="_sub31" href="#_subfunctions" class="code">function DataList2_Callback(hObject, eventdata, handles)</a>
1783 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1784     Mode = <span class="string">'Simulator'</span>;
1785 <span class="keyword">else</span>
1786     Mode = <span class="string">'Online'</span>;
1787 <span class="keyword">end</span>
1788 
1789 i = get(hObject,<span class="string">'Value'</span>);
1790 DataStruct = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
1791 
1792 Family = DataStruct.FamilyName;
1793 Field = DataStruct.Field;
1794 List = DataStruct.DeviceList;
1795 [tmp,ao] = isfamily(Family);
1796 
1797 <span class="keyword">if</span> strcmpi(Field, <span class="string">'Monitor'</span>)
1798     Field = <span class="string">'Setpoint'</span>;
1799 <span class="keyword">end</span>
1800 
1801 set(handles.DataList2, <span class="string">'TooltipString'</span>, cell2mat(family2tangodev(Family,List(i,:))));
1802 
1803 <span class="keyword">if</span> isfield(ao, Field)
1804     <span class="keyword">if</span> getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>) == 1
1805         UnitsFlag = <span class="string">'Physics'</span>;
1806     <span class="keyword">else</span>
1807         UnitsFlag = <span class="string">'Hardware'</span>;
1808     <span class="keyword">end</span>
1809 
1810     <span class="comment">% Get/save the present setpoint then call the GUI for setpoint changes</span>
1811     <span class="keyword">try</span>
1812         SP = getpv(Family, Field, List(i,:), Mode, UnitsFlag, <span class="string">'Struct'</span>);
1813         set(handles.SetpointSlider, <span class="string">'UserData'</span>, SP);
1814         set(handles.SetpointPushButton, <span class="string">'UserData'</span>, SP);
1815 
1816         <a href="#_sub93" class="code" title="subfunction SetpointGUI_Callback(hObject, eventdata, handles)">SetpointGUI_Callback</a>(hObject, eventdata, handles);
1817     <span class="keyword">catch</span>
1818         fprintf(<span class="string">'   Trouble finding the present value of %s.%s(%d,%d)\n'</span>,Family, Field, List(i,:));
1819     <span class="keyword">end</span>
1820 <span class="keyword">end</span>
1821 
1822 
1823 
1824 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
1825 <span class="comment">% MENU CALLBACKS %</span>
1826 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
1827 
1828 <span class="comment">% --------------------------------------------------------------------</span>
1829 <a name="_sub32" href="#_subfunctions" class="code">function PopPlot_Callback(hObject, eventdata, handles)</a>
1830 a = figure;
1831 b = copyobj(handles.Graph1, a); 
1832 set(b, <span class="string">'Position'</span>, [0.1300    0.5811    0.7750    0.3439]);
1833 set(b, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1834 set(b, <span class="string">'XAxisLocation'</span>,<span class="string">'Bottom'</span>);
1835 
1836 b = copyobj(handles.Graph2, a); 
1837 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.3439]);
1838 set(b, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1839 xlabel(b, <span class="string">'Position [meters]'</span>);
1840 
1841 Data = getappdata(handles.figure1, <span class="string">'RawY'</span>);
1842 <span class="keyword">if</span> isfield(Data, <span class="string">'TimeStamp'</span>)
1843     addlabel(1,0,datestr(Data.TimeStamp,21));
1844 <span class="keyword">end</span>
1845 orient tall
1846 
1847 
1848 <span class="comment">% --------------------------------------------------------------------</span>
1849 <a name="_sub33" href="#_subfunctions" class="code">function PopPlot1_Callback(hObject, eventdata, handles)</a>
1850 <span class="comment">%set(handles.figure1, 'HandleVisibility','Callback');</span>
1851 
1852 a = figure;
1853 b = copyobj(handles.Graph1, a); 
1854 set(b, <span class="string">'Position'</span>,[0.13 0.11 0.775 0.815]); 
1855 set(b, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1856 set(b, <span class="string">'XAxisLocation'</span>,<span class="string">'Bottom'</span>);
1857 Axis1 = axis;
1858 
1859 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1860     set(b, <span class="string">'Position'</span>,[0.13 0.11 0.775 0.7]); 
1861     c = copyobj(handles.Graph3, a); 
1862     
1863     <span class="comment">% Plot on top of each other</span>
1864     <span class="comment">%set(c, 'Position',[0.13 0.11 0.775 0.815]);</span>
1865     
1866     <span class="comment">% Separate plots</span>
1867     set(c, <span class="string">'Position'</span>,[0.13 0.11+.72 0.775 0.12]); 
1868     
1869     set(c,<span class="string">'color'</span>,[1 1 1]);
1870     set(c,<span class="string">'Visible'</span>,<span class="string">'On'</span>);   
1871     set(c,<span class="string">'XAxisLocation'</span>,<span class="string">'Top'</span>);
1872     set(c,<span class="string">'XTick'</span>,get(b,<span class="string">'XTick'</span>));
1873     <span class="comment">%set(c,'XTickLabel',get(b,'XTickLabel'));</span>
1874     set(c,<span class="string">'XTickLabel'</span>,[]);
1875     set(c,<span class="string">'XMinorTick'</span>,<span class="string">'On'</span>);
1876     set(c,<span class="string">'XMinorGrid'</span>,<span class="string">'Off'</span>);
1877     set(c,<span class="string">'XGrid'</span>,<span class="string">'Off'</span>);
1878     set(c,<span class="string">'YGrid'</span>,<span class="string">'Off'</span>);
1879     set(c,<span class="string">'XAxisLocation'</span>,<span class="string">'Bottom'</span>);
1880     set(c,<span class="string">'YAxisLocation'</span>,<span class="string">'Left'</span>);
1881     <span class="comment">%set(c,'YAxisLocation','Right');</span>
1882     set(c,<span class="string">'YTick'</span>,[]);
1883     set(c,<span class="string">'YMinorTick'</span>,<span class="string">'Off'</span>);
1884     set(c,<span class="string">'YMinorGrid'</span>,<span class="string">'Off'</span>);
1885     set(c,<span class="string">'YTickLabel'</span>,[]);
1886     axis(c,<span class="string">'tight'</span>);
1887     Axis2 = axis(c); 
1888     axis(c,[Axis1(1) Axis1(2) Axis2(3)-.2*(Axis2(4)-Axis2(3)) Axis2(4)+.2*(Axis2(4)-Axis2(3))]);
1889     
1890     set(c, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1891 
1892     <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1893         ylabel(c, <span class="string">'Beta X'</span>);
1894     <span class="keyword">end</span>
1895     <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1896         ylabel(c, <span class="string">'Beta Y'</span>);
1897     <span class="keyword">end</span>
1898     <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_DispX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1899         ylabel(c, <span class="string">'Disp X'</span>);
1900     <span class="keyword">end</span>
1901     <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_DispY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1902         ylabel(c, <span class="string">'Disp Y'</span>);
1903     <span class="keyword">end</span>
1904 <span class="keyword">end</span>
1905 xlabel(b, <span class="string">'Position [meters]'</span>);
1906 Data = getappdata(handles.figure1, <span class="string">'RawX'</span>);
1907 <span class="keyword">if</span> isfield(Data, <span class="string">'TimeStamp'</span>) &amp;&amp; ~isempty(Data.TimeStamp)
1908     addlabel(1,0,datestr(Data.TimeStamp,21));
1909 <span class="keyword">end</span>
1910 orient portrait
1911 
1912 
1913 <span class="comment">% --------------------------------------------------------------------</span>
1914 <a name="_sub34" href="#_subfunctions" class="code">function PopPlot2_Callback(hObject, eventdata, handles)</a>
1915 set(handles.Graph2, <span class="string">'HandleVisibility'</span>, <span class="string">'Callback'</span>); 
1916 
1917 a = figure;
1918 b = copyobj(handles.Graph2, a); 
1919 set(b, <span class="string">'Position'</span>,[0.13 0.11 0.775 0.815]); 
1920 set(b, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1921 Axis1 = axis;
1922 
1923 <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_Nothing,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1924     set(b, <span class="string">'Position'</span>,[0.13 0.11 0.775 0.7]); 
1925     c = copyobj(handles.Graph4, a); 
1926     
1927     <span class="comment">% Plot on top of each other</span>
1928     <span class="comment">%set(c, 'Position',[0.13 0.11 0.775 0.815]);</span>
1929     
1930     <span class="comment">% Separate plots</span>
1931     set(c, <span class="string">'Position'</span>,[0.13 0.11+.72 0.775 0.12]); 
1932     
1933     set(c,<span class="string">'color'</span>,[1 1 1]);
1934     set(c,<span class="string">'Visible'</span>,<span class="string">'On'</span>);   
1935     set(c,<span class="string">'XAxisLocation'</span>,<span class="string">'Top'</span>);
1936     set(c,<span class="string">'XTick'</span>,get(b,<span class="string">'XTick'</span>));
1937     set(c,<span class="string">'XTickLabel'</span>,get(b,<span class="string">'XTickLabel'</span>));
1938     <span class="comment">%set(c,'XTickLabel',[]);</span>
1939     set(c,<span class="string">'XMinorTick'</span>,<span class="string">'On'</span>);
1940     set(c,<span class="string">'XMinorGrid'</span>,<span class="string">'Off'</span>);
1941     set(c,<span class="string">'XGrid'</span>,<span class="string">'Off'</span>);
1942     set(c,<span class="string">'YGrid'</span>,<span class="string">'Off'</span>);
1943     set(c,<span class="string">'YAxisLocation'</span>,<span class="string">'Left'</span>);
1944 
1945     <span class="comment">% Turn y-axis on</span>
1946     set(c,<span class="string">'YTick'</span>,[]);
1947     set(c,<span class="string">'YMinorTick'</span>,<span class="string">'Off'</span>);
1948     set(c,<span class="string">'YMinorGrid'</span>,<span class="string">'Off'</span>);
1949     set(c,<span class="string">'YTickLabel'</span>,[]);
1950     axis(c,<span class="string">'tight'</span>);
1951     Axis2 = axis(c); 
1952     axis(c,[Axis1(1) Axis1(2) Axis2(3)-.2*(Axis2(4)-Axis2(3)) Axis2(4)+.2*(Axis2(4)-Axis2(3))]);
1953     
1954     set(c, <span class="string">'ButtonDownFcn'</span>,<span class="string">''</span>);
1955 
1956     <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1957         ylabel(c,<span class="string">'Beta X'</span>);
1958     <span class="keyword">end</span>
1959     <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1960         ylabel(c,<span class="string">'Beta Y'</span>);
1961     <span class="keyword">end</span>
1962     <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_DispX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1963         ylabel(c,<span class="string">'Disp X'</span>);
1964     <span class="keyword">end</span>
1965     <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_DispY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1966         ylabel(c,<span class="string">'Disp Y'</span>);
1967     <span class="keyword">end</span>
1968 <span class="keyword">end</span>
1969 xlabel(<span class="string">'Position [meters]'</span>);
1970 Data = getappdata(handles.figure1, <span class="string">'RawY'</span>);
1971 <span class="keyword">if</span> isfield(Data, <span class="string">'TimeStamp'</span>) &amp;&amp; ~isempty(Data.TimeStamp)
1972     addlabel(1,0,datestr(Data.TimeStamp,21));
1973 <span class="keyword">end</span>
1974 orient portrait
1975 
1976 
1977 <span class="comment">% --------------------------------------------------------------------</span>
1978 <a name="_sub35" href="#_subfunctions" class="code">function Axis1_Callback(hObject, eventdata, handles)</a>
1979 a = axis(handles.Graph1);
1980 a = a(3:4);
1981 answer = inputdlg(<span class="string">'New upper graph vertical axis [2 element vector]'</span>,<span class="string">''</span>,1,{sprintf(<span class="string">'[%s]'</span>,num2str(a))});
1982 <span class="keyword">if</span> ~isempty(answer)
1983     a = str2num(answer{1});
1984     <span class="keyword">if</span> length(a) == 2
1985         set(handles.Graph1, <span class="string">'YLim'</span>, a);
1986     <span class="keyword">else</span>
1987         fprintf(<span class="string">'   Vertical axis needs to be a 2 element vector.\n'</span>);
1988     <span class="keyword">end</span>
1989 <span class="keyword">end</span>
1990 
1991 
1992 <span class="comment">% --------------------------------------------------------------------</span>
1993 <a name="_sub36" href="#_subfunctions" class="code">function Axis2_Callback(hObject, eventdata, handles)</a>
1994 a = axis(handles.Graph2);
1995 a = a(3:4);
1996 answer = inputdlg(<span class="string">'New lower graph vertical axis [2 element vector]'</span>,<span class="string">''</span>,1,{sprintf(<span class="string">'[%s]'</span>,num2str(a))});
1997 <span class="keyword">if</span> ~isempty(answer)
1998     a = str2num(answer{1});
1999     <span class="keyword">if</span> length(a) == 2
2000         set(handles.Graph2, <span class="string">'YLim'</span>, a);
2001     <span class="keyword">else</span>
2002         fprintf(<span class="string">'   Vertical axis needs to be a 2 element vector.\n'</span>);
2003     <span class="keyword">end</span>
2004 <span class="keyword">end</span>
2005 
2006 
2007 <span class="comment">% --------------------------------------------------------------------</span>
2008 <a name="_sub37" href="#_subfunctions" class="code">function HorizontalAxis_Callback(hObject, eventdata, handles)</a>
2009 a = axis(handles.Graph2);
2010 a = a(1:2);
2011 answer = inputdlg(<span class="string">'New horizontal axis [2 element vector]'</span>,<span class="string">''</span>,1,{sprintf(<span class="string">'[%s]'</span>,num2str(a))});
2012 <span class="keyword">if</span> ~isempty(answer)
2013     a = str2num(answer{1});
2014     <span class="keyword">if</span> length(a) == 2
2015         set(handles.Graph1, <span class="string">'XLim'</span>, a);
2016         set(handles.Graph2, <span class="string">'XLim'</span>, a);
2017         set(handles.Graph3, <span class="string">'XLim'</span>, a);
2018         set(handles.Graph4, <span class="string">'XLim'</span>, a);
2019         set(handles.LatticeAxes, <span class="string">'XLim'</span>, a);
2020         setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, a(:)');
2021         setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, a(:)');
2022     <span class="keyword">else</span>
2023         fprintf(<span class="string">'   Horizontal axis needs to be a 2 element vector.\n'</span>);
2024     <span class="keyword">end</span>
2025 <span class="keyword">end</span>
2026 
2027 
2028 <span class="comment">% --------------------------------------------------------------------</span>
2029 <a name="_sub38" href="#_subfunctions" class="code">function HorizontalAxisSector_Callback(hObject, eventdata, handles)</a>
2030 a = eventdata;
2031 <span class="keyword">if</span> length(a) == 2
2032     set(handles.Graph1, <span class="string">'XLim'</span>, a);
2033     set(handles.Graph2, <span class="string">'XLim'</span>, a);
2034     set(handles.Graph3, <span class="string">'XLim'</span>, a);
2035     set(handles.Graph4, <span class="string">'XLim'</span>, a);
2036     set(handles.LatticeAxes, <span class="string">'XLim'</span>, a);
2037 
2038     setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, a(:)');
2039     setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, a(:)');
2040 <span class="keyword">else</span>
2041     fprintf(<span class="string">'   Horizontal axis needs to be a 2 element vector.\n'</span>);
2042 <span class="keyword">end</span>
2043 
2044 
2045 
2046 
2047 <span class="comment">% --------------------------------------------------------------------</span>
2048 <a name="_sub39" href="#_subfunctions" class="code">function YScaleLog1_Callback(hObject, eventdata, handles)</a>
2049 set(handles.Graph1,<span class="string">'YScale'</span>,<span class="string">'Log'</span>);
2050 set(handles.YScaleLog1,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2051 set(handles.YScaleLinear1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2052 drawnow;
2053 
2054 
2055 <span class="comment">% --------------------------------------------------------------------</span>
2056 <a name="_sub40" href="#_subfunctions" class="code">function YScaleLinear1_Callback(hObject, eventdata, handles)</a>
2057 set(handles.Graph1,<span class="string">'YScale'</span>,<span class="string">'Linear'</span>);
2058 set(handles.YScaleLog1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2059 set(handles.YScaleLinear1,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2060 drawnow;
2061 
2062 
2063 <span class="comment">% --------------------------------------------------------------------</span>
2064 <a name="_sub41" href="#_subfunctions" class="code">function YScaleLog2_Callback(hObject, eventdata, handles)</a>
2065 set(handles.Graph2,<span class="string">'YScale'</span>,<span class="string">'Log'</span>);
2066 set(handles.YScaleLog2,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2067 set(handles.YScaleLinear2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2068 drawnow;
2069 
2070 <span class="comment">% --------------------------------------------------------------------</span>
2071 <a name="_sub42" href="#_subfunctions" class="code">function YScaleLinear2_Callback(hObject, eventdata, handles)</a>
2072 set(handles.Graph2,<span class="string">'YScale'</span>,<span class="string">'Linear'</span>);
2073 set(handles.YScaleLog2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2074 set(handles.YScaleLinear2,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2075 drawnow;
2076 
2077 <span class="comment">% --------------------------------------------------------------------</span>
2078 <a name="_sub43" href="#_subfunctions" class="code">function BPMxFamily_Callback(hObject, eventdata, handles)</a>
2079 UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
2080 <span class="keyword">if</span> UnitMenu == 1
2081     UnitsFlag = <span class="string">'Physics'</span>;
2082 <span class="keyword">else</span>
2083     UnitsFlag = <span class="string">'Hardware'</span>;
2084 <span class="keyword">end</span>
2085 
2086 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
2087     Mode = <span class="string">'Simulator'</span>;
2088 <span class="keyword">else</span>
2089     Mode = <span class="string">'Online'</span>;
2090 <span class="keyword">end</span>
2091 
2092 <span class="keyword">if</span> isempty(hObject)
2093     close(gcbf);
2094     error(<span class="string">'PLOTFAMILY:  Menu corrupted, restart application.'</span>);
2095 <span class="keyword">else</span>
2096     DataStruct = get(hObject, <span class="string">'UserData'</span>);
2097 <span class="keyword">end</span>
2098 
2099 <span class="comment">% Rebuild the data structure in case a status field was changed</span>
2100 DataStruct = family2datastruct(DataStruct.FamilyName, DataStruct.Field);
2101 
2102 <span class="keyword">if</span> isfamily(DataStruct)
2103     setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, DataStruct);
2104     
2105     s = getspos(DataStruct);
2106     setappdata(handles.figure1, <span class="string">'SPosX'</span>, s);
2107     
2108     <span class="comment">%L = getfamilydata('Circumference');</span>
2109     <span class="comment">%if isempty(L)</span>
2110     <span class="comment">%    setappdata(handles.figure1, 'AxisRange1X', [min(s) max(s)]);</span>
2111     <span class="comment">%else</span>
2112     <span class="comment">%    setappdata(handles.figure1, 'AxisRange1X', [0 L]);</span>
2113     <span class="comment">%end</span>
2114     
2115     ZeroData = DataStruct;
2116     ZeroData.Data = zeros(size(DataStruct.Data,1),1);
2117     
2118     <span class="comment">% Menu label</span>
2119     set(handles.BPMxFamily,<span class="string">'Label'</span>,sprintf(<span class="string">'Plot: %s.%s'</span>, DataStruct.FamilyName, DataStruct.Field));
2120     
2121     setappdata(handles.figure1,<span class="string">'SaveX'</span>, ZeroData);
2122     tmp = getappdata(handles.figure1,<span class="string">'SaveY'</span>);
2123     tmp.Data = 0 * tmp.Data;
2124     setappdata(handles.figure1,<span class="string">'SaveY'</span>, tmp);
2125     set(handles.SaveTime,<span class="string">'String'</span>, <span class="string">'Not saved'</span>);
2126     
2127 <span class="comment">%     % Look for the golden values</span>
2128 <span class="comment">%     try</span>
2129 <span class="comment">%         if strcmpi(DataStruct.Field,'Monitor')</span>
2130 <span class="comment">%             % Use the golden setpoint</span>
2131 <span class="comment">%             GoldenValues = getgolden(DataStruct.FamilyName, DataStruct.DeviceList, 'Setpoint', UnitsFlag, 'Struct');</span>
2132 <span class="comment">%         else</span>
2133 <span class="comment">%             GoldenValues = getgolden(DataStruct, UnitsFlag, 'Struct');</span>
2134 <span class="comment">%         end</span>
2135 <span class="comment">%         setappdata(handles.figure1, 'GoldenX', GoldenValues);</span>
2136 <span class="comment">%     catch</span>
2137 <span class="comment">%         setappdata(handles.figure1, 'GoldenX', ZeroData);</span>
2138 <span class="comment">%     end</span>
2139 <span class="comment">%</span>
2140 <span class="comment">%     % Look for the offset values</span>
2141 <span class="comment">%     try</span>
2142 <span class="comment">%         OffsetValues = getoffset(DataStruct, UnitsFlag, 'Struct');</span>
2143 <span class="comment">%         setappdata(handles.figure1, 'OffsetX', OffsetValues);</span>
2144 <span class="comment">%     catch</span>
2145 <span class="comment">%         try</span>
2146 <span class="comment">%             % If and offset does not exist than try using the setpoint</span>
2147 <span class="comment">%             setappdata(handles.figure1, 'OffsetX', getsp(DataStruct.FamilyName, DataStruct.DeviceList, Mode, UnitsFlag, 'Struct'));</span>
2148 <span class="comment">%         catch</span>
2149 <span class="comment">%             % Use zeros</span>
2150 <span class="comment">%             setappdata(handles.figure1, 'OffsetX', ZeroData);</span>
2151 <span class="comment">%         end</span>
2152 <span class="comment">%     end</span>
2153     
2154     <span class="keyword">try</span>
2155         FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2156         <span class="keyword">if</span> isempty(FileName)
2157             FileName = getappdata(handles.figure1, <span class="string">'FileNameY'</span>);
2158         <span class="keyword">end</span>
2159     <span class="keyword">end</span>
2160 
2161     <span class="keyword">try</span>
2162         FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2163         <span class="keyword">if</span> isempty(FileName)
2164             setappdata(handles.figure1,<span class="string">'FileX'</span>, ZeroData);
2165         <span class="keyword">else</span>
2166             tmp = getdata(DataStruct.FamilyName, DataStruct.DeviceList, FileName, <span class="string">'Struct'</span>);
2167             <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(tmp.Units,<span class="string">'Hardware'</span>)
2168                 <span class="comment">% Physics units requested, data is in Hardware units</span>
2169                 tmp = hw2physics(tmp);
2170             <span class="keyword">else</span>
2171                 <span class="comment">% Hardware units requested, data is in Physics units</span>
2172                 tmp = physics2hw(tmp);
2173             <span class="keyword">end</span>
2174             setappdata(handles.figure1,<span class="string">'FileX'</span>, tmp);
2175             setappdata(handles.figure1,<span class="string">'FileNameX'</span>, FileName);
2176         <span class="keyword">end</span>
2177     <span class="keyword">catch</span>
2178         setappdata(handles.figure1,<span class="string">'FileX'</span>, ZeroData);
2179         setappdata(handles.figure1,<span class="string">'FileNameX'</span>,<span class="string">''</span>);
2180     <span class="keyword">end</span>
2181     
2182     set(handles.DataList1,<span class="string">'Value'</span>, 1);
2183     set(handles.DataList1,<span class="string">'ListBoxTop'</span>, 1);
2184     <a href="#_sub22" class="code" title="subfunction UpdateFileDisplayLocal(handles)">UpdateFileDisplayLocal</a>(handles);
2185     <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);        
2186     
2187     <span class="comment">% Auto scale y-axis</span>
2188     <span class="comment">% AutoScaleYLocal(handles);</span>
2189     a = axis(handles.Graph1);
2190     axis(handles.Graph1, <span class="string">'auto'</span>);
2191     set(handles.Graph1, <span class="string">'XLim'</span>, a(1:2));
2192 
2193 
2194 <span class="keyword">else</span>
2195     fprintf(<span class="string">'   %s is not a known family\n'</span>, DataStruct.FamilyName);
2196 <span class="keyword">end</span>
2197 
2198 
2199 <span class="comment">% --------------------------------------------------------------------</span>
2200 <a name="_sub44" href="#_subfunctions" class="code">function BPMyFamily_Callback(hObject, eventdata, handles)</a>
2201 UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
2202 <span class="keyword">if</span> UnitMenu == 1
2203     UnitsFlag = <span class="string">'Physics'</span>;
2204 <span class="keyword">else</span>
2205     UnitsFlag = <span class="string">'Hardware'</span>;
2206 <span class="keyword">end</span>
2207 
2208 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
2209     Mode = <span class="string">'Simulator'</span>;
2210 <span class="keyword">else</span>
2211     Mode = <span class="string">'Online'</span>;
2212 <span class="keyword">end</span>
2213 
2214 <span class="keyword">if</span> isempty(hObject)
2215     close(gcbf);
2216     error(<span class="string">'PLOTFAMILY:  Menu corrupted, restart application.'</span>);
2217 <span class="keyword">else</span>
2218     DataStruct = get(hObject, <span class="string">'UserData'</span>);
2219 <span class="keyword">end</span>
2220 
2221 <span class="comment">% Rebuild the data structure in case a status field was changed</span>
2222 DataStruct = family2datastruct(DataStruct.FamilyName, DataStruct.Field);
2223 
2224 <span class="keyword">if</span> isfamily(DataStruct)
2225     setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, DataStruct);
2226     
2227     s = getspos(DataStruct);
2228     setappdata(handles.figure1, <span class="string">'SPosY'</span>, s);
2229     <span class="comment">%L = getfamilydata('Circumference');</span>
2230     <span class="comment">%if isempty(L)</span>
2231     <span class="comment">%    setappdata(handles.figure1, 'AxisRange2X', [min(s) max(s)]);</span>
2232     <span class="comment">%else</span>
2233     <span class="comment">%    setappdata(handles.figure1, 'AxisRange2X', [0 L]);</span>
2234     <span class="comment">%end</span>
2235     
2236     ZeroData = DataStruct;
2237     ZeroData.Data = zeros(size(DataStruct.Data,1),1);
2238     
2239     <span class="comment">% Menu label</span>
2240     set(handles.BPMyFamily,<span class="string">'Label'</span>,sprintf(<span class="string">'Plot: %s.%s'</span>, DataStruct.FamilyName, DataStruct.Field));
2241     
2242     setappdata(handles.figure1,<span class="string">'SaveY'</span>, ZeroData);
2243     tmp = getappdata(handles.figure1,<span class="string">'SaveX'</span>);
2244     tmp.Data = 0 * tmp.Data;
2245     setappdata(handles.figure1,<span class="string">'SaveX'</span>, tmp);
2246     set(handles.SaveTime,<span class="string">'String'</span>, <span class="string">''</span>);
2247     
2248 <span class="comment">%     % Look for the golden values</span>
2249 <span class="comment">%     try</span>
2250 <span class="comment">%         if strcmpi(DataStruct.Field,'Monitor')</span>
2251 <span class="comment">%             % Use the golden setpoint</span>
2252 <span class="comment">%             GoldenValues = getgolden(DataStruct.FamilyName, DataStruct.DeviceList, 'Setpoint', UnitsFlag, 'Struct');</span>
2253 <span class="comment">%         else</span>
2254 <span class="comment">%             GoldenValues = getgolden(DataStruct, UnitsFlag, 'Struct');</span>
2255 <span class="comment">%         end</span>
2256 <span class="comment">%         setappdata(handles.figure1,'GoldenY', GoldenValues);</span>
2257 <span class="comment">%     catch</span>
2258 <span class="comment">%         setappdata(handles.figure1, 'GoldenY', ZeroData);</span>
2259 <span class="comment">%     end</span>
2260 <span class="comment">%</span>
2261 <span class="comment">%     % Look for the offset values</span>
2262 <span class="comment">%     try</span>
2263 <span class="comment">%         OffsetValues = getoffset(DataStruct, UnitsFlag, 'Struct');</span>
2264 <span class="comment">%         setappdata(handles.figure1,'OffsetY', OffsetValues);</span>
2265 <span class="comment">%     catch</span>
2266 <span class="comment">%         try</span>
2267 <span class="comment">%             % If and offset does not exist than try using the setpoint</span>
2268 <span class="comment">%             setappdata(handles.figure1, 'OffsetY', getsp(DataStruct.FamilyName, DataStruct.DeviceList, Mode, UnitsFlag, 'Struct'));</span>
2269 <span class="comment">%         catch</span>
2270 <span class="comment">%             % Use zeros</span>
2271 <span class="comment">%             setappdata(handles.figure1, 'OffsetY', ZeroData);</span>
2272 <span class="comment">%         end</span>
2273 <span class="comment">%     end</span>
2274     
2275     <span class="comment">% Look for file data</span>
2276     <span class="keyword">try</span>
2277         FileName = getappdata(handles.figure1, <span class="string">'FileNameY'</span>);
2278         <span class="keyword">if</span> isempty(FileName)
2279             FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2280         <span class="keyword">end</span>
2281         <span class="keyword">end</span>
2282 
2283     <span class="comment">% Look for file data</span>
2284     <span class="keyword">try</span>
2285         FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2286         <span class="keyword">if</span> isempty(FileName)
2287             setappdata(handles.figure1, <span class="string">'FileY'</span>, ZeroData);
2288         <span class="keyword">else</span>
2289             tmp = getdata(DataStruct.FamilyName, DataStruct.DeviceList, FileName, <span class="string">'Struct'</span>);
2290             <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(tmp.Units,<span class="string">'Hardware'</span>)
2291                 <span class="comment">% Physics units requested, data is in Hardware units</span>
2292                 tmp = hw2physics(tmp);
2293             <span class="keyword">else</span>
2294                 <span class="comment">% Hardware units requested, data is in Physics units</span>
2295                 tmp = physics2hw(tmp);
2296             <span class="keyword">end</span>
2297             setappdata(handles.figure1, <span class="string">'FileY'</span>, tmp);
2298             setappdata(handles.figure1, <span class="string">'FileNameY'</span>, FileName);
2299         <span class="keyword">end</span>
2300     <span class="keyword">catch</span>
2301         setappdata(handles.figure1, <span class="string">'FileY'</span>, ZeroData);
2302         setappdata(handles.figure1, <span class="string">'FileNameY'</span>,<span class="string">''</span>);
2303     <span class="keyword">end</span>
2304     
2305     set(handles.DataList2, <span class="string">'Value'</span>, 1);
2306     set(handles.DataList2, <span class="string">'ListBoxTop'</span>, 1);
2307     <a href="#_sub22" class="code" title="subfunction UpdateFileDisplayLocal(handles)">UpdateFileDisplayLocal</a>(handles);    
2308     <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2309 
2310     <span class="comment">% Auto scale y-axis</span>
2311     <span class="comment">% AutoScaleYLocal(handles);</span>
2312     a = axis(handles.Graph2);
2313     axis(handles.Graph2, <span class="string">'auto'</span>);
2314     set(handles.Graph2, <span class="string">'XLim'</span>, a(1:2));
2315 <span class="keyword">else</span>
2316     fprintf(<span class="string">'   %s is not a known family\n'</span>, DataStruct.FamilyName);
2317 <span class="keyword">end</span>
2318 
2319 
2320 <span class="comment">% --------------------------------------------------------------------</span>
2321 <a name="_sub45" href="#_subfunctions" class="code">function BPMxList_Callback(hObject, eventdata, handles)</a>
2322 UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
2323 <span class="keyword">if</span> UnitMenu == 1
2324     UnitsFlag = <span class="string">'Physics'</span>;
2325 <span class="keyword">else</span>
2326     UnitsFlag = <span class="string">'Hardware'</span>;
2327 <span class="keyword">end</span>
2328 
2329 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
2330     Mode = <span class="string">'Simulator'</span>;
2331 <span class="keyword">else</span>
2332     Mode = <span class="string">'Online'</span>;
2333 <span class="keyword">end</span>
2334 
2335 DataStruct = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
2336 Family = DataStruct.FamilyName;
2337 List = DataStruct.DeviceList;
2338 FullList = family2dev(Family);    <span class="comment">% Include bad status</span>
2339 CheckList = zeros(size(FullList,1),1);
2340 i = findrowindex(List, FullList); <span class="comment">% Find all selected Devices</span>
2341 CheckList(i) = 1;
2342 List = editlist(FullList, Family, CheckList);
2343 
2344 DataStruct.Data = NaN * ones(size(List,1),1);  <span class="comment">%DataStruct.Data(i);</span>
2345 DataStruct.DeviceList = List;
2346 DataStruct.Status = ones(size(List,1),1);
2347 setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, DataStruct);
2348 
2349 s = getspos(DataStruct);
2350 setappdata(handles.figure1, <span class="string">'SPosX'</span>, s);
2351 
2352 ZeroData = DataStruct;
2353 ZeroData.Data = zeros(size(DataStruct.Data,1),1);
2354 
2355 <span class="comment">% % Look for the golden values</span>
2356 <span class="comment">% try</span>
2357 <span class="comment">%     if strcmpi(DataStruct.Field,'Monitor')</span>
2358 <span class="comment">%         % Use the golden setpoint</span>
2359 <span class="comment">%         GoldenValues = getgolden(DataStruct.FamilyName, DataStruct.DeviceList, 'Setpoint', UnitsFlag, 'Struct');</span>
2360 <span class="comment">%     else</span>
2361 <span class="comment">%         GoldenValues = getgolden(DataStruct, UnitsFlag, 'Struct');</span>
2362 <span class="comment">%     end</span>
2363 <span class="comment">%     setappdata(handles.figure1, 'GoldenX', GoldenValues);</span>
2364 <span class="comment">% catch</span>
2365 <span class="comment">%     setappdata(handles.figure1, 'GoldenX', ZeroData);</span>
2366 <span class="comment">% end</span>
2367 <span class="comment">%</span>
2368 <span class="comment">% % Look for the offset values</span>
2369 <span class="comment">% try</span>
2370 <span class="comment">%     OffsetValues = getoffset(DataStruct, UnitsFlag, 'Struct');</span>
2371 <span class="comment">%     setappdata(handles.figure1,'OffsetX', OffsetValues);</span>
2372 <span class="comment">% catch</span>
2373 <span class="comment">%     try</span>
2374 <span class="comment">%         % If and offset does not exist than try using the setpoint</span>
2375 <span class="comment">%         setappdata(handles.figure1, 'OffsetX', getsp(DataStruct.FamilyName, DataStruct.DeviceList, Mode, UnitsFlag, 'Struct'));</span>
2376 <span class="comment">%     catch</span>
2377 <span class="comment">%         % Use zeros</span>
2378 <span class="comment">%         setappdata(handles.figure1, 'OffsetX', ZeroData);</span>
2379 <span class="comment">%     end</span>
2380 <span class="comment">% end</span>
2381 
2382 
2383 <span class="comment">% Changing the list wipes out a save</span>
2384 setappdata(handles.figure1,<span class="string">'SaveX'</span>, ZeroData);
2385 tmp = getappdata(handles.figure1,<span class="string">'SaveY'</span>);
2386 tmp.Data = 0 * tmp.Data;
2387 setappdata(handles.figure1,<span class="string">'SaveY'</span>, tmp);
2388 set(handles.SaveTime,<span class="string">'String'</span>, <span class="string">'Data not saved'</span>);
2389 
2390 <span class="keyword">try</span>
2391     FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2392     <span class="keyword">if</span> isempty(FileName)
2393         FileName = getappdata(handles.figure1, <span class="string">'FileNameY'</span>);
2394     <span class="keyword">end</span>
2395     <span class="keyword">if</span> isempty(FileName)
2396         setappdata(handles.figure1,<span class="string">'FileX'</span>, ZeroData);
2397     <span class="keyword">else</span>
2398         tmp = getdata(DataStruct.FamilyName, DataStruct.DeviceList, FileName, <span class="string">'Struct'</span>);
2399         <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(tmp.Units,<span class="string">'Hardware'</span>)
2400             <span class="comment">% Physics units requested, data is in Hardware units</span>
2401             tmp = hw2physics(tmp);
2402         <span class="keyword">else</span>
2403             <span class="comment">% Hardware units requested, data is in Physics units</span>
2404             tmp = physics2hw(tmp);
2405         <span class="keyword">end</span>
2406         setappdata(handles.figure1,<span class="string">'FileX'</span>, tmp);
2407         setappdata(handles.figure1,<span class="string">'FileNameX'</span>, FileName);
2408     <span class="keyword">end</span>
2409 <span class="keyword">catch</span>
2410     setappdata(handles.figure1,<span class="string">'FileX'</span>, ZeroData);
2411     setappdata(handles.figure1,<span class="string">'FileNameX'</span>,<span class="string">''</span>);
2412 <span class="keyword">end</span>
2413 
2414 set(handles.DataList1,<span class="string">'Value'</span>, 1);
2415 set(handles.DataList1,<span class="string">'ListBoxTop'</span>, 1);
2416 <a href="#_sub22" class="code" title="subfunction UpdateFileDisplayLocal(handles)">UpdateFileDisplayLocal</a>(handles);
2417 cla(handles.Graph1);
2418 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2419 
2420 <span class="comment">% --------------------------------------------------------------------</span>
2421 <a name="_sub46" href="#_subfunctions" class="code">function BPMyList_Callback(hObject, eventdata, handles)</a>
2422 UnitMenu = getappdata(handles.figure1,<span class="string">'UnitsFlag'</span>);
2423 <span class="keyword">if</span> UnitMenu == 1
2424     UnitsFlag = <span class="string">'Physics'</span>;
2425 <span class="keyword">else</span>
2426     UnitsFlag = <span class="string">'Hardware'</span>;
2427 <span class="keyword">end</span>
2428 
2429 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
2430     Mode = <span class="string">'Simulator'</span>;
2431 <span class="keyword">else</span>
2432     Mode = <span class="string">'Online'</span>;
2433 <span class="keyword">end</span>
2434 
2435 <span class="comment">%% Build List display</span>
2436 DataStruct = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
2437 Family = DataStruct.FamilyName;
2438 List = DataStruct.DeviceList;
2439 FullList = family2dev(Family);    <span class="comment">% Include bad status</span>
2440 CheckList = zeros(size(FullList,1),1);
2441 i = findrowindex(List, FullList); <span class="comment">% Find all selected Devices</span>
2442 CheckList(i) = 1;
2443 List = editlist(FullList, Family, CheckList);
2444 
2445 DataStruct.Data = NaN * ones(size(List,1),1);  <span class="comment">%DataStruct.Data(i);</span>
2446 DataStruct.Data = DataStruct.Data(i);
2447 DataStruct.DeviceList = List;
2448 setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, DataStruct);
2449 
2450 s = getspos(DataStruct);
2451 setappdata(handles.figure1, <span class="string">'SPosY'</span>, s);
2452 
2453 ZeroData = DataStruct;
2454 ZeroData.Data = zeros(size(DataStruct.Data,1),1);
2455 
2456 
2457 <span class="comment">% % Look for the golden values</span>
2458 <span class="comment">% try</span>
2459 <span class="comment">%     if strcmpi(DataStruct.Field,'Monitor')</span>
2460 <span class="comment">%         % Use the golden setpoint</span>
2461 <span class="comment">%         GoldenValues = getgolden(DataStruct.FamilyName, DataStruct.DeviceList, 'Setpoint', UnitsFlag, 'Struct');</span>
2462 <span class="comment">%     else</span>
2463 <span class="comment">%         GoldenValues = getgolden(DataStruct, UnitsFlag, 'Struct');</span>
2464 <span class="comment">%     end</span>
2465 <span class="comment">%     setappdata(handles.figure1, 'GoldenY', GoldenValues);</span>
2466 <span class="comment">% catch</span>
2467 <span class="comment">%     setappdata(handles.figure1, 'GoldenY', ZeroData);</span>
2468 <span class="comment">% end</span>
2469 <span class="comment">%</span>
2470 <span class="comment">%</span>
2471 <span class="comment">% % Look for the offset values</span>
2472 <span class="comment">% try</span>
2473 <span class="comment">%     OffsetValues = getoffset(DataStruct, UnitsFlag, 'Struct');</span>
2474 <span class="comment">%     setappdata(handles.figure1,'OffsetY', OffsetValues);</span>
2475 <span class="comment">% catch</span>
2476 <span class="comment">%     try</span>
2477 <span class="comment">%         % If and offset does not exist than try using the setpoint</span>
2478 <span class="comment">%         setappdata(handles.figure1, 'OffsetY', getsp(DataStruct.FamilyName, DataStruct.DeviceList, Mode, UnitsFlag, 'Struct'));</span>
2479 <span class="comment">%     catch</span>
2480 <span class="comment">%         % Use zeros</span>
2481 <span class="comment">%         setappdata(handles.figure1, 'OffsetY', ZeroData);</span>
2482 <span class="comment">%     end</span>
2483 <span class="comment">% end</span>
2484 
2485 
2486 <span class="comment">% Changing the list wipes out a save</span>
2487 setappdata(handles.figure1,<span class="string">'SaveY'</span>, ZeroData);
2488 tmp = getappdata(handles.figure1,<span class="string">'SaveX'</span>);
2489 tmp.Data = 0 * tmp.Data;
2490 setappdata(handles.figure1,<span class="string">'SaveX'</span>, tmp);
2491 set(handles.SaveTime, <span class="string">'String'</span>, <span class="string">'Data not saved'</span>);
2492 
2493 <span class="keyword">try</span>
2494     FileName = getappdata(handles.figure1, <span class="string">'FileNameY'</span>);
2495     <span class="keyword">if</span> isempty(FileName)
2496         FileName = getappdata(handles.figure1, <span class="string">'FileNameX'</span>);
2497     <span class="keyword">end</span>
2498     <span class="keyword">if</span> isempty(FileName)
2499         setappdata(handles.figure1,<span class="string">'FileY'</span>, ZeroData);
2500     <span class="keyword">else</span>
2501             tmp = getdata(DataStruct.FamilyName, DataStruct.DeviceList, FileName, <span class="string">'Struct'</span>);
2502         <span class="keyword">if</span> UnitMenu == 1 &amp;&amp; strcmpi(tmp.Units,<span class="string">'Hardware'</span>)
2503             <span class="comment">% Physics units requested, data is in Hardware units</span>
2504             tmp = hw2physics(tmp);
2505         <span class="keyword">else</span>
2506             <span class="comment">% Hardware units requested, data is in Physics units</span>
2507             tmp = physics2hw(tmp);
2508         <span class="keyword">end</span>
2509         setappdata(handles.figure1,<span class="string">'FileY'</span>, tmp);
2510         setappdata(handles.figure1,<span class="string">'FileNameY'</span>, FileName);
2511     <span class="keyword">end</span>
2512 <span class="keyword">catch</span>
2513     setappdata(handles.figure1,<span class="string">'FileY'</span>, ZeroData);
2514     setappdata(handles.figure1,<span class="string">'FileNameY'</span>,<span class="string">''</span>);
2515 <span class="keyword">end</span>
2516 
2517 set(handles.DataList2,<span class="string">'Value'</span>, 1);
2518 set(handles.DataList2,<span class="string">'ListBoxTop'</span>, 1);
2519 <a href="#_sub22" class="code" title="subfunction UpdateFileDisplayLocal(handles)">UpdateFileDisplayLocal</a>(handles);
2520 cla(handles.Graph2);
2521 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2522 
2523 
2524 <span class="comment">% --------------------------------------------------------------------</span>
2525 <a name="_sub47" href="#_subfunctions" class="code">function UpdatePeriod_Callback(hObject, eventdata, handles)</a>
2526 answer = inputdlg(<span class="string">'Enter new update period [seconds]'</span>,<span class="string">''</span>,1,{num2str(getappdata(handles.figure1, <span class="string">'UpdatePeriod'</span>))});
2527 <span class="keyword">if</span> ~isempty(answer)
2528     UpdatePeriod = str2num(answer{1});
2529     <span class="keyword">if</span> ~isempty(UpdatePeriod) &amp;&amp; UpdatePeriod &gt;= 0
2530         <span class="keyword">if</span> UpdatePeriod &gt; 10
2531             UpdatePeriod = 10;
2532         <span class="keyword">end</span>
2533         set(handles.UpdatePeriod,<span class="string">'Label'</span>, sprintf(<span class="string">'Update Period = %.2f sec'</span>,UpdatePeriod));
2534         setappdata(handles.figure1, <span class="string">'UpdatePeriod'</span>, UpdatePeriod);
2535     <span class="keyword">end</span>
2536 <span class="keyword">end</span>
2537 
2538 <span class="comment">% --------------------------------------------------------------------</span>
2539 <a name="_sub48" href="#_subfunctions" class="code">function PhysicsUnits_Callback(hObject, eventdata, handles)</a>
2540 UnitMenu = 1;
2541 setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, UnitMenu);
2542 set(handles.PhysicsUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2543 set(handles.HardwareUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2544 set(handles.MicronFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2545 
2546 RawX = getappdata(handles.figure1, <span class="string">'RawX'</span>);
2547 RawY = getappdata(handles.figure1, <span class="string">'RawY'</span>);
2548 
2549 <span class="keyword">if</span> strcmpi(RawX.Units,<span class="string">'Hardware'</span>)
2550     <span class="comment">% Physics units requested, data is in Hardware units</span>
2551     setappdata(handles.figure1, <span class="string">'RawX'</span>, hw2physics(RawX));
2552     setappdata(handles.figure1, <span class="string">'RawY'</span>, hw2physics(RawY));
2553 
2554 <span class="comment">%     setappdata(handles.figure1, 'OffsetX', hw2physics(getappdata(handles.figure1,'OffsetX')));</span>
2555 <span class="comment">%     setappdata(handles.figure1, 'OffsetY', hw2physics(getappdata(handles.figure1,'OffsetY')));</span>
2556 <span class="comment">%</span>
2557 <span class="comment">%     setappdata(handles.figure1, 'GoldenX', hw2physics(getappdata(handles.figure1,'GoldenX')));</span>
2558 <span class="comment">%     setappdata(handles.figure1, 'GoldenY', hw2physics(getappdata(handles.figure1,'GoldenY')));</span>
2559     
2560     setappdata(handles.figure1, <span class="string">'SaveX'</span>, hw2physics(getappdata(handles.figure1,<span class="string">'SaveX'</span>)));
2561     setappdata(handles.figure1, <span class="string">'SaveY'</span>, hw2physics(getappdata(handles.figure1,<span class="string">'SaveY'</span>)));
2562 
2563     setappdata(handles.figure1, <span class="string">'FileX'</span>, hw2physics(getappdata(handles.figure1,<span class="string">'FileX'</span>)));
2564     setappdata(handles.figure1, <span class="string">'FileY'</span>, hw2physics(getappdata(handles.figure1,<span class="string">'FileY'</span>)));
2565 <span class="keyword">end</span>
2566 
2567 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
2568 <span class="keyword">if</span> strcmpi(DataStruct1.Units,<span class="string">'Hardware'</span>)
2569     <span class="comment">% Physics units requested, data is in Hardware units</span>
2570     setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, hw2physics(DataStruct1));
2571 <span class="keyword">end</span>
2572 
2573 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
2574 <span class="keyword">if</span> strcmpi(DataStruct2.Units,<span class="string">'Hardware'</span>)
2575     <span class="comment">% Physics units requested, data is in Hardware units</span>
2576     setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, hw2physics(DataStruct2));
2577 <span class="keyword">end</span>
2578 
2579 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2580 <a href="#_sub67" class="code" title="subfunction AutoScaleYLocal(handles)">AutoScaleYLocal</a>(handles);
2581 
2582 <span class="comment">% Turn off the setpoint GUI (or change it to physics units)</span>
2583 set(handles.SetpointEditBox,   <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2584 set(handles.SetpointFamily,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2585 set(handles.SetpointUnits,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2586 set(handles.SetpointSlider,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2587 set(handles.SetpointMax,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2588 set(handles.SetpointMin,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2589 set(handles.SetpointFrame,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2590 set(handles.SetpointStepSize,  <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2591 set(handles.SetpointPushButton,<span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2592 
2593 <span class="comment">% Change the save and file text to make room for the slider</span>
2594 p = get(handles.SaveTime, <span class="string">'Position'</span>);
2595 set(handles.SaveTime, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
2596 p = get(handles.FileName, <span class="string">'Position'</span>);
2597 set(handles.FileName, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
2598 p = get(handles.FileNameY, <span class="string">'Position'</span>);
2599 set(handles.FileNameY, <span class="string">'Position'</span>, [p(1) p(2) 45 p(4)]);
2600 
2601 drawnow;
2602 
2603 <span class="comment">% --------------------------------------------------------------------</span>
2604 <a name="_sub49" href="#_subfunctions" class="code">function HardwareUnits_Callback(hObject, eventdata, handles)</a>
2605 UnitMenu = 2;
2606 setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, UnitMenu);
2607 set(handles.PhysicsUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2608 set(handles.HardwareUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2609 set(handles.MicronFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2610 
2611 RawX = getappdata(handles.figure1, <span class="string">'RawX'</span>);
2612 RawY = getappdata(handles.figure1, <span class="string">'RawY'</span>);
2613 
2614 <span class="keyword">if</span> strcmpi(RawX.Units,<span class="string">'Physics'</span>)
2615     <span class="comment">% Hardware units requested, data is in Physics units</span>
2616     setappdata(handles.figure1, <span class="string">'RawX'</span>, physics2hw(RawX));
2617     setappdata(handles.figure1, <span class="string">'RawY'</span>, physics2hw(RawY));
2618 
2619 <span class="comment">%     setappdata(handles.figure1, 'OffsetX', physics2hw(getappdata(handles.figure1,'OffsetX')));</span>
2620 <span class="comment">%     setappdata(handles.figure1, 'OffsetY', physics2hw(getappdata(handles.figure1,'OffsetY')));</span>
2621 <span class="comment">%</span>
2622 <span class="comment">%     setappdata(handles.figure1, 'GoldenX', physics2hw(getappdata(handles.figure1,'GoldenX')));</span>
2623 <span class="comment">%     setappdata(handles.figure1, 'GoldenY', physics2hw(getappdata(handles.figure1,'GoldenY')));</span>
2624     
2625     setappdata(handles.figure1, <span class="string">'SaveX'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'SaveX'</span>)));
2626     setappdata(handles.figure1, <span class="string">'SaveY'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'SaveY'</span>)));
2627 
2628     setappdata(handles.figure1, <span class="string">'FileX'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'FileX'</span>)));
2629     setappdata(handles.figure1, <span class="string">'FileY'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'FileY'</span>)));
2630 <span class="keyword">end</span>
2631 
2632 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
2633 <span class="keyword">if</span> strcmpi(DataStruct1.Units,<span class="string">'Physics'</span>)
2634     <span class="comment">% Hardware units requested, data is in Physics units</span>
2635     setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, physics2hw(DataStruct1));
2636 <span class="keyword">end</span>
2637 
2638 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
2639 <span class="keyword">if</span> strcmpi(DataStruct2.Units,<span class="string">'Physics'</span>)
2640     <span class="comment">% Hardware units requested, data is in Physics units</span>
2641     setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, physics2hw(DataStruct2));
2642 <span class="keyword">end</span>
2643 
2644 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2645 <a href="#_sub67" class="code" title="subfunction AutoScaleYLocal(handles)">AutoScaleYLocal</a>(handles);
2646 
2647 <span class="comment">% Turn off the setpoint GUI (or change it to physics units)</span>
2648 set(handles.SetpointEditBox,   <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2649 set(handles.SetpointFamily,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2650 set(handles.SetpointUnits,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2651 set(handles.SetpointSlider,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2652 set(handles.SetpointMax,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2653 set(handles.SetpointMin,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2654 set(handles.SetpointFrame,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2655 set(handles.SetpointStepSize,  <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2656 set(handles.SetpointPushButton,<span class="string">'Visible'</span>, <span class="string">'Off'</span>);
2657 
2658 <span class="comment">% Change the save and file text to make room for the slider</span>
2659 p = get(handles.SaveTime, <span class="string">'Position'</span>);
2660 set(handles.SaveTime, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
2661 p = get(handles.FileName, <span class="string">'Position'</span>);
2662 set(handles.FileName, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
2663 p = get(handles.FileNameY, <span class="string">'Position'</span>);
2664 set(handles.FileNameY, <span class="string">'Position'</span>, [p(1) p(2) 45 p(4)]);
2665 
2666 drawnow;
2667 
2668 <span class="comment">% --------------------------------------------------------------------</span>
2669 <a name="_sub50" href="#_subfunctions" class="code">function MicronFlag_Callback(hObject, eventdata, handles)</a>
2670 UnitMenu = 3;
2671 setappdata(handles.figure1,<span class="string">'UnitsFlag'</span>, UnitMenu);
2672 set(handles.PhysicsUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2673 set(handles.HardwareUnitsFlag,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2674 set(handles.MicronFlag,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2675 
2676 RawX = getappdata(handles.figure1, <span class="string">'RawX'</span>);
2677 RawY = getappdata(handles.figure1, <span class="string">'RawY'</span>);
2678 
2679 <span class="keyword">if</span> strcmpi(RawX.Units,<span class="string">'Physics'</span>)
2680     <span class="comment">% Hardware units requested, data is in Physics units</span>
2681     setappdata(handles.figure1, <span class="string">'RawX'</span>, physics2hw(RawX));
2682     setappdata(handles.figure1, <span class="string">'RawY'</span>, physics2hw(RawY));
2683 
2684 <span class="comment">%     setappdata(handles.figure1, 'OffsetX', physics2hw(getappdata(handles.figure1,'OffsetX')));</span>
2685 <span class="comment">%     setappdata(handles.figure1, 'OffsetY', physics2hw(getappdata(handles.figure1,'OffsetY')));</span>
2686 <span class="comment">%</span>
2687 <span class="comment">%     setappdata(handles.figure1, 'GoldenX', physics2hw(getappdata(handles.figure1,'GoldenX')));</span>
2688 <span class="comment">%     setappdata(handles.figure1, 'GoldenY', physics2hw(getappdata(handles.figure1,'GoldenY')));</span>
2689     
2690     setappdata(handles.figure1, <span class="string">'SaveX'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'SaveX'</span>)));
2691     setappdata(handles.figure1, <span class="string">'SaveY'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'SaveY'</span>)));
2692 
2693     setappdata(handles.figure1, <span class="string">'FileX'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'FileX'</span>)));
2694     setappdata(handles.figure1, <span class="string">'FileY'</span>, physics2hw(getappdata(handles.figure1,<span class="string">'FileY'</span>)));
2695 <span class="keyword">end</span>
2696 
2697 DataStruct1 = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
2698 <span class="keyword">if</span> strcmpi(DataStruct1.Units,<span class="string">'Physics'</span>)
2699     <span class="comment">% Hardware units requested, data is in Physics units</span>
2700     setappdata(handles.figure1, <span class="string">'BPMxFamily'</span>, physics2hw(DataStruct1));
2701 <span class="keyword">end</span>
2702 
2703 DataStruct2 = getappdata(handles.figure1, <span class="string">'BPMyFamily'</span>);
2704 <span class="keyword">if</span> strcmpi(DataStruct2.Units,<span class="string">'Physics'</span>)
2705     <span class="comment">% Hardware units requested, data is in Physics units</span>
2706     setappdata(handles.figure1, <span class="string">'BPMyFamily'</span>, physics2hw(DataStruct2));
2707 <span class="keyword">end</span>
2708 
2709 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2710 <a href="#_sub67" class="code" title="subfunction AutoScaleYLocal(handles)">AutoScaleYLocal</a>(handles);
2711 drawnow;
2712 
2713 
2714 <span class="comment">% --------------------------------------------------------------------</span>
2715 <a name="_sub51" href="#_subfunctions" class="code">function SaveOrbitToFile_Callback(hObject, eventdata, handles)</a>
2716 
2717 Data1 = getappdata(handles.figure1, <span class="string">'RawX'</span>);
2718 Data2 = getappdata(handles.figure1, <span class="string">'RawY'</span>);
2719 
2720 <span class="keyword">if</span> isfield(Data1,<span class="string">'TimeStamp'</span>)
2721     DirStart = pwd;
2722     
2723     FamilyName1 = Data1.FamilyName;
2724     FamilyName2 = Data2.FamilyName;
2725     <span class="keyword">if</span> strcmpi(FamilyName1, FamilyName2)
2726         FileName = appendtimestamp(FamilyName1, Data1.TimeStamp);
2727     <span class="keyword">else</span>
2728         FileName = appendtimestamp([FamilyName1,<span class="string">'_'</span>,FamilyName2], Data1.TimeStamp);
2729     <span class="keyword">end</span>
2730     <span class="comment">%     DirectoryName = getfamilydata('Directory','DataRoot');</span>
2731     DirectoryName = getfamilydata(<span class="string">'Directory'</span>,<span class="string">'BPMData'</span>);
2732     
2733     [FileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Select File (Cancel to not save to a file)'</span>, [DirectoryName FileName, <span class="string">'.mat'</span>]);
2734     <span class="keyword">if</span> FileName == 0 
2735         disp(<span class="string">'   No data saved'</span>);
2736         <span class="keyword">return</span>
2737     <span class="keyword">end</span>
2738     
2739     [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
2740     save(FileName, <span class="string">'Data1'</span>, <span class="string">'Data2'</span>);
2741     cd(DirStart);
2742     fprintf(<span class="string">'   Data saved to %s\n'</span>, [DirectoryName FileName]);
2743 <span class="keyword">else</span>
2744     fprintf(<span class="string">'   No data to save \n'</span>);
2745 <span class="keyword">end</span>
2746 
2747 
2748 <span class="comment">% --------------------------------------------------------------------</span>
2749 <a name="_sub52" href="#_subfunctions" class="code">function Online_Callback(hObject, eventdata, handles)</a>
2750 set(handles.Online,  <span class="string">'Checked'</span>,<span class="string">'On'</span>);
2751 set(handles.Simulate,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2752 
2753 MachineName     = getfamilydata(<span class="string">'Machine'</span>);
2754 SubMachineName  = getfamilydata(<span class="string">'SubMachine'</span>);
2755 OperationalMode = getfamilydata(<span class="string">'OperationalMode'</span>);
2756 set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Plot Family:  %s  -  %s  -  %s  (%s)'</span>, MachineName, SubMachineName, OperationalMode, <span class="string">'Online'</span>));
2757 <span class="comment">%set(handles.figure1,'Name',sprintf('%s, Plot Family Data (Online)', getfamilydata('Machine')));</span>
2758 
2759 <span class="comment">%switch2online;</span>
2760 <span class="keyword">if</span> get(handles.OnOff,<span class="string">'Value'</span>) == 0
2761 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2762 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2763 <span class="keyword">end</span>
2764 
2765 <span class="comment">% --------------------------------------------------------------------</span>
2766 <a name="_sub53" href="#_subfunctions" class="code">function Simulate_Callback(hObject, eventdata, handles)</a>
2767 set(handles.Online,  <span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2768 set(handles.Simulate,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2769 
2770 MachineName     = getfamilydata(<span class="string">'Machine'</span>);
2771 SubMachineName  = getfamilydata(<span class="string">'SubMachine'</span>);
2772 OperationalMode = getfamilydata(<span class="string">'OperationalMode'</span>);
2773 set(handles.figure1,<span class="string">'Name'</span>,sprintf(<span class="string">'Plot Family:  %s  -  %s  -  %s  (%s)'</span>, MachineName, SubMachineName, OperationalMode, <span class="string">'Model'</span>));
2774 <span class="comment">%set(handles.figure1,'Name',sprintf('%s, Plot Family Data (Model)', getfamilydata('Machine')));</span>
2775 
2776 <span class="comment">%switch2sim;</span>
2777 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2778 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2779 
2780 <span class="comment">% --------------------------------------------------------------------</span>
2781 <a name="_sub54" href="#_subfunctions" class="code">function Sim2Machine_Callback(hObject, eventdata, handles)</a>
2782 sim2machine;
2783 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2784 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2785 
2786 <span class="comment">% --------------------------------------------------------------------</span>
2787 <a name="_sub55" href="#_subfunctions" class="code">function Machine2Sim_Callback(hObject, eventdata, handles)</a>
2788 machine2sim;
2789 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
2790 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2791 
2792 <span class="comment">% --------------------------------------------------------------------</span>
2793 <a name="_sub56" href="#_subfunctions" class="code">function AddPlot_Nothing_Callback(hObject, eventdata, handles)</a>
2794 
2795 hp = get(hObject, <span class="string">'Parent'</span>);
2796 hp = get(hp, <span class="string">'Parent'</span>);
2797 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
2798     plot(handles.Graph3, NaN, NaN)
2799     set(handles.Graph3,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
2800     set(handles.Graph3,<span class="string">'color'</span>,<span class="string">'none'</span>);
2801     set(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2802     set(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2803     set(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2804     set(handles.AddPlot1_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2805     set(handles.AddPlot1_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2806 <span class="keyword">else</span>
2807     plot(handles.Graph4, NaN, NaN)
2808     set(handles.Graph4,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
2809     set(handles.Graph4,<span class="string">'color'</span>,<span class="string">'none'</span>);
2810     set(handles.AddPlot2_Nothing,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2811     set(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2812     set(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2813     set(handles.AddPlot2_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2814     set(handles.AddPlot2_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2815 <span class="keyword">end</span>
2816 <span class="comment">%p = get(handles.Graph1,'Position');</span>
2817 <span class="comment">%set(handles.Graph3,'Position', [p(1) p(2) p(3) p(4)]);</span>
2818 <span class="comment">%plotappdatalocal(handles);</span>
2819 
2820 
2821 <span class="comment">% --------------------------------------------------------------------</span>
2822 <a name="_sub57" href="#_subfunctions" class="code">function DrawLattice_Callback(hObject, eventdata, handles)</a>
2823 
2824 CheckMark = get(handles.DrawLattice, <span class="string">'Checked'</span>);
2825 <span class="keyword">if</span> strcmpi(CheckMark, <span class="string">'On'</span>)
2826     d = .01;
2827     p1 = [0.07    0.65-d    0.74    0.29+d];
2828     set(handles.Graph1, <span class="string">'Position'</span>, p1);
2829     set(handles.Graph3, <span class="string">'Position'</span>, p1);
2830 
2831     p2 = [0.07    0.27    0.74    0.29+d];
2832     set(handles.Graph2, <span class="string">'Position'</span>, p2);
2833     set(handles.Graph4, <span class="string">'Position'</span>, p2);
2834 
2835     set(handles.DrawLattice, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
2836     set(get(handles.LatticeAxes,<span class="string">'Children'</span>), <span class="string">'Visible'</span> , <span class="string">'Off'</span>);
2837 <span class="keyword">else</span>
2838     p1 = [0.07    0.65    0.74    0.29];
2839     set(handles.Graph1, <span class="string">'Position'</span>, p1);
2840     set(handles.Graph3, <span class="string">'Position'</span>, p1);
2841 
2842     p2 = [0.07    0.27    0.74    0.29];
2843     set(handles.Graph2, <span class="string">'Position'</span>, p2);
2844     set(handles.Graph4, <span class="string">'Position'</span>, p2);
2845 
2846     set(handles.DrawLattice, <span class="string">'Checked'</span>, <span class="string">'On'</span>);
2847     set(get(handles.LatticeAxes,<span class="string">'Children'</span>), <span class="string">'Visible'</span> , <span class="string">'On'</span>);
2848 <span class="keyword">end</span>
2849 
2850 
2851 <span class="comment">% --------------------------------------------------------------------</span>
2852 <a name="_sub58" href="#_subfunctions" class="code">function AddPlot1_LatticeAxes_Callback(hObject, eventdata, handles)</a>
2853 axes(handles.Graph3);
2854 drawlattice;
2855 set(gca,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
2856 set(gca,<span class="string">'color'</span>,<span class="string">'none'</span>);
2857 a = getappdata(handles.figure1, <span class="string">'AxisRange1X'</span>);
2858 <span class="comment">%axis([a -5 5]);</span>
2859 axis([a -12 1.5]);
2860 
2861 set(gca ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2862 h = get(gca,<span class="string">'Children'</span>);
2863 <span class="keyword">for</span> i = 1:length(h)
2864     set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2865 <span class="keyword">end</span>
2866 
2867 axes(handles.Graph1);
2868 
2869 set(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2870 set(handles.AddPlot1_LatticeAxes,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2871 set(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2872 set(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2873 set(handles.AddPlot1_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2874 set(handles.AddPlot1_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2875 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2876 
2877 <span class="comment">% --------------------------------------------------------------------</span>
2878 <a name="_sub59" href="#_subfunctions" class="code">function AddPlot2_LatticeAxes_Callback(hObject, eventdata, handles)</a>
2879 axes(handles.Graph4);
2880 drawlattice;
2881 set(gca,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
2882 set(gca,<span class="string">'color'</span>,<span class="string">'none'</span>);
2883 a = getappdata(handles.figure1, <span class="string">'AxisRange2X'</span>);
2884 <span class="comment">%axis([a -5 5]);</span>
2885 axis([a -12 1.5]);
2886 
2887 set(gca ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2888 h = get(gca,<span class="string">'Children'</span>);
2889 <span class="keyword">for</span> i = 1:length(h)
2890     set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2891 <span class="keyword">end</span>
2892 
2893 axes(handles.Graph2);
2894 
2895 set(handles.AddPlot2_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2896 set(handles.AddPlot2_LatticeAxes,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2897 set(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2898 set(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2899 set(handles.AddPlot2_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2900 set(handles.AddPlot2_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2901 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2902 
2903 <span class="comment">% --------------------------------------------------------------------</span>
2904 <a name="_sub60" href="#_subfunctions" class="code">function AddPlot_Beta_Callback(hObject, eventdata, handles)</a>
2905 hp = get(hObject,<span class="string">'Parent'</span>);
2906 hp = get(hp,<span class="string">'Parent'</span>);
2907 hp = get(hp,<span class="string">'Parent'</span>);
2908 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
2909     hAxes = handles.Graph3;
2910 <span class="keyword">else</span>
2911     hAxes = handles.Graph4;
2912 <span class="keyword">end</span>
2913 [BetaX, BetaY, Sx, Sy] = modelbeta(<span class="string">'All'</span>,<span class="string">'All'</span>);
2914 <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
2915     plot(hAxes, Sx, BetaX,<span class="string">'g'</span>);
2916 <span class="keyword">else</span>
2917     plot(hAxes, Sy, BetaY,<span class="string">'g'</span>);
2918 <span class="keyword">end</span>
2919 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
2920     AxisRangeX = getappdata(handles.figure1, <span class="string">'AxisRange1X'</span>);
2921 <span class="keyword">else</span>
2922     AxisRangeX = getappdata(handles.figure1, <span class="string">'AxisRange2X'</span>);
2923 <span class="keyword">end</span>
2924 
2925 axis(hAxes, <span class="string">'auto'</span>);
2926 a = axis(hAxes);        
2927 del = a(4) - a(3);
2928 axis(hAxes, [AxisRangeX(1) AxisRangeX(2) a(3)-.4*del a(4)+.4*del]);
2929 
2930 set(hAxes,<span class="string">'color'</span>,<span class="string">'none'</span>);
2931 set(hAxes,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
2932 <span class="comment">%set(hAxes,'YAxisLocation','Right');</span>
2933 
2934 <span class="comment">% set(hAxes,'XTick',[]);</span>
2935 <span class="comment">% set(hAxes,'XTickLabel',[]);</span>
2936 <span class="comment">% set(hAxes,'XMinorTick','Off');</span>
2937 <span class="comment">% set(hAxes,'XMinorGrid','Off');</span>
2938 <span class="comment">% set(hAxes,'XGrid','Off');</span>
2939 <span class="comment">% set(hAxes,'YGrid','Off');</span>
2940 <span class="comment">% set(hAxes,'YTick',[]);</span>
2941 <span class="comment">% set(hAxes,'YMinorTick','Off');</span>
2942 <span class="comment">% set(hAxes,'YMinorGrid','Off');</span>
2943 <span class="comment">% set(hAxes,'YTickLabel',[]);</span>
2944 
2945 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
2946     set(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2947     <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
2948         set(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2949         set(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2950     <span class="keyword">else</span>
2951         set(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2952         set(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2953     <span class="keyword">end</span>
2954     set(handles.AddPlot1_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2955     set(handles.AddPlot1_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2956     
2957     set(hAxes ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2958     h = get(hAxes,<span class="string">'Children'</span>);
2959     <span class="keyword">for</span> i = 1:length(h)
2960         set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2961     <span class="keyword">end</span>
2962     
2963 <span class="keyword">else</span>
2964     set(handles.AddPlot2_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2965     <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
2966         set(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2967         set(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2968     <span class="keyword">else</span>
2969         set(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2970         set(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
2971     <span class="keyword">end</span>
2972     set(handles.AddPlot2_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2973     set(handles.AddPlot2_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
2974     
2975     set(hAxes ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2976     h = get(hAxes,<span class="string">'Children'</span>);
2977     <span class="keyword">for</span> i = 1:length(h)
2978         set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
2979     <span class="keyword">end</span>
2980 <span class="keyword">end</span>
2981 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
2982 
2983 
2984 <span class="comment">% --------------------------------------------------------------------</span>
2985 <a name="_sub61" href="#_subfunctions" class="code">function AddPlot_Dispersion_Callback(hObject, eventdata, handles)</a>
2986 <span class="comment">% Plot dispersion in physics units</span>
2987 hp = get(hObject,<span class="string">'Parent'</span>);
2988 hp = get(hp,<span class="string">'Parent'</span>);
2989 hp = get(hp,<span class="string">'Parent'</span>);
2990 
2991 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
2992     hAxes = handles.Graph3;
2993 <span class="keyword">else</span>
2994     hAxes = handles.Graph4;
2995 <span class="keyword">end</span>
2996 
2997 [DispX, DispY, Sx, Sy] = modeldisp(<span class="string">'All'</span>,<span class="string">'All'</span>,<span class="string">'Physics'</span>);
2998 <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
2999     plot(hAxes, Sx, DispX,<span class="string">'g'</span>);
3000 <span class="keyword">else</span>
3001     plot(hAxes, Sy, DispY,<span class="string">'g'</span>);
3002 <span class="keyword">end</span>
3003 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
3004     AxisRangeX = getappdata(handles.figure1, <span class="string">'AxisRange1X'</span>);
3005 <span class="keyword">else</span>
3006     AxisRangeX = getappdata(handles.figure1, <span class="string">'AxisRange2X'</span>);
3007 <span class="keyword">end</span>
3008 axis(hAxes, <span class="string">'auto'</span>);
3009 a = axis(hAxes);        
3010 del = a(4) - a(3);
3011 axis(hAxes, [AxisRangeX(1) AxisRangeX(2) a(3)-.4*del a(4)+.4*del]);
3012 
3013 set(hAxes,<span class="string">'color'</span>,<span class="string">'none'</span>);
3014 set(hAxes,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
3015 
3016 <span class="keyword">if</span> strcmp(get(hp,<span class="string">'Label'</span>),<span class="string">'Graph #1'</span>)
3017     set(handles.AddPlot1_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3018     <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
3019         set(handles.AddPlot1_DispX,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3020         set(handles.AddPlot1_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3021     <span class="keyword">else</span>
3022         set(handles.AddPlot1_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3023         set(handles.AddPlot1_DispY,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3024     <span class="keyword">end</span>
3025     set(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3026     set(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3027     
3028     set(hAxes ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
3029     h = get(hAxes,<span class="string">'Children'</span>);
3030     <span class="keyword">for</span> i = 1:length(h)
3031         set(h(i) ,<span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph1_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
3032     <span class="keyword">end</span>
3033     
3034 <span class="keyword">else</span>
3035     set(handles.AddPlot2_Nothing,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3036     <span class="keyword">if</span> strcmp(get(hObject,<span class="string">'Label'</span>),<span class="string">'Horizontal'</span>)
3037         set(handles.AddPlot2_DispX,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3038         set(handles.AddPlot2_DispY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3039     <span class="keyword">else</span>
3040         set(handles.AddPlot2_DispX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3041         set(handles.AddPlot2_DispY,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3042     <span class="keyword">end</span>
3043     set(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3044     set(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3045     
3046     set(hAxes, <span class="string">'ButtonDownFcn'</span>,<span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
3047     h = get(hAxes, <span class="string">'Children'</span>);
3048     <span class="keyword">for</span> i = 1:length(h)
3049         set(h(i), <span class="string">'ButtonDownFcn'</span>, <span class="string">'plotfamily(''Graph2_ButtonDown'',gcbo,[],guidata(gcbo))'</span>);
3050     <span class="keyword">end</span>
3051 <span class="keyword">end</span>
3052 <a href="#_sub9" class="code" title="subfunction plotappdatalocal(handles)">plotappdatalocal</a>(handles);
3053 
3054 
3055 <span class="comment">% --------------------------------------------------------------------</span>
3056 <a name="_sub62" href="#_subfunctions" class="code">function Graph1_ButtonDown(hObject, eventdata, handles)</a>
3057 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);
3058 CurrentPoint = get(gca, <span class="string">'CurrentPoint'</span>);
3059 SposMouse = CurrentPoint(1,1);
3060 SposData = getappdata(handles.figure1, <span class="string">'SPosX'</span>);
3061 
3062 MeritFcn = abs(SposData-SposMouse);
3063 i = find(min(MeritFcn) == MeritFcn);
3064 set(handles.DataList1, <span class="string">'value'</span>, i(1));
3065 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>);
3066 
3067 <span class="comment">% --------------------------------------------------------------------</span>
3068 <a name="_sub63" href="#_subfunctions" class="code">function Graph2_ButtonDown(hObject, eventdata, handles)</a>
3069 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);
3070 CurrentPoint = get(gca, <span class="string">'CurrentPoint'</span>);
3071 SposMouse = CurrentPoint(1,1);
3072 SposData = getappdata(handles.figure1, <span class="string">'SPosY'</span>);
3073 
3074 MeritFcn = abs(SposData-SposMouse);
3075 i = find(min(MeritFcn) == MeritFcn);
3076 set(handles.DataList2, <span class="string">'value'</span>, i(1));
3077 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>);
3078 
3079 
3080 <span class="comment">% --- Executes on button press in AutoScale1.</span>
3081 <a name="_sub64" href="#_subfunctions" class="code">function AutoScaleH_Callback(hObject, eventdata, handles)</a>
3082 
3083 <span class="comment">% Gets selected H view (all, supercell 1 to 4)</span>
3084 children = allchild(handles.supercell);
3085 <span class="comment">% Which one is selected</span>
3086 selected = find(strcmp(get(children,<span class="string">'Checked'</span>),<span class="string">'on'</span>));
3087 Tag = get(children,<span class="string">'Tag'</span>);
3088 
3089 callbackname = sprintf(<span class="string">'%s_Callback'</span>,Tag{selected});
3090 <a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>(callbackname, gcbo, [], guidata(gcbo));
3091 
3092 
3093 <span class="comment">% --- Executes on button press in AutoScale1.</span>
3094 <a name="_sub65" href="#_subfunctions" class="code">function AutoScale1_Callback(hObject, eventdata, handles)</a>
3095 
3096 <span class="comment">% Auto-scale x-axis</span>
3097 a = axis(handles.Graph1);
3098 axis(handles.Graph1, <span class="string">'auto'</span>);
3099 set(handles.Graph1, <span class="string">'XLim'</span>, a(1:2));
3100 
3101 <span class="comment">% Gets selected H view (all, supercell 1 to 4)</span>
3102 children = allchild(handles.supercell);
3103 <span class="comment">% Which one is selected</span>
3104 selected = find(strcmp(get(children,<span class="string">'Checked'</span>),<span class="string">'on'</span>));
3105 Tag = get(children,<span class="string">'Tag'</span>);
3106 
3107 callbackname = sprintf(<span class="string">'%s_Callback'</span>,Tag{selected});
3108 <a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>(callbackname, gcbo, [], guidata(gcbo));
3109 
3110 <span class="comment">% Auto-scale x-axis</span>
3111 a1 = axis(handles.Graph1);
3112 set(handles.Graph1, <span class="string">'Xlim'</span>, a1(1:2));
3113 set(handles.Graph3, <span class="string">'Xlim'</span>, a1(1:2));
3114 set(handles.LatticeAxes, <span class="string">'Xlim'</span>, a1(1:2));
3115 
3116 
3117 <span class="comment">% --- Executes on button press in AutoScale2.</span>
3118 <a name="_sub66" href="#_subfunctions" class="code">function AutoScale2_Callback(hObject, eventdata, handles)</a>
3119 
3120 <span class="comment">% Auto-scale x-axis</span>
3121 a = axis(handles.Graph2);
3122 axis(handles.Graph2, <span class="string">'auto'</span>);
3123 set(handles.Graph2, <span class="string">'XLim'</span>, a(1:2));
3124 
3125 <span class="comment">% Gets selected H view (all, supercell 1 to 4)</span>
3126 children = allchild(handles.supercell);
3127 
3128 <span class="comment">% Which one is selected</span>
3129 selected = find(strcmp(get(children,<span class="string">'Checked'</span>),<span class="string">'on'</span>));
3130 Tag = get(children,<span class="string">'Tag'</span>);
3131 
3132 callbackname = sprintf(<span class="string">'%s_Callback'</span>,Tag{selected});
3133 <a href="plotfamily.html" class="code" title="function varargout = plotfamily(varargin)">plotfamily</a>(callbackname, gcbo, [], guidata(gcbo));
3134 
3135 <span class="comment">% Auto-scale x-axis</span>
3136 a1 = axis(handles.Graph2);
3137 set(handles.Graph2, <span class="string">'Xlim'</span>, a1(1:2));
3138 set(handles.Graph4, <span class="string">'Xlim'</span>, a1(1:2));
3139 set(handles.LatticeAxes, <span class="string">'Xlim'</span>, a1(1:2));
3140 
3141 
3142 <span class="comment">% --- Executes on button press in AutoScaleYLocal.</span>
3143 <a name="_sub67" href="#_subfunctions" class="code">function AutoScaleYLocal(handles)</a>
3144 axis(handles.Graph1, <span class="string">'auto'</span>);
3145 AxisRange1X = getappdata(handles.figure1, <span class="string">'AxisRange1X'</span>);
3146 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3147 
3148 axis(handles.Graph2, <span class="string">'auto'</span>);
3149 AxisRange2X = getappdata(handles.figure1, <span class="string">'AxisRange2X'</span>);
3150 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange2X);
3151 
3152 
3153 <span class="comment">% --- Executes on button press in Graph1ZoomInVertical.</span>
3154 <a name="_sub68" href="#_subfunctions" class="code">function Graph1ZoomInVertical_Callback(hObject, eventdata, handles)</a>
3155 a = axis(handles.Graph1);
3156 ChangeFactor = 1.15;
3157 del = (1/ChangeFactor-1)*(a(4)-a(3));
3158 set(handles.Graph1, <span class="string">'YLim'</span>, [a(3)-del/2 a(4)+del/2]);
3159 set(hObject, <span class="string">'Value'</span>, 0);
3160 
3161 
3162 <span class="comment">% --- Executes on button press in Graph1ZoomOutVertical.</span>
3163 <a name="_sub69" href="#_subfunctions" class="code">function Graph1ZoomOutVertical_Callback(hObject, eventdata, handles)</a>
3164 a = axis(handles.Graph1);
3165 ChangeFactor = 1.15;
3166 del = (ChangeFactor-1)*(a(4)-a(3));
3167 set(handles.Graph1, <span class="string">'YLim'</span>, [a(3)-del/2 a(4)+del/2]);
3168 set(hObject, <span class="string">'Value'</span>, 0);
3169 
3170 
3171 <span class="comment">% --- Executes on button press in Graph2ZoomInVertical.</span>
3172 <a name="_sub70" href="#_subfunctions" class="code">function Graph2ZoomInVertical_Callback(hObject, eventdata, handles)</a>
3173 a = axis(handles.Graph2);
3174 ChangeFactor = 1.15;
3175 del = (1/ChangeFactor-1)*(a(4)-a(3));
3176 set(handles.Graph2, <span class="string">'YLim'</span>, [a(3)-del/2 a(4)+del/2]);
3177 set(hObject, <span class="string">'Value'</span>, 0);
3178 
3179 
3180 <span class="comment">% --- Executes on button press in Graph2ZoomOutVertical.</span>
3181 <a name="_sub71" href="#_subfunctions" class="code">function Graph2ZoomOutVertical_Callback(hObject, eventdata, handles)</a>
3182 a = axis(handles.Graph2);
3183 ChangeFactor = 1.15;
3184 del = (ChangeFactor-1)*(a(4)-a(3));
3185 set(handles.Graph2, <span class="string">'YLim'</span>, [a(3)-del/2 a(4)+del/2]);
3186 set(hObject, <span class="string">'Value'</span>, 0);
3187 
3188 
3189 <span class="comment">% --- Executes on button press in Graph1ZoomInVertical.</span>
3190 <a name="_sub72" href="#_subfunctions" class="code">function Graph1OffsetDownVertical_Callback(hObject, eventdata, handles)</a>
3191 ChangeFactor = 1.1;
3192 a1 = axis(handles.Graph1);
3193 del1 = (ChangeFactor-1)*(a1(4)-a1(3));
3194 set(handles.Graph1, <span class="string">'YLim'</span>, [a1(3)+del1 a1(4)+del1]);
3195 set(hObject, <span class="string">'Value'</span>, 0);
3196 
3197 <span class="comment">% --- Executes on button press in Graph1ZoomOutVertical.</span>
3198 <a name="_sub73" href="#_subfunctions" class="code">function Graph1OffsetUpVertical_Callback(hObject, eventdata, handles)</a>
3199 ChangeFactor = 1.1;
3200 a1 = axis(handles.Graph1);
3201 del1 = (1/ChangeFactor-1)*(a1(4)-a1(3));
3202 set(handles.Graph1, <span class="string">'Ylim'</span>, [a1(3)+del1 a1(4)+del1]);
3203 set(hObject, <span class="string">'Value'</span>, 0);
3204 
3205 
3206 <span class="comment">% --- Executes on button press in Graph1ZoomInVertical.</span>
3207 <a name="_sub74" href="#_subfunctions" class="code">function Graph2OffsetDownVertical_Callback(hObject, eventdata, handles)</a>
3208 ChangeFactor = 1.1;
3209 a1 = axis(handles.Graph2);
3210 del1 = (ChangeFactor-1)*(a1(4)-a1(3));
3211 set(handles.Graph2, <span class="string">'YLim'</span>, [a1(3)+del1 a1(4)+del1]);
3212 set(hObject, <span class="string">'Value'</span>, 0);
3213 
3214 <span class="comment">% --- Executes on button press in Graph1ZoomOutVertical.</span>
3215 <a name="_sub75" href="#_subfunctions" class="code">function Graph2OffsetUpVertical_Callback(hObject, eventdata, handles)</a>
3216 ChangeFactor = 1.1;
3217 a1 = axis(handles.Graph2);
3218 del1 = (1/ChangeFactor-1)*(a1(4)-a1(3));
3219 set(handles.Graph2, <span class="string">'YLim'</span>, [a1(3)+del1 a1(4)+del1]);
3220 set(hObject, <span class="string">'Value'</span>, 0);
3221 
3222 
3223 <span class="comment">% --- Executes on button press in HorizontalOffsetRight.</span>
3224 <a name="_sub76" href="#_subfunctions" class="code">function HorizontalOffsetLeft_Callback(hObject, eventdata, handles)</a>
3225 ChangeFactor = 1.05;
3226 a1 = axis(handles.Graph1);
3227 a2 = axis(handles.Graph2);
3228 del1 = (ChangeFactor-1)*(a1(2)-a1(1));
3229 del2 = (ChangeFactor-1)*(a2(2)-a2(1));
3230 set(handles.Graph1, <span class="string">'XLim'</span>, [a1(1)+del1 a1(2)+del1]);
3231 set(handles.Graph3, <span class="string">'XLim'</span>, [a1(1)+del1 a1(2)+del1]);
3232 set(handles.Graph2, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3233 set(handles.Graph4, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3234 set(handles.LatticeAxes, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3235 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, [a1(1)+del1 a1(2)+del1]);
3236 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, [a2(1)+del2 a2(2)+del2]);
3237 
3238 <a name="_sub77" href="#_subfunctions" class="code">function HorizontalOffsetRight_Callback(hObject, eventdata, handles)</a>
3239 ChangeFactor = 1.05;
3240 a1 = axis(handles.Graph1);
3241 a2 = axis(handles.Graph2);
3242 del1 = (1/ChangeFactor-1)*(a1(2)-a1(1));
3243 del2 = (1/ChangeFactor-1)*(a2(2)-a2(1));
3244 set(handles.Graph1, <span class="string">'XLim'</span>, [a1(1)+del1 a1(2)+del1]);
3245 set(handles.Graph3, <span class="string">'XLim'</span>, [a1(1)+del1 a1(2)+del1]);
3246 set(handles.Graph2, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3247 set(handles.Graph4, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3248 set(handles.LatticeAxes, <span class="string">'XLim'</span>, [a2(1)+del2 a2(2)+del2]);
3249 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, [a1(1)+del1 a1(2)+del1]);
3250 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, [a2(1)+del2 a2(2)+del2]);
3251 
3252 <a name="_sub78" href="#_subfunctions" class="code">function Graph1ZoomInHorizontal_Callback(hObject, eventdata, handles)</a>
3253 ChangeFactor = 1.3;
3254 a1 = axis(handles.Graph1);
3255 a2 = axis(handles.Graph2);
3256 del1 = (1/ChangeFactor-1)*(a1(2)-a1(1));
3257 del2 = (1/ChangeFactor-1)*(a2(2)-a2(1));
3258 set(handles.Graph1, <span class="string">'XLim'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3259 set(handles.Graph3, <span class="string">'XLim'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3260 set(handles.Graph2, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3261 set(handles.Graph4, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3262 set(handles.LatticeAxes, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3263 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3264 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3265 
3266 <a name="_sub79" href="#_subfunctions" class="code">function Graph1ZoomOutHorizontal_Callback(hObject, eventdata, handles)</a>
3267 ChangeFactor = 1.3;
3268 a1 = axis(handles.Graph1);
3269 a2 = axis(handles.Graph2);
3270 del1 = (ChangeFactor-1)*(a1(2)-a1(1));
3271 del2 = (ChangeFactor-1)*(a2(2)-a2(1));
3272 set(handles.Graph1, <span class="string">'XLim'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3273 set(handles.Graph3, <span class="string">'XLim'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3274 set(handles.Graph2, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3275 set(handles.Graph4, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3276 set(handles.LatticeAxes, <span class="string">'XLim'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3277 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, [a1(1)-del1/2 a1(2)+del1/2]);
3278 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, [a2(1)-del2/2 a2(2)+del2/2]);
3279 
3280 
3281 
3282 <span class="comment">% --------------------------------------------------------------------</span>
3283 <a name="_sub80" href="#_subfunctions" class="code">function supercell_Callback(hObject, eventdata, handles)</a>
3284 <span class="comment">% hObject    handle to supercell (see GCBO)</span>
3285 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3286 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3287 
3288 
3289 <span class="comment">% --------------------------------------------------------------------</span>
3290 <a name="_sub81" href="#_subfunctions" class="code">function all_Callback(hObject, eventdata, handles)</a>
3291 <span class="comment">% hObject    handle to all (see GCBO)</span>
3292 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3293 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3294 
3295 L = getfamilydata(<span class="string">'Circumference'</span>);
3296 <span class="keyword">if</span> isempty(L)
3297     Family = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
3298     s = getspos(Family);
3299     AxisRange1X = [min(s) max(s)];
3300 <span class="keyword">else</span>
3301     AxisRange1X = [0 L];
3302 <span class="keyword">end</span>
3303 
3304 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3305 set(handles.Graph3, <span class="string">'XLim'</span>, AxisRange1X);
3306 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange1X);
3307 set(handles.Graph4, <span class="string">'XLim'</span>, AxisRange1X);
3308 set(handles.LatticeAxes, <span class="string">'XLim'</span>, AxisRange1X);
3309 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, AxisRange1X);
3310 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, AxisRange1X);
3311 
3312 set(handles.all,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3313 set(handles.superperiod1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3314 set(handles.superperiod2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3315 set(handles.superperiod3,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3316 set(handles.superperiod4,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3317 
3318 
3319 <span class="comment">% --------------------------------------------------------------------</span>
3320 <a name="_sub82" href="#_subfunctions" class="code">function superperiod1_Callback(hObject, eventdata, handles)</a>
3321 <span class="comment">% hObject    handle to superperiod1 (see GCBO)</span>
3322 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3323 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3324 
3325 L = getfamilydata(<span class="string">'Circumference'</span>);
3326 <span class="keyword">if</span> isempty(L)
3327     Family = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
3328     s = getspos(Family);
3329     AxisRange1X = [min(s) max(s)/4];
3330 <span class="keyword">else</span>
3331     AxisRange1X = [0 0.25]*L;
3332 <span class="keyword">end</span>
3333 
3334 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3335 set(handles.Graph3, <span class="string">'XLim'</span>, AxisRange1X);
3336 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange1X);
3337 set(handles.Graph4, <span class="string">'XLim'</span>, AxisRange1X);
3338 set(handles.LatticeAxes, <span class="string">'XLim'</span>, AxisRange1X);
3339 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, AxisRange1X);
3340 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, AxisRange1X);
3341 
3342 set(handles.all,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3343 set(handles.superperiod1,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3344 set(handles.superperiod2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3345 set(handles.superperiod3,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3346 set(handles.superperiod4,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3347 
3348 <span class="comment">% --------------------------------------------------------------------</span>
3349 <a name="_sub83" href="#_subfunctions" class="code">function superperiod2_Callback(hObject, eventdata, handles)</a>
3350 <span class="comment">% hObject    handle to superperiod2 (see GCBO)</span>
3351 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3352 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3353 
3354 L = getfamilydata(<span class="string">'Circumference'</span>);
3355 <span class="keyword">if</span> isempty(L)
3356     Family = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
3357     s = getspos(Family);
3358     AxisRange1X = [min(s)*0.25 max(s)*.5];
3359 <span class="keyword">else</span>
3360     AxisRange1X = [0.25 .5]*L;
3361 <span class="keyword">end</span>
3362 
3363 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3364 set(handles.Graph3, <span class="string">'XLim'</span>, AxisRange1X);
3365 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange1X);
3366 set(handles.Graph4, <span class="string">'XLim'</span>, AxisRange1X);
3367 set(handles.LatticeAxes, <span class="string">'XLim'</span>, AxisRange1X);
3368 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, AxisRange1X);
3369 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, AxisRange1X);
3370 
3371 set(handles.all,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3372 set(handles.superperiod1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3373 set(handles.superperiod2,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3374 set(handles.superperiod3,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3375 set(handles.superperiod4,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3376 
3377 <span class="comment">% --------------------------------------------------------------------</span>
3378 <a name="_sub84" href="#_subfunctions" class="code">function superperiod3_Callback(hObject, eventdata, handles)</a>
3379 <span class="comment">% hObject    handle to superperiod3 (see GCBO)</span>
3380 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3381 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3382 
3383 L = getfamilydata(<span class="string">'Circumference'</span>);
3384 <span class="keyword">if</span> isempty(L)
3385     Family = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
3386     s = getspos(Family);
3387     AxisRange1X = [min(s)*0.5 max(s)*0.75];
3388 <span class="keyword">else</span>
3389     AxisRange1X = [0.5 0.75]*L;
3390 <span class="keyword">end</span>
3391 
3392 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3393 set(handles.Graph3, <span class="string">'XLim'</span>, AxisRange1X);
3394 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange1X);
3395 set(handles.Graph4, <span class="string">'XLim'</span>, AxisRange1X);
3396 set(handles.LatticeAxes, <span class="string">'XLim'</span>, AxisRange1X);
3397 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, AxisRange1X);
3398 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, AxisRange1X);
3399 
3400 set(handles.all,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3401 set(handles.superperiod1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3402 set(handles.superperiod2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3403 set(handles.superperiod3,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3404 set(handles.superperiod4,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3405 
3406 <span class="comment">% --------------------------------------------------------------------</span>
3407 <a name="_sub85" href="#_subfunctions" class="code">function superperiod4_Callback(hObject, eventdata, handles)</a>
3408 <span class="comment">% hObject    handle to superperiod4 (see GCBO)</span>
3409 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3410 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3411 
3412 
3413 L = getfamilydata(<span class="string">'Circumference'</span>);
3414 <span class="keyword">if</span> isempty(L)
3415     Family = getappdata(handles.figure1, <span class="string">'BPMxFamily'</span>);
3416     s = getspos(Family);
3417     AxisRange1X = [min(s)*0.75 max(s)];
3418 <span class="keyword">else</span>
3419     AxisRange1X = [0.75 1]*L;
3420 <span class="keyword">end</span>
3421 
3422 set(handles.Graph1, <span class="string">'XLim'</span>, AxisRange1X);
3423 set(handles.Graph3, <span class="string">'XLim'</span>, AxisRange1X);
3424 set(handles.Graph2, <span class="string">'XLim'</span>, AxisRange1X);
3425 set(handles.Graph4, <span class="string">'XLim'</span>, AxisRange1X);
3426 set(handles.LatticeAxes, <span class="string">'XLim'</span>, AxisRange1X);
3427 setappdata(handles.figure1, <span class="string">'AxisRange1X'</span>, AxisRange1X);
3428 setappdata(handles.figure1, <span class="string">'AxisRange2X'</span>, AxisRange1X);
3429 
3430 set(handles.all,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3431 set(handles.superperiod1,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3432 set(handles.superperiod2,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3433 set(handles.superperiod3,<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
3434 set(handles.superperiod4,<span class="string">'Checked'</span>,<span class="string">'On'</span>);
3435 
3436 <span class="comment">%% What to do before closing the application</span>
3437 <a name="_sub86" href="#_subfunctions" class="code">function Closinggui(obj, event, handles, figure1)</a>
3438 
3439 <span class="comment">% Get default command line output from handles structure</span>
3440 answer = questdlg(<span class="string">'Close PlotFamily?'</span>,<span class="keyword">...</span>
3441     <span class="string">'Exit PlotFamily Program'</span>,<span class="keyword">...</span>
3442     <span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
3443 
3444 <span class="keyword">switch</span> answer
3445     <span class="keyword">case</span> <span class="string">'Yes'</span>
3446         <span class="comment">%         delete(handles); %Delete Timer</span>
3447         delete(figure1); <span class="comment">%Close gui</span>
3448     <span class="keyword">otherwise</span>
3449         disp(<span class="string">'Closing aborted'</span>)
3450 <span class="keyword">end</span>
3451 
3452 
3453 <span class="comment">% --------------------------------------------------------------------</span>
3454 <a name="_sub87" href="#_subfunctions" class="code">function ReloadGoldenOrbit_Callback(hObject, eventdata, handles)</a>
3455 <span class="comment">% hObject    handle to ReloadGoldenOrbit (see GCBO)</span>
3456 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
3457 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
3458 
3459 setappdata(handles.figure1,<span class="string">'GoldenX'</span>, getgolden(<span class="string">'BPMx'</span>));
3460 setappdata(handles.figure1,<span class="string">'GoldenY'</span>, getgolden(<span class="string">'BPMz'</span>));
3461 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
3462 
3463 <span class="comment">% Just in LatticeAxes menu (Not plotfamily)</span>
3464 <a name="_sub88" href="#_subfunctions" class="code">function Switch2HW_Callback(hObject, eventdata, handles)</a>
3465 switch2hw;
3466 
3467 <a name="_sub89" href="#_subfunctions" class="code">function Switch2Physics_Callback(hObject, eventdata, handles)</a>
3468 switch2physics;
3469 
3470 <a name="_sub90" href="#_subfunctions" class="code">function Switch2Online_Callback(hObject, eventdata, handles)</a>
3471 switch2online;
3472 
3473 <a name="_sub91" href="#_subfunctions" class="code">function Switch2Sim_Callback(hObject, eventdata, handles)</a>
3474 switch2sim;
3475 
3476 
3477 
3478 
3479 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3480 <span class="comment">% Setpoint change callbacks %</span>
3481 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3482 
3483 <span class="comment">% --------------------------------------------------------------------</span>
3484 <a name="_sub92" href="#_subfunctions" class="code">function Lattice_ButtonDown(hObject, eventdata, handles)</a>
3485 <span class="comment">% Change setpoint request</span>
3486 ErrorFlag = 0;
3487 
3488 <span class="comment">% Only works on setpoint fields (at the moment)</span>
3489 Field = <span class="string">'Setpoint'</span>;
3490 
3491 <span class="keyword">try</span>
3492     ATIndex = get(hObject, <span class="string">'UserData'</span>);
3493 
3494     CurrentPoint = get(handles.LatticeAxes, <span class="string">'CurrentPoint'</span>);
3495     SposMouse = CurrentPoint(1,1);
3496     
3497     [Family, List] = atindex2family(ATIndex);
3498 
3499     <span class="keyword">if</span> isempty(Family) || isempty(List)
3500         ErrorFlag = 1;
3501     <span class="keyword">else</span>
3502 
3503         List = List(1,:);
3504 
3505         HCMFamily = gethcmfamily;
3506         VCMFamily = getvcmfamily;
3507         <span class="keyword">if</span> any(strcmpi(Family, {HCMFamily, VCMFamily}))
3508             <span class="comment">% A corrector was found (how do I know if it's a HCM or VCM?  AT does not differentiate)</span>
3509             <span class="keyword">if</span> strcmpi(Family, HCMFamily) &amp;&amp; CurrentPoint(1,2)&lt;0
3510                 <span class="comment">% It should be a VCM family</span>
3511                 DevList = family2dev(VCMFamily);
3512                 [i, col] = find(ATIndex == family2atindex(VCMFamily,DevList));
3513                 <span class="keyword">if</span> ~isempty(i)
3514                     Family = VCMFamily;
3515                     List = DevList(i,:);
3516                 <span class="keyword">end</span>
3517             <span class="keyword">elseif</span> strcmpi(Family, VCMFamily) &amp;&amp; CurrentPoint(1,2)&gt;0
3518                 <span class="comment">% It should be a HCM family</span>
3519                 DevList = family2dev(HCMFamily);
3520                 [i, col] = find(ATIndex == family2atindex(HCMFamily,DevList));
3521                 <span class="keyword">if</span> ~isempty(i)
3522                     Family = HCMFamily;
3523                     List = DevList(i,:);
3524                 <span class="keyword">end</span>
3525             <span class="keyword">end</span>
3526         <span class="keyword">end</span>
3527 
3528         [FamilyFlag,ao] = isfamily(Family);
3529 
3530         <span class="keyword">if</span> isfield(ao, Field)
3531             <span class="comment">% Get/save the present setpoint then call the GUI for setpoint changes</span>
3532             <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3533                 Mode = <span class="string">'Simulator'</span>;
3534             <span class="keyword">else</span>
3535                 Mode = <span class="string">'Online'</span>;
3536             <span class="keyword">end</span>
3537             <span class="keyword">if</span> strcmpi(get(handles.PhysicsUnitsFlag,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3538                 <span class="comment">%if getappdata(handles.figure1,'UnitsFlag') == 1</span>
3539                 UnitsFlag = <span class="string">'Physics'</span>;
3540             <span class="keyword">else</span>
3541                 UnitsFlag = <span class="string">'Hardware'</span>;
3542             <span class="keyword">end</span>
3543 
3544             SP = getpv(Family, Field, List, Mode, UnitsFlag, <span class="string">'Struct'</span>);
3545             set(handles.SetpointSlider,     <span class="string">'UserData'</span>, SP);
3546             set(handles.SetpointPushButton, <span class="string">'UserData'</span>, SP);
3547             <a href="#_sub93" class="code" title="subfunction SetpointGUI_Callback(hObject, eventdata, handles)">SetpointGUI_Callback</a>(hObject, eventdata, handles);
3548         <span class="keyword">else</span>
3549             ErrorFlag = 1;
3550         <span class="keyword">end</span>
3551     <span class="keyword">end</span>
3552 <span class="keyword">catch</span>
3553     ErrorFlag = 1;
3554     fprintf(<span class="string">'\n%s\n'</span>, lasterr);
3555     fprintf(<span class="string">'There was a problem getting %s.%s(%d,%d)\n'</span>, Family, Field, List);
3556 <span class="keyword">end</span>
3557 
3558 <span class="keyword">if</span> ErrorFlag
3559     <span class="comment">% Turn off the setpoint GUI</span>
3560     set(handles.SetpointEditBox,   <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3561     set(handles.SetpointFamily,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3562     set(handles.SetpointUnits,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3563     set(handles.SetpointSlider,    <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3564     set(handles.SetpointMax,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3565     set(handles.SetpointMin,       <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3566     set(handles.SetpointFrame,     <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3567     set(handles.SetpointStepSize,  <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3568     set(handles.SetpointPushButton,<span class="string">'Visible'</span>, <span class="string">'Off'</span>);
3569 
3570     <span class="comment">% Change the save and file text to make room for the slider</span>
3571     p = get(handles.SaveTime, <span class="string">'Position'</span>);
3572     set(handles.SaveTime, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
3573     p = get(handles.FileNameX, <span class="string">'Position'</span>);
3574     set(handles.FileNameX, <span class="string">'Position'</span>,  [p(1) p(2) 45 p(4)]);
3575     p = get(handles.FileNameY, <span class="string">'Position'</span>);
3576     set(handles.FileNameY, <span class="string">'Position'</span>, [p(1) p(2) 45 p(4)]);
3577 <span class="keyword">end</span>
3578 
3579 
3580 <span class="comment">% --------------------------------------------------------------------</span>
3581 <a name="_sub93" href="#_subfunctions" class="code">function SetpointGUI_Callback(hObject, eventdata, handles)</a>
3582 
3583 SP = get(handles.SetpointSlider, <span class="string">'UserData'</span>);
3584 
3585 <span class="comment">% Use slider and edit box</span>
3586 set(handles.SetpointSlider, <span class="string">'UserData'</span>, SP);
3587 <span class="keyword">try</span>
3588     MaxPV = maxpv(SP);
3589     MinPV = minpv(SP);
3590     <span class="comment">%if isinf(MaxPV) &amp;&amp; ~isnan(MaxPV)</span>
3591     <span class="comment">%    MaxPV = 1e10; %SP.Data + abs(SP.Data);</span>
3592     <span class="comment">%end</span>
3593     <span class="comment">%if isinf(MinPV) &amp;&amp; ~isnan(MinPV)</span>
3594     <span class="comment">%    MinPV = -1e10; %SP.Data - abs(SP.Data);;</span>
3595     <span class="comment">%end</span>
3596 
3597     <span class="keyword">if</span> MaxPV &lt; MinPV
3598         tmp = MaxPV;
3599         MaxPV = MinPV;
3600         MinPV = tmp;
3601     <span class="keyword">end</span>
3602 
3603     <span class="keyword">if</span> isnumeric(MaxPV) &amp;&amp; isnumeric(MinPV) &amp;&amp; ~isinf(MaxPV) &amp;&amp; ~isinf(MinPV) &amp;&amp; ~isnan(MaxPV) &amp;&amp; ~isnan(MinPV) &amp;&amp; (MaxPV-MinPV)~=0
3604         Range = abs(MaxPV-MinPV);
3605         <span class="keyword">if</span> Range == 1
3606             StepSize = 1;
3607         <span class="keyword">else</span>
3608             StepSize = Range/5000;
3609         <span class="keyword">end</span>
3610     <span class="keyword">else</span>
3611         StepSize = 1;
3612     <span class="keyword">end</span>
3613     set(handles.SetpointStepSize, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,StepSize));
3614 <span class="keyword">catch</span>
3615     MaxPV = Inf; <span class="comment">% 1e10; % SP.Data + abs(SP.Data);</span>
3616     MinPV =-Inf; <span class="comment">%-1e10; % SP.Data - abs(SP.Data);</span>
3617 <span class="keyword">end</span>
3618 
3619 set(handles.SetpointMax, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,MaxPV));
3620 set(handles.SetpointMin, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,MinPV));
3621 
3622 <span class="keyword">if</span> ~isinf(MaxPV) &amp;&amp; ~isnan(MaxPV) &amp;&amp; (MaxPV-MinPV)~=0
3623     set(handles.SetpointSlider, <span class="string">'Max'</span>, MaxPV);
3624 <span class="keyword">end</span>
3625 <span class="keyword">if</span> ~isinf(MinPV) &amp;&amp; ~isnan(MaxPV) &amp;&amp; (MaxPV-MinPV)~=0
3626     set(handles.SetpointSlider, <span class="string">'Min'</span>, MinPV);
3627 <span class="keyword">end</span>
3628 <a href="#_sub94" class="code" title="subfunction SetpointRange_Callback(hObject, eventdata, handles)">SetpointRange_Callback</a>(hObject, eventdata, handles);
3629 
3630 set(handles.SetpointFamily,  <span class="string">'String'</span>, sprintf(<span class="string">'%s.%s(%d,%d)'</span>, SP.FamilyName, SP.Field, SP.DeviceList));
3631 <span class="keyword">try</span>
3632     set(handles.SetpointFamily,  <span class="string">'TooltipString'</span>, sprintf(<span class="string">'%s'</span>, cell2mat(family2tango(SP))));
3633 <span class="keyword">catch</span>
3634     set(handles.SetpointFamily,  <span class="string">'TooltipString'</span>, <span class="string">''</span>);
3635 <span class="keyword">end</span>
3636 set(handles.SetpointUnits,   <span class="string">'String'</span>, [SP.UnitsString, <span class="string">'/step'</span>]);
3637 set(handles.SetpointEditBox, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>, SP.Data));
3638 set(handles.SetpointEditBox, <span class="string">'TooltipString'</span>, sprintf(<span class="string">'New setpoint in %s'</span>, SP.UnitsString));
3639 
3640 set(handles.SetpointPushButton, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>, SP.Data));
3641 set(handles.SetpointPushButton, <span class="string">'TooltipString'</span>, sprintf(<span class="string">'Restore original setpoint to %f %s'</span>, SP.Data, SP.UnitsString));
3642 
3643 
3644 set(handles.SetpointEditBox,   <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3645 set(handles.SetpointFamily,    <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3646 set(handles.SetpointUnits,     <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3647 set(handles.SetpointSlider,    <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3648 set(handles.SetpointMax,       <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3649 set(handles.SetpointMin,       <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3650 set(handles.SetpointFrame,     <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3651 set(handles.SetpointStepSize,  <span class="string">'Visible'</span>, <span class="string">'On'</span>);
3652 set(handles.SetpointPushButton,<span class="string">'Visible'</span>, <span class="string">'On'</span>);
3653 
3654 <span class="comment">% Change the save and file text to make room for the slider</span>
3655 p = get(handles.SaveTime, <span class="string">'Position'</span>);
3656 set(handles.SaveTime, <span class="string">'Position'</span>,  [p(1) p(2) 19 p(4)]);
3657 p = get(handles.FileNameX, <span class="string">'Position'</span>);
3658 set(handles.FileNameX, <span class="string">'Position'</span>,  [p(1) p(2) 19 p(4)]);
3659 p = get(handles.FileNameY, <span class="string">'Position'</span>);
3660 set(handles.FileNameY, <span class="string">'Position'</span>, [p(1) p(2) 19 p(4)]);
3661 
3662 <span class="comment">% % Other method: use input dialog box</span>
3663 <span class="comment">% answer = inputdlg(sprintf('Enter new setpoint for %s.%s(%d,%d) in %s (%s):', SP.FamilyName, SP.Field, SP.DeviceList, SP.UnitsString, SP.Mode),'FAMILYPLOT',1,{sprintf('%s',num2str(SP.Data))});</span>
3664 <span class="comment">% if ~isempty(answer)</span>
3665 <span class="comment">%     NewSP = str2num(answer{1});</span>
3666 <span class="comment">%     if ~isempty(NewSP)</span>
3667 <span class="comment">%         SP.Data = NewSP</span>
3668 <span class="comment">%         set(handles.SetpointSlider,  'UserData', SP);</span>
3669 <span class="comment">%         ChangeSetpointPlotfamily(hObject, eventdata, handles);</span>
3670 <span class="comment">%         %setpv(Family, Field, NewSP, List, Mode);</span>
3671 <span class="comment">%     end</span>
3672 <span class="comment">% end</span>
3673 
3674 
3675 <span class="comment">% --------------------------------------------------------------------</span>
3676 <a name="_sub94" href="#_subfunctions" class="code">function SetpointRange_Callback(hObject, eventdata, handles)</a>
3677 
3678 MaxPV = str2num(get(handles.SetpointMax,<span class="string">'String'</span>)); <span class="comment">%#ok&lt;ST2NM&gt;</span>
3679 MinPV = str2num(get(handles.SetpointMin,<span class="string">'String'</span>));
3680 
3681 <span class="keyword">if</span> isnumeric(MaxPV) &amp;&amp; isnumeric(MinPV) &amp;&amp; ~isinf(MaxPV) &amp;&amp; ~isinf(MinPV) &amp;&amp; ~isnan(MaxPV) &amp;&amp; ~isnan(MinPV) &amp;&amp; (MaxPV-MinPV)~=0
3682     <span class="keyword">if</span> MaxPV &lt; MinPV
3683         fprintf(<span class="string">'   Maximum range must be greater than the minimum range.\n'</span>);
3684         MaxPV = get(handles.SetpointSlider, <span class="string">'Max'</span>);
3685         MinPV = get(handles.SetpointSlider, <span class="string">'Min'</span>);
3686         set(handles.SetpointMax, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,MaxPV));
3687         set(handles.SetpointMin, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,MinPV));
3688     <span class="keyword">else</span>
3689         StepSize = abs(str2num(get(handles.SetpointStepSize, <span class="string">'String'</span>))); <span class="comment">%#ok&lt;ST2NM&gt;</span>
3690         Range = abs(MaxPV-MinPV);
3691         <span class="keyword">if</span> isempty(StepSize) || ~isnumeric(StepSize)
3692             fprintf(<span class="string">'   Step size is not a numeric value.  Overwriting with the default step size.\n'</span>);
3693             StepSize = Range/1000;
3694         <span class="keyword">end</span>
3695         set(handles.SetpointStepSize, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,StepSize));
3696         Steps = Range/StepSize;
3697         <span class="keyword">if</span> Steps &lt; 10
3698             Steps = 10;
3699         <span class="keyword">end</span>
3700         set(handles.SetpointSlider, <span class="string">'Max'</span>, MaxPV);
3701         set(handles.SetpointSlider, <span class="string">'Min'</span>, MinPV);
3702         set(handles.SetpointSlider, <span class="string">'SliderStep'</span>, [1/Steps 10/Steps]);
3703         <span class="comment">%set(handles.SetpointSlider, 'SliderStep', [.001 .01]);</span>
3704 
3705         SP = get(handles.SetpointSlider, <span class="string">'UserData'</span>);
3706         set(handles.SetpointSlider,  <span class="string">'Value'</span>,  SP.Data);
3707         
3708         set(handles.SetpointSlider, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
3709     <span class="keyword">end</span>
3710 <span class="keyword">else</span>
3711     set(handles.SetpointSlider, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
3712 <span class="keyword">end</span>
3713 
3714 
3715 
3716 <span class="comment">% --------------------------------------------------------------------</span>
3717 <a name="_sub95" href="#_subfunctions" class="code">function SetpointSlider_Callback(hObject, eventdata, handles)</a>
3718 
3719 <span class="comment">% Get setpoint from the slider</span>
3720 NewSP = get(handles.SetpointSlider, <span class="string">'Value'</span>);
3721 
3722 SP = get(handles.SetpointSlider, <span class="string">'UserData'</span>);
3723 SP.Data = NewSP;
3724 
3725 <span class="comment">% Update Slider</span>
3726 set(handles.SetpointSlider, <span class="string">'UserData'</span>, SP);
3727 set(handles.SetpointSlider, <span class="string">'Value'</span>, NewSP);
3728 
3729 <span class="comment">% Update EditBox</span>
3730 set(handles.SetpointEditBox, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>, SP.Data));
3731 
3732 <span class="comment">% Make setpoint change</span>
3733 <a href="#_sub98" class="code" title="subfunction ChangeSetpointPlotfamily(hObject, eventdata, handles)">ChangeSetpointPlotfamily</a>(hObject, eventdata, handles);
3734 
3735 
3736 <span class="comment">% --------------------------------------------------------------------</span>
3737 <a name="_sub96" href="#_subfunctions" class="code">function SetpointEditBox_Callback(hObject, eventdata, handles)</a>
3738 
3739 <span class="comment">% Get setpoint from the editbox</span>
3740 ValueStr = get(handles.SetpointEditBox, <span class="string">'String'</span>);
3741 
3742 <span class="keyword">if</span> ~isempty(ValueStr)
3743     NewSP = str2num(ValueStr);
3744 
3745     SP = get(handles.SetpointSlider, <span class="string">'UserData'</span>);
3746     SP.Data = NewSP;
3747 
3748     <span class="comment">% Check range (if slider is enabled)</span>
3749     ChangeFlag = 1;
3750     <span class="keyword">if</span> strcmpi(get(handles.SetpointSlider,<span class="string">'Enable'</span>), <span class="string">'On'</span>)
3751         MaxPV = str2num(get(handles.SetpointMax,<span class="string">'String'</span>));
3752         MinPV = str2num(get(handles.SetpointMin,<span class="string">'String'</span>));
3753         <span class="keyword">if</span> isnumeric(MaxPV) &amp;&amp; isnumeric(MinPV) &amp;&amp; ~isinf(MaxPV) &amp;&amp; ~isinf(MinPV) &amp;&amp; ~isnan(MaxPV) &amp;&amp; ~isnan(MinPV)
3754             <span class="keyword">if</span> MaxPV &lt; NewSP  || NewSP &lt; MinPV
3755                 fprintf(<span class="string">'   The requested setpoint is outside the limits.  Requested cancelled.\n'</span>);
3756                 ChangeFlag = 0;
3757                 OldSP = get(handles.SetpointSlider, <span class="string">'Value'</span>);
3758                 set(handles.SetpointEditBox, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,OldSP));
3759             <span class="keyword">end</span>
3760         <span class="keyword">end</span>
3761     <span class="keyword">end</span>
3762 
3763     <span class="comment">% Update Slider</span>
3764     <span class="keyword">if</span> ChangeFlag
3765         set(handles.SetpointSlider, <span class="string">'UserData'</span>, SP);
3766 
3767         <span class="comment">% Don't change the slider if it's not enabled</span>
3768         <span class="keyword">if</span> strcmpi(get(handles.SetpointSlider,<span class="string">'Enable'</span>), <span class="string">'On'</span>)
3769             set(handles.SetpointSlider, <span class="string">'Value'</span>, NewSP);
3770         <span class="keyword">end</span>
3771 
3772         <span class="comment">% Make setpoint change</span>
3773         <a href="#_sub98" class="code" title="subfunction ChangeSetpointPlotfamily(hObject, eventdata, handles)">ChangeSetpointPlotfamily</a>(hObject, eventdata, handles);
3774     <span class="keyword">end</span>
3775 <span class="keyword">end</span>
3776 
3777 
3778 <span class="comment">% --------------------------------------------------------------------</span>
3779 <a name="_sub97" href="#_subfunctions" class="code">function SetpointPushButton_Callback(hObject, eventdata, handles)</a>
3780 
3781 <span class="comment">% Get setpoint from the pushbutton</span>
3782 SP = get(handles.SetpointPushButton, <span class="string">'UserData'</span>);
3783 
3784 <span class="comment">% Update Slider if it's enabled</span>
3785 <span class="keyword">if</span> strcmpi(get(handles.SetpointSlider,<span class="string">'Enable'</span>), <span class="string">'On'</span>)
3786     set(handles.SetpointSlider, <span class="string">'Value'</span>, SP.Data);
3787 <span class="keyword">end</span>
3788 
3789 <span class="comment">% Store the setpoint change and update the editbox</span>
3790 set(handles.SetpointSlider, <span class="string">'UserData'</span>, SP);
3791 set(handles.SetpointEditBox, <span class="string">'String'</span>, sprintf(<span class="string">'%f'</span>,SP.Data));
3792 
3793 <span class="comment">% Make setpoint change</span>
3794 <a href="#_sub98" class="code" title="subfunction ChangeSetpointPlotfamily(hObject, eventdata, handles)">ChangeSetpointPlotfamily</a>(hObject, eventdata, handles);
3795 
3796 
3797 <span class="comment">% --------------------------------------------------------------------</span>
3798 <a name="_sub98" href="#_subfunctions" class="code">function ChangeSetpointPlotfamily(hObject, eventdata, handles)</a>
3799 
3800 SP = get(handles.SetpointSlider, <span class="string">'UserData'</span>);
3801 
3802 <span class="comment">% Get the present mode (units are stored with the data)</span>
3803 <span class="keyword">if</span> strcmpi(get(handles.Simulate,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3804     Mode = <span class="string">'Simulator'</span>;
3805 <span class="keyword">else</span>
3806     Mode = <span class="string">'Online'</span>;
3807 <span class="keyword">end</span>
3808 
3809 
3810 <span class="comment">% Make the setpoint change</span>
3811 setpv(SP, 0, Mode);
3812 
3813 <span class="comment">% Update plots</span>
3814 <a href="#_sub8" class="code" title="subfunction OneShot_Callback(hObject, eventdata, handles)">OneShot_Callback</a>(hObject, eventdata, handles);
3815 
3816 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_BetaX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3817     <a href="#_sub60" class="code" title="subfunction AddPlot_Beta_Callback(hObject, eventdata, handles)">AddPlot_Beta_Callback</a>(handles.AddPlot1_BetaX, eventdata, handles);
3818 <span class="keyword">end</span>
3819 <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_BetaX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3820     <a href="#_sub60" class="code" title="subfunction AddPlot_Beta_Callback(hObject, eventdata, handles)">AddPlot_Beta_Callback</a>(handles.AddPlot2_BetaX, eventdata, handles);
3821 <span class="keyword">end</span>
3822 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_BetaY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3823     <a href="#_sub60" class="code" title="subfunction AddPlot_Beta_Callback(hObject, eventdata, handles)">AddPlot_Beta_Callback</a>(handles.AddPlot1_BetaY, eventdata, handles);
3824 <span class="keyword">end</span>
3825 <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_BetaY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3826     <a href="#_sub60" class="code" title="subfunction AddPlot_Beta_Callback(hObject, eventdata, handles)">AddPlot_Beta_Callback</a>(handles.AddPlot2_BetaY, eventdata, handles);
3827 <span class="keyword">end</span>
3828 
3829 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_DispX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3830     <a href="#_sub61" class="code" title="subfunction AddPlot_Dispersion_Callback(hObject, eventdata, handles)">AddPlot_Dispersion_Callback</a>(handles.AddPlot1_DispX, eventdata, handles);
3831 <span class="keyword">end</span>
3832 <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_DispX,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3833     <a href="#_sub61" class="code" title="subfunction AddPlot_Dispersion_Callback(hObject, eventdata, handles)">AddPlot_Dispersion_Callback</a>(handles.AddPlot2_DispX, eventdata, handles);
3834 <span class="keyword">end</span>
3835 <span class="keyword">if</span> strcmpi(get(handles.AddPlot1_DispY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3836     <a href="#_sub61" class="code" title="subfunction AddPlot_Dispersion_Callback(hObject, eventdata, handles)">AddPlot_Dispersion_Callback</a>(handles.AddPlot1_DispY, eventdata, handles);
3837 <span class="keyword">end</span>
3838 <span class="keyword">if</span> strcmpi(get(handles.AddPlot2_DispY,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
3839     <a href="#_sub61" class="code" title="subfunction AddPlot_Dispersion_Callback(hObject, eventdata, handles)">AddPlot_Dispersion_Callback</a>(handles.AddPlot2_DispY, eventdata, handles);
3840 <span class="keyword">end</span>
3841 
3842 
3843</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:35:27 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>