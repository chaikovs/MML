<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fmap_soleilnu</title>
  <meta name="keywords" content="fmap_soleilnu">
  <meta name="description" content="function [nux,nuy]=sim_fmap_at_naff_diffu_3sb(nxmin,nxmax,nx,nymin,nymax,ny,ax,ay)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../../../index.html">Home</a> &gt;  <a href="#">machine</a> &gt; <a href="#">Soleil</a> &gt; <a href="../../index.html">common</a> &gt; <a href="#">naff</a> &gt; <a href="index.html">naffutils</a> &gt; fmap_soleilnu.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../../../index.html"><img alt="<" border="0" src="../../../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for machine/Soleil/common/naff/naffutils&nbsp;<img alt=">" border="0" src="../../../../../right.png"></a></td></tr></table>-->

<h1>fmap_soleilnu
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [nux,nuy]=sim_fmap_at_naff_diffu_3sb(nxmin,nxmax,nx,nymin,nymax,ny,ax,ay)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="box"><strong>function [nux,nuy,diffu]=fmap_soleilnu(nx,ny,ax,ay) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> function [nux,nuy]=sim_fmap_at_naff_diffu_3sb(nxmin,nxmax,nx,nymin,nymax,ny,ax,ay)

 simulates a frequency map using the tracking
 routine's out of Andrei Terebilos ATtoolbox and
 Jacques Laskars NAFF algorithm 
 (calcnaff.mex or calcnaff.dll)

 nux, nuy         are the returned betatron tune values
 diffu            is the returned diffusion rate

 nx        number of horizontal amplitudes
 ny        number of vertical amplitudes
 ax        maximum horizontal amplitude [mm]
 ay        maximum vertical amplitude [mm]

 Laurent Nadolski, ALS 09/01/02</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [nux,nuy,diffu]=fmap_soleilnu(nx,ny,ax,ay)</a>
0002 <span class="comment">% function [nux,nuy]=sim_fmap_at_naff_diffu_3sb(nxmin,nxmax,nx,nymin,nymax,ny,ax,ay)</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% simulates a frequency map using the tracking</span>
0005 <span class="comment">% routine's out of Andrei Terebilos ATtoolbox and</span>
0006 <span class="comment">% Jacques Laskars NAFF algorithm</span>
0007 <span class="comment">% (calcnaff.mex or calcnaff.dll)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% nux, nuy         are the returned betatron tune values</span>
0010 <span class="comment">% diffu            is the returned diffusion rate</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% nx        number of horizontal amplitudes</span>
0013 <span class="comment">% ny        number of vertical amplitudes</span>
0014 <span class="comment">% ax        maximum horizontal amplitude [mm]</span>
0015 <span class="comment">% ay        maximum vertical amplitude [mm]</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Laurent Nadolski, ALS 09/01/02</span>
0018 
0019 pathold = path;
0020 
0021 <span class="keyword">if</span> (~findstr(pathold,<span class="string">'matlab\at\accelerator\simulator\element'</span>))
0022     atinit;
0023 <span class="keyword">end</span>
0024 
0025 soleilnu
0026 radiationoff;
0027 cavityoff;
0028 
0029 
0030 <span class="comment">%FitTune2([.25,.2],'QF','QD');</span>
0031 <span class="comment">%FitChrom2([0.4,1.4],'SF','SD');</span>
0032 <span class="comment">%FitTune2([.25,.2],'QF','QD');</span>
0033 
0034 plotbeta;
0035 
0036 <span class="comment">% [closeOrb] = findorbit6(THERING);</span>
0037 <span class="comment">% closeOrb</span>
0038 
0039 fprintf(<span class="string">'Type any key to continue ...\n'</span>);
0040 pause;
0041 
0042 NT = 1024;
0043 
0044 T = ringpass(THERING,[0;0;0;0;0;0],1);
0045 
0046 <span class="keyword">for</span> i=1:nx
0047     ampx = ax*sqrt(i/nx);
0048     
0049     <span class="keyword">for</span> j=1:ny
0050         ampy = ay*sqrt(j/ny);
0051         sampx = int2str(ampx);
0052         sampy = int2str(ampy);
0053         
0054         fprintf(<span class="string">'amp_x=%g mm, amp_y=%g mm\n'</span>,ampx,ampy);
0055         
0056         X0=[ampx/1000 0 ampy/1000 0 0 0]';
0057         
0058         clear LOSSFLAG;
0059         cpustart=cputime;
0060         T = ringpass(THERING,X0,NT,<span class="string">'reuse'</span>);
0061         cpustop=cputime;
0062         fprintf(<span class="string">'track time for 1024 turns : %g s\n'</span>,cpustop-cpustart);
0063         
0064         
0065         Tx = T(1,:);
0066         Txp = T(2,:);
0067         Ty = T(3,:);
0068         Typ = T(4,:);
0069         TE = T(5,:);
0070         Tphi = T(6,:);
0071         
0072         <span class="keyword">if</span> (length(Ty)==1024) &amp; (all(Ty&lt;0.004)) <span class="keyword">...</span>
0073                 &amp; (~any(isnan(Ty))) &amp; (LOSSFLAG==0)
0074             
0075             cpustart=cputime;
0076             [tmpnux1]=abs(calcnaff(Tx(1:512),Txp(1:512),1)/(2*pi));
0077             [tmpnuy1]=abs(calcnaff(Ty(1:512),Typ(1:512),1)/(2*pi));
0078             [tmpnux2]=abs(calcnaff(Tx(513:1024),Txp(513:1024),1)/(2*pi));
0079             [tmpnuy2]=abs(calcnaff(Ty(513:1024),Typ(513:1024),1)/(2*pi));
0080             
0081             cpustop=cputime;
0082             fprintf(<span class="string">'NAFF CPU time (4*512 turns) : %g s\n'</span>,cpustop-cpustart);
0083             
0084             
0085             nux(i,j)=0.0; nuy(i,j) = 0.0;
0086             pampx(i,j)=-1;pampy(i,j)=-1;
0087             
0088 
0089      pampx(i,j)=ampx;
0090      pampy(i,j)=ampy;
0091     <span class="keyword">if</span> ((abs(tmpnuy1(1))&gt;0.001) &amp; (abs(tmpnuy1(1)-tmpnux1(1))&gt;0.001))
0092      nuy(i,j)=tmpnuy1(1);
0093       <span class="keyword">else</span>
0094      nuy(i,j)=tmpnuy1(2);
0095       <span class="keyword">end</span>         
0096     
0097       <span class="keyword">if</span> (abs(tmpnux1(1))&gt;0.001)
0098      nux(i,j)=tmpnux1(1);
0099       <span class="keyword">else</span>
0100      nux(i,j)=tmpnux1(2);
0101       <span class="keyword">end</span>            
0102 
0103      <span class="keyword">if</span> ((abs(tmpnuy2(1))&gt;0.001) &amp; (abs(tmpnuy2(1)-tmpnux2(1))&gt;0.001))
0104      nuy(i,j)=tmpnuy2(1);
0105       <span class="keyword">else</span>
0106      nuy(i,j)=tmpnuy2(2);
0107       <span class="keyword">end</span>         
0108     
0109       <span class="keyword">if</span> (abs(tmpnux2(1))&gt;0.001)
0110      nux(i,j)=tmpnux2(1);
0111       <span class="keyword">else</span>
0112      nux(i,j)=tmpnux2(2);
0113       <span class="keyword">end</span>            
0114             
0115            
0116             <span class="keyword">if</span> (length(tmpnuy2)==1) &amp; (length(tmpnux2)==1) &amp; (length(nux(i,j))==1) &amp; (length(nuy(i,j))==1)
0117                 diffu(i,j)=log10(sqrt((tmpnuy2-nuy(i,j))^2+(tmpnux2-nux(i,j))^2)/512);
0118             <span class="keyword">else</span>
0119                 diffu(i,j) = -3;
0120             <span class="keyword">end</span>
0121             
0122             <span class="keyword">if</span> (diffu(i,j) &lt; (-10))
0123                 diffu(i,j) = -10;
0124             <span class="keyword">end</span>
0125             
0126             taxi = ax*sqrt(i/nx);
0127             taxii = ax*sqrt((i-1)/nx);
0128             tayj = ay*sqrt(j/ny);
0129             tayjj = ay*sqrt((j-1)/ny);
0130             
0131             <span class="keyword">if</span> (i&gt;1) &amp; (j&gt;1)
0132                 xpos(:,(i-1)*(ny)+j) = [taxii;taxii;taxi;taxi];
0133                 ypos(:,(i-1)*(ny)+j) = [tayjj;tayj;tayj;tayjj];
0134             <span class="keyword">elseif</span> (i&gt;1)
0135                 xpos(:,(i-1)*(ny)+j) = [taxii;taxii;taxi;taxi];
0136                 ypos(:,(i-1)*(ny)+j) = [0;tayj;tayj;0];    
0137             <span class="keyword">elseif</span> (j&gt;1)    
0138                 xpos(:,(i-1)*(ny)+j) = [0;0;taxi;taxi];
0139                 ypos(:,(i-1)*(ny)+j) = [tayjj;tayj;tayj;tayjj];
0140             <span class="keyword">else</span>
0141                 xpos(:,(i-1)*(ny)+j) = [0;0;taxi;taxi];
0142                 ypos(:,(i-1)*(ny)+j) = [0;tayj;tayj;0];
0143             <span class="keyword">end</span>        
0144             
0145             nuxpos(:,(i-1)*(ny)+j) = <span class="keyword">...</span>
0146                 [nux(i,j)-.0001;nux(i,j)-.0001;nux(i,j)+.0001;nux(i,j)+.0001];
0147             nuypos(:,(i-1)*(ny)+j) = <span class="keyword">...</span>
0148                 [nuy(i,j)-.0006;nuy(i,j)+.0006;nuy(i,j)+.0006;nuy(i,j)-.0006];
0149             
0150             diffuvec(1:4,(i-1)*(ny)+j) = diffu(i,j);
0151             
0152             
0153         <span class="keyword">else</span>
0154             nux(i,j)=0.0; nuy(i,j)=0.0;
0155             pampx(i,j)=-1;pampy(i,j)=-1;
0156             xpos(:,(i-1)*(ny)+j) = [0;0;0;0];            
0157             ypos(:,(i-1)*(ny)+j) = [0;0;0;0];            
0158             nuxpos(:,(i-1)*(ny)+j) = [0;0;0;0];
0159             nuypos(:,(i-1)*(ny)+j) = [0;0;0;0];
0160             diffu(i,j)=-10;
0161             diffuvec(1:4,(i-1)*(ny)+j) = [-10;-10;-10;-10];
0162         <span class="keyword">end</span>
0163         
0164         <span class="keyword">if</span> nux(i,j) &amp; nuy(i,j)
0165             fprintf(<span class="string">'nu_x=%g, nu_y=%g\n'</span>,14+nux(i,j),8+nuy(i,j));
0166         <span class="keyword">else</span>
0167             fprintf(<span class="string">'particle lost\n'</span>);
0168         <span class="keyword">end</span>
0169         
0170     <span class="keyword">end</span>
0171     
0172     save <span class="string">'freqmap_new'</span> nux nuy diffu nuxpos nuypos xpos ypos diffuvec pampx pampy
0173     
0174 <span class="keyword">end</span>
0175 
0176 f1=figure;
0177 plot(18+nux,10+nuy,<span class="string">'b.'</span>);
0178 axis([18.2 18.5 10.0 10.5]);
0179 title(<span class="string">'ALS lattice, calculated frequency map (NAFF)'</span>);
0180 xlabel(<span class="string">'\nu_x'</span>);
0181 ylabel(<span class="string">'\nu_y'</span>);
0182 pause(0.1);
0183 
0184 <span class="keyword">if</span> min(size(diffu)) &gt; 1
0185     
0186     figure;
0187     fill(xpos,ypos,diffuvec);
0188     axis([0 ax 0 ay]);
0189     caxis([-10 -3]);
0190     hold on;
0191     shading flat;
0192     colormap(<span class="string">'jet'</span>);
0193     colorbar;
0194     title(<span class="string">'ALS lattice, calculated frequency map (NAFF), 3SB, \eta_x = 6cm, \eta_y(ID6) = 4cm'</span>);
0195     xlabel(<span class="string">'x position [mm] (injection straight)'</span>);
0196     ylabel(<span class="string">'y position [mm]'</span>);
0197     hold off;
0198     
0199     figure;
0200     fill(18+nuxpos,10+nuypos,diffuvec);
0201     axis([18.2 18.5 10.0 10.5]);
0202     caxis([-10 -3]);
0203     hold on;
0204     shading flat;
0205     colormap(<span class="string">'jet'</span>);
0206     colorbar;
0207     title(<span class="string">'ALS lattice, calculated frequency map (NAFF)'</span>);
0208     xlabel(<span class="string">'\nu_x'</span>);
0209     ylabel(<span class="string">'\nu_y'</span>);
0210     hold off;
0211     
0212 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:35:27 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>