<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calctuneTFB</title>
  <meta name="keywords" content="calctuneTFB">
  <meta name="description" content="T=timer('TimerFcn',@gettune_FBT, 'Period', 1.0);">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">machine</a> &gt; <a href="#">Soleil</a> &gt; <a href="index.html">StorageRing</a> &gt; calctuneTFB.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for machine/Soleil/StorageRing&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>calctuneTFB
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>T=timer('TimerFcn',@gettune_FBT, 'Period', 1.0);</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function calctuneTFB(action) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> T=timer('TimerFcn',@gettune_FBT, 'Period', 1.0);
%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = local_gettune_FBT</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function calctuneTFB(action)</a>
0002 <span class="comment">% T=timer('TimerFcn',@gettune_FBT, 'Period', 1.0);</span>
0003 <span class="comment">%%</span>
0004 
0005 StartFlag = 0;
0006 <span class="comment">%setappdata(h,'FEEDBACK_STOP_FLAG',0)</span>
0007 
0008 <span class="comment">% Devicelock configuration</span>
0009 devLockName = <span class="string">'ANS/CA/SERVICE-LOCKER'</span>;
0010 argin.svalue={<span class="string">'tunemeas'</span>};
0011 
0012 <span class="comment">% Arguments</span>
0013 <span class="keyword">if</span> nargin &lt; 1
0014     action = <span class="string">'Initialize'</span>;
0015 <span class="keyword">end</span>
0016 
0017 <span class="keyword">switch</span> action
0018     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0019         val = readattribute([devLockName <span class="string">'/'</span> argin.svalue{:}]);
0020 
0021         <span class="keyword">if</span> val == 1
0022             fprintf(<span class="string">'Tune measurement already running. Stop other application first!\n'</span>)
0023             <span class="keyword">return</span>;
0024         <span class="keyword">end</span>
0025 
0026         ButtonHeight = 50;
0027         ButtonWidth=50;
0028         offset = 100;
0029 
0030         h=figure(<span class="string">'Tag'</span>, <span class="string">'TuneFig'</span>);
0031         uicontrol(<span class="string">'Parent'</span>,h, <span class="keyword">...</span>
0032             <span class="string">'callback'</span>,<span class="string">'calctuneTFB(''Start'');'</span>, <span class="keyword">...</span>
0033             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0034             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0035             <span class="string">'Position'</span>,[2 offset+2*(ButtonHeight+1) ButtonWidth 0.8*ButtonHeight], <span class="keyword">...</span>
0036             <span class="string">'String'</span>,<span class="string">'Start'</span>, <span class="keyword">...</span>
0037             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0038             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0039             <span class="string">'Tag'</span>,<span class="string">'Start'</span>);
0040 
0041         uicontrol(<span class="string">'Parent'</span>,h, <span class="keyword">...</span>
0042             <span class="string">'callback'</span>,<span class="string">'calctuneTFB(''Stop'');'</span>, <span class="keyword">...</span>
0043             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0044             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0045             <span class="string">'Position'</span>,[2 offset+1*(ButtonHeight+1) ButtonWidth 0.8*ButtonHeight], <span class="keyword">...</span>
0046             <span class="string">'String'</span>,<span class="string">'Stop'</span>, <span class="keyword">...</span>
0047             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0048             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0049             <span class="string">'Tag'</span>,<span class="string">'Stop'</span>);
0050 
0051         <span class="comment">%%</span>
0052         <span class="comment">% Locktag  = tango_command_inout2(devLockName,'Lock', argin.svalue{:});</span>
0053         <span class="comment">% argin.lvalue = int32(Locktag);</span>
0054 
0055         <span class="comment">% Get data</span>
0056         [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = <a href="#_sub1" class="code" title="subfunction [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = local_gettune_FBT">local_gettune_FBT</a>;
0057 
0058         len1= length(dataFFT1);
0059         len2= length(dataFFT2);
0060 
0061         subplot(2,1,1);
0062         xdata1 = (0:len1-1)/len1;
0063         setappdata(h,<span class="string">'xdata1'</span>, xdata1);
0064 
0065         H1 = num2str(xdata1(idx1-1+5),<span class="string">'%6.4f'</span>);
0066         <span class="comment">%H1_var = xdata1(idx1-1+5);</span>
0067         V1 = num2str(xdata1(idx2-1+floor(len1/4)),<span class="string">'%6.4f'</span>);
0068         f1 = semilogy(xdata1, dataFFT1, <span class="string">'Tag'</span>, <span class="string">'ydata1'</span>);
0069         title (<span class="string">'FBT1'</span>);
0070         xlim([0 0.5])
0071         setappdata(h,<span class="string">'yaxis1'</span>, f1);
0072 
0073         subplot(2,1,2);
0074         xdata2 = (0:len2-1)/len2;
0075         setappdata(h,<span class="string">'xdata2'</span>, xdata2);
0076         H2 =  num2str(xdata2(idx3-1+5),<span class="string">'%6.4f'</span>);
0077         V2 =  xdata2(idx4-1+floor(len2/4));
0078         f2 = semilogy(xdata2, (dataFFT2),<span class="string">'Tag'</span>, <span class="string">'ydata1'</span>);
0079         title (<span class="string">'FBT2'</span>);
0080         xlim([0 0.5])
0081         setappdata(h,<span class="string">'yaxis2'</span>, f2);
0082 
0083         anno1 = annotation(<span class="string">'textbox'</span>,<span class="keyword">...</span>
0084             <span class="string">'Position'</span>,[0.14 0.83 0.12 0.08],<span class="keyword">...</span>
0085             <span class="string">'FitHeightToText'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
0086             <span class="string">'String'</span>,{H1}, <span class="string">'Tag'</span>, <span class="string">'box1'</span>);
0087         setappdata(h,<span class="string">'anno1'</span>, anno1);
0088 
0089         anno2 = annotation(<span class="string">'textbox'</span>,<span class="keyword">...</span>
0090             <span class="string">'Position'</span>,[0.14 0.35 0.12 0.08],<span class="keyword">...</span>
0091             <span class="string">'FitHeightToText'</span>,<span class="string">'off'</span>,<span class="keyword">...</span>
0092             <span class="string">'String'</span>,{H2}, <span class="string">'Tag'</span>, <span class="string">'box2'</span>);
0093         setappdata(h,<span class="string">'anno2'</span>, anno2);
0094 
0095     <span class="keyword">case</span> <span class="string">'Start'</span>
0096         setappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'FEEDBACK_STOP_FLAG'</span>,0);
0097         Locktag  = tango_command_inout2(devLockName,<span class="string">'Lock'</span>, argin.svalue{:});
0098         argin.lvalue = int32(Locktag);
0099         setappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'Locktag'</span>,Locktag);
0100 
0101         <span class="comment">% loop</span>
0102         <span class="keyword">while</span> ~getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'FEEDBACK_STOP_FLAG'</span>)
0103 
0104             [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = <a href="#_sub1" class="code" title="subfunction [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = local_gettune_FBT">local_gettune_FBT</a>;
0105             xdata1 = getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'xdata1'</span>);
0106             xdata2 = getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'xdata2'</span>);
0107             len1 = length(xdata1);
0108             len2 = length(xdata2);
0109 
0110             <span class="keyword">if</span> idx1 ~= -1
0111                 tunex1 = xdata1(idx1-1+5);
0112                 tunez1 = xdata1(idx2-1+floor(len1/4));
0113                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'anno1'</span>),<span class="string">'String'</span>,<span class="string">' '</span>);
0114                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'anno1'</span>),<span class="string">'String'</span>, <span class="keyword">...</span>
0115                     sprintf(<span class="string">'H = %5.4f \nV = %5.4f'</span>, tunex1, tunez1))
0116                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'yaxis1'</span>), <span class="string">'Ydata'</span>, dataFFT1)
0117                 tango_write_attribute2(<span class="string">'ANS/DG/PUB-TUNE'</span>,<span class="string">'tunex'</span>,tunex1);
0118                 tango_write_attribute2(<span class="string">'ANS/DG/PUB-TUNE'</span>,<span class="string">'tunez'</span>,tunez1);
0119             <span class="keyword">end</span>
0120             <span class="keyword">if</span> idx2 ~= -1
0121                 tunex2 = xdata2(idx3-1+5);
0122                 tunez2 = xdata2(idx4-1+floor(len2/4));
0123                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'anno2'</span>),<span class="string">'String'</span>,<span class="string">' '</span>);
0124                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'anno2'</span>), <span class="keyword">...</span>
0125                     <span class="string">'String'</span>,sprintf(<span class="string">'H = %5.4f \nV = %5.4f'</span>, tunex2, tunez2))
0126                 set(getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'yaxis2'</span>), <span class="string">'Ydata'</span>, dataFFT2)
0127                 tango_write_attribute2(<span class="string">'ANS/DG/PUB-TUNE'</span>,<span class="string">'tunex2'</span>,tunex2);
0128                 tango_write_attribute2(<span class="string">'ANS/DG/PUB-TUNE'</span>,<span class="string">'tunez2'</span>,tunez2);
0129             <span class="keyword">end</span>
0130             pause(0.5);
0131             <span class="comment">% Maintain lock on SOFB service</span>
0132             tango_command_inout2(devLockName,<span class="string">'MaintainLock'</span>, argin);
0133         <span class="keyword">end</span>
0134 
0135     <span class="keyword">case</span> <span class="string">'Stop'</span>
0136         <span class="comment">% Unlock SOFB service</span>
0137         Locktag = getappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'Locktag'</span>);
0138         argin.lvalue=int32(Locktag);
0139         tango_command_inout2(devLockName,<span class="string">'Unlock'</span>, argin);
0140         setappdata(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'TuneFig'</span>),<span class="string">'FEEDBACK_STOP_FLAG'</span>, 1);
0141 <span class="keyword">end</span>
0142 
0143 
0144 <span class="comment">% while(1)</span>
0145 <span class="comment">%     [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = local_gettune_FBT;</span>
0146 <span class="comment">%     if idx1 ~= -1</span>
0147 <span class="comment">%         tunex1 = xdata1(idx1-1+5);</span>
0148 <span class="comment">%         tunez1 = xdata1(idx2-1+floor(len1/4));</span>
0149 <span class="comment">%         set(anno1,'String',' ');</span>
0150 <span class="comment">%         set(anno1,'String',sprintf('H = %5.4f \nV = %5.4f', tunex1, tunez1))</span>
0151 <span class="comment">%         set(f1, 'Ydata', dataFFT1)</span>
0152 <span class="comment">%         tango_write_attribute2('ANS/DG/PUB-TUNE','tunex',tunex1);</span>
0153 <span class="comment">%         tango_write_attribute2('ANS/DG/PUB-TUNE','tunez',tunez1);</span>
0154 <span class="comment">%     end</span>
0155 <span class="comment">%     if idx2 ~= -1</span>
0156 <span class="comment">%         tunex2 = xdata2(idx3-1+5);</span>
0157 <span class="comment">%         tunez2 = xdata2(idx4-1+floor(len2/4));</span>
0158 <span class="comment">%         set(anno2,'String',' ');</span>
0159 <span class="comment">%         set(anno2,'String',sprintf('H = %5.4f \nV = %5.4f', tunex2, tunez2))</span>
0160 <span class="comment">%         set(f2, 'Ydata', dataFFT2)</span>
0161 <span class="comment">%         tango_write_attribute2('ANS/DG/PUB-TUNE','tunex2',tunex2);</span>
0162 <span class="comment">%         tango_write_attribute2('ANS/DG/PUB-TUNE','tunez2',tunez2);</span>
0163 <span class="comment">%     end</span>
0164 <span class="comment">%     pause(0.5);</span>
0165 <span class="comment">%     % Maintain lock on SOFB service</span>
0166 <span class="comment">%     tango_command_inout2(devLockName,'MaintainLock', argin);</span>
0167 <span class="comment">% end</span>
0168 
0169 
0170 <span class="comment">%subfunctions</span>
0171 
0172 <a name="_sub1" href="#_subfunctions" class="code">function [idx1 idx2 idx3 idx4 dataFFT1 dataFFT2] = local_gettune_FBT</a>
0173 
0174 rep1 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'excitedBunchData'</span>);
0175 <span class="keyword">if</span> ~isstruct(rep1) &amp;&amp; rep1 == -1
0176     pause(1)
0177     rep1 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'excitedBunchData'</span>);
0178     <span class="keyword">if</span> ~isstruct(rep1) &amp;&amp; rep1 == -1
0179         pause(2)
0180         rep1 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'excitedBunchData'</span>);
0181     <span class="keyword">else</span>
0182         rep1 = -1;
0183     <span class="keyword">end</span>
0184 <span class="keyword">end</span>
0185 
0186 rep2 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'selectedBunchData'</span>);
0187 <span class="comment">%rep2 = tango_read_attribute2('ANS/RF/BBFDataViewer.2', 'excitedBunchData');</span>
0188 <span class="keyword">if</span> ~isstruct(rep2) &amp;&amp; rep2 == -1
0189     pause(1)
0190     rep2 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'selectedBunchData'</span>);
0191     <span class="comment">%rep2 = tango_read_attribute2('ANS/RF/BBFDataViewer.2', 'excitedBunchData');</span>
0192     <span class="keyword">if</span> ~isstruct(rep2) &amp;&amp; rep2 == -1
0193 
0194         pause(2)
0195         rep2 = tango_read_attribute2(<span class="string">'ANS/RF/BBFDataViewer.1'</span>, <span class="string">'selectedBunchData'</span>);
0196         <span class="comment">%rep2 = tango_read_attribute2('ANS/RF/BBFDataViewer.2', 'excitedBunchData');</span>
0197     <span class="keyword">else</span>
0198         rep2 = -1;
0199     <span class="keyword">end</span>
0200 <span class="keyword">end</span>
0201 
0202 <span class="keyword">if</span> isstruct(rep1)
0203     data1 = double(rep1.value);
0204     dataFFT1 = abs(fft(data1));
0205     len1 = length(dataFFT1);
0206     [MNO1_h,idx1] = max (dataFFT1(5:floor(len1/4)));
0207     [MNO1_v,idx2] = max (dataFFT1(floor(len1/4):floor(len1/2)));
0208 <span class="keyword">else</span>
0209     idx1 = -1;
0210     idx2 = -1;
0211     dataFFT1 = 0;
0212 <span class="keyword">end</span>
0213 
0214 <span class="keyword">if</span> isstruct(rep2)
0215     data2 = double(rep2.value);
0216     dataFFT2 = abs(fft(data2));
0217 
0218     len2 = length(dataFFT2);
0219     [MNO2_h,idx3] = max (dataFFT2(5:floor(len2/4)));
0220     [MNO2_v,idx4] = max (dataFFT2(floor(len2/4):floor(len2/2)));
0221 <span class="keyword">else</span>
0222     idx3 = -1;
0223     idx4 = -1;
0224     dataFFT2 = 0;
0225 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 23-Jul-2010 00:42:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>