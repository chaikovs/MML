<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of measrespmat</title>
  <meta name="keywords" content="measrespmat">
  <meta name="description" content="MEASRESPMAT - Measure a response matrix">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; measrespmat.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>measrespmat
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>MEASRESPMAT - Measure a response matrix</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function S = measrespmat(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">MEASRESPMAT - Measure a response matrix

  For family name, device list inputs:
  S = measrespmat(MonitorFamily, MonitorDeviceList, ActuatorFamily, ActuatorDeviceList, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)

  For data structure inputs: 
  S = measrespmat(MonitorStruct, ActuatorStruct, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)

  INPUTS
  1. MonitorFamily       - AcceleratorObjects family name for monitors
     MonitorDeviceList   - AcceleratorObjects device list for monitors (element or device)
                           (MonitorFamily and MonitorDeviceList can be cell arrays)
     or 
     MonitorStruct can replace MonitorFamily and MonitorDeviceList

  2. ActuatorFamily      - AcceleratorObjects family name for actuators
     ActuatorDeviceList  - AcceleratorObjects device list for actuators (element or device)
     or 
     ActuatorStruct can replace ActuatorFamily and ActuatorDeviceList

  3. ActuatorDelta    - Change in actuator {Default: getfamilydata('ActuatorFamily','Setpoint','DeltaRespMat')}
  4. ModulationMethod - Method for changing the ActuatorFamily
                       'bipolar' changes the ActuatorFamily by +/- ActuatorDelta/2 on each step {Default}
                       'unipolar' changes the ActuatorFamily from 0 to ActuatorDelta on each step
  5. WaitFlag - (see setpv for WaitFlag definitions) {Default: []}
                WaitFlag = -5 will override gets to manual mode

  6. ExtraDelay - Extra time delay [seconds] after a setpoint change

  7. 'Struct'  - Output will be a response matrix structure {Default for data structure inputs}
     'Numeric' - Output will be a numeric matrix            {Default for non-data structure inputs}

  8. Optional override of the units:
     'Physics'  - Use physics  units
     'Hardware' - Use hardware units

  9. Optional override of the mode:
     'Online' - Set/Get data online  
     'Model'  - Set/Get data on the model (same as 'Simulator')
     'Manual' - Set/Get data manually

  10. 'Display'    - Prints status information to the command window {Default}
      'NoDisplay'  - Nothing is printed to the command window

  11. 'MinimumBeamCurrent' - Minimum beam current before prompting for a refill
                             The current (as returned by getdcct) must follow the flag. 
                             measbpmresp('MinimumBeamCurrent', 32.1) 
                             will pause at a beam current of 32.1 and prompt for a refill.

  OUTPUTS
  1. S = Response matrix

     For stucture outputs:
     S(Monitor, Actuator).Data - Response matrix
                         .Monitor - Monitor data structure (starting orbit)
                         .Monitor1 - First  data point matrix
                         .Monitor2 - Second data point matrix
                         .Actuator - Corrector data structure
                         .ActuatorDelta - Corrector kick vector
                         .GeV - Electron beam energy
                         .ModulationMethod - 'unipolar' or 'bipolar'
                         .WaitFlag - Wait flag used when acquiring data
                         .ExtraDelay - Extra time delay 
                         .TimeStamp - Matlab clock at the start of each actuator family
                         .CreatedBy
                         .DCCT

  NOTES
  1. If MonitorFamily and MonitorDeviceList are cell arrrays, then S is a cell array of response matrices.
  2. ActuatorFamily, ActuatorDeviceList, ActuatorDelta, ModulationMethod, WaitFlag are not cell arrrays.
  3. If ActuatorDeviceList is empty, then the entire family is change together.
  4. Bipolar mode changes the actuator by +/- ActuatorDelta/2
  5. Unipolar mode changes the actuator by ActuatorDelta
  6. Return values are MonitorChange/ActuatorDelta (normalized)
  7. When using cell array inputs don't mix structure data inputs with non-structure data

  EXAMPLES
  1. 2x2 tune response matrix for Q7 and Q9 families (delay for tune matrix will need to be adjusted):
     TuneRmatrix = [measrespmat('TUNE',[1;2],'Q7',[],.5,'unipolar') ... 
                    measrespmat('TUNE',[1;2],'Q9',[],.5,'unipolar')];

  2. Orbit response matrix for all the horizontal correctors (+/-1 amp kick amplitude):
     Smat = measrespmat({'BPMx','BPMz'}, {getlist('BPMx'),getlist('BPMz')}, 'HCOR', ...
                                          getlist('HCOR'),1,'bipolar',-2);
     The output is stored in a cell array.  Smat{1} is the horizontal plane and Smat{2} is the vertical cross plane.

  3. Orbit response matrix for all the horizontal correctors (Default kick amplitude):
     Smat = measrespmat(getx('Struct'), getsp('HCOR','struct'));</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checklimits.html" class="code" title="function [LimitFlag, LimitList] = checklimits(varargin)">checklimits</a>	CHECKLIMITS - Checks if the setpoint will exceed a limit</li><li><a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>	ELEM2DEV - Converts a device list to an element list</li><li><a href="family2common.html" class="code" title="function [CommonNames, ErrorFlag] = family2common(Family, DeviceList)">family2common</a>	FAMILY2COMMON - Convert a family name, device list to a common name list</li><li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="family2units.html" class="code" title="function [Units, UnitsString] = family2units(varargin)">family2units</a>	FAMILY2UNITS - Return the present family units and units string</li><li><a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>	GETAM - Gets monitor channels</li><li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getenergy.html" class="code" title="function [Energy, HCMEnergy] = getenergy(varargin)">getenergy</a>	GETENERGY - Returns the beam energy base on the bend magnet</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>	SETSP - Makes an absolute setpoint change to the 'Setpoint' field</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>	MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</li><li><a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>	MEASDISP - Measures the dispersion function</li><li><a href="meastuneresp.html" class="code" title="function [Rmat, OutputFileName] = meastuneresp(varargin)">meastuneresp</a>	MEASTUNERESP - Measures the response from quadrupole to tune</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function S = measrespmat(varargin)</a>
0002 <span class="comment">%MEASRESPMAT - Measure a response matrix</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  For family name, device list inputs:</span>
0005 <span class="comment">%  S = measrespmat(MonitorFamily, MonitorDeviceList, ActuatorFamily, ActuatorDeviceList, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  For data structure inputs:</span>
0008 <span class="comment">%  S = measrespmat(MonitorStruct, ActuatorStruct, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  INPUTS</span>
0011 <span class="comment">%  1. MonitorFamily       - AcceleratorObjects family name for monitors</span>
0012 <span class="comment">%     MonitorDeviceList   - AcceleratorObjects device list for monitors (element or device)</span>
0013 <span class="comment">%                           (MonitorFamily and MonitorDeviceList can be cell arrays)</span>
0014 <span class="comment">%     or</span>
0015 <span class="comment">%     MonitorStruct can replace MonitorFamily and MonitorDeviceList</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  2. ActuatorFamily      - AcceleratorObjects family name for actuators</span>
0018 <span class="comment">%     ActuatorDeviceList  - AcceleratorObjects device list for actuators (element or device)</span>
0019 <span class="comment">%     or</span>
0020 <span class="comment">%     ActuatorStruct can replace ActuatorFamily and ActuatorDeviceList</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%  3. ActuatorDelta    - Change in actuator {Default: getfamilydata('ActuatorFamily','Setpoint','DeltaRespMat')}</span>
0023 <span class="comment">%  4. ModulationMethod - Method for changing the ActuatorFamily</span>
0024 <span class="comment">%                       'bipolar' changes the ActuatorFamily by +/- ActuatorDelta/2 on each step {Default}</span>
0025 <span class="comment">%                       'unipolar' changes the ActuatorFamily from 0 to ActuatorDelta on each step</span>
0026 <span class="comment">%  5. WaitFlag - (see setpv for WaitFlag definitions) {Default: []}</span>
0027 <span class="comment">%                WaitFlag = -5 will override gets to manual mode</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%  6. ExtraDelay - Extra time delay [seconds] after a setpoint change</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%  7. 'Struct'  - Output will be a response matrix structure {Default for data structure inputs}</span>
0032 <span class="comment">%     'Numeric' - Output will be a numeric matrix            {Default for non-data structure inputs}</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%  8. Optional override of the units:</span>
0035 <span class="comment">%     'Physics'  - Use physics  units</span>
0036 <span class="comment">%     'Hardware' - Use hardware units</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%  9. Optional override of the mode:</span>
0039 <span class="comment">%     'Online' - Set/Get data online</span>
0040 <span class="comment">%     'Model'  - Set/Get data on the model (same as 'Simulator')</span>
0041 <span class="comment">%     'Manual' - Set/Get data manually</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%  10. 'Display'    - Prints status information to the command window {Default}</span>
0044 <span class="comment">%      'NoDisplay'  - Nothing is printed to the command window</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%  11. 'MinimumBeamCurrent' - Minimum beam current before prompting for a refill</span>
0047 <span class="comment">%                             The current (as returned by getdcct) must follow the flag.</span>
0048 <span class="comment">%                             measbpmresp('MinimumBeamCurrent', 32.1)</span>
0049 <span class="comment">%                             will pause at a beam current of 32.1 and prompt for a refill.</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%  OUTPUTS</span>
0052 <span class="comment">%  1. S = Response matrix</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%     For stucture outputs:</span>
0055 <span class="comment">%     S(Monitor, Actuator).Data - Response matrix</span>
0056 <span class="comment">%                         .Monitor - Monitor data structure (starting orbit)</span>
0057 <span class="comment">%                         .Monitor1 - First  data point matrix</span>
0058 <span class="comment">%                         .Monitor2 - Second data point matrix</span>
0059 <span class="comment">%                         .Actuator - Corrector data structure</span>
0060 <span class="comment">%                         .ActuatorDelta - Corrector kick vector</span>
0061 <span class="comment">%                         .GeV - Electron beam energy</span>
0062 <span class="comment">%                         .ModulationMethod - 'unipolar' or 'bipolar'</span>
0063 <span class="comment">%                         .WaitFlag - Wait flag used when acquiring data</span>
0064 <span class="comment">%                         .ExtraDelay - Extra time delay</span>
0065 <span class="comment">%                         .TimeStamp - Matlab clock at the start of each actuator family</span>
0066 <span class="comment">%                         .CreatedBy</span>
0067 <span class="comment">%                         .DCCT</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%  NOTES</span>
0070 <span class="comment">%  1. If MonitorFamily and MonitorDeviceList are cell arrrays, then S is a cell array of response matrices.</span>
0071 <span class="comment">%  2. ActuatorFamily, ActuatorDeviceList, ActuatorDelta, ModulationMethod, WaitFlag are not cell arrrays.</span>
0072 <span class="comment">%  3. If ActuatorDeviceList is empty, then the entire family is change together.</span>
0073 <span class="comment">%  4. Bipolar mode changes the actuator by +/- ActuatorDelta/2</span>
0074 <span class="comment">%  5. Unipolar mode changes the actuator by ActuatorDelta</span>
0075 <span class="comment">%  6. Return values are MonitorChange/ActuatorDelta (normalized)</span>
0076 <span class="comment">%  7. When using cell array inputs don't mix structure data inputs with non-structure data</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%  EXAMPLES</span>
0079 <span class="comment">%  1. 2x2 tune response matrix for Q7 and Q9 families (delay for tune matrix will need to be adjusted):</span>
0080 <span class="comment">%     TuneRmatrix = [measrespmat('TUNE',[1;2],'Q7',[],.5,'unipolar') ...</span>
0081 <span class="comment">%                    measrespmat('TUNE',[1;2],'Q9',[],.5,'unipolar')];</span>
0082 <span class="comment">%</span>
0083 <span class="comment">%  2. Orbit response matrix for all the horizontal correctors (+/-1 amp kick amplitude):</span>
0084 <span class="comment">%     Smat = measrespmat({'BPMx','BPMz'}, {getlist('BPMx'),getlist('BPMz')}, 'HCOR', ...</span>
0085 <span class="comment">%                                          getlist('HCOR'),1,'bipolar',-2);</span>
0086 <span class="comment">%     The output is stored in a cell array.  Smat{1} is the horizontal plane and Smat{2} is the vertical cross plane.</span>
0087 <span class="comment">%</span>
0088 <span class="comment">%  3. Orbit response matrix for all the horizontal correctors (Default kick amplitude):</span>
0089 <span class="comment">%     Smat = measrespmat(getx('Struct'), getsp('HCOR','struct'));</span>
0090 
0091 <span class="comment">%</span>
0092 <span class="comment">%  Written by Gregory J. Portmann</span>
0093 <span class="comment">%  Modified By Laurent S. Nadolski</span>
0094 
0095 <span class="comment">% Initialize</span>
0096 ActuatorDelta = [];
0097 ActuatorDeviceList = [];
0098 ModulationMethod = <span class="string">'bipolar'</span>;
0099 WaitFlag = [];
0100 WaitFlagMonitor = 0;
0101 ExtraDelay = 0; 
0102 StructOutputFlag = 0;
0103 NumericOutputFlag = 0;
0104 DisplayFlag = 1;
0105 ModeFlagCell = {};
0106 UnitsFlagCell = {};
0107 DCCTStopFlag = 0;
0108 
0109 InputFlags = {};
0110 <span class="keyword">for</span> i = length(varargin):-1:1
0111     <span class="keyword">if</span> isstruct(varargin{i})
0112         <span class="comment">% Ignor structures</span>
0113     <span class="keyword">elseif</span> iscell(varargin{i})
0114         <span class="comment">% Ignor cells</span>
0115     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0116         StructOutputFlag = 1;
0117         varargin(i) = [];
0118     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0119         NumericOutputFlag = 1;
0120         StructOutputFlag = 0;
0121         varargin(i) = [];
0122     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>) || strcmpi(varargin{i},<span class="string">'Model'</span>)
0123         ModeFlagCell = varargin(i);
0124         InputFlags = [InputFlags varargin(i)];
0125         varargin(i) = [];
0126     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0127         ModeFlagCell = varargin(i);
0128         InputFlags = [InputFlags varargin(i)];
0129         varargin(i) = [];
0130     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0131         ModeFlagCell = varargin(i);
0132         InputFlags = [InputFlags varargin(i)];
0133         varargin(i) = [];
0134     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Physics'</span>)
0135         UnitsFlagCell = varargin(i);
0136         InputFlags = [InputFlags varargin(i)];
0137         varargin(i) = [];
0138     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Hardware'</span>)
0139         UnitsFlagCell = varargin(i);
0140         InputFlags = [InputFlags varargin(i)];
0141         varargin(i) = [];
0142     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0143         DisplayFlag = 0;
0144         varargin(i) = [];
0145     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0146         DisplayFlag = 1;
0147         varargin(i) = [];
0148     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'MinimumBeamCurrent'</span>)
0149         DCCTStopFlag = 1;
0150         DCCTStop = varargin{i+1};
0151         varargin(i+1) = [];
0152         varargin(i) = [];
0153     <span class="keyword">end</span>
0154 <span class="keyword">end</span>
0155 
0156 
0157 <span class="keyword">if</span> length(varargin) &lt; 2
0158     error(<span class="string">'Not enough inputs'</span>)
0159 <span class="keyword">end</span>
0160 
0161 
0162 
0163 <span class="comment">% Find out if the inputs are data structures</span>
0164 StructInputFlag = 0;
0165 <span class="keyword">if</span> isstruct(varargin{1})
0166     StructInputFlag = 1;
0167 <span class="keyword">elseif</span> iscell(varargin{1})
0168     <span class="keyword">if</span> isstruct(varargin{1}{1})
0169         StructInputFlag = 1;
0170     <span class="keyword">end</span>
0171 <span class="keyword">end</span>
0172 
0173 
0174 <span class="keyword">if</span> StructInputFlag
0175     <span class="comment">% S = measrespmat(MonitorStruct, ActuatorStruct, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)</span>
0176     <span class="keyword">if</span> length(varargin) &lt; 2
0177         error(<span class="string">'At least 2 inputs required in structure mode.'</span>);
0178     <span class="keyword">end</span>
0179     
0180     <span class="comment">% Only change StructOutputFlag if 'numeric' is not on the input line</span>
0181     <span class="keyword">if</span> ~NumericOutputFlag
0182         StructOutputFlag = 1;
0183     <span class="keyword">end</span>
0184     
0185     MonitorStruct = varargin{1};
0186     ActuatorStruct = varargin{2};
0187     <span class="keyword">if</span> ~isstruct(ActuatorStruct)
0188         error(<span class="string">'If monitors are data structures, then the actuator must also be a data structure.'</span>);
0189     <span class="keyword">end</span>
0190     
0191     <span class="keyword">if</span> iscell(varargin{1})
0192         <span class="keyword">for</span> j = 1:length(MonitorStruct)
0193             <span class="keyword">if</span> ~isstruct(MonitorStruct{j})
0194                 error(<span class="string">'All monitors in the cell must be data structures or not (mixing methods not allowed).'</span>);
0195             <span class="keyword">end</span>
0196             
0197             MonitorFamily{j} = MonitorStruct{j}.FamilyName;
0198             MonitorDeviceList{j} = MonitorStruct{j}.DeviceList;
0199         <span class="keyword">end</span>
0200     <span class="keyword">else</span>
0201         MonitorFamily = MonitorStruct.FamilyName;
0202         MonitorDeviceList = MonitorStruct.DeviceList;
0203     <span class="keyword">end</span>
0204     ActuatorFamily = ActuatorStruct.FamilyName;
0205     ActuatorDeviceList = ActuatorStruct.DeviceList;
0206     <span class="keyword">if</span> length(varargin) &gt;= 3
0207         ActuatorDelta = varargin{3};
0208     <span class="keyword">end</span>
0209     <span class="keyword">if</span> length(varargin) &gt;= 4
0210         ModulationMethod = varargin{4};
0211     <span class="keyword">end</span>
0212     <span class="keyword">if</span> length(varargin) &gt;= 5
0213         WaitFlag = varargin{5};
0214     <span class="keyword">end</span>
0215     <span class="keyword">if</span> length(varargin) &gt;= 6
0216         ExtraDelay = varargin{6};
0217     <span class="keyword">end</span>
0218 <span class="keyword">else</span>
0219     <span class="comment">% S = measrespmat(MonitorFamily, MonitorDeviceList, ActuatorFamily, ActuatorDeviceList, ActuatorDelta, ModulationMethod, WaitFlag, ExtraDelay)</span>
0220     <span class="keyword">if</span> length(varargin) &lt; 3
0221         error(<span class="string">'At least 3 inputs required '</span>);
0222     <span class="keyword">end</span>
0223     MonitorFamily = varargin{1};
0224     MonitorDeviceList = varargin{2};
0225     ActuatorFamily = varargin{3};
0226     <span class="keyword">if</span> length(varargin) &gt;= 4
0227         ActuatorDeviceList = varargin{4};
0228     <span class="keyword">end</span>
0229     <span class="keyword">if</span> length(varargin) &gt;= 5
0230         ActuatorDelta = varargin{5};
0231     <span class="keyword">end</span>
0232     <span class="keyword">if</span> length(varargin) &gt;= 6
0233         ModulationMethod = varargin{6};
0234     <span class="keyword">end</span>
0235     <span class="keyword">if</span> length(varargin) &gt;= 7
0236         WaitFlag = varargin{7};
0237     <span class="keyword">end</span>
0238     <span class="keyword">if</span> length(varargin) &gt;= 8
0239         ExtraDelay = varargin{8};
0240     <span class="keyword">end</span>
0241 <span class="keyword">end</span>
0242 
0243 <span class="comment">% Remove extra delay for model</span>
0244 <span class="keyword">if</span> any(strcmpi(<span class="string">'Model'</span>, ModeFlagCell)) || any(strcmpi(<span class="string">'Simulator'</span>, ModeFlagCell))
0245     ExtraDelay = 0;
0246 <span class="keyword">end</span>
0247 
0248 <span class="keyword">if</span> isempty(ModulationMethod)
0249     ModulationMethod = <span class="string">'bipolar'</span>;
0250 <span class="keyword">elseif</span> ~strcmpi(ModulationMethod, <span class="string">'unipolar'</span>) &amp;&amp; ~strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0251     error(<span class="string">'ModulationMethod must be ''unipolar'' or ''bipolar'''</span>);
0252 <span class="keyword">end</span>
0253 
0254 
0255 <span class="comment">% Force to be a cells of equal length</span>
0256 <span class="keyword">if</span> ~iscell(MonitorFamily)
0257     MonitorFamily = {MonitorFamily};
0258 <span class="keyword">end</span>
0259 <span class="keyword">if</span> ~iscell(MonitorDeviceList)
0260     MonitorDeviceList = {MonitorDeviceList};
0261 <span class="keyword">end</span>
0262 <span class="keyword">if</span> ~iscell(ActuatorFamily)
0263     ActuatorFamily = {ActuatorFamily};
0264 <span class="keyword">end</span>
0265 <span class="keyword">if</span> isempty(ActuatorDeviceList)
0266     <span class="keyword">for</span> i = 1:length(ActuatorFamily)
0267         ActuatorDeviceList{i} = [];
0268     <span class="keyword">end</span>
0269 <span class="keyword">elseif</span> ~iscell(ActuatorDeviceList)
0270     ActuatorDeviceList = {ActuatorDeviceList};
0271 <span class="keyword">end</span>
0272 <span class="keyword">if</span> isempty(ActuatorDelta)
0273     <span class="keyword">for</span> i = 1:length(ActuatorFamily)
0274         ActuatorDelta{i} = [];
0275     <span class="keyword">end</span>
0276 <span class="keyword">elseif</span> ~iscell(ActuatorDelta)
0277     ActuatorDelta = {ActuatorDelta};
0278 <span class="keyword">end</span>
0279 
0280 
0281 <span class="comment">% Force column for monitors and rows for actuators</span>
0282 MonitorFamily = MonitorFamily(:);
0283 MonitorDeviceList = MonitorDeviceList(:);
0284 ActuatorFamily = ActuatorFamily(:)';
0285 ActuatorDeviceList = ActuatorDeviceList(:)';
0286 ActuatorDelta = ActuatorDelta(:)';
0287 
0288 
0289 <span class="comment">% Check length of cell inputs</span>
0290 <span class="keyword">if</span> length(MonitorFamily) ~= length(MonitorDeviceList)
0291     error(<span class="string">'The length of MonitorFamily (cell) must equal the length of MonitorDeviceList (cell)'</span>);
0292 <span class="keyword">end</span>
0293 <span class="keyword">if</span> length(ActuatorFamily) ~= length(ActuatorDeviceList)
0294     error(<span class="string">'The length of ActuatorFamily (cell) must equal the length of ActuatorDeviceList (cell)'</span>);
0295 <span class="keyword">end</span>
0296 <span class="keyword">if</span> length(ActuatorFamily) ~= length(ActuatorDelta)
0297     error(<span class="string">'The length of ActuatorFamily (cell) must equal the length of ActuatorDelta (cell)'</span>);
0298 <span class="keyword">end</span>
0299 
0300 
0301 <span class="comment">% Manual mode for monitors</span>
0302 WaitFlagMonitor = WaitFlag;
0303 <span class="keyword">if</span> WaitFlag == -5
0304     WaitFlag = 0;
0305 <span class="keyword">end</span>
0306 
0307 
0308 <span class="comment">% First get all defaults and do some error checking</span>
0309 <span class="keyword">for</span> iActFam = 1:length(ActuatorFamily)
0310     <span class="comment">% Convert element list to a device list if necessary</span>
0311     <span class="keyword">if</span> size(ActuatorDeviceList{iActFam},2) == 1
0312         ActuatorDeviceList{iActFam} = <a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>(ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam});
0313     <span class="keyword">end</span>
0314     
0315     <span class="comment">% Get ActuatorDelta if empty</span>
0316     <span class="keyword">if</span> isempty(ActuatorDelta{iActFam})
0317         <span class="comment">% Find the delta from the AO (.DeltaRespMat is always hardware!!!)</span>
0318         ActuatorDelta{iActFam} = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, <span class="string">'DeltaRespMat'</span>, ActuatorDeviceList{iActFam});
0319         <span class="keyword">if</span> isempty(ActuatorDelta{iActFam})
0320             error(sprintf(<span class="string">'%s.Setpoint.DeltaRespMat field must be set properly'</span>,ActuatorFamily{iActFam}));
0321         <span class="keyword">end</span>
0322         
0323         <span class="comment">% Check if ActuatorDelta needs a units conversion</span>
0324         <span class="keyword">if</span> strcmpi(UnitsFlagCell,{<span class="string">'Physics'</span>})
0325             <span class="comment">% Check over-ride</span>
0326             ActuatorDelta{iActFam} = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, ModeFlagCell{:});
0327         <span class="keyword">else</span>
0328             <span class="comment">% Check family</span>
0329             Units = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, <span class="string">'Units'</span>);
0330             <span class="keyword">if</span> strcmpi(Units, <span class="string">'Physics'</span>)
0331                 ActuatorDelta{iActFam} = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, ModeFlagCell{:});
0332             <span class="keyword">end</span>
0333         <span class="keyword">end</span>
0334         <span class="comment">%if strcmpi(UnitsFlagCell,{'Hardware'}) &amp; strcmpi(Units, 'Physics')</span>
0335         <span class="comment">%    ActuatorDelta{iActFam} = physics2hw(ActuatorFamily{iActFam}, 'Setpoint', ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, ModeFlagCell{:});</span>
0336         <span class="comment">%end</span>
0337     <span class="keyword">end</span>
0338     <span class="keyword">if</span> isempty(ActuatorDelta{iActFam})
0339         error(<span class="string">'ActuatorDelta is empty.  Must be an input or in the family structure (.DeltaRespMat in hardware units)'</span>);
0340     <span class="keyword">end</span>
0341     <span class="keyword">if</span> ~isnumeric(ActuatorDelta{iActFam})
0342         error(<span class="string">'ActuatorDelta must be numeric.'</span>);
0343     <span class="keyword">end</span>
0344     
0345     <span class="comment">% Force ActuatorDelta to be a column vector</span>
0346     ActuatorDelta{iActFam} = ActuatorDelta{iActFam}(:);
0347     
0348     <span class="comment">% Check for entire family</span>
0349     <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0350         <span class="comment">% Set the entire family at once</span>
0351         iActDeviceTotal{iActFam} = 1;
0352         
0353         <span class="comment">% Expand a scalar to all devices</span>
0354         <span class="keyword">if</span> length(ActuatorDelta{iActFam}) == 1
0355             <span class="comment">% OK</span>
0356         <span class="keyword">elseif</span> length(ActuatorDelta{iActFam}) == length(<a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(ActuatorFamily{iActFam}))
0357             <span class="comment">% OK</span>
0358         <span class="keyword">else</span>
0359             error(<span class="string">'ActuatorDelta must be a scalar or equal in length to the number of devices'</span>);
0360         <span class="keyword">end</span>
0361     <span class="keyword">else</span>
0362         iActDeviceTotal{iActFam} = size(ActuatorDeviceList{iActFam},1);
0363         
0364         <span class="comment">% Expand a scalar to all devices if scalar</span>
0365         <span class="keyword">if</span> length(ActuatorDelta{iActFam}) == 1
0366             ActuatorDelta{iActFam} = ActuatorDelta{iActFam} * ones(iActDeviceTotal{iActFam},1);
0367         <span class="keyword">end</span>
0368         <span class="comment">% Size of ActuatorDelta must equal total number of devices</span>
0369         <span class="keyword">if</span> length(ActuatorDelta{iActFam}) ~= iActDeviceTotal{iActFam}
0370             error(<span class="string">'ActuatorDelta must be a scalar or equal in length to the number of devices'</span>);
0371         <span class="keyword">end</span>
0372     <span class="keyword">end</span>
0373     
0374     <span class="comment">% Check for zeros</span>
0375     <span class="keyword">if</span> any(ActuatorDelta{iActFam} == 0)
0376         error(<span class="string">'At least one the actuator deltas is zero.'</span>);
0377     <span class="keyword">end</span>
0378 
0379     <span class="comment">% Get initial actuator values</span>
0380     ActuatorStart{iActFam} = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}, <span class="string">'Struct'</span>, InputFlags{:});
0381     InitActuator = ActuatorStart{iActFam}.Data;
0382     
0383     <span class="comment">% Check actuator limits</span>
0384     <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'unipolar'</span>)
0385         <span class="comment">% unipolar measurement</span>
0386         [LimitFlag, LimitList] = <a href="checklimits.html" class="code" title="function [LimitFlag, LimitList] = checklimits(varargin)">checklimits</a>(ActuatorFamily{iActFam}, InitActuator+ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, UnitsFlagCell{:});
0387         <span class="keyword">if</span> LimitFlag
0388             MagnetString = sprintf(<span class="string">'%s(%d,%d)=%f, Delta=%f'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(LimitList(1),:), InitActuator(LimitList(1)), ActuatorDelta{iActFam}(LimitList(1)));
0389             error([<span class="string">'Actuator limit would be exceeded (Setpoint+Delta) ('</span>, MagnetString, <span class="string">')'</span>]);
0390         <span class="keyword">end</span>
0391     <span class="keyword">elseif</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0392         <span class="comment">% bipolar measurement</span>
0393         [LimitFlag, LimitList] = <a href="checklimits.html" class="code" title="function [LimitFlag, LimitList] = checklimits(varargin)">checklimits</a>(ActuatorFamily{iActFam}, InitActuator-ActuatorDelta{iActFam}/2, ActuatorDeviceList{iActFam}, UnitsFlagCell{:});
0394         <span class="keyword">if</span> LimitFlag
0395             <span class="keyword">if</span> isempty(ActuatorDeviceList{:}),  ActuatorDeviceList{:} = [1 1]; <span class="keyword">end</span>
0396             MagnetString = sprintf(<span class="string">'%s(%d,%d)=%f, Delta=%f'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(LimitList(1),:), InitActuator(LimitList(1)), ActuatorDelta{iActFam}(LimitList(1)));
0397             error([<span class="string">'Actuator limit would be exceeded (Setpoint-Delta/2) ('</span>, MagnetString, <span class="string">')'</span>]);
0398         <span class="keyword">end</span>
0399         [LimitFlag, LimitList] = <a href="checklimits.html" class="code" title="function [LimitFlag, LimitList] = checklimits(varargin)">checklimits</a>(ActuatorFamily{iActFam}, InitActuator+ActuatorDelta{iActFam}/2, ActuatorDeviceList{iActFam}, UnitsFlagCell{:});
0400         <span class="keyword">if</span> LimitFlag
0401             MagnetString = sprintf(<span class="string">'%s(%d,%d)=%f, Delta=%f'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(LimitList(1),:), InitActuator(LimitList(1)), ActuatorDelta{iActFam}(LimitList(1)));
0402             error([<span class="string">'Actuator limit would be exceeded (Setpoint+Delta/2) ('</span>, MagnetString, <span class="string">')'</span>]);
0403         <span class="keyword">end</span>
0404     <span class="keyword">end</span>
0405 <span class="keyword">end</span>
0406 
0407 
0408 <span class="keyword">if</span> DisplayFlag
0409     fprintf(<span class="string">'   Measuring response using a %s actuator method\n'</span>, lower(ModulationMethod));
0410 <span class="keyword">end</span>
0411 
0412 <span class="comment">% Begin main loop over actuators</span>
0413 StopNow = 0;
0414 <span class="keyword">for</span> iActFam = 1:length(ActuatorFamily)
0415     t0 = clock;
0416     clear R;
0417         
0418     <span class="comment">% Get initial monitor values</span>
0419     <span class="keyword">if</span> StructOutputFlag
0420         <span class="keyword">if</span> WaitFlagMonitor == -5
0421             MonitorStart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, <span class="string">'Struct'</span>, <span class="string">'Manual'</span>, UnitsFlagCell{:});
0422         <span class="keyword">else</span>
0423             MonitorStart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, <span class="string">'Struct'</span>, InputFlags{:});
0424         <span class="keyword">end</span>
0425         <span class="keyword">if</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'DCCT'</span>)
0426             DCCTStart = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>(ModeFlagCell{:});
0427         <span class="keyword">else</span>
0428             DCCTStart = NaN;
0429         <span class="keyword">end</span>
0430     <span class="keyword">end</span>
0431     
0432     <span class="comment">% Get initial actuator values</span>
0433     InitActuator = ActuatorStart{iActFam}.Data;
0434     
0435     <span class="comment">% Just to display common names (empty if not using common names)</span>
0436     CommonNameList = <a href="family2common.html" class="code" title="function [CommonNames, ErrorFlag] = family2common(Family, DeviceList)">family2common</a>(ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam});
0437 
0438     <span class="comment">% Iterate on each actuator in the device list</span>
0439     <span class="keyword">if</span> DisplayFlag <span class="comment">% &amp; ~isempty(ActuatorDeviceList{iActFam})  %iActDeviceTotal{iActFam} &gt; 1</span>
0440         fprintf(<span class="string">'\n   %s family response matrix\n'</span>, ActuatorFamily{iActFam});
0441     <span class="keyword">end</span>
0442     
0443     <span class="comment">% Individual actuator loop</span>
0444     <span class="keyword">for</span> iActDevice = 1:iActDeviceTotal{iActFam}
0445         <span class="keyword">if</span> ~isempty(CommonNameList)
0446             CommonName = [deblank(CommonNameList(iActDevice,:)), <span class="string">' '</span>];
0447             <span class="keyword">if</span> strcmpi(deblank(CommonName), ActuatorFamily{iActFam})
0448                 CommonName = <span class="string">''</span>;
0449             <span class="keyword">end</span>
0450         <span class="keyword">end</span>
0451 
0452         <span class="comment">% Remove the CommonName for now</span>
0453         CommonName = <span class="string">''</span>;
0454 
0455         <span class="comment">% Step actuator down for bipolar</span>
0456         <span class="keyword">try</span>
0457             <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0458                 <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0459                     <span class="keyword">if</span> DisplayFlag
0460                         fprintf(<span class="string">'   %s family nominal value is %f [%s]\n'</span>, ActuatorFamily{iActFam}, InitActuator(1), ActuatorStart{iActFam}.UnitsString);
0461                         fprintf(<span class="string">'   Changing family by %+f [%s] from nominal\n'</span>, -ActuatorDelta{iActFam}(1)/2, ActuatorStart{iActFam}.UnitsString);
0462                         drawnow;
0463                     <span class="keyword">end</span>
0464                     DeltaActuator =                InitActuator-ActuatorDelta{iActFam}/2;
0465                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator-ActuatorDelta{iActFam}/2, ActuatorDeviceList{iActFam}, WaitFlag, InputFlags{:});
0466                 <span class="keyword">else</span>
0467                     <span class="keyword">if</span> DisplayFlag
0468                         fprintf(<span class="string">'   %d. %s%s(%d,%d) nominal value is %f [%s]\n'</span>, iActDevice, CommonName, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), InitActuator(iActDevice), ActuatorStart{iActFam}.UnitsString);
0469                         fprintf(<span class="string">'   %d. Changing actuator by %+f [%s] from nominal\n'</span>, iActDevice, -ActuatorDelta{iActFam}(iActDevice)/2, ActuatorStart{iActFam}.UnitsString);
0470                         drawnow;
0471                     <span class="keyword">end</span>
0472                     DeltaActuator =                InitActuator(iActDevice)-ActuatorDelta{iActFam}(iActDevice)/2;
0473                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator(iActDevice)-ActuatorDelta{iActFam}(iActDevice)/2, ActuatorDeviceList{iActFam}(iActDevice,:), WaitFlag, InputFlags{:});
0474                 <span class="keyword">end</span>
0475             <span class="keyword">elseif</span> strcmpi(ModulationMethod, <span class="string">'unipolar'</span>)
0476                 <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0477                     DeltaActuator = InitActuator(1);
0478                 <span class="keyword">else</span>
0479                     DeltaActuator = InitActuator(iActDevice);
0480                 <span class="keyword">end</span>
0481                 <span class="keyword">if</span> DisplayFlag
0482                     <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0483                         fprintf(<span class="string">'   %s family nominal value is %f [%s]\n'</span>, ActuatorFamily{iActFam}, InitActuator(1), ActuatorStart{iActFam}.UnitsString);
0484                         <span class="comment">%fprintf('   No change to actuator\n');</span>
0485                         drawnow;
0486                     <span class="keyword">else</span>
0487                         fprintf(<span class="string">'   %d. %s%s(%d,%d) nominal value is %f [%s]\n'</span>, iActDevice, CommonName, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), InitActuator(iActDevice), ActuatorStart{iActFam}.UnitsString);
0488                         <span class="comment">%fprintf('   %d. No change to actuator\n', iActDevice);</span>
0489                         drawnow;
0490                     <span class="keyword">end</span>
0491                 <span class="keyword">end</span>
0492             <span class="keyword">end</span>
0493             
0494         <span class="keyword">catch</span>
0495             fprintf(<span class="string">'   %s\n'</span>, lasterr);
0496             <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0497                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s to %f [%s].\n'</span>, ActuatorFamily{iActFam}, InitActuator(iActDevice), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0498             <span class="keyword">else</span>
0499                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s(%d,%d) to %f [%s].\n'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0500             <span class="keyword">end</span>
0501             CommandInput = questdlg( <span class="keyword">...</span>
0502                 strvcat(FamilyMessage, <span class="keyword">...</span>
0503                 strvcat(<span class="string">'Either manually varify that the magnet is at the proper setpoint'</span>, <span class="keyword">...</span>
0504                 strvcat(<span class="string">'and continue measuring the response matrix or stop'</span>,<span class="string">'the response matrix measurement?'</span>))), <span class="keyword">...</span>
0505                 <span class="string">'MEASRESPMAT'</span>, <span class="keyword">...</span>
0506                 <span class="string">'Continue'</span>, <span class="keyword">...</span>
0507                 <span class="string">'Stop'</span>, <span class="keyword">...</span>
0508                 <span class="string">'Continue'</span>);
0509             <span class="keyword">switch</span> CommandInput
0510                 <span class="keyword">case</span> <span class="string">'Stop'</span>
0511                     error(<span class="string">'Response matrix measurement stopped.'</span>);
0512                     <span class="comment">%S = {}</span>
0513                     <span class="comment">%return;</span>
0514                 <span class="keyword">case</span> <span class="string">'Continue'</span>
0515                     <span class="comment">%keyboard</span>
0516             <span class="keyword">end</span>
0517         <span class="keyword">end</span>
0518 
0519         <span class="comment">% Wait for signal processing if requested</span>
0520         sleep(ExtraDelay);
0521 
0522         <span class="comment">%if DisplayFlag</span>
0523         <span class="comment">%    fprintf('   Recording data point #1\n'); drawnow;</span>
0524         <span class="comment">%end</span>
0525 
0526         <span class="comment">% Acquire data</span>
0527         <span class="keyword">if</span> WaitFlagMonitor == -5
0528             Xm = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, <span class="string">'Manual'</span>, UnitsFlagCell{:});
0529         <span class="keyword">else</span>
0530             Xm = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, InputFlags{:});
0531         <span class="keyword">end</span>
0532 
0533         <span class="comment">% Step actuator up</span>
0534         <span class="keyword">try</span>
0535             <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0536                 <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0537                     <span class="keyword">if</span> DisplayFlag
0538                         fprintf(<span class="string">'   Changing family by %+f [%s] from nominal\n'</span>, ActuatorDelta{iActFam}(1)/2, ActuatorStart{iActFam}.UnitsString);
0539                         drawnow;
0540                     <span class="keyword">end</span>
0541                     DeltaActuator =                InitActuator+ActuatorDelta{iActFam}/2;
0542                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator+ActuatorDelta{iActFam}/2, ActuatorDeviceList{iActFam}, WaitFlag, InputFlags{:});
0543                 <span class="keyword">else</span>
0544                     <span class="keyword">if</span> DisplayFlag
0545                         fprintf(<span class="string">'   %d. Changing actuator by %+f [%s] from nominal\n'</span>, iActDevice, ActuatorDelta{iActFam}(iActDevice)/2, ActuatorStart{iActFam}.UnitsString);
0546                         drawnow;
0547                     <span class="keyword">end</span>
0548                     DeltaActuator =                InitActuator(iActDevice)+ActuatorDelta{iActFam}(iActDevice)/2;
0549                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator(iActDevice)+ActuatorDelta{iActFam}(iActDevice)/2, ActuatorDeviceList{iActFam}(iActDevice,:), WaitFlag, InputFlags{:});
0550                 <span class="keyword">end</span>
0551             <span class="keyword">elseif</span> strcmpi(ModulationMethod, <span class="string">'unipolar'</span>)
0552                 <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0553                     <span class="keyword">if</span> DisplayFlag
0554                         fprintf(<span class="string">'   Changing family by %+f [%s] from nominal\n'</span>, ActuatorDelta{iActFam}(1), ActuatorStart{iActFam}.UnitsString);
0555                         drawnow;
0556                     <span class="keyword">end</span>
0557                     DeltaActuator =                InitActuator+ActuatorDelta{iActFam};
0558                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator+ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, WaitFlag, InputFlags{:});
0559                 <span class="keyword">else</span>
0560                     <span class="keyword">if</span> DisplayFlag
0561                         fprintf(<span class="string">'   %d. Changing actuator by %+f [%s] from nominal\n'</span>, iActDevice, ActuatorDelta{iActFam}(iActDevice), ActuatorStart{iActFam}.UnitsString);
0562                         drawnow;
0563                     <span class="keyword">end</span>
0564                     DeltaActuator =                InitActuator(iActDevice)+ActuatorDelta{iActFam}(iActDevice);
0565                     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator(iActDevice)+ActuatorDelta{iActFam}(iActDevice), ActuatorDeviceList{iActFam}(iActDevice,:), WaitFlag, InputFlags{:});
0566                 <span class="keyword">end</span>
0567             <span class="keyword">end</span>
0568         <span class="keyword">catch</span>
0569             fprintf(<span class="string">'   %s\n'</span>, lasterr);
0570             <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0571                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s to %f [%s].\n'</span>, ActuatorFamily{iActFam}, InitActuator(iActDevice), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0572             <span class="keyword">else</span>
0573                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s(%d,%d) to %f [%s].\n'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0574             <span class="keyword">end</span>
0575             CommandInput = questdlg( <span class="keyword">...</span>
0576                 strvcat(FamilyMessage, <span class="keyword">...</span>
0577                 strvcat(<span class="string">'Either manually varify that the magnet is at the proper setpoint'</span>, <span class="keyword">...</span>
0578                 strvcat(<span class="string">'and continue measuring the response matrix or stop'</span>,<span class="string">'the response matrix measurement?'</span>))), <span class="keyword">...</span>
0579                 <span class="string">'MEASRESPMAT'</span>, <span class="keyword">...</span>
0580                 <span class="string">'Continue'</span>, <span class="keyword">...</span>
0581                 <span class="string">'Stop'</span>, <span class="keyword">...</span>
0582                 <span class="string">'Continue'</span>);
0583             <span class="keyword">switch</span> CommandInput
0584                 <span class="keyword">case</span> <span class="string">'Stop'</span>
0585                     error(<span class="string">'Response matrix measurement stopped.'</span>);
0586                     <span class="comment">%S = {}</span>
0587                     <span class="comment">%return;</span>
0588                 <span class="keyword">case</span> <span class="string">'Continue'</span>
0589                     <span class="comment">%keyboard</span>
0590             <span class="keyword">end</span>
0591         <span class="keyword">end</span>
0592 
0593         <span class="comment">% Wait for signal processing if requested</span>
0594         sleep(ExtraDelay);
0595 
0596         <span class="keyword">if</span> DisplayFlag
0597             <span class="comment">%fprintf('   Recording data point #2\n'); drawnow;</span>
0598         <span class="keyword">end</span>
0599 
0600         <span class="comment">% Acquire data</span>
0601         <span class="keyword">if</span> WaitFlagMonitor == -5
0602             Xp = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, <span class="string">'Manual'</span>, UnitsFlagCell{:});
0603         <span class="keyword">else</span>
0604             Xp = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(MonitorFamily, MonitorDeviceList, InputFlags{:});
0605         <span class="keyword">end</span>
0606 
0607         <span class="comment">% Restore actuators</span>
0608         <span class="keyword">try</span>
0609             <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0610                 DeltaActuator = InitActuator;
0611                 <span class="keyword">if</span> WaitFlag == -2
0612                     WaitFlagReset = -1;
0613                 <span class="keyword">else</span>
0614                     WaitFlagReset = WaitFlag;
0615                 <span class="keyword">end</span>
0616                 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator, ActuatorDeviceList{iActFam}, WaitFlagReset, InputFlags{:});
0617                 <span class="keyword">if</span> DisplayFlag
0618                     <span class="keyword">if</span> strcmpi(ActuatorStart{iActFam}.Mode, <span class="string">'Manual'</span>)
0619                         fprintf(<span class="string">'   %s family reset\n'</span>, ActuatorFamily{iActFam});
0620                     <span class="keyword">else</span>
0621                         FinalSP = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(ActuatorFamily{iActFam}, InputFlags{:});
0622                         fprintf(<span class="string">'   %s family reset to %f [%s]\n'</span>, ActuatorFamily{iActFam}, FinalSP(1), ActuatorStart{iActFam}.UnitsString);
0623                     <span class="keyword">end</span>
0624                 <span class="keyword">end</span>
0625             <span class="keyword">else</span>
0626                 DeltaActuator = InitActuator(iActDevice);
0627                 <span class="keyword">if</span> WaitFlag == -2
0628                     WaitFlagReset = -1;
0629                 <span class="keyword">else</span>
0630                     WaitFlagReset = WaitFlag;
0631                 <span class="keyword">end</span>
0632                 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(ActuatorFamily{iActFam}, InitActuator(iActDevice), ActuatorDeviceList{iActFam}(iActDevice,:), WaitFlagReset, InputFlags{:});
0633                 <span class="keyword">if</span> DisplayFlag
0634                     <span class="keyword">if</span> strcmpi(ActuatorStart{iActFam}.Mode,<span class="string">'Manual'</span>)
0635                         fprintf(<span class="string">'   %d. %s%s(%d,%d) reset\n'</span>, iActDevice, CommonName, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:));
0636                     <span class="keyword">else</span>
0637                         fprintf(<span class="string">'   %d. %s%s(%d,%d) reset to %f [%s]\n'</span>, iActDevice, CommonName, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(ActuatorFamily{iActFam},ActuatorDeviceList{iActFam}(iActDevice,:)), ActuatorStart{iActFam}.UnitsString);
0638                     <span class="keyword">end</span>
0639                 <span class="keyword">end</span>
0640             <span class="keyword">end</span>
0641             drawnow;
0642         <span class="keyword">catch</span>
0643             fprintf(<span class="string">'   %s\n'</span>, lasterr);
0644             <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0645                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s to %f [%s].\n'</span>, ActuatorFamily{iActFam}, InitActuator(iActDevice), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0646             <span class="keyword">else</span>
0647                 FamilyMessage = sprintf(<span class="string">'An error occurred setting %s(%d,%d) to %f [%s].\n'</span>, ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam}(iActDevice,:), DeltaActuator, ActuatorStart{iActFam}.UnitsString);
0648             <span class="keyword">end</span>
0649             CommandInput = questdlg( <span class="keyword">...</span>
0650                 strvcat(FamilyMessage, <span class="keyword">...</span>
0651                 strvcat(<span class="string">'Either manually varify that the magnet is at the proper setpoint'</span>, <span class="keyword">...</span>
0652                 strvcat(<span class="string">'and continue measuring the response matrix or stop'</span>,<span class="string">'the response matrix measurement?'</span>))), <span class="keyword">...</span>
0653                 <span class="string">'MEASRESPMAT'</span>, <span class="keyword">...</span>
0654                 <span class="string">'Continue'</span>, <span class="keyword">...</span>
0655                 <span class="string">'Stop'</span>, <span class="keyword">...</span>
0656                 <span class="string">'Continue'</span>);
0657             <span class="keyword">switch</span> CommandInput
0658                 <span class="keyword">case</span> <span class="string">'Stop'</span>
0659                     error(<span class="string">'Response matrix measurement stopped.'</span>);
0660                     <span class="comment">%S = {}</span>
0661                     <span class="comment">%return;</span>
0662                 <span class="keyword">case</span> <span class="string">'Continue'</span>
0663                     <span class="comment">%keyboard</span>
0664             <span class="keyword">end</span>
0665         <span class="keyword">end</span>
0666 
0667         <span class="keyword">if</span> DisplayFlag &amp;&amp; (iActDevice &lt; iActDeviceTotal{iActFam})
0668             fprintf(<span class="string">'\n'</span>);
0669         <span class="keyword">end</span>
0670         
0671         <span class="comment">% Compute differences</span>
0672         <span class="keyword">for</span> iMonFam = 1:length(MonitorFamily)
0673             <span class="keyword">if</span> isempty(ActuatorDeviceList{iActFam})
0674                 <span class="comment">% Compute response matrix columns</span>
0675                 <span class="comment">% For each magnet:  1. Divide by the change in amperes, like [Tune / Ampere]</span>
0676                 <span class="comment">%                   2. Scale each magnet by its fractional contribution in physics units (should use K*L, not just K)</span>
0677                 <span class="keyword">if</span> strcmpi(<a href="family2units.html" class="code" title="function [Units, UnitsString] = family2units(varargin)">family2units</a>(ActuatorFamily{iActFam},<span class="string">'Setpoint'</span>),<span class="string">'Hardware'</span>)
0678                     DeltaPhysics = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, InitActuator+ActuatorDelta{iActFam}, ActuatorDeviceList{iActFam}, ModeFlagCell{:}) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(ActuatorFamily{iActFam}, <span class="string">'Setpoint'</span>, InitActuator, ActuatorDeviceList{iActFam}, ModeFlagCell{:});
0679                 <span class="keyword">else</span>
0680                     DeltaPhysics = ActuatorDelta{iActFam};
0681                 <span class="keyword">end</span>
0682                 
0683                 <span class="comment">% DeltaPhysics should be K*Leff (not just &quot;K&quot;)</span>
0684                 Leff = getleff(ActuatorFamily{iActFam}, ActuatorDeviceList{iActFam});
0685                 
0686                 <span class="comment">% Zero Leff is trouble, just divide by the number of actuators</span>
0687                 i = find(Leff==0);
0688                 Leff(i) = 1 / length(Leff);
0689                 
0690                 DeltaPhysics = DeltaPhysics .* Leff;
0691                 
0692                 <span class="comment">% In order to backout the response at each magnet, assume that</span>
0693                 <span class="comment">% the response at each magnet is equal in physics units.</span>
0694                 DeltaMonitorPerPhysicsUnit = (Xp{iMonFam}-Xm{iMonFam}) / sum(DeltaPhysics);
0695                 
0696                 <span class="comment">% Expand to each magnet</span>
0697                 R{iMonFam} = DeltaMonitorPerPhysicsUnit * ones(1,length(DeltaPhysics));
0698                 
0699                 <span class="comment">% When in hardware unit convert to delta monitor / ampere</span>
0700                 <span class="keyword">if</span> strcmpi(<a href="family2units.html" class="code" title="function [Units, UnitsString] = family2units(varargin)">family2units</a>(ActuatorFamily{iActFam},<span class="string">'Setpoint'</span>),<span class="string">'Hardware'</span>)
0701                     PhysicsUnitPerAmp = DeltaPhysics ./ ActuatorDelta{iActFam};
0702                     <span class="keyword">for</span> n = 1:length(DeltaPhysics)
0703                         R{iMonFam}(:,n) = PhysicsUnitPerAmp(n) * R{iMonFam}(:,n);
0704                     <span class="keyword">end</span>
0705                 <span class="keyword">end</span>
0706                 
0707             <span class="keyword">else</span>
0708                 <span class="comment">% Just divide the monitor value by the actuator value</span>
0709                 R{iMonFam}(:,iActDevice) = (Xp{iMonFam}-Xm{iMonFam}) / ActuatorDelta{iActFam}(iActDevice); 
0710             <span class="keyword">end</span>
0711             
0712             <span class="comment">% Save the measurements</span>
0713             Monitor1{iMonFam}(:,iActDevice) = Xm{iMonFam};
0714             Monitor2{iMonFam}(:,iActDevice) = Xp{iMonFam};
0715 
0716         <span class="keyword">end</span> <span class="comment">% iMonFam</span>
0717         
0718         <span class="comment">% If the beam current is too low, prompt for a refill</span>
0719         <span class="keyword">if</span> DCCTStopFlag
0720             <span class="keyword">if</span> (<a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> - DCCTStop) &lt; 0
0721                 CommandInput = questdlg( <span class="keyword">...</span>
0722                     {sprintf(<span class="string">'The present beam current is %f'</span>, <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>), <span class="keyword">...</span>
0723                     sprintf(<span class="string">'A refill prompt was requested at %f'</span>, DCCTStop), <span class="keyword">...</span>
0724                     <span class="string">'   '</span>, <span class="keyword">...</span>
0725                     <span class="string">'Your choices are:'</span>
0726                     sprintf(<span class="string">'Continue - Continue and you will be prompted again a %f'</span>, DCCTStop), <span class="keyword">...</span>
0727                     <span class="string">'Stop - Stop the measure right now'</span>, <span class="keyword">...</span>
0728                     <span class="string">'Don''t ask again - Continue on without another interruption'</span>}, <span class="keyword">...</span>
0729                     <span class="string">'MEASRESPMAT'</span>, <span class="keyword">...</span>
0730                     <span class="string">'Continue'</span>, <span class="keyword">...</span>
0731                     <span class="string">'Stop'</span>, <span class="keyword">...</span>
0732                     <span class="string">'Don''t ask again'</span>, <span class="string">'Don''t ask again'</span>);
0733                 <span class="keyword">if</span> isempty(CommandInput) || strcmp(CommandInput, <span class="string">'Don''t ask again'</span>)
0734                     DCCTStopFlag = 0;
0735                 <span class="keyword">elseif</span> strcmp(CommandInput, <span class="string">'Stop'</span>)
0736                     StopNow = 1;
0737                     <span class="keyword">break</span>;
0738                 <span class="keyword">end</span>
0739             <span class="keyword">end</span>
0740         <span class="keyword">end</span>
0741     
0742     <span class="keyword">end</span> <span class="comment">% iActDevice</span>
0743         
0744     <span class="keyword">for</span> iMonFam = 1:length(MonitorFamily)
0745         <span class="keyword">if</span> StructOutputFlag
0746             S{iMonFam,iActFam}.Data = R{iMonFam};
0747             
0748             S{iMonFam,iActFam}.Monitor = MonitorStart{iMonFam};
0749             S{iMonFam,iActFam}.Actuator = ActuatorStart{iActFam};
0750             S{iMonFam,iActFam}.ActuatorDelta = ActuatorDelta{iActFam};
0751             
0752             S{iMonFam,iActFam}.Monitor1 = Monitor1{iMonFam};
0753             S{iMonFam,iActFam}.Monitor2 = Monitor2{iMonFam};
0754             
0755             <span class="keyword">if</span> ~strcmpi(MonitorStart{iMonFam}.Units, ActuatorStart{iActFam}.Units)
0756                 S{iMonFam,iActFam}.Units =  [MonitorStart{iMonFam}.Units, <span class="string">'/'</span>, ActuatorStart{iActFam}.Units];
0757                 fprintf(<span class="string">'   Warning: Units are in a mixed mode'</span>);
0758             <span class="keyword">else</span>
0759                 S{iMonFam,iActFam}.Units = MonitorStart{iMonFam}.Units;
0760             <span class="keyword">end</span>
0761             <span class="comment">%S{iMonFam,iActFam}.UnitsString = ['[',MonitorStart{iMonFam}.UnitsString,']', '/', '[',ActuatorStart{iActFam}.UnitsString,']'];</span>
0762             S{iMonFam,iActFam}.UnitsString = [MonitorStart{iMonFam}.UnitsString, <span class="string">'/'</span>, ActuatorStart{iActFam}.UnitsString];
0763 
0764             S{iMonFam,iActFam}.GeV = <a href="getenergy.html" class="code" title="function [Energy, HCMEnergy] = getenergy(varargin)">getenergy</a>(ModeFlagCell{:}); 
0765             S{iMonFam,iActFam}.TimeStamp = t0;
0766             S{iMonFam,iActFam}.DCCT = DCCTStart;
0767             S{iMonFam,iActFam}.ModulationMethod = ModulationMethod;
0768             S{iMonFam,iActFam}.WaitFlag = WaitFlagMonitor;
0769             S{iMonFam,iActFam}.ExtraDelay = ExtraDelay;
0770             S{iMonFam,iActFam}.DataDescriptor = <span class="string">'Response Matrix'</span>;
0771             S{iMonFam,iActFam}.CreatedBy = <span class="string">'measrespmat'</span>;
0772             S{iMonFam,iActFam}.OperationalMode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'OperationalMode'</span>);
0773         <span class="keyword">else</span>
0774             S{iMonFam,iActFam} = R{iMonFam};
0775         <span class="keyword">end</span>
0776     <span class="keyword">end</span>
0777 
0778     <span class="keyword">if</span> StopNow
0779         <span class="keyword">break</span>;
0780     <span class="keyword">end</span>
0781 
0782 <span class="keyword">end</span>
0783 
0784 
0785 <span class="comment">% For one family inputs, there is no need for a cell output</span>
0786 <span class="keyword">if</span> all(size(S) == [1 1])
0787     S = S{1};
0788 <span class="keyword">end</span>
0789</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>