<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of setpv</title>
  <meta name="keywords" content="setpv">
  <meta name="description" content="SETPV - Setpoint change of the online system or model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; setpv.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>setpv
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>SETPV - Setpoint change of the online system or model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ErrorFlag = setpv(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">SETPV - Setpoint change of the online system or model

  FamilyName Method
  ErrorFlag = setpv(Family, Field, NewSP, DeviceList, WaitFlag)

  Data Structure
  ErrorFlag = setpv(DataStructure, WaitFlag)

  ChannelName (EPICS/TANGO) Method
  ErrorFlag = setpv(TangoName, NewSP, WaitFlag)
  ErrorFlag = setpv(ChannelName, NewSP, WaitFlag)
  ErrorFlag = setpv(ChannelName, Field, NewSP, WaitFlag)

  CommonName Method
  ErrorFlag = setpv(CommonNames, NewSP, WaitFlag)
  ErrorFlag = setpv(CommonNames, Field, NewSP, WaitFlag)
  ErrorFlag = setpv(Family, Field, NewSP, CommonNames, WaitFlag)

  INPUTS
  1. Family - FamilyName
              Data Structure
              Channel Name or matrix of Channel Names (see note #5)
              Tango Name or matrix of Tango Names
              AcceleratorObject
              Use Family=[] in CommonName method to search all Families
              (or Cell Array of inputs)

  2. Field - AcceleratorObject Field name ('Monitor', 'Setpoint', etc)
             {Default: 'Monitor' or '' for ChannelNames method}
             If Family is a cell array then Field must be a cell array

  3. NewSP - New Setpoints or cell array of Setpoints
             Note: Present, only LabCA can handle string setpoints.  String setpoints
                   will fail if hw2physics or physics2hw are needed.

  4. DeviceList - ([Sector Device #] or [element #]) {Default or empty list: whole family}
                  Note: all numerical inputs must be column vectors
     CommonName - Common name can replace a DeviceList (scalar or vector outputs)

  5. WaitFlag - 0    -&gt; return immediately {Default}
                &gt; 0  -&gt; wait until ramping is done then adds an extra delay equal to WaitFlag
                = -1 -&gt; wait until ramping is done
                = -2 -&gt; wait until ramping is done then adds an extra delay for fresh data
                        from the BPMs
                = -3 -&gt; wait until ramping is done then adds an extra delay for fresh data
                        from the tune measurement system
                = -4 -&gt; wait until ramping is done then wait for a carriage return
     Note: For channel names, it is assumed the ramp time is immediate.

  6. Units flag overrides
     'Physics'  - Use physics  units
     'Hardware' - Use hardware units

  7. Mode flag overrides
     'Online' - Set data online
     'Model'  - Set data on the model
     'Manual' - Set data manually

  8. 'Abs' or 'Absolute'   - Absolute setpoint change {Default}
     'Inc' or 'Incrmental' - Incremental setpoint change

  OUTPUTS
  1. ErrorFlag - 0   -&gt; OK
                else -&gt; error or warning condition occurred
     Note: ErrorFlag is only used if AD.ErrorWarningLevel &lt; 0, otherwise a Matlab error
           in issued.  Use try;catch statements to catch the errors.

  NOTES
  1. For data structure inputs:
     Family     = DataStructure.FamilyName (This field must exist)
     Field      = DataStructure.Field      (Field can be overridden on the input line)
     NewSP      = DataStructure.Data       (NewSP can be overridden on the input line)
     DeviceList = DataStructure.DeviceList (DeviceList can be overridden on the input line)
     Units      = DataStructure.Units      (Units can be overridden on the input line)
     (The Mode field is ignored!)

  2. The number of colomns of NewSP and DeviceList must be equal,
     or NewSP must be a scalar.  If NewSP is a scalar, then all
     devices in DeviceList will be set to the same value.

  3. When using cell array all inputs must be the same size cell array
     and the output will also be a cell array.  Field and WaitFlag can be
     cells but they don't have to be.

  4. ChannelName method:
     a. Always Online!
     b. The optional Field input is added as a .Field to the channel name
     c. If use setpv(ChannelName, NewSP, WaitFlag) then NewSP must a numeric.
        Use setpv(ChannelName, '',NewSP, WaitFlag) if NewSP is a string.

  5. For cell array inputs:
     a. Input 1 defines the maximum size of all cells
     b. The cell array size must be 1 or equal to the number of cell in input #1
     c. WaitFlag can be a cell but it doesn't have to be.

  6. WaitFlag
     a. If no change is seen on the AM then an error will occur.  The tolerance for this
        may need to be changed depending on the accelerator (edit the end of this function to do so)
     b. The delay for WaitFlag = -2 is in the AD.  It is often better to use the FreshDataFlag when
        getting BPM data but the data must to noisy for this to work.

  7. Strings - when setting string the Field input must exist otherwise the setpoint will be
               confused for a Field.

  8. If say Golden is a software field in the MML structure in the BPMx family, then 
     setpv('BPMx','Golden', NewValue, DeviceList) will set the data in that field. 

  EXAMPES
  1. setpv('HCM','Setpoint',1.23);               Sets the entire HCM family to 1.23
  2. setpv({'HCM','VCM'},'Setpoint',{10.4,5.3}); Sets the entire HCM family to 10.4 and VCM family to 5.3
  3. setpv('HCM','Setpoint',1.23,[1 3]);    Simple DeviceList method
  4. setpv('HCM','Setpoint',1.23, 3);       Simple ElementList method
  5. setpv(AO('HCM'),'Setpoint',1.5,[1 2]);     If AO is a properly formatted AcceleratorObject Structure
                                                    then this sets the 1st sector, 2nd element to 1.5
  6. setpv('HCM','Setpoint',1.23,'1CX3');   CommonName method with Family specified (spear3 naming convection)
  7. setpv([],'Setpoint',1.23,'1CX3');      CommonName method without Family (spear3 naming convection)

  See also <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>, <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>, <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>, <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>, <a href="steppv.html" class="code" title="function ErrorFlag = steppv(varargin)">steppv</a>, <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>, setpvmodel, setpvonline

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>	COMMON2DEV - Converts a common name to a device list</li><li><a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>	ELEM2DEV - Converts a device list to an element list</li><li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>	GETAM - Gets monitor channels</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getramprate.html" class="code" title="function RampRate = getramprate(varargin)">getramprate</a>	GETRAMPRATE - Returns the ramp rate for a family</li><li><a href="getrunflag.html" class="code" title="function [RunFlag, Delta, Tol] = getrunflag(varargin)">getrunflag</a>	GETRUNFLAG - Returns position if the device is in the process of changing a setpoint</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>	PHYSICS2HW - Converts from 'Physics' units to 'Hardware' units</li><li><a href="setfamilydata.html" class="code" title="function setfamilydata(Data, Family, Field1, Field2, DeviceList)">setfamilydata</a>	SETFAMILYDATA - Sets data associated with accelerator control</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="correctors2golden.html" class="code" title="function correctors2golden">correctors2golden</a>	CORRECTORS2GOLDEN - Sets the default corrector families to the golden configuration values</li><li><a href="measidfftable.html" class="code" title="function ffgettbl(Sector, BPMFlag)">measidfftable</a>	FFGETTBL - Measures an insertion device feed forward table for the vertical gap</li><li><a href="setam.html" class="code" title="function ErrorFlag = setam(Family, varargin)">setam</a>	SETAM - Sets analog monitor value</li><li><a href="setenergy.html" class="code" title="function [ConfigSetpointEnd, ConfigSetpointStart, ConfigSetpointPhysics] = setenergy(varargin)">setenergy</a>	SETENERGY - Sets the storage ring energy (GeV) by ramping all lattice magnets</li><li><a href="setmachineconfig.html" class="code" title="function [ConfigSetpoint, FileName] = setmachineconfig(varargin)">setmachineconfig</a>	SETMACHINECONFIG - Sets the storage ring setpoints from a file or configuration data structure</li><li><a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>	SETORBIT - Orbit correction function</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li><li><a href="setrf.html" class="code" title="function setrf(RF, varargin)">setrf</a>	SETRF - Sets the RF frequency</li><li><a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>	SETSP - Makes an absolute setpoint change to the 'Setpoint' field</li><li><a href="steppv.html" class="code" title="function ErrorFlag = steppv(varargin)">steppv</a>	STEPPV - Incremental setpoint change of a process variable or simulated value</li><li><a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>	STEPSP - Step the setpoint for family</li><li><a href="sweepenergy.html" class="code" title="function sweepenergy(PercentChangeInEnergy)">sweepenergy</a>	SWEEPENERGY - Energy sweep of the storage ring</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function ErrorFlag = local_setpv(AO, Field, NewSP, DeviceList, WaitFlag)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ErrorFlag = setpv(varargin)</a>
0002 <span class="comment">%SETPV - Setpoint change of the online system or model</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  FamilyName Method</span>
0005 <span class="comment">%  ErrorFlag = setpv(Family, Field, NewSP, DeviceList, WaitFlag)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  Data Structure</span>
0008 <span class="comment">%  ErrorFlag = setpv(DataStructure, WaitFlag)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  ChannelName (EPICS/TANGO) Method</span>
0011 <span class="comment">%  ErrorFlag = setpv(TangoName, NewSP, WaitFlag)</span>
0012 <span class="comment">%  ErrorFlag = setpv(ChannelName, NewSP, WaitFlag)</span>
0013 <span class="comment">%  ErrorFlag = setpv(ChannelName, Field, NewSP, WaitFlag)</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%  CommonName Method</span>
0016 <span class="comment">%  ErrorFlag = setpv(CommonNames, NewSP, WaitFlag)</span>
0017 <span class="comment">%  ErrorFlag = setpv(CommonNames, Field, NewSP, WaitFlag)</span>
0018 <span class="comment">%  ErrorFlag = setpv(Family, Field, NewSP, CommonNames, WaitFlag)</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%  INPUTS</span>
0021 <span class="comment">%  1. Family - FamilyName</span>
0022 <span class="comment">%              Data Structure</span>
0023 <span class="comment">%              Channel Name or matrix of Channel Names (see note #5)</span>
0024 <span class="comment">%              Tango Name or matrix of Tango Names</span>
0025 <span class="comment">%              AcceleratorObject</span>
0026 <span class="comment">%              Use Family=[] in CommonName method to search all Families</span>
0027 <span class="comment">%              (or Cell Array of inputs)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%  2. Field - AcceleratorObject Field name ('Monitor', 'Setpoint', etc)</span>
0030 <span class="comment">%             {Default: 'Monitor' or '' for ChannelNames method}</span>
0031 <span class="comment">%             If Family is a cell array then Field must be a cell array</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%  3. NewSP - New Setpoints or cell array of Setpoints</span>
0034 <span class="comment">%             Note: Present, only LabCA can handle string setpoints.  String setpoints</span>
0035 <span class="comment">%                   will fail if hw2physics or physics2hw are needed.</span>
0036 <span class="comment">%</span>
0037 <span class="comment">%  4. DeviceList - ([Sector Device #] or [element #]) {Default or empty list: whole family}</span>
0038 <span class="comment">%                  Note: all numerical inputs must be column vectors</span>
0039 <span class="comment">%     CommonName - Common name can replace a DeviceList (scalar or vector outputs)</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%  5. WaitFlag - 0    -&gt; return immediately {Default}</span>
0042 <span class="comment">%                &gt; 0  -&gt; wait until ramping is done then adds an extra delay equal to WaitFlag</span>
0043 <span class="comment">%                = -1 -&gt; wait until ramping is done</span>
0044 <span class="comment">%                = -2 -&gt; wait until ramping is done then adds an extra delay for fresh data</span>
0045 <span class="comment">%                        from the BPMs</span>
0046 <span class="comment">%                = -3 -&gt; wait until ramping is done then adds an extra delay for fresh data</span>
0047 <span class="comment">%                        from the tune measurement system</span>
0048 <span class="comment">%                = -4 -&gt; wait until ramping is done then wait for a carriage return</span>
0049 <span class="comment">%     Note: For channel names, it is assumed the ramp time is immediate.</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%  6. Units flag overrides</span>
0052 <span class="comment">%     'Physics'  - Use physics  units</span>
0053 <span class="comment">%     'Hardware' - Use hardware units</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%  7. Mode flag overrides</span>
0056 <span class="comment">%     'Online' - Set data online</span>
0057 <span class="comment">%     'Model'  - Set data on the model</span>
0058 <span class="comment">%     'Manual' - Set data manually</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%  8. 'Abs' or 'Absolute'   - Absolute setpoint change {Default}</span>
0061 <span class="comment">%     'Inc' or 'Incrmental' - Incremental setpoint change</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%  OUTPUTS</span>
0064 <span class="comment">%  1. ErrorFlag - 0   -&gt; OK</span>
0065 <span class="comment">%                else -&gt; error or warning condition occurred</span>
0066 <span class="comment">%     Note: ErrorFlag is only used if AD.ErrorWarningLevel &lt; 0, otherwise a Matlab error</span>
0067 <span class="comment">%           in issued.  Use try;catch statements to catch the errors.</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%  NOTES</span>
0070 <span class="comment">%  1. For data structure inputs:</span>
0071 <span class="comment">%     Family     = DataStructure.FamilyName (This field must exist)</span>
0072 <span class="comment">%     Field      = DataStructure.Field      (Field can be overridden on the input line)</span>
0073 <span class="comment">%     NewSP      = DataStructure.Data       (NewSP can be overridden on the input line)</span>
0074 <span class="comment">%     DeviceList = DataStructure.DeviceList (DeviceList can be overridden on the input line)</span>
0075 <span class="comment">%     Units      = DataStructure.Units      (Units can be overridden on the input line)</span>
0076 <span class="comment">%     (The Mode field is ignored!)</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%  2. The number of colomns of NewSP and DeviceList must be equal,</span>
0079 <span class="comment">%     or NewSP must be a scalar.  If NewSP is a scalar, then all</span>
0080 <span class="comment">%     devices in DeviceList will be set to the same value.</span>
0081 <span class="comment">%</span>
0082 <span class="comment">%  3. When using cell array all inputs must be the same size cell array</span>
0083 <span class="comment">%     and the output will also be a cell array.  Field and WaitFlag can be</span>
0084 <span class="comment">%     cells but they don't have to be.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">%  4. ChannelName method:</span>
0087 <span class="comment">%     a. Always Online!</span>
0088 <span class="comment">%     b. The optional Field input is added as a .Field to the channel name</span>
0089 <span class="comment">%     c. If use setpv(ChannelName, NewSP, WaitFlag) then NewSP must a numeric.</span>
0090 <span class="comment">%        Use setpv(ChannelName, '',NewSP, WaitFlag) if NewSP is a string.</span>
0091 <span class="comment">%</span>
0092 <span class="comment">%  5. For cell array inputs:</span>
0093 <span class="comment">%     a. Input 1 defines the maximum size of all cells</span>
0094 <span class="comment">%     b. The cell array size must be 1 or equal to the number of cell in input #1</span>
0095 <span class="comment">%     c. WaitFlag can be a cell but it doesn't have to be.</span>
0096 <span class="comment">%</span>
0097 <span class="comment">%  6. WaitFlag</span>
0098 <span class="comment">%     a. If no change is seen on the AM then an error will occur.  The tolerance for this</span>
0099 <span class="comment">%        may need to be changed depending on the accelerator (edit the end of this function to do so)</span>
0100 <span class="comment">%     b. The delay for WaitFlag = -2 is in the AD.  It is often better to use the FreshDataFlag when</span>
0101 <span class="comment">%        getting BPM data but the data must to noisy for this to work.</span>
0102 <span class="comment">%</span>
0103 <span class="comment">%  7. Strings - when setting string the Field input must exist otherwise the setpoint will be</span>
0104 <span class="comment">%               confused for a Field.</span>
0105 <span class="comment">%</span>
0106 <span class="comment">%  8. If say Golden is a software field in the MML structure in the BPMx family, then</span>
0107 <span class="comment">%     setpv('BPMx','Golden', NewValue, DeviceList) will set the data in that field.</span>
0108 <span class="comment">%</span>
0109 <span class="comment">%  EXAMPES</span>
0110 <span class="comment">%  1. setpv('HCM','Setpoint',1.23);               Sets the entire HCM family to 1.23</span>
0111 <span class="comment">%  2. setpv({'HCM','VCM'},'Setpoint',{10.4,5.3}); Sets the entire HCM family to 10.4 and VCM family to 5.3</span>
0112 <span class="comment">%  3. setpv('HCM','Setpoint',1.23,[1 3]);    Simple DeviceList method</span>
0113 <span class="comment">%  4. setpv('HCM','Setpoint',1.23, 3);       Simple ElementList method</span>
0114 <span class="comment">%  5. setpv(AO('HCM'),'Setpoint',1.5,[1 2]);     If AO is a properly formatted AcceleratorObject Structure</span>
0115 <span class="comment">%                                                    then this sets the 1st sector, 2nd element to 1.5</span>
0116 <span class="comment">%  6. setpv('HCM','Setpoint',1.23,'1CX3');   CommonName method with Family specified (spear3 naming convection)</span>
0117 <span class="comment">%  7. setpv([],'Setpoint',1.23,'1CX3');      CommonName method without Family (spear3 naming convection)</span>
0118 <span class="comment">%</span>
0119 <span class="comment">%  See also getam, getsp, getpv, setsp, steppv, stepsp, setpvmodel, setpvonline</span>
0120 <span class="comment">%</span>
0121 <span class="comment">%  Written by Greg Portmann</span>
0122 
0123 
0124 <span class="comment">% Defaults</span>
0125 WaitFlagDefault = 0;
0126 FieldDefault = <span class="string">'Setpoint'</span>;
0127 
0128 
0129 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0130 <span class="comment">% Input Parsing %</span>
0131 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0132 Field = FieldDefault;
0133 IncrementalFlag = 0;
0134 DeviceList = [];
0135 WaitFlag = [];
0136 ModeFlag = <span class="string">''</span>;
0137 UnitsFlag = <span class="string">''</span>;
0138 InputFlags = {};
0139 <span class="keyword">for</span> i = length(varargin):-1:1
0140     <span class="keyword">if</span> isstruct(varargin{i})
0141         <span class="comment">% Ignor structures</span>
0142     <span class="keyword">elseif</span> iscell(varargin{i})
0143         <span class="comment">% Ignor cells</span>
0144     <span class="keyword">elseif</span> isa(varargin{i},<span class="string">'AccObj'</span>)
0145         AccObj1 = struct(varargin{i});
0146         Families = fieldnames(AccObj1);
0147         j = 0;
0148         <span class="keyword">for</span> k = 1:length(Families)
0149             <span class="keyword">if</span> ~isempty(AccObj1.(Families{k}))
0150                 j = j + 1;
0151                 tmpcell{j} = AccObj1.(Families{k});
0152             <span class="keyword">end</span>
0153         <span class="keyword">end</span>
0154         <span class="keyword">if</span> length(tmpcell) == 1
0155             varargin{i} = tmpcell{1};
0156         <span class="keyword">else</span>
0157             varargin{i} = tmpcell;
0158         <span class="keyword">end</span>
0159     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'struct'</span>)
0160         <span class="comment">% Remove and ignor</span>
0161         varargin(i) = [];
0162     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'numeric'</span>)
0163         <span class="comment">% Remove and ignor</span>
0164         varargin(i) = [];
0165     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'simulator'</span>) || strcmpi(varargin{i},<span class="string">'model'</span>)
0166         ModeFlag = <span class="string">'SIMULATOR'</span>;
0167         InputFlags = [InputFlags varargin(i)];
0168         varargin(i) = [];
0169     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0170         ModeFlag = <span class="string">'Online'</span>;
0171         InputFlags = [InputFlags varargin(i)];
0172         varargin(i) = [];
0173     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0174         ModeFlag = <span class="string">'Manual'</span>;
0175         InputFlags = [InputFlags varargin(i)];
0176         varargin(i) = [];
0177     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Special'</span>)
0178         ModeFlag = <span class="string">'Special'</span>;
0179         InputFlags = [InputFlags varargin(i)];
0180         varargin(i) = [];
0181     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'physics'</span>)
0182         UnitsFlag = <span class="string">'Physics'</span>;
0183         InputFlags = [InputFlags varargin(i)];
0184         varargin(i) = [];
0185     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0186         UnitsFlag = <span class="string">'Hardware'</span>;
0187         InputFlags = [InputFlags varargin(i)];
0188         varargin(i) = [];
0189     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Inc'</span>) || strcmpi(varargin{i},<span class="string">'Incremental'</span>)
0190         IncrementalFlag = 1;
0191         InputFlags = [InputFlags varargin(i)];
0192         varargin(i) = [];
0193     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Abs'</span>) || strcmpi(varargin{i},<span class="string">'Absolute'</span>)
0194         IncrementalFlag = 0;
0195         InputFlags = [InputFlags varargin(i)];
0196         varargin(i) = [];
0197     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'String'</span>)
0198         <span class="comment">% Remove and ignor</span>
0199         varargin(i) = [];
0200     <span class="keyword">end</span>
0201 <span class="keyword">end</span>
0202 
0203 <span class="keyword">if</span> isempty(varargin)
0204     error(<span class="string">'Not enough inputs'</span>);
0205 <span class="keyword">end</span>
0206 
0207 Family = varargin{1};
0208 
0209 
0210 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0211 <span class="comment">% CELL OR CELL ARRAY INPUT %</span>
0212 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0213 <span class="keyword">if</span> iscell(varargin{1})
0214     <span class="comment">% Iterate on each cell</span>
0215     <span class="comment">% ErrorFlag = setpv(Family, Field, NewSP, DeviceList, WaitFlag)</span>
0216     <span class="comment">% ErrorFlag = setpv(DataStructure, WaitFlag)</span>
0217     <span class="comment">% ErrorFlag = setpv(ChannelName, NewSP)</span>
0218     <span class="comment">% ErrorFlag = setpv(Family, Field, NewSP, CommonNames, WaitFlag)</span>
0219 
0220     <span class="comment">% Set everything with WaitFlag==0</span>
0221     DoItAgainFlag = 0;
0222     ErrorFlag = 0;
0223     <span class="keyword">for</span> i = 1:size(varargin{1},1)
0224         <span class="keyword">for</span> j = 1:size(varargin{1},2)
0225 
0226             <span class="comment">% Build the input line</span>
0227             <span class="keyword">for</span> k = 1:length(varargin)
0228                 <span class="keyword">if</span> ~iscell(varargin{k})
0229                     Inputs1{1,k} = varargin{k};
0230                 <span class="keyword">elseif</span> length(varargin{k}) == 1
0231                     Inputs1{1,k} = varargin{k}{1};
0232                 <span class="keyword">elseif</span> (size(varargin{k},1) == size(varargin{1},1)) &amp;&amp; (size(varargin{k},2) == size(varargin{1},2))
0233                     Inputs1{1,k} = varargin{k}{i,j};
0234                 <span class="keyword">else</span>
0235                     error(<span class="string">'When using cells, all the cells must be the same size or length 1 (repeated).'</span>);
0236                 <span class="keyword">end</span>
0237             <span class="keyword">end</span>
0238 
0239             <span class="comment">% Remove WaitFlag on first set if WaitFlag~=0 on any cell</span>
0240             <span class="keyword">if</span> isstruct(varargin{1}{i,j})
0241                 <span class="keyword">if</span> length(Inputs1) &gt;= 2
0242                     <span class="keyword">if</span> ischar(Inputs1{2})
0243                         <span class="comment">% Inputs1{2} might be 'setpoint' due to setsp</span>
0244                         <span class="keyword">if</span> length(Inputs1) &gt;= 3
0245                             <span class="keyword">if</span> Inputs1{3} ~= 0
0246                                 DoItAgainFlag = 1;
0247                                 Inputs1{2} = 0;
0248                             <span class="keyword">end</span>
0249                             Inputs1(3) = [];
0250                         <span class="keyword">else</span>
0251                             DoItAgainFlag = 1;
0252                         <span class="keyword">end</span>
0253                     <span class="keyword">else</span>
0254                         <span class="keyword">if</span> Inputs1{2} ~= 0
0255                             DoItAgainFlag = 1;
0256                             Inputs1{2} = 0;
0257                         <span class="keyword">end</span>
0258                     <span class="keyword">end</span>
0259                 <span class="keyword">else</span>
0260                     DoItAgainFlag = 1;
0261                 <span class="keyword">end</span>
0262             <span class="keyword">elseif</span> length(Inputs1) == 2
0263                 <span class="comment">% For ChannelName just set once</span>
0264             <span class="keyword">elseif</span> length(Inputs1) == 3
0265                 DoItAgainFlag = 1;
0266                 Inputs1{4} = [];
0267                 Inputs1{5} = 0;
0268             <span class="keyword">elseif</span> length(Inputs1) == 4
0269                 DoItAgainFlag = 1;
0270                 Inputs1{5} = 0;
0271             <span class="keyword">elseif</span> length(Inputs1) &gt;= 5
0272                 <span class="keyword">if</span> Inputs1{5} ~= 0
0273                     DoItAgainFlag = 1;
0274                     Inputs1{5} = 0;
0275                 <span class="keyword">end</span>
0276             <span class="keyword">end</span>
0277             
0278             <span class="comment">% Make the setpoint change</span>
0279             ErrorFlagNew = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Inputs1{:}, InputFlags{:});
0280             ErrorFlag = ErrorFlag | any(ErrorFlagNew);
0281         <span class="keyword">end</span>
0282     <span class="keyword">end</span>
0283 
0284     <span class="comment">% Wait for the waitflag</span>
0285     <span class="keyword">if</span> DoItAgainFlag
0286         <span class="keyword">for</span> i = 1:size(varargin{1},1)
0287             <span class="keyword">for</span> j = 1:size(varargin{1},2)
0288 
0289                 <span class="comment">% Build the input line</span>
0290                 <span class="keyword">for</span> k = 1:length(varargin)
0291                     <span class="keyword">if</span> ~iscell(varargin{k})
0292                         Inputs1{1,k} = varargin{k};
0293                     <span class="keyword">elseif</span> length(varargin{k}) == 1
0294                         Inputs1{1,k} = varargin{k}{1};
0295                     <span class="keyword">elseif</span> (size(varargin{k},1) == size(varargin{1},1)) &amp;&amp; (size(varargin{k},2) == size(varargin{1},2))
0296                         Inputs1{1,k} = varargin{k}{i,j};
0297                     <span class="keyword">else</span>
0298                         error(<span class="string">'When using cells, all the cells must be the same size or length 1 (repeated).'</span>);
0299                     <span class="keyword">end</span>
0300                 <span class="keyword">end</span>
0301 
0302                 <span class="comment">% Make the setpoint change</span>
0303                 ErrorFlagNew = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Inputs1{:}, InputFlags{:});
0304                 ErrorFlag = ErrorFlag | any(ErrorFlagNew);
0305             <span class="keyword">end</span>
0306         <span class="keyword">end</span>
0307     <span class="keyword">end</span>
0308 
0309     <span class="keyword">return</span>
0310 <span class="keyword">end</span>
0311 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0312 <span class="comment">% End cell input %</span>
0313 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0314 
0315 
0316 
0317 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0318 <span class="comment">% COMMONNAME - Commonname input with no family input %</span>
0319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0320 <span class="keyword">if</span> isempty(Family)
0321     <span class="comment">% Common names with Family = []</span>
0322     <span class="comment">% [], Field, NewSP, CommonNames</span>
0323     
0324     <span class="keyword">if</span> length(varargin) &gt;= 2
0325         <span class="keyword">if</span> ischar(varargin{2})
0326             Field = varargin{2};
0327             varargin(2) = [];
0328         <span class="keyword">end</span>
0329     <span class="keyword">end</span>
0330     <span class="keyword">if</span> isempty(Field)
0331         Field = FieldDefault;
0332     <span class="keyword">end</span>
0333     <span class="keyword">if</span> length(varargin) &gt;= 2
0334         NewSP = varargin{2};
0335     <span class="keyword">else</span>
0336         error(<span class="string">'New setpoint not found on input line'</span>);
0337     <span class="keyword">end</span>
0338     <span class="keyword">if</span> length(varargin) &gt;= 3
0339         CommonNames = varargin{3};
0340     <span class="keyword">else</span>
0341         CommonNames = [];
0342     <span class="keyword">end</span>
0343     <span class="keyword">if</span> length(varargin) &gt;= 4
0344         WaitFlag = varargin{4};
0345     <span class="keyword">end</span>
0346     <span class="keyword">if</span> isempty(WaitFlag)
0347         WaitFlag = WaitFlagDefault;
0348     <span class="keyword">end</span>
0349 
0350     <span class="keyword">if</span> size(NewSP,1) == 1
0351         <span class="comment">% Set all elements to same value</span>
0352         NewSP = ones(size(CommonNames,1),1) * NewSP;
0353     <span class="keyword">elseif</span> size(NewSP,1) == size(CommonNames,1)
0354         <span class="comment">% Input OK</span>
0355     <span class="keyword">else</span>
0356         error(<span class="string">'Size of NewSP must be equal to the number of Commonnames or a scalar!'</span>);
0357     <span class="keyword">end</span>
0358 
0359     <span class="comment">% Convert all the common names to Family and Device lists</span>
0360     [DeviceList, Family, ErrorFlag] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(CommonNames, Field);
0361 
0362     <span class="comment">% If all the families are the same then compress them</span>
0363     FamilyTest = unique(Family, <span class="string">'rows'</span>);
0364 
0365     <span class="keyword">if</span> size(FamilyTest, 1) == 1
0366         <span class="comment">% 1 Family, Multiple devices are ok</span>
0367         ErrorFlag = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(FamilyTest, Field, NewSP, DeviceList, WaitFlag, InputFlags{:});
0368     <span class="keyword">else</span>
0369         <span class="comment">% Multiple families (loop)</span>
0370         <span class="comment">% It has to be in a loop for the simulator and to pickup special functions</span>
0371         <span class="keyword">for</span> i = 1:size(Family,1)
0372             ErrorFlag1 = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Family(i,:), Field, NewSP(i,:), DeviceList(i,:), 0, InputFlags{:});
0373             ErrorFlag = ErrorFlag | ErrorFlag1;
0374         <span class="keyword">end</span>
0375         <span class="keyword">if</span> WaitFlag
0376             <span class="keyword">for</span> i = 1:size(Family,1)
0377                 ErrorFlag1 = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Family(i,:), Field, NewSP(i,:), DeviceList(i,:), WaitFlag, InputFlags{:});
0378                 ErrorFlag = ErrorFlag | ErrorFlag1;
0379             <span class="keyword">end</span>
0380         <span class="keyword">end</span>
0381     <span class="keyword">end</span>
0382     
0383     <span class="keyword">return</span>
0384 <span class="keyword">end</span>
0385 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0386 <span class="comment">% End CommonName input with no family input %</span>
0387 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0388 
0389 
0390 
0391 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0392 <span class="comment">% Parce inputs depending on Data structure, AO structure, Family, ChannelName method %</span>
0393 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0394 <span class="keyword">if</span> isstruct(Family)
0395     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0396     <span class="comment">% STRUCTURE INPUTS - Data structure or AO structure %</span>
0397     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0398     <span class="keyword">if</span> isfield(varargin{1},<span class="string">'FamilyName'</span>) &amp;&amp; isfield(varargin{1},<span class="string">'Field'</span>)
0399         <span class="comment">% setpv(DataStruct, Field, NewSP, WaitFlag)</span>
0400         <span class="comment">%   Select FamilyName, DeviceList, Units from the structure (if not on the input line)</span>
0401         <span class="comment">%   Mode in the structure is ignored</span>
0402         Family = varargin{1}.FamilyName;
0403 
0404         <span class="comment">% The only input for a Data Structure can Field and WaitFlag</span>
0405         Field = <span class="string">''</span>;
0406         <span class="keyword">if</span> length(varargin) &gt;= 2
0407             <span class="keyword">if</span> ischar(varargin{2})
0408                 Field = varargin{2};
0409                 varargin(2) = [];
0410             <span class="keyword">end</span>
0411         <span class="keyword">end</span>
0412         <span class="keyword">if</span> isempty(Field)
0413             Field = varargin{1}.Field;
0414         <span class="keyword">end</span>
0415 
0416         NewSP = varargin{1}.Data;
0417         DeviceList = varargin{1}.DeviceList;
0418 
0419         <span class="keyword">if</span> length(varargin) &gt;= 2
0420            WaitFlag = varargin{2};
0421         <span class="keyword">end</span>
0422 
0423         <span class="comment">%if length(varargin) &gt;= 2</span>
0424         <span class="comment">%    NewSP = varargin{2};</span>
0425         <span class="comment">%else</span>
0426         <span class="comment">%    NewSP = varargin{1}.Data;</span>
0427         <span class="comment">%end</span>
0428         <span class="comment">%if length(varargin) &gt;= 3</span>
0429         <span class="comment">%    DeviceList = varargin{3};</span>
0430         <span class="comment">%else</span>
0431         <span class="comment">%    DeviceList = varargin{1}.DeviceList;</span>
0432         <span class="comment">%end</span>
0433         <span class="comment">%if length(varargin) &gt;= 4</span>
0434         <span class="comment">%    WaitFlag = varargin{4};</span>
0435         <span class="comment">%end</span>
0436 
0437         [FamilyIndex, AO] = <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(Family);
0438 
0439         <span class="comment">% Change Units to the data structure units (command-line override comes latter)</span>
0440         <span class="keyword">if</span> isfield(AO, Field)
0441             AO.(Field).Units = varargin{1}.Units;
0442         <span class="keyword">end</span>
0443         
0444         <span class="keyword">if</span> FamilyIndex == 0
0445             error(<span class="string">'Unknown family in the data structure'</span>);
0446         <span class="keyword">end</span>
0447 
0448     <span class="keyword">elseif</span> isfield(varargin{1},<span class="string">'FamilyName'</span>)
0449         <span class="comment">% AO structure - use the AO structure directly</span>
0450         <span class="comment">% setpv(AO, Field, NewSP, DeviceList, WaitFlag)</span>
0451 
0452         Field = <span class="string">''</span>;
0453         <span class="keyword">if</span> length(varargin) &gt;= 2
0454             <span class="keyword">if</span> ischar(varargin{2})
0455                 Field = varargin{2};
0456                 varargin(2) = [];
0457             <span class="keyword">end</span>
0458         <span class="keyword">end</span>
0459         <span class="keyword">if</span> length(varargin) &gt;= 2
0460             NewSP = varargin{2};
0461         <span class="keyword">else</span>
0462             error(<span class="string">'New setpoint not found on input line'</span>);
0463         <span class="keyword">end</span>
0464         <span class="keyword">if</span> length(varargin) &gt;= 3
0465             DeviceList = varargin{3};
0466         <span class="keyword">else</span>
0467             DeviceList = varargin{1}.DeviceList;
0468             iStatus = find(varargin{1}.Status == 0);
0469             DeviceList(iStatus,:) = [];
0470         <span class="keyword">end</span>
0471         <span class="keyword">if</span> length(varargin) &gt;= 4
0472             WaitFlag = varargin{4};
0473         <span class="keyword">end</span>
0474 
0475         FamilyIndex = 1;
0476         AO = Family;
0477 
0478     <span class="keyword">else</span>
0479         error(<span class="string">'Input #1 of unknown type'</span>);
0480     <span class="keyword">end</span>
0481 
0482 <span class="keyword">else</span>
0483 
0484     <span class="comment">% Family or ChannelName/TangoName is the only thing left</span>
0485     [FamilyIndex, AO] = <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(Family);
0486 
0487     <span class="keyword">if</span> FamilyIndex
0488 
0489         <span class="comment">%%%%%%%%%%%%%%</span>
0490         <span class="comment">% FamilyName %</span>
0491         <span class="comment">%%%%%%%%%%%%%%</span>
0492         <span class="keyword">if</span> length(varargin) &gt;= 2
0493             <span class="keyword">if</span> ischar(varargin{2})
0494                 Field = varargin{2};
0495                 varargin(2) = [];
0496             <span class="keyword">end</span>
0497         <span class="keyword">end</span>
0498         <span class="keyword">if</span> isempty(Field)
0499             Field = FieldDefault;
0500         <span class="keyword">end</span>
0501         <span class="keyword">if</span> length(varargin) &gt;= 2
0502             NewSP = varargin{2};
0503         <span class="keyword">else</span>
0504             error(<span class="string">'New setpoint not found on input line'</span>);
0505         <span class="keyword">end</span>
0506         <span class="keyword">if</span> length(varargin) &gt;= 3
0507             DeviceList = varargin{3};
0508         <span class="keyword">end</span>
0509         <span class="keyword">if</span> length(varargin) &gt;= 4
0510             WaitFlag = varargin{4};
0511         <span class="keyword">end</span>
0512         <span class="keyword">if</span> isempty(WaitFlag)
0513             WaitFlag = WaitFlagDefault;
0514         <span class="keyword">end</span>
0515 
0516     <span class="keyword">else</span>
0517 
0518         <span class="comment">% Look to see if it's a channel name or a common name</span>
0519         <span class="comment">% Just check the first name so it's a faster test</span>
0520         [DeviceListTest, FamilyTest] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(Family(1,:));
0521 
0522         <span class="keyword">if</span> ~isempty(FamilyTest)
0523             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0524             <span class="comment">% Common names where the family was the common name %</span>
0525             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0526             
0527             <span class="comment">% The DeviceList should not be on the input line!</span>
0528 
0529             <span class="keyword">if</span> length(varargin) &gt;= 2
0530                 <span class="keyword">if</span> ischar(varargin{2})
0531                     Field = varargin{2};
0532                     varargin(2) = [];
0533                 <span class="keyword">end</span>
0534             <span class="keyword">end</span>
0535             <span class="keyword">if</span> isempty(Field)
0536                 Field = FieldDefault;
0537             <span class="keyword">end</span>
0538             <span class="keyword">if</span> length(varargin) &gt;= 2
0539                 NewSP = varargin{2};
0540             <span class="keyword">else</span>
0541                 error(<span class="string">'New setpoint not found on input line'</span>);
0542             <span class="keyword">end</span>
0543             <span class="keyword">if</span> length(varargin) &gt;= 3
0544                 WaitFlag = varargin{3};
0545             <span class="keyword">end</span>
0546             <span class="keyword">if</span> isempty(WaitFlag)
0547                 WaitFlag = WaitFlagDefault;
0548             <span class="keyword">end</span>
0549 
0550             CommonNames = Family;
0551 
0552             <span class="keyword">if</span> size(NewSP,1) == 1
0553                 <span class="comment">% Set all elements to same value</span>
0554                 NewSP = ones(size(CommonNames,1),1) * NewSP;
0555             <span class="keyword">elseif</span> size(NewSP,1) == size(CommonNames,1)
0556                 <span class="comment">% Input OK</span>
0557             <span class="keyword">else</span>
0558                 error(<span class="string">'Size of NewSP must be equal to the number of Commonnames or a scalar!'</span>);
0559             <span class="keyword">end</span>
0560 
0561             <span class="comment">% Convert all the common names to Family and Device lists</span>
0562             [DeviceList, Family, ErrorFlag] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(CommonNames);
0563 
0564             <span class="comment">% If all the families are the same then compress them</span>
0565             FamilyTest = unique(Family, <span class="string">'rows'</span>);
0566 
0567             <span class="keyword">if</span> size(FamilyTest, 1) == 1
0568                 <span class="comment">% 1 Family, Multiple devices are ok</span>
0569                 ErrorFlag = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(FamilyTest, Field, NewSP, DeviceList, WaitFlag, InputFlags{:});
0570             <span class="keyword">else</span>
0571                 <span class="comment">% Multiple families (loop)</span>
0572                 <span class="comment">% It has to be in a loop for the simulator and to pickup special functions</span>
0573                 <span class="keyword">for</span> i = 1:size(Family,1)
0574                     ErrorFlag1 = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Family(i,:), Field, NewSP(i,:), DeviceList(i,:), 0, InputFlags{:});
0575                     ErrorFlag = ErrorFlag | ErrorFlag1;
0576                 <span class="keyword">end</span>
0577                 <span class="keyword">if</span> WaitFlag
0578                     <span class="keyword">for</span> i = 1:size(Family,1)
0579                         ErrorFlag1 = <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(Family(i,:), Field, NewSP(i,:), DeviceList(i,:), WaitFlag, InputFlags{:});
0580                         ErrorFlag = ErrorFlag | ErrorFlag1;
0581                     <span class="keyword">end</span>
0582                 <span class="keyword">end</span>
0583             <span class="keyword">end</span>
0584                    
0585             <span class="comment">% Return for common names</span>
0586            <span class="keyword">return</span>
0587             
0588         <span class="keyword">else</span>
0589 
0590             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0591         <span class="comment">% CHANNEL NAME or TANGO NAME - Online Only %</span>
0592             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0593 
0594             <span class="comment">% setpv(ChannelName, Field, NewSP, WaitFlag)</span>
0595             <span class="comment">% setpv(ChannelName, Field, NewSP)</span>
0596             <span class="comment">% setpv(ChannelName, NewSP, WaitFlag)  % NewSP cannot be string for this case</span>
0597             <span class="comment">% setpv(ChannelName, NewSP)</span>
0598             Field = <span class="string">''</span>;
0599             <span class="keyword">if</span> length(varargin) == 2
0600                 <span class="comment">% setpv(ChannelName, NewSP)</span>
0601                 NewSP = varargin{2};
0602             <span class="keyword">elseif</span> length(varargin) &gt;= 3
0603                 <span class="keyword">if</span> ischar(varargin{2})
0604                     Field = varargin{2};
0605                     varargin(2) = [];
0606                 <span class="keyword">end</span>
0607                 NewSP = varargin{2};
0608             <span class="keyword">end</span>
0609 
0610             <span class="keyword">if</span> length(varargin) &gt;= 3
0611                 WaitFlag = varargin{3};
0612             <span class="keyword">else</span>
0613                 WaitFlag = [];
0614             <span class="keyword">end</span>
0615             <span class="keyword">if</span> isempty(WaitFlag)
0616                 WaitFlag = WaitFlagDefault;
0617             <span class="keyword">end</span>
0618 
0619             <span class="comment">% Don't set NaN's for now???</span>
0620             <span class="comment">%iNaN = find(isnan(NewSP));</span>
0621             <span class="comment">%if ~isempty(iNaN)</span>
0622             <span class="comment">%    Family(iNaN,:) = [];</span>
0623             <span class="comment">%    NewSP(iNaN,:) = [];</span>
0624             <span class="comment">%end</span>
0625 
0626         <span class="comment">% Can't use overrides with channel / TANGO name method</span>
0627             <span class="keyword">if</span> ~isempty(UnitsFlag)
0628             error(<span class="string">'You cannot change the units when using channel or attribute names.'</span>)
0629             <span class="keyword">end</span>
0630         <span class="keyword">if</span> ~(isempty(ModeFlag) | strcmpi(ModeFlag, <span class="string">'Online'</span>))
0631             error(<span class="string">'Channelor Tango names only have an ''Online'' Mode.'</span>)
0632             <span class="keyword">end</span>
0633 
0634         <span class="comment">% Get rid of repeated &amp; blank channel or attribute names</span>
0635             [Family, i] = unique(Family, <span class="string">'rows'</span>);
0636             <span class="keyword">if</span> size(NewSP,1) ~= 1
0637                 NewSP = NewSP(i,:);
0638             <span class="keyword">end</span>
0639             <span class="keyword">if</span> isempty(deblank(Family(1,:)))
0640                 Family(1,:) = [];
0641                 <span class="keyword">if</span> size(NewSP,1) ~= 1
0642                     NewSP(1,:) = [];
0643                 <span class="keyword">end</span>
0644             <span class="keyword">end</span>
0645 
0646             <span class="comment">% Add Field to Family.Field</span>
0647             <span class="keyword">if</span> ~isempty(Field)
0648                 Family = strcat(Family, [<span class="string">'.'</span>,Field]);
0649             <span class="keyword">end</span>
0650             
0651             <span class="comment">% Incremental change in the setpoint</span>
0652             <span class="keyword">if</span> IncrementalFlag
0653                 <span class="comment">% Note: ModeFlag, UnitsFlag are ignored for channel name inputs</span>
0654                 <span class="comment">%NewSP = NewSP + getpv(Family);</span>
0655                 <span class="keyword">if</span> size(NewSP,2) == 1
0656                     SPpresent = getpvonline(Family, <span class="string">''</span>, 1);
0657                 <span class="keyword">else</span>
0658                     SPpresent = getpvonline(Family);
0659                 <span class="keyword">end</span>
0660                 NewSP = NewSP + SPpresent;
0661             <span class="keyword">else</span>
0662                 <span class="keyword">if</span> size(NewSP,1) == 1 &amp;&amp; size(Family,1) &gt; 1
0663                     <span class="comment">% Set all elements to same value</span>
0664                     NewSP = NewSP * ones(size(Family,1),1);
0665                 <span class="keyword">end</span>
0666             <span class="keyword">end</span>
0667 
0668 
0669             <span class="comment">%%%%%%%%%%%%</span>
0670             <span class="comment">% Set data %</span>
0671             <span class="comment">%%%%%%%%%%%%</span>
0672             <span class="comment">% Could add N-Steps here???</span>
0673             ErrorFlag = setpvonline(Family, NewSP);
0674 
0675 
0676             <span class="comment">% Add a delay based on the WaitFlag</span>
0677             <span class="keyword">if</span> WaitFlag &gt; 0
0678                 sleep(WaitFlag);
0679             <span class="keyword">elseif</span> WaitFlag == -2
0680                 [N, BPMDelay] = getbpmaverages;
0681                 BPMDelay = 2.2 * max(BPMDelay);
0682                 <span class="keyword">if</span> ~isempty(BPMDelay)
0683                     sleep(BPMDelay);
0684                 <span class="keyword">end</span>
0685             <span class="keyword">elseif</span> WaitFlag == -3
0686                 TUNEDelay = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'TUNEDelay'</span>);
0687                 <span class="keyword">if</span> ~isempty(TUNEDelay)
0688                     sleep(TUNEDelay);
0689                 <span class="keyword">end</span>
0690             <span class="keyword">elseif</span> WaitFlag == -4
0691                 tmp = input(<span class="string">'   Setpoint changed.  Hit return ready. '</span>);
0692             <span class="keyword">end</span>
0693 
0694             <span class="keyword">return</span>
0695         <span class="keyword">end</span>
0696     <span class="keyword">end</span>
0697 <span class="keyword">end</span>
0698 <span class="comment">% End input selection:  data structure, AO structure, family, commonname, and channelname method</span>
0699 
0700 
0701 
0702 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0703 <span class="comment">% SET DATA FOR FAMILIES %</span>
0704 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0705 
0706 <span class="comment">% Family = FamilyName or AO structure with DeviceList or CommonName List</span>
0707 
0708 <span class="keyword">if</span> isempty(DeviceList)                   <span class="comment">% This is a very important line, it determines the default behavior</span>
0709     DeviceList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(Family);     <span class="comment">% Default behavior comes from family2dev</span>
0710     <span class="comment">%DeviceList = family2dev(Family,1);  % Good status only</span>
0711     <span class="comment">%DeviceList = AO.DeviceList;         % All devices</span>
0712 <span class="keyword">end</span>
0713 
0714 <span class="comment">% If DeviceList is a string it's a common name list</span>
0715 <span class="keyword">if</span> ischar(DeviceList)
0716     DeviceList = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(DeviceList, AO);
0717 <span class="keyword">end</span>
0718 
0719 <span class="comment">% Convert DeviceList format to ElementList format</span>
0720 <span class="keyword">if</span> (size(DeviceList,2) == 1)
0721     DeviceList = <a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>(Family, DeviceList);
0722 <span class="keyword">end</span>
0723 
0724 <span class="keyword">if</span> isempty(WaitFlag)
0725     WaitFlag = WaitFlagDefault;
0726 <span class="keyword">end</span>
0727 
0728 
0729 <span class="comment">% Look for command-line over rides</span>
0730 <span class="keyword">if</span> ~isempty(UnitsFlag)
0731     AO.(Field).Units = UnitsFlag;
0732 <span class="keyword">end</span>
0733 <span class="keyword">if</span> ~isempty(ModeFlag)
0734     AO.(Field).Mode = ModeFlag;
0735 <span class="keyword">end</span>
0736 
0737 
0738 <span class="keyword">if</span> size(NewSP,1) == 1 &amp;&amp; size(DeviceList,1) &gt; 1
0739     <span class="comment">% Set all elements to same value</span>
0740     NewSP = NewSP * ones(size(DeviceList,1),1);
0741 
0742 <span class="keyword">elseif</span> size(NewSP,1) ~= size(DeviceList,1)
0743     <span class="comment">% This is either an error or NewSP equals the number of power supplies (not magnets)</span>
0744     [DeviceList, ii, jj] = unique(DeviceList, <span class="string">'rows'</span>);
0745     [TangoNames, i, j] = unique(family2tango(Family, DeviceList), <span class="string">'rows'</span>);
0746     
0747     <span class="keyword">if</span> size(NewSP,1) == size(TangoNames,1)
0748         NewSP = NewSP(j);
0749         NewSP = NewSP(ii);
0750     <span class="keyword">else</span>
0751         error(<span class="string">'The number of setpoints does not equal the number of magnets or magnet power supplies.'</span>);
0752     <span class="keyword">end</span>
0753 <span class="keyword">end</span>
0754 
0755 
0756 <span class="comment">% Incremental change in the setpoint</span>
0757 <span class="keyword">if</span> IncrementalFlag
0758     NewSP = NewSP + <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Family, Field, DeviceList, AO.(Field).Units, AO.(Field).Mode);
0759 <span class="keyword">end</span>
0760 
0761 
0762 <span class="comment">% Main call for all applications except ChannelName / TangoName method</span>
0763 ErrorFlag = <a href="#_sub1" class="code" title="subfunction ErrorFlag = local_setpv(AO, Field, NewSP, DeviceList, WaitFlag)">local_setpv</a>(AO, Field, NewSP, DeviceList, WaitFlag);
0764 
0765 
0766 <span class="comment">%%%%%%%%%%%%%%%%</span>
0767 <span class="comment">% End of setpv %</span>
0768 <span class="comment">%%%%%%%%%%%%%%%%</span>
0769 <span class="keyword">return</span>
0770 
0771 
0772 
0773 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0774 <span class="comment">%  Main Function for Setting Data using the Accelerator Object  %</span>
0775 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0776 <a name="_sub1" href="#_subfunctions" class="code">function ErrorFlag = local_setpv(AO, Field, NewSP, DeviceList, WaitFlag)</a>
0777 <span class="comment">%  INPUTS</span>
0778 <span class="comment">%  1. AO - the ACCELERATOR_OBJECT structure for the called family</span>
0779 <span class="comment">%  2. Field - 'Monitor' or 'Setpoint'</span>
0780 <span class="comment">%  3. NewSP - setpoint values</span>
0781 <span class="comment">%  4. DeviceList - Device list</span>
0782 <span class="comment">%</span>
0783 <span class="comment">%  OUTPUTS</span>
0784 <span class="comment">%  1. ErrorFlag - 0 if OK, else 1</span>
0785 <span class="comment">%</span>
0786 <span class="comment">%  NOTES</span>
0787 <span class="comment">%  1. AO comes directly from the main AcceleratorObject family</span>
0788 <span class="comment">%  2. Field is which field to use</span>
0789 <span class="comment">%  3. DeviceList is which device list to use</span>
0790 <span class="comment">%  4. AO.DeviceList is the entire device list</span>
0791 <span class="comment">%</span>
0792 <span class="comment">%  Note: local_setpv can not be used for channel names</span>
0793 
0794 
0795 TimeOutPeriodOnWaitFlag = 10;  <span class="comment">% Seconds of monitor not changing</span>
0796 ErrorFlag = 0;
0797 
0798 
0799 <span class="comment">% Don't set NaN's for now???</span>
0800 iNaN = find(isnan(NewSP));
0801 <span class="keyword">if</span> ~isempty(iNaN)
0802     NewSP(iNaN,:) = [];
0803     DeviceList(iNaN,:) = [];
0804 <span class="keyword">end</span>
0805 
0806 
0807 <span class="comment">% Check for empty device list</span>
0808 <span class="keyword">if</span> isempty(DeviceList)
0809     AM = [];
0810     <span class="comment">%fprintf('   WARNING:  No devices to get for Family %s\n', AO.FamilyName));</span>
0811     <span class="keyword">return</span>;
0812 <span class="keyword">end</span>
0813 
0814 
0815 <span class="comment">% Find the index for where the desired data is in the total device list</span>
0816 DeviceListTotal = AO.DeviceList;
0817 [DeviceIndex, iNotFound] = findrowindex(DeviceList, DeviceListTotal);
0818 <span class="keyword">if</span> length(iNotFound) &gt; 0
0819     <span class="comment">% Device not found</span>
0820     <span class="keyword">for</span> i = 1:length(iNotFound)
0821         fprintf(<span class="string">'   No devices to get for Family %s(%d,%d)\n'</span>, AO.FamilyName, DeviceList(i,1), DeviceList(i,2));
0822     <span class="keyword">end</span>
0823     error(sprintf(<span class="string">'%d Devices not found'</span>, length(iNotFound)));
0824 <span class="keyword">end</span>
0825 
0826 
0827 <span class="comment">% If Field is not found in the AO, it is unclear what to do next.</span>
0828 <span class="comment">% I could error here, but it's convenient to try to set</span>
0829 <span class="comment">% EPICS subfields or other simulator fields at this point.</span>
0830 <span class="keyword">if</span> ~isfield(AO, Field)
0831     <span class="comment">% Try to check it online or simulator</span>
0832     <span class="keyword">if</span> isfield(AO, <span class="string">'Setpoint'</span>)
0833         Mode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(AO.FamilyName, <span class="string">'Setpoint'</span>, <span class="string">'Mode'</span>);
0834     <span class="keyword">elseif</span> isfield(AO, <span class="string">'Monitor'</span>)
0835         Mode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(AO.FamilyName, <span class="string">'Monitor'</span>, <span class="string">'Mode'</span>);
0836     <span class="keyword">else</span>
0837         Mode = <span class="string">''</span>;
0838     <span class="keyword">end</span>
0839     <span class="keyword">if</span> strcmpi(Mode,<span class="string">'Simulator'</span>) || strcmpi(Mode,<span class="string">'Model'</span>)
0840         ErrorFlag = setpvmodel(AO.FamilyName, Field, NewSP, DeviceList, <span class="string">'Physics'</span>);
0841         <span class="keyword">return</span>
0842     <span class="keyword">end</span>
0843 
0844 
0845     <span class="comment">% Try changing the suffix of the Monitor or Setpoint field</span>
0846     <span class="keyword">if</span> isfield(AO, <span class="string">'Setpoint'</span>)
0847         Tango = family2tango(AO, <span class="string">'Setpoint'</span>, DeviceList);
0848     <span class="keyword">elseif</span> isfield(AO, <span class="string">'Monitor'</span>)
0849         Tango = family2tango(AO, <span class="string">'Monitor'</span>, DeviceList);
0850     <span class="keyword">else</span>
0851         error(sprintf(<span class="string">'Field %s not found for Family %s'</span>, Field, AO.FamilyName));
0852     <span class="keyword">end</span>
0853     
0854     <span class="comment">% Get rid of repeated &amp; blank TANGO names</span>
0855     [Tango, i] = unique(Tango, <span class="string">'rows'</span>);
0856     <span class="keyword">if</span> size(NewSP,1) ~= 1
0857         NewSP = NewSP(i,:);
0858     <span class="keyword">end</span>
0859     <span class="keyword">if</span> isempty(deblank(Tango(1,:)))
0860         Tango(1,:) = [];
0861         <span class="keyword">if</span> size(NewSP,1) ~= 1
0862             NewSP(1,:) = [];
0863         <span class="keyword">end</span>
0864     <span class="keyword">end</span>
0865 
0866     <span class="keyword">if</span> any(strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),{<span class="string">'spear3'</span>,<span class="string">'spear'</span>}))
0867         <span class="comment">% Change the last ':' Field</span>
0868         <span class="comment">%i = findstr(Channel(1,:),':');</span>
0869         <span class="comment">%if ~isempty(i)</span>
0870         <span class="comment">%    Channel(:,i:end) = [];</span>
0871         <span class="comment">%end</span>
0872         <span class="comment">%ChannelNew = strcat(Channel, [':',Field]);</span>
0873 
0874         <span class="comment">% Since the location of &quot;:&quot; can be different in each row, loop</span>
0875         ChannelNew = [];
0876         <span class="keyword">for</span> j = 1:size(Channel,1)
0877             i = findstr(Channel(j,:),<span class="string">':'</span>);
0878             <span class="keyword">if</span> isempty(i)
0879                 <span class="comment">% I'm not sure what to do if &quot;:&quot; is missing, I'm just add a &quot;:&quot;</span>
0880                 ChannelNew = strvcat(ChannelNew, [Channel(j,1:i), <span class="string">':'</span>, Field]);
0881             <span class="keyword">else</span>
0882                 ChannelNew = strvcat(ChannelNew, [Channel(j,1:i), Field]);
0883             <span class="keyword">end</span>
0884         <span class="keyword">end</span>
0885         TangoNew = strcat(Tango, [<span class="string">':'</span>,Field]);
0886     <span class="keyword">else</span>
0887         <span class="comment">% Add a .Field</span>
0888         TangoNew = strcat(Tango, [<span class="string">'.'</span>,Field]);
0889     <span class="keyword">end</span>
0890     
0891     
0892     ErrorFlag = setpvonline(TangoNew, NewSP);
0893 
0894     <span class="keyword">if</span> WaitFlag &gt; 0
0895         sleep(WaitFlag);
0896     <span class="keyword">elseif</span> WaitFlag == -2
0897         [N, BPMDelay] = getbpmaverages;
0898         BPMDelay = 2.2 * max(BPMDelay);
0899         <span class="keyword">if</span> ~isempty(BPMDelay)
0900             sleep(BPMDelay);
0901         <span class="keyword">end</span>
0902     <span class="keyword">elseif</span> WaitFlag == -3
0903         TUNEDelay = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'TUNEDelay'</span>);
0904         <span class="keyword">if</span> ~isempty(TUNEDelay)
0905             sleep(TUNEDelay);
0906         <span class="keyword">end</span>
0907     <span class="keyword">elseif</span> WaitFlag == -4
0908         tmp = input(<span class="string">'   Setpoint changed.  Hit return ready. '</span>);
0909     <span class="keyword">end</span>
0910     <span class="keyword">return</span>
0911 <span class="keyword">end</span>
0912 
0913 
0914 <span class="comment">% Extract 'Mode'</span>
0915 <span class="keyword">if</span> isfield(AO.(Field), <span class="string">'Mode'</span>)
0916     Mode = AO.(Field).Mode;
0917 <span class="keyword">else</span>
0918     Mode = <span class="string">'Online'</span>;
0919 <span class="keyword">end</span>
0920 
0921 
0922 <span class="comment">% Check if Online should really be special</span>
0923 <span class="keyword">if</span> strcmpi(Mode, <span class="string">'Online'</span>)
0924    <span class="keyword">if</span> isfield(AO.(Field), <span class="string">'SpecialFunctionSet'</span>)
0925        Mode = <span class="string">'Special'</span>;
0926    <span class="keyword">end</span>
0927 <span class="keyword">end</span>
0928 
0929 
0930 <span class="keyword">if</span> ~isstruct(AO.(Field))
0931     <span class="comment">% If it's not a structure that just set the field</span>
0932     <span class="comment">% Hardward and physics get ignored</span>
0933     <a href="setfamilydata.html" class="code" title="function setfamilydata(Data, Family, Field1, Field2, DeviceList)">setfamilydata</a>(NewSP, AO.FamilyName, Field, DeviceList);
0934     
0935 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Online'</span>)
0936     <span class="comment">%%%%%%%%%%</span>
0937     <span class="comment">% Online %</span>
0938     <span class="comment">%%%%%%%%%%</span>
0939 
0940 
0941     <span class="comment">% Could add N-Steps here???</span>
0942 
0943     
0944     <span class="comment">% Change to hardware units if in physics units</span>
0945     <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Physics'</span>)
0946         NewSP = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(AO.FamilyName, Field, NewSP, DeviceList);
0947     <span class="keyword">end</span>
0948 
0949     <span class="keyword">if</span>  strcmpi(AO.(Field).DataType,<span class="string">'scalar'</span>)
0950         
0951         ErrorFlag = setpvonline(AO.(Field).TangoNames(DeviceIndex,:), NewSP);
0952         
0953     <span class="keyword">elseif</span>  strcmpi(AO.(Field).DataType,<span class="string">'vector'</span>)
0954         
0955         <span class="comment">% There can only be one Tango name for DataType='Vector'</span>
0956         TangName = deblank(AO.(Field).TangoNames(1,:));
0957         
0958         <span class="comment">% Get the vector and only load what is requested</span>
0959         FullVector = getpvonline(TangName);
0960         
0961         <span class="keyword">if</span> isfield(AO.(Field), <span class="string">'DataTypeIndex'</span>)
0962             FullVector(AO.(Field).DataTypeIndex(DeviceIndex)) = NewSP;
0963         <span class="keyword">else</span>
0964             FullVector(DeviceIndex) = NewSP;
0965         <span class="keyword">end</span>        
0966         
0967         <span class="comment">% Vectorized put</span>
0968         ErrorFlag = setpvonline(TangName, FullVector);
0969 
0970     <span class="keyword">else</span>       
0971         <span class="comment">% Not a scalar or vector</span>
0972         error(sprintf(<span class="string">'Unknown DataType %s for family %s.'</span>, AO.(Field).DataType, AO.FamilyName));
0973     <span class="keyword">end</span> 
0974     
0975     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0976     <span class="comment">% WaitFlag Processing %</span>
0977     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0978     <span class="keyword">if</span> WaitFlag &amp;&amp; WaitFlag~=-4
0979 
0980         t00 = gettime;
0981         [RunFlag, Delta0, Tol] = <a href="getrunflag.html" class="code" title="function [RunFlag, Delta, Tol] = getrunflag(varargin)">getrunflag</a>(AO, Field, DeviceList);
0982         RampRate = <a href="getramprate.html" class="code" title="function RampRate = getramprate(varargin)">getramprate</a>(AO, DeviceList, <span class="string">'Hardware'</span>);
0983 
0984         <span class="keyword">if</span> any(Tol == 0) || isempty(Tol)
0985             <span class="comment">% Tol should not be set to zero, but if it is then base time-out on percentage of SP</span>
0986             <span class="comment">% This many not be a good criterion and may need to be adjusted based on the machine!!!</span>
0987             TimeoutTol = NewSP / 200;   <span class="comment">% .5 percent</span>
0988         <span class="keyword">else</span>
0989             <span class="comment">% Check if the Delta has changed by at least a few tolerances in the last TimeOutPeriodOnWaitFlag seconds</span>
0990             <span class="comment">% This many not be a good criterion and may need to be adjusted based on the machine!!!</span>
0991             TimeoutTol = 5 * Tol;
0992 
0993             <span class="comment">% Or base on the ramprate</span>
0994             <span class="comment">%if ~isempty(RampRate) &amp; ~any(isnan(RampRate))</span>
0995             <span class="comment">%    RR = max(abs(RampRate));</span>
0996             <span class="comment">%    if ~isnan(RR)</span>
0997             <span class="comment">%        % Base time-out on .1 what the monitor should have changed in TimeOutPeriodOnWaitFlag seconds</span>
0998             <span class="comment">%        TimeoutTol = .1 * RR * TimeOutPeriodOnWaitFlag;</span>
0999             <span class="comment">%    end</span>
1000             <span class="comment">%end</span>
1001         <span class="keyword">end</span>
1002 
1003         t0  = gettime;
1004         <span class="keyword">while</span> any(RunFlag)
1005             <span class="comment">% Pause a little so that the network doesn't get too thrashed</span>
1006             sleep(.1);
1007 
1008             [RunFlag, Delta, Tol] = <a href="getrunflag.html" class="code" title="function [RunFlag, Delta, Tol] = getrunflag(varargin)">getrunflag</a>(AO, Field, DeviceList);
1009 
1010             <span class="comment">% Check if the Delta has changed in the last TimeOutPeriodOnWaitFlag seconds</span>
1011             <span class="keyword">if</span> gettime-t0 &gt; TimeOutPeriodOnWaitFlag
1012                 x = (abs(Delta) &gt; Tol) &amp; (abs(abs(Delta)-abs(Delta0)) &lt;= TimeoutTol);
1013                 <span class="keyword">if</span> any(x)
1014                     TangoName = <span class="string">''</span>;
1015                     <span class="keyword">for</span> i = 1:length(x)
1016                         <span class="keyword">if</span> x(i)
1017                             TangoNameNext = family2tango(AO.FamilyName,  DeviceList(i,:));
1018                             <span class="keyword">if</span> ~strcmp(TangoName, TangoNameNext)
1019                                 <span class="keyword">if</span> isfield(AO,<span class="string">'Monitor'</span>) &amp; isfield(AO,<span class="string">'Setpoint'</span>)
1020                                     fprintf(<span class="string">'   %s(%d,%d) SP-AM &gt; Tol and the monitor does not appear to be changing.\n'</span>, AO.FamilyName,  DeviceList(i,1), DeviceList(i,2));
1021                                     SP = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(AO.FamilyName,  DeviceList(i,:));
1022                                     AM = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(AO.FamilyName,  DeviceList(i,:));
1023                                     fprintf(<span class="string">'           Setpoint = %f,  Monitor = %f,  SP-AM = %f,  getrunflag Delta = %f,  Tolerance = %f\n'</span>, SP, AM, SP-AM, Delta(i), Tol(i));
1024                                 <span class="keyword">else</span>
1025                                     fprintf(<span class="string">'   %s(%d,%d) timed-out waiting for run flag to change.\n'</span>, AO.FamilyName,  DeviceList(i,1), DeviceList(i,2));
1026                                 <span class="keyword">end</span>
1027                             <span class="keyword">end</span>
1028                             TangoName = TangoNameNext;
1029                         <span class="keyword">end</span>
1030                     <span class="keyword">end</span>
1031 
1032                     <span class="comment">% Decide whether or not to error on a SP-AM problem</span>
1033                     ErrorWarningLevel = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'ErrorWarningLevel'</span>);
1034                     <span class="keyword">if</span> isempty(ErrorWarningLevel) || ErrorWarningLevel &gt;= 0
1035                         error(sprintf(<span class="string">'Time-Out:  Monitor did not appear to be changing for the last %.1f seconds.'</span>, TimeOutPeriodOnWaitFlag));
1036                     <span class="keyword">elseif</span> ErrorWarningLevel == -1
1037                         warning(<span class="string">'Time-Out:  Monitor did not appear to be changing for the last %.1f seconds.'</span>, TimeOutPeriodOnWaitFlag);
1038                     <span class="keyword">elseif</span> ErrorWarningLevel == -2
1039                         <span class="keyword">try</span>
1040                             <span class="comment">% Make some noise</span>
1041                             sound(cos(1:10000));
1042                         <span class="keyword">catch</span>
1043                         <span class="keyword">end</span>
1044                         CommandInput = questdlg( <span class="keyword">...</span>
1045                             {<span class="string">'The run flag is not changing.  This is often a'</span>, <span class="keyword">...</span>
1046                              <span class="string">'Setpoint-Monitor tolerance problem.  Either manually'</span>, <span class="keyword">...</span>
1047                              <span class="string">'varify that the magnet is at the proper setpoint and'</span>, <span class="keyword">...</span>
1048                              <span class="string">' '</span>, <span class="keyword">...</span>
1049                              <span class="string">'Continue - recheck the run condition'</span>, <span class="keyword">...</span>
1050                              <span class="string">'Stop - issue an error and see if there is error handling'</span>, <span class="keyword">...</span>
1051                              <span class="string">'Ignore the problem and push on'</span>}, <span class="keyword">...</span>
1052                             <span class="string">'SETPV Question'</span>, <span class="keyword">...</span>
1053                             <span class="string">'Continue'</span>, <span class="keyword">...</span>
1054                             <span class="string">'Stop'</span>, <span class="keyword">...</span>
1055                             <span class="string">'Ignore'</span>, <span class="keyword">...</span>
1056                             <span class="string">'Continue'</span>);
1057                         <span class="keyword">switch</span> CommandInput
1058                             <span class="keyword">case</span> <span class="string">'Stop'</span>
1059                                 error(<span class="string">'SP-AM error in setpv.'</span>);
1060                             <span class="keyword">case</span> <span class="string">'Continue'</span>
1061                             <span class="keyword">case</span> <span class="string">'Ignore'</span>
1062                                 RunFlag = 0;
1063                         <span class="keyword">end</span>
1064                     <span class="keyword">else</span> <span class="comment">% ErrorWarningLevel &lt;= -3</span>
1065                         <span class="comment">% Do nothing</span>
1066                         ErrorFlag = -1;
1067                     <span class="keyword">end</span>
1068                 <span class="keyword">end</span>
1069 
1070                 <span class="comment">% Reset Delta0 and timeout timer</span>
1071                 Delta0 = Delta;
1072                 t0 = gettime;
1073             <span class="keyword">end</span>
1074         <span class="keyword">end</span>
1075 
1076         <span class="comment">% Add extra delay for continued ramping due to the size of the tolerance</span>
1077         <span class="keyword">if</span> isempty(Tol) &amp;&amp; isempty(Delta0)
1078             <span class="comment">% If Tol and Delta) are empty, then WaitFlag is probably not wanted</span>
1079             <span class="comment">%if WaitFlag &lt; 0</span>
1080             <span class="comment">%    WaitFlag = 0;</span>
1081             <span class="comment">%end</span>
1082         <span class="keyword">else</span>
1083             <span class="comment">% In case Tol is large, use the min of Tol and the present Delta SP-AM</span>
1084             <span class="keyword">if</span> any(isnan(RampRate))
1085                 <span class="comment">% For lack of a better idea: If the RampRate is not defined, calculate what it has been doing.</span>
1086                 iNaN = find(isnan(RampRate));
1087                 RampRate(iNaN) = abs(Delta0(iNaN) / (gettime-t00));
1088             <span class="keyword">end</span>
1089             <span class="keyword">if</span> isempty(RampRate)
1090                 <span class="comment">% For lack of a better idea: If the RampRate is not defined, calculate what it has been doing.</span>
1091                 RampRate = abs(Delta0 / (gettime-t00));
1092             <span class="keyword">end</span>
1093             <span class="keyword">if</span> any(RampRate == 0)
1094             <span class="keyword">else</span>
1095                 T = min([(Tol./RampRate) abs(Delta0./RampRate)],[],2);
1096                 <span class="keyword">if</span> ~isempty(max(T))
1097                     sleep(1.05*max(T));
1098                 <span class="keyword">end</span>
1099             <span class="keyword">end</span>
1100         <span class="keyword">end</span>
1101     <span class="keyword">end</span>
1102     
1103     <span class="keyword">if</span> WaitFlag &amp;&amp; ~strcmpi(Mode,<span class="string">'Simulator'</span>)
1104         <span class="comment">% Add a delay based on the WaitFlag</span>
1105         <span class="keyword">if</span> WaitFlag &gt; 0
1106             sleep(WaitFlag);
1107         <span class="keyword">elseif</span> WaitFlag == -2
1108             [N, BPMDelay] = getbpmaverages;
1109             BPMDelay = 2.2 * max(BPMDelay);
1110             <span class="keyword">if</span> ~isempty(BPMDelay)
1111                 sleep(BPMDelay);
1112             <span class="keyword">end</span>
1113         <span class="keyword">elseif</span> WaitFlag == -3
1114             TUNEDelay = 2.2 * <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'TUNEDelay'</span>);
1115             <span class="keyword">if</span> ~isempty(TUNEDelay)
1116                 sleep(TUNEDelay);
1117             <span class="keyword">end</span>
1118         <span class="keyword">elseif</span> WaitFlag == -4
1119             tmp = input(<span class="string">'   Setpoint changed.  Hit return ready. '</span>);
1120         <span class="keyword">end</span>
1121     <span class="keyword">end</span>
1122 
1123 
1124 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Manual'</span>)
1125     <span class="comment">%%%%%%%%%%%%%%%</span>
1126     <span class="comment">% Manual mode %</span>
1127     <span class="comment">%%%%%%%%%%%%%%%</span>
1128     
1129     <span class="comment">% Change to hardware units if in physics units</span>
1130     <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Physics'</span>)
1131         NewSP = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(AO.FamilyName, Field, NewSP, DeviceList);
1132     <span class="keyword">end</span>
1133 
1134     <span class="comment">% NewSP is always in hardware units at this point</span>
1135     <span class="keyword">for</span> i = 1:length(DeviceIndex)
1136         <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Hardware'</span>)
1137             fprintf(<span class="string">'   Manually set:  %s(%d,%d) = %f [%s]\n'</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), NewSP(i), AO.(Field).HWUnits);
1138         <span class="keyword">else</span>
1139             NewSP(i) = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(AO.FamilyName, Field, NewSP(i), AO.DeviceList(DeviceIndex(i),:));
1140             fprintf(<span class="string">'   Manually set:  %s(%d,%d) = %f [%s]\n'</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), NewSP(i), AO.(Field).PhysicsUnits);
1141         <span class="keyword">end</span>
1142     <span class="keyword">end</span>
1143     <span class="keyword">if</span> length(NewSP) == 1
1144         input(sprintf(<span class="string">'   Set device manually and hit return '</span>));
1145     <span class="keyword">else</span>
1146         input(sprintf(<span class="string">'   Set these devices manually and hit return '</span>));
1147     <span class="keyword">end</span>    
1148     fprintf(<span class="string">'   \n'</span>);
1149 
1150     <span class="comment">%if strcmp(AO.FamilyName, 'RF')</span>
1151     <span class="comment">%    input(sprintf('   Manually set the RF frequency to %f [MHz] and hit return.', NewSP));</span>
1152     <span class="comment">%else</span>
1153     <span class="comment">%    for i = 1:length(DeviceIndex)</span>
1154     <span class="comment">%        fprintf('   Manually set:  %s(%d,%d) = %f\n', AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), NewSP(i));</span>
1155     <span class="comment">%    end</span>
1156     <span class="comment">%    input(sprintf('   Set these devices manually and hit return.'));</span>
1157     <span class="comment">%end</span>
1158     
1159 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Special'</span>)
1160     <span class="comment">%===================================</span>
1161     <span class="comment">% Special mode (evaluate a function)</span>
1162     <span class="comment">%===================================</span>
1163     
1164     <span class="comment">% Could add N-Steps here???</span>
1165 
1166     <span class="comment">% Change to hardware units if in physics units</span>
1167     <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Physics'</span>)
1168         NewSP = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(AO.FamilyName, Field, NewSP, DeviceList);
1169     <span class="keyword">end</span>
1170     
1171     <span class="keyword">if</span> isfield(AO.(Field), <span class="string">'SpecialFunctionSet'</span>)
1172         ErrorFlag = feval(AO.(Field).SpecialFunctionSet, AO.FamilyName, Field, NewSP, DeviceList, WaitFlag); 
1173     <span class="keyword">else</span>
1174         error(sprintf(<span class="string">'No special function specified for Family %s (setpv).'</span>, AO.FamilyName));
1175     <span class="keyword">end</span>
1176     
1177 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Simulator'</span>)
1178     <span class="comment">%==================</span>
1179     <span class="comment">% AT simulator mode</span>
1180     <span class="comment">%==================</span>
1181     
1182     ErrorFlag = setpvmodel(AO, Field, NewSP, DeviceList, AO.(Field).Units);
1183     
1184 <span class="keyword">else</span>
1185     error(sprintf(<span class="string">'Unknown mode % for family %s.'</span>, Mode, AO.FamilyName));
1186 <span class="keyword">end</span>
1187 
1188 
1189 
1190 
1191 <span class="comment">% Old Cell Input Method</span>
1192 
1193 <span class="comment">%     if length(varargin) == 1</span>
1194 <span class="comment">%         % One data structure input (NewSP contained in data structure)</span>
1195 <span class="comment">%         % Call without WaitFlag, then set with WaitFlag</span>
1196 <span class="comment">%         for i = 1:length(Family)</span>
1197 <span class="comment">%             setpv(Family{i}, 0);</span>
1198 <span class="comment">%         end</span>
1199 <span class="comment">%</span>
1200 <span class="comment">%         % Then set with default WaitFlag</span>
1201 <span class="comment">%         for i = 1:length(Family)</span>
1202 <span class="comment">%             setpv(Family{i});</span>
1203 <span class="comment">%         end</span>
1204 <span class="comment">%         return</span>
1205 <span class="comment">%     end</span>
1206 <span class="comment">%</span>
1207 <span class="comment">%     % For (DataStructure, WaitFlag) or (ChannelName, NewSP) inputs</span>
1208 <span class="comment">%     if length(varargin) == 2</span>
1209 <span class="comment">%         if isstruc(Family)</span>
1210 <span class="comment">%             % Data structure input</span>
1211 <span class="comment">%             if iscell(Field)</span>
1212 <span class="comment">%                 if length(Family) ~= length(Field)</span>
1213 <span class="comment">%                     error('If WaitFlag is a cell array it must be the same size as DataStructure');</span>
1214 <span class="comment">%                 end</span>
1215 <span class="comment">%             end</span>
1216 <span class="comment">%</span>
1217 <span class="comment">%             % Call without WaitFlag, then set with WaitFlag</span>
1218 <span class="comment">%             for i = 1:length(Family)</span>
1219 <span class="comment">%                 setpv(Family{i}, 0);</span>
1220 <span class="comment">%             end</span>
1221 <span class="comment">%             for i = 1:length(Family)</span>
1222 <span class="comment">%                 if iscell(Field)</span>
1223 <span class="comment">%                     setpv(Family{i}, Field{i});</span>
1224 <span class="comment">%                 else</span>
1225 <span class="comment">%                     setpv(Family{i}, Field);</span>
1226 <span class="comment">%                 end</span>
1227 <span class="comment">%             end</span>
1228 <span class="comment">%         else</span>
1229 <span class="comment">%             % ChannelName input</span>
1230 <span class="comment">%             if iscell(Field)</span>
1231 <span class="comment">%                 if length(Family) ~= length(Field)</span>
1232 <span class="comment">%                     error('Family and NewSP must be the same size cell arrays');</span>
1233 <span class="comment">%                 end</span>
1234 <span class="comment">%             else</span>
1235 <span class="comment">%                 error('NewSP must be a cell array');</span>
1236 <span class="comment">%             end</span>
1237 <span class="comment">%             for i = 1:length(Family)            % call setpv recursively for each cell</span>
1238 <span class="comment">%                 if iscell(Field)</span>
1239 <span class="comment">%                     setpv(Family{i}, Field{i});</span>
1240 <span class="comment">%                 else</span>
1241 <span class="comment">%                     setpv(Family{i}, Field);</span>
1242 <span class="comment">%                 end</span>
1243 <span class="comment">%             end</span>
1244 <span class="comment">%         end</span>
1245 <span class="comment">%         return</span>
1246 <span class="comment">%     end</span>
1247 <span class="comment">%</span>
1248 <span class="comment">%</span>
1249 <span class="comment">%     % 3 or greater inputs implies a Family method</span>
1250 <span class="comment">%     if length(varargin) &lt; 3</span>
1251 <span class="comment">%         error('Must have at least 3 inputs when using cells with families');</span>
1252 <span class="comment">%     end</span>
1253 <span class="comment">%</span>
1254 <span class="comment">%</span>
1255 <span class="comment">%     % If Field is a cell it must be the same size as Family</span>
1256 <span class="comment">%     if iscell(Field)</span>
1257 <span class="comment">%         if length(Family) ~= length(Field)</span>
1258 <span class="comment">%             error('If Field is a cell it must be the same size as Family');</span>
1259 <span class="comment">%         end</span>
1260 <span class="comment">%     end</span>
1261 <span class="comment">%</span>
1262 <span class="comment">%     % NewSP must a cell array equal to the length of Family</span>
1263 <span class="comment">%     if ~iscell(NewSP)</span>
1264 <span class="comment">%         error('If Family is a cell array, then NewSP must be a cell array');</span>
1265 <span class="comment">%     end</span>
1266 <span class="comment">%     if length(Family) ~= length(NewSP)</span>
1267 <span class="comment">%         error('Family and NewSP must be the same size cell arrays');</span>
1268 <span class="comment">%     end</span>
1269 <span class="comment">%</span>
1270 <span class="comment">%     if length(varargin) &gt;= 4</span>
1271 <span class="comment">%         % DeviceList must a cell array equal to the length of Family</span>
1272 <span class="comment">%         if ~iscell(DeviceList)</span>
1273 <span class="comment">%             error('If Family is a cell array, then DeviceList must be a cell array');</span>
1274 <span class="comment">%         end</span>
1275 <span class="comment">%         if length(Family) ~= length(DeviceList)    % same number of DeviceLists as Families</span>
1276 <span class="comment">%             error('Family and DeviceList must be the same size cell arrays');</span>
1277 <span class="comment">%         end</span>
1278 <span class="comment">%     end</span>
1279 <span class="comment">%</span>
1280 <span class="comment">%     if length(varargin) &gt;= 5</span>
1281 <span class="comment">%         % If WaitFlag is a cell it must be the same size as Family</span>
1282 <span class="comment">%         if iscell(WaitFlag)</span>
1283 <span class="comment">%             if length(Family) ~= length(WaitFlag)</span>
1284 <span class="comment">%                 error('If WaitFlag is a cell it must be the same size as Family');</span>
1285 <span class="comment">%             end</span>
1286 <span class="comment">%         end</span>
1287 <span class="comment">%     end</span>
1288 <span class="comment">%</span>
1289 <span class="comment">%     % First set everything without WaitFlag  (still cell array of Families)</span>
1290 <span class="comment">%     for i = 1:length(Family)</span>
1291 <span class="comment">%         if nargin &gt;= 4</span>
1292 <span class="comment">%            DeviceList = family2dev(Family{i});     % Default behavior comes from family2dev</span>
1293 <span class="comment">%            %DeviceList = family2dev(Family{i},1);  % Good status only</span>
1294 <span class="comment">%             if iscell(Field)</span>
1295 <span class="comment">%                 setpv(Family{i}, Field{i}, NewSP{i}, DeviceList{i}, 0);</span>
1296 <span class="comment">%             else</span>
1297 <span class="comment">%                 setpv(Family{i}, Field, NewSP{i}, DeviceList{i}, 0);</span>
1298 <span class="comment">%             end</span>
1299 <span class="comment">%         else  % only 2 inputs specified (2 inputs finished above)</span>
1300 <span class="comment">%             if iscell(Field)</span>
1301 <span class="comment">%                 setpv(Family{i}, Field{i}, NewSP{i}, [], 0);</span>
1302 <span class="comment">%             else</span>
1303 <span class="comment">%                 setpv(Family{i}, Field, NewSP{i}, [], 0);</span>
1304 <span class="comment">%             end</span>
1305 <span class="comment">%         end  % end nargin &gt;= 4</span>
1306 <span class="comment">%     end % end loop on Families without WaitFlag</span>
1307 <span class="comment">%</span>
1308 <span class="comment">%     % Then check for WaitFlag</span>
1309 <span class="comment">%     for i = 1:length(Family)</span>
1310 <span class="comment">%         if nargin == 3 % assumes default WaitFlag</span>
1311 <span class="comment">%             if iscell(Field)</span>
1312 <span class="comment">%                 ErrorFlag{i} = setpv(Family{i}, Field{i}, NewSP{i});</span>
1313 <span class="comment">%             else</span>
1314 <span class="comment">%                 ErrorFlag{i} = setpv(Family{i}, Field, NewSP{i});  % single entry for field</span>
1315 <span class="comment">%             end</span>
1316 <span class="comment">%         elseif nargin == 4</span>
1317 <span class="comment">%             if iscell(Field)</span>
1318 <span class="comment">%                 ErrorFlag{i} = setpv(Family{i}, Field{i}, NewSP{i}, DeviceList{i});</span>
1319 <span class="comment">%             else</span>
1320 <span class="comment">%                 ErrorFlag{i} = setpv(Family{i}, Field, NewSP{i}, DeviceList{i}); % single entry for field</span>
1321 <span class="comment">%             end</span>
1322 <span class="comment">%         else  % must be nargin == 5 because nargin == 2 complete above</span>
1323 <span class="comment">%             if iscell(Field)</span>
1324 <span class="comment">%                 if iscell(WaitFlag)</span>
1325 <span class="comment">%                     ErrorFlag{i} = setpv(Family{i}, Field{i}, NewSP{i}, DeviceList{i}, WaitFlag{i});</span>
1326 <span class="comment">%                 else</span>
1327 <span class="comment">%                     ErrorFlag{i} = setpv(Family{i}, Field{i}, NewSP{i}, DeviceList{i}, WaitFlag);</span>
1328 <span class="comment">%                 end</span>
1329 <span class="comment">%             else</span>
1330 <span class="comment">%                 if iscell(WaitFlag)</span>
1331 <span class="comment">%                     ErrorFlag{i} = setpv(Family{i}, Field, NewSP{i}, DeviceList{i}, WaitFlag{i});</span>
1332 <span class="comment">%                 else</span>
1333 <span class="comment">%                     ErrorFlag{i} = setpv(Family{i}, Field, NewSP{i}, DeviceList{i}, WaitFlag);</span>
1334 <span class="comment">%                 end</span>
1335 <span class="comment">%             end</span>
1336 <span class="comment">%         end</span>
1337 <span class="comment">%     end %end second loop over families with WaitFlag</span>
1338 <span class="comment">%     return</span>
1339 
1340</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>