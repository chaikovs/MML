<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of setorbit</title>
  <meta name="keywords" content="setorbit">
  <meta name="description" content="SETORBIT - Orbit correction function">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; setorbit.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>setorbit
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>SETORBIT - Orbit correction function</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">SETORBIT - Orbit correction function
  Family/DeviceList method:
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, NIter, SVDIndex, BPMWeight);

  Data structure method:
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMstruct,             CMstruct,            NIter, SVDIndex, BPMWeight);

  Use cell arrays for multiple family correction (like coupled planes):
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbitCell, BPMcell, CMcell, NIter, SVDIndex, BPMWeight);
  Note: BPMcell and CMcell must be a data structures when using cell arrays (GoalOrbitCell can be a cell or a string)

  Orbit Correction Structure (OCS) method:
  [CM, OCS0, V, Svalues] = setorbit(OCS, NIter, SVDIndex, BPMWeight);

  INPUTS
  1. GoalOrbit - Goal orbit (vector or cell array)
                'Golden' for the golden orbit {Default}
                'Offset' for the offset orbit
  2. BPM - BPM data structure (or cell array of structures)
     or BPMFamily and BPMDevList
  3. CM - Corrector magnet data structure (or cell array of structures)
     or CMFamily and CMDevList
  4. SVDIndex - vector, maximum number, 'All', or
                base on a threshold of min/max singular value {Default: 1e-3}
  5. NIter - Number of iterations  {Default: 1}
            (NIter can be 0, see note 1 below)
  6. BPMWeight - Weight applied to the BPMs (OCS.BPMWeight)
  7. FLAGS  - 'Abs' or 'Inc' - GoalOrbit is an absolute or incremental change {Default: 'Abs'}
                               ('Absolute' or 'Incremental' can also be used)
              'CorrectorGain', Gain - Scale the correction by Gain {Default: 1}
              'Display' - plot orbit information before applying the correction
              'FigureHandles' followed by a vector of 1 or 2 elements for figure handles and
                                                      4 or 8 elements for axes handles.
              'FitRF' or 'SetRF' - Fit and change the RF frequency
                   'GoldenDisp' - Use the golden dispersion {Default}
                   'MeasDisp'   - Measure the dispersion 
                   'ModelDisp'  - Calculate the model dispersion
              'GetPV' or 'NoGetPV' - Get new data or use the data already in the OCS {Default: 'GetPV' (for the first iteration)}
                                     This allows one make a correction based on data already checked and analyzed.
                                     ('GetAM' or 'NoGetAM' does the same thing)
              'GoldenResp' or 'ModelResp' - Golden BPM response or calculate from the model {Default: 'GoldenResp'} 
              'SetPV' or 'NoSetPV' - Set or don't set the correctors and RF {Default: 'SetSP'}
                                    'NoSetPV' does the calculation without making the correction.  That way one can
                                     take a look at the expected correction results before applying them.
                                     ('SetSP' or 'NoSetSP' does the same thing)
              'Tolerance', Tol - Quit correction if the std(error) &lt; Tol {Tol: 0}
              'RampSteps', NSteps - Number of steps to ramp in the correction {NSteps: 1}
                                    This is used to avoid a large transient between setpoint changes.
                                    Note: NSteps is only used on the first iteration.
              'FitRF','SetRF','RFCorrector'                       - Set the RF frequency (Eta Column)
              'FitRFHCM0','FitRFEnergy','SetRFHCM0','SetRFEnergy' - Set the RF frequency (HCM energy constraint)
              'FitRFDeltaHCM0','SetRFDeltaHCM0'                   - Set the RF frequency (Delta HCM energy constraint)
              'FitRFDispersionOrbit','SetRFDispersionOrbit'       - Set the RF frequency (Dispersion orbit constraint)
              'FitRFDispersionHCM','SetRFDispersionHCM'           - Set the RF frequency (Dispersion correction constraint)
              The usual Units and Mode flags can also be used.
              Flags are not case sensitive

  OUTPUTS
  1. OCS    - New orbit correction structure (OCS)
  2. OCS0   - Starting OCS
  3. V      - Corrector magnet singular vectors
  4. Svalue - Singular values (vector)

  ALGORITHM
  SVD orbit correction:
  Decompose the response matrix, Rmat:
    [U, S, V] = svd(Rmat);

  The V matrix columns are the singular vectors in the corrector magnet space
  The U matrix columns are the singular vectors in the BPM space
    Rmat = U * S = Rmat * V

  Modify the response matrix by removing singular vector with small singular values
    Rmod = U(:,SVDIndex) * S(SVDIndex,SVDIndex) = Rmat * V(:,SVDIndex)

  Only project (least squares) on to the modified response matrix
    b = inv(Rmod'*Rmod)*Rmod' * (GoalOrbit - PresentOrbit);
  Or
    b = Rmod \ (GoalOrbit - PresentOrbit);

  The b coefficients are in terms of the singular vectors.
  The corrector strengths come from the linear combination of the singular vectors
    DeltaCM = V(:,SVDIndex) * b;

  ORBIT CORRECTION STRUCTURE (OCS)
    OCS.BPM (Data structure or cell array of data structures)
    OCS.CM  (Data structure or cell array of data structures)
    OCS.GoalOrbit
    OCS.NIter         - Number of correction iterations
    OCS.NCorrections  - Number of corrections actually done
    OCS.Tolerance     - Tolerance level to quit iterating
    OCS.RampSteps     - Number of steps to ramp in the each correction
    OCS.SVDIndex
    OCS.FitRF         - Methods for RF correction
                        1 Standard way with no constraints
                        2 Sum of the energy change to zero Also remove the
                          energy change due to the present corrector setpoints
                        3 Sum of the energy change to zero
                          remove energy change due to the incremental change in the correctors
                        4 Constraint: dot(DispersionX,   Smat * dHCM) = 0
                        5 Constraint: dot(HCM(Dispersion), dHCM) = 0
    OCS.RF
    OCS.DeltaRF
    OCS.Display
    OCS.Incremental   - GoalOrbit is an incremental change from the present (1) or absolute (0) {Default: 0}
    OCS.CorrectorGain - Scales the correction (usually used in slow feedback)
    OCS.BPMWeight     - Row    weights on the response matrix
    OCS.CMWeight      - Column weights on the response matrix
    OCS.Flags = {}

  EXAMPLES
  1. The default behavior us horizontal and vertical (coupled) orbit correction to the golden orbit
     setorbit;
     is equivalent to
     x = getx('struct');
     y = gety('struct');
     hcm = getsp('HCM','struct');
     vcm = getsp('VCM','struct');
     setorbit('Golden', {x,y}, {hcm,vcm});

  2. Horizontal orbit correction with the follow criterion:
     a. Correct to the golden orbit
     b. Use the first 10 singular values
     c. Display results

     x = getx([1 1;1 2;12 1; 13 4],'struct');
     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');
     setorbit('Golden', x, hcm, 10, 'Display');

  3. Horizontal and vertical (coupled) orbit correction to the golden orbit (display results)
     x = getx([1 1;1 2;12 1; 13 4],'struct');
     y = gety([1 1;1 2;12 1; 13 4],'struct');
     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');
     vcm = getsp('VCM',[3 1;4 1;9 1;10 1],'struct');
     setorbit('Golden', {x,y}, {hcm,vcm}, 'Display');

  NOTES
  1. Incremental orbit changes with more then one iteration are treated algorithmically
     just like absolute orbit changes.  For a 1 iteration incremental orbit change
     BPM data is not needed and hence not used.  However, if one uses the
     'Display' flag then BPM data is used to show results.  If BPM data is not
     available and one wants to still display corrector and estimated orbit
     information then use the special mode: 'Inc', 'Display', NIter=0.
  2. The 'Display' flag only displays the first iteration and the final result.
     Intermediate iterations (if used) are not displayed.
  3. If horizontal and vertical corrector are used, then the
     coupling terms in the response matrix will be used.
     To avoid using coupling terms, use separate calls.
  4. OCS0.CM.Data is the corrector strength before setorbit ran
     OCS.CM.Data  is the corrector strength after  setorbit ran
     Hence, DeltaCM = OCS.CM.Data - OCS0.CM.Data;
     However, if the 'NoSetSP' flag was used, then no correction was done and
     OCS.CM.Data=OCS0.CM.Data (ie, the present corrector strength).  To apply
     the correction, use OCS.CM.Data + OCS.CM.Delta

  See also <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>, <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>, setorbitgui, <a href="rmdisp.html" class="code" title="function [DeltaRF, BPM, c, DispOrbit] = rmdisp(varargin)">rmdisp</a>, <a href="plotcm.html" class="code" title="function [DeltaRF, HCMEnergyChangeTotal, DeltaL] = plotcm(varargin)">plotcm</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>	FAMILY2DATASTRUCTURE - Returns a datastructure corresponding to a Family</li><li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>	FAMILY2STATUS - Returns the device status</li><li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>	GETGOLDEN - Returns the golden values for a family</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>	GETMODE - Returns the present family mode ('Online', 'Simulator', 'Manual', 'Special', etc)</li><li><a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>	GETOFFSET - Returns the offset values for a family</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>	GETSPOS - Returns the longitudinal position in meters</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>	MAXSP - Maximum value of the setpoint</li><li><a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>	MINSP - Minimum value of the setpoint</li><li><a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>	ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li><li><a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>	STEPRF - Increment change in the RF frequency</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>	SETORBITBUMP - Local bump program (uses setorbit)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)</a></li><li><a href="#_sub2" class="code">function [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)</a></li><li><a href="#_sub3" class="code">function drawmoreplots(Haxis, OCS, Smat, S, U, V)</a></li><li><a href="#_sub4" class="code">function PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)</a>
0002 <span class="comment">%SETORBIT - Orbit correction function</span>
0003 <span class="comment">%  Family/DeviceList method:</span>
0004 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, NIter, SVDIndex, BPMWeight);</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  Data structure method:</span>
0007 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMstruct,             CMstruct,            NIter, SVDIndex, BPMWeight);</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  Use cell arrays for multiple family correction (like coupled planes):</span>
0010 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbitCell, BPMcell, CMcell, NIter, SVDIndex, BPMWeight);</span>
0011 <span class="comment">%  Note: BPMcell and CMcell must be a data structures when using cell arrays (GoalOrbitCell can be a cell or a string)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%  Orbit Correction Structure (OCS) method:</span>
0014 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(OCS, NIter, SVDIndex, BPMWeight);</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%  INPUTS</span>
0017 <span class="comment">%  1. GoalOrbit - Goal orbit (vector or cell array)</span>
0018 <span class="comment">%                'Golden' for the golden orbit {Default}</span>
0019 <span class="comment">%                'Offset' for the offset orbit</span>
0020 <span class="comment">%  2. BPM - BPM data structure (or cell array of structures)</span>
0021 <span class="comment">%     or BPMFamily and BPMDevList</span>
0022 <span class="comment">%  3. CM - Corrector magnet data structure (or cell array of structures)</span>
0023 <span class="comment">%     or CMFamily and CMDevList</span>
0024 <span class="comment">%  4. SVDIndex - vector, maximum number, 'All', or</span>
0025 <span class="comment">%                base on a threshold of min/max singular value {Default: 1e-3}</span>
0026 <span class="comment">%  5. NIter - Number of iterations  {Default: 1}</span>
0027 <span class="comment">%            (NIter can be 0, see note 1 below)</span>
0028 <span class="comment">%  6. BPMWeight - Weight applied to the BPMs (OCS.BPMWeight)</span>
0029 <span class="comment">%  7. FLAGS  - 'Abs' or 'Inc' - GoalOrbit is an absolute or incremental change {Default: 'Abs'}</span>
0030 <span class="comment">%                               ('Absolute' or 'Incremental' can also be used)</span>
0031 <span class="comment">%              'CorrectorGain', Gain - Scale the correction by Gain {Default: 1}</span>
0032 <span class="comment">%              'Display' - plot orbit information before applying the correction</span>
0033 <span class="comment">%              'FigureHandles' followed by a vector of 1 or 2 elements for figure handles and</span>
0034 <span class="comment">%                                                      4 or 8 elements for axes handles.</span>
0035 <span class="comment">%              'FitRF' or 'SetRF' - Fit and change the RF frequency</span>
0036 <span class="comment">%                   'GoldenDisp' - Use the golden dispersion {Default}</span>
0037 <span class="comment">%                   'MeasDisp'   - Measure the dispersion</span>
0038 <span class="comment">%                   'ModelDisp'  - Calculate the model dispersion</span>
0039 <span class="comment">%              'GetPV' or 'NoGetPV' - Get new data or use the data already in the OCS {Default: 'GetPV' (for the first iteration)}</span>
0040 <span class="comment">%                                     This allows one make a correction based on data already checked and analyzed.</span>
0041 <span class="comment">%                                     ('GetAM' or 'NoGetAM' does the same thing)</span>
0042 <span class="comment">%              'GoldenResp' or 'ModelResp' - Golden BPM response or calculate from the model {Default: 'GoldenResp'}</span>
0043 <span class="comment">%              'SetPV' or 'NoSetPV' - Set or don't set the correctors and RF {Default: 'SetSP'}</span>
0044 <span class="comment">%                                    'NoSetPV' does the calculation without making the correction.  That way one can</span>
0045 <span class="comment">%                                     take a look at the expected correction results before applying them.</span>
0046 <span class="comment">%                                     ('SetSP' or 'NoSetSP' does the same thing)</span>
0047 <span class="comment">%              'Tolerance', Tol - Quit correction if the std(error) &lt; Tol {Tol: 0}</span>
0048 <span class="comment">%              'RampSteps', NSteps - Number of steps to ramp in the correction {NSteps: 1}</span>
0049 <span class="comment">%                                    This is used to avoid a large transient between setpoint changes.</span>
0050 <span class="comment">%                                    Note: NSteps is only used on the first iteration.</span>
0051 <span class="comment">%              'FitRF','SetRF','RFCorrector'                       - Set the RF frequency (Eta Column)</span>
0052 <span class="comment">%              'FitRFHCM0','FitRFEnergy','SetRFHCM0','SetRFEnergy' - Set the RF frequency (HCM energy constraint)</span>
0053 <span class="comment">%              'FitRFDeltaHCM0','SetRFDeltaHCM0'                   - Set the RF frequency (Delta HCM energy constraint)</span>
0054 <span class="comment">%              'FitRFDispersionOrbit','SetRFDispersionOrbit'       - Set the RF frequency (Dispersion orbit constraint)</span>
0055 <span class="comment">%              'FitRFDispersionHCM','SetRFDispersionHCM'           - Set the RF frequency (Dispersion correction constraint)</span>
0056 <span class="comment">%              The usual Units and Mode flags can also be used.</span>
0057 <span class="comment">%              Flags are not case sensitive</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%  OUTPUTS</span>
0060 <span class="comment">%  1. OCS    - New orbit correction structure (OCS)</span>
0061 <span class="comment">%  2. OCS0   - Starting OCS</span>
0062 <span class="comment">%  3. V      - Corrector magnet singular vectors</span>
0063 <span class="comment">%  4. Svalue - Singular values (vector)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">%  ALGORITHM</span>
0066 <span class="comment">%  SVD orbit correction:</span>
0067 <span class="comment">%  Decompose the response matrix, Rmat:</span>
0068 <span class="comment">%    [U, S, V] = svd(Rmat);</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%  The V matrix columns are the singular vectors in the corrector magnet space</span>
0071 <span class="comment">%  The U matrix columns are the singular vectors in the BPM space</span>
0072 <span class="comment">%    Rmat = U * S = Rmat * V</span>
0073 <span class="comment">%</span>
0074 <span class="comment">%  Modify the response matrix by removing singular vector with small singular values</span>
0075 <span class="comment">%    Rmod = U(:,SVDIndex) * S(SVDIndex,SVDIndex) = Rmat * V(:,SVDIndex)</span>
0076 <span class="comment">%</span>
0077 <span class="comment">%  Only project (least squares) on to the modified response matrix</span>
0078 <span class="comment">%    b = inv(Rmod'*Rmod)*Rmod' * (GoalOrbit - PresentOrbit);</span>
0079 <span class="comment">%  Or</span>
0080 <span class="comment">%    b = Rmod \ (GoalOrbit - PresentOrbit);</span>
0081 <span class="comment">%</span>
0082 <span class="comment">%  The b coefficients are in terms of the singular vectors.</span>
0083 <span class="comment">%  The corrector strengths come from the linear combination of the singular vectors</span>
0084 <span class="comment">%    DeltaCM = V(:,SVDIndex) * b;</span>
0085 <span class="comment">%</span>
0086 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
0087 <span class="comment">%    OCS.BPM (Data structure or cell array of data structures)</span>
0088 <span class="comment">%    OCS.CM  (Data structure or cell array of data structures)</span>
0089 <span class="comment">%    OCS.GoalOrbit</span>
0090 <span class="comment">%    OCS.NIter         - Number of correction iterations</span>
0091 <span class="comment">%    OCS.NCorrections  - Number of corrections actually done</span>
0092 <span class="comment">%    OCS.Tolerance     - Tolerance level to quit iterating</span>
0093 <span class="comment">%    OCS.RampSteps     - Number of steps to ramp in the each correction</span>
0094 <span class="comment">%    OCS.SVDIndex</span>
0095 <span class="comment">%    OCS.FitRF         - Methods for RF correction</span>
0096 <span class="comment">%                        1 Standard way with no constraints</span>
0097 <span class="comment">%                        2 Sum of the energy change to zero Also remove the</span>
0098 <span class="comment">%                          energy change due to the present corrector setpoints</span>
0099 <span class="comment">%                        3 Sum of the energy change to zero</span>
0100 <span class="comment">%                          remove energy change due to the incremental change in the correctors</span>
0101 <span class="comment">%                        4 Constraint: dot(DispersionX,   Smat * dHCM) = 0</span>
0102 <span class="comment">%                        5 Constraint: dot(HCM(Dispersion), dHCM) = 0</span>
0103 <span class="comment">%    OCS.RF</span>
0104 <span class="comment">%    OCS.DeltaRF</span>
0105 <span class="comment">%    OCS.Display</span>
0106 <span class="comment">%    OCS.Incremental   - GoalOrbit is an incremental change from the present (1) or absolute (0) {Default: 0}</span>
0107 <span class="comment">%    OCS.CorrectorGain - Scales the correction (usually used in slow feedback)</span>
0108 <span class="comment">%    OCS.BPMWeight     - Row    weights on the response matrix</span>
0109 <span class="comment">%    OCS.CMWeight      - Column weights on the response matrix</span>
0110 <span class="comment">%    OCS.Flags = {}</span>
0111 <span class="comment">%</span>
0112 <span class="comment">%  EXAMPLES</span>
0113 <span class="comment">%  1. The default behavior us horizontal and vertical (coupled) orbit correction to the golden orbit</span>
0114 <span class="comment">%     setorbit;</span>
0115 <span class="comment">%     is equivalent to</span>
0116 <span class="comment">%     x = getx('struct');</span>
0117 <span class="comment">%     y = gety('struct');</span>
0118 <span class="comment">%     hcm = getsp('HCM','struct');</span>
0119 <span class="comment">%     vcm = getsp('VCM','struct');</span>
0120 <span class="comment">%     setorbit('Golden', {x,y}, {hcm,vcm});</span>
0121 <span class="comment">%</span>
0122 <span class="comment">%  2. Horizontal orbit correction with the follow criterion:</span>
0123 <span class="comment">%     a. Correct to the golden orbit</span>
0124 <span class="comment">%     b. Use the first 10 singular values</span>
0125 <span class="comment">%     c. Display results</span>
0126 <span class="comment">%</span>
0127 <span class="comment">%     x = getx([1 1;1 2;12 1; 13 4],'struct');</span>
0128 <span class="comment">%     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');</span>
0129 <span class="comment">%     setorbit('Golden', x, hcm, 10, 'Display');</span>
0130 <span class="comment">%</span>
0131 <span class="comment">%  3. Horizontal and vertical (coupled) orbit correction to the golden orbit (display results)</span>
0132 <span class="comment">%     x = getx([1 1;1 2;12 1; 13 4],'struct');</span>
0133 <span class="comment">%     y = gety([1 1;1 2;12 1; 13 4],'struct');</span>
0134 <span class="comment">%     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');</span>
0135 <span class="comment">%     vcm = getsp('VCM',[3 1;4 1;9 1;10 1],'struct');</span>
0136 <span class="comment">%     setorbit('Golden', {x,y}, {hcm,vcm}, 'Display');</span>
0137 <span class="comment">%</span>
0138 <span class="comment">%  NOTES</span>
0139 <span class="comment">%  1. Incremental orbit changes with more then one iteration are treated algorithmically</span>
0140 <span class="comment">%     just like absolute orbit changes.  For a 1 iteration incremental orbit change</span>
0141 <span class="comment">%     BPM data is not needed and hence not used.  However, if one uses the</span>
0142 <span class="comment">%     'Display' flag then BPM data is used to show results.  If BPM data is not</span>
0143 <span class="comment">%     available and one wants to still display corrector and estimated orbit</span>
0144 <span class="comment">%     information then use the special mode: 'Inc', 'Display', NIter=0.</span>
0145 <span class="comment">%  2. The 'Display' flag only displays the first iteration and the final result.</span>
0146 <span class="comment">%     Intermediate iterations (if used) are not displayed.</span>
0147 <span class="comment">%  3. If horizontal and vertical corrector are used, then the</span>
0148 <span class="comment">%     coupling terms in the response matrix will be used.</span>
0149 <span class="comment">%     To avoid using coupling terms, use separate calls.</span>
0150 <span class="comment">%  4. OCS0.CM.Data is the corrector strength before setorbit ran</span>
0151 <span class="comment">%     OCS.CM.Data  is the corrector strength after  setorbit ran</span>
0152 <span class="comment">%     Hence, DeltaCM = OCS.CM.Data - OCS0.CM.Data;</span>
0153 <span class="comment">%     However, if the 'NoSetSP' flag was used, then no correction was done and</span>
0154 <span class="comment">%     OCS.CM.Data=OCS0.CM.Data (ie, the present corrector strength).  To apply</span>
0155 <span class="comment">%     the correction, use OCS.CM.Data + OCS.CM.Delta</span>
0156 <span class="comment">%</span>
0157 <span class="comment">%  See also orbitcorrectionmethods, setorbitbump, setorbitgui, rmdisp, plotcm</span>
0158 
0159 <span class="comment">%</span>
0160 <span class="comment">%  Written by Greg Portmann</span>
0161 
0162 
0163 <span class="comment">% Initialize</span>
0164 ErrorFlag = 0;
0165 ExtraDelay = 0;
0166 
0167 DefaultNIter = 1;
0168 DefaultSVDIndex = 1e-4;
0169 DefaultGoalOrbit = <span class="string">'Golden'</span>;
0170 DefaultFitRF = 0;
0171 DefaultDisplay = 0;
0172 DefaultCorrectorGain = 1;
0173 
0174 RespFlag = <span class="string">'GoldenResp'</span>;
0175 DispFlag = <span class="string">'GoldenDisp'</span>;
0176 SetSPFlag = 1;
0177 GetPVFlag = 1;
0178 RF0 = [];
0179 RF  = [];
0180 FigHandles = [];
0181 AxesHandles = [];
0182 
0183 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0184 <span class="comment">% Input parsing and checking %</span>
0185 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0186 IncrementalFlag = -1;
0187 ModeFlag = <span class="string">''</span>;
0188 InputFlags = {};
0189 OCSFlags = {};
0190 DCCTLOW = .1; <span class="comment">% A minimum stored current into the machine</span>
0191 
0192 <span class="comment">% OCS init and defaults</span>
0193 OCS.BPM = [];
0194 OCS.CM  = [];
0195 OCS.GoalOrbit = DefaultGoalOrbit;
0196 OCS.SVDIndex  = DefaultSVDIndex;
0197 OCS.FitRF     = DefaultFitRF;
0198 OCS.NIter     = DefaultNIter;
0199 OCS.Display   = DefaultDisplay;
0200 OCS.CorrectorGain = DefaultCorrectorGain;
0201 OCS.Incremental = 0;
0202 OCS.Tolerance = 0;
0203 OCS.RampSteps = 1;
0204 
0205 <span class="comment">% First check if an OCS structure was input</span>
0206 OCSInputFlag = 0;
0207 <span class="keyword">if</span> length(varargin) &gt;= 1
0208     <span class="keyword">if</span> isstruct(varargin{1})
0209         <span class="keyword">if</span> isfield(varargin{1},<span class="string">'BPM'</span>) &amp;&amp; isfield(varargin{1},<span class="string">'CM'</span>)
0210             OCSInputFlag = 1;
0211                         
0212             OCSin = varargin{1};
0213             varargin(1) = [];
0214 
0215             <span class="comment">% Copy the input OSC on top of the defaults</span>
0216             FieldCell = fieldnames(OCSin);
0217             <span class="keyword">for</span> i = 1:length(FieldCell)
0218                 OCS.(FieldCell{i}) = OCSin.(FieldCell{i});
0219             <span class="keyword">end</span>
0220            
0221             <span class="comment">% Attach the flags</span>
0222             <span class="keyword">if</span> isfield(OCS, <span class="string">'Flags'</span>)
0223                 varargin = [varargin OCS.Flags];
0224             <span class="keyword">end</span>
0225         <span class="keyword">end</span>
0226     <span class="keyword">end</span>
0227 <span class="keyword">end</span>
0228 
0229 
0230 <span class="keyword">for</span> i = length(varargin):-1:1
0231     <span class="keyword">if</span> isstruct(varargin{i})
0232         <span class="comment">% Ignor structures</span>
0233     <span class="keyword">elseif</span> iscell(varargin{i})
0234         <span class="comment">% Ignor cells</span>
0235 
0236     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Golden'</span>)
0237         <span class="comment">% Use the golden orbit</span>
0238         OCS.GoalOrbit = <span class="string">'Golden'</span>;
0239         varargin(i) = [];
0240     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Offset'</span>)
0241         <span class="comment">% Use the offset orbit</span>
0242         OCS.GoalOrbit = <span class="string">'Offset'</span>;
0243         varargin(i) = [];
0244 
0245     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRF'</span>,<span class="string">'SetRF'</span>,<span class="string">'RFCorrector'</span>}))
0246         <span class="comment">%SetRFString = 'Set the RF frequency (Eta Column)';</span>
0247         OCS.FitRF = 1;
0248         varargin(i) = [];
0249     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFHCM0'</span>,<span class="string">'FitRFEnergy'</span>,<span class="string">'SetRFHCM0'</span>,<span class="string">'SetRFEnergy'</span>}))
0250         <span class="comment">%SetRFString = 'Set the RF frequency (HCM energy constraint)';</span>
0251         OCS.FitRF = 2;
0252         varargin(i) = [];
0253     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDeltaHCM0'</span>,<span class="string">'SetRFDeltaHCM0'</span>}))
0254         <span class="comment">%SetRFString = 'Set the RF frequency (Delta HCM energy constraint)';</span>
0255         OCS.FitRF = 3;
0256         varargin(i) = [];
0257     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDispersionOrbit'</span>,<span class="string">'SetRFDispersionOrbit'</span>}))
0258         <span class="comment">%SetRFString = 'Set the RF frequency (Dispersion orbit constraint)';</span>
0259         OCS.FitRF = 4;
0260         varargin(i) = [];
0261     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDispersionHCM'</span>,<span class="string">'SetRFDispersionHCM'</span>}))
0262         <span class="comment">%SetRFString = 'Set the RF frequency (Dispersion correction constraint)';</span>
0263         OCS.FitRF = 5;
0264         varargin(i) = [];
0265 
0266     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0267         OCS.Display = 1;
0268         varargin(i) = [];
0269     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>) || strcmpi(varargin{i},<span class="string">'No Display'</span>)
0270         OCS.Display = 0;
0271         varargin(i) = [];
0272 
0273     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'ModelResp'</span>)
0274         RespFlag = varargin{i};
0275         varargin(i) = [];
0276     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'GoldenResp'</span>)
0277         RespFlag = varargin{i};
0278         varargin(i) = [];
0279 
0280     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'ModelDisp'</span>)
0281         DispFlag = varargin{i};
0282         varargin(i) = [];
0283     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'MeasDisp'</span>)
0284         DispFlag = varargin{i};
0285         varargin(i) = [];
0286     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'GoldenDisp'</span>)
0287         DispFlag = varargin{i};
0288         varargin(i) = [];
0289 
0290     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'Inc'</span>,<span class="string">'Incremental'</span>}))
0291         OCS.Incremental = 1;
0292         varargin(i) = [];
0293     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'Abs'</span>,<span class="string">'Absolute'</span>}))
0294         OCS.Incremental = 0;
0295         varargin(i) = [];
0296 
0297     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'SetPV'</span>,<span class="string">'SetSP'</span>}))
0298         SetSPFlag = 1;
0299         varargin(i) = [];
0300     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'NoSetPV'</span>,<span class="string">'NoSetSP'</span>}))
0301         SetSPFlag = 0;
0302         varargin(i) = [];
0303 
0304     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'GetPV'</span>,<span class="string">'GetAM'</span>}))
0305         GetPVFlag = 1;
0306         varargin(i)   = [];
0307     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'NoGetPV'</span>,<span class="string">'NoGetAM'</span>}))
0308         GetPVFlag = 0;
0309         varargin(i)   = [];
0310 
0311     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>) || strcmpi(varargin{i},<span class="string">'Model'</span>)
0312         ModeFlag = <span class="string">'Simulator'</span>;
0313         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0314         InputFlags = [InputFlags varargin(i)];
0315         varargin(i) = [];
0316     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0317         ModeFlag = <span class="string">'Online'</span>;
0318         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0319         InputFlags = [InputFlags varargin(i)];
0320         varargin(i) = [];
0321     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0322         ModeFlag = <span class="string">'Manual'</span>;
0323         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0324         InputFlags = [InputFlags varargin(i)];
0325         varargin(i) = [];
0326     
0327     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'physics'</span>)
0328         OCSFlags = [OCSFlags varargin(i)];
0329         InputFlags = [InputFlags varargin(i)];
0330         varargin(i) = [];
0331     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0332         OCSFlags = [OCSFlags varargin(i)];
0333         InputFlags = [InputFlags varargin(i)];
0334         varargin(i) = [];
0335 
0336     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'FigureHandles'</span>)
0337         OCS.Display = 1;
0338         FigHandles = varargin{i+1};
0339         <span class="keyword">if</span> ~any(length(FigHandles) == [1 2  3 6])
0340             error(<span class="string">'Figure handles must be of length 1 or 2 for figures or 3 or 6 for axes.'</span>);
0341         <span class="keyword">end</span>
0342         varargin(i+1) = [];
0343         varargin(i)   = [];
0344 
0345     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'CorrectorGain'</span>)
0346         OCS.CorrectorGain = varargin{i+1};
0347         varargin(i+1) = [];
0348         varargin(i)   = [];
0349 
0350     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Tolerance'</span>)
0351         OCS.Tolerance = varargin{i+1};
0352         varargin(i+1) = [];
0353         varargin(i)   = [];
0354 
0355     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'RampSteps'</span>)
0356         OCS.RampSteps = varargin{i+1};
0357         varargin(i+1) = [];
0358         varargin(i)   = [];
0359 
0360     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Archive'</span>)
0361         <span class="comment">% Just remove</span>
0362         varargin(i) = [];
0363     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoArchive'</span>)
0364         <span class="comment">% Just remove</span>
0365         varargin(i) = [];
0366     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0367         <span class="comment">% Just remove</span>
0368         varargin(i) = [];
0369     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0370         <span class="comment">% Just remove</span>
0371         varargin(i) = [];
0372     <span class="keyword">end</span>
0373 <span class="keyword">end</span>
0374 
0375 OCSFlags = [OCSFlags {RespFlag} {DispFlag}];
0376 
0377 
0378 <span class="keyword">if</span> ~OCSInputFlag
0379     <span class="keyword">if</span> iscell(varargin{1})
0380         <span class="keyword">if</span> isstruct(varargin{1}{1})
0381             <span class="comment">% BPM, CM</span>
0382             <span class="keyword">if</span> length(varargin) &lt; 2
0383                 error(<span class="string">'Input parsing problem'</span>);
0384             <span class="keyword">end</span>
0385             <span class="keyword">if</span> ~iscell(varargin{1}) || ~iscell(varargin{2})
0386                 error(<span class="string">'When using cell arrays BPM and CM inputs must all be cell arrays'</span>);
0387             <span class="keyword">end</span>
0388             OCS.BPM = varargin{1};
0389             OCS.CM = varargin{2};
0390             varargin(1:2) = [];
0391         <span class="keyword">else</span>
0392             <span class="comment">% GoalOrbit, BPM, CM</span>
0393             <span class="keyword">if</span> length(varargin) &lt; 3
0394                 error(<span class="string">'Input parsing problem'</span>);
0395             <span class="keyword">end</span>
0396             OCS.GoalOrbit = varargin{1};
0397             <span class="keyword">if</span> ~iscell(varargin{2}) || ~iscell(varargin{3})
0398                 error(<span class="string">'When using cell arrays BPM and CM inputs must all be cell arrays'</span>);
0399             <span class="keyword">end</span>
0400             OCS.BPM = varargin{2};
0401             OCS.CM = varargin{3};
0402             varargin(1:3) = [];
0403         <span class="keyword">end</span>
0404     <span class="keyword">elseif</span> isstruct(varargin{1})
0405         <span class="comment">% BPM and CM are structures, Golden orbit is not</span>
0406         <span class="comment">% Golden orbit could have been a string which has already been removed</span>
0407         <span class="keyword">if</span> length(varargin) &lt; 2
0408             error(<span class="string">'Input parsing problem: BPM and/or CM not found'</span>);
0409         <span class="keyword">end</span>
0410         OCS.BPM = varargin{1};
0411         varargin(1) = [];
0412         <span class="keyword">if</span> ischar(OCS.BPM)
0413             FamilyName = OCS.BPM;
0414             DeviceList = varargin{1};
0415             <span class="keyword">if</span> length(varargin) &lt; 1
0416                 error(<span class="string">'BPM device list must exist'</span>);
0417             <span class="keyword">end</span>
0418             varargin(1) = [];
0419             OCS.BPM = <a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>(FamilyName, DeviceList);
0420         <span class="keyword">end</span>
0421         OCS.CM = varargin{1};
0422         varargin(1) = [];
0423         <span class="keyword">if</span> ischar(OCS.CM)
0424             FamilyName = OCS.CM;
0425             <span class="keyword">if</span> length(varargin) &lt; 1
0426                 error(<span class="string">'Corrector magnet device list must exist'</span>);
0427             <span class="keyword">end</span>
0428             DeviceList = varargin{1};
0429             varargin(1) = [];
0430             OCS.CM = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(FamilyName, DeviceList, <span class="string">'struct'</span>);
0431         <span class="keyword">end</span>
0432     <span class="keyword">else</span>
0433         <span class="keyword">if</span> isnumeric(varargin{1})
0434             <span class="keyword">if</span> length(varargin) &lt; 3
0435                 error(<span class="string">'Input parsing problem: GoalOrbit, BPM, CM not all found'</span>);
0436             <span class="keyword">end</span>
0437             OCS.GoalOrbit = varargin{1};
0438             varargin(1) = [];
0439         <span class="keyword">else</span>
0440             <span class="keyword">if</span> length(varargin) &lt; 2
0441                 error(<span class="string">'Input parsing problem: BPM and/or CM not found'</span>);
0442             <span class="keyword">end</span>
0443         <span class="keyword">end</span>
0444 
0445         OCS.BPM = varargin{1};
0446         varargin(1) = [];
0447         <span class="keyword">if</span> ischar(OCS.BPM)
0448             FamilyName = OCS.BPM;
0449             <span class="keyword">if</span> isnumeric(varargin{1})
0450                 DeviceList = varargin{1};
0451                 varargin(1) = [];
0452             <span class="keyword">else</span>
0453                 DeviceList = [];
0454             <span class="keyword">end</span>
0455             <span class="keyword">if</span> length(varargin) &lt; 1
0456                 error(<span class="string">'BPM device list must exist'</span>);
0457             <span class="keyword">end</span>
0458             OCS.BPM = <a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>(FamilyName, DeviceList);
0459         <span class="keyword">end</span>
0460 
0461         OCS.CM = varargin{1};
0462         varargin(1) = [];
0463         <span class="keyword">if</span> ischar(OCS.CM)
0464             FamilyName = OCS.CM;
0465             <span class="keyword">if</span> length(varargin) &lt; 1
0466                 error(<span class="string">'Corrector magnget device list must exist'</span>);
0467             <span class="keyword">end</span>
0468             <span class="keyword">if</span> isnumeric(varargin{1})
0469                 DeviceList = varargin{1};
0470                 varargin(1) = [];
0471             <span class="keyword">else</span>
0472                 DeviceList = [];
0473             <span class="keyword">end</span>
0474             OCS.CM = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(FamilyName, DeviceList, <span class="string">'struct'</span>);
0475         <span class="keyword">end</span>
0476     <span class="keyword">end</span>
0477 <span class="keyword">end</span>
0478 
0479 
0480 <span class="comment">% Get NIter</span>
0481 <span class="keyword">if</span> length(varargin) &gt;= 1
0482     OCS.NIter = varargin{1};
0483     varargin(1) = [];
0484 <span class="keyword">end</span>
0485 <span class="keyword">if</span> isempty(OCS.NIter)
0486     OCS.NIter = DefaultNIter;
0487 <span class="keyword">end</span>
0488 
0489 <span class="comment">% Get SVDIndex</span>
0490 <span class="keyword">if</span> length(varargin) &gt;= 1
0491     OCS.SVDIndex = varargin{1};
0492     varargin(1) = [];
0493 <span class="keyword">end</span>
0494 <span class="keyword">if</span> isempty(OCS.SVDIndex)
0495     OCS.SVDIndex = DefaultSVDIndex;
0496 <span class="keyword">end</span>
0497 
0498 
0499 <span class="comment">% Get BPMWeight</span>
0500 <span class="keyword">if</span> length(varargin) &gt;= 1
0501     OCS.BPMWeight = varargin{1};
0502     varargin(1) = [];
0503 <span class="keyword">end</span>
0504 
0505 
0506 <span class="comment">% Check BPM field</span>
0507 <span class="keyword">if</span> isempty(OCS.BPM)
0508     OCS.BPM = {<a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>};
0509 <span class="keyword">end</span>
0510 
0511 <span class="comment">% Check CM field</span>
0512 <span class="keyword">if</span> isempty(OCS.CM)
0513     OCS.CM = {<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>,  <a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>};
0514 <span class="keyword">end</span>
0515 
0516 
0517 <span class="comment">% Check the Display field</span>
0518 <span class="keyword">if</span> isempty(OCS.Display)
0519     OCS.Display = DefaultDisplay;
0520 <span class="keyword">end</span>
0521 
0522 
0523 <span class="comment">% Check the corrector gain</span>
0524 <span class="keyword">if</span> isempty(OCS.CorrectorGain)
0525     OCS.CorrectorGain = DefaultCorrectorGain;
0526 <span class="keyword">end</span>
0527 
0528 
0529 <span class="comment">% Check NIter</span>
0530 <span class="keyword">if</span> OCS.Incremental
0531     <span class="keyword">if</span> ~OCS.Display &amp;&amp; OCS.NIter == 1
0532         <span class="comment">% Use OCS.NIter=0, since BPM data is not needed</span>
0533         OCS.NIter = 0;
0534     <span class="keyword">end</span>
0535 <span class="keyword">else</span>
0536     <span class="keyword">if</span> OCS.NIter == 0
0537         error(<span class="string">'Number of iterations cannot be zero for absolute orbit changes'</span>);
0538     <span class="keyword">end</span>
0539 <span class="keyword">end</span>
0540 
0541 
0542 <span class="comment">% Make cell arrays if they are not already</span>
0543 <span class="keyword">if</span> ~iscell(OCS.BPM)
0544     NoCellBPMFlag = 1;
0545     OCS.BPM = {OCS.BPM};
0546 <span class="keyword">else</span>
0547     NoCellBPMFlag = 0;
0548 <span class="keyword">end</span>
0549 <span class="keyword">if</span> ~iscell(OCS.CM)
0550     NoCellCMFlag = 1;
0551     OCS.CM = {OCS.CM};
0552     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>) &amp;&amp; ~iscell(OCS.CMWeight)
0553         OCS.CMWeight = {OCS.CMWeight};
0554     <span class="keyword">end</span>
0555 <span class="keyword">else</span>
0556     NoCellCMFlag = 0;
0557 <span class="keyword">end</span>
0558 
0559 
0560 <span class="comment">% Attach the flags</span>
0561 OCS.Flags = OCSFlags;
0562 
0563 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0564 <span class="comment">% End input parsing and checking %</span>
0565 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0566 
0567 
0568 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0569 <span class="comment">% Check for good status if online %</span>
0570 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0571 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0572     <span class="keyword">if</span> strcmpi(<a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(OCS.BPM{i}),<span class="string">'Online'</span>)
0573         [S, IndexList] = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(OCS.BPM{i});
0574         <span class="keyword">if</span> find(S==0)
0575             tmp = questdlg({sprintf(<span class="keyword">...</span>
0576                 <span class="string">'BPM family %s is showing %d element(s) with bad status.'</span>, OCS.BPM{i}.FamilyName, length(find(S==0))), <span class="keyword">...</span>
0577                 <span class="string">'Do you want to continue with orbit correction?'</span>},<span class="keyword">...</span>
0578                 <span class="string">'SETORBIT'</span>,<span class="string">'YES'</span>,<span class="string">'NO'</span>,<span class="string">'NO'</span>);
0579             <span class="keyword">if</span> ~strcmpi(tmp,<span class="string">'YES'</span>)
0580                 <span class="keyword">return</span>
0581             <span class="keyword">end</span>
0582         <span class="keyword">end</span>
0583     <span class="keyword">end</span>
0584 <span class="keyword">end</span>
0585 <span class="keyword">for</span> i = 1:length(OCS.CM)
0586     <span class="keyword">if</span> strcmpi(<a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(OCS.CM{i}),<span class="string">'Online'</span>)
0587         [S, IndexList] = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(OCS.CM{i});
0588         <span class="keyword">if</span> find(S==0)
0589             tmp = questdlg({sprintf(<span class="keyword">...</span>
0590                 <span class="string">'Corrector family %s is showing %d element(s) with bad status.'</span>, OCS.CM{i}.FamilyName, length(find(S==0))), <span class="keyword">...</span>
0591                 <span class="string">'Do you want to continue with orbit correction?'</span>},<span class="keyword">...</span>
0592                 <span class="string">'SETORBIT'</span>,<span class="string">'YES'</span>,<span class="string">'NO'</span>,<span class="string">'NO'</span>);
0593             <span class="keyword">if</span> ~strcmpi(tmp,<span class="string">'YES'</span>)
0594                 <span class="keyword">return</span>
0595             <span class="keyword">end</span>
0596         <span class="keyword">end</span>
0597     <span class="keyword">end</span>
0598 <span class="keyword">end</span>
0599 
0600 
0601 <span class="comment">% Check BPMWeight</span>
0602 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'BPMWeight'</span>)
0603     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0604         OCS.BPMWeight{i} = [];
0605     <span class="keyword">end</span>
0606 <span class="keyword">end</span>
0607 <span class="keyword">if</span> ~iscell(OCS.BPMWeight)
0608     OCS.BPMWeight = {OCS.BPMWeight};
0609 <span class="keyword">end</span>
0610 
0611 
0612 
0613 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0614 <span class="comment">% Build the goal orbit cell %</span>
0615 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0616 <span class="keyword">if</span> ischar(OCS.GoalOrbit)
0617     GoalOrbitFlag = OCS.GoalOrbit;
0618     OCS.GoalOrbit = [];
0619     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0620         <span class="keyword">if</span> strcmpi(GoalOrbitFlag,<span class="string">'Golden'</span>)
0621             tmp = <a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0622         <span class="keyword">elseif</span> strcmpi(GoalOrbitFlag,<span class="string">'Offset'</span>)
0623             tmp = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0624         <span class="keyword">else</span>
0625             error(<span class="string">'Only golden and offset orbits are known'</span>)
0626         <span class="keyword">end</span>
0627         OCS.GoalOrbit{i} = tmp;
0628     <span class="keyword">end</span>
0629 <span class="keyword">end</span>
0630 <span class="keyword">if</span> ~iscell(OCS.GoalOrbit)
0631     OCS.GoalOrbit = {OCS.GoalOrbit};
0632 <span class="keyword">end</span>
0633 
0634 
0635 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0636 <span class="comment">% End of Input Setup %</span>
0637 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0638 
0639 
0640 
0641 <span class="comment">% Save the starting RF frequency</span>
0642 <span class="keyword">if</span> GetPVFlag
0643     OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
0644 <span class="keyword">end</span>
0645 
0646 
0647 <span class="comment">% Number of iterations (OCS.NIter can be 0 for display reasons with increment changes)</span>
0648 <span class="keyword">if</span> OCS.NIter == 0
0649     NumberOfTrys = 1;
0650 <span class="keyword">else</span>
0651     NumberOfTrys = OCS.NIter;
0652 <span class="keyword">end</span>
0653 
0654 
0655 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0656 <span class="comment">% Build the starting orbit %</span>
0657 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0658 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0659     <span class="keyword">if</span> OCS.NIter == 0
0660         <span class="comment">% Don't use BPM data for zero interations</span>
0661         OCS.BPM{i}.Data = zeros(size(OCS.BPM{i}.DeviceList,1),1);
0662     <span class="keyword">else</span>
0663         <span class="keyword">if</span> GetPVFlag
0664             <span class="comment">% Get new BPM data if not in calculate mode</span>
0665             OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0666         <span class="keyword">end</span>
0667     <span class="keyword">end</span>
0668 <span class="keyword">end</span>
0669 
0670 <span class="comment">% For increment changes, convert the goal orbit to an absolute orbit</span>
0671 <span class="keyword">if</span> OCS.Incremental
0672     <span class="keyword">for</span> i = 1:length(OCS.GoalOrbit)
0673         OCS.GoalOrbit{i} = OCS.GoalOrbit{i} + OCS.BPM{i}.Data;
0674     <span class="keyword">end</span>
0675     
0676     <span class="comment">% The incremental flag is always zero on exit because the orbits are absolute at this point</span>
0677     OCS.Incremental = 0;
0678 <span class="keyword">end</span>
0679 
0680 
0681 
0682 <span class="comment">% Interactively select singular value</span>
0683 SVDquestion = <span class="string">'Select Again'</span>;
0684 MorePlotsFlag = 0;
0685 <span class="keyword">while</span> strcmp(SVDquestion,<span class="string">'Select Again'</span>)
0686 
0687     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0688     <span class="comment">% Build the starting orbit %</span>
0689     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0690     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0691         <span class="keyword">if</span> OCS.NIter == 0
0692             <span class="comment">% Don't use BPM data for zero interations</span>
0693             OCS.BPM{i}.Data = zeros(size(OCS.BPM{i}.DeviceList,1),1);
0694         <span class="keyword">else</span>
0695             <span class="keyword">if</span> GetPVFlag
0696                 <span class="comment">% Get new BPM data if not in calculate mode</span>
0697                 OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0698             <span class="keyword">end</span>
0699         <span class="keyword">end</span>
0700     <span class="keyword">end</span>
0701 
0702 
0703     <span class="comment">% Get the present setpoints</span>
0704     <span class="keyword">if</span> GetPVFlag
0705         OCS.CM = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM, <span class="string">'Struct'</span>, InputFlags{:});
0706     <span class="keyword">end</span>
0707 
0708     <span class="comment">% Compute the correction</span>
0709     [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);
0710 
0711     <span class="comment">% Save the starting OCS (with possible CM &amp; BPM list changes)</span>
0712     OCS0 = OCS;
0713 
0714     <span class="keyword">if</span> OCS.Display  <span class="comment">% || length(FigHandles&gt;=3)</span>
0715         [FigHandles, AxesHandles, OCS] = <a href="#_sub2" class="code" title="subfunction [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)">PreCorrectionDisplay</a>(FigHandles, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags);
0716     <span class="keyword">else</span>
0717         SVDquestion = <span class="string">'Correct Orbit'</span>;
0718     <span class="keyword">end</span>
0719 
0720     <span class="keyword">if</span> SetSPFlag &amp;&amp; OCS.Display &amp;&amp; length(FigHandles)&lt;3
0721         Units = get(0,<span class="string">'units'</span>);
0722         <span class="keyword">if</span> strcmpi(Units, <span class="string">'Normalized'</span>)
0723             fprintf(<span class="string">'   Setting the command window units to pixels since the menu command fails with normalized units.\n'</span>);
0724             set(0,<span class="string">'units'</span>,<span class="string">'pixels'</span>);
0725         <span class="keyword">end</span>
0726         <span class="keyword">if</span> MorePlotsFlag == 0
0727             tmp = menu(<span class="string">''</span>, <span class="keyword">...</span>
0728                 <span class="string">'Apply orbit correction'</span>, <span class="keyword">...</span>
0729                 <span class="string">'Change the number of singular values'</span>, <span class="keyword">...</span>
0730                 <span class="string">'Change the BPMs'</span>, <span class="keyword">...</span>
0731                 <span class="string">'Change the correctors'</span>, <span class="keyword">...</span>
0732                 <span class="string">'Plot more information (AT Model required)'</span>, <span class="keyword">...</span>
0733                 <span class="string">'Exit - No orbit correction'</span>);
0734         <span class="keyword">else</span>
0735             tmp = menu(<span class="string">''</span>, <span class="keyword">...</span>
0736                 <span class="string">'Apply orbit correction'</span>, <span class="keyword">...</span>
0737                 <span class="string">'Change the number of singular values'</span>, <span class="keyword">...</span>
0738                 <span class="string">'Change the BPMs'</span>, <span class="keyword">...</span>
0739                 <span class="string">'Change the correctors'</span>, <span class="keyword">...</span>
0740                 <span class="string">'Close &quot;more information plot&quot;'</span>, <span class="keyword">...</span>
0741                 <span class="string">'Exit - No orbit correction'</span>);
0742         <span class="keyword">end</span>
0743         <span class="keyword">if</span> tmp == 6
0744             fprintf(<span class="string">'   Orbit not corrected\n'</span>);
0745             SVDquestion = <span class="string">'Correct not corrected'</span>;
0746             SetSPFlag = 0;
0747         <span class="keyword">elseif</span> tmp == 1
0748             SVDquestion = <span class="string">'Correct Orbit'</span>;
0749         <span class="keyword">elseif</span> tmp == 2
0750             <span class="comment">% Change the singular values</span>
0751             def = {sprintf(<span class="string">'[%d:%d]'</span>,OCS.SVDIndex(1),OCS.SVDIndex(end))};
0752             answer=inputdlg({<span class="string">'Which singular values:'</span>}, <span class="string">'SETORBIT'</span>, 1, def);
0753             <span class="keyword">if</span> ~isempty(answer)
0754                 tmp = str2num(answer{1});
0755 
0756                 <span class="comment">% Test for out-ot-range</span>
0757                 <span class="keyword">if</span> all(tmp&lt;=size(V,2)) &amp;&amp; ~isempty(tmp)
0758                     OCS.SVDIndex = tmp;
0759                 <span class="keyword">else</span>
0760                     fprintf(<span class="string">'   Singular value selection out-of-range.  Select again and try a new range.\n'</span>);
0761                 <span class="keyword">end</span>
0762             <span class="keyword">end</span>
0763         <span class="keyword">elseif</span> tmp == 3
0764             <span class="comment">% Change BPMs</span>
0765             <span class="keyword">for</span> i = 1:length(OCS.BPM)
0766                 List0 = OCS.BPM{i}.DeviceList;
0767                 ListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(OCS.BPM{i}.FamilyName);
0768                 j = findrowindex(OCS.BPM{i}.DeviceList, ListTotal);
0769                 CheckedList = zeros(size(ListTotal,1),1);
0770                 CheckedList(j) = 1;
0771                 OCS.BPM{i}.DeviceList = editlist(ListTotal, OCS.BPM{i}.FamilyName, CheckedList);
0772 
0773                 [j,jNotFound] = findrowindex(OCS.BPM{i}.DeviceList, List0);
0774                 <span class="keyword">if</span> isempty(jNotFound)
0775                     OCS.GoalOrbit{i} = OCS.GoalOrbit{i}(j);
0776                     <span class="keyword">if</span> ~isempty(OCS.BPMWeight{i}) &amp;&amp; isvector(OCS.BPMWeight{i})
0777                         OCS.BPMWeight{i} = OCS.BPMWeight{i}(j);
0778                     <span class="keyword">end</span>
0779                 <span class="keyword">else</span>
0780                     <span class="comment">% New BPMs were added</span>
0781                     <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'Golden'</span>))
0782                         OCS.GoalOrbit{i} = <a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0783                     <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'Offset'</span>))
0784                         OCS.GoalOrbit{i} = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0785                     <span class="keyword">else</span>
0786                         error(<span class="string">'Unknown goal orbit for the new BPMs'</span>);
0787                     <span class="keyword">end</span>
0788                     <span class="keyword">if</span> ~isempty(OCS.BPMWeight{i})
0789                         <span class="keyword">if</span> all(OCS.BPMWeight{i} == max(OCS.BPMWeight{i}))
0790                             <span class="comment">% If all the weights are the same, then the new BPMs get the same weight</span>
0791                             OCS.BPMWeight{i} = OCS.BPMWeight{i}(1) * ones(size(OCS.BPM{i}.DeviceList,1),1);
0792                         <span class="keyword">else</span>
0793                             error(<span class="string">'Unknown BPM weights for new BPMs'</span>);
0794                         <span class="keyword">end</span>
0795                     <span class="keyword">end</span>
0796                 <span class="keyword">end</span>
0797             <span class="keyword">end</span>
0798         <span class="keyword">elseif</span> tmp == 4
0799             <span class="comment">% Change correctors</span>
0800             <span class="keyword">for</span> i = 1:length(OCS.CM)
0801                 ListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(OCS.CM{i}.FamilyName);
0802                 j = findrowindex(OCS.CM{i}.DeviceList, ListTotal);
0803                 CheckedList = zeros(size(ListTotal,1),1);
0804                 CheckedList(j) = 1;
0805                 OCS.CM{i}.DeviceList = editlist(ListTotal, OCS.CM{i}.FamilyName, CheckedList);
0806             <span class="keyword">end</span>
0807         <span class="keyword">elseif</span> tmp == 5
0808             <span class="keyword">if</span> MorePlotsFlag == 0
0809                 MorePlotsFlag = 1;
0810             <span class="keyword">else</span>
0811                 MorePlotsFlag = 0;
0812                 close(FigHandles(2));
0813                 FigHandles = [FigHandles(1); NaN];
0814 
0815                 <span class="comment">% Make figure 1 a little wider</span>
0816                 p = get(FigHandles(1), <span class="string">'Position'</span>);
0817                 set(FigHandles(1), <span class="string">'Position'</span>, [p(1)-.1*p(3) p(2) p(3)+.1*p(3) p(4)]);
0818             <span class="keyword">end</span>
0819         <span class="keyword">end</span>
0820     <span class="keyword">else</span>
0821         SVDquestion = <span class="string">'Get out of loop'</span>;
0822     <span class="keyword">end</span>
0823 <span class="keyword">end</span>
0824 
0825 
0826 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0827 <span class="comment">% Exit if ~SetSPFlag %</span>
0828 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0829 <span class="keyword">if</span> ~SetSPFlag
0830     <span class="comment">%% Put Delta into OCS.CM (don't do this since setorbit can be called multiple times before correcting)</span>
0831     <span class="comment">%for i = 1:length(OCS.CM)</span>
0832     <span class="comment">%    OCS.CM{i}.Data = OCS.CM{i}.Data + OCS.CM{i}.Delta;</span>
0833     <span class="comment">%end</span>
0834     <span class="comment">%if OCS.FitRF</span>
0835     <span class="comment">%    OCS.RF.Data = OCS.RF.Data + OCS.DeltaRF;</span>
0836     <span class="comment">%end</span>
0837 
0838     <span class="comment">% Remove the cell array if it was not input as a cell array</span>
0839     <span class="keyword">if</span> NoCellBPMFlag
0840         OCS.BPM = OCS.BPM{1};
0841         OCS0.BPM = OCS0.BPM{1};
0842 
0843         OCS.GoalOrbit = OCS.GoalOrbit{1};
0844         OCS0.GoalOrbit = OCS0.GoalOrbit{1};
0845 
0846         OCS.BPMWeight = OCS.BPMWeight{1};
0847         OCS0.BPMWeight = OCS0.BPMWeight{1};
0848     <span class="keyword">end</span>
0849     <span class="keyword">if</span> NoCellCMFlag
0850         OCS.CM = OCS.CM{1};
0851         OCS0.CM = OCS0.CM{1};
0852 
0853         <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
0854             OCS.CMWeight = OCS.CMWeight{1};
0855             OCS0.CMWeight = OCS0.CMWeight{1};
0856         <span class="keyword">end</span>
0857     <span class="keyword">end</span>
0858     <span class="keyword">return</span>;
0859 <span class="keyword">end</span>
0860 
0861 
0862 
0863 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0864 <span class="comment">% Iterate on orbit correction %</span>
0865 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0866 
0867 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'MinimumPeriod'</span>)
0868     OCS.MinimumPeriod = 0;
0869 <span class="keyword">end</span>
0870 <span class="keyword">if</span> isempty(OCS.MinimumPeriod)
0871     OCS.MinimumPeriod = 0;
0872 <span class="keyword">end</span>
0873 
0874         
0875 <span class="comment">% Running flag</span>
0876 RingSetOrbit.RunFlag = 1;
0877 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0878 
0879 OCS.NCorrections = 0;
0880 <span class="keyword">for</span> iloop = 1:NumberOfTrys
0881     tic;
0882 
0883     <span class="comment">% The 1st iteration is already computed</span>
0884     <span class="keyword">if</span> iloop &gt; 1
0885         <span class="comment">% Build the new starting orbit</span>
0886         <span class="keyword">for</span> i = 1:length(OCS.BPM)
0887             OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0888         <span class="keyword">end</span>
0889 
0890         <span class="comment">% Compute the correction</span>
0891         OCS = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS, Smat, S, U, V);
0892     <span class="keyword">end</span>
0893 
0894 
0895     <span class="comment">% Tolerance check</span>
0896     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0897         TolFlag(i) = std(OCS.BPM{i}.Data(:) - OCS.GoalOrbit{i}(:)) &lt; OCS.Tolerance;
0898     <span class="keyword">end</span>
0899     <span class="keyword">if</span> all(TolFlag)
0900         <span class="keyword">break</span>;
0901     <span class="keyword">end</span>
0902 
0903     
0904     <span class="comment">% Put Delta into OCS.CM &amp; OCS.RF</span>
0905     <span class="keyword">for</span> i = 1:length(OCS.CM)
0906         OCS.CM{i}.Data = OCS.CM{i}.Data + OCS.CorrectorGain * OCS.CM{i}.Delta;
0907     <span class="keyword">end</span>
0908     <span class="keyword">if</span> OCS.FitRF
0909         OCS.RF.Data = OCS.RF.Data + OCS.CorrectorGain * OCS.DeltaRF;
0910     <span class="keyword">end</span>
0911 
0912     <span class="comment">% Check corrector power supply limits</span>
0913     <span class="keyword">for</span> i = 1:length(OCS.CM)
0914         MinSP = <a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>(OCS.CM{i});
0915         MaxSP = <a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>(OCS.CM{i});
0916         
0917         <span class="comment">% Since the Max or Min sign is really arbitary, any(OCS.CM{i}.Data &gt; MaxSP) will not work</span>
0918         <span class="comment">% For instance, a max in hardware units can be a min in physics units.</span>
0919         <span class="comment">% It's better to check if it's between the max and min</span>
0920         [Tmp, SortIndex] = sort([MinSP OCS.CM{i}.Data MaxSP],2);
0921         <span class="keyword">if</span> any(SortIndex(:,2) ~= 2)
0922             icm = find(SortIndex(:,2) ~= 2);
0923             <span class="keyword">for</span> j = 1:length(icm)
0924                 fprintf(<span class="string">'   Setting %s(%d,%d) to %f would exceed [%f %f] %s range.\n'</span>, OCS.CM{i}.FamilyName, OCS.CM{i}.DeviceList(icm(j),:), OCS.CM{i}.Data(icm(j)), MinSP(icm(j)), MaxSP(icm(j)), OCS.CM{i}.UnitsString);
0925             <span class="keyword">end</span>
0926             fprintf(<span class="string">'   Orbit correction stopped on iteration %d.\n   A power supply limit would have been exceeded!\n'</span>, iloop);
0927             RingSetOrbit.RunFlag = 0;
0928             setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0929             ErrorFlag = 1;
0930             <span class="keyword">break</span>;
0931             <span class="comment">%return;</span>
0932         <span class="keyword">end</span>
0933     <span class="keyword">end</span>
0934     <span class="keyword">if</span> ErrorFlag
0935         <span class="keyword">break</span>;
0936     <span class="keyword">end</span>
0937 
0938 
0939     <span class="comment">%if OCS.Display</span>
0940     <span class="comment">%    if OCS.NIter &gt; 1</span>
0941     <span class="comment">%        fprintf('   Iteration %d. Changing the correctors (%s)\n', iloop, datestr(clock, 0));</span>
0942     <span class="comment">%        if OCS.FitRF</span>
0943     <span class="comment">%            fprintf('   Iteration %d. Changing the RF frequency by %d %s\n', iloop, OCS.DeltaRF, OCS.RF.UnitsString);</span>
0944     <span class="comment">%        end</span>
0945     <span class="comment">%    else</span>
0946     <span class="comment">%        fprintf('   Setting the correctors (%s)\n', datestr(clock, 0));</span>
0947     <span class="comment">%        if OCS.FitRF</span>
0948     <span class="comment">%            fprintf('   Changing the RF frequency by %d %s (%s)\n', OCS.DeltaRF, OCS.RF.UnitsString, datestr(clock, 0));</span>
0949     <span class="comment">%        end</span>
0950     <span class="comment">%    end</span>
0951     <span class="comment">%end</span>
0952     
0953     <span class="comment">% Since power supplies get out of sync, it can be useful</span>
0954     <span class="comment">% to set the power supplies in smaller steps.</span>
0955     <span class="keyword">if</span> OCS.RampSteps == 1 || iloop &gt; 1
0956         <span class="comment">% Apply correction in 1 step</span>
0957         
0958         <span class="comment">% Set the RF frequency</span>
0959         <span class="keyword">if</span> OCS.FitRF
0960             <a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>(OCS.DeltaRF, -1, InputFlags{:});
0961         <span class="keyword">end</span>
0962 
0963         <span class="comment">% Set the correctors in one step</span>
0964         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(OCS.CM, -2, InputFlags{:});
0965 
0966     <span class="keyword">else</span>
0967 
0968         <span class="comment">% Apply correction slowly</span>
0969         CM  = OCS.CM;
0970         CM1 = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM,<span class="string">'Struct'</span>);
0971         CM2 = OCS.CM;
0972 
0973         <span class="keyword">if</span> OCS.FitRF
0974             dRF = OCS.DeltaRF / OCS.RampSteps;
0975         <span class="keyword">end</span>
0976 
0977         <span class="keyword">for</span> j = 1:OCS.RampSteps
0978             <span class="keyword">if</span> j == OCS.RampSteps
0979                 WaitFlag = -2;
0980             <span class="keyword">else</span>
0981                 WaitFlag = -1;
0982             <span class="keyword">end</span>
0983             
0984             <span class="keyword">if</span> OCS.FitRF
0985                 <a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>(dRF, -1, InputFlags{:});
0986             <span class="keyword">end</span>
0987 
0988             <span class="keyword">for</span> i = 1:length(OCS.CM)
0989                 CM{i}.Data = CM1{i}.Data + (CM2{i}.Data - CM1{i}.Data)*(j/OCS.RampSteps);
0990                 <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(CM{i}, WaitFlag, InputFlags{:});
0991             <span class="keyword">end</span>
0992         <span class="keyword">end</span>
0993     <span class="keyword">end</span>
0994     
0995 
0996     OCS.NCorrections = iloop;            <span class="comment">% Count the actual number of corrections made</span>
0997     sleep(ExtraDelay);
0998 
0999         
1000     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1001     <span class="comment">% Build the final orbit %</span>
1002     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1003     <span class="keyword">for</span> i = 1:length(OCS.BPM)
1004         <span class="keyword">if</span> OCS.NIter &gt; 0
1005             OCS.BPM{i}.Data = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>, InputFlags{:});
1006         <span class="keyword">end</span>
1007     <span class="keyword">end</span>
1008 
1009 
1010     <span class="comment">% Get the present setpoints</span>
1011     <span class="comment">% Some accelerators might have digitizing errors that gets picked up with a reread</span>
1012     OCS.CM = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM, <span class="string">'Struct'</span>, InputFlags{:});
1013 
1014     <span class="keyword">if</span> OCS.FitRF
1015         OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
1016     <span class="keyword">end</span>
1017 
1018 
1019     <span class="comment">% Display final result if OCS.Display, more than 0 iterations, and a setpoint change was made</span>
1020     <span class="comment">%if (OCS.Display | length(FigHandles&gt;=4)) &amp; OCS.NIter &amp; SetSPFlag</span>
1021     <span class="keyword">if</span> OCS.Display &amp;&amp; OCS.NIter &amp;&amp; SetSPFlag
1022         <a href="#_sub4" class="code" title="subfunction PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)">PostCorrectionDisplay</a>(AxesHandles, OCS0, OCS, Smat, S, U, V, iloop, NumberOfTrys, MorePlotsFlag, InputFlags);
1023     <span class="keyword">end</span>
1024 
1025     <span class="comment">% Update timestamp</span>
1026     <span class="keyword">if</span> OCS.Display &amp;&amp; isfield(OCS,<span class="string">'Handles'</span>) &amp;&amp; isfield(OCS.Handles, <span class="string">'TimeStamp'</span>) &amp;&amp; ~isempty(OCS.Handles.TimeStamp)
1027         set(OCS.Handles.TimeStamp, <span class="string">'String'</span>, datestr(clock,0));
1028         drawnow;
1029     <span class="keyword">end</span>
1030     
1031     
1032     <span class="keyword">if</span> iloop ~= NumberOfTrys
1033         <span class="comment">% Check if another application is trying to change a setting</span>
1034         [StopFlag, OCS, Smat, S, U, V, AxesHandles, MorePlotsFlag] = <a href="#_sub1" class="code" title="subfunction [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)">answersetorbitcall</a>(OCS, Smat, S, U, V, AxesHandles, InputFlags);
1035         <span class="keyword">if</span> StopFlag
1036             <span class="keyword">break</span>;
1037         <span class="keyword">end</span>
1038 
1039 
1040         <span class="comment">% Check beam current (this might be machine dependent)</span>
1041         <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; DCCTLOW
1042             fprintf(<span class="string">'   Orbit correction stopped on iteration %d.   Beam current is below .05 milliampere!\n'</span>, iloop);
1043             <span class="keyword">break</span>;
1044         <span class="keyword">end</span>
1045 
1046         
1047         <span class="comment">% Set the minimum update period</span>
1048         <span class="keyword">while</span> toc &lt; OCS.MinimumPeriod
1049             <span class="keyword">if</span> (OCS.MinimumPeriod-toc) &gt; .3
1050                 sleep(.3);
1051             <span class="keyword">else</span>
1052                 sleep(OCS.MinimumPeriod - toc);
1053             <span class="keyword">end</span>
1054 
1055             <span class="comment">% Check for a stop request or change to the minimum update period</span>
1056             [StopFlag, OCS, Smat, S, U, V, AxesHandles, MorePlotsFlag] = <a href="#_sub1" class="code" title="subfunction [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)">answersetorbitcall</a>(OCS, Smat, S, U, V, AxesHandles, InputFlags);
1057             <span class="keyword">if</span> StopFlag
1058                 <span class="keyword">break</span>;
1059             <span class="keyword">end</span>
1060         <span class="keyword">end</span>
1061     <span class="keyword">end</span>
1062 <span class="keyword">end</span>
1063 
1064 
1065 <span class="comment">% Orbit correction finished</span>
1066 RingSetOrbit.RunFlag = 0;
1067 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1068 
1069 
1070 <span class="comment">% For multiple iterations put the total change in the .Delta &amp; .DeltaRF fields</span>
1071 <span class="keyword">for</span> i = 1:length(OCS.CM)
1072     OCS.CM{i}.Delta = OCS.CM{i}.Data - OCS0.CM{i}.Data;
1073 <span class="keyword">end</span>
1074 <span class="keyword">if</span> OCS.FitRF
1075     OCS.DeltaRF = OCS.RF.Data - OCS0.RF.Data;
1076 <span class="keyword">end</span>
1077 
1078 
1079 <span class="comment">% Remove the cell array if the input was not a cell</span>
1080 <span class="keyword">if</span> NoCellBPMFlag
1081     OCS.BPM = OCS.BPM{1};
1082     OCS0.BPM = OCS0.BPM{1};
1083 
1084     OCS.GoalOrbit = OCS.GoalOrbit{1};
1085     OCS0.GoalOrbit = OCS0.GoalOrbit{1};
1086 
1087     OCS.BPMWeight = OCS.BPMWeight{1};
1088     OCS0.BPMWeight = OCS0.BPMWeight{1};
1089 <span class="keyword">end</span>
1090 <span class="keyword">if</span> NoCellCMFlag
1091     OCS.CM = OCS.CM{1};
1092     OCS0.CM = OCS0.CM{1};
1093     
1094     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
1095         OCS.CMWeight = OCS.CMWeight{1};
1096         OCS0.CMWeight = OCS0.CMWeight{1};
1097     <span class="keyword">end</span>
1098 <span class="keyword">end</span>
1099 
1100 
1101 <span class="comment">% if OCS.Display</span>
1102 <span class="comment">%     fprintf('   Orbit correction complete (%s)\n', datestr(clock, 0));</span>
1103 <span class="comment">% end</span>
1104 
1105 
1106 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
1107 <span class="comment">% End of Setorbit %</span>
1108 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
1109 
1110 
1111 
1112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1113 <span class="comment">% Ring/Answer Subroutine %</span>
1114 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1115 <a name="_sub1" href="#_subfunctions" class="code">function [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)</a>
1116 
1117 StopFlag = 0;
1118 MorePlotsFlag = 0;
1119 RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1120 
1121 <span class="keyword">if</span> ~isempty(RingSetOrbit)
1122 
1123     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'RunFlag'</span>)
1124         <span class="keyword">if</span> RingSetOrbit.RunFlag == -1
1125             StopFlag = 1;
1126         <span class="keyword">end</span>
1127         <span class="comment">%RingSetOrbit = rmfield(RingSetOrbit, 'RunFlag');</span>
1128         <span class="comment">%setappdata(0, 'RingSetOrbit', RingSetOrbit);</span>
1129     <span class="keyword">end</span>
1130 
1131     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'MinimumPeriod'</span>)
1132         OCS.MinimumPeriod = RingSetOrbit.MinimumPeriod;
1133         <span class="keyword">if</span> isempty(OCS.MinimumPeriod)
1134             OCS.MinimumPeriod = 0;
1135         <span class="keyword">end</span>
1136         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'MinimumPeriod'</span>);
1137         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1138     <span class="keyword">end</span>
1139 
1140     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'Display'</span>)
1141         OCS.Display = RingSetOrbit.Display;
1142         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'Display'</span>);
1143         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1144     <span class="keyword">end</span>
1145 
1146     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'CorrectorGain'</span>)
1147         OCS.CorrectorGain = RingSetOrbit.CorrectorGain;
1148         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'CorrectorGain'</span>);
1149         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1150     <span class="keyword">end</span>
1151 
1152     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'FigureHandles'</span>)
1153         FigureHandles = RingSetOrbit.FigureHandles;
1154         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'FigureHandles'</span>);
1155         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1156 
1157         <span class="keyword">if</span> length(FigureHandles) == 6
1158             <a href="#_sub3" class="code" title="subfunction drawmoreplots(Haxis, OCS, Smat, S, U, V)">drawmoreplots</a>(FigureHandles(4:6), OCS, Smat, S, U, V);
1159             <span class="comment">%MorePlotsFlag = 1;</span>
1160         <span class="keyword">end</span>
1161     <span class="keyword">end</span>
1162 
1163 
1164     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'FitRF'</span>)
1165         OCS.FitRF = RingSetOrbit.FitRF;
1166         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'FitRF'</span>);
1167         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1168         
1169         <span class="keyword">if</span> OCS.FitRF == 1
1170             <span class="comment">% Include the RF frequency next time</span>
1171             OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
1172             [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);  <span class="comment">% Get new S, U, V matrices</span>
1173         <span class="keyword">else</span>
1174             <span class="comment">% Don't include the RF frequency next time</span>
1175             OCS.FitRF = 0;
1176             [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);  <span class="comment">% Get new S, U, V matrices</span>
1177         <span class="keyword">end</span>
1178     <span class="keyword">end</span>
1179     
1180 <span class="keyword">end</span>
1181 
1182 
1183 
1184 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1185 <span class="comment">%  Pre-correction display %</span>
1186 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1187 <a name="_sub2" href="#_subfunctions" class="code">function [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)</a>
1188 
1189 <span class="comment">% Build the orbit vector</span>
1190 StartOrbitVec = [];
1191 Orbit0Vec = [];
1192 GoalOrbitVec = [];
1193 BPMWeight = [];
1194 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1195     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data];
1196     Orbit0Vec     = [Orbit0Vec;     OCS.BPM{i}.Data];
1197     GoalOrbitVec  = [GoalOrbitVec;  OCS.GoalOrbit{i}];
1198 
1199     <span class="keyword">if</span> isempty(OCS.BPMWeight{i})
1200         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];
1201     <span class="keyword">else</span>
1202         BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];
1203     <span class="keyword">end</span>
1204 <span class="keyword">end</span>
1205 
1206 <span class="comment">% Plot some stuff</span>
1207 L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
1208 <span class="keyword">if</span> isempty(L)
1209     <span class="keyword">global</span> THERING
1210     L = findspos(THERING, length(THERING)+1);
1211 <span class="keyword">end</span>
1212 
1213 
1214 <span class="keyword">if</span> isempty(H)
1215     HCF = get(0, <span class="string">'CurrentFigure'</span>);
1216     <span class="keyword">if</span> isempty(HCF)
1217         H = [gcf; NaN];
1218     <span class="keyword">else</span>
1219         <span class="keyword">if</span> rem(HCF,1)==0
1220             H = [HCF(1); NaN];
1221         <span class="keyword">else</span>
1222             H = [figure; NaN];
1223         <span class="keyword">end</span>
1224     <span class="keyword">end</span>
1225     <span class="comment">%drawnow</span>
1226     subfig(2,2,2, H(1));
1227     p = get(H(1), <span class="string">'Position'</span>);
1228     set(H(1), <span class="string">'Position'</span>, [p(1) p(2)-.8*p(4) p(3) p(4)+.8*p(4)]);
1229 <span class="keyword">end</span>
1230 
1231 
1232 <span class="keyword">if</span> length(H) &lt; 3
1233     figure(H(1));
1234     clf reset
1235     Haxis(1) = subplot(3,1,1);
1236     Haxis(2) = subplot(3,1,2);
1237     Haxis(3) = subplot(3,1,3);
1238     yaxesposition(1.05);
1239     orient portrait
1240 <span class="keyword">else</span>
1241     Haxis = H;
1242 <span class="keyword">end</span>
1243 
1244 
1245 ColorOrderMat = get(gca,<span class="string">'ColorOrder'</span>);
1246 
1247 
1248 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1249 <span class="comment">% Change in corrector %</span>
1250 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1251 axes(Haxis(1));
1252 <span class="keyword">for</span> i4 = 1:length(OCS.CM)
1253     CMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.CM{i4});
1254     [CMpos,isort] = sort(CMpos);
1255 
1256     <span class="comment">% Percentage from max</span>
1257     <span class="comment">%CMmax = maxsp(OCS.CM{i4});</span>
1258     <span class="comment">%plot(CMpos, 100*OCS.CM{i4}.Delta./CMmax, '.-','Color', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));</span>
1259     <span class="comment">%%plot(CMpos, 100*OCS.CM{i4}.Delta./CMmax,'-square','Color', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:), 'Markersize',3, 'MarkerFaceColor', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));</span>
1260     <span class="comment">%LabelCell4{i4} = sprintf('%s', OCS.CM{i4}.FamilyName);</span>
1261 
1262     <span class="comment">% Absolute corrector change</span>
1263     plot(CMpos, OCS.CM{i4}.Delta(isort), <span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));
1264     LabelCell4{i4} = sprintf(<span class="string">'%s [%s]'</span>, OCS.CM{i4}.FamilyName, OCS.CM{i4}.UnitsString);
1265     hold on;
1266 <span class="keyword">end</span>
1267 hold off;
1268 <span class="keyword">if</span> length(OCS.CM) == 1
1269     <span class="comment">%ylabel(sprintf('{\\Delta}%s [%%Max]', OCS.CM{1}.FamilyName));</span>
1270     ylabel(sprintf(<span class="string">'\\Delta %s [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1271 <span class="keyword">else</span>
1272     <span class="comment">%ylabel('\Delta Corrector [%Max]');</span>
1273     ylabel(<span class="string">'\Delta Corrector'</span>);
1274     h_legend = legend(LabelCell4, 0);
1275     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes1'</span>);
1276 <span class="keyword">end</span>
1277 
1278 <span class="comment">%if NumberOfTrys == 1</span>
1279 <span class="keyword">if</span> OCS.FitRF
1280     title({sprintf(<span class="string">'\\DeltaRF = %g %s   SV[%d out of %d]'</span>, OCS.DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="string">'Pre-Orbit Correction'</span>});
1281 <span class="keyword">else</span>
1282     title({sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="string">'Pre-Orbit Correction'</span>});
1283 <span class="keyword">end</span>
1284 
1285 <span class="comment">%xlabel('Position [Meters]');</span>
1286 xaxis([0 L]);
1287 <span class="comment">%set(gca,'XTickLabel','');</span>
1288 
1289 
1290 
1291 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1292 <span class="comment">% Plot Orbit Error %</span>
1293 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1294 axes(Haxis(2));
1295 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1296     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1297     [BPMpos, isort] = sort(BPMpos);
1298     plot(BPMpos, OCS.BPM{i}.Data(isort) - OCS.GoalOrbit{i}(isort),<span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1299     hold on;
1300     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1301 <span class="keyword">end</span>
1302 hold off
1303 <span class="keyword">if</span> length(LabelCell2) == 1
1304     ylabel(sprintf(<span class="string">'%s Starting Error [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1305 <span class="keyword">else</span>
1306     ylabel(<span class="string">'Starting Orbit Error'</span>);
1307     h_legend = legend(LabelCell2, 0);
1308     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes2'</span>);
1309 <span class="keyword">end</span>
1310 <span class="comment">%title(sprintf('Orbit Error Before Correction (Iteration 1 of %d)', NumberOfTrys));</span>
1311 <span class="comment">%xlabel('Position [Meters]');</span>
1312 xaxis([0 L]);
1313 <span class="comment">%set(gca,'XTickLabel','');</span>
1314 
1315 
1316 
1317 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
1318 <span class="comment">% Predicted Residual %</span>
1319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
1320 axes(Haxis(3));
1321 
1322 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1323     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1324     [BPMpos, isort] = sort(BPMpos);
1325 
1326     <span class="comment">% S-mat prediction: OrbitDelta + Error</span>
1327     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),<span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1328     hold on;
1329     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1330 <span class="keyword">end</span>
1331 hold off
1332 <span class="keyword">if</span> length(LabelCell2) == 1
1333     ylabel(sprintf(<span class="string">'%s Residual [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1334 <span class="keyword">else</span>
1335     ylabel(<span class="string">'Orbit Residual'</span>);
1336     h_legend = legend(LabelCell2, 0);
1337     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes3'</span>);
1338 <span class="keyword">end</span>
1339 <span class="comment">%title('Predicted Orbit Residual (by the Response Matrix)');</span>
1340 xlabel(<span class="string">'Position [Meters]'</span>);
1341 xaxis([0 L]);
1342 
1343 
1344 <span class="comment">% Add TimeStamp labels</span>
1345 <span class="keyword">if</span> length(H) &lt; 3
1346     OCS.Handles.TimeStamp = addlabel(1, 0, datestr(OCS.BPM{1}.TimeStamp,0));
1347 
1348     <span class="comment">%if OCS.FitRF</span>
1349     <span class="comment">%    OCS.Handles.RF = addlabel(0, 0, sprintf('RF frequency will be changed by  %g %s', OCS.DeltaRF, OCS.RF.UnitsString));</span>
1350     <span class="comment">%end</span>
1351 <span class="keyword">end</span>
1352 
1353 
1354 
1355 
1356 <span class="keyword">if</span> MorePlotsFlag || length(H)==6
1357 
1358     <span class="comment">%%%%%%%%%%%%%%%%</span>
1359     <span class="comment">% 3 More Plots %</span>
1360     <span class="comment">%%%%%%%%%%%%%%%%</span>
1361 
1362     <span class="keyword">if</span> length(H) &lt; 3
1363         <span class="keyword">if</span> isnan(H(2))
1364             H(2) = H(1) + 1;
1365             subfig(2,2,1,H(2));
1366             p = get(H(2), <span class="string">'Position'</span>);
1367             set(H(2), <span class="string">'Position'</span>, [p(1) p(2)-.8*p(4) p(3) p(4)+.8*p(4)]);
1368             p = get(H(2), <span class="string">'Position'</span>);
1369             set(H(2), <span class="string">'Position'</span>, [p(1)+.2*p(3) p(2) p(3)-.1*p(3) p(4)]);
1370 
1371             p = get(H(1), <span class="string">'Position'</span>);
1372             set(H(1), <span class="string">'Position'</span>, [p(1)+.1*p(3) p(2) p(3)-.1*p(3) p(4)]);
1373         <span class="keyword">end</span>
1374 
1375         figure(H(2));
1376         clf reset
1377 
1378         Haxis(4) = subplot(3,1,1);
1379         Haxis(5) = subplot(3,1,2);
1380         Haxis(6) = subplot(3,1,3);
1381         yaxesposition(1.05);
1382         orient portrait
1383     <span class="keyword">end</span>
1384 
1385     <a href="#_sub3" class="code" title="subfunction drawmoreplots(Haxis, OCS, Smat, S, U, V)">drawmoreplots</a>(Haxis(4:6), OCS, Smat, S, U, V);
1386 <span class="keyword">end</span>
1387 
1388 drawnow;
1389 
1390 
1391 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1392 <span class="comment">%  End pre-correction display  %</span>
1393 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1394 
1395 
1396 
1397 
1398 <a name="_sub3" href="#_subfunctions" class="code">function drawmoreplots(Haxis, OCS, Smat, S, U, V)</a>
1399 
1400 
1401 <span class="comment">%%%%%%%%%%%%%%%%</span>
1402 <span class="comment">% 3 More Plots %</span>
1403 <span class="comment">%%%%%%%%%%%%%%%%</span>
1404 
1405 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1406 <span class="comment">% Compute Orbit Error &amp; CM strength vs SVD Number %</span>
1407 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1408 
1409 <span class="comment">% Print wait messege</span>
1410 <span class="comment">%plot([0 1],[0 1],'w');</span>
1411 <span class="comment">%UnitsString = get(gca,'units');</span>
1412 <span class="comment">%set(gca,'units','characters');</span>
1413 <span class="comment">%p = get(gca,'Position');</span>
1414 <span class="comment">%set(gca,'XTick',[]); set(gca,'YTick',[]); cla; title(' '); xlabel(' '); ylabel(' ');</span>
1415 <span class="comment">%set(gca,'box','on');</span>
1416 <span class="comment">%Top = floor(p(4));</span>
1417 <span class="comment">%</span>
1418 <span class="comment">%text(4,Top-4,sprintf('Please wait ...'),'units','characters');</span>
1419 <span class="comment">%text(4,Top-6,sprintf('Computing correction performance'),'units','characters');</span>
1420 <span class="comment">%text(4,Top-7,sprintf('   as a function of singular value number.'),'units','characters');</span>
1421 <span class="comment">%set(gca, 'units', UnitsString);</span>
1422 <span class="comment">%drawnow;</span>
1423 
1424 
1425 <span class="comment">% The total kick as a function of SV</span>
1426 hbar = waitbar(0, <span class="string">'Computing Orbit Change vs SVD#.  Please wait ...'</span>);
1427 warning off;
1428 LastGoodSvalue = 1;
1429 OCStmp = OCS;
1430 N = length(S);
1431 <span class="keyword">for</span> i = 1:N
1432     lastwarn(<span class="string">''</span>);
1433     waitbar(i/N);
1434 
1435     OCStmp.SVDIndex = 1:i;
1436     OCStmp = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCStmp, Smat, S, U, V);
1437 
1438 
1439     <span class="comment">% RMS orbit change of the corrector magnets</span>
1440     <span class="keyword">for</span> j = 1:length(OCS.CM)
1441         <span class="keyword">if</span> isempty(lastwarn)
1442             CMSTDvec{j}(i) = std(OCStmp.CM{j}.Delta);
1443             CMTotal(j,i) = sum(abs(OCStmp.CM{j}.Delta));
1444         <span class="keyword">else</span>
1445             CMSTDvec{j}(i) = NaN;
1446             CMTotal(j,i) = NaN;
1447         <span class="keyword">end</span>
1448 
1449 
1450         <span class="comment">% S-mat prediction residual: PredictedOrbitData + Error</span>
1451         BPMresidual(j,i) = std(OCStmp.BPM{j}.PredictedOrbitDelta + (OCStmp.BPM{j}.Data-OCStmp.GoalOrbit{j}));
1452     <span class="keyword">end</span>
1453 
1454     <span class="keyword">if</span> isempty(lastwarn)
1455         LastGoodSvalue = i;
1456         DeltaRFvec(i,1) = OCStmp.DeltaRF;
1457     <span class="keyword">else</span>
1458         DeltaRFvec(i,1) = NaN;
1459         <span class="comment">%fprintf('\n   S-value number %d warning: %s', i, lastwarn);</span>
1460     <span class="keyword">end</span>
1461 <span class="keyword">end</span>
1462 <span class="keyword">try</span>
1463     close(hbar);
1464 <span class="keyword">catch</span>
1465 <span class="keyword">end</span>
1466 
1467 
1468 warning on;
1469 <span class="keyword">if</span> LastGoodSvalue ~= length(S)
1470     fprintf(<span class="string">'   Computational warning for choosing singular values above %d. \n'</span>, LastGoodSvalue);
1471 <span class="keyword">end</span>
1472 
1473 
1474 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1475 <span class="comment">% CM strength vs SVD number %</span>
1476 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1477 iSVDremove = 1:length(S);
1478 [tmp1, tmp2, i] = intersect(OCS.SVDIndex, iSVDremove);
1479 iSVDremove(i) = [];
1480 
1481 <span class="keyword">for</span> i = 1:length(OCS.CM)
1482     LabelCellCM{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.CM{i}.FamilyName, OCS.CM{i}.UnitsString);
1483 <span class="keyword">end</span>
1484 <span class="keyword">if</span> OCS.FitRF
1485     <span class="comment">%(Haxis(1));</span>
1486     [ax, h1, h2] = plotyy(Haxis(1), 1:length(S), CMTotal, 1:length(S), DeltaRFvec, @plot, @plot);
1487     set(get(ax(2),<span class="string">'Ylabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\DeltaRF Frequency [%s]'</span>, OCS.RF.UnitsString), <span class="string">'Color'</span>,[.5 0 0]);
1488     set(h1,<span class="string">'LineStyle'</span>,<span class="string">'-'</span>);
1489     set(h1,<span class="string">'Marker'</span>,<span class="string">'.'</span>);
1490     set(h1,<span class="string">'MarkerSize'</span>,6);
1491     set(h2,<span class="string">'LineStyle'</span>,<span class="string">'-'</span>);
1492     set(h2,<span class="string">'Color'</span>,[.5 0 0]);
1493     set(ax(2),<span class="string">'YColor'</span>,[.5 0 0]);
1494     set(h2,<span class="string">'Marker'</span>,<span class="string">'.'</span>);
1495     set(h2,<span class="string">'MarkerSize'</span>,6);
1496     <span class="comment">%set(get(ax(1),'XLabel'),'String', 'Singular Value Number');</span>
1497     <span class="comment">%set(get(ax(1),'Title'), 'String', 'Total Kick Strength');</span>
1498 
1499     set(ax(1),<span class="string">'XLim'</span>, [0 length(S)]);
1500     set(ax(2),<span class="string">'XLim'</span>, [0 length(S)]);
1501 
1502     set(get(ax(1),<span class="string">'XLabel'</span>),<span class="string">'String'</span>, <span class="string">''</span>);
1503     set(get(ax(2),<span class="string">'XLabel'</span>),<span class="string">'String'</span>, <span class="string">''</span>);
1504     <span class="comment">%set(ax(1),'XTickLabel', '');</span>
1505     <span class="comment">%set(ax(2),'XTickLabel', '');</span>
1506 
1507     set(get(ax(1),<span class="string">'title'</span>),<span class="string">'string'</span>, {<span class="string">'Performance vs. Number of Singular Values'</span>,sprintf(<span class="string">'Based on %s Orbit'</span>,datestr(OCS.BPM{1}.TimeStamp,0))});
1508 
1509     <span class="keyword">if</span> length(LabelCellCM) == 1
1510         set(get(ax(1),<span class="string">'YLabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\Sigma \\mid%s\\mid [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1511     <span class="keyword">else</span>
1512         set(get(ax(1),<span class="string">'YLabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\Sigma \\midCM\\mid'</span>));
1513         <span class="comment">%h_legend = legend(Haxis(1), LabelCellCM, 0);</span>
1514         <span class="comment">%set(h_legend, 'UserData', 'Axes4');</span>
1515         AxePosition = get(ax(2),<span class="string">'Position'</span>);
1516         set(ax(1),<span class="string">'Position'</span>, AxePosition);
1517     <span class="keyword">end</span>
1518 <span class="keyword">else</span>
1519     <span class="comment">%semilogy(1:length(S), CMTotal, '.-');</span>
1520     plot(Haxis(1), 1:length(S), CMTotal, <span class="string">'-'</span>);
1521     hold(Haxis(1), <span class="string">'on'</span>);
1522     plot(Haxis(1), OCS.SVDIndex, CMTotal(:,OCS.SVDIndex), <span class="string">'s'</span>, <span class="string">'markersize'</span>,2);
1523     plot(Haxis(1), iSVDremove,   CMTotal(:,iSVDremove),   <span class="string">'sr'</span>,<span class="string">'markersize'</span>,2);
1524     hold(Haxis(1), <span class="string">'off'</span>);
1525 
1526     <span class="keyword">if</span> length(LabelCellCM) == 1
1527         ylabel(Haxis(1), sprintf(<span class="string">'\\Sigma \\mid%s\\mid [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1528     <span class="keyword">else</span>
1529         ylabel(Haxis(1), <span class="string">'\Sigma \midCM\mid'</span>);
1530         <span class="comment">%h_legend = legend(Haxis(1), LabelCellCM, 0);</span>
1531         <span class="comment">%set(h_legend, 'UserData', 'Axes4');</span>
1532     <span class="keyword">end</span>
1533     <span class="comment">%xlabel(Haxis(1), 'Singular Value Number');</span>
1534     title(Haxis(1), {<span class="string">'Performance vs. Number of Singular Values'</span>,sprintf(<span class="string">'Based on %s Orbit'</span>,datestr(OCS.BPM{1}.TimeStamp,0))});
1535     
1536     axis(Haxis(1), <span class="string">'tight'</span>);
1537     a = axis(Haxis(1));
1538     axis(Haxis(1), [0 length(S) a(3:4)]);
1539     <span class="comment">%set(gca,'XTickLabel','');</span>
1540 <span class="keyword">end</span>
1541 
1542 
1543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1544 <span class="comment">% Plot Orbit Error vs SVD Number %</span>
1545 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1546 <span class="comment">%axes(Haxis(2));</span>
1547 ColorOrderMat = get(Haxis(2),<span class="string">'ColorOrder'</span>);
1548 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1549     <span class="comment">%BPMpos = getspos(OCS.BPM{i});</span>
1550     <span class="comment">%semilogy(1:length(S), CMSTDvec{i},'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1551     plot(Haxis(2), 1:length(S), BPMresidual(i,:),<span class="string">'-'</span>, <span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1552     hold(Haxis(2), <span class="string">'on'</span>);
1553     plot(Haxis(2), OCS.SVDIndex, BPMresidual(i,OCS.SVDIndex), <span class="string">'s'</span>, <span class="string">'markersize'</span>,2, <span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1554     plot(Haxis(2), iSVDremove,   BPMresidual(i,iSVDremove),   <span class="string">'sr'</span>,<span class="string">'markersize'</span>,2);
1555    
1556     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1557 <span class="keyword">end</span>
1558 hold(Haxis(2), <span class="string">'off'</span>);
1559 <span class="keyword">if</span> length(LabelCell2) == 1
1560     ylabel(Haxis(2), sprintf(<span class="string">'STD %s [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1561 <span class="keyword">else</span>
1562     ylabel(Haxis(2), <span class="string">'std(Residual)'</span>);
1563     <span class="comment">%h_legend = legend(Haxis(2), LabelCell2, 0);</span>
1564     <span class="comment">%set(h_legend, 'UserData', 'Axes5');</span>
1565 <span class="keyword">end</span>
1566 <span class="comment">%title(Haxis(2), 'Standard Deviation of the Predicted Orbit Residual');</span>
1567 <span class="comment">%xlabel(Haxis(2), 'Singular Value Number');</span>
1568 
1569 axis(Haxis(2), <span class="string">'tight'</span>);
1570 a = axis(Haxis(2));
1571 axis(Haxis(2), [0 length(S) a(3:4)]);
1572 <span class="comment">%set(gca,'XTickLabel','');</span>
1573 
1574 
1575 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%</span>
1576 <span class="comment">% Plot singular values %</span>
1577 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%</span>
1578 axes(Haxis(3));
1579 semilogy(S,<span class="string">'-b'</span>);
1580 hold on;
1581 semilogy(OCS.SVDIndex,S(OCS.SVDIndex),<span class="string">'sb'</span>,<span class="string">'markersize'</span>,2);
1582 semilogy(iSVDremove,S(iSVDremove),<span class="string">'sr'</span>,<span class="string">'markersize'</span>,2);
1583 hold off
1584 ylabel(<span class="string">'Magnitude'</span>);
1585 xlabel(<span class="string">'Singular Value Number'</span>);
1586 axis tight
1587 xaxis([0 length(S)]);
1588 
1589 drawnow;
1590 
1591 
1592 
1593 
1594 
1595 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1596 <span class="comment">%  Post-correction display  %</span>
1597 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1598 <a name="_sub4" href="#_subfunctions" class="code">function PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)</a>
1599 
1600 ColorOrderMat = get(gca,<span class="string">'ColorOrder'</span>);
1601 
1602 <span class="comment">% Build the orbit vectors</span>
1603 StartOrbitVec = [];
1604 Orbit0Vec = [];
1605 GoalOrbitVec = [];
1606 OrbitNewVec = [];
1607 <span class="comment">%BPMWeight = [];</span>
1608 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1609     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data];
1610     Orbit0Vec     = [Orbit0Vec;     OCS.BPM{i}.Data];
1611     GoalOrbitVec  = [GoalOrbitVec;  OCS.GoalOrbit{i}];
1612 
1613     <span class="comment">%OCS.BPM{i} = getpv(OCS.BPM{i}, 'Struct', InputFlags{:});</span>
1614     OrbitNewVec = [OrbitNewVec; OCS.BPM{i}.Data];
1615 
1616     <span class="comment">%if isempty(OCS.BPMWeight{i})</span>
1617     <span class="comment">%    BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];</span>
1618     <span class="comment">%else</span>
1619     <span class="comment">%    BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];</span>
1620     <span class="comment">%end</span>
1621 <span class="keyword">end</span>
1622 
1623 L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
1624 <span class="keyword">if</span> isempty(L)
1625     <span class="keyword">global</span> THERING
1626     L = findspos(THERING, length(THERING)+1);
1627 <span class="keyword">end</span>
1628 
1629 
1630 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1631 <span class="comment">% Plot cumulative change in the corrector %</span>
1632 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1633 set(H(1), <span class="string">'YLimMode'</span>, <span class="string">'Auto'</span>);
1634 hline = get(H(1), <span class="string">'Children'</span>);
1635 <span class="keyword">for</span> i = 1:length(OCS.CM)
1636     CMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.CM{i});
1637     [CMpos, isort] = sort(CMpos);
1638     set(hline(end-i+1), <span class="string">'YData'</span>, OCS.CM{i}.Data(isort)-OCS0.CM{i}.Data(isort));
1639 <span class="keyword">end</span>
1640 <span class="keyword">if</span> length(OCS.CM) == 1
1641     set(get(H(1),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, sprintf(<span class="string">'\\Delta %s [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1642 <span class="keyword">else</span>
1643     set(get(H(1),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, <span class="string">'\Delta Corrector'</span>);
1644 <span class="keyword">end</span>
1645 
1646 DeltaRF = OCS.RF.Data - OCS0.RF.Data;
1647 <span class="keyword">if</span> NumberOfTrys == 1
1648     <span class="keyword">if</span> OCS.FitRF
1649         TitleString = {sprintf(<span class="string">'\\DeltaRF = %g %s   SV[%d out of %d]'</span>, DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="string">'Post-Orbit Correction'</span>};
1650     <span class="keyword">else</span>
1651         TitleString = {sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="string">'Post-Orbit Correction'</span>};
1652     <span class="keyword">end</span>
1653 <span class="keyword">else</span>
1654     <span class="keyword">if</span> OCS.FitRF
1655         TitleString = {<span class="keyword">...</span>
1656             sprintf(<span class="string">'\\DeltaRF = %g %s    SV[%d out of %d]'</span>, DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="keyword">...</span>
1657             sprintf(<span class="string">'Iteration %d of %d'</span>, Iteration, NumberOfTrys)};
1658     <span class="keyword">else</span>
1659         TitleString = {<span class="keyword">...</span>
1660             sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="keyword">...</span>
1661             sprintf(<span class="string">'Iteration %d of %d'</span>, Iteration, NumberOfTrys)};
1662     <span class="keyword">end</span>
1663 <span class="keyword">end</span>
1664 set(get(H(1),<span class="string">'Title'</span>), <span class="string">'String'</span>, TitleString);
1665 
1666 <span class="comment">%set(gca,'XTickLabel','');</span>
1667 
1668 
1669 
1670 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1671 <span class="comment">% Plot Orbit Error %</span>
1672 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1673 set(H(3), <span class="string">'YLimMode'</span>, <span class="string">'Auto'</span>);
1674 hline = get(H(3), <span class="string">'Children'</span>);
1675 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1676     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1677     [BPMpos,isort] = sort(BPMpos);
1678     <span class="comment">%plot(BPMpos, OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1679     set(hline(end-i+1), <span class="string">'YData'</span>, OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort));
1680 <span class="keyword">end</span>
1681 <span class="keyword">if</span> length(OCS.BPM) == 1
1682     set(get(H(3),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, sprintf(<span class="string">'%s Remaining Error [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1683 <span class="keyword">else</span>
1684     set(get(H(3),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, <span class="string">'Remaining Orbit Error'</span>);
1685 <span class="keyword">end</span>
1686 
1687 
1688 <span class="comment">% if OCS.FitRF</span>
1689 <span class="comment">%     set(OCS.Handles.RF, 'String', sprintf(' RF frequency was changed by  %g %s', OCS.DeltaRF, OCS.RF.UnitsString));</span>
1690 <span class="comment">% end</span>
1691 
1692 
1693 drawnow;
1694 
1695 
1696 
1697 
1698 
1699 <span class="comment">% % Plot Orbit Error</span>
1700 <span class="comment">%</span>
1701 <span class="comment">% The problem here is the orbit gets updated but .PredictedOrbitDelta does not</span>
1702 <span class="comment">%</span>
1703 <span class="comment">% axes(H(3));</span>
1704 <span class="comment">%</span>
1705 <span class="comment">% ColorOrderMat = get(gca,'ColorOrder');</span>
1706 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1707 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1708 <span class="comment">%     [BPMpos, isort] = sort(BPMpos);</span>
1709 <span class="comment">%</span>
1710 <span class="comment">%     % S-mat prediction: OrbitDelta + Error</span>
1711 <span class="comment">%     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1712 <span class="comment">%     hold on;</span>
1713 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1714 <span class="comment">% end</span>
1715 <span class="comment">% hold off</span>
1716 <span class="comment">% if length(LabelCell2) == 1</span>
1717 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1718 <span class="comment">% else</span>
1719 <span class="comment">%     ylabel('Orbit Residual');</span>
1720 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1721 <span class="comment">% end</span>
1722 <span class="comment">% title('Predicted Orbit Residual (by the Response Matrix)');</span>
1723 <span class="comment">% xlabel('Position [Meters]');</span>
1724 <span class="comment">% xaxis([0 L]);</span>
1725 <span class="comment">% set(gca,'XTickLabel','');</span>
1726 
1727 
1728 
1729 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%</span>
1730 <span class="comment">% % Predicted Residual %</span>
1731 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%</span>
1732 <span class="comment">% if length(H) &lt; 3</span>
1733 <span class="comment">%     figure(H(1));</span>
1734 <span class="comment">%     subplot(3,1,3);</span>
1735 <span class="comment">% else</span>
1736 <span class="comment">%     axes(H(3));</span>
1737 <span class="comment">% end</span>
1738 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1739 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1740 <span class="comment">%     [BPMpos, isort] = sort(BPMpos);</span>
1741 <span class="comment">%</span>
1742 <span class="comment">%     % S-mat prediction: OrbitDelta + Error</span>
1743 <span class="comment">%     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1744 <span class="comment">%     hold on;</span>
1745 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1746 <span class="comment">% end</span>
1747 <span class="comment">% hold off</span>
1748 <span class="comment">% if length(LabelCell2) == 1</span>
1749 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1750 <span class="comment">% else</span>
1751 <span class="comment">%     ylabel('Orbit Residual');</span>
1752 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1753 <span class="comment">% end</span>
1754 <span class="comment">% %title('Predicted Orbit Residual (by the Response Matrix)');</span>
1755 <span class="comment">% xlabel('Position [Meters]');</span>
1756 <span class="comment">% xaxis([0 L]);</span>
1757 
1758 
1759 
1760 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1761 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1762 <span class="comment">%     [BPMpos,isort] = sort(BPMpos);</span>
1763 <span class="comment">%</span>
1764 <span class="comment">%     % S-mat prediction</span>
1765 <span class="comment">%     plot(BPMpos, (OCS0.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)) + (OCS.BPM{i}.PredictedOrbitDelta(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1766 <span class="comment">%     hold on;</span>
1767 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1768 <span class="comment">% end</span>
1769 <span class="comment">% hold off</span>
1770 <span class="comment">% if length(LabelCell2) == 1</span>
1771 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1772 <span class="comment">% else</span>
1773 <span class="comment">%     ylabel('Orbit Residual');</span>
1774 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1775 <span class="comment">% end</span>
1776 <span class="comment">% title('Predicted Orbit Residual (by the Response Matrix)');</span>
1777 <span class="comment">% xlabel('Position [Meters]');</span>
1778 <span class="comment">% xaxis([0 L]);</span>
1779 
1780 
1781 
1782 
1783 
1784 
1785 
1786 
1787 
1788 
1789 
1790 
1791 <span class="comment">%     %%%%%%%%%%%%%%%%%%%%%</span>
1792 <span class="comment">%     % Model predictions %</span>
1793 <span class="comment">%     %%%%%%%%%%%%%%%%%%%%%</span>
1794 <span class="comment">%     % %[Orbit0ModelX, Orbit0ModelY, Xpos, Ypos] = modeltwiss('x', 'All');</span>
1795 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1796 <span class="comment">%     %     OCS0Model.BPM{i} = getpv(OCS.BPM{i},'Model');</span>
1797 <span class="comment">%     % end</span>
1798 <span class="comment">%     %</span>
1799 <span class="comment">%     % % Step the model</span>
1800 <span class="comment">%     % for i = 1:length(OCS.CM)</span>
1801 <span class="comment">%     %     steppv(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, OCS.CM{i}.Delta, OCS.CM{i}.DeviceList, 'Model', InputFlags{:});</span>
1802 <span class="comment">%     % end</span>
1803 <span class="comment">%     % if OCS.FitRF</span>
1804 <span class="comment">%     %     stepsp('RF', OCS.DeltaRF, 'Model');</span>
1805 <span class="comment">%     % end</span>
1806 <span class="comment">%     %</span>
1807 <span class="comment">%     % %[OrbitModelX, OrbitModelY] = modeltwiss('x', 'All');</span>
1808 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1809 <span class="comment">%     %     OCSModel.BPM{i} = getpv(OCS.BPM{i},'Model');</span>
1810 <span class="comment">%     % end</span>
1811 <span class="comment">%     %</span>
1812 <span class="comment">%     % % Step the model back</span>
1813 <span class="comment">%     % for i = 1:length(OCS.CM)</span>
1814 <span class="comment">%     %     steppv(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, -1*OCS.CM{i}.Delta, OCS.CM{i}.DeviceList, 'Model', InputFlags{:});</span>
1815 <span class="comment">%     % end</span>
1816 <span class="comment">%     % if OCS.FitRF</span>
1817 <span class="comment">%     %     stepsp('RF', -OCS.DeltaRF, 'Model');</span>
1818 <span class="comment">%     % end</span>
1819 <span class="comment">%     %</span>
1820 <span class="comment">%     %</span>
1821 <span class="comment">%     % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1822 <span class="comment">%     % % Plot Orbit Residue based on the AT model %</span>
1823 <span class="comment">%     % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1824 <span class="comment">%     % axes(Haxis(7));</span>
1825 <span class="comment">%     % ColorOrderMat = get(gca,'ColorOrder');</span>
1826 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1827 <span class="comment">%     %     BPMpos = getspos(OCS.BPM{i});</span>
1828 <span class="comment">%     %     [BPMpos,isort] = sort(BPMpos);</span>
1829 <span class="comment">%     %</span>
1830 <span class="comment">%     %     % Model prediction Error</span>
1831 <span class="comment">%     %     plot(BPMpos, (OCSModel.BPM{i}.Data(isort)-OCS0Model.BPM{i}.Data(isort)) - (OCS.GoalOrbit{i}(isort)-OCS.BPM{i}.Data(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1832 <span class="comment">%     %</span>
1833 <span class="comment">%     %     % S-mat prediction</span>
1834 <span class="comment">%     %     %    plot(BPMpos, (OCS0.BPM{i}.Data-OCS.GoalOrbit{i}) + (BPMSVDDeltaCell{i}),':','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1835 <span class="comment">%     %     hold on;</span>
1836 <span class="comment">%     %     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1837 <span class="comment">%     % end</span>
1838 <span class="comment">%     % hold off</span>
1839 <span class="comment">%     % if length(LabelCell2) == 1</span>
1840 <span class="comment">%     %     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1841 <span class="comment">%     % else</span>
1842 <span class="comment">%     %     ylabel('Orbit Residual');</span>
1843 <span class="comment">%     %     h_legend = legend(LabelCell2, 0);</span>
1844 <span class="comment">%     % end</span>
1845 <span class="comment">%     % title('Predicted Orbit Residual (by the Nonlinear AT Model)');</span>
1846 <span class="comment">%     % xlabel('Position [Meters]');</span>
1847 <span class="comment">%     % xaxis([0 L]);</span>
1848 <span class="comment">%     %</span>
1849 <span class="comment">%     %</span>
1850 <span class="comment">%     % % Linearization Error</span>
1851 <span class="comment">%     % if length(H) &lt; 4</span>
1852 <span class="comment">%     %     figure(H(2));</span>
1853 <span class="comment">%     %     subplot(4,1,4);</span>
1854 <span class="comment">%     % else</span>
1855 <span class="comment">%     %     axes(H(8));</span>
1856 <span class="comment">%     % end</span>
1857 <span class="comment">%     % ColorOrderMat = get(gca,'ColorOrder');</span>
1858 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1859 <span class="comment">%     %     BPMpos = getspos(OCS.BPM{i});</span>
1860 <span class="comment">%     %     [BPMpos,isort] = sort(BPMpos);</span>
1861 <span class="comment">%     %</span>
1862 <span class="comment">%     %     % Model - S-matrix prediction</span>
1863 <span class="comment">%     %     plot(BPMpos, (OCSModel.BPM{i}.Data(isort)-OCS0Model.BPM{i}.Data(isort)) - OCS.BPM{i}.PredictedOrbitDelta(isort),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1864 <span class="comment">%     %     hold on;</span>
1865 <span class="comment">%     %     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1866 <span class="comment">%     % end</span>
1867 <span class="comment">%     % hold off</span>
1868 <span class="comment">%     % if length(LabelCell2) == 1</span>
1869 <span class="comment">%     %     %ylabel(sprintf('%s Linearization Error [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1870 <span class="comment">%     %     ylabel(sprintf('Linearization Error [%s]', OCS.BPM{1}.UnitsString));</span>
1871 <span class="comment">%     % else</span>
1872 <span class="comment">%     %     ylabel('Linearization Error');</span>
1873 <span class="comment">%     %     h_legend = legend(LabelCell2, 0);</span>
1874 <span class="comment">%     % end</span>
1875 <span class="comment">%     % title('Predicted Orbit Change Error (AT Model - Response Matrix)');</span>
1876 <span class="comment">%     % xlabel('Position [Meters]');</span>
1877 <span class="comment">%     % xaxis([0 L]);</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>