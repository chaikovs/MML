<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of modeltwiss</title>
  <meta name="keywords" content="modeltwiss">
  <meta name="description" content="MODELTWISS - Returns a twiss function of the model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mml</a> &gt; <a href="index.html">at</a> &gt; modeltwiss.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml/at&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>modeltwiss
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MODELTWISS - Returns a twiss function of the model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MODELTWISS - Returns a twiss function of the model
  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, DeviceList1, Family2, DeviceList2)
  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, Family2)
  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, DeviceList1)
  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString)

  INPUTS
  1. TwissData - Structure with the twiss parameters {Default: get from THERING{1}.TwissData}
  2. TwissString - 'beta'           for beta function [meters]
                   'mu' or 'Phase'  for betatron phase advance (NOT 2*PI normalized)
                   'alpha'          Derivative of the beta function
                   'ClosedOrbit' or 'x'       ('y'  reverses output  [ y,  x, Sy, Sx, Tune] = modeltwiss('y')) 
                   'ClosedOrbitPrime' or 'Px' ('Py' reverses output  [Py, Px, Sy, Sx, Tune] = modeltwiss('Py')) (momentum, NOT angle)
                   'Eta' for dispersion
                   'EtaPrime' for the derivative of dispersion
  3. Family1 and Family2 are the family names for where to measure the horizontal/vertical twiss parameter.
     A family name can be a middlelayer family or an AT family (FamName). 
     'All' returns the value at every element in the model plus the end of the ring.
     {Default or []: 'All'}
  4. DeviceList1 and DeviceList2 are the device list corresponding to Family1 and Family2.
     {Default or []: the entire list}

  OUTPUTS
  1. TwissX and TwissY - Horizontal and vertical twiss parameter
  2. Sx and Sy are longitudinal locations in the ring [meters]
  3. Tune - Fractional tune

  NOTES
  1. This function use twissline which uses the linear model.  See twissline 
     for all the assumption that it uses.
  2. This function uses the model coordinate system in physics units. 
     Ie., no BPM or CM gain or rolls errors are applied.
  3. Family1 and DeviceList1 can be any family.  For instance, if Family1='VCM'
     and DeviceList1=[], then TwissX is the horizontal beta function at the 
     vertical corrector magnets (similarly for Family2 and DeviceList2).
  4. If no output exists, the function will be plotted to the screen.
  5. Phase is in radians.

  See also <a href="modelbeta.html" class="code" title="function [BetaX, BetaY, Sx, Sy, Tune] = modelbeta(varargin)">modelbeta</a> <a href="modeltune.html" class="code" title="function [FractionalTune, IntegerTune] = modeltune">modeltune</a> <a href="modeldisp.html" class="code" title="function [Dx, Dy, Sx, Sy] = modeldisp(varargin)">modeldisp</a> <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a> <a href="setpvmodel.html" class="code" title="function ErrorFlag = setpvmodel(varargin)">setpvmodel</a>

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>	DRAWLATTICE - Draws the AT lattice to a figure</li><li><a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>	FAMILY2ATINDEX - Returns the AT index for a given family</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="modelbeta.html" class="code" title="function [BetaX, BetaY, Sx, Sy, Tune] = modelbeta(varargin)">modelbeta</a>	MODELBETA - Returns the beta function of the model</li><li><a href="modelchrosensitivity.html" class="code" title="function [DSx DSz] = modelchrosensitivity(varargin)">modelchrosensitivity</a>	TUNESENSITIVITY - Computes sextupole change for a given dxi</li><li><a href="modelcurlh.html" class="code" title="function [hx, hy] = modelcurlh">modelcurlh</a>	MODELCURLH - Computes and plots the H-curl functions</li><li><a href="modelphase.html" class="code" title="function [PhaseX, PhaseZ, Sx, Sz, Tune] = modelphase(varargin)">modelphase</a>	MODELBETA - Returns the Phase function of the model</li><li><a href="modeltunesensitivity.html" class="code" title="function [DKx DKz]=modeltunesensitivity(varargin)">modeltunesensitivity</a>	TUNESENSITIVITY - Computes quadrupole change for a given dnu</li><li><a href="plotmodelorbit.html" class="code" title="function varargout = plotcod">plotmodelorbit</a>	PLOTMODELORBIT - Plot closed orbit distortion</li><li><a href="plottwiss.html" class="code" title="function plottwiss(varargin)">plottwiss</a>	PLOTTWISS - Plot the optical functions and tune of the present lattice</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(varargin)</a>
0002 <span class="comment">%MODELTWISS - Returns a twiss function of the model</span>
0003 <span class="comment">%  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, DeviceList1, Family2, DeviceList2)</span>
0004 <span class="comment">%  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, Family2)</span>
0005 <span class="comment">%  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString, Family1, DeviceList1)</span>
0006 <span class="comment">%  [TwissX, TwissY, Sx, Sy, Tune] = modeltwiss(TwissData {opt.}, TwissString)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%  INPUTS</span>
0009 <span class="comment">%  1. TwissData - Structure with the twiss parameters {Default: get from THERING{1}.TwissData}</span>
0010 <span class="comment">%  2. TwissString - 'beta'           for beta function [meters]</span>
0011 <span class="comment">%                   'mu' or 'Phase'  for betatron phase advance (NOT 2*PI normalized)</span>
0012 <span class="comment">%                   'alpha'          Derivative of the beta function</span>
0013 <span class="comment">%                   'ClosedOrbit' or 'x'       ('y'  reverses output  [ y,  x, Sy, Sx, Tune] = modeltwiss('y'))</span>
0014 <span class="comment">%                   'ClosedOrbitPrime' or 'Px' ('Py' reverses output  [Py, Px, Sy, Sx, Tune] = modeltwiss('Py')) (momentum, NOT angle)</span>
0015 <span class="comment">%                   'Eta' for dispersion</span>
0016 <span class="comment">%                   'EtaPrime' for the derivative of dispersion</span>
0017 <span class="comment">%  3. Family1 and Family2 are the family names for where to measure the horizontal/vertical twiss parameter.</span>
0018 <span class="comment">%     A family name can be a middlelayer family or an AT family (FamName).</span>
0019 <span class="comment">%     'All' returns the value at every element in the model plus the end of the ring.</span>
0020 <span class="comment">%     {Default or []: 'All'}</span>
0021 <span class="comment">%  4. DeviceList1 and DeviceList2 are the device list corresponding to Family1 and Family2.</span>
0022 <span class="comment">%     {Default or []: the entire list}</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%  OUTPUTS</span>
0025 <span class="comment">%  1. TwissX and TwissY - Horizontal and vertical twiss parameter</span>
0026 <span class="comment">%  2. Sx and Sy are longitudinal locations in the ring [meters]</span>
0027 <span class="comment">%  3. Tune - Fractional tune</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%  NOTES</span>
0030 <span class="comment">%  1. This function use twissline which uses the linear model.  See twissline</span>
0031 <span class="comment">%     for all the assumption that it uses.</span>
0032 <span class="comment">%  2. This function uses the model coordinate system in physics units.</span>
0033 <span class="comment">%     Ie., no BPM or CM gain or rolls errors are applied.</span>
0034 <span class="comment">%  3. Family1 and DeviceList1 can be any family.  For instance, if Family1='VCM'</span>
0035 <span class="comment">%     and DeviceList1=[], then TwissX is the horizontal beta function at the</span>
0036 <span class="comment">%     vertical corrector magnets (similarly for Family2 and DeviceList2).</span>
0037 <span class="comment">%  4. If no output exists, the function will be plotted to the screen.</span>
0038 <span class="comment">%  5. Phase is in radians.</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%  See also modelbeta modeltune modeldisp getpvmodel setpvmodel</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%  Written by Greg Portmann</span>
0043 
0044 
0045 <span class="keyword">global</span> THERING
0046 <span class="keyword">if</span> isempty(THERING)
0047     error(<span class="string">'Simulator variable is not setup properly.'</span>);
0048 <span class="keyword">end</span>
0049 
0050 <span class="comment">% Default parameters if not overwritten</span>
0051 TwissString = <span class="string">'beta'</span>;
0052 Family1 = <span class="string">'ALL'</span>;
0053 Family2 = <span class="string">'ALL'</span>;
0054 <span class="comment">%Family1 = 'BPMx';</span>
0055 <span class="comment">%Family2 = 'BPMy';</span>
0056 DeviceList1 = [];   
0057 DeviceList2 = [];   
0058 DrawLatticeFlag = 0;
0059 
0060 
0061 <span class="comment">% Look for flags</span>
0062 <span class="keyword">for</span> i = length(varargin):-1:1
0063     <span class="keyword">if</span> ischar(varargin{i})
0064         <span class="keyword">if</span> strcmpi(varargin{i}, <span class="string">'DrawLattice'</span>)
0065             DrawLatticeFlag = 1;
0066             varargin(i) = [];
0067         <span class="keyword">end</span>
0068     <span class="keyword">end</span>
0069 <span class="keyword">end</span>
0070 
0071 
0072 <span class="comment">% Look for TwissString</span>
0073 <span class="keyword">if</span> length(varargin) &gt;= 1
0074     <span class="keyword">if</span> ischar(varargin{1})
0075         TwissString = varargin{1};
0076         varargin(1) = [];
0077     <span class="keyword">end</span>
0078 <span class="keyword">end</span>
0079 
0080 <span class="comment">% Look for BPMx family info</span>
0081 <span class="keyword">if</span> length(varargin) &gt;= 1
0082     <span class="keyword">if</span> ischar(varargin{1})
0083         Family1 = varargin{1};
0084         varargin(1) = [];
0085         <span class="keyword">if</span> length(varargin) &gt;= 1
0086             <span class="keyword">if</span> isnumeric(varargin{1})
0087                 DeviceList1 = varargin{1};
0088                 varargin(1) = [];
0089             <span class="keyword">end</span>
0090         <span class="keyword">end</span>
0091     <span class="keyword">else</span>
0092         <span class="keyword">if</span> isnumeric(varargin{1})
0093             DeviceList1 = varargin{1};
0094             varargin(1) = [];
0095         <span class="keyword">end</span>
0096     <span class="keyword">end</span>
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">% Look for BPMy family info</span>
0100 <span class="keyword">if</span> length(varargin) &gt;= 1
0101     <span class="keyword">if</span> ischar(varargin{1})
0102         Family2 = varargin{1};
0103         varargin(1) = [];
0104         <span class="keyword">if</span> length(varargin) &gt;= 1
0105             <span class="keyword">if</span> isnumeric(varargin{1})
0106                 DeviceList2 = varargin{1};
0107                 varargin(1) = [];
0108             <span class="keyword">end</span>
0109         <span class="keyword">end</span>
0110     <span class="keyword">else</span>
0111         <span class="keyword">if</span> isnumeric(varargin{1})
0112             DeviceList2 = varargin{1};
0113             varargin(1) = [];
0114         <span class="keyword">end</span>
0115     <span class="keyword">end</span>
0116 <span class="keyword">else</span>
0117     Family2 = Family1;
0118     DeviceList2 = DeviceList1;
0119 <span class="keyword">end</span>
0120 
0121 
0122 <span class="comment">% Horizontal plane</span>
0123 <span class="keyword">if</span> strcmpi(Family1,<span class="string">'All'</span>) 
0124     Index1 = 1:length(THERING)+1;
0125 <span class="keyword">elseif</span> isfamily(Family1)
0126     Index1 = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(Family1, DeviceList1);
0127 <span class="keyword">else</span>
0128     Index1 = findcells(THERING, <span class="string">'FamName'</span>, Family1);
0129 <span class="keyword">end</span>
0130 <span class="keyword">if</span> isempty(Index1)
0131     error(<span class="string">'Family1 could not be found in the AO or AT deck'</span>);
0132 <span class="keyword">else</span>
0133     Index1 = Index1(:)';    <span class="comment">% Row vector</span>
0134 <span class="keyword">end</span>
0135 
0136 <span class="comment">% Vertical plane</span>
0137 <span class="keyword">if</span> strcmpi(Family2,<span class="string">'All'</span>) 
0138     Index2 = 1:length(THERING)+1;
0139 <span class="keyword">elseif</span> isfamily(Family2)
0140     Index2 = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(Family2, DeviceList2);
0141 <span class="keyword">else</span>
0142     Index2 = findcells(THERING, <span class="string">'FamName'</span>, Family2);
0143 <span class="keyword">end</span>
0144 <span class="keyword">if</span> isempty(Index2)
0145     error(<span class="string">'Family2 could not be found in the AO or AT deck'</span>);
0146 <span class="keyword">else</span>
0147     Index2 = Index2(:)';    <span class="comment">% Row vector</span>
0148 <span class="keyword">end</span>
0149 
0150 MachineType = getfamilydata(<span class="string">'MachineType'</span>);
0151 <span class="keyword">if</span> any(strcmpi(MachineType, {<span class="string">'Transport'</span>,<span class="string">'Transportline'</span>,<span class="string">'Linac'</span>}))
0152     <span class="comment">% Transport line</span>
0153 
0154     <span class="comment">% Look for TWISSDATAIN</span>
0155     TWISSDATAIN = [];
0156     <span class="keyword">if</span> length(varargin) &gt;= 1
0157         <span class="keyword">if</span> isstruct(varargin{1})
0158             TWISSDATAIN = varargin{1};
0159             varargin(1) = [];
0160         <span class="keyword">end</span>
0161     <span class="keyword">end</span>
0162     <span class="keyword">if</span> isempty(TWISSDATAIN)
0163         <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'TwissData'</span>)
0164             TWISSDATAIN = THERING{1}.TwissData;
0165         <span class="keyword">else</span>
0166             TWISSDATAIN = getfamilydata(<span class="string">'TwissData'</span>);
0167             <span class="keyword">if</span> isempty(TWISSDATAIN)
0168                 error(<span class="string">'TWISSDATAIN must be an input, located in THERING{1}.TwissData, or accessible to getfamilydata.'</span>);
0169             <span class="keyword">end</span>
0170         <span class="keyword">end</span>
0171     <span class="keyword">end</span>
0172 
0173     <span class="keyword">if</span> strcmpi(TwissString, <span class="string">'Eta'</span>) || strcmpi(TwissString, <span class="string">'Dispersion'</span>)  || strcmpi(TwissString, <span class="string">'Disp'</span>)
0174         TD = twissline(THERING, 0, TWISSDATAIN, 1:(length(THERING)+1), <span class="string">'Chrom'</span>);
0175     <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'etaprime'</span>)
0176         TD = twissline(THERING, 0, TWISSDATAIN, 1:(length(THERING)+1), <span class="string">'Chrom'</span>);
0177     <span class="keyword">else</span>
0178         TD = twissline(THERING, 0, TWISSDATAIN, 1:(length(THERING)+1));
0179     <span class="keyword">end</span>
0180     
0181     <span class="comment">% Tune</span>
0182     Tune = TD(end).mu/2/pi;
0183     Tune = Tune(:);
0184 
0185 <span class="keyword">else</span>
0186     <span class="comment">% Storage ring</span>
0187     <span class="keyword">if</span> strcmpi(TwissString, <span class="string">'Eta'</span>) || strcmpi(TwissString, <span class="string">'Dispersion'</span>)
0188         <span class="comment">% if nargout == 0</span>
0189         <span class="comment">%     % To get the default plot</span>
0190         <span class="comment">%     modeldisp(Family1, DeviceList1, Family2, DeviceList2, 'Physics');</span>
0191         <span class="comment">% else</span>
0192         <span class="comment">%     [TwissX, TwissY, Sx, Sy] = modeldisp(Family1, DeviceList1, Family2, DeviceList2, 'Physics');</span>
0193         <span class="comment">% end</span>
0194         <span class="comment">% if nargout &gt;= 5</span>
0195         <span class="comment">%     Tune = modeltune;</span>
0196         <span class="comment">% end</span>
0197         <span class="comment">% return;</span>
0198         [TD, Tune] = twissring(THERING, 0, 1:(length(THERING)+1), <span class="string">'Chrom'</span>);
0199     <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'etaprime'</span>)
0200         [TD, Tune] = twissring(THERING, 0, 1:(length(THERING)+1), <span class="string">'Chrom'</span>);
0201     <span class="keyword">else</span>
0202         [TD, Tune] = twissring(THERING, 0, 1:(length(THERING)+1));
0203     <span class="keyword">end</span>
0204     Tune = Tune(:);
0205 <span class="keyword">end</span>
0206 
0207 
0208 <span class="keyword">if</span> strcmpi(TwissString, <span class="string">'Phase'</span>)
0209     TwissString = <span class="string">'mu'</span>;
0210 <span class="keyword">end</span>
0211 
0212 
0213 <span class="keyword">if</span> strcmpi(TwissString, <span class="string">'beta'</span>)
0214     Twiss = cat(1,TD.beta);
0215     TwissXAll = Twiss(:,1);
0216     TwissYAll = Twiss(:,2);
0217     TwissX = Twiss(Index1,1);
0218     TwissY = Twiss(Index2,2);
0219 
0220     <span class="comment">% Average of beginning and end of magnet</span>
0221     <span class="comment">%TwissXAll = [(Twiss(1:end-1,1)+Twiss(2:end,1))/2; Twiss(end,1)];</span>
0222     <span class="comment">%TwissYAll = [(Twiss(1:end-1,2)+Twiss(2:end,2))/2; Twiss(end,2)];</span>
0223     <span class="comment">%TwissX = (Twiss(Index1,1)+Twiss(Index1+1,1))/2;</span>
0224     <span class="comment">%TwissY = (Twiss(Index2,2)+Twiss(Index2+1,2))/2;</span>
0225 
0226     YLabel1 = sprintf(<span class="string">'\\beta_x [meters]'</span>);
0227     YLabel2 = sprintf(<span class="string">'\\beta_y [meters]'</span>);
0228     Title1  = sprintf(<span class="string">'\\beta-function (Tune = %.3f / %.3f)'</span>, Tune);
0229 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'mu'</span>)
0230     Twiss = cat(1,TD.mu);
0231     TwissXAll = Twiss(:,1);
0232     TwissYAll = Twiss(:,2);
0233     TwissX = Twiss(Index1,1);
0234     TwissY = Twiss(Index2,2);
0235 
0236     <span class="comment">%TwissXAll = [(Twiss(1:end-1,1)+Twiss(2:end,1))/2; Twiss(end,1)];</span>
0237     <span class="comment">%TwissYAll = [(Twiss(1:end-1,2)+Twiss(2:end,2))/2; Twiss(end,2)];</span>
0238     <span class="comment">%TwissX = (Twiss(Index1,1)+Twiss(Index1+1,1))/2;</span>
0239     <span class="comment">%TwissY = (Twiss(Index2,2)+Twiss(Index2+1,2))/2;</span>
0240 
0241     YLabel1 = sprintf(<span class="string">'\\%s_x [radians]'</span>, <span class="string">'phi'</span>);
0242     YLabel2 = sprintf(<span class="string">'\\%s_y [radians]'</span>, <span class="string">'phi'</span>);
0243     Title1  = sprintf(<span class="string">'Phase Advance (Tune = %.3f / %.3f)'</span>, Tune);
0244 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'dispersion'</span>) || strcmpi(TwissString, <span class="string">'disp'</span>) || strcmpi(TwissString, <span class="string">'eta'</span>)
0245     <span class="comment">%error('Use modeldisp');</span>
0246     Twiss = cat(2,TD.Dispersion)';
0247     TwissXAll = Twiss(:,1);
0248     TwissYAll = Twiss(:,3);
0249     TwissX = Twiss(Index1,1);
0250     TwissY = Twiss(Index2,3);
0251     YLabel1 = sprintf(<span class="string">'\\eta_x [m/(dp/p)]'</span>);
0252     YLabel2 = sprintf(<span class="string">'\\eta_y [m/(dp/p)]'</span>);
0253     Title1  = sprintf(<span class="string">'Dispersion'</span>);
0254 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'etaprime'</span>)
0255     Twiss = cat(2,TD.Dispersion)';
0256     TwissXAll = Twiss(:,2);
0257     TwissYAll = Twiss(:,4);
0258     TwissX = Twiss(Index1,2);
0259     TwissY = Twiss(Index2,4);
0260     YLabel1 = <span class="string">'\partial\eta_x / \partial \its'</span>;
0261     YLabel2 = <span class="string">'\partial\eta_y / \partial \its'</span>;
0262     Title1  = sprintf(<span class="string">'Derivative of the Dispersion'</span>);
0263 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'ClosedOrbit'</span>) ||  strcmpi(TwissString, <span class="string">'x'</span>)
0264     iCavity = findcells(THERING,<span class="string">'Frequency'</span>);
0265              
0266     <span class="keyword">if</span> isempty(iCavity)  <span class="comment">%no cavity in AT model</span>
0267         Twiss = cat(2,TD.ClosedOrbit)';
0268         <span class="comment">%Twiss = findsyncorbit(THERING, 0, ATIndexList);</span>
0269     <span class="keyword">else</span>
0270         <span class="comment">% Cavity in AT model</span>
0271         PassMethod = THERING{iCavity(1)}.PassMethod;
0272         <span class="keyword">for</span> kk = 1:length(iCavity)
0273             THERING{iCavity(kk)}.PassMethod = <span class="string">'IdentityPass'</span>;    <span class="comment">% Off</span>
0274         <span class="keyword">end</span>               
0275         
0276         C = 2.99792458e8;
0277         CavityFrequency  = THERING{iCavity(1)}.Frequency;
0278         CavityHarmNumber = THERING{iCavity(1)}.HarmNumber;
0279         L = findspos(THERING,length(THERING)+1); 
0280         f0 = C * CavityHarmNumber / L;
0281         DeltaRF = CavityFrequency - f0;   <span class="comment">% Hz</span>
0282         Twiss = findsyncorbit(THERING, -C*DeltaRF*CavityHarmNumber/CavityFrequency^2, 1:length(THERING)+1);
0283                 
0284         <span class="comment">% Reset PassMethod</span>
0285         <span class="keyword">for</span> kk = 1:length(iCavity)
0286             <span class="comment">%THERING{iCavity(kk)}.PassMethod = 'ThinCavityPass';  % On</span>
0287             THERING{iCavity(kk)}.PassMethod = PassMethod;
0288         <span class="keyword">end</span>
0289 
0290         Twiss = Twiss';
0291     <span class="keyword">end</span>
0292     TwissXAll = Twiss(:,1);
0293     TwissYAll = Twiss(:,3);
0294     TwissX = Twiss(Index1, 1);
0295     TwissY = Twiss(Index2, 3);
0296     YLabel1 = sprintf(<span class="string">'x [meter]'</span>);
0297     YLabel2 = sprintf(<span class="string">'y [meter]'</span>);
0298     Title1  = sprintf(<span class="string">'Closed Orbit'</span>);
0299 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'y'</span>)
0300     iCavity = findcells(THERING,<span class="string">'Frequency'</span>);
0301     <span class="keyword">if</span> isempty(iCavity)  <span class="comment">%no cavity in AT model</span>
0302         Twiss = cat(2,TD.ClosedOrbit)';
0303         <span class="comment">%Twiss = findsyncorbit(THERING, 0, ATIndexList);</span>
0304     <span class="keyword">else</span>
0305         <span class="comment">% Cavity in AT model</span>
0306         PassMethod = THERING{iCavity}.PassMethod;
0307         THERING{iCavity}.PassMethod = <span class="string">'IdentityPass'</span>;    <span class="comment">% Off</span>
0308         
0309         C = 2.99792458e8;
0310         CavityFrequency  = THERING{iCavity}.Frequency;
0311         CavityHarmNumber = THERING{iCavity}.HarmNumber;
0312         L = findspos(THERING,length(THERING)+1); 
0313         f0 = C * CavityHarmNumber / L;
0314         DeltaRF = CavityFrequency - f0;   <span class="comment">% Hz</span>
0315         Twiss = findsyncorbit(THERING, -C*DeltaRF*CavityHarmNumber/CavityFrequency^2, 1:length(THERING)+1);
0316         
0317         <span class="comment">% Reset PassMethod</span>
0318         <span class="comment">%THERING{iCavity}.PassMethod = 'ThinCavityPass';  % On</span>
0319         THERING{iCavity}.PassMethod = PassMethod;
0320 
0321         Twiss = Twiss';
0322     <span class="keyword">end</span> 
0323     TwissXAll = Twiss(:,3);
0324     TwissYAll = Twiss(:,1);
0325     TwissX = Twiss(Index1, 3);
0326     TwissY = Twiss(Index2, 1);
0327     YLabel1 = sprintf(<span class="string">'y [meter]'</span>);
0328     YLabel2 = sprintf(<span class="string">'x [meter]'</span>);
0329     Title1  = sprintf(<span class="string">'Closed Orbit'</span>);
0330 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'ClosedOrbitPrime'</span>) || strcmpi(TwissString, <span class="string">'Px'</span>)
0331     Twiss = cat(2,TD.ClosedOrbit)';
0332     TwissXAll = Twiss(:,2);
0333     TwissYAll = Twiss(:,4);
0334     TwissX = Twiss(Index1, 2);
0335     TwissY = Twiss(Index2, 4);
0336     YLabel1 = <span class="string">'P_x'</span>;
0337     YLabel2 = <span class="string">'P_y'</span>;
0338     Title1  = <span class="string">'Derivative of the Closed Orbit'</span>;
0339 <span class="keyword">elseif</span> strcmpi(TwissString, <span class="string">'Py'</span>)
0340     Twiss = cat(2,TD.ClosedOrbit)';
0341     TwissXAll = Twiss(:,4);
0342     TwissYAll = Twiss(:,2);
0343     TwissX = Twiss(Index1, 4);
0344     TwissY = Twiss(Index2, 2);
0345     YLabel1 = <span class="string">'P_y'</span>;
0346     YLabel2 = <span class="string">'P_x'</span>;
0347     Title1  = <span class="string">'Derivative of the Closed Orbit'</span>;
0348 <span class="keyword">else</span>
0349     Twiss = cat(1,TD.(TwissString));
0350     TwissXAll = Twiss(:,1);
0351     TwissYAll = Twiss(:,2);
0352     TwissX = Twiss(Index1, 1);
0353     TwissY = Twiss(Index2, 2);
0354     YLabel1 = sprintf(<span class="string">'\\%s_x'</span>, TwissString);
0355     YLabel2 = sprintf(<span class="string">'\\%s_y'</span>, TwissString);
0356     Title1  = sprintf(<span class="string">'\\%s-functions'</span>, TwissString);
0357 <span class="keyword">end</span>
0358 
0359 
0360 <span class="comment">% Longitudinal position</span>
0361 SAll = cat(1,TD.SPos);
0362 Sx = SAll(Index1);
0363 Sy = SAll(Index2);
0364 
0365 Sx = Sx(:);
0366 Sy = Sy(:);
0367 SAll = SAll(:);
0368 
0369 <span class="comment">% Twiss = Twiss;</span>
0370 <span class="comment">% TwissX = TwissX;</span>
0371 <span class="comment">% TwissY = TwissY;</span>
0372 <span class="comment">% TwissXAll = TwissXAll;</span>
0373 <span class="comment">% TwissYAll = TwissYAll;</span>
0374 
0375 
0376 <span class="comment">% Output</span>
0377 <span class="keyword">if</span> nargout == 0
0378     <span class="comment">% Plot</span>
0379     <span class="keyword">if</span> strcmpi(TwissString, <span class="string">'mu'</span>)
0380         <span class="comment">% Keep phase plot between -pi and pi</span>
0381         xall = [];
0382         sxall= [];
0383         <span class="keyword">for</span> i = 1:length(TwissXAll)
0384             <span class="keyword">if</span> TwissXAll(i) &gt; 2*pi
0385                 TwissXAll(i:end) = TwissXAll(i:end) - 2*pi;
0386                 xall = [xall; 2*pi; 0];    
0387                 sxall = [sxall; mean(SAll(i-1:i)); mean(SAll(i-1:i))];
0388                 xall = [xall; TwissXAll(i)];
0389                 sxall = [sxall; SAll(i)];
0390             <span class="keyword">else</span>
0391                 xall = [xall; TwissXAll(i)];
0392                 sxall = [sxall; SAll(i)];
0393             <span class="keyword">end</span>
0394         <span class="keyword">end</span>
0395         TwissX = rem(TwissX,2*pi);
0396         
0397         yall = [];
0398         syall= [];
0399         <span class="keyword">for</span> i = 1:length(TwissYAll)
0400             <span class="keyword">if</span> TwissYAll(i) &gt; 2*pi
0401                 TwissYAll(i:end) = TwissYAll(i:end) - 2*pi;
0402                 yall = [yall; 2*pi; 0];    
0403                 syall = [syall; mean(SAll(i-1:i)); mean(SAll(i-1:i))];
0404                 yall = [yall; TwissYAll(i)];
0405                 syall = [syall; SAll(i)];
0406             <span class="keyword">else</span>
0407                 yall = [yall; TwissYAll(i)];
0408                 syall = [syall; SAll(i)];
0409             <span class="keyword">end</span>
0410         <span class="keyword">end</span>
0411         TwissY = rem(TwissY,2*pi);
0412         
0413         clf reset
0414         h1 = subplot(5,1,[1 2]);
0415         <span class="comment">% plot Twiss paramaters</span>
0416         plot(sxall, xall, <span class="string">'-b'</span>);
0417         <span class="keyword">if</span> strcmpi(Family1,<span class="string">'All'</span>)
0418             xlabel(<span class="string">'Position [meters]'</span>);
0419         <span class="keyword">else</span>
0420             hold on;
0421             plot(Sx, TwissX, <span class="string">'.b'</span>);
0422             hold off;
0423             xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family1));
0424         <span class="keyword">end</span>
0425         ylabel(YLabel1);
0426         title(Title1, <span class="string">'Fontsize'</span>, 12);
0427         yaxis([0 2*pi]);
0428         xaxis([SAll(1) SAll(end)]);
0429         
0430         <span class="comment">% plot lattice</span>
0431         h2 = subplot(5,1,3);
0432         <a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>;
0433         
0434         h3 = subplot(5,1,[4 5]);
0435         <span class="comment">% plot Twiss paramaters</span>
0436         plot(syall, yall, <span class="string">'-b'</span>);
0437         <span class="keyword">if</span> strcmpi(Family2,<span class="string">'All'</span>)
0438             xlabel(<span class="string">'Position [meters]'</span>);
0439         <span class="keyword">else</span>
0440             hold on;
0441             plot(Sy, TwissY, <span class="string">'.b'</span>);
0442             hold off;
0443             xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family2));
0444         <span class="keyword">end</span>
0445         ylabel(YLabel2);
0446         yaxis([0 2*pi]);
0447         xaxis([SAll(1) SAll(end)]);
0448         
0449         linkaxes([h1 h2 h3],<span class="string">'x'</span>)
0450         set([h1 h2 h3],<span class="string">'XGrid'</span>,<span class="string">'On'</span>,<span class="string">'YGrid'</span>,<span class="string">'On'</span>);
0451     <span class="keyword">else</span>
0452         clf reset
0453         h1 = subplot(5,1,[1 2]);
0454         <span class="comment">% plot Twiss paramaters</span>
0455         plot(SAll, TwissXAll, <span class="string">'-b'</span>);
0456         <span class="keyword">if</span> strcmpi(Family1,<span class="string">'All'</span>)
0457             xlabel(<span class="string">'Position [meters]'</span>);
0458         <span class="keyword">else</span>
0459             hold on;
0460             plot(Sx, TwissX, <span class="string">'.b'</span>);
0461             hold off;
0462             xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family1));
0463         <span class="keyword">end</span>
0464         ylabel(YLabel1);
0465         title(Title1, <span class="string">'Fontsize'</span>, 12);
0466         xaxis([SAll(1) SAll(end)]);
0467         
0468         <span class="comment">% plot lattice</span>
0469         h2 = subplot(5,1,3);
0470         <a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>;
0471         
0472         h3 = subplot(5,1,[4 5]);
0473         <span class="comment">% plot Twiss parmaters</span>
0474         plot(SAll, TwissYAll, <span class="string">'-b'</span>);
0475         <span class="keyword">if</span> strcmpi(Family2,<span class="string">'All'</span>)
0476             xlabel(<span class="string">'Position [meters]'</span>);
0477         <span class="keyword">else</span>
0478             hold on;
0479             plot(Sy, TwissY, <span class="string">'.b'</span>);
0480             hold off;
0481             xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family2));
0482         <span class="keyword">end</span>
0483         ylabel(YLabel2);
0484         xaxis([SAll(1) SAll(end)]);
0485         
0486         linkaxes([h1 h2 h3],<span class="string">'x'</span>)
0487         set([h1 h2 h3],<span class="string">'XGrid'</span>,<span class="string">'On'</span>,<span class="string">'YGrid'</span>,<span class="string">'On'</span>);
0488 
0489         grid on;
0490     <span class="keyword">end</span>
0491 
0492     <span class="keyword">if</span> DrawLatticeFlag
0493         subplot(2,1,1);
0494         hold on
0495         a = axis;
0496         <a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>(a(4)-.08*(a(4)-a(3)),.05*(a(4)-a(3)));
0497         <span class="comment">%drawlattice(a(4)-.5*(a(4)-a(3)),.05*(a(4)-a(3)));</span>
0498         hold off;
0499         <span class="comment">%subplot(2,1,2);</span>
0500         <span class="comment">%hold on</span>
0501         <span class="comment">%a = axis;</span>
0502         <span class="comment">%drawlattice(a(4)-.08*(a(4)-a(3)),.05*(a(4)-a(3)));</span>
0503         <span class="comment">%hold off;</span>
0504 
0505         <span class="comment">% subplot(2,1,1);</span>
0506         <span class="comment">% xlabel('');</span>
0507         <span class="comment">%</span>
0508         <span class="comment">% h = subplot(17,1,9);</span>
0509         <span class="comment">% drawlattice(0, 1, h);</span>
0510         <span class="comment">% %set(h,'Visible','Off');</span>
0511         <span class="comment">% set(h,'Color','None');</span>
0512         <span class="comment">% set(h,'XMinorTick','Off');</span>
0513         <span class="comment">% set(h,'XMinorGrid','Off');</span>
0514         <span class="comment">% set(h,'YMinorTick','Off');</span>
0515         <span class="comment">% set(h,'YMinorGrid','Off');</span>
0516         <span class="comment">% set(h,'XTickLabel',[]);</span>
0517         <span class="comment">% set(h,'YTickLabel',[]);</span>
0518         <span class="comment">% set(h,'XLim', [0 Cir]);</span>
0519         <span class="comment">% set(h,'YLim', [-1.5 1.5]);</span>
0520     <span class="keyword">end</span>
0521 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>