<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calccoupling</title>
  <meta name="keywords" content="calccoupling">
  <meta name="description" content="CALCCOUPLING - Calculates the coupling and tilt of the AT model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mml</a> &gt; <a href="index.html">at</a> &gt; calccoupling.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml/at&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>calccoupling
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>CALCCOUPLING - Calculates the coupling and tilt of the AT model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [Tilt, Eta, Ratio, ENV, DP, DL] = calccoupling </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">CALCCOUPLING - Calculates the coupling and tilt of the AT model
  [Eta, Tilt, EmittanceRatio, ENV, DP, DL] = calccoupling

  OUTPUTS
  1. Tilt - Tilts of the emittance ellipse [radian]
  2. Eta - Emittance
  3. EmittanceRatio - median(EpsX) / median(EpsX)
  4-6. ENV, DP, DL - Output of ohmienvelope

  NOTES
  1. If there are no outputs, the coupling information will be plotted.
  2. It can be helpful the draw the lattice on top of a graph (hold on; drawlattice(Offset, Height);)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>	FAMILY2ATINDEX - Returns the AT index for a given family</li><li><a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>	GETCAVITY - Returns the RF cavity state ('On' / 'Off')</li><li><a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>	SETCAVITY - Set the RF cavity state</li><li><a href="setpassmethod.html" class="code" title="function setpassmethod(ATIndex, PassMethod, DeviceList)">setpassmethod</a>	SETPASSMETHOD - Sets the PassMethod</li><li><a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a>	SETRADIATION - Sets the model PassMethod to include or exclude radiation ('On' / 'Off' {Default})</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Tilt, Eta, Ratio, ENV, DP, DL] = calccoupling</a>
0002 <span class="comment">%CALCCOUPLING - Calculates the coupling and tilt of the AT model</span>
0003 <span class="comment">%  [Eta, Tilt, EmittanceRatio, ENV, DP, DL] = calccoupling</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%  OUTPUTS</span>
0006 <span class="comment">%  1. Tilt - Tilts of the emittance ellipse [radian]</span>
0007 <span class="comment">%  2. Eta - Emittance</span>
0008 <span class="comment">%  3. EmittanceRatio - median(EpsX) / median(EpsX)</span>
0009 <span class="comment">%  4-6. ENV, DP, DL - Output of ohmienvelope</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%  NOTES</span>
0012 <span class="comment">%  1. If there are no outputs, the coupling information will be plotted.</span>
0013 <span class="comment">%  2. It can be helpful the draw the lattice on top of a graph (hold on; drawlattice(Offset, Height);)</span>
0014 
0015 <span class="comment">%</span>
0016 <span class="comment">%  Written by James Safranek</span>
0017 
0018 
0019 <span class="keyword">global</span> THERING
0020     
0021 
0022 C0 = 299792458;      <span class="comment">% Speed of light [m/s]</span>
0023 
0024 ati = atindex(THERING);
0025 L0 = findspos(THERING, length(THERING)+1);
0026 
0027 <span class="comment">% HarmNumber = 936;</span>
0028 <span class="comment">% THERING{ati.RF}.Frequency = HarmNumber*C0/L0;</span>
0029 <span class="comment">% THERING{ati.RF}.PassMethod = 'CavityPass';</span>
0030 <span class="comment">% for i = ati.RF</span>
0031 <span class="comment">%     THERING{i}.Frequency = THERING{i}.HarmNumber*C0/L0;</span>
0032 <span class="comment">%     THERING{i}.PassMethod = 'CavityPass';</span>
0033 <span class="comment">% end</span>
0034 
0035 
0036 [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = <a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a>(<span class="string">'On'</span>);
0037 
0038 CavityState = <a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>;
0039 <a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>(<span class="string">'On'</span>);
0040 
0041 
0042 <span class="comment">% Get all the AT elements that add radiation</span>
0043 BendCell = findmemberof(<span class="string">'BEND'</span>);
0044 iBend = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(BendCell);
0045 <span class="keyword">for</span> ii = 1:length(iBend)
0046     <span class="keyword">if</span> size(iBend{ii},2) &gt; 1
0047         iBend{ii} = sort(iBend{ii}(:));
0048         nanindx = find(isnan(iBend{ii}));
0049         iBend{ii}(nanindx) = [];
0050     <span class="keyword">end</span>
0051 <span class="keyword">end</span>
0052 iBend = cell2mat(iBend(:));
0053 
0054 
0055 QuadCell = findmemberof(<span class="string">'QUAD'</span>);
0056 iQuad = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(QuadCell);
0057 <span class="keyword">for</span> ii = 1:length(iQuad)
0058     <span class="keyword">if</span> size(iQuad{ii},2) &gt; 1
0059         iQuad{ii} = sort(iQuad{ii}(:));
0060         nanindx = find(isnan(iQuad{ii}));
0061         iQuad{ii}(nanindx) = [];
0062     <span class="keyword">end</span>
0063 <span class="keyword">end</span>
0064 iQuad = cell2mat(iQuad(:));
0065 
0066 
0067 SextCell = findmemberof(<span class="string">'SEXT'</span>);
0068 iSext = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(SextCell);
0069 <span class="keyword">for</span> ii = 1:length(iSext)
0070     <span class="keyword">if</span> size(iSext{ii},2) &gt; 1
0071         iSext{ii} = sort(iSext{ii}(:));
0072         nanindx = find(isnan(iSext{ii}));
0073         iSext{ii}(nanindx) = [];
0074     <span class="keyword">end</span>
0075 <span class="keyword">end</span>
0076 iSext = cell2mat(iSext(:));
0077 
0078 
0079 RadiationElemIndex = sort([iBend(:); iQuad(:); iSext(:)]');
0080 <span class="comment">%RadiationElemIndex(find(isnan(RadiationElemIndex))) = [];</span>
0081 
0082 [ENV, DP, DL] = ohmienvelope(THERING, RadiationElemIndex, 1:length(THERING)+1);
0083 
0084 sigmas = cat(2, ENV.Sigma);
0085 Tilt = cat(2, ENV.Tilt);
0086 spos = findspos(THERING, 1:length(THERING)+1);
0087 
0088 [TwissData, tune, chrom]  = twissring(THERING, 0, 1:length(THERING)+1, <span class="string">'chrom'</span>);
0089 
0090 
0091 <span class="comment">% The the passmethods back</span>
0092 <a href="setpassmethod.html" class="code" title="function setpassmethod(ATIndex, PassMethod, DeviceList)">setpassmethod</a>(ATIndexOld, PassMethodOld);
0093 <a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>(CavityState);
0094 
0095 
0096 <span class="comment">% Calculate tilts</span>
0097 Beta = cat(1,TwissData.beta);
0098 spos = cat(1,TwissData.SPos);
0099 
0100 Eta = cat(2,TwissData.Dispersion);
0101 EpsX = (sigmas(1,:).^2-Eta(1,:).^2*DP^2)./Beta(:,1)';
0102 EpsY = (sigmas(2,:).^2-Eta(3,:).^2*DP^2)./Beta(:,2)';
0103 
0104 <span class="comment">% RMS tilt</span>
0105 TiltRMS = norm(Tilt)/sqrt(length(Tilt));
0106 EtaY = Eta(3,:);
0107 
0108 EpsX0 = mean(EpsX);
0109 EpsY0 = mean(EpsY);
0110 <span class="comment">%EpsX0 = median(EpsX);</span>
0111 <span class="comment">%EpsY0 = median(EpsY);</span>
0112 Ratio = EpsY0 / EpsX0;
0113 
0114 
0115 <span class="comment">% Fix imaginary data</span>
0116 <span class="comment">% ohmienvelope seems to return complex when very close to zero</span>
0117 <span class="keyword">if</span> ~isreal(sigmas(1,:))
0118     <span class="comment">% Sigma is positive so this should be ok</span>
0119     sigmas(1,:) = abs(sigmas(1,:));
0120 <span class="keyword">end</span>
0121 <span class="keyword">if</span> ~isreal(sigmas(2,:))
0122     <span class="comment">% Sigma is positive so this should be ok</span>
0123     sigmas(2,:) = abs(sigmas(2,:));
0124 <span class="keyword">end</span>
0125     
0126 
0127 <span class="keyword">if</span> nargout == 0
0128     fprintf(<span class="string">'   RMS Tilt = %f [degrees]\n'</span>, (180/pi) * TiltRMS);
0129     fprintf(<span class="string">'   RMS Vertical Dispersion = %f [m]\n'</span>, norm(EtaY)/sqrt(length(EtaY)));
0130     fprintf(<span class="string">'   Mean Horizontal Emittance = %f [nm rad]\n'</span>, 1e9*EpsX0);
0131     fprintf(<span class="string">'   Mean Vertical   Emittance = %f [nm rad]\n'</span>, 1e9*EpsY0);
0132     fprintf(<span class="string">'   Emittance Ratio = %f%% \n'</span>, 100*Ratio);
0133     
0134     <span class="comment">%figure(1);</span>
0135     gcf;
0136     clf reset;
0137     subplot(2,2,1);
0138     plot(spos, Tilt*180/pi, <span class="string">'-'</span>)
0139     set(gca,<span class="string">'XLim'</span>,[0 spos(end)])
0140     ylabel(<span class="string">'Tilt [degrees]'</span>);
0141     title(sprintf(<span class="string">'Rotation Angle of the Beam Ellipse  (RMS = %f)'</span>, (180/pi) * TiltRMS));
0142     xlabel(<span class="string">'s - Position [m]'</span>);
0143 
0144     <span class="comment">%figure(2);</span>
0145     subplot(2,2,3);
0146     [AX, H1, H2] = plotyy(spos, 1e6*sigmas(1,:), spos, 1e6*sigmas(2,:));
0147 
0148     <span class="comment">%set(H1,'Marker','.')</span>
0149     set(AX(1),<span class="string">'XLim'</span>,[0 spos(end)]);
0150     <span class="comment">%set(H2,'Marker','.')</span>
0151     set(AX(2),<span class="string">'XLim'</span>,[0 spos(end)]);
0152     title(<span class="string">'Principal Axis of the Beam Ellipse'</span>);
0153     set(get(AX(1),<span class="string">'Ylabel'</span>), <span class="string">'String'</span>, <span class="string">'Horizontal [\mum]'</span>); 
0154     set(get(AX(2),<span class="string">'Ylabel'</span>), <span class="string">'String'</span>, <span class="string">'Vertical [\mum]'</span>); 
0155     xlabel(<span class="string">'s - Position [m]'</span>);
0156     
0157     FontSize = get(get(AX(1),<span class="string">'Ylabel'</span>),<span class="string">'FontSize'</span>);
0158 
0159     <span class="comment">%figure(3);</span>
0160     subplot(2,2,2);    
0161     plot(spos, 1e9 * EpsX);
0162     title(<span class="string">'Horizontal Emittance'</span>);
0163     ylabel(sprintf(<span class="string">'\\fontsize{16}\\epsilon_x  \\fontsize{%d}[nm rad]'</span>, FontSize));
0164     xlabel(<span class="string">'s - Position [m]'</span>);
0165     xaxis([0 L0]);
0166     
0167     <span class="comment">%figure(4);</span>
0168     subplot(2,2,4);
0169     plot(spos, 1e9 * EpsY);
0170     title(<span class="string">'Vertical Emittance'</span>);
0171     ylabel(sprintf(<span class="string">'\\fontsize{16}\\epsilon_y  \\fontsize{%d}[nm rad]'</span>, FontSize));
0172     xlabel(<span class="string">'s - Position [m]'</span>);
0173     xaxis([0 L0]);
0174    
0175     h = addlabel(.75, 0, sprintf(<span class="string">'     Emittance Ratio = %f%% '</span>, 100*Ratio), 10);
0176     set(h,<span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>);
0177     
0178     orient landscape;
0179 <span class="keyword">end</span>
0180</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>