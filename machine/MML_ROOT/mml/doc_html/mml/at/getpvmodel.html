<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of getpvmodel</title>
  <meta name="keywords" content="getpvmodel">
  <meta name="description" content="GETPVMODEL - Get the model value">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mml</a> &gt; <a href="index.html">at</a> &gt; getpvmodel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml/at&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>getpvmodel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>GETPVMODEL - Get the model value</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">GETPVMODEL - Get the model value
  [Value, tout, DataTime, ErrorFlag] = getpvmodel(Family, Field, DeviceList, t)
  [Value, tout, DataTime, ErrorFlag] = getpvmodel(Family, DeviceList, t)
  [Value, tout, DataTime, ErrorFlag] = getpvmodel(DataStructure, t)

  INPUTS
  1. Family - Family Name
              Data Structure
              Accelerator Object
              AT family name (or 'All' for every AT element)
              'DCCT', 'TUNE', 'Energy'
  2. Field - Accelerator Object field name ('Monitor', 'Setpoint', etc) {'Monitor'}
             AT field name
                 or
             'K','Quad','Quadrupole'
             'K2','Sext','Sextupole'
             'K3','Octupole'
             'KS1','SkewQuad','Skew'
             'Roll' or 'Tilt' - for a magnet rolls
             'RollX' or 'TiltX' and 'RollY' or 'TiltY' - for corrector magnet rolls
             'DX' or 'XShift' - for a magnet shift (see setshift)
             'ClosedOrbit' - [x Px y Py dP dL] (dL is only calculated if the cavity is on)

             'xTurns', 'PxTurns', 'yTurns', 'PyTurns', dpTurns', 'dLTurns' (single turn data) (BPM Number x N turns)
             'FirstTurn' - 6-dimensional first turn or single pass
             'Turns' - 3 dimensional matrix (BPM Number x N turns x 6)
             Note: Units can only be 'Physics' for these field types.  'xTurns' or 'yTurns' can
                   be converted to 'Hardware' units by calling physics2hw as a separate call.
             Note: getpvmodel('TwissData','ClosedOrbit') - Gets the 6-dim start condition at the first AT element 
                   getpvmodel('TwissData', Field) - Gets the TwissData.(Field) twiss parameters at the first AT element

  3. DeviceList ([Sector Device #] or [element #]) {Default: Entire family}
  4. 'Physics'  - Use physics  units (optional override of units)
     'Hardware' - Use hardware units (optional override of units)  {Default: Hardware}
  5. 'Struct' will return a data structure {Default for data structure inputs}
     'Numeric' will return numeric outputs {Default for non-data structure inputs}

  OUTPUTS
  1. Value - Model value
  2. tout - Time it took to compute the output [seconds]
  3. DataTime - Time (in seconds) since  00:00:00, Jan 1, 1970
                 (seconds + milliseconds * i)
  4. ErrorFlag

  NOTES
  1. If Family is a cell array, then DeviceList and Field can also be a cell arrays</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>	FAMILY2ATINDEX - Returns the AT index for a given family</li><li><a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>	GETCAVITY - Returns the RF cavity state ('On' / 'Off')</li><li><a href="getenergymodel.html" class="code" title="function GeV = getenergymodel">getenergymodel</a>	GETENERGYMODEL - Returns the model energy in GeV</li><li><a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>	GETPVMODEL - Get the model value</li><li><a href="getturns.html" class="code" title="function [xAllBPMs, ATindex, LostBeam] = getturns(x0, N, Family, DeviceList)">getturns</a>	GETTURNS - Single particle tracking for multiple turns</li><li><a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>	ISRADIATIONON - 1 if a radiation passmethod is found</li><li><a href="modeltune.html" class="code" title="function [FractionalTune, IntegerTune] = modeltune">modeltune</a>	MODELTUNE - Returns the model tune (2x1 vector)</li><li><a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>	SETCAVITY - Set the RF cavity state</li><li><a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a>	SETRADIATION - Sets the model PassMethod to include or exclude radiation ('On' / 'Off' {Default})</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>	GETPVMODEL - Get the model value</li><li><a href="getturns.html" class="code" title="function [xAllBPMs, ATindex, LostBeam] = getturns(x0, N, Family, DeviceList)">getturns</a>	GETTURNS - Single particle tracking for multiple turns</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)</a>
0002 <span class="comment">%GETPVMODEL - Get the model value</span>
0003 <span class="comment">%  [Value, tout, DataTime, ErrorFlag] = getpvmodel(Family, Field, DeviceList, t)</span>
0004 <span class="comment">%  [Value, tout, DataTime, ErrorFlag] = getpvmodel(Family, DeviceList, t)</span>
0005 <span class="comment">%  [Value, tout, DataTime, ErrorFlag] = getpvmodel(DataStructure, t)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  INPUTS</span>
0008 <span class="comment">%  1. Family - Family Name</span>
0009 <span class="comment">%              Data Structure</span>
0010 <span class="comment">%              Accelerator Object</span>
0011 <span class="comment">%              AT family name (or 'All' for every AT element)</span>
0012 <span class="comment">%              'DCCT', 'TUNE', 'Energy'</span>
0013 <span class="comment">%  2. Field - Accelerator Object field name ('Monitor', 'Setpoint', etc) {'Monitor'}</span>
0014 <span class="comment">%             AT field name</span>
0015 <span class="comment">%                 or</span>
0016 <span class="comment">%             'K','Quad','Quadrupole'</span>
0017 <span class="comment">%             'K2','Sext','Sextupole'</span>
0018 <span class="comment">%             'K3','Octupole'</span>
0019 <span class="comment">%             'KS1','SkewQuad','Skew'</span>
0020 <span class="comment">%             'Roll' or 'Tilt' - for a magnet rolls</span>
0021 <span class="comment">%             'RollX' or 'TiltX' and 'RollY' or 'TiltY' - for corrector magnet rolls</span>
0022 <span class="comment">%             'DX' or 'XShift' - for a magnet shift (see setshift)</span>
0023 <span class="comment">%             'ClosedOrbit' - [x Px y Py dP dL] (dL is only calculated if the cavity is on)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%             'xTurns', 'PxTurns', 'yTurns', 'PyTurns', dpTurns', 'dLTurns' (single turn data) (BPM Number x N turns)</span>
0026 <span class="comment">%             'FirstTurn' - 6-dimensional first turn or single pass</span>
0027 <span class="comment">%             'Turns' - 3 dimensional matrix (BPM Number x N turns x 6)</span>
0028 <span class="comment">%             Note: Units can only be 'Physics' for these field types.  'xTurns' or 'yTurns' can</span>
0029 <span class="comment">%                   be converted to 'Hardware' units by calling physics2hw as a separate call.</span>
0030 <span class="comment">%             Note: getpvmodel('TwissData','ClosedOrbit') - Gets the 6-dim start condition at the first AT element</span>
0031 <span class="comment">%                   getpvmodel('TwissData', Field) - Gets the TwissData.(Field) twiss parameters at the first AT element</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%  3. DeviceList ([Sector Device #] or [element #]) {Default: Entire family}</span>
0034 <span class="comment">%  4. 'Physics'  - Use physics  units (optional override of units)</span>
0035 <span class="comment">%     'Hardware' - Use hardware units (optional override of units)  {Default: Hardware}</span>
0036 <span class="comment">%  5. 'Struct' will return a data structure {Default for data structure inputs}</span>
0037 <span class="comment">%     'Numeric' will return numeric outputs {Default for non-data structure inputs}</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%  OUTPUTS</span>
0040 <span class="comment">%  1. Value - Model value</span>
0041 <span class="comment">%  2. tout - Time it took to compute the output [seconds]</span>
0042 <span class="comment">%  3. DataTime - Time (in seconds) since  00:00:00, Jan 1, 1970</span>
0043 <span class="comment">%                 (seconds + milliseconds * i)</span>
0044 <span class="comment">%  4. ErrorFlag</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%  NOTES</span>
0047 <span class="comment">%  1. If Family is a cell array, then DeviceList and Field can also be a cell arrays</span>
0048 
0049 <span class="comment">%</span>
0050 <span class="comment">%  Written by Gregory J. Portmann</span>
0051 <span class="comment">% Revisions</span>
0052 <span class="comment">% January 25, 2005 Laurent S. Nadolski</span>
0053 <span class="comment">% ATparamgroup part modified to handle structure</span>
0054 <span class="comment">% February 2005: BEND return always an energy (??? commented in 2007)</span>
0055 <span class="comment">% 12/12/05 BPMx, BPMz, HCOR and VCOR getroll and getcrunch commented since too slow</span>
0056 <span class="comment">% add in bpm and corrector other names (machine dependent?)</span>
0057 
0058 <span class="keyword">global</span> THERING THERINGCELL
0059 
0060 ErrorFlag = 0;
0061 
0062 <span class="comment">% Input parsing</span>
0063 StructOutputFlag = 0;
0064 NumericOutputFlag = 0;
0065 UnitsFlag = {};
0066 <span class="keyword">for</span> i = length(varargin):-1:1
0067     <span class="keyword">if</span> isstruct(varargin{i})
0068         <span class="comment">% Ignore structures</span>
0069     <span class="keyword">elseif</span> iscell(varargin{i})
0070         <span class="comment">% Ignore cells</span>
0071     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'struct'</span>)
0072         StructOutputFlag = 1;
0073         varargin(i) = [];
0074     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'numeric'</span>)
0075         NumericOutputFlag = 1;
0076         StructOutputFlag = 0;
0077         varargin(i) = [];
0078     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>) || <span class="keyword">...</span>
0079             strcmpi(varargin{i},<span class="string">'Model'</span>)  || <span class="keyword">...</span>
0080             strcmpi(varargin{i},<span class="string">'Online'</span>) || <span class="keyword">...</span>
0081             strcmpi(varargin{i},<span class="string">'Manual'</span>)
0082         <span class="comment">% Remove and ignore</span>
0083         varargin(i) = [];
0084     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'physics'</span>)
0085         UnitsFlag = {<span class="string">'Physics'</span>};
0086         varargin(i) = [];
0087     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0088         UnitsFlag = {<span class="string">'Hardware'</span>};
0089         varargin(i) = [];
0090     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'archive'</span>)
0091         <span class="comment">% Just remove</span>
0092         varargin(i) = [];
0093     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'noarchive'</span>)
0094         <span class="comment">% Just remove</span>
0095         varargin(i) = [];
0096     <span class="keyword">end</span>
0097 <span class="keyword">end</span>
0098 
0099 <span class="keyword">if</span> isempty(varargin)
0100     error(<span class="string">'Must have at least a family name input'</span>);
0101 <span class="keyword">else</span>
0102     Family = varargin{1};
0103     <span class="keyword">if</span> length(varargin) &gt;= 2
0104         Field = varargin{2};
0105     <span class="keyword">end</span>
0106     <span class="keyword">if</span> length(varargin) &gt;= 3
0107         DeviceList = varargin{3};
0108     <span class="keyword">end</span>
0109     <span class="keyword">if</span> length(varargin) &gt;= 4
0110         t = varargin{4};
0111     <span class="keyword">else</span>
0112         t = 0;
0113     <span class="keyword">end</span>
0114 <span class="keyword">end</span>
0115 
0116 
0117 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0118 <span class="comment">% Cell Array Inputs %</span>
0119 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0120 <span class="keyword">if</span> iscell(Family)
0121     <span class="keyword">for</span> i = 1:length(Family)
0122         <span class="keyword">if</span> length(varargin) &lt; 2
0123             [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, UnitsFlag{:});
0124         <span class="keyword">elseif</span> length(varargin) &lt; 3
0125             <span class="keyword">if</span> iscell(Field)
0126                 [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field{i}, UnitsFlag{:});
0127             <span class="keyword">else</span>
0128                 [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field, UnitsFlag{:});
0129             <span class="keyword">end</span>
0130         <span class="keyword">else</span>
0131             <span class="keyword">if</span> iscell(Field)
0132                 <span class="keyword">if</span> iscell(DeviceList)
0133                     [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field{i}, DeviceList{i}, UnitsFlag{:}, t);
0134                 <span class="keyword">else</span>
0135                     [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field{i}, DeviceList, UnitsFlag{:}, t);
0136                 <span class="keyword">end</span>
0137             <span class="keyword">else</span>
0138                 <span class="keyword">if</span> iscell(DeviceList)
0139                     [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field, DeviceList{i}, UnitsFlag{:}, t);
0140                 <span class="keyword">else</span>
0141                     [AM{i}, tout{i}, DataTime{i}, ErrorFlag{i}] = <a href="getpvmodel.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvmodel(varargin)">getpvmodel</a>(Family{i}, Field, DeviceList, UnitsFlag{:}, t);
0142                 <span class="keyword">end</span>
0143             <span class="keyword">end</span>
0144         <span class="keyword">end</span>
0145     <span class="keyword">end</span>
0146     <span class="keyword">return</span>
0147 <span class="keyword">end</span>
0148 
0149 
0150 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0151 <span class="comment">% Family or data structure inputs beyond this point %</span>
0152 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0153 <span class="keyword">if</span> isstruct(Family)
0154     <span class="comment">% Only change StructOutputFlag if 'numeric' is not on the input line</span>
0155     <span class="keyword">if</span> ~NumericOutputFlag
0156         StructOutputFlag = 1;
0157     <span class="keyword">end</span>
0158 
0159     <span class="comment">% Data structure inputs</span>
0160     Field = <span class="string">''</span>;
0161     <span class="keyword">if</span> length(varargin) &gt;= 2
0162         <span class="comment">% Look for t as the second input</span>
0163         <span class="keyword">if</span> isnumeric(varargin{2})
0164             t = varargin{2};
0165         <span class="keyword">else</span>
0166             Field = varargin{2};
0167         <span class="keyword">end</span>
0168     <span class="keyword">end</span>
0169     <span class="keyword">if</span> length(varargin) &gt;= 3
0170         DeviceList =  varargin{3};
0171     <span class="keyword">else</span>
0172         DeviceList = [];
0173     <span class="keyword">end</span>
0174     <span class="keyword">if</span> length(varargin) &gt;= 4
0175         t =  varargin{4};
0176     <span class="keyword">end</span>
0177     <span class="keyword">if</span> isfield(Family,<span class="string">'FamilyName'</span>)
0178         Family = Family.FamilyName;
0179     <span class="keyword">else</span>
0180         error(<span class="string">'For data structure inputs FamilyName field must exist'</span>)
0181     <span class="keyword">end</span>
0182     <span class="keyword">if</span> isempty(Field)
0183         <span class="keyword">if</span> isfield(Family,<span class="string">'Field'</span>)
0184             Field = Family.Field;
0185         <span class="keyword">end</span>
0186     <span class="keyword">end</span>
0187     <span class="keyword">if</span> isempty(DeviceList)
0188         <span class="keyword">if</span> isfield(Family,<span class="string">'DeviceList'</span>)
0189             DeviceList = Family.DeviceList;
0190         <span class="keyword">end</span>
0191     <span class="keyword">end</span>
0192     <span class="keyword">if</span> isempty(UnitsFlag)
0193         <span class="keyword">if</span> isfield(Family,<span class="string">'Units'</span>)
0194             UnitsFlag{1} = Family.Units;
0195         <span class="keyword">end</span>
0196     <span class="keyword">end</span>
0197 <span class="keyword">else</span>
0198     <span class="comment">% Family string input</span>
0199     <span class="keyword">if</span> length(varargin) &lt; 2
0200         Field = <span class="string">''</span>;
0201     <span class="keyword">end</span>
0202     <span class="keyword">if</span> length(varargin) &lt; 3
0203         DeviceList = [];
0204     <span class="keyword">end</span>
0205     <span class="keyword">if</span> isnumeric(Field)
0206         <span class="keyword">if</span> length(varargin) &gt;= 3
0207             t = DeviceList;
0208         <span class="keyword">end</span>
0209         DeviceList = Field;
0210         Field = <span class="string">''</span>;
0211     <span class="keyword">end</span>
0212 <span class="keyword">end</span>
0213 
0214 <span class="keyword">if</span> isempty(Field)
0215     Field = <span class="string">'Monitor'</span>;
0216 <span class="keyword">end</span>
0217 <span class="keyword">if</span> isempty(DeviceList)
0218     <span class="keyword">if</span> isfamily(Family)
0219         DeviceList = family2dev(Family);
0220     <span class="keyword">end</span>
0221 <span class="keyword">else</span>
0222     <span class="keyword">if</span> isfamily(Family)
0223         <span class="keyword">if</span> (size(DeviceList,2) == 1)
0224             DeviceList = elem2dev(Family, DeviceList);
0225         <span class="keyword">end</span>
0226     <span class="keyword">end</span>
0227 <span class="keyword">end</span>
0228 
0229 <span class="keyword">if</span> isempty(UnitsFlag)
0230     UnitsFlag = <span class="string">'Hardware'</span>;
0231 <span class="keyword">else</span>
0232     UnitsFlag = UnitsFlag{1};
0233 <span class="keyword">end</span>
0234 
0235 
0236 <span class="comment">% Look to see it the AT model needs to be changed for this family</span>
0237 ATModelNumber = getfamilydata(Family, <span class="string">'AT'</span>, <span class="string">'ATModel'</span>);
0238 <span class="keyword">if</span> ~isempty(ATModelNumber)
0239     <span class="comment">% Change THERING</span>
0240     THERING = THERINGCELL{ATModelNumber};
0241 
0242     <span class="comment">% Set AD.Circumference</span>
0243     setfamilydata(findspos(THERING,length(THERING)+1), <span class="string">'Circumference'</span>);
0244     
0245     <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'MachineType'</span>)
0246         setfamilydata(THERING{1}.MachineType, <span class="string">'MachineType'</span>);
0247     <span class="keyword">end</span>
0248     <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'Energy'</span>)
0249         setfamilydata(THERING{1}.Energy, <span class="string">'Energy'</span>);
0250     <span class="keyword">end</span>
0251     <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'InjectionEnergy'</span>)
0252         setfamilydata(THERING{1}.InjectionEnergy, <span class="string">'InjectionEnergy'</span>);
0253     <span class="keyword">end</span>
0254     <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'MCF'</span>)
0255         setfamilydata(THERING{1}.MCF, <span class="string">'MCF'</span>);
0256     <span class="keyword">else</span>
0257         <span class="comment">% Recompute the MCF if it's likely if a new accelerator</span>
0258         <span class="comment">%try</span>
0259         <span class="comment">%    setfamilydata(getmcf('Model'), 'MCF');</span>
0260         <span class="comment">%catch</span>
0261         <span class="comment">%end</span>
0262     <span class="keyword">end</span>
0263 <span class="keyword">end</span>
0264 
0265 
0266 <span class="comment">% Simulator (AT)</span>
0267 <span class="keyword">if</span> isempty(THERING)
0268     error(<span class="string">'Simulator variable is not setup properly.'</span>);
0269 <span class="keyword">end</span>
0270 
0271 
0272 t0 = gettime;
0273 
0274 <span class="comment">%%%%%%%%%%%%</span>
0275 <span class="comment">% Get Data %</span>
0276 <span class="comment">%%%%%%%%%%%%</span>
0277 
0278 <span class="comment">% Families that do not require at AT field</span>
0279 <span class="keyword">if</span> strcmp(Family, <span class="string">'TUNE'</span>)
0280     AM = <a href="modeltune.html" class="code" title="function [FractionalTune, IntegerTune] = modeltune">modeltune</a>;
0281 
0282     <span class="comment">% Add random errors</span>
0283     <span class="comment">%AM = Tune1' + rand(2,1)*.0001;</span>
0284 
0285 <span class="keyword">elseif</span> strcmp(Family, <span class="string">'RF'</span>)
0286 
0287     iCavity = findcells(THERING,<span class="string">'Frequency'</span>);
0288     AM = THERING{iCavity(1)}.Frequency;
0289 
0290 <span class="keyword">elseif</span> strcmpi(Family, <span class="string">'DCCT'</span>)
0291 
0292     <span class="comment">% 6 hour lifetime, refill at midnight to 1000 mamps</span>
0293     tau = 6;
0294     a = clock;
0295     AM = 1000 * exp(-(60*60*a(4)+60*a(5)+a(6))/tau/60/60);
0296     
0297 <span class="keyword">elseif</span> any(strcmpi(Family,{<span class="string">'Energy'</span>,<span class="string">'GeV'</span>}))
0298     
0299     AM = <a href="getenergymodel.html" class="code" title="function GeV = getenergymodel">getenergymodel</a>;
0300     Family = <span class="string">'GeV'</span>;  <span class="comment">% Just so hw2physics works (ALS)</span>
0301     
0302 <span class="keyword">elseif</span> strcmp(Family, <span class="string">'TwissData'</span>)
0303     
0304     <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'TwissData'</span>)
0305         TwissData = THERING{1}.TwissData;
0306     <span class="keyword">else</span>
0307         TwissData = getfamilydata(<span class="string">'TwissData'</span>);
0308     <span class="keyword">end</span>
0309     
0310     <span class="keyword">if</span> any(strcmpi(Field, {<span class="string">'xTurns'</span>,<span class="string">'PxTurns'</span>,<span class="string">'yTurns'</span>,<span class="string">'PyTurns'</span>,<span class="string">'dPTurns'</span>,<span class="string">'dLTurns'</span>}))
0311         <span class="keyword">if</span> ~isfield(TwissData, <span class="string">'ClosedOrbit'</span>)
0312             error(<span class="string">'ClosedOrbit twiss parameter not found.'</span>);
0313         <span class="keyword">end</span>
0314         <span class="keyword">if</span> strcmpi(Field, <span class="string">'xTurns'</span>)
0315             AM = TwissData.ClosedOrbit(1);
0316         <span class="keyword">elseif</span> strcmpi(Field, <span class="string">'PxTurns'</span>)
0317             AM = TwissData.ClosedOrbit(2);
0318         <span class="keyword">elseif</span> strcmpi(Field, <span class="string">'yTurns'</span>)
0319             AM = TwissData.ClosedOrbit(3);
0320         <span class="keyword">elseif</span> strcmpi(Field, <span class="string">'PyTurns'</span>)
0321             AM = TwissData.ClosedOrbit(4);
0322         <span class="keyword">elseif</span> strcmpi(Field, <span class="string">'dPTurns'</span>)
0323             AM = TwissData.dP;
0324         <span class="keyword">elseif</span> strcmpi(Field, <span class="string">'dLTurns'</span>)
0325             AM = TwissData.dL;
0326         <span class="keyword">end</span>
0327     <span class="keyword">else</span>
0328         <span class="keyword">if</span> nargin == 1
0329             AM = TwissData;
0330         <span class="keyword">else</span>
0331             AM = TwissData.(Field);
0332         <span class="keyword">end</span>
0333     <span class="keyword">end</span>
0334     <span class="keyword">return</span>;
0335     
0336 <span class="keyword">else</span>
0337     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0338     <span class="comment">% Families that require an AT field %</span>
0339     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0340 
0341     <span class="comment">% Find the index for where the desired data is in the total device list</span>
0342     <span class="keyword">if</span> isfamily(Family)
0343         DeviceListTotal = family2dev(Family, 0);
0344         [DeviceIndex, iNotFound] = findrowindex(DeviceList, DeviceListTotal);
0345         <span class="keyword">if</span> length(iNotFound) &gt; 0
0346             <span class="comment">% Device not found</span>
0347             <span class="keyword">for</span> i = 1:length(iNotFound)
0348                 fprintf(<span class="string">'   No devices to get for Family %s(%d,%d)\n'</span>, Family, DeviceList(i,1), DeviceList(i,2));
0349             <span class="keyword">end</span>
0350             error(sprintf(<span class="string">'%d Devices not found'</span>, length(iNotFound)));
0351         <span class="keyword">end</span>
0352 
0353         <span class="comment">% Find the AT structure if it exists</span>
0354         AT = getfamilydata(Family, Field, <span class="string">'AT'</span>);
0355         <span class="keyword">if</span> isempty(AT)
0356             <span class="keyword">if</span> any(strcmpi(Field,{<span class="string">'Setpoint'</span>,<span class="string">'Monitor'</span>,<span class="string">'Sum'</span>,<span class="string">'Set'</span>,<span class="string">'Read'</span>,<span class="string">'Readback'</span>}))
0357                 AT = getfamilydata(Family, <span class="string">'AT'</span>);
0358                 <span class="keyword">if</span> isempty(AT)
0359                     <span class="comment">% AT.ATType must be defined</span>
0360                     <span class="comment">%warning('Simulator not setup for %s.%s family (data filled with NaN)\n', Family, Field);</span>
0361                     fprintf(<span class="string">'WARNING: Simulator not setup for %s.%s family (data filled with NaN)\n'</span>, Family, Field);
0362                     AM = NaN * ones(length(DeviceIndex),1);
0363                     tout = gettime - t0;
0364                     ErrorFlag = 1;
0365                     DataTime = 0+0*sqrt(-1);
0366                     <span class="keyword">return</span>
0367                 <span class="keyword">end</span>
0368             <span class="keyword">else</span>
0369                 AT.ATType = Field;
0370             <span class="keyword">end</span>
0371         <span class="keyword">end</span>
0372         
0373         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0374         <span class="comment">% Special function for simulator %</span>
0375         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0376         <span class="keyword">if</span> isfield(AT, <span class="string">'SpecialFunctionGet'</span>)
0377             AM = feval(AT.SpecialFunctionGet, Family, Field, DeviceList);
0378 
0379             <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0380                 <span class="keyword">if</span> isfamily(Family, Field)
0381                     AM = physics2hw(Family, Field, AM, DeviceList, <a href="getenergymodel.html" class="code" title="function GeV = getenergymodel">getenergymodel</a>);
0382                 <span class="keyword">else</span>
0383                     UnitsFlag = <span class="string">'Physics'</span>;
0384                 <span class="keyword">end</span>
0385             <span class="keyword">else</span>
0386                 UnitsFlag = <span class="string">'Physics'</span>;
0387             <span class="keyword">end</span>
0388 
0389             <span class="comment">% Expand if there is a time vector input</span>
0390             <span class="keyword">if</span> length(t) &gt; 1
0391                 AM(:,1:length(t)) = AM * ones(1,length(t));
0392                 tout(1,1:length(t)) = t + gettime - t0;
0393                 DataTime(1:size(AM,1),1:length(t)) = fix(t0) + rem(t0,1)*1e9*sqrt(-1);
0394             <span class="keyword">else</span>
0395                 tout = t + gettime - t0;
0396                 DataTime = fix(t0) + rem(t0,1)*1e9*sqrt(-1);
0397             <span class="keyword">end</span>
0398 
0399             <span class="keyword">if</span> StructOutputFlag
0400                 <span class="comment">% Structure output for channel name method</span>
0401                 AM.Data = AM;
0402                 AM.FamilyName = Family;
0403                 AM.Field = Field;
0404                 AM.DeviceList = DeviceList;
0405                 AM.Mode = <span class="string">'Simulator'</span>;
0406                 AM.t = t;           <span class="comment">% Matlab time at start of measurement</span>
0407                 AM.tout = tout;     <span class="comment">% Matlab time at  end  of measurement</span>
0408                 AM.DataTime = DataTime;
0409                 AM.TimeStamp = clock;
0410                 AM.Units = UnitsFlag;
0411                 <span class="keyword">if</span> strcmpi(AM.Units,<span class="string">'Hardware'</span>)
0412                     AM.UnitsString = getfamilydata(Family, Field, <span class="string">'HWUnits'</span>);
0413                 <span class="keyword">else</span>
0414                     AM.UnitsString = getfamilydata(Family, Field, <span class="string">'PhysicsUnits'</span>);
0415                 <span class="keyword">end</span>
0416                 AM.DataDescriptor = [];
0417                 AM.CreatedBy = <span class="string">'getpvmodel'</span>;
0418             <span class="keyword">end</span>
0419 
0420             <span class="keyword">return</span>
0421         <span class="keyword">end</span>
0422     <span class="keyword">else</span>
0423         <span class="comment">% Look for an AT family</span>
0424         <span class="keyword">if</span> strcmpi(Family, <span class="string">'All'</span>)
0425             AT.ATIndex = (1:length(THERING))';
0426         <span class="keyword">else</span>
0427             AT.ATIndex = findcells(THERING, <span class="string">'FamName'</span>, Family);
0428         <span class="keyword">end</span>
0429         DeviceIndex = 1:length(AT.ATIndex);
0430         <span class="keyword">if</span> isempty(DeviceList)
0431             DeviceList = [ones(length(DeviceIndex),1) DeviceIndex(:)];
0432         <span class="keyword">end</span>
0433         AT.ATType = Field;
0434     <span class="keyword">end</span>
0435     
0436     
0437     <span class="comment">% Get methods</span>
0438     <span class="keyword">if</span> isfield(AT, <span class="string">'ATParameterGroup'</span>)
0439         ATIndexList = AT.ATIndex(DeviceIndex,1);  <span class="comment">% Only use the first column</span>
0440         <span class="keyword">for</span> i = 1:size(DeviceList,1)
0441             <span class="keyword">if</span> isstruct(AT.ATParameterGroup)
0442                 <span class="comment">% Introduced for SOLEIL</span>
0443                 PGField = AT.ATParameterGroup(1).FieldName;
0444                 AM(i,1) = getfield(THERING{ATIndexList(1)}, PGField, <span class="keyword">...</span>
0445                     AT.ATParameterGroup(1).FieldIndex);
0446 
0447             <span class="keyword">elseif</span> iscell(AT.ATParameterGroup)
0448                 <span class="comment">% If cell, get the parameter group</span>
0449                 <span class="comment">% Note:  this only works if the first FieldName sets the group parameter value</span>
0450                 PGField = AT.ATParameterGroup{DeviceIndex(i)}(1).FieldName;
0451                 AM(i,:) = getfield(THERING{ATIndexList(i)}, PGField, AT.ATParameterGroup{DeviceIndex(i)}(1).FieldIndex);
0452 
0453                 <span class="comment">% If getfield disappears use:</span>
0454                 <span class="comment">%DataField = THERING{ATIndexList(i)}.(PGField);</span>
0455                 <span class="comment">%Index1 = AT.ATParameterGroup{DeviceIndex(i)}(1).FieldIndex{1};</span>
0456                 <span class="comment">%Index2 = AT.ATParameterGroup{DeviceIndex(i)}(1).FieldIndex{2};</span>
0457                 <span class="comment">%AM(i,1) = DataField(Index1, Index2);</span>
0458             <span class="keyword">elseif</span> ischar(AT.ATParameterGroup)
0459                 <span class="comment">% If string, get the field</span>
0460                 PGField = AT.ATParameterGroup;
0461                 AM(i,:) = THERING{ATIndexList(i)}.PGField;
0462             <span class="keyword">end</span>
0463         <span class="keyword">end</span>
0464 
0465     <span class="keyword">else</span>
0466         
0467         <span class="comment">% Make sure AT.Index exists</span>
0468         <span class="keyword">if</span> ~isfield(AT, <span class="string">'ATIndex'</span>)
0469             AT.ATIndex = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(Family, DeviceListTotal);
0470         <span class="keyword">end</span>
0471 
0472         <span class="comment">% For split magnet reduce the get to the first magnet in the split</span>
0473         <span class="comment">% If K*Leff (not K) is being varied then use Nsplits as a multiplier</span>
0474         <span class="keyword">if</span> size(AT.ATIndex,2) &gt; 1
0475             Nsplits = ones(size(AT.ATIndex));
0476             Nsplits(find(isnan(AT.ATIndex)))=0;
0477             Nsplits = sum(Nsplits')';
0478             ATIndexList = AT.ATIndex(:,1);
0479         <span class="keyword">else</span>
0480             ATIndexList = AT.ATIndex;
0481         <span class="keyword">end</span>
0482         ATIndexList = ATIndexList(DeviceIndex);
0483 
0484 
0485         <span class="comment">% Check the DeviceIndex</span>
0486         <span class="keyword">if</span> isempty(ATIndexList)
0487             AM = [];
0488             DataTime = 0+0*sqrt(-1);
0489             <span class="keyword">return</span>;
0490         <span class="keyword">end</span>
0491         
0492 
0493         <span class="comment">% Switch on simulation method</span>
0494         <span class="keyword">if</span> any(strcmpi(AT.ATType, {<span class="string">'x'</span>,<span class="string">'BPMx'</span>,<span class="string">'Horizontal'</span>,<span class="string">'y'</span>,<span class="string">'BPMy'</span>, <span class="string">'z'</span>,<span class="string">'BPMz'</span>,<span class="string">'Vertical'</span>,<span class="string">'ClosedOrbit'</span>}))
0495             <span class="comment">% Need to consider AT 'x' at say Family='Quad' -&gt; rolls etc?</span>
0496             [ATIndexList, isort] = sort(ATIndexList);
0497 
0498             [CavityState, PassMethod, iCavity] = <a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>;
0499             <span class="keyword">if</span> isempty(CavityState)
0500                 <span class="comment">% No cavity in AT model</span>
0501                 <span class="keyword">if</span> <a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>
0502                     fprintf(<span class="string">'   Turning radiation off since there is no RF cavity.\n'</span>);
0503                     <a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a> off;
0504                 <span class="keyword">end</span>
0505                 Orbit = findsyncorbit(THERING, 0, ATIndexList);
0506             <span class="keyword">else</span>
0507                 <span class="keyword">if</span> strcmpi(deblank(CavityState(1,:)), <span class="string">'On'</span>) || <a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>
0508                     <span class="comment">% findorbit6 recommended when cavity or radiation is on</span>
0509                     <span class="keyword">if</span> strcmpi(deblank(CavityState(1,:)), <span class="string">'Off'</span>)
0510                         <span class="comment">% Turn off cavity in AT model</span>
0511                         fprintf(<span class="string">'   Turning the RF cavity on, since radiation is on.\n'</span>);
0512                         <a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>(<span class="string">'On'</span>);
0513                     <span class="keyword">end</span>
0514                     Orbit = findorbit6(THERING, ATIndexList);
0515                 <span class="keyword">else</span>
0516                     <span class="comment">% Cavity is off in AT model</span>
0517                     <span class="comment">%setcavity('Off');</span>
0518 
0519                     <span class="comment">% This is a way to simulate the effect of the RF without a cavity</span>
0520                     C = 2.99792458e8;
0521                     CavityFrequency  = THERING{iCavity(1)}.Frequency;
0522                     CavityHarmNumber = THERING{iCavity(1)}.HarmNumber;
0523                     L = findspos(THERING,length(THERING)+1);   <span class="comment">% getfamilydata('Circumference')</span>
0524                     f0 = C * CavityHarmNumber / L;
0525                     DeltaRF = CavityFrequency - f0;   <span class="comment">% Hz</span>
0526                     Orbit = findsyncorbit(THERING, -C*DeltaRF*CavityHarmNumber/CavityFrequency^2, ATIndexList);
0527                     <span class="comment">%Orbit = findsyncorbit(THERING, 0, ATIndexList);</span>
0528 
0529                     <span class="comment">% Reset cavity PassMethod</span>
0530                     <span class="comment">%setcavity(PassMethod);</span>
0531                 <span class="keyword">end</span>
0532             <span class="keyword">end</span>
0533 
0534             <span class="keyword">if</span> any(strcmpi(AT.ATType, {<span class="string">'x'</span>,<span class="string">'BPMx'</span>,<span class="string">'Horizontal'</span>}))
0535 
0536                 <span class="comment">% Roll and Crunch are corrected here (BPM gain errors are corrected in real2raw/raw2real)</span>
0537                 <span class="keyword">if</span> isfamily(Family, Field)
0538                     <span class="comment">% Only corrector for gain/roll errors is using a ML family</span>
0539                     <span class="comment">% Roll and Crunch are corrected here (BPM gain errors are corrected in real2raw/raw2real)</span>
0540                     <span class="comment">%NDevices = length(ATIndexList);</span>
0541                     <span class="comment">%GCR = zeros(NDevices,4);</span>
0542                     <span class="comment">%GCR(:,1) = getcellstruct(THERING(ATIndexList), 'GCR', 1:NDevices, 1);</span>
0543                     <span class="comment">%GCR(:,2) = getcellstruct(THERING(ATIndexList), 'GCR', 1:NDevices, 2);</span>
0544                     <span class="comment">%GCR(:,3) = getcellstruct(THERING(ATIndexList), 'GCR', 1:NDevices, 3);</span>
0545                     <span class="comment">%GCR(:,4) = getcellstruct(THERING(ATIndexList), 'GCR', 1:NDevices, 4);</span>
0546                     <span class="keyword">for</span> i = 1:length(ATIndexList)
0547                         <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'GCR'</span>)
0548                             GCR(i,:) = THERING{ATIndexList(i)}.GCR;
0549                         <span class="keyword">else</span>
0550                             <span class="comment">%GCR(i,:) = [1 1 0 0];  % [Gx Gy Crunch Roll]</span>
0551                             <span class="comment">% Laurent begin</span>
0552                             <span class="comment">%Crunch = getcrunch(Family, Field, DeviceList(i,:)); % Laurent</span>
0553                             <span class="comment">%Roll = getroll(Family, Field, DeviceList(i,:)); %Laurent</span>
0554                             <span class="comment">%m = gcr2loco(1, 1, Crunch, Roll);</span>
0555                             <span class="comment">%GCR(i,:) = [1 1 Crunch Roll]; % Laurent</span>
0556                             GCR(i,:) = [1 1 0 0];
0557                         <span class="keyword">end</span>
0558                     <span class="keyword">end</span>
0559 
0560                     x = Orbit(1,:)';
0561                     y = Orbit(3,:)';
0562 
0563                     AM = ((x - GCR(:,3) .* y) .* cos(GCR(:,4)) + (y + GCR(:,3) .* x) .* sin(GCR(:,4))) ./ sqrt(1-GCR(:,3).^2);
0564 
0565                     <span class="comment">% Same as:</span>
0566                     <span class="comment">%Crunch = GCR(:,3);</span>
0567                     <span class="comment">%Roll = GCR(:,4);</span>
0568                     <span class="comment">%a = ( Crunch .* sin(Roll) + cos(Roll)) ./ sqrt(1 - Crunch.^2);</span>
0569                     <span class="comment">%b = (-Crunch .* cos(Roll) + sin(Roll)) ./ sqrt(1 - Crunch.^2);</span>
0570                     <span class="comment">%AM = a .* x + b .* y;</span>
0571                 <span class="keyword">else</span>
0572                     AM = Orbit(1,:)';
0573                 <span class="keyword">end</span>
0574 
0575             <span class="keyword">elseif</span> any(strcmpi(AT.ATType, {<span class="string">'y'</span>,<span class="string">'BPMy'</span>, <span class="string">'z'</span>, <span class="string">'BPMz'</span>, <span class="string">'Vertical'</span>}))
0576 
0577                 <span class="keyword">if</span> isfamily(Family, Field)
0578                     <span class="comment">% Only corrector for gain/roll errors is using a ML family</span>
0579                     <span class="comment">% Roll and Crunch are corrected here (BPM gain errors are corrected in real2raw/raw2real)</span>
0580                     <span class="keyword">for</span> i = 1:length(ATIndexList)
0581                         <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'GCR'</span>)
0582                             GCR(i,:) = THERING{ATIndexList(i)}.GCR;
0583                         <span class="keyword">else</span>
0584                             <span class="comment">%GCR(i,:) = [1 1 0 0];  % [Gx Gy Crunch Roll]</span>
0585                             <span class="comment">%Crunch = getcrunch(Family, Field, DeviceList(i,:)); %Laurent</span>
0586                             <span class="comment">%Roll = getroll(Family, Field, DeviceList(i,:)); % Laurent</span>
0587                             <span class="comment">%m = gcr2loco(1, 1, Crunch, Roll);</span>
0588                             <span class="comment">%GCR(i,:) = [1 1 Crunch Roll]; % Laurent</span>
0589                             GCR(i,:) = [1 1 0 0];
0590                         <span class="keyword">end</span>
0591                     <span class="keyword">end</span>
0592 
0593                     x = Orbit(1,:)';
0594                     y = Orbit(3,:)';
0595 
0596                     AM = ((y - GCR(:,3) .* x) .* cos(GCR(:,4)) - (x + GCR(:,3) .* y) .* sin(GCR(:,4))) ./ sqrt(1-GCR(:,3).^2);
0597 
0598                     <span class="comment">% Same as:</span>
0599                     <span class="comment">%Crunch = GCR(:,3);</span>
0600                     <span class="comment">%Roll = GCR(:,4);</span>
0601                     <span class="comment">%c = (-Crunch .* cos(Roll) - sin(Roll)) ./ sqrt(1 - Crunch.^2);</span>
0602                     <span class="comment">%d = (-Crunch .* sin(Roll) + cos(Roll)) ./ sqrt(1 - Crunch.^2);</span>
0603                     <span class="comment">%AM = c .* x + d .* y;</span>
0604                 <span class="keyword">else</span>
0605                     AM = Orbit(3,:)';
0606                 <span class="keyword">end</span>
0607             <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'ClosedOrbit'</span>)
0608                     AM = Orbit';
0609             <span class="keyword">end</span>
0610 
0611             AM(isort,:) = AM;
0612 
0613             <span class="comment">% Add noise to the BPMs</span>
0614             <span class="comment">%AM = AM + .1e-6*randn(size(AM));</span>
0615 
0616         <span class="keyword">elseif</span> any(strcmpi(AT.ATType, {<span class="string">'HCM'</span>, <span class="string">'HCOR'</span>, <span class="string">'FHCOR'</span>, <span class="string">'CH'</span>}))
0617 
0618             <span class="keyword">if</span> any(strcmpi(Field,{<span class="string">'Setpoint'</span>,<span class="string">'Monitor'</span>,<span class="string">'Sum'</span>,<span class="string">'Set'</span>,<span class="string">'Read'</span>,<span class="string">'Readback'</span>,<span class="string">'Kick'</span>}))
0619                 <span class="comment">% Bending Angle (Radians)</span>
0620                 <span class="keyword">for</span> i=1:length(ATIndexList)
0621                     <span class="comment">% The CM gain errors are corrected in real2raw/raw2real</span>
0622                     <span class="comment">% Coupling: Magnet roll is part of the AT model</span>
0623                     <span class="comment">%           The gain is part of hw2physics/physics2hw</span>
0624                     <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'Roll'</span>)
0625                         Roll = THERING{ATIndexList(i)}.Roll;
0626                     <span class="keyword">else</span>
0627                         <span class="comment">% Knowing the cross-plane family name can be a problem</span>
0628                         <span class="comment">% If the VCM family has the same AT index, then use it.</span>
0629                         <span class="keyword">try</span>
0630                             <span class="comment">% Begin Laurent</span>
0631                             <span class="comment">%VCMFamily = getvcmfamily;</span>
0632                             <span class="comment">%Roll = [getroll(Family, Field, DeviceList(i,:))  0];</span>
0633                             <span class="comment">%VCMDevList = family2dev(VCMFamily);</span>
0634                             <span class="comment">%iVCM = findrowindex(DeviceList(i,:), VCMDevList);</span>
0635                             <span class="comment">%if ~isempty(iVCM)</span>
0636                             <span class="comment">%    ATIndexVCM = family2atindex(VCMFamily, DeviceList(i,:));</span>
0637                             <span class="comment">%    if ATIndexVCM == ATIndexList(i)</span>
0638                             <span class="comment">%        Roll = [Roll(1) getroll(VCMFamily, Field, DeviceList(i,:))];</span>
0639                             <span class="comment">%    else</span>
0640                                     Roll = [0 0];
0641                             <span class="comment">%    end</span>
0642                             <span class="comment">%end</span>
0643                             <span class="comment">% end Laurent</span>
0644                         <span class="keyword">catch</span>
0645                             Roll = [0 0];
0646                         <span class="keyword">end</span>
0647                     <span class="keyword">end</span>
0648                     AM(i,1) = [cos(Roll(2)) sin(Roll(2))] * THERING{ATIndexList(i)}.KickAngle(:) / (cos(Roll(1)-Roll(2)));
0649 
0650                     <span class="keyword">if</span> size(AT.ATIndex,2) &gt; 1
0651                         AM(i,1) = Nsplits(i) * AM(i,1);
0652                     <span class="keyword">end</span>
0653                 <span class="keyword">end</span>
0654 
0655                 <span class="comment">% Add noise (microradian)</span>
0656                 <span class="comment">%AM = AM + 1e-6*randn(length(AM),1);</span>
0657             <span class="keyword">else</span>
0658                 <span class="keyword">if</span> isfield(THERING{ATIndexList(1)}, Field)
0659                     <span class="keyword">for</span> i=1:length(ATIndexList)
0660                         AM(i,:) = THERING{ATIndexList(i)}.(Field);
0661                     <span class="keyword">end</span>
0662                 <span class="keyword">else</span>
0663                     AM = zeros(length(ATIndexList),1);  <span class="comment">% or error???</span>
0664                 <span class="keyword">end</span>
0665             <span class="keyword">end</span>
0666 
0667         <span class="keyword">elseif</span> any(strcmpi(AT.ATType, {<span class="string">'VCM'</span>, <span class="string">'VCOR'</span>, <span class="string">'FVCOR'</span>, <span class="string">'CV'</span>}))
0668 
0669             <span class="keyword">if</span> any(strcmpi(Field,{<span class="string">'Setpoint'</span>,<span class="string">'Monitor'</span>,<span class="string">'Sum'</span>,<span class="string">'Set'</span>,<span class="string">'Read'</span>,<span class="string">'Readback'</span>,<span class="string">'Kick'</span>}))
0670                 <span class="comment">% Bending Angle (Radians)</span>
0671                 <span class="keyword">for</span> i=1:length(ATIndexList)
0672                     <span class="comment">% The CM gain errors are corrected in real2raw/raw2real</span>
0673                     <span class="comment">% Coupling: Magnet roll is part of the AT model</span>
0674                     <span class="comment">%           The gain is part of hw2physics/physics2hw</span>
0675                     <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'Roll'</span>)
0676                         Roll = THERING{ATIndexList(i)}.Roll;
0677                     <span class="keyword">else</span>
0678                         <span class="comment">% Knowing the cross-plane family name can be a problem</span>
0679                         <span class="comment">% If the VCM family has the same AT index, then use it.</span>
0680                         <span class="comment">% Begin Laurent</span>
0681                         <span class="comment">%try</span>
0682                         <span class="comment">%    HCMFamily = getvcmfamily;</span>
0683                         <span class="comment">%    Roll = [0 getroll(Family, Field, DeviceList(i,:))];</span>
0684                         <span class="comment">%    HCMDevList = family2dev(HCMFamily);</span>
0685                         <span class="comment">%    iHCM = findrowindex(DeviceList(i,:), HCMDevList);</span>
0686                         <span class="comment">%    if ~isempty(iHCM)</span>
0687                         <span class="comment">%        ATIndexHCM = family2atindex(HCMFamily, DeviceList(i,:));</span>
0688                         <span class="comment">%        if ATIndexHCM == ATIndexList(i)</span>
0689                         <span class="comment">%            Roll = [getroll(HCMFamily, Field, DeviceList(i,:)) Roll(2)];</span>
0690                         <span class="comment">%        else</span>
0691                         <span class="comment">%            Roll = [0 0];</span>
0692                         <span class="comment">%        end</span>
0693                         <span class="comment">%    end</span>
0694                         <span class="comment">%catch</span>
0695                             Roll = [0 0];
0696                         <span class="comment">%end</span>
0697                         <span class="comment">% End Laurent</span>
0698                     <span class="keyword">end</span>
0699 
0700                     AM(i,1) = [-sin(Roll(1)) cos(Roll(1))] * THERING{ATIndexList(i)}.KickAngle(:) / (cos(Roll(1)-Roll(2)));
0701 
0702                     <span class="keyword">if</span> size(AT.ATIndex,2) &gt; 1
0703                         AM(i,1) = Nsplits(i) * AM(i,1);
0704                     <span class="keyword">end</span>
0705                 <span class="keyword">end</span>
0706                 <span class="comment">% Add noise (microradian)</span>
0707                 <span class="comment">%AM = AM + 1e-6*randn(length(AM),1);</span>
0708             <span class="keyword">else</span>
0709                 <span class="keyword">if</span> isfield(THERING{ATIndexList(1)}, Field)
0710                     <span class="keyword">for</span> i=1:length(ATIndexList)
0711                         AM(i,:) = THERING{ATIndexList(i)}.(Field);
0712                     <span class="keyword">end</span>
0713                 <span class="keyword">else</span>
0714                     AM = zeros(length(ATIndexList),1);
0715                 <span class="keyword">end</span>
0716             <span class="keyword">end</span>
0717 
0718         <span class="keyword">elseif</span> any(strcmpi(AT.ATType,{<span class="string">'K'</span>,<span class="string">'Quad'</span>,<span class="string">'Quadrupole'</span>}))
0719             <span class="comment">% Quadrupole</span>
0720             <span class="keyword">if</span> isfield(THERING{ATIndexList(1)}, <span class="string">'K'</span>)
0721                 <span class="keyword">for</span> i = 1:length(ATIndexList)
0722                     AM(i,1) = THERING{ATIndexList(i)}.K;
0723                 <span class="keyword">end</span>
0724             <span class="keyword">else</span>
0725                 <span class="keyword">for</span> i = 1:length(ATIndexList)
0726                     AM(i,1) = THERING{ATIndexList(i)}.PolynomB(2);
0727                 <span class="keyword">end</span>
0728             <span class="keyword">end</span>
0729             <span class="comment">% Add noise</span>
0730             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0731 
0732         <span class="keyword">elseif</span> any(strcmpi(AT.ATType,{<span class="string">'K2'</span>,<span class="string">'Sext'</span>,<span class="string">'Sextupole'</span>}))
0733             <span class="comment">% Sextupole</span>
0734             <span class="keyword">for</span> i = 1:length(ATIndexList)
0735                 AM(i,1) = THERING{ATIndexList(i)}.PolynomB(3);
0736             <span class="keyword">end</span>
0737             <span class="comment">% Add noise</span>
0738             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0739 
0740         <span class="keyword">elseif</span> any(strcmpi(AT.ATType,{<span class="string">'K3'</span>,<span class="string">'Octupole'</span>}))
0741             <span class="comment">% Octupole</span>
0742             <span class="keyword">for</span> i = 1:length(ATIndexList)
0743                 AM(i,1) = THERING{ATIndexList(i)}.PolynomB(4);
0744             <span class="keyword">end</span>
0745             <span class="comment">% Add noise</span>
0746             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0747 
0748         <span class="keyword">elseif</span> any(strcmpi(AT.ATType,{<span class="string">'KS'</span>,<span class="string">'KS1'</span>,<span class="string">'SkewQ'</span>,<span class="string">'SkewQuad'</span>, <span class="string">'QT'</span>}))
0749             <span class="comment">% SkewQuad</span>
0750             <span class="keyword">for</span> i = 1:length(ATIndexList)
0751                 AM(i,1) = THERING{ATIndexList(i)}.PolynomA(2);
0752             <span class="keyword">end</span>
0753             <span class="comment">% Add noise</span>
0754             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0755 
0756         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'BEND'</span>)
0757             <span class="comment">% BEND</span>
0758             <span class="keyword">for</span> i = 1:length(ATIndexList)
0759                 AM(i,1) = THERING{ATIndexList(i)}.BendingAngle;
0760                 <span class="comment">% Modif: Laurent to be consistent, has to return an energy</span>
0761                 <span class="comment">% AM(i,1) = getenergymodel;</span>
0762             <span class="keyword">end</span>
0763 
0764         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'Photon BPM'</span>)
0765             <span class="comment">% Spear only</span>
0766             <span class="keyword">if</span> strcmpi(Family, <span class="string">'BLOpen'</span>)
0767                 AM = ones(length(DeviceIndex),1);
0768             <span class="keyword">elseif</span> strcmpi(Family, <span class="string">'BLSum'</span>)
0769                 AM = ones(length(DeviceIndex),1);
0770             <span class="keyword">elseif</span> strcmpi(Family, <span class="string">'BLErr'</span>)
0771                 <span class="comment">% Calculate photon beam location</span>
0772                 <span class="comment">% for ii=1:length(DeviceIndex)</span>
0773                 <span class="comment">%    if strcmp(AO.BLType,'dipole')</span>
0774                 <span class="comment">%        AM(ii)=CalcDipolePBPM(orbit(3,BPMATIndex),orbit(4,UpstreamBPMIndex),AO.BLLength);</span>
0775                 <span class="comment">%    elseif strcmp(AO.BLType,'id')</span>
0776                 <span class="comment">%        AM(ii)=CalcIDAngle(DeviceIndex,'simulator');</span>
0777                 <span class="comment">%        AM(ii)=CalcIDError(DeviceIndex,'simulator');</span>
0778                 <span class="comment">%    end</span>
0779                 <span class="comment">% end</span>
0780                 <span class="comment">% Add noise</span>
0781                 <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0782             <span class="keyword">end</span>
0783 
0784         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'Kicker'</span>) || strcmpi(AT.ATType, <span class="string">'kickeramp'</span>)
0785 
0786             ATIndexList = AT.ATIndex(DeviceIndex);
0787             <span class="keyword">if</span> any(strcmpi(Field,{<span class="string">'Setpoint'</span>,<span class="string">'Monitor'</span>}))
0788                 <span class="comment">% KickAngle</span>
0789                 <span class="keyword">for</span> i=1:length(ATIndexList)
0790                     AM(i,1) = THERING{ATIndexList(i)}.KickAngle(1);  <span class="comment">% This only allows for a horizontal kick</span>
0791                 <span class="keyword">end</span>
0792             <span class="keyword">else</span>
0793                 <span class="keyword">if</span> isfield(THERING{ATIndexList(1)}, Field)
0794                     <span class="keyword">for</span> i=1:length(ATIndexList)
0795                         AM(i,:) = THERING{ATIndexList(i)}.(Field);
0796                     <span class="keyword">end</span>
0797                 <span class="keyword">else</span>
0798                     AM = NaN * ones(length(ATIndexList),1);
0799                 <span class="keyword">end</span>
0800             <span class="keyword">end</span>
0801 
0802         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'Roll'</span>) || strcmpi(AT.ATType, <span class="string">'Tilt'</span>)
0803             <span class="comment">% Roll or Tilt of a magnet</span>
0804             <span class="keyword">for</span> i = 1:length(ATIndexList)
0805                 <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'R1'</span>) &amp;&amp; isfield(THERING{ATIndexList(i)}, <span class="string">'R2'</span>)
0806                     R1 = THERING{ATIndexList(i)}.R1;
0807                     AM(i,1) = acos(R1(1,1));
0808                 <span class="keyword">else</span>
0809                     error(sprintf(<span class="string">'%s(%d,%d) must have a R1 &amp; R2 field in the model to be rolled.'</span>, Family, DeviceList(i,:)));
0810                 <span class="keyword">end</span>
0811             <span class="keyword">end</span>
0812 
0813         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'XShift'</span>) || strcmpi(AT.ATType, <span class="string">'DX'</span>)
0814             <span class="comment">% Roll or Tilt of a magnet</span>
0815             <span class="keyword">for</span> i = 1:length(ATIndexList)
0816                 <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'T1'</span>)
0817                     T1 = THERING{ATIndexList(i)}.T1;
0818                     AM(i,1) = T1(1);
0819                 <span class="keyword">else</span>
0820                     error(sprintf(<span class="string">'%s(%d,%d) must have a T1 field in the model to be shifted.'</span>, Family, DeviceList(i,:)));
0821                 <span class="keyword">end</span>
0822             <span class="keyword">end</span>
0823 
0824         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'YShift'</span>) || strcmpi(AT.ATType, <span class="string">'DY'</span>)
0825             <span class="comment">% Roll or Tilt of a magnet</span>
0826             <span class="keyword">for</span> i = 1:length(ATIndexList)
0827                 <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'T1'</span>)
0828                     T1 = THERING{ATIndexList(i)}.T1;
0829                     AM(i,1) = T1(3);
0830                 <span class="keyword">else</span>
0831                     error(sprintf(<span class="string">'%s(%d,%d) must have a T1 field in the model to be shifted.'</span>, Family, DeviceList(i,:)));
0832                 <span class="keyword">end</span>
0833             <span class="keyword">end</span>
0834 
0835         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'RollX'</span>) || strcmpi(AT.ATType, <span class="string">'RollY'</span>)
0836             <span class="comment">% Roll or Tilt</span>
0837             <span class="keyword">for</span> i=1:length(ATIndexList)
0838                 <span class="comment">% Corrector magnet roll</span>
0839                 <span class="comment">% The .Roll field is just a middle layer way to store the roll.</span>
0840                 <span class="comment">% Otherwise, one can not tell the difference between x/y kicks and coupling</span>
0841                 <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'KickAngle'</span>)
0842                     <span class="keyword">if</span> isfield(THERING{ATIndexList(i)}, <span class="string">'Roll'</span>)
0843                         Roll = THERING{ATIndexList(i)}.Roll;
0844                     <span class="keyword">else</span>
0845                         Roll = [0 0];
0846                     <span class="keyword">end</span>
0847                     <span class="keyword">if</span> strcmpi(AT.ATType, <span class="string">'RollX'</span>)
0848                         AM(i,1) = Roll(1);
0849                     <span class="keyword">else</span>
0850                         AM(i,1) = Roll(2);
0851                     <span class="keyword">end</span>
0852                 <span class="keyword">else</span>
0853                     error(sprintf(<span class="string">'%s(%d,%d) must be a KickAngle field in the model to be rolled.'</span>, Family, DeviceList(i,:)));
0854                 <span class="keyword">end</span>
0855             <span class="keyword">end</span>
0856 
0857         <span class="keyword">elseif</span> any(strcmpi(AT.ATType,{<span class="string">'FirstTurn'</span>,<span class="string">'linepass'</span>,<span class="string">'Turns'</span>, <span class="string">'xTurns'</span>,<span class="string">'PxTurns'</span>,<span class="string">'yTurns'</span>,<span class="string">'PyTurns'</span>,<span class="string">'dPTurns'</span>,<span class="string">'dLTurns'</span>}))
0858             <span class="comment">% Turn-by-turn data</span>
0859 
0860             Nturns = round(max(abs(t)));  <span class="comment">% getfamilydata('NTURNS');</span>
0861             t = Nturns; <span class="comment">% Just incase it changed</span>
0862             <span class="keyword">if</span> isempty(Nturns) || Nturns &lt; 1
0863                 Nturns = 1;
0864             <span class="keyword">end</span>
0865 
0866             <span class="comment">% Initial launch condition</span>
0867             <span class="keyword">if</span> isfield(THERING{1}, <span class="string">'TwissData'</span>)
0868                 TwissData = THERING{1}.TwissData;
0869             <span class="keyword">else</span>
0870                 TwissData = getfamilydata(<span class="string">'TwissData'</span>);
0871             <span class="keyword">end</span>
0872             <span class="keyword">if</span> ~isfield(TwissData, <span class="string">'dP'</span>)
0873                 TwissData.dP = 0;
0874             <span class="keyword">end</span>
0875             <span class="keyword">if</span> ~isfield(TwissData, <span class="string">'L'</span>)
0876                 TwissData.dL = 0;
0877             <span class="keyword">end</span>
0878             <span class="keyword">if</span> isempty(TwissData.ClosedOrbit)
0879                 fprintf(<span class="string">'   6-dim initial condition set to zeros.  Use setpvmodel(''TwissData'',''ClosedOrbit'') to change it.\n'</span>);
0880                 TwissData.ClosedOrbit = [0 0 0 0]';
0881                 <span class="comment">%x0 = [.001 0, 0.001, 0]';</span>
0882                 TwissData.dP = 0;
0883                 TwissData.dL = 0;
0884             <span class="keyword">end</span>
0885             x0 = [TwissData.ClosedOrbit(:); TwissData.dP; TwissData.dL];
0886             
0887             [AM, ATIndexList, LostBeam] = <a href="getturns.html" class="code" title="function [xAllBPMs, ATindex, LostBeam] = getturns(x0, N, Family, DeviceList)">getturns</a>(x0, Nturns, Family, DeviceList);
0888             
0889             <span class="keyword">if</span> LostBeam
0890                 error(<span class="string">'Tracking failed due to beam loss.'</span>);
0891             <span class="keyword">end</span>
0892             
0893             <span class="keyword">if</span> any(strcmpi(AT.ATType,{<span class="string">'FirstTurn'</span>, <span class="string">'linepass'</span>, <span class="string">'Turns'</span>}))
0894                 <span class="comment">%AM = squeeze(AM(:,:,1:6));</span>
0895             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'xTurns'</span>)
0896                 AM = squeeze(AM(:,:,1));
0897             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'PxTurns'</span>)
0898                 AM = squeeze(AM(:,:,2));
0899             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'yTurns'</span>)
0900                 AM = squeeze(AM(:,:,3));
0901             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'PyTurns'</span>)
0902                 AM = squeeze(AM(:,:,4));
0903             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'dPTurns'</span>)
0904                 AM = squeeze(AM(:,:,5));
0905             <span class="keyword">elseif</span> strcmpi(AT.ATType,<span class="string">'dLTurns'</span>)
0906                 AM = squeeze(AM(:,:,6));
0907             <span class="keyword">else</span>
0908                 error(<span class="string">'Input of unknown type'</span>);
0909             <span class="keyword">end</span>
0910             
0911             <span class="comment">%if size(AM, 1) ~= length(ATIndexList)</span>
0912             <span class="keyword">if</span> size(AM, 2) ~= Nturns
0913                 AM = AM';
0914             <span class="keyword">end</span>
0915             
0916             <span class="comment">% Gain/Roll coordinate change???</span>
0917 
0918             <span class="comment">% Add noise</span>
0919             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0920 
0921         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'Septum'</span>)
0922 
0923             AM = 0;
0924 
0925         <span class="keyword">elseif</span> strcmpi(AT.ATType, <span class="string">'null'</span>)
0926             <span class="comment">% JR default do-nothing behaviour</span>
0927             AM = NaN;
0928 
0929         <span class="keyword">else</span>
0930             <span class="keyword">if</span> isfield(THERING{ATIndexList(1)}, Field)
0931                 <span class="keyword">for</span> i = 1:length(ATIndexList)
0932                     AM(i,:) = THERING{ATIndexList(i)}.(Field);
0933                 <span class="keyword">end</span>
0934             <span class="keyword">else</span>
0935                 <span class="comment">%error(sprintf('ATType unknown for Family %s', Family));</span>
0936                 AM = NaN * ones(length(ATIndexList),1);
0937             <span class="keyword">end</span>
0938             <span class="comment">% Add noise</span>
0939             <span class="comment">%AM = AM + 1e-3*randn(length(AM),1);</span>
0940         <span class="keyword">end</span>
0941     <span class="keyword">end</span>
0942 <span class="keyword">end</span>
0943 
0944 
0945 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0946 <span class="comment">% Change to hardware units if requested %</span>
0947 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0948 <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>) 
0949     <span class="keyword">if</span> isfamily(Family, Field)
0950         AM = physics2hw(Family, Field, AM, DeviceList, <a href="getenergymodel.html" class="code" title="function GeV = getenergymodel">getenergymodel</a>);
0951     <span class="keyword">else</span>
0952         <span class="keyword">persistent</span> WarningFlag
0953         <span class="keyword">if</span> isempty(WarningFlag)
0954             fprintf(<span class="string">'\n   You are asking for hardware units from a nonstandard MML family (%s.%s).\n'</span>, Family, Field);
0955             fprintf(<span class="string">'   Whenever conversion factors are not known for model data, physics units are returned.\n\n'</span>);
0956             WarningFlag = 1;
0957         <span class="keyword">end</span>
0958 
0959         UnitsFlag = <span class="string">'Physics'</span>;
0960     <span class="keyword">end</span>
0961 <span class="keyword">else</span>
0962     UnitsFlag = <span class="string">'Physics'</span>;
0963 <span class="keyword">end</span>
0964 
0965 
0966 <span class="comment">% Expand if there is a time vector input</span>
0967 <span class="keyword">if</span> length(t) &gt; 1
0968     AM(:,1:length(t)) = AM * ones(1,length(t));
0969     tout(1,1:length(t)) = t + gettime - t0;
0970 <span class="keyword">else</span>
0971     <span class="keyword">if</span> strcmpi(Field,<span class="string">'Turns'</span>)
0972         tout = gettime - t0;
0973     <span class="keyword">else</span>
0974         tout = t + gettime - t0;
0975     <span class="keyword">end</span>
0976     <span class="comment">%DataTime = fix(t0) + rem(t0,1)*1e9*sqrt(-1);</span>
0977 <span class="keyword">end</span>
0978 DataTime(1:size(AM,1),1:length(t)) = fix(t0) + rem(t0,1)*1e9*sqrt(-1);
0979 
0980 
0981 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0982 <span class="comment">% Structure Outputs %</span>
0983 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0984 <span class="keyword">if</span> StructOutputFlag
0985     <span class="comment">% Structure output for channel name method</span>
0986     AM.Data = AM;
0987     AM.FamilyName = Family;
0988     AM.Field = Field;
0989     AM.DeviceList = DeviceList;
0990     AM.Mode = <span class="string">'Simulator'</span>;
0991     AM.t = t;           <span class="comment">% Matlab time at start of measurement</span>
0992     AM.tout = tout;     <span class="comment">% Matlab time at  end  of measurement</span>
0993     AM.DataTime = DataTime;
0994     AM.TimeStamp = clock;
0995     AM.Units = UnitsFlag;
0996     <span class="keyword">if</span> strcmpi(AM.Units,<span class="string">'Hardware'</span>)
0997         AM.UnitsString = getfamilydata(Family, Field, <span class="string">'HWUnits'</span>);
0998     <span class="keyword">else</span>
0999         AM.UnitsString = getfamilydata(Family, Field, <span class="string">'PhysicsUnits'</span>);
1000     <span class="keyword">end</span>
1001     AM.DataDescriptor = [];
1002     AM.CreatedBy = <span class="string">'getpvmodel'</span>;
1003 <span class="keyword">end</span>
1004</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>