<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of modeldisp</title>
  <meta name="keywords" content="modeldisp">
  <meta name="description" content="MODELDISP - Returns the dispersion function of the model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mml</a> &gt; <a href="index.html">at</a> &gt; modeldisp.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml/at&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>modeldisp
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MODELDISP - Returns the dispersion function of the model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [Dx, Dy, Sx, Sy] = modeldisp(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MODELDISP - Returns the dispersion function of the model
  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, DeviceList1, Family2, DeviceList2, ModulationMethod)
  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, DeviceList1);  % Uses the same information for both planes
  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, Family2);      % Assumes DeviceList1 and DeviceList2 are []
  [Dx, Dy, Sx, Sy] = modeldisp(Family1, Family2);               % Assumes DeviceList1 and DeviceList2 are []
  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1);               % Family2 = Family1
  [Dx, Dy, Sx, Sy] = modeldisp;                                 % DeltaRF, Family, DeviceList are all optional

  INPUTS
  1. DeltaRF is the change in RF frequency {Default: .2% energy change}
  2. Family1 and Family2 are the family names for where to measure the horizontal/vertical dispersion
     A family name can be a middlelayer family, an AT family (FamName), or 'All' for all AT elements
     plus the end of the ring.  However, if using a non-middlelayer family, 'Physics' units must be used.
     {Default or []: 'All'}
  3. DeviceList1 and DeviceList2 are the device list corresponding to Family2 and Family2.
     Or a subindex array of the AT family.
     {Default or []: the entire list}
  4. ModulationMethod - Method for changing the ActuatorFamily
                       'bipolar' changes the RF by +/- DeltaRF/2 {Default}
                       'unipolar' changes the RF from 0 to DeltaRF
  5. Units - {Default: 'Physics'}
     'Physics' - Forces dispersion units of meters/(dp/p) add 'Physics' with an optional input of the 
                 momentum compaction factor (mcf will be found from the AT function mcf if empty).  
     'Hardware' - Forces dispersion units of (Hardware BPM Units)/(Hardware RF units)
  6. 'Struct'  will return data structures instead of vectors
     'Numeric' will return vector outputs {Default}
  7. Optional display
     'Display'   - Plot the dispersion {Default if no outputs exist}
     'NoDisplay' - Dispersion will not be plotted {Default if outputs exist}
  8. 'NoArchive' - No file archive {Default}
     'Archive'   - Save a dispersion data structure to \&lt;Directory.DispData&gt;\&lt;DispArchiveFile&gt;&lt;Date&gt;&lt;Time&gt;.mat
                   To change the filename, included the filename after the 'Archive', '' to browse

  OUTPUTS
  1. Dx and Dy - Horizontal and vertical dispersion function
                 Note: it does not matter what the input families are
                       Dx is always horizontal and Dy vertical 
  2. Sx and Sy are longitudinal locations in the ring [meters].

  For hardware units:
  Dx = Delta BPMx / Delta RF and Dy = Delta BPMy / Delta RF
       hence Dx and Dy are not quite the definition of dispersion

               x2(RF0+DeltaRF/2) - x1(RF0-DeltaRF/2) 
           D = -------------------------------------
                              DeltaRF
           
           where RF0 = is the present RF frequency

  For physics units: DeltaRF is converted to change in energy, dp/p,
  hence dispersion is has units of [meters/(dp/p)]
   
  NOTE
  1. This function uses the model coordinate system, ie, no BPM rolls.  If hardware
     units are used, only a gain change will be applied. 
  2. This function only call the AT model. 
  3. If no output exist, the dispersion function will be plotted to the screen.
  4. Family2 and DeviceList1 can be any family.  For instance, if Family2='VCM'
     and DeviceList1=[], then Dx is the horizontal dispersion function at the 
     vertical corrector magnets (similarly for Family2 and DeviceList2).

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>	DRAWLATTICE - Draws the AT lattice to a figure</li><li><a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>	FAMILY2ATINDEX - Returns the AT index for a given family</li><li><a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>	GETCAVITY - Returns the RF cavity state ('On' / 'Off')</li><li><a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>	ISRADIATIONON - 1 if a radiation passmethod is found</li><li><a href="modelmcf.html" class="code" title="function Alpha = modelmcf">modelmcf</a>	MODELMCF - Momentum compaction factor (MCF) of the model</li><li><a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>	SETCAVITY - Set the RF cavity state</li><li><a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a>	SETRADIATION - Sets the model PassMethod to include or exclude radiation ('On' / 'Off' {Default})</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="modelchrosensitivity.html" class="code" title="function [DSx DSz] = modelchrosensitivity(varargin)">modelchrosensitivity</a>	TUNESENSITIVITY - Computes sextupole change for a given dxi</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Dx, Dy, Sx, Sy] = modeldisp(varargin)</a>
0002 <span class="comment">%MODELDISP - Returns the dispersion function of the model</span>
0003 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, DeviceList1, Family2, DeviceList2, ModulationMethod)</span>
0004 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, DeviceList1);  % Uses the same information for both planes</span>
0005 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1, Family2);      % Assumes DeviceList1 and DeviceList2 are []</span>
0006 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp(Family1, Family2);               % Assumes DeviceList1 and DeviceList2 are []</span>
0007 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp(DeltaRF, Family1);               % Family2 = Family1</span>
0008 <span class="comment">%  [Dx, Dy, Sx, Sy] = modeldisp;                                 % DeltaRF, Family, DeviceList are all optional</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  INPUTS</span>
0011 <span class="comment">%  1. DeltaRF is the change in RF frequency {Default: .2% energy change}</span>
0012 <span class="comment">%  2. Family1 and Family2 are the family names for where to measure the horizontal/vertical dispersion</span>
0013 <span class="comment">%     A family name can be a middlelayer family, an AT family (FamName), or 'All' for all AT elements</span>
0014 <span class="comment">%     plus the end of the ring.  However, if using a non-middlelayer family, 'Physics' units must be used.</span>
0015 <span class="comment">%     {Default or []: 'All'}</span>
0016 <span class="comment">%  3. DeviceList1 and DeviceList2 are the device list corresponding to Family2 and Family2.</span>
0017 <span class="comment">%     Or a subindex array of the AT family.</span>
0018 <span class="comment">%     {Default or []: the entire list}</span>
0019 <span class="comment">%  4. ModulationMethod - Method for changing the ActuatorFamily</span>
0020 <span class="comment">%                       'bipolar' changes the RF by +/- DeltaRF/2 {Default}</span>
0021 <span class="comment">%                       'unipolar' changes the RF from 0 to DeltaRF</span>
0022 <span class="comment">%  5. Units - {Default: 'Physics'}</span>
0023 <span class="comment">%     'Physics' - Forces dispersion units of meters/(dp/p) add 'Physics' with an optional input of the</span>
0024 <span class="comment">%                 momentum compaction factor (mcf will be found from the AT function mcf if empty).</span>
0025 <span class="comment">%     'Hardware' - Forces dispersion units of (Hardware BPM Units)/(Hardware RF units)</span>
0026 <span class="comment">%  6. 'Struct'  will return data structures instead of vectors</span>
0027 <span class="comment">%     'Numeric' will return vector outputs {Default}</span>
0028 <span class="comment">%  7. Optional display</span>
0029 <span class="comment">%     'Display'   - Plot the dispersion {Default if no outputs exist}</span>
0030 <span class="comment">%     'NoDisplay' - Dispersion will not be plotted {Default if outputs exist}</span>
0031 <span class="comment">%  8. 'NoArchive' - No file archive {Default}</span>
0032 <span class="comment">%     'Archive'   - Save a dispersion data structure to \&lt;Directory.DispData&gt;\&lt;DispArchiveFile&gt;&lt;Date&gt;&lt;Time&gt;.mat</span>
0033 <span class="comment">%                   To change the filename, included the filename after the 'Archive', '' to browse</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%  OUTPUTS</span>
0036 <span class="comment">%  1. Dx and Dy - Horizontal and vertical dispersion function</span>
0037 <span class="comment">%                 Note: it does not matter what the input families are</span>
0038 <span class="comment">%                       Dx is always horizontal and Dy vertical</span>
0039 <span class="comment">%  2. Sx and Sy are longitudinal locations in the ring [meters].</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%  For hardware units:</span>
0042 <span class="comment">%  Dx = Delta BPMx / Delta RF and Dy = Delta BPMy / Delta RF</span>
0043 <span class="comment">%       hence Dx and Dy are not quite the definition of dispersion</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%               x2(RF0+DeltaRF/2) - x1(RF0-DeltaRF/2)</span>
0046 <span class="comment">%           D = -------------------------------------</span>
0047 <span class="comment">%                              DeltaRF</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%           where RF0 = is the present RF frequency</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%  For physics units: DeltaRF is converted to change in energy, dp/p,</span>
0052 <span class="comment">%  hence dispersion is has units of [meters/(dp/p)]</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%  NOTE</span>
0055 <span class="comment">%  1. This function uses the model coordinate system, ie, no BPM rolls.  If hardware</span>
0056 <span class="comment">%     units are used, only a gain change will be applied.</span>
0057 <span class="comment">%  2. This function only call the AT model.</span>
0058 <span class="comment">%  3. If no output exist, the dispersion function will be plotted to the screen.</span>
0059 <span class="comment">%  4. Family2 and DeviceList1 can be any family.  For instance, if Family2='VCM'</span>
0060 <span class="comment">%     and DeviceList1=[], then Dx is the horizontal dispersion function at the</span>
0061 <span class="comment">%     vertical corrector magnets (similarly for Family2 and DeviceList2).</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%  Written by Greg Portmann</span>
0064 
0065 
0066 <span class="keyword">global</span> THERING
0067 <span class="keyword">if</span> isempty(THERING)
0068     error(<span class="string">'Simulator variable is not setup properly'</span>);
0069 <span class="keyword">end</span>
0070 
0071 DeltaRFDefault = .1;  <span class="comment">% Hz</span>
0072 Family1 = <span class="string">'ALL'</span>;
0073 Family2 = <span class="string">'ALL'</span>;
0074 <span class="comment">%Family1 = 'BPMx';</span>
0075 <span class="comment">%Family2 = 'BPMy';</span>
0076 DeviceList1 = [];   
0077 DeviceList2 = [];   
0078 ModulationMethod = <span class="string">'bipolar'</span>;
0079 StructOutputFlag = 0;
0080 NumericOutputFlag = 0; 
0081 ArchiveFlag = 0;
0082 FileName = -1;
0083 <span class="keyword">if</span> nargout == 0
0084     DisplayFlag = 1;
0085 <span class="keyword">else</span>
0086     DisplayFlag = 0;
0087 <span class="keyword">end</span>
0088 ModeFlag = {};  <span class="comment">% model, online, manual, or '' for default mode</span>
0089 UnitsFlag = <span class="string">''</span>; <span class="comment">% hardware, physics, or '' for default units</span>
0090 MCF = [];
0091 
0092 InputFlags = {};
0093 <span class="keyword">for</span> i = length(varargin):-1:1
0094     <span class="keyword">if</span> isstruct(varargin{i})
0095         <span class="comment">% Ignor structures</span>
0096     <span class="keyword">elseif</span> iscell(varargin{i})
0097         <span class="comment">% Ignor cells</span>
0098     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'struct'</span>)
0099         StructOutputFlag = 1;
0100         varargin(i) = [];
0101     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'numeric'</span>)
0102         NumericOutputFlag = 1;
0103         StructOutputFlag = 0;
0104         varargin(i) = [];
0105     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'archive'</span>)
0106         ArchiveFlag = 1;
0107         <span class="keyword">if</span> length(varargin) &gt; i
0108             <span class="comment">% Look for a filename as the next input</span>
0109             <span class="keyword">if</span> ischar(varargin{i+1})
0110                 FileName = varargin{i+1};
0111                 varargin(i+1) = [];
0112             <span class="keyword">end</span>
0113         <span class="keyword">end</span>
0114         varargin(i) = [];
0115     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'noarchive'</span>)
0116         ArchiveFlag = 0;
0117         varargin(i) = [];
0118     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0119         DisplayFlag = 1;
0120         varargin(i) = [];
0121     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0122         DisplayFlag = 0;
0123         varargin(i) = [];
0124     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'bipolar'</span>)
0125         ModulationMethod = <span class="string">'bipolar'</span>;
0126         varargin(i) = [];
0127     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'unipolar'</span>)
0128         ModulationMethod = <span class="string">'unipolar'</span>;
0129         varargin(i) = [];
0130     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'eta'</span>) | strcmpi(varargin{i},<span class="string">'physics'</span>)
0131         UnitsFlag = <span class="string">'Physics'</span>;
0132         varargin(i) = [];
0133         <span class="keyword">if</span> length(varargin) &gt;= i
0134             <span class="keyword">if</span> isnumeric(varargin{i})
0135                 MCF = varargin{i};
0136                 varargin(i) = [];
0137             <span class="keyword">end</span>
0138         <span class="keyword">end</span>
0139     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0140         UnitsFlag = varargin{i};
0141         varargin(i) = [];
0142         <span class="keyword">if</span> length(varargin) &gt;= i
0143             <span class="keyword">if</span> isnumeric(varargin{i})
0144                 MCF = varargin{i};
0145                 varargin(i) = [];
0146             <span class="keyword">end</span>
0147         <span class="keyword">end</span>
0148     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'simulator'</span>) | strcmpi(varargin{i},<span class="string">'model'</span>)
0149         <span class="comment">% Ignor</span>
0150         varargin(i) = [];
0151     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'online'</span>)
0152         <span class="comment">% Ignor</span>
0153         varargin(i) = [];
0154     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'manual'</span>)
0155         <span class="comment">% Ignor</span>
0156         varargin(i) = [];
0157     <span class="keyword">end</span>
0158 <span class="keyword">end</span>
0159 
0160 
0161 <span class="comment">% Look for DeltaRF input</span>
0162 <span class="keyword">if</span> length(varargin) &gt;= 1
0163     <span class="keyword">if</span> isnumeric(varargin{1})
0164         DeltaRF = varargin{1}; 
0165         varargin(1) = [];
0166     <span class="keyword">else</span>
0167         DeltaRF = [];
0168     <span class="keyword">end</span>
0169 <span class="keyword">else</span>
0170     DeltaRF = [];
0171 <span class="keyword">end</span>
0172 
0173 
0174 <span class="comment">% Look for BPMx family info</span>
0175 <span class="keyword">if</span> length(varargin) &gt;= 1
0176     <span class="keyword">if</span> isstr(varargin{1})
0177         Family1 = varargin{1};
0178         varargin(1) = [];
0179         <span class="keyword">if</span> length(varargin) &gt;= 1
0180             <span class="keyword">if</span> isnumeric(varargin{1})
0181                 DeviceList1 = varargin{1};
0182                 varargin(1) = [];
0183             <span class="keyword">end</span>
0184         <span class="keyword">end</span>
0185     <span class="keyword">elseif</span> isnumeric(varargin{1})
0186         DeviceList1 = varargin{1};
0187         varargin(1) = [];
0188     <span class="keyword">elseif</span> isstruct(varargin{1})
0189         Family1 = varargin{1}.FamilyName;
0190         DeviceList1 = varargin{1}.DeviceList;
0191         <span class="keyword">if</span> isempty(UnitsFlag)
0192             UnitsFlag = varargin{1}.Units;
0193         <span class="keyword">end</span>
0194         <span class="keyword">if</span> ~NumericOutputFlag
0195             <span class="comment">% Only change StructOutputFlag if 'numeric' is not on the input line</span>
0196             StructOutputFlag = 1;
0197         <span class="keyword">end</span>
0198         varargin(1) = [];      
0199     <span class="keyword">end</span>
0200 <span class="keyword">end</span>
0201 
0202 <span class="comment">% Look for BPMy family info</span>
0203 <span class="keyword">if</span> length(varargin) &gt;= 1
0204     <span class="keyword">if</span> isstr(varargin{1})
0205         Family2 = varargin{1};
0206         varargin(1) = [];
0207         <span class="keyword">if</span> length(varargin) &gt;= 1
0208             <span class="keyword">if</span> isnumeric(varargin{1})
0209                 DeviceList2 = varargin{1};
0210                 varargin(1) = [];
0211             <span class="keyword">end</span>
0212         <span class="keyword">end</span>
0213     <span class="keyword">elseif</span> isnumeric(varargin{1})
0214         DeviceList2 = varargin{1};
0215         varargin(1) = [];
0216     <span class="keyword">elseif</span> isstruct(varargin{1})
0217         Family2 = varargin{1}.FamilyName;
0218         DeviceList2 = varargin{1}.DeviceList;
0219         <span class="keyword">if</span> isempty(UnitsFlag)
0220             UnitsFlag = varargin{1}.Units;
0221         <span class="keyword">end</span>
0222         <span class="keyword">if</span> ~NumericOutputFlag
0223             <span class="comment">% Only change StructOutputFlag if 'numeric' is not on the input line</span>
0224             StructOutputFlag = 1;
0225         <span class="keyword">end</span>
0226         varargin(1) = [];      
0227     <span class="keyword">end</span>
0228 <span class="keyword">else</span>
0229     Family2 = Family1;
0230     DeviceList2 = DeviceList1;
0231 <span class="keyword">end</span>
0232 <span class="comment">% End of input parsing</span>
0233 
0234 
0235 <span class="comment">% Archive data structure</span>
0236 <span class="keyword">if</span> ArchiveFlag
0237     <span class="keyword">if</span> isempty(FileName)
0238         FileName = appendtimestamp(getfamilydata(<span class="string">'Default'</span>, <span class="string">'DispArchiveFile'</span>));
0239         DirectoryName = getfamilydata(<span class="string">'Directory'</span>,<span class="string">'DispData'</span>);
0240         <span class="keyword">if</span> isempty(DirectoryName)
0241             DirectoryName = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'DataRoot'</span>) <span class="string">'Dispersion'</span>, filesep];
0242         <span class="keyword">else</span>
0243             <span class="comment">% Make sure default directory exists</span>
0244             DirStart = pwd;
0245             [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
0246             cd(DirStart);
0247         <span class="keyword">end</span>
0248         [FileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Select Dispersion File'</span>, [DirectoryName FileName]);
0249         <span class="keyword">if</span> FileName == 0
0250             ArchiveFlag = 0;
0251             disp(<span class="string">'   Dispersion measurement canceled.'</span>);
0252             Dx=[]; Dy=[]; FileName=<span class="string">''</span>;
0253             <span class="keyword">return</span>
0254         <span class="keyword">end</span>
0255         FileName = [DirectoryName, FileName];
0256     <span class="keyword">elseif</span> FileName == -1
0257         FileName = appendtimestamp(getfamilydata(<span class="string">'Default'</span>, <span class="string">'DispArchiveFile'</span>));
0258         DirectoryName = getfamilydata(<span class="string">'Directory'</span>,<span class="string">'DispData'</span>);
0259         <span class="keyword">if</span> isempty(DirectoryName)
0260             DirectoryName = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'DataRoot'</span>) <span class="string">'Dispersion'</span>, filesep];
0261         <span class="keyword">end</span>
0262         FileName = [DirectoryName, FileName];
0263     <span class="keyword">end</span>
0264 <span class="keyword">end</span>
0265 
0266 
0267 <span class="comment">% Get the input units</span>
0268 <span class="keyword">if</span> isempty(UnitsFlag)
0269     UnitsFlag = <span class="string">'Physics'</span>;
0270 <span class="comment">%     if strcmpi(Family1, 'All') | strcmpi(Family2, 'All')</span>
0271 <span class="comment">%         UnitsFlag = 'Physics';</span>
0272 <span class="comment">%     else</span>
0273 <span class="comment">%         RFUnitsInput = getfamilydata('RF','Setpoint','Units');</span>
0274 <span class="comment">%         UnitsFlag = RFUnitsInput;</span>
0275 <span class="comment">%     end</span>
0276 <span class="keyword">else</span>
0277     RFUnitsInput = UnitsFlag;
0278 <span class="keyword">end</span>
0279 
0280 
0281 <span class="comment">% Get DeltaRF in Hardware units</span>
0282 RFHWUnits = getfamilydata(<span class="string">'RF'</span>,<span class="string">'Setpoint'</span>,<span class="string">'HWUnits'</span>);
0283 
0284 
0285 <span class="comment">% Make sure DeltaRF is in hardware units</span>
0286 <span class="keyword">if</span> isempty(DeltaRF) | ~isnumeric(DeltaRF)
0287     <span class="comment">% Get the default from the AD is in Hardware units</span>
0288     DeltaRF = getfamilydata(<span class="string">'DeltaRFDisp'</span>);
0289     
0290     <span class="comment">% If the default is not in the AD</span>
0291     <span class="keyword">if</span> isempty(DeltaRF)
0292         <span class="comment">% Here is the second level default</span>
0293         DeltaRF = getrf(<span class="string">'Model'</span>,<span class="string">'Hardware'</span>) * <a href="modelmcf.html" class="code" title="function Alpha = modelmcf">modelmcf</a> * .002;  <span class="comment">% .2% energy change</span>
0294     <span class="keyword">end</span>
0295 
0296 <span class="keyword">else</span>
0297     <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Physics'</span>)
0298         <span class="comment">% Change to hardware</span>
0299         RFUnitsInput = UnitsFlag;
0300         DeltaRF = physics2hw(<span class="string">'RF'</span>, <span class="string">'Setpoint'</span>, DeltaRF, [1 1]);
0301     <span class="keyword">end</span>
0302 <span class="keyword">end</span>
0303 
0304 
0305 <span class="comment">% DeltaRF are in hardware units at this point</span>
0306 <span class="comment">% Change to AT units</span>
0307 DeltaRF = hw2physics(<span class="string">'RF'</span>, <span class="string">'Setpoint'</span>, DeltaRF, [1 1]);
0308 
0309 
0310 <span class="comment">% Check DeltaRF for resonable values</span>
0311 <span class="keyword">if</span> DeltaRF &gt; 15000;  <span class="comment">% Hz</span>
0312     tmp = questdlg(sprintf(<span class="string">'%f Hz is a large RF change.  Do you want to continue?'</span>, DeltaRF),<span class="string">'Dispersion Measurement'</span>,<span class="string">'YES'</span>,<span class="string">'NO'</span>,<span class="string">'YES'</span>);
0313     <span class="keyword">if</span> strcmp(tmp,<span class="string">'NO'</span>)
0314         Dx=[];  Dy=[];
0315         <span class="keyword">return</span>
0316     <span class="keyword">end</span>
0317 <span class="keyword">end</span>
0318 
0319 <span class="keyword">if</span> isempty(MCF)
0320     MCF = <a href="modelmcf.html" class="code" title="function Alpha = modelmcf">modelmcf</a>;
0321 <span class="keyword">end</span>
0322 
0323 
0324 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0325 <span class="comment">% Get the model dispersion %</span>
0326 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0327 
0328 <span class="comment">% Find which orbit method to use</span>
0329 [CavityState, PassMethod, iCavity] = <a href="getcavity.html" class="code" title="function [CavityState, PassMethod, ATCavityIndex, RF, HarmNumber] = getcavity">getcavity</a>;
0330 <span class="keyword">if</span> isempty(CavityState)
0331     <span class="comment">% No cavity in AT model</span>
0332     <span class="keyword">if</span> <a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>
0333         fprintf(<span class="string">'   Turning radiation off since there is no RF cavity.\n'</span>);
0334         <a href="setradiation.html" class="code" title="function [PassMethod, ATIndex, FamName, PassMethodOld, ATIndexOld, FamNameOld] = setradiation(InputString)">setradiation</a> off;
0335     <span class="keyword">end</span>
0336     ATMethod = <span class="string">'findorbit4'</span>;
0337 <span class="keyword">else</span>
0338     <span class="keyword">if</span> strcmpi(deblank(CavityState(1,:)), <span class="string">'On'</span>) | <a href="isradiationon.html" class="code" title="function Answer = isradiationon">isradiationon</a>
0339         <span class="comment">% findorbit6 recommended when cavity or radiation is on</span>
0340         <span class="keyword">if</span> strcmpi(deblank(CavityState(1,:)), <span class="string">'Off'</span>)
0341             <span class="comment">% Turn off cavity in AT model</span>
0342             fprintf(<span class="string">'   Turning the RF cavity on, since radiation is on.\n'</span>);
0343             <a href="setcavity.html" class="code" title="function ATCavityIndex = setcavity(InputString)">setcavity</a>(<span class="string">'On'</span>);
0344         <span class="keyword">end</span>
0345         ATMethod = <span class="string">'findorbit6'</span>;
0346     <span class="keyword">else</span>
0347         <span class="comment">% Cavity is off in AT model</span>
0348         ATMethod = <span class="string">'findsyncorbit'</span>;
0349     <span class="keyword">end</span>
0350 <span class="keyword">end</span>
0351 
0352 
0353 <span class="keyword">if</span> strcmpi(ATMethod, <span class="string">'findsyncorbit'</span>)      
0354     C = 2.99792458e8;
0355     CavityFrequency  = THERING{iCavity(1)}.Frequency;
0356     CavityHarmNumber = THERING{iCavity(1)}.HarmNumber;
0357     L = findspos(THERING,length(THERING)+1)';  <span class="comment">% getfamilydata('Circumference')</span>
0358     f0 = C * CavityHarmNumber / L;
0359     RFChange = CavityFrequency - f0;   <span class="comment">% To account for all the changes made to the RF [Hz]</span>
0360     
0361     <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0362         ORBITPLUS = findsyncorbit(THERING, (-C*( DeltaRF+RFChange)*CavityHarmNumber/CavityFrequency^2)/2, 1:length(THERING)+1);
0363         ORBIT0    = findsyncorbit(THERING, (-C*(-DeltaRF+RFChange)*CavityHarmNumber/CavityFrequency^2)/2, 1:length(THERING)+1);
0364     <span class="keyword">else</span>
0365         ORBITPLUS = findsyncorbit(THERING, -C*(DeltaRF+RFChange)*CavityHarmNumber/CavityFrequency^2, 1:length(THERING)+1);
0366         ORBIT0    = findsyncorbit(THERING, -C*(        RFChange)*CavityHarmNumber/CavityFrequency^2, 1:length(THERING)+1);
0367     <span class="keyword">end</span>    
0368 <span class="keyword">elseif</span> strcmpi(ATMethod, <span class="string">'findorbit4'</span>)
0369     <span class="comment">% Use findorbit4</span>
0370     <span class="comment">% CavityFrequency is needed to for convert DeltaRF to dP</span>
0371     <span class="comment">% Since on cavity is in the model, use the frequency calculated from the harmonic number</span>
0372     C = 2.99792458e8;
0373     CavityHarmNumber = getfamilydata(<span class="string">'HarmonicNumber'</span>);
0374     <span class="keyword">if</span> isempty(CavityHarmNumber)
0375         error(<span class="string">'Add HarmonicNumber to the ML so that the RF can be inferred when no cavity is in the model'</span>);
0376     <span class="keyword">end</span>
0377     L = findspos(THERING,length(THERING)+1)';  <span class="comment">% getfamilydata('Circumference')</span>
0378     CavityFrequency = C * CavityHarmNumber / L;
0379     dP = DeltaRF / MCF/ CavityFrequency;
0380     <span class="comment">%DeltaRF = CavityFrequency * MCF * dP;</span>
0381     <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0382         ORBITPLUS = findorbit4(THERING, -dP/2, 1:length(THERING)+1);
0383         ORBIT0    = findorbit4(THERING,  dP/2, 1:length(THERING)+1);
0384     <span class="keyword">else</span>
0385         ORBITPLUS = findorbit4(THERING, -dP, 1:length(THERING)+1);
0386         ORBIT0    = findorbit4(THERING,   0, 1:length(THERING)+1);
0387     <span class="keyword">end</span>    
0388     
0389 <span class="keyword">elseif</span> strcmpi(ATMethod, <span class="string">'findorbit6'</span>)
0390     <span class="comment">% Use findorbit6</span>
0391     CavityFrequency = THERING{iCavity(1)}.Frequency;
0392     <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0393         <span class="keyword">for</span> kk = 1:length(iCavity)
0394             THERING{iCavity(kk)}.Frequency = CavityFrequency + DeltaRF/2;
0395         <span class="keyword">end</span>               
0396         ORBITPLUS = findorbit6(THERING, 1:length(THERING)+1);
0397     <span class="keyword">else</span>
0398         <span class="keyword">for</span> kk = 1:length(iCavity)
0399             THERING{iCavity(kk)}.Frequency = CavityFrequency + DeltaRF;
0400         <span class="keyword">end</span>               
0401         ORBITPLUS = findorbit6(THERING, 1:length(THERING)+1);
0402     <span class="keyword">end</span>    
0403     <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0404         <span class="keyword">for</span> kk = 1:length(iCavity)
0405             THERING{iCavity(kk)}.Frequency = CavityFrequency - DeltaRF/2;
0406         <span class="keyword">end</span>               
0407         ORBIT0 = findorbit6(THERING, 1:length(THERING)+1);
0408         <span class="keyword">for</span> kk = 1:length(iCavity)
0409             THERING{iCavity(kk)}.Frequency = CavityFrequency;
0410         <span class="keyword">end</span>               
0411     <span class="keyword">else</span>
0412         <span class="keyword">for</span> kk = 1:length(iCavity)
0413             THERING{iCavity(kk)}.Frequency = CavityFrequency;
0414         <span class="keyword">end</span>               
0415         ORBIT0 = findorbit6(THERING, 1:length(THERING)+1);
0416     <span class="keyword">end</span>    
0417 <span class="keyword">end</span>
0418 
0419 
0420 <span class="comment">% Horizontal plane</span>
0421 <span class="keyword">if</span> strcmpi(Family1,<span class="string">'All'</span>)
0422     Index1 = 1:length(THERING)+1;
0423     <span class="keyword">if</span> ~isempty(DeviceList1)
0424         Index1 = Index1(DeviceList1);
0425     <span class="keyword">end</span>
0426 <span class="keyword">elseif</span> isfamily(Family1)
0427     Index1 = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(Family1, DeviceList1);
0428 <span class="keyword">else</span>
0429     Index1 = findcells(THERING, <span class="string">'FamName'</span>, Family1);
0430     <span class="keyword">if</span> ~isempty(DeviceList1)
0431         Index1 = Index1(DeviceList1);
0432     <span class="keyword">end</span>
0433 <span class="keyword">end</span>
0434 <span class="keyword">if</span> isempty(Index1)
0435     error(sprintf(<span class="string">'Family1=%s could not be found in the AO or AT deck'</span>,Family1));
0436 <span class="keyword">else</span>
0437     Index1 = Index1(:)';    <span class="comment">% Row vector</span>
0438 <span class="keyword">end</span>
0439 
0440 D = ORBITPLUS([1 3], Index1) - ORBIT0([1 3], Index1);
0441 Sx = findspos(THERING, Index1);
0442 Sx = Sx(:)';
0443 Dx = D(1,:)' / DeltaRF;
0444 
0445 <span class="comment">% Vertical plane</span>
0446 <span class="keyword">if</span> strcmpi(Family2,<span class="string">'All'</span>) 
0447     Index2 = 1:length(THERING)+1;
0448     <span class="keyword">if</span> ~isempty(DeviceList2)
0449         Index2 = Index2(DeviceList2);
0450     <span class="keyword">end</span>
0451 <span class="keyword">elseif</span> isfamily(Family2)
0452     Index2 = <a href="family2atindex.html" class="code" title="function [ATIndexList, ErrorFlag] = family2atindex(Family, varargin);">family2atindex</a>(Family2, DeviceList2);
0453 <span class="keyword">else</span>
0454     Index2 = findcells(THERING, <span class="string">'FamName'</span>, Family2);
0455     <span class="keyword">if</span> ~isempty(DeviceList2)
0456         Index2 = Index2(DeviceList2);
0457     <span class="keyword">end</span>
0458 <span class="keyword">end</span>
0459 <span class="keyword">if</span> isempty(Index2)
0460     error(sprintf(<span class="string">'Family2=%s could not be found in the AO or AT deck'</span>,Family2));
0461 <span class="keyword">else</span>
0462     Index2 = Index2(:)';    <span class="comment">% Row vector</span>
0463 <span class="keyword">end</span>
0464 
0465 D = ORBITPLUS([1 3], Index2) - ORBIT0([1 3], Index2);
0466 Sy = findspos(THERING, Index2);
0467 Sy = Sy(:)';
0468 Dy = D(2,:)' / DeltaRF;
0469 
0470 <span class="comment">% All elements</span>
0471 D = ORBITPLUS([1 3], :) - ORBIT0([1 3], :);
0472 DxAll = D(1,:)' / DeltaRF;
0473 DyAll = D(2,:)' / DeltaRF;
0474 SAll = findspos(THERING, 1:length(THERING)+1);
0475 
0476 
0477 <span class="comment">% Dispersion has units meters/Hz at this point</span>
0478 <span class="comment">% Change to true physics units meters/(dp/p)</span>
0479 Dx = -CavityFrequency * MCF * Dx;
0480 Dy = -CavityFrequency * MCF * Dy;
0481 DxAll = -CavityFrequency * MCF * DxAll;
0482 DyAll = -CavityFrequency * MCF * DyAll;
0483 
0484 <span class="comment">% Fill the dispersion structure (response matrix structure + some fields)</span>
0485 d(1).Data = Dx;
0486 d(2).Data = Dy;
0487 d(1).FamilyName = <span class="string">'DispersionX'</span>;
0488 d(2).FamilyName = <span class="string">'DispersionY'</span>;
0489 
0490 d(1).Actuator = getsp(<span class="string">'RF'</span>,<span class="string">'Physics'</span>,<span class="string">'Struct'</span>);
0491 d(2).Actuator = d(1).Actuator;
0492 <span class="comment">% d(1).Actuator.Data = CavityFrequency;</span>
0493 <span class="comment">% d(2).Actuator.Data = CavityFrequency;</span>
0494 <span class="comment">% d(1).Actuator.Units = 'Physics';</span>
0495 <span class="comment">% d(2).Actuator.Units = 'Physics';</span>
0496 <span class="comment">% d(1).Actuator.UnitsString = 'Hz';</span>
0497 <span class="comment">% d(2).Actuator.UnitsString = 'Hz';</span>
0498 d(1).ActuatorDelta = DeltaRF;
0499 d(2).ActuatorDelta = DeltaRF;
0500 
0501 <span class="keyword">if</span> isfamily(Family1) &amp; ismemberof(Family1, <span class="string">'BPM'</span>)
0502     d(1).Monitor = family2datastruct(Family1, <span class="string">'Monitor'</span>, DeviceList1, <span class="string">'Physics'</span>);
0503 <span class="keyword">else</span>
0504     d(1).Monitor.Data = ORBIT0(1, Index1)';
0505     d(1).Monitor.FamilyName = [<span class="string">'x@'</span>, Family1];
0506     d(1).Monitor.Field = <span class="string">'Monitor'</span>;
0507     d(1).Monitor.DeviceList = DeviceList1;
0508     d(1).Monitor.Units = <span class="string">'Physics'</span>;
0509     d(1).Monitor.UnitsString = <span class="string">'meters'</span>;
0510     d(1).Monitor.TimeStamp = clock;
0511     d(1).Monitor.t = 0;
0512     d(1).Monitor.tout = 0;
0513 <span class="keyword">end</span>
0514 <span class="keyword">if</span> isfamily(Family2) &amp; ismemberof(Family2, <span class="string">'BPM'</span>)
0515     d(2).Monitor = family2datastruct(Family2, <span class="string">'Monitor'</span>, DeviceList2, <span class="string">'Physics'</span>);
0516 <span class="keyword">else</span>
0517     d(2).Monitor.Data = ORBIT0(2, Index2)';
0518     d(2).Monitor.FamilyName = [<span class="string">'y@'</span>, Family2];
0519     d(2).Monitor.Field = <span class="string">'Monitor'</span>;
0520     d(2).Monitor.DeviceList = DeviceList2;
0521     d(2).Monitor.Units = <span class="string">'Physics'</span>;
0522     d(2).Monitor.UnitsString = <span class="string">'meters'</span>;
0523     d(2).Monitor.TimeStamp = clock;
0524     d(2).Monitor.t = 0;
0525     d(2).Monitor.tout = 0;
0526 <span class="keyword">end</span>
0527 
0528 d(1).TimeStamp = clock;
0529 d(2).TimeStamp = d(1).TimeStamp;
0530 
0531 <span class="keyword">for</span> i=1:2
0532     d(i).Mode = <span class="string">'Model'</span>;
0533     d(i).Units = <span class="string">'Physics'</span>;
0534     d(i).UnitsString = <span class="string">'m/(dp/p)'</span>;
0535     d(i).ModulationMethod = ModulationMethod;
0536     d(i).OperationalMode = getfamilydata(<span class="string">'OperationalMode'</span>);
0537     d(i).DataDescriptor = <span class="string">'Dispersion'</span>;
0538     d(i).CreatedBy = <span class="string">'modeldisp'</span>;
0539     d(i).GeV = getenergy(<span class="string">'Model'</span>);
0540     d(i).WaitFlag = -2;
0541     d(i).MCF = MCF;
0542     d(i).dp = -DeltaRF / (CavityFrequency*MCF);
0543 <span class="keyword">end</span>
0544 
0545 
0546 <span class="comment">% Final units conversion</span>
0547 <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0548     <span class="keyword">if</span> ~ismemberof(Family1, <span class="string">'BPM'</span>) | ~ismemberof(Family2, <span class="string">'BPM'</span>)
0549         error(<span class="string">'Hardware units cannot be used when not using a BPM family'</span>);
0550     <span class="keyword">end</span>
0551     d = physics2hw(d);
0552 <span class="keyword">end</span>
0553 
0554 
0555 <span class="comment">% Output</span>
0556 <span class="comment">% Plot if no output</span>
0557 <span class="keyword">if</span> DisplayFlag
0558     <span class="comment">% Plot dispersion</span>
0559     
0560     <span class="comment">% plotdisp cannot handle a AT family name or 'All'</span>
0561     <span class="comment">% so a new dispersion plot was written below</span>
0562     <span class="comment">%plotdisp(d);</span>
0563 
0564     UnitsFlag = d(1).Units;
0565     UnitsString = d(1).UnitsString;
0566 
0567     <span class="keyword">if</span> strcmp(UnitsString, <span class="string">'mm/MHz'</span>)
0568         TitleString = sprintf(<span class="string">'Change in Orbit / Change in RF (Delta RF=%g Hz)'</span>, DeltaRF);
0569     <span class="keyword">elseif</span> strcmp(UnitsString, <span class="string">'meters/(dp/p)'</span>) | strcmp(UnitsString, <span class="string">'m/(dp/p)'</span>)
0570         TitleString = sprintf(<span class="string">'Dispersion Function: %s  (\\alpha=%.5f, f=%f Hz, \\Deltaf=%g Hz)'</span>, texlabel(<span class="string">'-alpha f {Delta}Orbit / {Delta}f'</span>), MCF, CavityFrequency, DeltaRF);
0571     <span class="keyword">else</span>
0572         TitleString = <span class="string">'Dispersion Function'</span>;
0573     <span class="keyword">end</span>
0574     
0575     h1 = subplot(5,1,[1 2]);
0576     plot(SAll, DxAll, <span class="string">'-b'</span>);
0577     <span class="keyword">if</span> strcmpi(Family1,<span class="string">'All'</span>)
0578         xlabel(<span class="string">'Position [meters]'</span>);
0579     <span class="keyword">else</span>
0580         hold on; 
0581         plot(Sx, Dx, <span class="string">'.b'</span>);
0582         hold off;
0583         xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family1));
0584     <span class="keyword">end</span>
0585     xlim([0 SAll(end)]);
0586     ylabel(sprintf(<span class="string">'Horizontal [%s]'</span>, UnitsString));
0587     title(TitleString);
0588     
0589     h2 = subplot(5,1,3);
0590     <a href="drawlattice.html" class="code" title="function drawlattice(Offset, Scaling, hAxes)">drawlattice</a>;
0591     
0592     h3 = subplot(5,1,[4 5]);
0593     plot(SAll, DyAll, <span class="string">'-b'</span>);
0594     <span class="keyword">if</span> strcmpi(Family2,<span class="string">'All'</span>)
0595         xlabel(<span class="string">'Position [meters]'</span>);
0596     <span class="keyword">else</span>
0597         hold on; 
0598         plot(Sy, Dy, <span class="string">'.b'</span>);
0599         hold off;
0600         xlabel(sprintf(<span class="string">'%s Position [meters]'</span>, Family2));
0601     <span class="keyword">end</span>
0602     ylabel(sprintf(<span class="string">'Vertical [%s]'</span>, UnitsString));
0603     
0604     linkaxes([h1 h2 h3],<span class="string">'x'</span>)
0605     set([h1 h2 h3],<span class="string">'XGrid'</span>,<span class="string">'On'</span>,<span class="string">'YGrid'</span>,<span class="string">'On'</span>);
0606 <span class="keyword">end</span>
0607 
0608 <span class="comment">% Output</span>
0609 <span class="keyword">if</span> StructOutputFlag
0610     Dx = d(1);
0611     Dy = d(2);
0612 <span class="keyword">else</span>
0613     Dx = d(1).Data;
0614     Dy = d(2).Data;
0615 <span class="keyword">end</span>
0616 
0617 
0618 <span class="comment">% Archive data structure</span>
0619 <span class="keyword">if</span> ArchiveFlag
0620     <span class="comment">% If the filename contains a directory then make sure it exists</span>
0621     [DirectoryName, FileName, Ext] = fileparts(FileName);
0622     DirStart = pwd;
0623     [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
0624     BPMxDisp = d(1);
0625     BPMyDisp = d(2);
0626     save(FileName, <span class="string">'BPMxDisp'</span>, <span class="string">'BPMyDisp'</span>);
0627     <span class="keyword">if</span> DisplayFlag
0628         fprintf(<span class="string">'   Model dispersion data saved to %s.mat\n'</span>, [DirectoryName FileName]);
0629         <span class="keyword">if</span> ErrorFlag
0630             fprintf(<span class="string">'   Warning: %s was not the desired directory\n'</span>, DirectoryName);
0631         <span class="keyword">end</span>
0632     <span class="keyword">end</span>
0633     cd(DirStart);
0634     FileName = [DirectoryName FileName];
0635 <span class="keyword">end</span>
0636 <span class="keyword">if</span> FileName == -1
0637     FileName = <span class="string">''</span>;
0638 <span class="keyword">end</span>
0639 
0640</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>