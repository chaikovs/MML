<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of orbitcorrectionmethods</title>
  <meta name="keywords" content="orbitcorrectionmethods">
  <meta name="description" content="ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; orbitcorrectionmethods.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>orbitcorrectionmethods
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources

  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS)                 % Get response matrix &amp; compute SVD correction
  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat)           % Compute SVD &amp; correction
  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)  % Compute correction

  OCS.FitRF - Determines which RF freqency method to use
  See setorbit for information on all the different flags.
  
  NOTES
  1. OCS.CM.Data is not changed by this function
     OCS.CM.Delta is the delta correction
  2. Both row and column weighting of the response matrix can be done.
     The default is unity row weights and column weight by the std of each column.

  See also <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>, <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>, <a href="rmdisp.html" class="code" title="function [DeltaRF, BPM, c, DispOrbit] = rmdisp(varargin)">rmdisp</a>, <a href="plotcm.html" class="code" title="function [DeltaRF, HCMEnergyChangeTotal, DeltaL] = plotcm(varargin)">plotcm</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>	GETDISP - Returns the dispersion for a family (from file)</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a>	GETMCF - Returns the momentum compaction factor (MCF) stored in the AD or the model</li><li><a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>	GETRESPMAT - Get response matrix data from a file</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>	ISMEMBEROF - Returns turn if the membership information of a family (cell of strings)</li><li><a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>	MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</li><li><a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>	MEASDISP - Measures the dispersion function</li><li><a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>	PHYSICS2HW - Converts from 'Physics' units to 'Hardware' units</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>	SETORBIT - Orbit correction function</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)</a>
0002 <span class="comment">%ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS)                 % Get response matrix &amp; compute SVD correction</span>
0005 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat)           % Compute SVD &amp; correction</span>
0006 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)  % Compute correction</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%  OCS.FitRF - Determines which RF freqency method to use</span>
0009 <span class="comment">%  See setorbit for information on all the different flags.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%  NOTES</span>
0012 <span class="comment">%  1. OCS.CM.Data is not changed by this function</span>
0013 <span class="comment">%     OCS.CM.Delta is the delta correction</span>
0014 <span class="comment">%  2. Both row and column weighting of the response matrix can be done.</span>
0015 <span class="comment">%     The default is unity row weights and column weight by the std of each column.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  See also setorbit, setorbitbump, rmdisp, plotcm</span>
0018 
0019 <span class="comment">%</span>
0020 <span class="comment">%  Written by Gregory J. Portmann</span>
0021 <span class="comment">%  Addition for Soleil by Laurent S. Nadolski</span>
0022 <span class="comment">%    Constraints on min and max RF frequency variations</span>
0023 
0024 <span class="comment">%  T = V(:,OCS.SVDIndex) * diag(S(OCS.SVDIndex).^(-1)) * U(:,OCS.SVDIndex)';</span>
0025 <span class="comment">%  Delcm = T * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));</span>
0026 <span class="comment">%</span>
0027 
0028 
0029 <span class="comment">% Initialize</span>
0030 FitRFDefault = 0;
0031 
0032 <span class="comment">% Machine dependent</span>
0033 <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'SubMachine'</span>),<span class="string">'Soleil'</span>)
0034     DeltaRFmin = 1e-7;   <span class="comment">% MHz minimum variation allowed by Master oscillator</span>
0035     DeltaRFmax = 100e-6; <span class="comment">% MHz maximum variation allowed in one step</span>
0036 <span class="keyword">end</span>
0037 
0038 
0039 <span class="comment">% Input checking (should add more)</span>
0040 <span class="keyword">if</span> nargin &lt; 2
0041     Smat = [];
0042 <span class="keyword">end</span>
0043 <span class="keyword">if</span> nargin &lt; 3
0044     S = [];
0045     U = [];
0046     V = [];
0047 <span class="keyword">end</span>
0048 
0049 
0050 <span class="comment">% This function expects .BPM and .CM to be cell arrays.</span>
0051 <span class="comment">% This gets put back at the end of the function.</span>
0052 <span class="keyword">if</span> ~iscell(OCS.BPM)
0053     NoCellBPMFlag = 1;
0054     OCS.BPM = {OCS.BPM};
0055     OCS.GoalOrbit = {OCS.GoalOrbit};
0056     <span class="keyword">if</span> isfield(OCS, <span class="string">'BPMWeight'</span>)
0057         OCS.BPMWeight = {OCS.BPMWeight};
0058     <span class="keyword">end</span>
0059 <span class="keyword">else</span>
0060     NoCellBPMFlag = 0;
0061 <span class="keyword">end</span>
0062 <span class="keyword">if</span> ~iscell(OCS.CM)
0063     NoCellCMFlag = 1;
0064     OCS.CM = {OCS.CM};
0065     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
0066         <span class="keyword">if</span> ~iscell(OCS.CMWeight)
0067             OCS.CMWeight = {OCS.CMWeight};
0068         <span class="keyword">end</span>
0069     <span class="keyword">end</span>
0070 <span class="keyword">else</span>
0071     NoCellCMFlag = 0;
0072 <span class="keyword">end</span>
0073 
0074 
0075 <span class="comment">% RF frequency methods in orbit correction</span>
0076 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'FitRF'</span>)
0077     OCS.FitRF = FitRFDefault;
0078 <span class="keyword">end</span>
0079 <span class="keyword">if</span> isempty(OCS.FitRF)
0080     OCS.FitRF = FitRFDefault;
0081 <span class="keyword">end</span>
0082 
0083 
0084 <span class="comment">%%%%%%%%%%%%%%%%</span>
0085 <span class="comment">% The SVD Part %</span>
0086 <span class="comment">%%%%%%%%%%%%%%%%</span>
0087 <span class="keyword">if</span> isempty(U)
0088     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0089     <span class="comment">% Get the response matrix %</span>
0090     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0091     <span class="keyword">if</span> isempty(Smat)
0092         <span class="keyword">for</span> i = 1:length(OCS.BPM)
0093             Srow = [];
0094             <span class="keyword">for</span> j = 1:length(OCS.CM)
0095                 <span class="comment">%if ModelRespFlag == 1</span>
0096                 <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'ModelResp'</span>))
0097                     <span class="comment">% When using measbpmresp('Model')</span>
0098                     <span class="comment">% Rmat(1,1) is always horizontal</span>
0099                     <span class="comment">% Rmat(2,2) is always vertical</span>
0100                     Rmat = <a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>(<span class="string">'model'</span>,OCS.BPM{i},OCS.BPM{i}, OCS.CM{j},OCS.CM{j}, OCS.BPM{i}.Units);
0101                     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>)
0102                         S = Rmat(1,1).Data;
0103                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>)
0104                         S = Rmat(2,1).Data;               
0105                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>)
0106                         S = Rmat(1,2).Data;
0107                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>)
0108                         S = Rmat(2,2).Data;
0109                     <span class="keyword">else</span>
0110                         error(<span class="string">'Problem getting the model response matrix'</span>);
0111                     <span class="keyword">end</span>
0112                 <span class="keyword">else</span>
0113                     <span class="comment">% Get the golden BPM response matrix</span>
0114                     [S, FileName] = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(OCS.BPM{i}, OCS.CM{j}, <span class="string">'Numeric'</span>);
0115                     <span class="keyword">if</span> any(find(isnan(S)))
0116                         error(<span class="string">'Not all BPMs and correctors exist in the response matrix.'</span>);
0117                     <span class="keyword">end</span>
0118                 <span class="keyword">end</span>
0119                 <span class="keyword">if</span> length(OCS.GoalOrbit{i}) ~= size(S,1)
0120                     error(<span class="string">'The goal orbit vector length does not equal the response matrix row length'</span>);
0121                 <span class="keyword">end</span>
0122 
0123                 Srow = [Srow S];
0124             <span class="keyword">end</span>
0125             Smat = [Smat; Srow];
0126         <span class="keyword">end</span>
0127         <span class="comment">%SmatCheck = measbpmresp('Model','Numeric');</span>
0128 
0129 
0130         <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0131         <span class="comment">% Get Dispersion %</span>
0132         <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0133         Eta = [];
0134         <span class="keyword">if</span> OCS.FitRF
0135             <span class="keyword">for</span> i = 1:length(OCS.BPM)
0136                 <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'ModelDisp'</span>))
0137                     <span class="comment">%if strcmpi(DispFlag,'ModelDisp')</span>
0138                     DispOrbit = <a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>, <span class="string">'Model'</span>);
0139                 <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'MeasDisp'</span>))
0140                     <span class="comment">%elseif strcmpi(DispFlag,'MeasDisp')</span>
0141                     DispOrbit = <a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>);
0142                 <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'GoldenDisp'</span>))
0143                     <span class="comment">%elseif strcmpi(DispFlag,'GoldenDisp')</span>
0144                     DispOrbit = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>);
0145                 <span class="keyword">end</span>
0146                 
0147                 <span class="keyword">if</span> strcmpi(OCS.BPM{i}.Units, <span class="string">'Physics'</span>)
0148                     <span class="comment">% Put the RF change in physics units, not energy change</span>
0149                     RFhw = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(OCS.RF);
0150                     DispOrbit = DispOrbit / (OCS.RF.Data / RFhw.Data);
0151                 <span class="keyword">end</span>
0152                 
0153                 <span class="keyword">if</span> isempty(DispOrbit)
0154                     error(<span class="string">'Did not find or generate dispersion orbit properly'</span>);
0155                 <span class="keyword">end</span>
0156                 <span class="keyword">if</span> any(isnan(DispOrbit))
0157                     error(<span class="string">'The dispersion data has at least one NaN.'</span>);
0158                 <span class="keyword">end</span>
0159                 
0160                 Eta = [Eta; DispOrbit];
0161             <span class="keyword">end</span>
0162         <span class="keyword">end</span>
0163         OCS.Eta = Eta;
0164     <span class="keyword">end</span>
0165 <span class="keyword">end</span>
0166 
0167 
0168 <span class="comment">% Save a weight free response matrix</span>
0169 SmatNoWeights = Smat;
0170 
0171 
0172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0173 <span class="comment">% Build the orbit vectors %</span>
0174 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0175 StartOrbitVec = [];
0176 GoalOrbitVec = [];
0177 BPMWeight = [];
0178 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0179     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data(:)];
0180     GoalOrbitVec  = [GoalOrbitVec; OCS.GoalOrbit{i}(:)];
0181 
0182     <span class="keyword">if</span> ~isfield(OCS, <span class="string">'BPMWeight'</span>) || isempty(OCS.BPMWeight{i})
0183         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];
0184     <span class="keyword">elseif</span> isscalar(OCS.BPMWeight{i})
0185         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1) * OCS.BPMWeight{i}];
0186     <span class="keyword">else</span>
0187         BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];
0188     <span class="keyword">end</span>
0189 <span class="keyword">end</span>
0190 
0191 
0192 <span class="comment">% Build column weight vector</span>
0193 CMWeight = [];
0194 <span class="keyword">for</span> i = 1:length(OCS.CM)
0195     <span class="keyword">if</span> ~isfield(OCS, <span class="string">'CMWeight'</span>) || isempty(OCS.CMWeight{i})
0196         <span class="comment">% When using all singular values this does not do anything</span>
0197         <span class="comment">% The amp to radian conversion is probably a better normalizer</span>
0198         <span class="comment">%CMWeight = 1 ./ sqrt(sum(Smat.^2));</span>
0199         CMWeight = 1./std(Smat)';
0200 
0201         <span class="comment">% No weight</span>
0202         <span class="comment">%CMWeight = ones(size(Smat,2),1);</span>
0203 
0204         <span class="keyword">break</span>;
0205         <span class="comment">%CMWeight = [CMWeight; ones(length(OCS.CM{i}.Data),1)];</span>
0206 
0207     <span class="keyword">elseif</span> isscalar(OCS.CMWeight{i})
0208         CMWeight = [CMWeight; ones(length(OCS.CM{i}.Data),1) * OCS.CMWeight{i}];
0209 
0210     <span class="keyword">else</span>
0211         CMWeight = [CMWeight; OCS.CMWeight{i}(:)];
0212     <span class="keyword">end</span>
0213 <span class="keyword">end</span>
0214 
0215 
0216 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0217 <span class="comment">% Add a column weight to the response matrix %</span>
0218 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0219 <span class="comment">%if isempty(U)</span>
0220     <span class="keyword">for</span> j = 1:length(CMWeight)
0221         Smat(:,j) = Smat(:,j) * CMWeight(j);
0222     <span class="keyword">end</span>
0223 <span class="comment">%end</span>
0224 
0225 
0226 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0227 <span class="comment">% Add a weighted disperion as a column of the response matrix %</span>
0228 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0229 <span class="keyword">if</span> OCS.FitRF == 0
0230     <span class="comment">% Don't fit the RF frequency</span>
0231     OCS.DeltaRF = 0;
0232 <span class="keyword">elseif</span> any(OCS.FitRF == [1 2 3 4 5])
0233     <span class="comment">% Column weighting (changing the units or sensitivity) seems to be a good thing.</span>
0234     <span class="comment">% (At least at the ALS working in hardware units.)</span>
0235     <span class="comment">% Weight by more than the average std of Smat also seems to give good results but</span>
0236     <span class="comment">% I'm not sure it's necessary or should be done.</span>
0237     RFWeight = 10 * mean(std(Smat)) / std(OCS.Eta);
0238     Smat = [Smat RFWeight*OCS.Eta];
0239 <span class="keyword">else</span>
0240     error(<span class="string">'Unknown RF correction method.'</span>);
0241 <span class="keyword">end</span>
0242 
0243 
0244 
0245 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0246 <span class="comment">% Add a row weight to the response matrix %</span>
0247 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0248 <span class="comment">% Weighted LS</span>
0249 <span class="comment">% Weighted LS was developed for heteroscedastic errors but it's used here for other reasons</span>
0250 <span class="comment">% W*(Mmeas - Mmodel) = W*A*b + W*e,  where the e's are gausian, zero mean, independent, but not constant variance</span>
0251 <span class="comment">% W is chosen to make E(Wee'W') = sigma * I  (ie, W * e has a constant variance)</span>
0252 <span class="comment">%</span>
0253 <span class="comment">% The new LS equations are,</span>
0254 <span class="comment">% b = inv(Amod'*W' * W*Amod) * Amod'*W' * W*(Xgoal - Xmeasured);      % Parameter fit</span>
0255 <span class="comment">% b = V(:,Ivec) * b;</span>
0256 <span class="comment">% bvar = inv(Amod'*W'*W*Amod);</span>
0257 <span class="comment">%</span>
0258 <span class="comment">% Since the weight matrix, W, is only going to be diagonal, it is less memory</span>
0259 <span class="comment">% to scaled Amod and (Mmeas-Model) by the diagonal term and not create the matrix W</span>
0260 <span class="keyword">if</span> ~all(BPMWeight == 1)
0261     <span class="keyword">for</span> i = 1:size(Smat,1)
0262         Smat(i,:) = BPMWeight(i) * Smat(i,:);
0263     <span class="keyword">end</span>
0264 <span class="keyword">end</span>
0265 
0266 
0267 <span class="comment">%%%%%%%%%%%%%%%%</span>
0268 <span class="comment">% The SVD Part %</span>
0269 <span class="comment">%%%%%%%%%%%%%%%%</span>
0270 <span class="keyword">if</span> isempty(U)
0271     <span class="keyword">if</span> any(any(isnan(Smat)))
0272         error(<span class="string">'The response matrix has at least one NaN.'</span>);
0273     <span class="keyword">end</span>
0274 
0275     <span class="comment">% Do the SVD</span>
0276     [U, S, V] = svd(Smat, 0);  <span class="comment">%'econ');</span>
0277     S = diag(S);
0278 <span class="keyword">end</span>
0279 
0280 
0281 <span class="comment">% Determine the singular vector and error check</span>
0282 <span class="keyword">if</span> isnumeric(OCS.SVDIndex)
0283     <span class="keyword">if</span> length(OCS.SVDIndex) == 1
0284         <span class="keyword">if</span> rem(OCS.SVDIndex,1) == 0
0285             OCS.SVDIndex = 1:OCS.SVDIndex;
0286         <span class="keyword">else</span>
0287             <span class="comment">% Use threshold</span>
0288             Ivec = find(S &gt; max(S)*OCS.SVDIndex);
0289             OCS.SVDIndex = Ivec;
0290         <span class="keyword">end</span>
0291     <span class="keyword">end</span>
0292 <span class="keyword">elseif</span> ischar(OCS.SVDIndex)
0293     <span class="keyword">if</span> strcmpi(OCS.SVDIndex, <span class="string">'All'</span>)
0294         OCS.SVDIndex = 1:length(S);
0295     <span class="keyword">else</span>
0296         error(<span class="string">'OCS.SVDIndex unknown'</span>);
0297     <span class="keyword">end</span>
0298 <span class="keyword">else</span>
0299     error(<span class="string">'OCS.SVDIndex unknown'</span>);
0300 <span class="keyword">end</span>
0301 
0302 <span class="comment">% Nothing greater then the total number is singular values</span>
0303 i = find(OCS.SVDIndex &gt; length(S));
0304 <span class="keyword">if</span> ~isempty(i)
0305     warning(<span class="string">'Requested number of singular values is greater than the total.  Removing %d values.'</span>,length(i));
0306     OCS.SVDIndex(i) = length(S);
0307 <span class="keyword">end</span>
0308 
0309 <span class="comment">% No non-integers</span>
0310 OCS.SVDIndex = round(OCS.SVDIndex);
0311 
0312 <span class="comment">% Nothing less than zero</span>
0313 i = find(OCS.SVDIndex &lt;= 0);
0314 OCS.SVDIndex(i) = length(S);
0315 
0316 <span class="comment">% No repeats</span>
0317 OCS.SVDIndex = sort(OCS.SVDIndex);
0318 i = find(diff(OCS.SVDIndex)==0);
0319 OCS.SVDIndex(i) = [];
0320 
0321 <span class="keyword">if</span> isempty(OCS.SVDIndex)
0322     error(<span class="string">'Singular values vector is empty'</span>);
0323 <span class="keyword">end</span>
0324 
0325 
0326 <span class="keyword">if</span> OCS.FitRF == 2 || OCS.FitRF == 3
0327     <span class="comment">% Constrained L.S. with SVD</span>
0328     <span class="comment">% Constraint: Sum of the energy change to zero</span>
0329     <span class="comment">% Note: Model required</span>
0330     
0331     R = [];
0332     HCMEnergyChangeTotal = 0;
0333     <span class="keyword">for</span> i = 1:length(OCS.CM)
0334         <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{i}.FamilyName, <span class="string">'HCM'</span>)
0335             L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
0336 
0337             <span class="keyword">if</span> ~isfield(OCS.CM{i}, <span class="string">'Dispersion'</span>)
0338                 <span class="comment">% Dispersion at the correctors in physics units</span>
0339                 [OCS.CM{i}.Dispersion, DyHCM] = modeldisp([], OCS.CM{i}.FamilyName, OCS.CM{i}.DeviceList, <span class="string">'Numeric'</span>, <span class="string">'Physics'</span>);
0340             <span class="keyword">end</span>
0341             
0342             <span class="comment">% Present corrector setpoint in physics units</span>
0343             HCM = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i});
0344 
0345             
0346             <span class="comment">% Move ALS specific code to setorbitdefault ???</span>
0347             <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),<span class="string">'ALS'</span>)
0348                 <span class="comment">% For the ALS, either the HCMCHICANE families need to be included or</span>
0349                 <span class="comment">% the chicane &quot;part&quot; of the HCMs needs to be removed.  This will remove the chicane.</span>
0350                 Energy = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Energy'</span>);
0351 
0352                 <span class="comment">% Sector 6</span>
0353                 <span class="comment">%                   Off    1.9 GeV   1.5 GeV</span>
0354                 <span class="comment">% HCMCHICANEM(6,1)  80.0    18.0       ?</span>
0355                 <span class="comment">% HCMCHICANEM(6,1)  80.0    20.0       ?</span>
0356                 <span class="comment">% HCM(6,1)           0.0    18.8       ?</span>
0357                 ihcm = findrowindex([6 1], OCS.CM{i}.DeviceList);
0358                 <span class="keyword">if</span> length(ihcm) == 1
0359                     <span class="keyword">try</span>
0360                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[6 1]) &lt; 70
0361                             <span class="comment">% Assume sector 6 chicane is on</span>
0362                             <span class="keyword">if</span> Energy == 1.9
0363                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, -18.8, [6 1]);
0364                             <span class="keyword">else</span>
0365                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field,  -18.8*1.5/1.9, [6 1]);
0366                             <span class="keyword">end</span>
0367                         <span class="keyword">end</span>
0368                     <span class="keyword">catch</span>
0369                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0370                         fprintf(<span class="string">'Problem reading HCMCHICANEM(6,1).  The chicane &quot;offset&quot; on HCM(6,1) will not be removed.\n\n'</span>);
0371                     <span class="keyword">end</span>
0372                 <span class="keyword">end</span>
0373 
0374                 <span class="comment">% Sector 11</span>
0375                 <span class="comment">%                    Off    1.9 GeV   1.5 GeV</span>
0376                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0377                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0378                 <span class="comment">% HCM(10,8)           0.0   -17.0     -14.0</span>
0379                 <span class="comment">% HCM(11,1)           0.0   -17.0     -14.0</span>
0380                 ihcm = findrowindex([10 8], OCS.CM{i}.DeviceList);
0381                 <span class="keyword">if</span> length(ihcm) == 1
0382                     <span class="keyword">try</span>
0383                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0384                             <span class="comment">% Assume sector 11 chicane is on</span>
0385                             <span class="keyword">if</span> Energy == 1.9
0386                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [17; 17], [10 8;11 1]);
0387                             <span class="keyword">else</span>
0388                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [14; 14], [10 8;11 1]);
0389                             <span class="keyword">end</span>
0390                         <span class="keyword">end</span>
0391                     <span class="keyword">catch</span>
0392                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0393                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(10,8) will not be removed.n\n'</span>);
0394                     <span class="keyword">end</span>
0395                 <span class="keyword">end</span>
0396                 ihcm = findrowindex([11 1], OCS.CM{i}.DeviceList);
0397                 <span class="keyword">if</span> length(ihcm) == 1
0398                     <span class="keyword">try</span>
0399                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0400                             <span class="comment">% Assume sector 11 chicane is on</span>
0401                             <span class="keyword">if</span> Energy == 1.9
0402                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [17; 17], [10 8;11 1]);
0403                             <span class="keyword">else</span>
0404                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [14; 14], [10 8;11 1]);
0405                             <span class="keyword">end</span>
0406                         <span class="keyword">end</span>
0407                     <span class="keyword">catch</span>
0408                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0409                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(11,1) will not be removed.n\n'</span>);
0410                     <span class="keyword">end</span>
0411                 <span class="keyword">end</span>
0412             <span class="keyword">end</span>
0413             <span class="comment">% END ALS only</span>
0414             
0415             
0416             <span class="comment">% Energy change to remove</span>
0417             HCMEnergyChangeTotal = HCMEnergyChangeTotal + sum(-1 * HCM.Data .* OCS.CM{i}.Dispersion / <a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a> / L);
0418             
0419             <span class="comment">% Energy scaling must be in physics units, hence the (HCM.Data./OCS.CM{i}.Data)</span>
0420             <span class="keyword">if</span> strcmpi(OCS.CM{i}.Units, <span class="string">'Hardware'</span>)
0421                 <span class="comment">% PhysicsUnitsScaling = (HCM.Data./OCS.CM{i}.Data);  %This does not work for zero setpoints</span>
0422                 PhysicsUnitsScaling = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}. FamilyName,OCS.CM{i}.Field, 1, OCS.CM{i}.DeviceList); 
0423             <span class="keyword">else</span>
0424                 PhysicsUnitsScaling = 1;
0425             <span class="keyword">end</span>
0426             HCMEnergyChangeScalar = -1 * PhysicsUnitsScaling .* OCS.CM{i}.Dispersion / <a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a> / L;
0427             R = [R HCMEnergyChangeScalar(:)'];
0428             
0429             <span class="comment">% Sum of correctors to zero</span>
0430             <span class="comment">%R = [R ones(size(HCMEnergyChange(:)'))];</span>
0431         <span class="keyword">else</span>
0432             R = [R zeros(1,size(OCS.CM{i}.DeviceList,1))];
0433         <span class="keyword">end</span>
0434     <span class="keyword">end</span>
0435     
0436     <span class="keyword">if</span> OCS.FitRF == 2
0437         <span class="comment">% Also remove the energy change due to the present corrector setpoints</span>
0438         r = -HCMEnergyChangeTotal/2;    <span class="comment">% Not sure about the divide by 2</span>
0439     <span class="keyword">elseif</span> OCS.FitRF == 3
0440         <span class="comment">% Only remove energy change due to the incremental change in the correctors</span>
0441         r = 0;
0442     <span class="keyword">end</span>
0443     
0444     <span class="comment">% Add a zero for no constaint on the RF</span>
0445     R = [R 0];
0446     
0447 
0448     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0449     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0450     X = Smat * V(:,OCS.SVDIndex);
0451     R = R * V(:,OCS.SVDIndex);
0452     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0453     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0454     Delcm = V(:,OCS.SVDIndex) * br;
0455 
0456 <span class="keyword">elseif</span> OCS.FitRF == 4
0457     <span class="comment">% Constrained L.S. with SVD</span>
0458     <span class="comment">% Constraint: dot(DispersionX,   Smat * dHCM) = 0</span>
0459     <span class="comment">%         or  dot(DispersionX' * Smat,  dHCM) = 0 or total dot(DisperionX, Smat * HCM)</span>
0460     R = [];
0461     DispDotSmatHCM = 0;
0462     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0463         <span class="keyword">if</span> strcmpi(OCS.BPM{i}.FamilyName, <span class="string">'BPMx'</span>) || <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <span class="string">'BPMx'</span>)
0464             <span class="keyword">if</span> ~isfield(OCS.BPM{i}, <span class="string">'Dispersion'</span>)
0465                 <span class="comment">% Dispersion at the correctors in physics units</span>
0466                 [OCS.BPM{i}.Dispersion, Dy] = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}.FamilyName, OCS.BPM{i}.DeviceList, <span class="string">'Numeric'</span>,  OCS.BPM{i}.Units);
0467             <span class="keyword">end</span>
0468             R = [R OCS.BPM{i}.Dispersion(:)'];
0469             
0470             HCM = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(OCS.CM{i});
0471 
0472             
0473             <span class="comment">% Move ALS specific code to setorbitdefault ???</span>
0474             <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),<span class="string">'ALS'</span>)
0475                 <span class="comment">% For the ALS, either the HCMCHICANE families need to be included or</span>
0476                 <span class="comment">% the chicane &quot;part&quot; of the HCMs needs to be removed.  This will remove the chicane.</span>
0477                 Energy = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Energy'</span>);
0478 
0479                 <span class="comment">% Sector 6</span>
0480                 <span class="comment">%                   Off    1.9 GeV   1.5 GeV</span>
0481                 <span class="comment">% HCMCHICANEM(6,1)  80.0    18.0       ?</span>
0482                 <span class="comment">% HCMCHICANEM(6,1)  80.0    20.0       ?</span>
0483                 <span class="comment">% HCM(6,1)           0.0    18.8       ?</span>
0484                 ihcm = findrowindex([6 1], OCS.CM{i}.DeviceList);
0485                 <span class="keyword">if</span> length(ihcm) == 1
0486                     <span class="keyword">try</span>
0487                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[6 1]) &lt; 70
0488                             <span class="comment">% Assume sector 6 chicane is on</span>
0489                             <span class="keyword">if</span> Energy == 1.9
0490                                 HCM.Data(ihcm) = HCM.Data(ihcm) - 18.8;
0491                             <span class="keyword">else</span>
0492                                 HCM.Data(ihcm) = HCM.Data(ihcm) - 18.8*1.5/1.9;
0493                             <span class="keyword">end</span>
0494                         <span class="keyword">end</span>
0495                     <span class="keyword">catch</span>
0496                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0497                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(6,1) will not be removed.\n\n'</span>);
0498                     <span class="keyword">end</span>
0499                 <span class="keyword">end</span>
0500 
0501                 <span class="comment">% Sector 11</span>
0502                 <span class="comment">%                    Off    1.9 GeV   1.5 GeV</span>
0503                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0504                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0505                 <span class="comment">% HCM(10,8)           0.0   -17.0     -14.0</span>
0506                 <span class="comment">% HCM(11,1)           0.0   -17.0     -14.0</span>
0507                 ihcm = findrowindex([10 8], OCS.CM{i}.DeviceList);
0508                 <span class="keyword">if</span> length(ihcm) == 1
0509                     <span class="keyword">try</span>
0510                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0511                             <span class="comment">% Assume sector 11 chicane is on</span>
0512                             <span class="keyword">if</span> Energy == 1.9
0513                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 17;
0514                             <span class="keyword">else</span>
0515                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 14;
0516                             <span class="keyword">end</span>
0517                         <span class="keyword">end</span>
0518                     <span class="keyword">catch</span>
0519                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0520                         fprintf(<span class="string">'Problem reading HCMCHICANEM(11,1).  The chicane &quot;offset&quot; on HCM(10,8) will not be removed.n\n'</span>);
0521                     <span class="keyword">end</span>
0522                 <span class="keyword">end</span>
0523                 ihcm = findrowindex([11 1], OCS.CM{i}.DeviceList);
0524                 <span class="keyword">if</span> length(ihcm) == 1
0525                     <span class="keyword">try</span>
0526                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0527                             <span class="comment">% Assume sector 11 chicane is on</span>
0528                             <span class="keyword">if</span> Energy == 1.9
0529                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 17;
0530                             <span class="keyword">else</span>
0531                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 14;
0532                             <span class="keyword">end</span>
0533                         <span class="keyword">end</span>
0534                     <span class="keyword">catch</span>
0535                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0536                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(11,1) will not be removed.n\n'</span>);
0537                     <span class="keyword">end</span>
0538                 <span class="keyword">end</span>
0539             <span class="keyword">end</span>
0540             <span class="comment">% END ALS only</span>
0541 
0542 
0543             <span class="comment">% Assumes 1 HCM family and it's first???</span>
0544             DispDotSmatHCM = DispDotSmatHCM + OCS.BPM{i}.Dispersion'*Smat(1:size(OCS.BPM{i}.DeviceList,1),1:1:size(OCS.CM{i}.DeviceList,1))*HCM.Data;
0545         <span class="keyword">else</span>
0546             R = [R zeros(1,size(OCS.BPM{i}.DeviceList,1))];
0547         <span class="keyword">end</span>
0548     <span class="keyword">end</span>
0549     <span class="comment">% [OCS.BPM{1}.Dispersion, Dy] = getdisp(OCS.BPM{1}.FamilyName, OCS.BPM{1}.DeviceList, 'Numeric', OCS.BPM{1}.Units);</span>
0550     <span class="comment">% RR = [OCS.BPM{1}.Dispersion(:); zeros(size(OCS.BPM{2}.DeviceList,1),1)]';</span>
0551 
0552     <span class="comment">%r = 0;</span>
0553     r = -1*DispDotSmatHCM;  <span class="comment">% Not sure if this should be divided by 2</span>
0554     R = [R*Smat(:,1:end-1) 0];
0555 
0556 
0557     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0558     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0559     X = Smat * V(:,OCS.SVDIndex);
0560     R = R * V(:,OCS.SVDIndex);
0561     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0562     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0563     Delcm = V(:,OCS.SVDIndex) * br;
0564     
0565     <span class="comment">%DelcmNoR = V(:,OCS.SVDIndex) * b;</span>
0566     <span class="comment">%fprintf('   dRF=%g  dRF(NoR)=%g\n',  RFWeight * Delcm(end),  RFWeight * DelcmNoR(end));</span>
0567     
0568 <span class="keyword">elseif</span> OCS.FitRF == 5
0569     <span class="comment">% Constrained L.S. with SVD</span>
0570     <span class="comment">% Constraint: dot(HCM(Dispersion), dHCM) = 0</span>
0571     R = [];
0572     <span class="keyword">for</span> i = 1:length(OCS.CM)
0573         <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{i}.FamilyName, <span class="string">'HCM'</span>)
0574             <span class="comment">% Assume CM{i} is the same plane as BPM{i}</span>
0575             <span class="keyword">if</span> ~isfield(OCS.BPM{i}, <span class="string">'Dispersion'</span>)
0576                 <span class="comment">% Dispersion at the horizontal BPMs</span>
0577                 [OCS.BPM{i}.Dispersion, Dy] = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}.FamilyName, OCS.BPM{i}.DeviceList, <span class="string">'Numeric'</span>,  OCS.BPM{i}.Units);
0578 
0579                 <span class="comment">% Find the corrector pattern of the dispersion orbit</span>
0580                 <span class="comment">%</span>
0581                 <span class="comment">% OCS.SVDIndex ????</span>
0582                 <span class="comment">% Smat???  make an array</span>
0583                 <span class="comment">% Why is Rhcm so different from Rbpmx?</span>
0584                 
0585                 <span class="comment">% Assumes 1 HCM family and it's first???</span>
0586                 SmatNoEta = Smat(1:size(OCS.BPM{i}.DeviceList,1),1:size(OCS.CM{i}.DeviceList,1));
0587                 [UU, SS, VV] = svd(SmatNoEta, <span class="string">'econ'</span>);
0588                 SS = diag(SS);
0589 
0590                 X = SmatNoEta * VV(:,OCS.SVDIndex);
0591                 b = inv(X'*X)*X' * OCS.BPM{i}.Dispersion;
0592                 OCS.BPM{i}.DispersionCorrectors = VV(:,OCS.SVDIndex) * b;
0593             <span class="keyword">end</span>
0594             R = [R OCS.BPM{i}.DispersionCorrectors(:)'];
0595         <span class="keyword">else</span>
0596             R = [R zeros(1,size(OCS.CM{i}.DeviceList,1))];
0597         <span class="keyword">end</span>
0598     <span class="keyword">end</span>
0599 
0600     r = 0;  <span class="comment">% Should it be an absolute conditional ???</span>
0601     R = [R 0];
0602 
0603 
0604     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0605     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0606     X = Smat * V(:,OCS.SVDIndex);
0607     R = R * V(:,OCS.SVDIndex);
0608     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0609     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0610     Delcm = V(:,OCS.SVDIndex) * br;
0611     
0612     <span class="comment">%DelcmNoR = V(:,OCS.SVDIndex) * b;</span>
0613     <span class="comment">%fprintf('   dRF=%g  dRF(NoR)=%g\n',  RFWeight * Delcm(end),  RFWeight * DelcmNoR(end));</span>
0614 
0615 <span class="keyword">else</span>
0616 
0617     <span class="comment">% L.S. with SVD algorithm</span>
0618     <span class="comment">% The V matrix columns are the singular vectors in the corrector magnet space</span>
0619     <span class="comment">% The U matrix columns are the singular vectors in the BPM space</span>
0620     <span class="comment">% Smat = U*S*V' where U'*U=I and V*V'=I</span>
0621     <span class="comment">%</span>
0622     <span class="comment">% b is the coef. of the projection onto the columns of Smat*V(:,Ivec) - the corrector space (same space as spanned by U)</span>
0623     <span class="comment">% Sometimes it's interesting to look at the size of these coefficients with singular value number.</span>
0624     b = U(:,OCS.SVDIndex)' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0625     b = diag(S(OCS.SVDIndex).^(-1)) * b;
0626 
0627     <span class="comment">% Convert the b vector back to coefficents of response matrix</span>
0628     Delcm = V(:,OCS.SVDIndex) * b;
0629 <span class="keyword">end</span>
0630 
0631 
0632 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0633 <span class="comment">% Remove Weights for the Correction %</span>
0634 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0635 <span class="comment">% Separate the RF from the correctors</span>
0636 <span class="keyword">if</span> OCS.FitRF
0637     <span class="comment">% RF frequency is the last actuator</span>
0638     OCS.DeltaRF = RFWeight * Delcm(end);
0639     <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'SubMachine'</span>), <span class="string">'Soleil'</span>)
0640         <span class="comment">% Begin Add by Laurent % To be done with variables</span>
0641         <span class="comment">% test for avoiding to move too often RF frequency</span>
0642         <span class="comment">%fprintf('Prog %e \n',DelRF);</span>
0643         <span class="keyword">if</span> abs(OCS.DeltaRF) &lt; DeltaRFmin <span class="comment">% minimum RF is .1 Hz</span>
0644             OCS.DeltaRF = 0;
0645         <span class="keyword">end</span>
0646         <span class="keyword">if</span> abs(OCS.DeltaRF) &gt; DeltaRFmax <span class="comment">% maximum is 100 Hz</span>
0647             error(<span class="string">'RF change too large DeltaRF = %f Hz (&gt; %f Hz) \nRF frequency shift has to be fixed first by hand.\nSee expert steprf command'</span>, <span class="keyword">...</span>
0648                 <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(<span class="string">'RF'</span>,<span class="string">'Setpoint'</span>,OCS.DeltaRF), <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(<span class="string">'RF'</span>,<span class="string">'Setpoint'</span>,DeltaRFmax));
0649         <span class="keyword">end</span>
0650     <span class="keyword">end</span>
0651     Delcm = Delcm(1:end-1);
0652 <span class="keyword">end</span>
0653 
0654 <span class="comment">% Remove column weights from Delcm</span>
0655 Delcm = Delcm .* CMWeight;
0656     
0657     
0658 <span class="comment">% Predict Orbit</span>
0659 <span class="keyword">if</span> OCS.FitRF
0660     OrbitDeltaTotal = [SmatNoWeights OCS.Eta] * [Delcm; OCS.DeltaRF];
0661 <span class="keyword">else</span>
0662     OrbitDeltaTotal = SmatNoWeights * Delcm;
0663 <span class="keyword">end</span>
0664 <span class="keyword">for</span> j = 1:length(OCS.BPM)
0665     N = length(OCS.BPM{j}.Data);
0666     OCS.BPM{j}.PredictedOrbitDelta = OrbitDeltaTotal(1:N);
0667     OrbitDeltaTotal(1:N) = [];
0668 <span class="keyword">end</span>
0669 
0670 
0671 <span class="comment">% Don't put the Delcm into OCS.CM so this function can get</span>
0672 <span class="comment">% called multiple times before actually correcting the orbit</span>
0673 <span class="keyword">for</span> i = 1:length(OCS.CM)
0674     N = length(OCS.CM{i}.Data);
0675     <span class="comment">%OCS.CM{i}.Data = OCS.CM{i}.Data + Delcm(1:N);</span>
0676     OCS.CM{i}.Delta = Delcm(1:N);
0677     Delcm(1:N) = [];
0678 
0679     OCS.CMWeight{i} = CMWeight(1:N);
0680     CMWeight(1:N) = [];
0681 <span class="keyword">end</span>
0682 
0683 
0684 <span class="comment">% Remove the cell array if the length is one</span>
0685 <span class="keyword">if</span> NoCellBPMFlag
0686     OCS.BPM = OCS.BPM{1};
0687     OCS.GoalOrbit = OCS.GoalOrbit{1};
0688     OCS.BPMWeight = OCS.BPMWeight{1};
0689 <span class="keyword">end</span>
0690 <span class="keyword">if</span> NoCellCMFlag
0691     OCS.CM = OCS.CM{1};
0692     OCS.CMWeight = OCS.CMWeight{1};
0693 <span class="keyword">end</span>
0694 
0695 
0696 <span class="comment">% Output statistics???</span>
0697 <span class="comment">% 1. Correctable orbit</span>
0698 <span class="comment">% 2. Not correctable orbit</span>
0699 <span class="comment">% 3. Error propagation</span>
0700 
0701</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>