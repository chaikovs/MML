<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of measlifetime</title>
  <meta name="keywords" content="measlifetime">
  <meta name="description" content="MEASLIFETIME - Measures the lifetime using an exponential or linear least squares fit to beam current">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; measlifetime.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>measlifetime
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>MEASLIFETIME - Measures the lifetime using an exponential or linear least squares fit to beam current</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [Tau, I0, t, DCCT, chi2n] = measlifetime(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">MEASLIFETIME - Measures the lifetime using an exponential or linear least squares fit to beam current
  [Tau, I0, t, DCCT] = measlifetime(t, DCCT)
  [Tau, I0, t, DCCT] = measlifetime(t)
  [Tau, I0, t, DCCT] = measlifetime

  INPUTS #1 - t is a vector or positive scalar
  1. t    = a.  If vector, time [seconds] (vector input)
            b.  If scalar and t &gt; 0, length of time in seconds to measure current
                Default sample period is .5 seconds.
  2. DCCT = current vector [mAmps]
            if the DCCT vector is empty then this function will
            get the current using getdcct at the times defined in t
  3. Method - 'Exponential' for exponential least square fit
            - 'Linear' for linear least square fit 

     or

  [Tau, I0, t, DCCT] = measlifetime(DCCT_Drop, Tmax, Tmin, Nmin)

  INPUTS #2 - &quot;t&quot; is negative
  1. DCCT_Drop - If DCCT_Drop is scalar and DCCT_Drop &lt;= 0, then the beam current will be
                 monitored until the current is DCCT_Drop.  Default sample period is .5 seconds.
                 Default:  Monitor the beam current until current drops 60 uA
                           (At Spear sigma(DCCT) = 0.001 mA)
  2. Tmax - Maximum time to measure DCCT {Default: inf}
  3. Tmin - Minimum time to measure DCCT {Default: 0}
  4. Nmin - Minimum number of unique data points when monitoring DCCT drop {Default: 6}
  
     The goal is to measure the current until a current drop of DCCT_Drop is achived.  However, the
     time that takes will never goes above Tmax.  And if DCCT_Drop is achived then the measurement will
     continue until Tmin or Nmin points is achieved (but not exceeding Tmax).


  OUTPUTS
  DCCTfit = I0 * exp(-t/Tau); Exponential
  DCCTfit = I0 * (1-t/Tau);   Linear
  1. Tau  - Computed lifetime   [hours]
  2. I0   - Computed            [mAmps]
  3. DCCT - Beam current vector [mAmps]
  4. t    - Actual time         [Seconds]
  5. chi2n - normalized chi2


  NOTES
  1. If no output exists, the beam current and fit will be plotted to the screen
     as well as the residual of the DCCT.
  2. DCCT is assumed to be in mAmps</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Tau, I0, t, DCCT, chi2n] = measlifetime(varargin) </a>
0002 <span class="comment">%MEASLIFETIME - Measures the lifetime using an exponential or linear least squares fit to beam current</span>
0003 <span class="comment">%  [Tau, I0, t, DCCT] = measlifetime(t, DCCT)</span>
0004 <span class="comment">%  [Tau, I0, t, DCCT] = measlifetime(t)</span>
0005 <span class="comment">%  [Tau, I0, t, DCCT] = measlifetime</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  INPUTS #1 - t is a vector or positive scalar</span>
0008 <span class="comment">%  1. t    = a.  If vector, time [seconds] (vector input)</span>
0009 <span class="comment">%            b.  If scalar and t &gt; 0, length of time in seconds to measure current</span>
0010 <span class="comment">%                Default sample period is .5 seconds.</span>
0011 <span class="comment">%  2. DCCT = current vector [mAmps]</span>
0012 <span class="comment">%            if the DCCT vector is empty then this function will</span>
0013 <span class="comment">%            get the current using getdcct at the times defined in t</span>
0014 <span class="comment">%  3. Method - 'Exponential' for exponential least square fit</span>
0015 <span class="comment">%            - 'Linear' for linear least square fit</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%     or</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%  [Tau, I0, t, DCCT] = measlifetime(DCCT_Drop, Tmax, Tmin, Nmin)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%  INPUTS #2 - &quot;t&quot; is negative</span>
0022 <span class="comment">%  1. DCCT_Drop - If DCCT_Drop is scalar and DCCT_Drop &lt;= 0, then the beam current will be</span>
0023 <span class="comment">%                 monitored until the current is DCCT_Drop.  Default sample period is .5 seconds.</span>
0024 <span class="comment">%                 Default:  Monitor the beam current until current drops 60 uA</span>
0025 <span class="comment">%                           (At Spear sigma(DCCT) = 0.001 mA)</span>
0026 <span class="comment">%  2. Tmax - Maximum time to measure DCCT {Default: inf}</span>
0027 <span class="comment">%  3. Tmin - Minimum time to measure DCCT {Default: 0}</span>
0028 <span class="comment">%  4. Nmin - Minimum number of unique data points when monitoring DCCT drop {Default: 6}</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%     The goal is to measure the current until a current drop of DCCT_Drop is achived.  However, the</span>
0031 <span class="comment">%     time that takes will never goes above Tmax.  And if DCCT_Drop is achived then the measurement will</span>
0032 <span class="comment">%     continue until Tmin or Nmin points is achieved (but not exceeding Tmax).</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%  OUTPUTS</span>
0036 <span class="comment">%  DCCTfit = I0 * exp(-t/Tau); Exponential</span>
0037 <span class="comment">%  DCCTfit = I0 * (1-t/Tau);   Linear</span>
0038 <span class="comment">%  1. Tau  - Computed lifetime   [hours]</span>
0039 <span class="comment">%  2. I0   - Computed            [mAmps]</span>
0040 <span class="comment">%  3. DCCT - Beam current vector [mAmps]</span>
0041 <span class="comment">%  4. t    - Actual time         [Seconds]</span>
0042 <span class="comment">%  5. chi2n - normalized chi2</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%  NOTES</span>
0046 <span class="comment">%  1. If no output exists, the beam current and fit will be plotted to the screen</span>
0047 <span class="comment">%     as well as the residual of the DCCT.</span>
0048 <span class="comment">%  2. DCCT is assumed to be in mAmps</span>
0049 
0050 <span class="comment">%</span>
0051 <span class="comment">%  Written by Gregory S. Portmann</span>
0052 <span class="comment">%  Modified by Amor Nadji, May 2005</span>
0053 <span class="comment">%  Adapted by Laurent S. Nadolski, 23/01/06</span>
0054 <span class="comment">%  Added covariance calculation</span>
0055 
0056 <span class="comment">% Default method if not user given</span>
0057 MethodFlag = <span class="string">'Exponential'</span>;
0058 sigma = 0.2e-6; <span class="comment">% Error in dcct measure in Amps for 7 read per second config</span>
0059 
0060 <span class="comment">% Parser for method</span>
0061 <span class="keyword">for</span> i = length(varargin):-1:1
0062     <span class="keyword">if</span> strcmpi(varargin{i},<span class="string">'Linear'</span>)
0063         MethodFlag = <span class="string">'Linear'</span>;
0064         varargin(i) = [];
0065     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Exponential'</span>)
0066         MethodFlag = <span class="string">'Exponential'</span>;
0067         varargin(i) = [];
0068     <span class="keyword">end</span>
0069 <span class="keyword">end</span>
0070 
0071 T_Seconds = .5;     <span class="comment">% Default sample period [Seconds]</span>
0072 TmaxDefault = inf;  <span class="comment">% Maximum time</span>
0073 TminDefault = 0;    <span class="comment">% Minimum time</span>
0074 NminDefault = 6;    <span class="comment">% Minimum number of data points</span>
0075 
0076 
0077 <span class="comment">% Input parsing</span>
0078 Tmax = [];
0079 <span class="keyword">if</span> length(varargin) == 0
0080     MonitorFlag = 2;
0081     deltaDCCT = 60 * 0.001;
0082     Tmin = TminDefault;
0083     Tmax = TmaxDefault;
0084     Nmin = NminDefault;
0085     
0086 <span class="keyword">elseif</span> length(varargin) &gt;= 1
0087     t = varargin{1};
0088     <span class="keyword">if</span> all(size(t)==[1 1])
0089         <span class="keyword">if</span> t &gt; 0
0090             MonitorFlag = 1;
0091             t = 0:T_Seconds:t;
0092             Tmax = TmaxDefault;
0093         <span class="keyword">else</span>
0094             MonitorFlag = 2;
0095             deltaDCCT = abs(t);
0096             <span class="keyword">if</span> length(varargin) &gt;= 2
0097                 Tmax = DCCT;
0098             <span class="keyword">else</span>
0099                 Tmax = [];
0100             <span class="keyword">end</span>
0101         <span class="keyword">end</span>
0102         <span class="keyword">if</span> length(varargin) &lt; 3
0103             Tmin = [];
0104         <span class="keyword">end</span>
0105         <span class="keyword">if</span> length(varargin) &lt; 4
0106             Nmin = [];
0107         <span class="keyword">end</span>
0108         <span class="keyword">if</span> isempty(Tmax)
0109             Tmax = TmaxDefault;
0110         <span class="keyword">end</span>
0111         <span class="keyword">if</span> isempty(Tmin)
0112             Tmin = TminDefault;
0113         <span class="keyword">end</span>
0114         <span class="keyword">if</span> isempty(Nmin)
0115             Nmin = NminDefault;
0116         <span class="keyword">end</span>
0117     <span class="keyword">else</span>
0118         <span class="comment">% Time vector input</span>
0119         <span class="keyword">if</span> length(varargin) &lt; 2
0120             MonitorFlag = 1;
0121         <span class="keyword">else</span>
0122             MonitorFlag = 0;
0123         <span class="keyword">end</span>
0124     <span class="keyword">end</span>
0125 <span class="keyword">end</span>
0126 
0127 
0128 <span class="keyword">if</span> MonitorFlag == 1
0129     
0130     <span class="comment">% Get DCCT data at a fix interval determined by the input vector t</span>
0131     <span class="comment">%disp(['   Monitoring beam current for ', num2str(t(length(t))), ' seconds.']);</span>
0132     t0 = gettime;
0133     <span class="keyword">for</span> j = 1:length(t)
0134         T = t(j) - (gettime-t0);
0135         <span class="keyword">if</span> T &gt; 0
0136             pause(T);
0137         <span class="keyword">end</span>
0138         tout(j,1) = gettime - t0;    
0139         DCCT(j,1) = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>;
0140     <span class="keyword">end</span>
0141     
0142 <span class="keyword">elseif</span> MonitorFlag == 2
0143     
0144     <span class="comment">% Monitor for a fixed DCCT drop</span>
0145     <span class="comment">%disp(['   Monitoring beam current until current drops by more than ', num2str(deltaDCCT), ' mA.']);</span>
0146     j = 1;
0147     n = 1;
0148     tout(n,1) = 0;
0149     DCCT(n,1) = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>;
0150     t0 = gettime;
0151     t0_Display = 0;
0152     <span class="keyword">while</span> ((abs(DCCT(<span class="keyword">end</span>,1)-DCCT(1,1)) &lt; deltaDCCT) &amp; (DCCT(<span class="keyword">end</span>,1) &gt; 0.1)) | <span class="keyword">...</span>
0153             n &lt; Nmin | (gettime-t0) &lt; Tmin
0154         j = j+1;
0155         T = (j-1)*T_Seconds - (gettime-t0);
0156         <span class="keyword">if</span> T &gt; 0
0157             pause(T);
0158         <span class="keyword">end</span>
0159         DCCTnew = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>;
0160         <span class="keyword">if</span> DCCTnew ~= DCCT(n)
0161             n = n + 1;
0162             tout(n,1) = gettime - t0;
0163             DCCT(n,1) = DCCTnew;
0164         <span class="keyword">end</span>
0165         <span class="keyword">if</span> gettime-t0 &gt; Tmax
0166             <span class="keyword">break</span>;
0167         <span class="keyword">end</span>
0168         <span class="keyword">if</span> gettime-t0_Display &gt; 10    
0169             fprintf(<span class="string">'   Monitoring DCCT for lifetime measurement (%s)\n'</span>, <span class="keyword">...</span>
0170                 datestr(clock,0));
0171             t0_Display = gettime;
0172         <span class="keyword">end</span>
0173     <span class="keyword">end</span>
0174     t = tout;
0175 <span class="keyword">end</span>
0176 
0177 <span class="comment">% Column vectors</span>
0178 DCCT = DCCT(:);
0179 t = t(:);
0180 
0181 
0182 <span class="comment">% Lookfor identical data in DCCT.  Some machine don't update at T_Sample and</span>
0183 <span class="comment">% having the same reading twice is probably not so good for the LS fit.</span>
0184 iExtra = find(diff(DCCT)==0);
0185 DCCT(iExtra) = [];
0186 t(iExtra) = [];
0187 
0188 <span class="keyword">if</span> length(DCCT) &lt; 2
0189     Tau = NaN;
0190     I0 = NaN;
0191     fprintf(<span class="string">'   Only 1 unique DCCT reading, hence Tau is set to NaN.\n'</span>);
0192     <span class="comment">%error('There must be at least 2 unique point to fit a lifetime.');</span>
0193     <span class="keyword">return</span>
0194 <span class="keyword">end</span>
0195     
0196     
0197 <span class="comment">% LS fit</span>
0198 <span class="keyword">if</span> strcmpi(MethodFlag,<span class="string">'Exponential'</span>)
0199     y = log(DCCT);
0200 <span class="keyword">else</span>
0201     y = DCCT;
0202 <span class="keyword">end</span>
0203 
0204 X = [ones(size(t)) t];
0205 
0206 <span class="comment">% Linear Least square fit</span>
0207 invXX = inv(X'*X);
0208 B = invXX*X'*y     
0209 
0210 <span class="keyword">if</span> strcmpi(MethodFlag,<span class="string">'Exponential'</span>)
0211     <span class="comment">% yfit = exp(B(1))*exp(B(2)*tfit);</span>
0212     I0 = exp(B(1));
0213     Tau = -1/B(2)/3600;    <span class="comment">% In hours</span>
0214     yfit = exp(B(1))*exp(B(2)*t);
0215     stitle = <span class="string">'Least Squares Fit : I0*exp(-t/tau)'</span>;
0216 <span class="keyword">else</span>
0217     <span class="comment">% yfit = B(1) + B(2)*tfit;</span>
0218     I0 = B(1)
0219     Tau = -B(1)/B(2)/60/60;    <span class="comment">% In hours</span>
0220     yfit = B(1) + B(2)*t;
0221     stitle = <span class="string">'Least Squares Fit : I0*(1 - t/tau)'</span>;
0222 <span class="keyword">end</span>
0223 
0224 <span class="comment">%% Erreur</span>
0225 <span class="comment">%chi2 = 1/(sigma*sigma)*sum(power(DCCT - yfit,2));</span>
0226 chi2 = 1/(sigma*sigma)*sum(power(y - B(1)-B(2)*t,2));
0227 <span class="comment">% Normalized chi2</span>
0228 chi2n = chi2/(length(t)-length(B));
0229 <span class="comment">% Covariance matrix</span>
0230 Mcovariance = chi2n*invXX
0231 
0232 <span class="keyword">if</span> strcmpi(MethodFlag,<span class="string">'Exponential'</span>)
0233     dtau = sqrt(Mcovariance(2,2)/B(2)/B(2))/3600;
0234 <span class="keyword">else</span>
0235     dtau = sqrt(Mcovariance(1,1)/B(2)/B(2) + <span class="keyword">...</span>
0236         power(B(1)/B(2)/B(2),2)*Mcovariance(2,2) - <span class="keyword">...</span>
0237         2*B(1)/power(B(2),3)*Mcovariance(2,1));
0238 <span class="keyword">end</span>
0239 
0240 <span class="keyword">if</span> isnan(Tau) || chi2n &gt; 5
0241     fprintf(<span class="string">'   Life time measurement is inaccurate!\n'</span>);
0242 <span class="keyword">end</span>
0243 
0244 <span class="keyword">if</span> nargout == 0    
0245         
0246     clf reset
0247     subplot(2,1,1)
0248     plot(t,DCCT,<span class="string">'o-b'</span>, t,yfit,<span class="string">'--r'</span>); hold on;
0249     <span class="comment">% errorbar(t,DCCT,sigma*ones(size(DCCT)),'.b'); hold off</span>
0250     title(sprintf(<span class="string">'Beam Current vs Time: Lifetime= %2.2f +/- %2.2f (h) with chi2n = %2.2g'</span>, Tau, dtau, chi2n))
0251 <span class="comment">%    title(sprintf('Beam Current vs Time: Lifetime= %2.2f (h) with chi2n = %2.2g', Tau, chi2n))</span>
0252     xlabel(<span class="string">'Time [seconds]'</span>); 
0253     ylabel(<span class="string">'Beam Current [mA]'</span>);
0254     legend(<span class="string">'Measured Beam Current'</span>,stitle,0);
0255     grid on;
0256     xlim([t(1) t(end)]);
0257 
0258     subplot(2,1,2)
0259     plot(t,DCCT-yfit);
0260     title([<span class="string">'Residual Error (RMS = '</span> num2str(std(DCCT-yfit),<span class="string">'%.2g'</span>) <span class="string">' mA)'</span>]);
0261     xlabel(<span class="string">'Time [seconds]'</span>); 
0262     ylabel(<span class="string">'Lifetime Corrected Beam Current Variation'</span>);
0263     grid on;
0264     
0265     addlabel(1,0, datestr(clock,0));
0266 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>