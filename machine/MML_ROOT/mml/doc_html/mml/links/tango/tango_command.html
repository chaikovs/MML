<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of tango_command</title>
  <meta name="keywords" content="tango_command">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">mml</a> &gt; <a href="#">links</a> &gt; <a href="index.html">tango</a> &gt; tango_command.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml/links/tango&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>tango_command
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function tango_command(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="family2tango.html" class="code" title="function [TangoNames, ErrorFlag] = family2tango(varargin)">family2tango</a>	FAMILY2TANGO - Converts a familly to TANGO names</li><li><a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>	GETPVONLINE - Get the online value</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_command(AO, DeviceList, commandName)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function tango_command(varargin)</a>
0002 
0003 <span class="comment">%</span>
0004 [FamilyIndex, AO] = isfamily(varargin{1});
0005 
0006 <span class="keyword">if</span> FamilyIndex
0007     Family = varargin{1};
0008     <span class="keyword">if</span> length(varargin) &gt;= 1
0009         DeviceList = varargin{2};
0010         commandName = varargin{3};
0011     <span class="keyword">end</span>
0012     <a href="#_sub1" class="code" title="subfunction [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_command(AO, DeviceList, commandName)">local_command</a>(AO, DeviceList, commandName);
0013 <span class="keyword">end</span>
0014 
0015 
0016 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0017 <span class="comment">%% Main Function for Getting Data using the Accelerator Object  %</span>
0018 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0019 <span class="comment">%function [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_command(AO, Field, DeviceList, OutputDataType, t, FreshDataFlag, TimeOutPeriod)</span>
0020 <a name="_sub1" href="#_subfunctions" class="code">function [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_command(AO, DeviceList, commandName)</a>
0021 <span class="comment">%  INPUTS</span>
0022 <span class="comment">%  1. AO - the ACCELERATOR_OBJECT structure for the called family</span>
0023 <span class="comment">%  2. Field - 'Monitor' or 'Setpoint'</span>
0024 <span class="comment">%  3. DeviceList - Device list</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  OUTPUTS</span>
0027 <span class="comment">%  1. AM - Vector a read values</span>
0028 <span class="comment">%  2. TimeStamp - timestamp when data collected</span>
0029 <span class="comment">%  3. ErrorFlag - 0 if OK, else 1</span>
0030 <span class="comment">%  4. DeviceIndex - List of status 1 devices</span>
0031 
0032 <span class="comment">%  Written by Gregory J. Portmann</span>
0033 <span class="comment">%  Modified by Laurent S. Nadolski</span>
0034 
0035 t0 = clock;
0036 ErrorFlag = 0;
0037 N = 0;  <span class="comment">% Output size</span>
0038 
0039 <span class="comment">% Find the index for where the desired data is in the total device list</span>
0040 DeviceListTotal = AO.DeviceList;
0041 [DeviceIndex, iNotFound] = findrowindex(DeviceList, DeviceListTotal);
0042 <span class="keyword">if</span> length(iNotFound) &gt; 0
0043     <span class="comment">% Device not found</span>
0044     <span class="keyword">for</span> i = 1:length(iNotFound)
0045         fprintf(<span class="string">'   No devices to get for Family %s(%d,%d)\n'</span>, AO.FamilyName, DeviceList(i,1), DeviceList(i,2));
0046     <span class="keyword">end</span>
0047     error(<span class="string">'%d Devices not found'</span>, length(iNotFound));
0048 <span class="keyword">end</span>
0049 
0050 <span class="comment">% Check the DeviceIndex</span>
0051 <span class="keyword">if</span> isempty(DeviceIndex)
0052     DataTime = 0 + 0*sqrt(-1);
0053     tout = etime(clock, t0);
0054     AM = [];
0055     <span class="comment">%fprintf('   WARNING:  No devices to get for Family %s (getpv)\n', AO.FamilyName);</span>
0056     <span class="keyword">return</span>;
0057 <span class="keyword">end</span>
0058 
0059 <span class="comment">%% TANGO specific part</span>
0060 
0061 <span class="comment">% Load Field sub-structure into AOField</span>
0062 <span class="keyword">if</span> ~isfield(AO, Field);
0063     <span class="comment">% Try changing the suffix of the Monitor or Setpoint field</span>
0064     <span class="keyword">if</span> isfield(AO, <span class="string">'Setpoint'</span>)
0065         Tango = <a href="family2tango.html" class="code" title="function [TangoNames, ErrorFlag] = family2tango(varargin)">family2tango</a>(AO, <span class="string">'Setpoint'</span>, DeviceList);
0066     <span class="keyword">elseif</span> isfield(AO, <span class="string">'Monitor'</span>)
0067         Tango = <a href="family2tango.html" class="code" title="function [TangoNames, ErrorFlag] = family2tango(varargin)">family2tango</a>(AO, <span class="string">'Monitor'</span>, DeviceList);
0068     <span class="keyword">else</span>
0069         error(sprintf(<span class="string">'Field %s not found for Family %s'</span>, Field, AO.FamilyName));
0070     <span class="keyword">end</span>
0071     <span class="keyword">if</span> any(strcmpi(getfamilydata(<span class="string">'Machine'</span>),{<span class="string">'spear3'</span>,<span class="string">'spear'</span>}))
0072         <span class="comment">% Change the last ':' Field</span>
0073         i = findstr(Tango(1,:),<span class="string">':'</span>);
0074         <span class="keyword">if</span> ~isempty(i)
0075             Tango(:,i:end) = [];
0076         <span class="keyword">end</span>
0077         Tango = strcat(Tango, [<span class="string">':'</span>,Field]);
0078     <span class="keyword">else</span>
0079         <span class="comment">% Add a .Field</span>
0080         Tango = strcat(Tango, [<span class="string">'.'</span>,Field]);
0081     <span class="keyword">end</span>
0082 
0083     ExtraTimeDelay = etime(clock, t0);
0084     <span class="keyword">if</span> nargout &lt; 3
0085         [AM, tout] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(Tango, OutputDataType, N, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0086     <span class="keyword">else</span>
0087         [AM, tout, DataTime, ErrorFlag] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(Tango, OutputDataType, N, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0088     <span class="keyword">end</span>
0089     tout = tout + ExtraTimeDelay;
0090     <span class="keyword">return</span>
0091 <span class="keyword">end</span>
0092     
0093 
0094 AOField = AO.(Field);
0095 
0096 <span class="comment">% If mode does not exist, force to online mode</span>
0097 <span class="keyword">if</span> isfield(AOField, <span class="string">'Mode'</span>)
0098     Mode = AOField.Mode;
0099 <span class="keyword">else</span>
0100     Mode = <span class="string">'Online'</span>;
0101 <span class="keyword">end</span>
0102 
0103 <span class="comment">%%</span>
0104 <span class="comment">%=======================</span>
0105 <span class="comment">%% ONLINE MACHINE</span>
0106 <span class="comment">%=======================</span>
0107 <span class="keyword">if</span> strcmpi(Mode,<span class="string">'Online'</span>)
0108     <span class="comment">% Online</span>
0109     <span class="keyword">if</span> strcmpi(AOField.DataType,<span class="string">'Scalar'</span>)
0110         N = 1;  <span class="comment">% Output size</span>
0111 
0112         ExtraTimeDelay = etime(clock, t0);
0113         <span class="keyword">if</span> nargout &lt; 3
0114             [AM, tout] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N, t-ExtraTimeDelay);
0115         <span class="keyword">else</span>
0116             [AM, tout, DataTime, ErrorFlag] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N, t-ExtraTimeDelay);
0117         <span class="keyword">end</span>
0118         tout = tout + ExtraTimeDelay;
0119 
0120         <span class="comment">% FreshDataFlag</span>
0121         <span class="keyword">if</span> FreshDataFlag &amp; length(t) == 1
0122             <span class="comment">% Only use FreshDataFlag for scalar t</span>
0123             FreshDataCounter = FreshDataFlag;
0124             AM0 = AM;
0125             <span class="keyword">while</span> FreshDataCounter
0126                 <span class="keyword">if</span> nargout &lt; 3
0127                     [AM, tout] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(AOField.TangoNames(DeviceIndex,:), Field,OutputDataType, N);
0128                 <span class="keyword">else</span>
0129                     [AM, tout, DataTime, ErrorFlag] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N);
0130                 <span class="keyword">end</span>
0131 
0132                 <span class="keyword">if</span> ~any((AM-AM0)==0)
0133                     FreshDataCounter = FreshDataCounter - 1;
0134                     AM0 = AM;
0135                 <span class="keyword">end</span>
0136 
0137                 <span class="keyword">if</span> etime(clock, t0) &gt; TimeOutPeriod
0138                     k = find((AM-AM0)==0);
0139                     <span class="keyword">for</span> j = 1:length(k)
0140                         fprintf(<span class="string">'%s not changing.\n'</span>, deblank((AOField.TangoNames(DeviceIndex(k(j)),:))));
0141                     <span class="keyword">end</span>
0142                     error(<span class="string">'Timed out waiting for fresh data.'</span>);
0143                 <span class="keyword">end</span>
0144             <span class="keyword">end</span>
0145             tout = etime(clock, t0);
0146         <span class="keyword">end</span>
0147         
0148     <span class="keyword">elseif</span> strcmpi(AOField.DataType, <span class="string">'Vector'</span>)
0149 
0150 
0151         <span class="comment">% Output(DataTypeIndex) must be equal to the number of elements in the family</span>
0152         
0153         <span class="comment">% There can only be one Tango or channel name for DataType='Vector'</span>
0154         TangoNames = deblank(AOField.TangoNames(1,:));
0155 
0156 
0157 
0158         <span class="comment">% Get data at every point in time vector, t</span>
0159         AM = [];
0160         ExtraTimeDelay = etime(clock, t0);
0161         t = t - ExtraTimeDelay;
0162         <span class="keyword">for</span> itime = 1:length(t)
0163             T = t(itime)-etime(clock, t0);
0164             <span class="keyword">if</span> T &gt; 0
0165                 pause(T);
0166             <span class="keyword">end</span>
0167 
0168             <span class="comment">% Get data</span>
0169             <span class="keyword">if</span> nargout &gt;= 3
0170                 [tmp, tout, DataTime(:,itime), ErrorFlag] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(TangoNames, <span class="string">'Vector'</span>, N);
0171             <span class="keyword">else</span>
0172                 tmp = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(TangoNames, <span class="string">'Vector'</span>, N);
0173             <span class="keyword">end</span>
0174             <span class="keyword">if</span> isfield(AOField, <span class="string">'DataTypeIndex'</span>)
0175                 tmp = tmp(AOField.DataTypeIndex);
0176             <span class="keyword">end</span>
0177             AM = [AM tmp(DeviceIndex,:)];
0178 
0179             tout(itime) = etime(clock, t0);
0180         <span class="keyword">end</span>
0181 
0182         <span class="comment">% FreshDataFlag</span>
0183         <span class="keyword">if</span> FreshDataFlag &amp; length(t) == 1
0184             <span class="comment">% Only use FreshDataFlag for scalar t</span>
0185             FreshDataCounter = FreshDataFlag;
0186             AM0 = AM;
0187             <span class="keyword">while</span> FreshDataCounter
0188                 <span class="keyword">if</span> nargout &gt;= 3
0189                     [AM, tout, DataTime, ErrorFlag] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(TangoNames, <span class="string">'Vector'</span>, N);
0190                 <span class="keyword">else</span>
0191                     AM = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(TangoNames, <span class="string">'Vector'</span>, N);
0192                 <span class="keyword">end</span>
0193                 <span class="keyword">if</span> isfield(AOField, <span class="string">'DataTypeIndex'</span>)
0194                     AM = AM(AOField.DataTypeIndex);
0195                 <span class="keyword">end</span>
0196                 AM = AM(DeviceIndex,:);
0197 
0198                 <span class="keyword">if</span> ~any((AM-AM0)==0)
0199                     FreshDataCounter = FreshDataCounter - 1;
0200                     AM0 = AM;
0201                 <span class="keyword">end</span>
0202 
0203                 <span class="keyword">if</span> etime(clock, t0) &gt; TimeOutPeriod
0204                     k = find((AM-AM0)==0);
0205                     <span class="keyword">for</span> j = 1:length(k)
0206                         fprintf(<span class="string">'%s[%d,%d] not changing.\n'</span>, AO.FamilyName, DeviceList(k(j),1), DeviceList(k(j),2));
0207                     <span class="keyword">end</span>
0208                     error(<span class="string">'Timed out waiting for fresh data.'</span>);
0209                 <span class="keyword">end</span>
0210             <span class="keyword">end</span>
0211             tout = etime(clock, t0);
0212         <span class="keyword">end</span>
0213 
0214     <span class="keyword">elseif</span> strcmpi(AOField.DataType,<span class="string">'Matrix'</span>)
0215 
0216         <span class="keyword">for</span> iDev = 1:length(DeviceIndex)
0217             <span class="comment">%AM(iDev,:) = rand(1,10); DataTime(iDev,:) = now; ErrorFlag(iDev,:)=0;</span>
0218             [AM(iDev,:), tout, DataTime(iDev,:), ErrorFlag(iDev,1)] = <a href="getpvonline.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, Field, varargin);">getpvonline</a>(AOField.TangoNames(DeviceIndex(iDev),:), <span class="string">'Matrix'</span>, N);
0219         <span class="keyword">end</span>
0220         ErrorFlag = any(ErrorFlag);
0221         tout = etime(clock, t0);
0222 
0223     <span class="keyword">else</span>
0224         error(sprintf(<span class="string">'Unknown DataType for family %s.'</span>, AO.FamilyName));
0225     <span class="keyword">end</span>
0226 
0227     <span class="comment">% Change to physics units if Units = 'physics'</span>
0228     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
0229         <span class="comment">% Change to physics units</span>
0230         AM = hw2physics(AO.FamilyName, Field, AM, DeviceList);
0231     <span class="keyword">end</span>
0232 
0233 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Special'</span>)
0234 
0235     <span class="keyword">if</span> isfield(AOField, <span class="string">'SpecialFunctionGet'</span>)
0236         SpecialFunction = AOField.SpecialFunctionGet;
0237     <span class="keyword">elseif</span> isfield(AOField, <span class="string">'SpecialFunction'</span>)
0238         SpecialFunction = AOField.SpecialFunction;
0239     <span class="keyword">else</span>
0240         error(sprintf(<span class="string">'No special function specified for Family %s (getpv).'</span>, AO.FamilyName));
0241     <span class="keyword">end</span>
0242 
0243     <span class="comment">% Get data at every point in time vector, t</span>
0244     ExtraTimeDelay = etime(clock, t0);
0245     t = t - ExtraTimeDelay;
0246     [AM, tout, DataTime, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
0247     t1 = clock;
0248     <span class="keyword">if</span> isempty(tout)
0249         tout = etime(t1, t0);
0250     <span class="keyword">end</span>
0251     <span class="keyword">if</span> nargout &gt;= 3 &amp; isempty(DataTime)
0252         days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0253         tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
0254         DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
0255     <span class="keyword">end</span>
0256     <span class="keyword">if</span> length(t) &gt; length(tout)
0257         <span class="keyword">for</span> itime = 2:length(t)
0258             T = t(itime)-etime(clock, t0);
0259             <span class="keyword">if</span> T &gt; 0
0260                 pause(T);
0261             <span class="keyword">end</span>
0262 
0263             <span class="comment">% Get data</span>
0264             [Tmp, toutTmp, DataTimeTmp, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
0265             
0266             AM = [AM Tmp];
0267             DataTime = [DataTime DataTimeTmp];
0268 
0269             t1 = clock;
0270             tout(1,itime) = etime(t1, t0);
0271             <span class="keyword">if</span> nargout &gt;= 3 &amp; isempty(DataTimeTmp)
0272                 days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0273                 tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
0274                 DataTime(1:size(AM,1),itime) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
0275             <span class="keyword">end</span>
0276         <span class="keyword">end</span>
0277     <span class="keyword">end</span>
0278 
0279     <span class="comment">% FreshDataFlag</span>
0280     <span class="keyword">if</span> FreshDataFlag &amp; length(t) == 1
0281         <span class="comment">% Only use FreshDataFlag for scalar t</span>
0282         FreshDataCounter = FreshDataFlag;
0283         AM0 = AM;
0284         <span class="keyword">while</span> FreshDataCounter
0285             <span class="comment">% Get data</span>
0286             [AM, tout, DataTime, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
0287 
0288             <span class="keyword">if</span> ~any((AM-AM0)==0)
0289                 FreshDataCounter = FreshDataCounter - 1;
0290                 AM0 = AM;
0291             <span class="keyword">end</span>
0292 
0293             t1 = clock;
0294             <span class="keyword">if</span> etime(t1, t0) &gt; TimeOutPeriod
0295                 k = find((AM-AM0)==0);
0296                 <span class="keyword">for</span> j = 1:length(k)
0297                     fprintf(<span class="string">'%s[%d,%d] not changing.\n'</span>, AO.FamilyName, DeviceList(k(j),1), DeviceList(k(j),2));
0298                 <span class="keyword">end</span>
0299                 error(<span class="string">'Timed out waiting for fresh data.'</span>);
0300             <span class="keyword">end</span>
0301         <span class="keyword">end</span>
0302         tout = etime(t1, t0);
0303 
0304         <span class="keyword">if</span> nargout &gt;= 3 &amp; isempty(DataTime)
0305             days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0306             tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
0307             DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
0308         <span class="keyword">end</span>
0309     <span class="keyword">end</span>    
0310     
0311     <span class="comment">% Change to physics units if Units = 'physics'</span>
0312     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
0313         <span class="comment">% Change to physics units</span>
0314         AM = hw2physics(AO.FamilyName, Field, AM, DeviceList);
0315     <span class="keyword">end</span>
0316         
0317 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Manual'</span>)
0318    <span class="comment">% Always return in hardware units (like connected to the IOC)</span>
0319     <span class="comment">% The conversion to physics in done at the end</span>
0320     t = 0;
0321     <span class="keyword">if</span> strcmp(AO.FamilyName, <span class="string">'TUNE'</span>)
0322         HarmNumber = [];
0323         RF = [];
0324         <span class="keyword">if</span> find(DeviceIndex == 1)
0325             AM(1,1) = input(sprintf(<span class="string">'   Input the horizontal tune (fraction or Hz) = '</span>));
0326             <span class="keyword">if</span> AM(1,1) &gt; 1
0327                 HarmNumber = getharmonicnumber;
0328                 RF = getrf(<span class="string">'Struct'</span>);
0329                 <span class="keyword">if</span> strcmpi(RF.UnitsString,<span class="string">'MHz'</span>)
0330                     FundFreq = 1e6*RF.Data / HarmNumber;
0331                 <span class="keyword">elseif</span> strcmpi(RF.UnitsString,<span class="string">'Hz'</span>)
0332                     FundFreq = RF.Data / HarmNumber;
0333                 <span class="keyword">else</span>
0334                     error(<span class="string">'RF units in not known.'</span>);
0335                 <span class="keyword">end</span>
0336                 <span class="comment">%AM(1,1) = (AM(1,1)- RF) / FundFreq;</span>
0337                 AM(1,1) = AM(1,1) / FundFreq;
0338                 fprintf(<span class="string">'   Horizontal fraction tune computed to be %f\n\n'</span>, AM(1,1));
0339             <span class="keyword">end</span>
0340         <span class="keyword">end</span>
0341         <span class="keyword">if</span> find(DeviceIndex == 2)
0342             AM(2,1) = input(sprintf(<span class="string">'   Input the vertical   tune (fraction or Hz) = '</span>));
0343             <span class="keyword">if</span> AM(2,1) &gt; 1
0344                 <span class="keyword">if</span> isempty(HarmNumber)
0345                     HarmNumber = getharmonicnumber;
0346                 <span class="keyword">end</span>
0347                 <span class="keyword">if</span> isempty(RF)
0348                     RF = getrf(<span class="string">'Struct'</span>);
0349                 <span class="keyword">end</span>
0350                 <span class="keyword">if</span> strcmpi(RF.UnitsString,<span class="string">'MHz'</span>)
0351                     FundFreq = 1e6*RF.Data / HarmNumber;
0352                 <span class="keyword">elseif</span> strcmpi(RF.UnitsString,<span class="string">'Hz'</span>)
0353                     FundFreq = RF.Data / HarmNumber;
0354                 <span class="keyword">else</span>
0355                     error(<span class="string">'RF units in not known.'</span>);
0356                 <span class="keyword">end</span>
0357                 AM(2,1) = AM(2,1)/FundFreq;
0358                 <span class="comment">%AM(2,1) = (AM(2,1) - HarmNumber * FundFreq)/FundFreq;</span>
0359                 fprintf(<span class="string">'   Vertical   fraction tune computed to be %f\n\n'</span>, AM(2,1));
0360             <span class="keyword">end</span>
0361         <span class="keyword">end</span>
0362         <span class="keyword">if</span> find(DeviceIndex == 3)
0363             AM(2,1) = input(<span class="string">'   Input the synchrotron tune = '</span>);
0364         <span class="keyword">end</span>
0365     <span class="keyword">elseif</span> strcmp(AO.FamilyName, <span class="string">'RF'</span>)
0366         <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Hardware'</span>)
0367             AM(1) = input(sprintf(<span class="string">'   Input the RF frequency [%s] = '</span>, AO.(Field).HWUnits));
0368         <span class="keyword">else</span>
0369             AM(1) = input(sprintf(<span class="string">'   Input the RF frequency [%s] = '</span>, AO.(Field).PhysicsUnits));
0370             AM = physics2hw(AO.FamilyName, Field, AM, [1 1]);
0371         <span class="keyword">end</span>
0372     <span class="keyword">else</span>
0373         <span class="keyword">for</span> i = 1:length(DeviceIndex)
0374             <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Hardware'</span>)
0375                 AM(i,:) = input(sprintf(<span class="string">'   Manual input:  %s(%d,%d) [%s] = '</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), AO.(Field).HWUnits));
0376             <span class="keyword">else</span>
0377                 AM(i,:) = input(sprintf(<span class="string">'   Manual input:  %s(%d,%d) [%s] = '</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), AO.(Field).PhysicsUnits));
0378                 AM(i,:) = physics2hw(AO.FamilyName, Field, AM(i,:), AO.DeviceList(DeviceIndex(i),:));
0379             <span class="keyword">end</span>
0380         <span class="keyword">end</span>
0381     <span class="keyword">end</span>
0382     
0383     t1 = clock;
0384     tout = etime(t1, t0);
0385     days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0386     tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
0387     DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
0388     
0389     <span class="comment">% Change to physics units if Units = 'physics'</span>
0390     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
0391         <span class="comment">% Change to physics units</span>
0392         AM = hw2physics(AO.FamilyName, Field, AM, DeviceList);
0393     <span class="keyword">end</span>
0394    
0395 <span class="comment">%====================</span>
0396 <span class="comment">%% MODEL or SIMULATOR</span>
0397 <span class="comment">%====================</span>
0398 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Simulator'</span>) || strcmpi(Mode,<span class="string">'Model'</span>)    
0399     error(<span class="string">'Unknown mode for family %s.'</span>, AO.FamilyName)
0400 <span class="keyword">else</span>
0401     error(<span class="string">'Unknown mode for family %s.'</span>, AO.FamilyName);
0402 <span class="keyword">end</span>
0403 
0404 
0405 <span class="comment">% Return a column vector</span>
0406 <span class="comment">%AM = AM(:);  doesn't work for strings or matrices</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>