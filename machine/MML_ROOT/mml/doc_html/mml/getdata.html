<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of getdata</title>
  <meta name="keywords" content="getdata">
  <meta name="description" content="GETDATA - Searches through a file (or group of files) for a data structure which matches the family name">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; getdata.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>getdata
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>GETDATA - Searches through a file (or group of files) for a data structure which matches the family name</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [S, FileName] = getdata(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">GETDATA - Searches through a file (or group of files) for a data structure which matches the family name
  [Data, FileName] = getdata(FamilyName, FileName)
  [Data, FileName] = getdata(FamilyName, DeviceList, FileName)

  INPUTS
  1. FamilyName - Family name to search for.  This function will search through all 
                  the variables in the file looking for a FamilyName match.  It will 
                  also look through any array or cell array.  Arrays within a cell
                  array will also be searched through.
  2. FileName - File name to search in (or cell array of file names) {default: []}
                [] - prompt the user to choose a file
  3. DeviceList - Device list to index by (optional input)
  4. 'Field' - Sometime searching on FamilyName is not enough.  To contraint which
               Field to search for, use the keyword 'Field' followed 
               by the desired name to look for (see example 3) (optional input).
  5. 'Struct'  - Return a data structure
     'Numeric' - Return numeric outputs  {Default}
     'Object'  - Return a accelerator object (AccObj)

  OUTPUTS
  1. Data - Data found
  2. FileName - File name where the data was found (including the path) 

  EXAMPLES
  1. Get BPM data in file abc.mat 
     &gt;&gt; BPM = getdata('QF', 'abc.mat');
  2. Get QF setpoint data in file abc.mat 
     &gt;&gt; SP = getdata('QF', 'Struct', 'Field', 'Setpoint', 'abc.mat');

  See also <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>	ELEM2DEV - Converts a device list to an element list</li><li><a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>	ISMEMBEROF - Returns turn if the membership information of a family (cell of strings)</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getsigma.html" class="code" title="function [Data, FileName] = getsigma(varargin)">getsigma</a>	GETSIGMA - Return the standard deviation in the monitor for a family</li><li><a href="plotorbitdata.html" class="code" title="function [BPMx, BPMy] = plotorbitdata(varargin)">plotorbitdata</a>	PLOTORBITDATA - Plots BPM statistics</li><li><a href="setgolden.html" class="code" title="function varargout = setgolden(varargin)">setgolden</a>	SETGOLDEN - Set the golden values</li><li><a href="setoffset.html" class="code" title="function varargout = setoffset(varargin)">setoffset</a>	SETOFFSET - Set the offset</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [S, FileName] = getdata(varargin)</a>
0002 <span class="comment">%GETDATA - Searches through a file (or group of files) for a data structure which matches the family name</span>
0003 <span class="comment">%  [Data, FileName] = getdata(FamilyName, FileName)</span>
0004 <span class="comment">%  [Data, FileName] = getdata(FamilyName, DeviceList, FileName)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  INPUTS</span>
0007 <span class="comment">%  1. FamilyName - Family name to search for.  This function will search through all</span>
0008 <span class="comment">%                  the variables in the file looking for a FamilyName match.  It will</span>
0009 <span class="comment">%                  also look through any array or cell array.  Arrays within a cell</span>
0010 <span class="comment">%                  array will also be searched through.</span>
0011 <span class="comment">%  2. FileName - File name to search in (or cell array of file names) {default: []}</span>
0012 <span class="comment">%                [] - prompt the user to choose a file</span>
0013 <span class="comment">%  3. DeviceList - Device list to index by (optional input)</span>
0014 <span class="comment">%  4. 'Field' - Sometime searching on FamilyName is not enough.  To contraint which</span>
0015 <span class="comment">%               Field to search for, use the keyword 'Field' followed</span>
0016 <span class="comment">%               by the desired name to look for (see example 3) (optional input).</span>
0017 <span class="comment">%  5. 'Struct'  - Return a data structure</span>
0018 <span class="comment">%     'Numeric' - Return numeric outputs  {Default}</span>
0019 <span class="comment">%     'Object'  - Return a accelerator object (AccObj)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%  OUTPUTS</span>
0022 <span class="comment">%  1. Data - Data found</span>
0023 <span class="comment">%  2. FileName - File name where the data was found (including the path)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%  EXAMPLES</span>
0026 <span class="comment">%  1. Get BPM data in file abc.mat</span>
0027 <span class="comment">%     &gt;&gt; BPM = getdata('QF', 'abc.mat');</span>
0028 <span class="comment">%  2. Get QF setpoint data in file abc.mat</span>
0029 <span class="comment">%     &gt;&gt; SP = getdata('QF', 'Struct', 'Field', 'Setpoint', 'abc.mat');</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%  See also getrespmat</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%  Written by Greg Portmann</span>
0034 
0035 
0036 <span class="comment">% Input parsing</span>
0037 <span class="comment">% [S, FileName] = getdata(Family, 'Field', 'Monitor', FileName, DeviceList)</span>
0038 <span class="comment">% [S, FileName] = getdata(Family, FileName, DeviceList)</span>
0039 <span class="comment">% [S, FileName] = getdata(Family, DeviceList)</span>
0040 <span class="comment">% [S, FileName] = getdata(Family)</span>
0041 
0042 
0043 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0044 <span class="comment">% Input Parsing %</span>
0045 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0046 StructOutputFlag = 0;
0047 ObjectOutputFlag = 0;
0048 FileName = <span class="string">''</span>;
0049 DeviceList = [];
0050 FieldConstraint = <span class="string">''</span>;
0051 <span class="keyword">for</span> i = length(varargin):-1:1
0052     <span class="keyword">if</span> isstruct(varargin{i})
0053         <span class="comment">% Ignor structures</span>
0054     <span class="keyword">elseif</span> iscell(varargin{i})
0055         <span class="comment">% Ignor cells</span>
0056     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0057         StructOutputFlag = 1;
0058         varargin(i) = [];
0059     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0060         StructOutputFlag = 0;
0061         varargin(i) = [];
0062     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Object'</span>)
0063         ObjectOutputFlag = 1;
0064         StructOutputFlag = 1;
0065         varargin(i) = [];
0066     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Field'</span>)
0067         varargin(i) = [];
0068         FieldConstraint = varargin{i};
0069         varargin(i) = [];
0070     <span class="keyword">end</span>
0071 <span class="keyword">end</span>
0072 
0073 
0074 <span class="keyword">if</span> isempty(varargin)
0075     error(<span class="string">'FamilyName input required'</span>);
0076 <span class="keyword">end</span>
0077 
0078 <span class="keyword">if</span> length(varargin) &gt;= 1 
0079     Family = varargin{1};
0080 <span class="keyword">end</span>
0081 
0082 <span class="keyword">if</span> length(varargin) &gt;= 2
0083     <span class="keyword">if</span> ischar(varargin{2})
0084         FileName = varargin{2};
0085     <span class="keyword">else</span>
0086         DeviceList = varargin{2};
0087     <span class="keyword">end</span>
0088 <span class="keyword">end</span>
0089 
0090 <span class="keyword">if</span> length(varargin) &gt;= 3
0091     <span class="keyword">if</span> ischar(varargin{3})
0092         FileName = varargin{3};
0093     <span class="keyword">else</span>
0094         DeviceList = varargin{3};
0095     <span class="keyword">end</span>
0096 <span class="keyword">end</span>
0097 
0098 <span class="keyword">if</span> isempty(FieldConstraint)
0099     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(Family,<span class="string">'BPM'</span>)
0100         FieldConstraint = <span class="string">'Monitor'</span>;
0101     <span class="keyword">else</span>
0102         FieldConstraint = <span class="string">'Setpoint'</span>;        
0103     <span class="keyword">end</span>
0104 <span class="keyword">end</span>
0105 <span class="comment">% End input parsing</span>
0106 
0107 
0108 <span class="keyword">if</span> isempty(FileName)
0109     [FileName, DirectoryName, FilterIndex] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a Data File'</span>);
0110     <span class="comment">%[FileName, DirectoryName, FilterIndex] = uigetfile('*.mat', 'Select a Data File', getfamilydata('Directory', 'DataRoot'));</span>
0111     <span class="keyword">if</span> FilterIndex == 0
0112         S=[]; FileName=[];
0113         <span class="keyword">return</span>
0114     <span class="keyword">end</span>
0115     FileName = [DirectoryName FileName];
0116 <span class="keyword">end</span>
0117 
0118 
0119 <span class="comment">% Force FileNameCell to be a cell</span>
0120 <span class="keyword">if</span> iscell(FileName)
0121     FileNameCell = FileName;
0122 <span class="keyword">else</span>
0123     FileNameCell = {FileName};
0124 <span class="keyword">end</span>
0125 
0126 Data = [];
0127 Found = 0;
0128 <span class="keyword">for</span> i = 1:length(FileNameCell)
0129     <span class="keyword">try</span>
0130         <span class="comment">% FileStruct is a structure of all the variable inside FileNameCell</span>
0131         FileStruct = load(FileNameCell{i});
0132         
0133         <span class="comment">% VarCell is a cell array of the field names of FileStruct</span>
0134         VarCell = fieldnames(FileStruct);  
0135         
0136         <span class="keyword">for</span> j = 1:length(VarCell)
0137             <span class="comment">% OneField is one of the fields of FileStruct</span>
0138             OneField = FileStruct.(VarCell{j});
0139             
0140             <span class="comment">% Look through all the variable to find a structure with Monitor, Actuator, and Data fields</span>
0141             <span class="keyword">for</span> ii = 1:size(OneField,1)
0142                 <span class="keyword">for</span> jj = 1:size(OneField,2)
0143                     
0144                     <span class="keyword">if</span> iscell(OneField)
0145                         
0146                         <span class="comment">% If OneField is a cell</span>
0147                         OneCell = OneField{ii,jj};
0148                         <span class="keyword">for</span> mm = 1:size(OneCell,1)
0149                             <span class="keyword">for</span> nn = 1:size(OneCell,2)
0150                                 <span class="comment">% If OneCell is an array, look through OneCell to find a structure with FamilyName and Data</span>
0151                                 <span class="keyword">if</span> isfield(OneCell(mm,nn),<span class="string">'FamilyName'</span>) &amp;&amp; isfield(OneCell(mm,nn),<span class="string">'Data'</span>)
0152                                     <span class="keyword">if</span> strcmp(OneCell(mm,nn).FamilyName, Family)
0153                                         <span class="keyword">if</span> ~isempty(FieldConstraint)
0154                                             <span class="keyword">if</span> isfield(OneCell(mm,nn), <span class="string">'Field'</span>)
0155                                                 <span class="keyword">if</span> strcmp(OneCell(mm,nn).Field, FieldConstraint)
0156                                                     S = OneCell(mm,nn);
0157                                                     Found = 1;
0158                                                     <span class="keyword">break</span>
0159                                                 <span class="keyword">end</span>
0160                                             <span class="keyword">end</span>
0161                                         <span class="keyword">else</span>
0162                                             S = OneCell(mm,nn);
0163                                             Found = 1;
0164                                             <span class="keyword">break</span>
0165                                         <span class="keyword">end</span>
0166                                     <span class="keyword">end</span>
0167                                     
0168                                 <span class="keyword">elseif</span> isfield(OneField(mm,nn), Family)
0169                                     <span class="comment">% Config data structure</span>
0170                                     <span class="keyword">if</span> isfield(OneCell(mm,nn).(Family),<span class="string">'FamilyName'</span>) &amp;&amp; isfield(OneCell(mm,nn).(Family),<span class="string">'Data'</span>)
0171                                         <span class="keyword">if</span> ~isempty(FieldConstraint)
0172                                             <span class="keyword">if</span> isfield(OneCell(mm,nn).(Family), <span class="string">'Field'</span>)
0173                                                 <span class="keyword">if</span> strcmp(OneCell(mm,nn).(Family).Field, FieldConstraint) 
0174                                                     S = OneCell(mm,nn).(Family);
0175                                                     Found = 1;
0176                                                     <span class="keyword">break</span>       
0177                                                 <span class="keyword">end</span>
0178                                             <span class="keyword">end</span>
0179                                         <span class="keyword">else</span>
0180                                             S = OneCell(mm,nn).(Family);
0181                                             Found = 1;
0182                                             <span class="keyword">break</span>       
0183                                         <span class="keyword">end</span>
0184                                     <span class="keyword">end</span>
0185                                 <span class="keyword">end</span>
0186                             <span class="keyword">end</span>
0187                         <span class="keyword">end</span>
0188                         
0189                     <span class="keyword">else</span>
0190                         <span class="comment">% Structure</span>
0191                         <span class="comment">% If OneCell is an array, look through OneCell to find a structure with FamilyName and Data</span>
0192                         <span class="keyword">if</span> isfield(OneField(ii,jj),<span class="string">'FamilyName'</span>) &amp;&amp; isfield(OneField(ii,jj),<span class="string">'Data'</span>)
0193                             <span class="keyword">if</span> strcmp(OneField(ii,jj).FamilyName, Family)
0194                                 <span class="keyword">if</span> ~isempty(FieldConstraint)
0195                                     <span class="keyword">if</span> isfield(OneField(ii,jj), <span class="string">'Field'</span>)
0196                                         <span class="keyword">if</span> strcmp(OneField(ii,jj).Field, FieldConstraint)
0197                                             S = OneField(ii,jj);
0198                                             Found = 1;
0199                                             <span class="keyword">break</span>
0200                                         <span class="keyword">end</span>
0201                                     <span class="keyword">end</span>
0202                                 <span class="keyword">else</span>
0203                                     S = OneField(ii,jj);
0204                                     Found = 1;
0205                                     <span class="keyword">break</span>
0206                                 <span class="keyword">end</span>
0207                             <span class="keyword">end</span>
0208                                     
0209                         <span class="keyword">elseif</span> isfield(OneField(ii,jj), Family)
0210                             <span class="keyword">if</span> isfield(OneField(ii,jj).(Family),<span class="string">'FamilyName'</span>) &amp;&amp; isfield(OneField(ii,jj).(Family),<span class="string">'Data'</span>)
0211                                 <span class="comment">% Old config data structure</span>
0212                                 <span class="keyword">if</span> ~isempty(FieldConstraint)
0213                                     <span class="keyword">if</span> isfield(OneField(ii,jj).(Family), <span class="string">'Field'</span>)
0214                                         <span class="keyword">if</span> strcmp(OneField(ii,jj).(Family).Field, FieldConstraint) 
0215                                             S = OneField(ii,jj).(Family);
0216                                             Found = 1;
0217                                             <span class="keyword">break</span>       
0218                                         <span class="keyword">end</span>
0219                                     <span class="keyword">end</span>
0220                                 <span class="keyword">else</span>
0221                                     S = OneField(ii,jj).(Family);
0222                                     Found = 1;
0223                                     <span class="keyword">break</span>       
0224                                 <span class="keyword">end</span>
0225                             <span class="keyword">elseif</span> isfield(OneField(ii,jj), Family) &amp;&amp; isfield(OneField(ii,jj).(Family),FieldConstraint)
0226                                 <span class="comment">% New config data structure</span>
0227                                 <span class="keyword">if</span> ~isempty(FieldConstraint)
0228                                     <span class="keyword">if</span> isfield(OneField(ii,jj).(Family), FieldConstraint) 
0229                                         <span class="keyword">if</span> isfield(OneField(ii,jj).(Family).(FieldConstraint),<span class="string">'FamilyName'</span>) &amp;&amp; isfield(OneField(ii,jj).(Family).(FieldConstraint),<span class="string">'Data'</span>)
0230                                             S = OneField(ii,jj).(Family).(FieldConstraint);
0231                                             Found = 1;
0232                                             <span class="keyword">break</span>       
0233                                         <span class="keyword">end</span>
0234                                     <span class="keyword">end</span>
0235                                 <span class="keyword">end</span>
0236                             <span class="keyword">end</span>
0237                         <span class="keyword">end</span>
0238                     <span class="keyword">end</span>
0239                 <span class="keyword">end</span>
0240                 <span class="keyword">if</span> Found
0241                     <span class="keyword">break</span>;
0242                 <span class="keyword">end</span>
0243             <span class="keyword">end</span>
0244             <span class="keyword">if</span> Found
0245                 <span class="keyword">break</span>;
0246             <span class="keyword">end</span>    
0247         <span class="keyword">end</span>
0248     <span class="keyword">catch</span>
0249     <span class="keyword">end</span>
0250     <span class="keyword">if</span> Found
0251         <span class="keyword">break</span>;
0252     <span class="keyword">end</span>
0253 <span class="keyword">end</span>
0254 
0255 <span class="keyword">if</span> ~Found
0256     error(<span class="string">'Could not find the data structure'</span>);
0257 <span class="keyword">end</span>
0258 
0259 
0260 <span class="comment">% If a DeviceList exists, index .Data, .Status, and .DeviceList</span>
0261 <span class="keyword">if</span> ~isempty(DeviceList)
0262     <span class="keyword">if</span> size(DeviceList,2) == 1
0263         <span class="comment">% Convert element list to a device list</span>
0264         DeviceList = <a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>(Family, DeviceList);
0265     <span class="keyword">end</span>
0266     
0267     DeviceListTotal = S.DeviceList;
0268     [Index, iNotFound, iMonitor] = findrowindex(DeviceList,  DeviceListTotal);
0269     <span class="keyword">if</span> ~isempty(iNotFound)
0270         <span class="comment">% Error if a monitor is not found</span>
0271         <span class="comment">%for i = iNotFound(:)'</span>
0272         <span class="comment">%    fprintf('   %s(%d,%d) not found\n', S.FamilyName, DeviceList(i,1), DeviceList(i,2));</span>
0273         <span class="comment">%end</span>
0274         <span class="comment">%error(sprintf('Not all the devices found in %s', FileName));</span>
0275         
0276         <span class="comment">% Fill the missing .Data with NaN</span>
0277         Data = NaN * ones(size(DeviceList,1), size(S.Data,2));
0278         Data(iMonitor,:) = S.Data(Index,:);
0279         S.Data = Data;
0280         
0281         <span class="comment">% Fill the missing .Status with zeros</span>
0282         <span class="keyword">if</span> length(S.Status) == 1
0283             S.Status = S.Status * ones(size(S.Data,1),1);
0284         <span class="keyword">end</span>
0285         Data = zeros(size(DeviceList,1), 1);
0286         Data(iMonitor,:) = S.Status(Index,:);
0287         S.Status = Data;
0288     <span class="keyword">else</span>
0289         S.Data   = S.Data(Index, :);
0290         S.Status = S.Status(Index, :);
0291     <span class="keyword">end</span>
0292     
0293     <span class="comment">% Index the device list</span>
0294     S.DeviceList = DeviceList;
0295     
0296     
0297     <span class="comment">% Find other fields that need to be indexed</span>
0298     SFields = fieldnames(S);
0299     <span class="keyword">for</span> i = 1:length(SFields)
0300         <span class="keyword">if</span> size(S.(SFields{i}),1) == size(DeviceListTotal,1)
0301             <span class="keyword">if</span> ~isempty(iNotFound)
0302                 Data = NaN * ones(size(DeviceList,1), size(S.(SFields{i}),2));
0303                 Data(iMonitor,:) = S.(SFields{i})(Index,:);
0304                 S.(SFields{i}) = Data;
0305             <span class="keyword">else</span>
0306                 <span class="comment">% Fill the missing .Data with NaN</span>
0307                 Data = NaN * ones(size(DeviceList,1), size(S.(SFields{i}),2));
0308                 Data(iMonitor,:) = S.(SFields{i})(Index,:);
0309                 S.(SFields{i}) = Data;
0310                 
0311                 <span class="comment">%S.(SFields{i}) = S.(SFields{i})(Index,:);</span>
0312             <span class="keyword">end</span>
0313         <span class="keyword">end</span>
0314     <span class="keyword">end</span>
0315 <span class="keyword">end</span>  
0316 
0317 
0318 <span class="comment">% Make the output an AccObj object</span>
0319 <span class="keyword">if</span> ObjectOutputFlag
0320     Data = AccObj(Data);
0321 <span class="keyword">end</span>
0322 
0323 
0324 <span class="keyword">if</span> ~StructOutputFlag
0325     S = S.Data;
0326 <span class="keyword">end</span>
0327</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>