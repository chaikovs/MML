<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of getchroresp</title>
  <meta name="keywords" content="getchroresp">
  <meta name="description" content="GETCHRORESP - Loads the chromaticity response vector (or matrix) for multiple sextupole families">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; getchroresp.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>getchroresp
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>GETCHRORESP - Loads the chromaticity response vector (or matrix) for multiple sextupole families</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [ChromaticityMatrix, FileName] = getchroresp(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">GETCHRORESP - Loads the chromaticity response vector (or matrix) for multiple sextupole families
  [ChromaticityMatrix, FileName] = getchroresp(FamilyName1, DeviceList1, FamilyName2, DeviceList2, ... , FileName, GeV)
  [ChromaticityMatrix, FileName] = getchroresp(DataStructure1, DataStructure2, ... , FileName, GeV)

  INPUTS  
  1. FamilyName - Sextupole family name
  2. DeviceList - DeviceList for a sextuopole family.  If [] or no input, then ChromaticityMatrix 
                  will be a column vector which is the cumulative sum of all magnets in the family.
  3. FileName - File name to look for the response matrix (or cell array of file names)
                '' prompts the user to choose a response matrix file
  4. GeV will linearly scale the response matrix from the measured energy {Default: getenergy}.
  Note: FamilyName and DeviceList can be cell arrays instead of multiple input pairs

  OUTPUTS 
  1. ChromaticityMatrix - Response matrix {Default is physics units}
  
     It is assumed that most common use of this function is with the chromaticity
     corrector families on a ganged power supply.  Hence, the default 
     behavior is to return the cumulative sum of all the magnets in the chain.
     If there is more than one FamilyName, then ChromaticityMatrix will be a matrix  
     where each column is the sum of the contribution of all magnets in that family.

     To get the response matrix for individual magnets in the family use getrespmat:
     getrespmat('Chromaticity', [1 1;1 2], MagnetFamilyName, MagnetDeviceList)
     For instance, getrespmat('Chromaticity', [1 1;1 2], 'SF', [])

  EXAMPLES
  1. M = getchroresp
     M = getchroresp( 'SF','SD') 
     M = getchroresp({'SF','SD'}) 
     M = getchroresp({'SF','SD'},{[],[]})
     All returns the same 2x2 matrix of SF and SD to horizontal and vertical chromaticity

  2. M = getchroresp('SF')
     M = getchroresp('SF', []) 
     M = getchroresp('SF',getlist('SF'))
     Returns a 2x1 matrix representing the cumulative sum of all the magnets in the chain

  3. SF_DataStruct = getsp('SF','Struct');
     M = getchroresp(SF_DataStruct); 
     Returns a 2x1 matrix representing the cumulative sum of all the magnets in the chain

  4. Change the chromaticity by [.1; -.1] using the entire 'SF' and 'SD' families (see stepchro)
     DeltaChromaticity = [.1; -.1];
     DeltaAmps = inv(getchroresp) * DeltaChromaticity;
     setsp({'SF', 'SD'}, {getsp('SF')+DeltaAmps(1), getsp('SD')+DeltaAmps(2)});

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="findmemberof.html" class="code" title="function  FamilyName = findmemberof(MemberString, Field)">findmemberof</a>	FINDMEMBEROF - Finds all family members</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>	GETRESPMAT - Get response matrix data from a file</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="measchroresp.html" class="code" title="function [Rmat, OutputFileName] = measchroresp(varargin)">measchroresp</a>	MEASCHRORESP - measures the response from sextupoles to chromaticity</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="stepchro.html" class="code" title="function  [DelSext, ActuatorFamily] = stepchro(varargin)">stepchro</a>	STEPCHRO - Incremental change in the chromaticity (Delta Tune / Delta RF)</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [ChromaticityMatrix, FileName] = getchroresp(varargin)</a>
0002 <span class="comment">%GETCHRORESP - Loads the chromaticity response vector (or matrix) for multiple sextupole families</span>
0003 <span class="comment">%  [ChromaticityMatrix, FileName] = getchroresp(FamilyName1, DeviceList1, FamilyName2, DeviceList2, ... , FileName, GeV)</span>
0004 <span class="comment">%  [ChromaticityMatrix, FileName] = getchroresp(DataStructure1, DataStructure2, ... , FileName, GeV)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  INPUTS</span>
0007 <span class="comment">%  1. FamilyName - Sextupole family name</span>
0008 <span class="comment">%  2. DeviceList - DeviceList for a sextuopole family.  If [] or no input, then ChromaticityMatrix</span>
0009 <span class="comment">%                  will be a column vector which is the cumulative sum of all magnets in the family.</span>
0010 <span class="comment">%  3. FileName - File name to look for the response matrix (or cell array of file names)</span>
0011 <span class="comment">%                '' prompts the user to choose a response matrix file</span>
0012 <span class="comment">%  4. GeV will linearly scale the response matrix from the measured energy {Default: getenergy}.</span>
0013 <span class="comment">%  Note: FamilyName and DeviceList can be cell arrays instead of multiple input pairs</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%  OUTPUTS</span>
0016 <span class="comment">%  1. ChromaticityMatrix - Response matrix {Default is physics units}</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%     It is assumed that most common use of this function is with the chromaticity</span>
0019 <span class="comment">%     corrector families on a ganged power supply.  Hence, the default</span>
0020 <span class="comment">%     behavior is to return the cumulative sum of all the magnets in the chain.</span>
0021 <span class="comment">%     If there is more than one FamilyName, then ChromaticityMatrix will be a matrix</span>
0022 <span class="comment">%     where each column is the sum of the contribution of all magnets in that family.</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%     To get the response matrix for individual magnets in the family use getrespmat:</span>
0025 <span class="comment">%     getrespmat('Chromaticity', [1 1;1 2], MagnetFamilyName, MagnetDeviceList)</span>
0026 <span class="comment">%     For instance, getrespmat('Chromaticity', [1 1;1 2], 'SF', [])</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%  EXAMPLES</span>
0029 <span class="comment">%  1. M = getchroresp</span>
0030 <span class="comment">%     M = getchroresp( 'SF','SD')</span>
0031 <span class="comment">%     M = getchroresp({'SF','SD'})</span>
0032 <span class="comment">%     M = getchroresp({'SF','SD'},{[],[]})</span>
0033 <span class="comment">%     All returns the same 2x2 matrix of SF and SD to horizontal and vertical chromaticity</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%  2. M = getchroresp('SF')</span>
0036 <span class="comment">%     M = getchroresp('SF', [])</span>
0037 <span class="comment">%     M = getchroresp('SF',getlist('SF'))</span>
0038 <span class="comment">%     Returns a 2x1 matrix representing the cumulative sum of all the magnets in the chain</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%  3. SF_DataStruct = getsp('SF','Struct');</span>
0041 <span class="comment">%     M = getchroresp(SF_DataStruct);</span>
0042 <span class="comment">%     Returns a 2x1 matrix representing the cumulative sum of all the magnets in the chain</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%  4. Change the chromaticity by [.1; -.1] using the entire 'SF' and 'SD' families (see stepchro)</span>
0045 <span class="comment">%     DeltaChromaticity = [.1; -.1];</span>
0046 <span class="comment">%     DeltaAmps = inv(getchroresp) * DeltaChromaticity;</span>
0047 <span class="comment">%     setsp({'SF', 'SD'}, {getsp('SF')+DeltaAmps(1), getsp('SD')+DeltaAmps(2)});</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%  Written by Greg Portmann</span>
0050 
0051 <span class="comment">%</span>
0052 <span class="comment">%  Written by Gregory J. Portmann</span>
0053 <span class="comment">%  Modified By Laurent S. Nadolski</span>
0054 
0055 FileName = <span class="string">''</span>;
0056 NumericFlag = 1;
0057 InputFlags = {};
0058 <span class="keyword">for</span> i = length(varargin):-1:1
0059     <span class="keyword">if</span> isstruct(varargin{i})
0060         <span class="comment">% Ignore structures</span>
0061     <span class="keyword">elseif</span> iscell(varargin{i})
0062         <span class="comment">% Ignore cells</span>
0063     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0064         NumericFlag = 0;
0065         varargin(i) = [];
0066     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0067         NumericFlag = 1;
0068         varargin(i) = [];
0069     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0070         <span class="comment">% Remove</span>
0071         fprintf(<span class="string">'   GETCHRORESP WARNING: ''Online'' input ignored.  Used measchroresp to get the chromaticity response matrix.\n'</span>);
0072         varargin(i) = [];
0073     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>)
0074         <span class="comment">% Remove</span>
0075         fprintf(<span class="string">'   GETCHRORESP WARNING: ''Simulator'' input ignored.\n   Used measchroresp(''Simulator'') to get the simulated chromaticity response matrix.\n'</span>);
0076         varargin(i) = [];
0077     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Model'</span>)
0078         <span class="comment">% Remove</span>
0079         fprintf(<span class="string">'   GETCHRORESP WARNING: ''Model'' input ignored.\n   Use measchroresp(''Model'') to get the model chromaticity response matrix.\n'</span>);
0080         varargin(i) = [];
0081     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Physics'</span>)
0082         InputFlags = [InputFlags varargin(i)];
0083         varargin(i) = [];
0084     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Hardware'</span>)
0085         InputFlags = [InputFlags varargin(i)];
0086         varargin(i) = [];
0087     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'FileName'</span>)
0088         <span class="keyword">if</span> length(varargin) &gt;= i+1 &amp;&amp; ischar(varargin{i+1})
0089             FileName = varargin{i+1};
0090             varargin(i:i+1) = [];
0091         <span class="keyword">else</span>
0092             varargin(i) = [];
0093         <span class="keyword">end</span>
0094         <span class="keyword">if</span> isempty(FileName)
0095             DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'ChroResponse'</span>);
0096             [FileName, DirectoryName] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a chromaticity response matrix file'</span>, DirectoryName);
0097             InputFlags = [InputFlags {[DirectoryName FileName]}];
0098         <span class="keyword">end</span>
0099     <span class="keyword">end</span>
0100 <span class="keyword">end</span>
0101 
0102 
0103 <span class="comment">% Default units</span>
0104 <span class="keyword">if</span> ~any(strcmpi(InputFlags,<span class="string">'Physics'</span>)) &amp;&amp; ~any(strcmpi(InputFlags,<span class="string">'Hardware'</span>))
0105     InputFlags{length(InputFlags)+1} = <span class="string">'Physics'</span>;
0106 <span class="keyword">end</span>
0107 
0108 
0109 ActuatorFamilyDefault = <a href="findmemberof.html" class="code" title="function  FamilyName = findmemberof(MemberString, Field)">findmemberof</a>(<span class="string">'Chromaticity Corrector'</span>)';
0110 <span class="keyword">if</span> isempty(ActuatorFamilyDefault)
0111     ActuatorFamilyDefault = {<span class="string">'S9'</span>,<span class="string">'S10'</span>};
0112 <span class="keyword">end</span>
0113 
0114 <span class="keyword">if</span> isempty(varargin)
0115     FamilyNameCell = ActuatorFamilyDefault;
0116     DeviceListCell = cell(size(ActuatorFamilyDefault));
0117     NumFamilies = length(ActuatorFamilyDefault);
0118     
0119 <span class="keyword">elseif</span> length(varargin) == 1 &amp;&amp; isempty(varargin{1})
0120     FamilyNameCell = ActuatorFamilyDefault;
0121     DeviceListCell = cell(size(ActuatorFamilyDefault));
0122     NumFamilies = length(ActuatorFamilyDefault);
0123 
0124 <span class="keyword">elseif</span> iscell(varargin{1})
0125     FamilyNameCell = varargin{1};
0126     varargin(1) = [];
0127     <span class="keyword">if</span> length(varargin) &gt;= 1
0128         DeviceListCell = varargin{1};
0129         varargin(1) = [];
0130     <span class="keyword">else</span>
0131         <span class="keyword">for</span> i = 1:length(FamilyNameCell)
0132             DeviceListCell{i} = [];
0133         <span class="keyword">end</span>
0134     <span class="keyword">end</span>
0135     NumFamilies = length(FamilyNameCell);
0136     <span class="keyword">if</span> ~iscell(DeviceListCell)
0137         error(<span class="string">'If FamilyName is a cell array then DeviceList must be a cell array'</span>)
0138     <span class="keyword">end</span>
0139     
0140 <span class="keyword">elseif</span> isstruct(varargin{1})
0141     NumFamilies = 0;
0142     <span class="keyword">while</span> ~isempty(varargin)
0143         <span class="comment">% Look for Family and DeviceList</span>
0144         <span class="keyword">if</span> length(varargin) &gt;= 1
0145             <span class="keyword">if</span> ~isstruct(varargin{1})
0146                 <span class="keyword">break</span>
0147             <span class="keyword">end</span>
0148             <span class="keyword">if</span> ~<a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(varargin{1}.FamilyName)
0149                 error(<span class="string">'Unknown family name in data structure'</span>);
0150             <span class="keyword">end</span>
0151             NumFamilies = NumFamilies + 1;
0152             FamilyNameCell{NumFamilies} = varargin{1}.FamilyName;
0153             DeviceListCell{NumFamilies} = varargin{1}.DeviceList;
0154             varargin(1) = [];
0155         <span class="keyword">end</span>
0156     <span class="keyword">end</span>
0157     
0158 <span class="keyword">else</span>
0159     NumFamilies = 0;
0160     <span class="keyword">while</span> ~isempty(varargin)
0161         <span class="comment">% Look for Family and DeviceList</span>
0162         <span class="keyword">if</span> length(varargin) &gt;= 1
0163             <span class="keyword">if</span> ~<a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(varargin{1})
0164                 <span class="keyword">break</span>
0165             <span class="keyword">end</span>
0166             NumFamilies = NumFamilies + 1;
0167             FamilyNameCell{NumFamilies} = varargin{1};
0168             varargin(1) = [];
0169         <span class="keyword">end</span>
0170         <span class="keyword">if</span> length(varargin) &gt;= 1
0171             <span class="keyword">if</span> isnumeric(varargin{1}) || isempty(varargin{1})
0172                 DeviceListCell{NumFamilies} = varargin{1};
0173                 varargin(1) = [];
0174             <span class="keyword">else</span>
0175                 DeviceListCell{NumFamilies} = [];
0176             <span class="keyword">end</span>
0177         <span class="keyword">else</span>
0178             DeviceListCell{NumFamilies} = [];
0179         <span class="keyword">end</span>
0180     <span class="keyword">end</span>
0181 <span class="keyword">end</span>
0182 
0183 
0184 <span class="comment">% FileName should be the next input (if a string, or [] for dialog box)</span>
0185 <span class="keyword">if</span> length(varargin) &gt;= 1
0186     <span class="keyword">if</span> ischar(varargin{1}) || isempty(varargin{1})
0187         FileName = varargin{1};
0188         varargin(1) = [];
0189         
0190         <span class="keyword">if</span> isempty(FileName)
0191             <span class="comment">% Note: This only works if all families are in the same file</span>
0192             DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'ChroResponse'</span>);  
0193             [FileName, DirectoryName, FilterIndex] = uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Select Sextupole-to-Chromaticity Response Matrix File'</span>, DirectoryName);
0194             <span class="keyword">if</span> FilterIndex == 0
0195                 ChromaticityMatrix = [];
0196                 FileName = [];
0197                 <span class="keyword">return</span>
0198             <span class="keyword">end</span>
0199             
0200             FileName = [DirectoryName FileName];
0201             InputFlags = [{FileName} InputFlags];
0202         <span class="keyword">end</span>
0203     <span class="keyword">end</span>
0204 <span class="keyword">end</span>
0205 
0206 
0207 <span class="comment">% The only thing left on the input line can be energy which can be left in varargin</span>
0208 
0209 
0210 <span class="comment">% Get the response matrix</span>
0211 <span class="keyword">if</span> NumericFlag == 1
0212     ChromaticityMatrix = [];
0213 <span class="keyword">end</span>
0214 <span class="keyword">for</span> i = 1:NumFamilies
0215     <span class="keyword">if</span> NumericFlag == 1
0216         <span class="keyword">try</span>
0217             [M, FileName] = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(<span class="string">'Chromaticity'</span>, [1 1;1 2], FamilyNameCell{i}, DeviceListCell{i}, <span class="string">'Numeric'</span>, InputFlags{:}, varargin{:});
0218         <span class="keyword">catch</span>
0219             fprintf(<span class="string">'   Could not find a chromaticity response matrix file, so using the model (%s).\n'</span>, FamilyNameCell{i});
0220             M = <a href="measchroresp.html" class="code" title="function [Rmat, OutputFileName] = measchroresp(varargin)">measchroresp</a>(FamilyNameCell{i}, DeviceListCell{i}, <span class="string">'Model'</span>, <span class="string">'Numeric'</span>, InputFlags{:}, varargin{:});
0221             <span class="comment">%M = measrespmat('Chromaticity', [1 1;1 2], FamilyNameCell{i}, DeviceListCell{i}, 'Model', 'Numeric', InputFlags{:}, varargin{:});</span>
0222             FileName = <span class="string">''</span>;
0223         <span class="keyword">end</span>
0224         ChromaticityMatrix = [ChromaticityMatrix sum(M,2)];
0225     <span class="keyword">else</span>
0226         <span class="keyword">try</span>
0227             [ChromaticityMatrix(1,i), FileName] = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(<span class="string">'Chromaticity'</span>, [1 1;1 2], FamilyNameCell{i}, DeviceListCell{i}, <span class="string">'Struct'</span>, InputFlags{:}, varargin{:});
0228             <span class="comment">%ChromaticityMatrix(1,i).Data = sum(ChromaticityMatrix(1,i).Data,2);</span>
0229             <span class="comment">%ChromaticityMatrix(1,i).ActuatorDelta = mean(ChromaticityMatrix(1,i).ActuatorDelta,1);</span>
0230             <span class="comment">%ChromaticityMatrix(1,i).Actuator.Data = mean(ChromaticityMatrix(1,i).Actuator.Data,1);</span>
0231         <span class="keyword">catch</span>
0232             fprintf(<span class="string">'   Could not find a chromaticity response matrix file, so using the model (%s).\n'</span>, FamilyNameCell{i});
0233             ChromaticityMatrix(1,i) = <a href="measchroresp.html" class="code" title="function [Rmat, OutputFileName] = measchroresp(varargin)">measchroresp</a>(FamilyNameCell{i}, DeviceListCell{i}, <span class="string">'Model'</span>, <span class="string">'Struct'</span>, InputFlags{:}, varargin{:});
0234             FileName = <span class="string">''</span>;
0235         <span class="keyword">end</span>
0236     <span class="keyword">end</span>
0237 <span class="keyword">end</span>
0238</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>