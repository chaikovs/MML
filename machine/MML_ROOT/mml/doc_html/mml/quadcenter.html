<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of quadcenter</title>
  <meta name="keywords" content="quadcenter">
  <meta name="description" content="QUADCENTER - Measure the magnet center of a quadrupole magnet">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; quadcenter.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>quadcenter
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>QUADCENTER - Measure the magnet center of a quadrupole magnet</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">QUADCENTER - Measure the magnet center of a quadrupole magnet
  [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)
                     or
  [QMS1, QMS2] = quadcenter(QMSstructure, FigureHandle)

  Finds the center of an individual quadrupole magnet.
  The data is automatically appended to quadcenter.log and 
  saved to an individual mat file named by family, sector, and element number

  INPUTS 
  1. QuadFamily  = Family name
  2. QuadDev     = Device list for quadrupole family
  3. XYPlane     = 0 -&gt; both horizontal and vertical {default}
                   1 -&gt; horizontal only
                   2 -&gt; vertical only 
  4. FigureHandle can be a figure handle, a vector of 4 axes handles 
                 (used by quadplot), or zero for no plots

  The QuadFamily and QuadDev input get converted to a QMSstructure using quadcenterinit.  
  One can also directly input this data structure.
  QMSstructure = 
         QuadFamily: Quadrupole family name, like 'QF'
            QuadDev: Quadrupole device, like [7 1]
          QuadDelta: Modulation amplitude in the quadrupole, like 1
          QuadPlane: Horizontal (1) or vertical (2) plane
         CorrFamily: Corrector magnet family, like 'HCM'
        CorrDevList: Corrector magnet(s) using to vary the orbit in the quadrupole, like [7 1]
          CorrDelta: Maximum change in the corrector(s), like 0.5000
          BPMFamily: BPM family name, like 'BPMx'
             BPMDev: BPM device next to the quadrupole, like [7 1]
         BPMDevList: BPM device list used calculate the center and for orbit correction ([nx2 array])
   ModulationMethod: Method for changing the quadrupole
                         'bipolar' changes the quadrupole by +/- QuadDelta on each step
                         'unipolar' changes the quadrupole from 0 to QuadDelta on each step
                         'sweep' moves the quadrupole by QuadDelta at each step.  This allows for
                                 staying on a given hysteresis branch.
     NumberOfPoints: Number of points, like 3
      DataDirectory: Directory to store the results.  Leave this field out or '.' will put the data
                         in the present directory.
       QuadraticFit: 0 = linear fit, else quadratic fit  (used by quadplot)
      OutlierFactor: if abs(data - fit) &gt; OutlierFactor, then remove that BPM from the center calculation [mm] (used by quadplot)
         ExtraDelay: Extra delay added before reading the BPMs [seconds] {optional}

  OUTPUTS
  The QMSstructure input structure will get the following output fields appended to it.  
  This structure will be output as well as saved to a file which is named based on the 
  sector, quadrupole family name, and device number.  A log file will also be updated.
  QMSstructure = 
          OldCenter: Old quadrupole center (from getoffsetorbit)
                 x1: horizonal data at quadrupole value #1
                 x2: horizonal data at quadrupole value #2
                 y1: vertical data at quadrupole value #1
                 y2: vertical data at quadrupole value #2
               Xerr: Horizonal BPM starting error
               Yerr: Vertical  BPM starting error
          TimeStamp: Time stamp as output by clock (6 element vector)
          CreatedBy: 'quadcenter'
      QMS.BPMStatus: Status of the BPMs
         QMS.BPMSTD: Standard deviation of the BPMs (from getsigma)
             Center: Mean of the BPM center calculations
          CenterSTD: Standard deviation of the BPM center calculations 
  For two planes, QMS1 is the horizontal and QMS2 is the vertical.  When only finding
  one plane, only the first output is used.  For multiple magnets, the output is a column
  vector containing the quadrupole center. 

  NOTE
  1. It is a good idea to have the global orbit reasonable well corrected at the start
  2. If the quadrupole modulation system is not a simple device with one family name then
     edit the setquad function (machine specific).
  3. For the new BPM offsets to take effect, they must be loaded into the main AO data structure. 
  4. This program changes the MML warning level to -2 -&gt; Dialog Box
     That way the measurement can be salvaged if something goes wrong

  Machine specific setup:
  1. setquad and getquad must exist for setting and getting the quadrupole current.
     These function are often machine dependent.

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>	FAMILY2STATUS - Returns the device status</li><li><a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>	GETAM - Gets monitor channels</li><li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getfamilylist.html" class="code" title="function  [Families, AO] = getfamilylist(OutputFlag)">getfamilylist</a>	GETFAMILYLIST - Returns a list of all the family names</li><li><a href="getlist.html" class="code" title="function DeviceList = getlist(varargin)">getlist</a>	GETLIST - Returns Device List for a Family</li><li><a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>	GETMODE - Returns the present family mode ('Online', 'Simulator', 'Manual', 'Special', etc)</li><li><a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>	GETOFFSET - Returns the offset values for a family</li><li><a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>	GETRESPMAT - Get response matrix data from a file</li><li><a href="getsigma.html" class="code" title="function [Data, FileName] = getsigma(varargin)">getsigma</a>	GETSIGMA - Return the standard deviation in the monitor for a family</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>	GETTUNE - Returns the betatron tunes</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>	ISMEMBEROF - Returns turn if the membership information of a family (cell of strings)</li><li><a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>	MAXSP - Maximum value of the setpoint</li><li><a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>	MINSP - Minimum value of the setpoint</li><li><a href="quadcenter.html" class="code" title="function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)">quadcenter</a>	QUADCENTER - Measure the magnet center of a quadrupole magnet</li><li><a href="quadcenterinit.html" class="code" title="function QMS = quadcenterinit(QuadFamily, QuadDev, QuadPlane)">quadcenterinit</a>	QMS = quadcenterinit(Family, Device, QuadPlane)</li><li><a href="quadplot.html" class="code" title="function [QMS, WarningString] = quadplot(Input1, FigureHandle, sigmaBPM)">quadplot</a>	QUADPLOT - Plots quadrupole centering data</li><li><a href="setfamilydata.html" class="code" title="function setfamilydata(Data, Family, Field1, Field2, DeviceList)">setfamilydata</a>	SETFAMILYDATA - Sets data associated with accelerator control</li><li><a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>	SETSP - Makes an absolute setpoint change to the 'Setpoint' field</li><li><a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>	STEPSP - Step the setpoint for family</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="quadcenter.html" class="code" title="function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)">quadcenter</a>	QUADCENTER - Measure the magnet center of a quadrupole magnet</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)</a>
0002 <span class="comment">%QUADCENTER - Measure the magnet center of a quadrupole magnet</span>
0003 <span class="comment">%  [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)</span>
0004 <span class="comment">%                     or</span>
0005 <span class="comment">%  [QMS1, QMS2] = quadcenter(QMSstructure, FigureHandle)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  Finds the center of an individual quadrupole magnet.</span>
0008 <span class="comment">%  The data is automatically appended to quadcenter.log and</span>
0009 <span class="comment">%  saved to an individual mat file named by family, sector, and element number</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%  INPUTS</span>
0012 <span class="comment">%  1. QuadFamily  = Family name</span>
0013 <span class="comment">%  2. QuadDev     = Device list for quadrupole family</span>
0014 <span class="comment">%  3. XYPlane     = 0 -&gt; both horizontal and vertical {default}</span>
0015 <span class="comment">%                   1 -&gt; horizontal only</span>
0016 <span class="comment">%                   2 -&gt; vertical only</span>
0017 <span class="comment">%  4. FigureHandle can be a figure handle, a vector of 4 axes handles</span>
0018 <span class="comment">%                 (used by quadplot), or zero for no plots</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%  The QuadFamily and QuadDev input get converted to a QMSstructure using quadcenterinit.</span>
0021 <span class="comment">%  One can also directly input this data structure.</span>
0022 <span class="comment">%  QMSstructure =</span>
0023 <span class="comment">%         QuadFamily: Quadrupole family name, like 'QF'</span>
0024 <span class="comment">%            QuadDev: Quadrupole device, like [7 1]</span>
0025 <span class="comment">%          QuadDelta: Modulation amplitude in the quadrupole, like 1</span>
0026 <span class="comment">%          QuadPlane: Horizontal (1) or vertical (2) plane</span>
0027 <span class="comment">%         CorrFamily: Corrector magnet family, like 'HCM'</span>
0028 <span class="comment">%        CorrDevList: Corrector magnet(s) using to vary the orbit in the quadrupole, like [7 1]</span>
0029 <span class="comment">%          CorrDelta: Maximum change in the corrector(s), like 0.5000</span>
0030 <span class="comment">%          BPMFamily: BPM family name, like 'BPMx'</span>
0031 <span class="comment">%             BPMDev: BPM device next to the quadrupole, like [7 1]</span>
0032 <span class="comment">%         BPMDevList: BPM device list used calculate the center and for orbit correction ([nx2 array])</span>
0033 <span class="comment">%   ModulationMethod: Method for changing the quadrupole</span>
0034 <span class="comment">%                         'bipolar' changes the quadrupole by +/- QuadDelta on each step</span>
0035 <span class="comment">%                         'unipolar' changes the quadrupole from 0 to QuadDelta on each step</span>
0036 <span class="comment">%                         'sweep' moves the quadrupole by QuadDelta at each step.  This allows for</span>
0037 <span class="comment">%                                 staying on a given hysteresis branch.</span>
0038 <span class="comment">%     NumberOfPoints: Number of points, like 3</span>
0039 <span class="comment">%      DataDirectory: Directory to store the results.  Leave this field out or '.' will put the data</span>
0040 <span class="comment">%                         in the present directory.</span>
0041 <span class="comment">%       QuadraticFit: 0 = linear fit, else quadratic fit  (used by quadplot)</span>
0042 <span class="comment">%      OutlierFactor: if abs(data - fit) &gt; OutlierFactor, then remove that BPM from the center calculation [mm] (used by quadplot)</span>
0043 <span class="comment">%         ExtraDelay: Extra delay added before reading the BPMs [seconds] {optional}</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%  OUTPUTS</span>
0046 <span class="comment">%  The QMSstructure input structure will get the following output fields appended to it.</span>
0047 <span class="comment">%  This structure will be output as well as saved to a file which is named based on the</span>
0048 <span class="comment">%  sector, quadrupole family name, and device number.  A log file will also be updated.</span>
0049 <span class="comment">%  QMSstructure =</span>
0050 <span class="comment">%          OldCenter: Old quadrupole center (from getoffsetorbit)</span>
0051 <span class="comment">%                 x1: horizonal data at quadrupole value #1</span>
0052 <span class="comment">%                 x2: horizonal data at quadrupole value #2</span>
0053 <span class="comment">%                 y1: vertical data at quadrupole value #1</span>
0054 <span class="comment">%                 y2: vertical data at quadrupole value #2</span>
0055 <span class="comment">%               Xerr: Horizonal BPM starting error</span>
0056 <span class="comment">%               Yerr: Vertical  BPM starting error</span>
0057 <span class="comment">%          TimeStamp: Time stamp as output by clock (6 element vector)</span>
0058 <span class="comment">%          CreatedBy: 'quadcenter'</span>
0059 <span class="comment">%      QMS.BPMStatus: Status of the BPMs</span>
0060 <span class="comment">%         QMS.BPMSTD: Standard deviation of the BPMs (from getsigma)</span>
0061 <span class="comment">%             Center: Mean of the BPM center calculations</span>
0062 <span class="comment">%          CenterSTD: Standard deviation of the BPM center calculations</span>
0063 <span class="comment">%  For two planes, QMS1 is the horizontal and QMS2 is the vertical.  When only finding</span>
0064 <span class="comment">%  one plane, only the first output is used.  For multiple magnets, the output is a column</span>
0065 <span class="comment">%  vector containing the quadrupole center.</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%  NOTE</span>
0068 <span class="comment">%  1. It is a good idea to have the global orbit reasonable well corrected at the start</span>
0069 <span class="comment">%  2. If the quadrupole modulation system is not a simple device with one family name then</span>
0070 <span class="comment">%     edit the setquad function (machine specific).</span>
0071 <span class="comment">%  3. For the new BPM offsets to take effect, they must be loaded into the main AO data structure.</span>
0072 <span class="comment">%  4. This program changes the MML warning level to -2 -&gt; Dialog Box</span>
0073 <span class="comment">%     That way the measurement can be salvaged if something goes wrong</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%  Machine specific setup:</span>
0076 <span class="comment">%  1. setquad and getquad must exist for setting and getting the quadrupole current.</span>
0077 <span class="comment">%     These function are often machine dependent.</span>
0078 <span class="comment">%</span>
0079 <span class="comment">%  Written by Greg Portmann</span>
0080 
0081 
0082 
0083 <span class="comment">% Extra delay can be written over by the QMS.ExtraDelay field.  If this</span>
0084 <span class="comment">% does not exist, then the value below is used.</span>
0085 ExtraDelay = 0; 
0086 
0087 
0088 <span class="comment">% Set the waitflag on power supply setpoints to wait for fresh data from the BPMs</span>
0089 WaitFlag = -2; 
0090 
0091 
0092 <span class="comment">% Record the tune at each point.</span>
0093 <span class="comment">% In simulate mode the tunes are always saved unless the TUNE family does not exist.</span>
0094 GetTuneFlag = 0;
0095 
0096 
0097 <span class="comment">% Inputs</span>
0098 QMS1 = [];
0099 QMS2 = [];
0100 <span class="keyword">if</span> nargin &lt; 1
0101     FamilyList = <a href="getfamilylist.html" class="code" title="function  [Families, AO] = getfamilylist(OutputFlag)">getfamilylist</a>;
0102     [tmp,i] = <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(FamilyList,<span class="string">'QUAD'</span>);
0103     <span class="keyword">if</span> ~isempty(i)
0104         FamilyList = FamilyList(i,:);
0105     <span class="keyword">end</span>
0106     <span class="keyword">if</span> size(FamilyList,1) == 1
0107         QuadFamily = deblank(FamilyList);
0108     <span class="keyword">else</span>
0109         [i,ok] = listdlg(<span class="string">'PromptString'</span>, <span class="string">'Select a quadrupole family:'</span>, <span class="keyword">...</span>
0110             <span class="string">'SelectionMode'</span>, <span class="string">'single'</span>, <span class="keyword">...</span>
0111             <span class="string">'ListString'</span>, FamilyList);
0112         <span class="keyword">if</span> ok == 0
0113             <span class="keyword">return</span>
0114         <span class="keyword">else</span>
0115             QuadFamily = deblank(FamilyList(i,:));
0116         <span class="keyword">end</span>
0117     <span class="keyword">end</span>
0118 <span class="keyword">end</span>
0119 
0120 <span class="keyword">if</span> isstruct(QuadFamily)
0121     QMS = QuadFamily;
0122     XYPlane = QMS.QuadPlane;
0123     <span class="keyword">if</span> QMS.QuadPlane == 1
0124         QMS_Horizontal = QMS;
0125         QMS_Vertical   = <a href="quadcenterinit.html" class="code" title="function QMS = quadcenterinit(QuadFamily, QuadDev, QuadPlane)">quadcenterinit</a>(QMS.QuadFamily, QMS.QuadDev, 2);
0126         QMS_Vertical.CorrectOrbit = QMS.CorrectOrbit;
0127     <span class="keyword">elseif</span> QMS.QuadPlane == 2
0128         QMS_Horizontal = <a href="quadcenterinit.html" class="code" title="function QMS = quadcenterinit(QuadFamily, QuadDev, QuadPlane)">quadcenterinit</a>(QMS.QuadFamily, QMS.QuadDev, 1);
0129         QMS_Horizontal.CorrectOrbit = QMS.CorrectOrbit;
0130         QMS_Vertical = QMS;
0131     <span class="keyword">else</span>
0132         error(<span class="string">'QMS.QuadPlane must be 1 or 2 when using a QMS structure input'</span>);
0133     <span class="keyword">end</span>
0134     <span class="keyword">if</span> nargin &gt;= 2 
0135         FigureHandle = QuadDev;
0136     <span class="keyword">else</span>
0137         FigureHandle = [];
0138     <span class="keyword">end</span>
0139     QuadFamily = QMS.QuadFamily;
0140     QuadDev    = QMS.QuadDev;
0141 <span class="keyword">else</span>
0142     <span class="keyword">if</span> ~<a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(QuadFamily)
0143         error(sprintf(<span class="string">'Quadrupole family %s does not exist.  Make sure the middle layer had been initialized properly.'</span>,QuadFamily));
0144     <span class="keyword">end</span>
0145     <span class="keyword">if</span> nargin &lt; 2
0146         QuadDev = editlist(<a href="getlist.html" class="code" title="function DeviceList = getlist(varargin)">getlist</a>(QuadFamily),QuadFamily,zeros(length(<a href="getlist.html" class="code" title="function DeviceList = getlist(varargin)">getlist</a>(QuadFamily)),1));
0147     <span class="keyword">end</span>
0148     <span class="keyword">if</span> nargin &lt; 3
0149         ButtonNumber = menu(<span class="string">'Which Plane?'</span>, <span class="string">'Both'</span>,<span class="string">'Horizontal Only'</span>,<span class="string">'Vertical Only'</span>,<span class="string">'Cancel'</span>);  
0150         drawnow;
0151         <span class="keyword">switch</span> ButtonNumber
0152             <span class="keyword">case</span> 1
0153                 XYPlane = 0;
0154             <span class="keyword">case</span> 2
0155                 XYPlane = 1;
0156             <span class="keyword">case</span> 3
0157                 XYPlane = 2;
0158             <span class="keyword">otherwise</span>
0159                 fprintf(<span class="string">'   quadcenter cancelled\n'</span>);
0160                 <span class="keyword">return</span>
0161         <span class="keyword">end</span>
0162     <span class="keyword">end</span>
0163     <span class="keyword">if</span> nargin &lt; 4 
0164         FigureHandle = [];
0165     <span class="keyword">end</span>
0166     
0167     <span class="comment">% If QuadDev is a vector</span>
0168     <span class="keyword">if</span> size(QuadDev,1) &gt; 1
0169         <span class="keyword">for</span> i = 1:size(QuadDev,1)
0170             <span class="keyword">if</span> XYPlane == 0
0171                 [Q1, Q2] = <a href="quadcenter.html" class="code" title="function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)">quadcenter</a>(QuadFamily, QuadDev(i,:), XYPlane, FigureHandle);
0172                 QMS1(i,1) = Q1.Center;
0173                 QMS2(i,1) = Q2.Center;
0174             <span class="keyword">else</span>
0175                 [Q1] = <a href="quadcenter.html" class="code" title="function [QMS1, QMS2] = quadcenter(QuadFamily, QuadDev, XYPlane, FigureHandle)">quadcenter</a>(QuadFamily, QuadDev(i,:), XYPlane, FigureHandle);
0176                 QMS1(i,1) = Q1.Center;
0177             <span class="keyword">end</span>
0178         <span class="keyword">end</span>
0179         <span class="keyword">return</span>
0180     <span class="keyword">end</span>
0181     
0182     
0183     <span class="comment">% Get QMS structure</span>
0184     QMS_Horizontal = <a href="quadcenterinit.html" class="code" title="function QMS = quadcenterinit(QuadFamily, QuadDev, QuadPlane)">quadcenterinit</a>(QuadFamily, QuadDev, 1);
0185     QMS_Vertical   = <a href="quadcenterinit.html" class="code" title="function QMS = quadcenterinit(QuadFamily, QuadDev, QuadPlane)">quadcenterinit</a>(QuadFamily, QuadDev, 2);
0186 <span class="keyword">end</span>
0187 
0188 
0189 <span class="comment">% Change the MML warning level to -2 -&gt; Dialog Box</span>
0190 <span class="comment">% That way the measurement can be salvaged if something goes wrong</span>
0191 ErrorWarningLevel = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'ErrorWarningLevel'</span>);
0192 <a href="setfamilydata.html" class="code" title="function setfamilydata(Data, Family, Field1, Field2, DeviceList)">setfamilydata</a>(-2, <span class="string">'ErrorWarningLevel'</span>);
0193 
0194 
0195 <span class="comment">% Initialize variables</span>
0196 HCMFamily  = QMS_Horizontal.CorrFamily;
0197 HCMDev     = QMS_Horizontal.CorrDevList;
0198 DelHCM     = QMS_Horizontal.CorrDelta;
0199 BPMxFamily = QMS_Horizontal.BPMFamily;
0200 BPMxDev    = QMS_Horizontal.BPMDev;
0201 BPMxDevList= QMS_Horizontal.BPMDevList;
0202 
0203 VCMFamily  = QMS_Vertical.CorrFamily;
0204 VCMDev     = QMS_Vertical.CorrDevList;
0205 DelVCM     = QMS_Vertical.CorrDelta;
0206 BPMyFamily = QMS_Vertical.BPMFamily;
0207 BPMyDev    = QMS_Vertical.BPMDev;
0208 BPMyDevList= QMS_Vertical.BPMDevList;
0209 
0210 Xcenter = NaN;
0211 Ycenter = NaN;
0212 
0213 
0214 <span class="comment">% Check status for BPMs next to the quadrupole and correctors used in orbit correction</span>
0215 HCMStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(HCMFamily, HCMDev);
0216 
0217 <span class="keyword">if</span> ~isnan(HCMStatus) &amp;&amp; any(HCMStatus==0) 
0218     error(sprintf(<span class="string">'A %s corrector used in finding the center has a bad status'</span>, HCMFamily));
0219 <span class="keyword">end</span>
0220 VCMStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(VCMFamily, VCMDev);
0221 <span class="keyword">if</span> ~isnan(VCMStatus) &amp;&amp; any(VCMStatus==0) 
0222     error(sprintf(<span class="string">'A %s corrector used in finding the center has a bad status'</span>, VCMFamily));
0223 <span class="keyword">end</span>
0224 BPMxStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(BPMxFamily, BPMxDev);
0225 <span class="keyword">if</span> ~isnan(BPMxStatus) &amp;&amp; any(BPMxStatus==0) 
0226     error(sprintf(<span class="string">'The %s monitor next to the quadrupole has bad status'</span>, BPMxFamily));
0227 <span class="keyword">end</span>
0228 BPMyStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(BPMxFamily, BPMxDev);
0229 <span class="keyword">if</span> ~isnan(BPMyStatus) &amp;&amp; any(BPMyStatus==0) 
0230     error(sprintf(<span class="string">'The %s monitor next to the quadrupole has bad status'</span>, BPMxFamily));
0231 <span class="keyword">end</span>
0232 
0233     
0234 <span class="comment">% Record start directory</span>
0235 DirStart = pwd;
0236 
0237 <span class="comment">% Get the current offset orbit</span>
0238 Xoffset = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMxFamily, BPMxDev);
0239 Yoffset = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMyFamily, BPMyDev);
0240 XoffsetOld = Xoffset;
0241 YoffsetOld = Yoffset;
0242 
0243 <span class="comment">% Starting correctors</span>
0244 HCM00 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMDev);
0245 VCM00 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMDev);
0246 
0247 
0248 <span class="comment">% % Global orbit correction</span>
0249 <span class="comment">% CM = getsp('HCM','struct');</span>
0250 <span class="comment">% BPM = getx('struct');</span>
0251 <span class="comment">% BPMWeight = ones(size(BPM.DeviceList,1),1);</span>
0252 <span class="comment">% i = findrowindex(BPMxDev, BPM.DeviceList);</span>
0253 <span class="comment">%</span>
0254 <span class="comment">% x = getoffset('BPMx');</span>
0255 <span class="comment">% x = .1 * BPMWeight;</span>
0256 <span class="comment">% %x(i) = -.2;</span>
0257 <span class="comment">% BPMWeight(i) = 100;</span>
0258 <span class="comment">%</span>
0259 <span class="comment">% setorbit(x, BPM, CM, 3, 20, BPMWeight, 'Display');</span>
0260 
0261 
0262 <span class="comment">% Correct orbit to the old offsets first</span>
0263 <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0264     fprintf(<span class="string">'   Correcting the orbit to the old horizontal center of %s(%d,%d)\n'</span>, QuadFamily, QuadDev); pause(0);
0265     <span class="keyword">if</span> ~isnan(Xoffset)
0266         <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0267     <span class="keyword">end</span>
0268 <span class="keyword">end</span>
0269 <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0270     fprintf(<span class="string">'   Correcting the orbit to the old vertical center of %s(%d,%d)\n'</span>, QuadFamily, QuadDev); pause(0);
0271     <span class="keyword">if</span> ~isnan(Yoffset)
0272         <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0273     <span class="keyword">end</span>
0274 <span class="keyword">end</span>
0275 
0276 <span class="comment">%OrbitCorrection(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev);</span>
0277 <span class="comment">%OrbitCorrection(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev);</span>
0278 
0279 
0280 
0281 <span class="comment">% Algorithm</span>
0282 <span class="comment">% 1.  Change the horizontal orbit in the quad</span>
0283 <span class="comment">% 2.  Correct the vertical orbit</span>
0284 <span class="comment">% 3.  Record the orbit</span>
0285 <span class="comment">% 4.  Step the quad</span>
0286 <span class="comment">% 5.  Record the orbit</span>
0287 
0288 
0289 <span class="comment">% FIND HORIZONTAL OFFSET</span>
0290 <span class="keyword">if</span> XYPlane==0 || XYPlane==1    
0291     FigureHandle = 1;
0292         
0293     <span class="comment">% BPM processor delay</span>
0294     <span class="keyword">if</span> isfield(QMS_Horizontal, <span class="string">'ExtraDelay'</span>) 
0295         ExtraDelay = QMS_Horizontal.ExtraDelay;
0296     <span class="keyword">end</span>
0297 
0298     <span class="comment">% Get mode</span>
0299     Mode = <a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(QMS_Horizontal.QuadFamily);
0300     
0301     <span class="comment">% Record starting point</span>
0302     QUAD0 = getquad(QMS_Horizontal);
0303     HCM0 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMDev);
0304     VCM0 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMDev);
0305     Xerr = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDev) - Xoffset;
0306     Yerr = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDev) - Yoffset;
0307     xstart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0308     ystart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0309 
0310     QMS_Horizontal.Orbit0 = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList, <span class="string">'Struct'</span>);
0311     
0312     [tmp, iNotFound] = findrowindex(BPMxDev, BPMxDevList);
0313     <span class="keyword">if</span> ~isempty(iNotFound)
0314         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM00, HCMDev, 0);
0315         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM00, VCMDev, 0);
0316         error(<span class="string">'BPM at the quadrupole not found in the BPM device list'</span>);
0317     <span class="keyword">end</span>
0318       
0319     DelQuad = QMS_Horizontal.QuadDelta;
0320     N = abs(round(QMS_Horizontal.NumberOfPoints));
0321     <span class="keyword">if</span> N &lt; 1
0322         error(<span class="string">'The number of points must be 2 or more.'</span>);
0323     <span class="keyword">end</span>
0324     
0325    
0326     fprintf(<span class="string">'   Finding horizontal center of %s(%d,%d)\n'</span>, QuadFamily, QuadDev);
0327     fprintf(<span class="string">'   Starting orbit error: %s(%d,%d)=%f , %s(%d,%d)=%f %s\n'</span>, BPMxFamily, BPMxDev, Xerr, BPMyFamily, BPMyDev, Yerr, QMS_Horizontal.Orbit0.UnitsString);
0328     <span class="keyword">if</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'bipolar'</span>)
0329         fprintf(<span class="string">'   Quadrupole starting current = %.3f, modulate by +/- %.3f\n'</span>, getquad(QMS_Horizontal), DelQuad);
0330     <span class="keyword">elseif</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'unipolar'</span>)
0331         fprintf(<span class="string">'   Quadrupole starting current = %.3f, modulate by 0 to %.3f\n'</span>, getquad(QMS_Horizontal), DelQuad);
0332     <span class="keyword">elseif</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'sweep'</span>)
0333         fprintf(<span class="string">'   Quadrupole starting current = %.3f, sweep by %.3f on each step\n'</span>, getquad(QMS_Horizontal), DelQuad);        
0334     <span class="keyword">else</span>
0335         <span class="comment">% Reset or error</span>
0336         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM00, HCMDev, 0);
0337         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM00, VCMDev, 0);
0338         setquad(QMS_Horizontal, QUAD0, 0);
0339         cd(DirStart);
0340         error(<span class="string">'Unknown ModulationMethod in the QMS input structure (likely a problem with quadcenterinit)'</span>);
0341     <span class="keyword">end</span>
0342     pause(0);
0343     
0344     <span class="comment">% Establish a hysteresis loop</span>
0345     <span class="keyword">if</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'bipolar'</span>)
0346         fprintf(<span class="string">'   Establishing a hysteresis loop on the quadrupole (bi-polar case)\n'</span>); pause(0);
0347         setquad(QMS_Horizontal, DelQuad+QUAD0, -1);
0348         setquad(QMS_Horizontal,-DelQuad+QUAD0, -1);
0349         setquad(QMS_Horizontal, DelQuad+QUAD0, -1);
0350         setquad(QMS_Horizontal,-DelQuad+QUAD0, -1);
0351         setquad(QMS_Horizontal,         QUAD0, -1);
0352     <span class="keyword">elseif</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'unipolar'</span>)
0353         fprintf(<span class="string">'   Establishing a hysteresis loop on the quadrupole (uni-polar case)\n'</span>); pause(0);
0354         setquad(QMS_Horizontal, DelQuad+QUAD0, -1);
0355         setquad(QMS_Horizontal,         QUAD0, -1);
0356         setquad(QMS_Horizontal, DelQuad+QUAD0, -1);
0357         setquad(QMS_Horizontal,         QUAD0, -1);
0358     <span class="keyword">end</span>
0359     
0360     
0361     <span class="comment">% Corrector step size</span>
0362     CorrStep = 2 * DelHCM / (N-1);
0363 
0364     
0365     <span class="comment">% Start the corrector a little lower first for hysteresis reasons</span>
0366     <span class="comment">%stepsp(HCMFamily, -1.0*DelHCM, HCMDev, -1);</span>
0367     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(HCMFamily, -1.2*DelHCM, HCMDev, -1);
0368     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(HCMFamily,   .2*DelHCM, HCMDev, WaitFlag); 
0369 
0370     
0371     <span class="comment">% Main horizontal data loop</span>
0372     clear DCCT
0373     <span class="keyword">for</span> i = 1:N <span class="comment">% Loop of corrector steps</span>
0374         <span class="comment">% Step the horizontal orbit</span>
0375         <span class="keyword">if</span> i ~= 1
0376             <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(HCMFamily, CorrStep, HCMDev, WaitFlag);
0377         <span class="keyword">end</span>
0378         
0379         fprintf(<span class="string">'   %d. %s(%d,%d) sp/am = %+.4f/%+.4f, %s(%d,%d) = %+.5f %s\n'</span>, i, HCMFamily, HCMDev(1,:), <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMDev(1,:)), <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(HCMFamily, HCMDev(1,:)),  BPMxFamily, BPMxDev, <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDev), QMS_Horizontal.Orbit0.UnitsString); pause(0);  
0380         
0381         <span class="comment">% If correcting the orbit, then recorrect the vertical center now</span>
0382         <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0383            <span class="comment">% Correct the vertical orbit</span>
0384            <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0385         <span class="keyword">end</span>
0386         
0387         <span class="keyword">if</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'sweep'</span>)
0388             <span class="comment">% One directional sweep of the quadrupole</span>
0389             sleep(ExtraDelay);
0390             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0391             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0392             x0(:,i) = x1(:,i);
0393             y0(:,i) = y1(:,i);
0394            
0395             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0396                 QMS_Horizontal.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0397             <span class="keyword">end</span>
0398 
0399             setquad(QMS_Horizontal, i*DelQuad+QUAD0, WaitFlag);
0400             sleep(ExtraDelay);
0401 
0402             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0403             <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0404                 <span class="comment">% Correct the vertical orbit</span>
0405                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0406                 sleep(ExtraDelay);
0407             <span class="keyword">end</span>
0408 
0409             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0410             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0411             
0412             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0413                 QMS_Horizontal.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0414             <span class="keyword">end</span>
0415    
0416         <span class="keyword">elseif</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'bipolar'</span>)
0417             <span class="comment">% Modulate the quadrupole</span>
0418             sleep(ExtraDelay);
0419             x0(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0420             y0(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0421             setquad(QMS_Horizontal, DelQuad+QUAD0, WaitFlag);
0422             sleep(ExtraDelay);
0423 
0424             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0425             <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0426                 <span class="comment">% Correct the vertical orbit</span>
0427                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0428                 sleep(ExtraDelay);
0429             <span class="keyword">end</span>
0430 
0431             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0432             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0433             
0434             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0435                 QMS_Horizontal.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0436             <span class="keyword">end</span>
0437 
0438             setquad(QMS_Horizontal,-DelQuad+QUAD0, WaitFlag);
0439             sleep(ExtraDelay);
0440 
0441             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0442             <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0443                 <span class="comment">% Correct the vertical orbit</span>
0444                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0445                 sleep(ExtraDelay);
0446             <span class="keyword">end</span>
0447 
0448             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0449             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0450             
0451             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0452                 QMS_Horizontal.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0453             <span class="keyword">end</span>
0454 
0455             setquad(QMS_Horizontal, QUAD0, WaitFlag);
0456         
0457         <span class="keyword">elseif</span> strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'unipolar'</span>)
0458             <span class="comment">% Modulate the quadrupole</span>
0459             sleep(ExtraDelay);
0460             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0461             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0462             x0(:,i) = x1(:,i);
0463             y0(:,i) = y1(:,i);
0464             
0465             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0466                 QMS_Horizontal.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0467             <span class="keyword">end</span>
0468 
0469             setquad(QMS_Horizontal, DelQuad+QUAD0, WaitFlag);
0470             sleep(ExtraDelay);
0471 
0472             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0473             <span class="keyword">if</span> strcmpi(QMS_Horizontal.CorrectOrbit, <span class="string">'yes'</span>)
0474                 <span class="comment">% Correct the vertical orbit</span>
0475                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Yoffset, BPMyFamily, BPMyDev, VCMFamily, VCMDev, 4);
0476                 sleep(ExtraDelay);
0477             <span class="keyword">end</span>
0478 
0479             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0480             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0481             
0482             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0483                 QMS_Horizontal.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0484             <span class="keyword">end</span>
0485 
0486             setquad(QMS_Horizontal, QUAD0, WaitFlag);
0487         <span class="keyword">end</span>
0488 
0489         DCCT(i) = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>;
0490     <span class="keyword">end</span>
0491 
0492     <span class="comment">% Get the horizontal data filename and save the data</span>
0493     <span class="comment">% Append data and time</span>
0494     FileName = [<span class="string">'s'</span>, num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), <span class="string">'h1'</span>];
0495     FileName = appendtimestamp(FileName, clock);
0496 
0497     <span class="comment">% Use a version number</span>
0498     <span class="comment">%i=1;</span>
0499     <span class="comment">%FileName = ['s', num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), 'h', num2str(i)];</span>
0500     <span class="comment">%while exist([FileName,'.mat'], 'file')</span>
0501     <span class="comment">%    i = i + 1;</span>
0502     <span class="comment">%    FileName = ['s', num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), 'h', num2str(i)];</span>
0503     <span class="comment">%end</span>
0504     
0505     QMS = QMS_Horizontal;
0506     QMS.QuadPlane = 1;
0507     
0508     QMS.OldCenter = Xoffset;
0509     QMS.XOffsetOld = XoffsetOld;
0510     QMS.YOffsetOld = YoffsetOld;
0511     
0512     QMS.xstart = xstart;
0513     QMS.ystart = ystart;
0514     
0515     QMS.x0 = x0;
0516     QMS.x1 = x1;
0517     QMS.x2 = x2;
0518     QMS.y0 = y0;
0519     QMS.y1 = y1;
0520     QMS.y2 = y2;
0521     QMS.Xerr = Xerr;
0522     QMS.Yerr = Yerr;
0523     QMS.TimeStamp = clock;
0524     QMS.DCCT = DCCT;
0525     QMS.DataDescriptor = <span class="string">'Quadrupole Center'</span>;
0526     QMS.CreatedBy = <span class="string">'quadcenter'</span>;
0527     
0528     <span class="comment">% Get and store the BPM status and standard deviation (to be used by the center calculation routine)</span>
0529     QMS.BPMStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(BPMxFamily, BPMxDevList);
0530     N = getbpmaverages(BPMxDevList);
0531     QMS.BPMSTD = <a href="getsigma.html" class="code" title="function [Data, FileName] = getsigma(varargin)">getsigma</a>(BPMxFamily, BPMxDevList, N);
0532 
0533     <span class="comment">% Set up figures, plot and find horizontal center</span>
0534     <span class="keyword">try</span>
0535         <span class="keyword">if</span> isempty(FigureHandle)
0536             QMS = <a href="quadplot.html" class="code" title="function [QMS, WarningString] = quadplot(Input1, FigureHandle, sigmaBPM)">quadplot</a>(QMS);
0537         <span class="keyword">else</span>
0538             QMS = <a href="quadplot.html" class="code" title="function [QMS, WarningString] = quadplot(Input1, FigureHandle, sigmaBPM)">quadplot</a>(QMS, FigureHandle);
0539         <span class="keyword">end</span>
0540         drawnow;
0541     <span class="keyword">catch</span>
0542         fprintf(<span class="string">'\n%s\n'</span>, lasterr);
0543     <span class="keyword">end</span>
0544     QMS1 = QMS;
0545 
0546     <span class="comment">% Save the horizontal data</span>
0547     <span class="keyword">if</span> isfield(QMS_Horizontal, <span class="string">'DataDirectory'</span>)
0548         [FinalDir, ErrorFlag] = gotodirectory(QMS_Horizontal.DataDirectory);
0549     <span class="keyword">end</span>
0550     QMS.DataDirectory = pwd;
0551     save(FileName, <span class="string">'QMS'</span>);
0552     fprintf(<span class="string">'   Data saved to file %s in directory %s\n\n'</span>, FileName, QMS.DataDirectory);
0553 
0554     <span class="comment">% Output data to file</span>
0555     fid1 = fopen(<span class="string">'quadcenter.log'</span>,<span class="string">'at'</span>);
0556     time=clock;
0557     fprintf(fid1, <span class="string">'%s   %d:%d:%2.0f \n'</span>, date, time(4),time(5),time(6));
0558     fprintf(fid1, <span class="string">'Data saved to file %s (%s)\n'</span>, FileName, QMS.DataDirectory);
0559     fprintf(fid1, <span class="string">'%s(%d,%d) %s(%d,%d) = %f (+/- %f) [%s]\n\n'</span>, QuadFamily, QuadDev, BPMxFamily, BPMxDev, QMS.Center, QMS.CenterSTD, QMS_Horizontal.Orbit0.UnitsString);
0560     fclose(fid1);
0561     cd(DirStart);
0562 
0563     <span class="comment">% Change the offset orbit to the new center so that the vertical plane uses it</span>
0564     Xoffset = QMS.Center;
0565     
0566     <span class="comment">% Restore magnets their starting points (correctors to values after orbit correction)</span>
0567     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM0, HCMDev, WaitFlag);
0568     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM0, VCMDev, WaitFlag);
0569     setquad(QMS_Horizontal, QUAD0, WaitFlag);
0570     
0571     <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0572         <span class="comment">% Print the tune information</span>
0573         fprintf(<span class="string">'   Tune and tune difference for the 1st points in the merit function (QMS.Tune1): \n'</span>);
0574         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune1(1,:));
0575         fprintf(<span class="string">'  Horizontal\n'</span>);
0576         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune1(2,:));
0577         fprintf(<span class="string">'  Vertical\n'</span>);
0578         fprintf(<span class="string">'   ===================================================\n'</span>);
0579         fprintf(<span class="string">'   %8.5f'</span>, diff(QMS.Tune1));
0580         fprintf(<span class="string">'  Difference \n\n'</span>);
0581         
0582         fprintf(<span class="string">'   Tune and tune difference for the 2nd points in the merit function (QMS.Tune2): \n'</span>);
0583         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune2(1,:));
0584         fprintf(<span class="string">'  Horizontal\n'</span>);
0585         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune2(2,:));
0586         fprintf(<span class="string">'  Vertical\n'</span>);
0587         fprintf(<span class="string">'   ===================================================\n'</span>);
0588         fprintf(<span class="string">'   %8.5f'</span>, diff(QMS.Tune2));
0589         fprintf(<span class="string">'  Difference\n\n'</span>);
0590 
0591         dTune1 = diff(QMS.Tune1);
0592         dTune2 = diff(QMS.Tune2);
0593         
0594         <span class="keyword">if</span> any(sign(dTune1/dTune1(1))==-1)
0595             fprintf(<span class="string">'   Tune change sign!!!\n'</span>);            
0596         <span class="keyword">end</span>
0597         
0598         <span class="keyword">if</span> any(abs(dTune1) &lt; .025) || any(abs(dTune2) &lt; .025)
0599             fprintf(<span class="string">'   Horizontal and vertical tunes seem too close.\n'</span>);
0600         <span class="keyword">end</span>
0601     <span class="keyword">end</span>    
0602 <span class="keyword">end</span>
0603 
0604 
0605 
0606 <span class="comment">% FIND VERTICAL OFFSET</span>
0607 <span class="keyword">if</span> XYPlane==0 || XYPlane==2    
0608     FigureHandle = 1;
0609 
0610     <span class="comment">% BPM processor delay</span>
0611     <span class="keyword">if</span> isfield(QMS_Vertical, <span class="string">'ExtraDelay'</span>)
0612         ExtraDelay = QMS_Vertical.ExtraDelay;
0613     <span class="keyword">end</span>
0614 
0615     <span class="comment">% Get mode</span>
0616     Mode = <a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(QMS_Horizontal.QuadFamily);
0617     
0618     <span class="comment">% Record starting point</span>
0619     QUAD0 = getquad(QMS_Vertical);
0620     HCM0 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMDev);
0621     VCM0 = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMDev);
0622     Xerr = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDev) - Xoffset;
0623     Yerr = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDev) - Yoffset;
0624     xstart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0625     ystart = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0626     
0627     QMS_Vertical.Orbit0 = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList, <span class="string">'Struct'</span>);
0628 
0629     [tmp, iNotFound] = findrowindex(BPMyDev, BPMyDevList);
0630     <span class="keyword">if</span> ~isempty(iNotFound)
0631         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM00, HCMDev, 0);
0632         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM00, VCMDev, 0);
0633         error(<span class="string">'BPM at the quadrupole not found in the BPM device list'</span>);
0634     <span class="keyword">end</span>
0635 
0636     DelQuad = QMS_Vertical.QuadDelta;
0637     N = abs(round(QMS_Vertical.NumberOfPoints));
0638     <span class="keyword">if</span> N &lt; 1
0639         error(<span class="string">'The number of points must be 2 or more.'</span>);
0640     <span class="keyword">end</span>
0641 
0642     fprintf(<span class="string">'   Finding vertical center of %s(%d,%d)\n'</span>, QuadFamily, QuadDev);
0643     fprintf(<span class="string">'   Starting orbit error: %s(%d,%d)=%f , %s(%d,%d)=%f %s\n'</span>, BPMxFamily, BPMxDev, Xerr, BPMyFamily, BPMyDev, Yerr, QMS_Vertical.Orbit0.UnitsString);
0644     <span class="keyword">if</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'bipolar'</span>)
0645         fprintf(<span class="string">'   Quadrupole starting current = %.3f, modulate by +/- %.3f\n'</span>, getquad(QMS_Vertical), DelQuad);
0646     <span class="keyword">elseif</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'unipolar'</span>)
0647         fprintf(<span class="string">'   Quadrupole starting current = %.3f, modulate by 0 to %.3f\n'</span>, getquad(QMS_Vertical), DelQuad);
0648     <span class="keyword">elseif</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'sweep'</span>)
0649         fprintf(<span class="string">'   Quadrupole starting current = %.3f, sweep by %.3f on each step\n'</span>, getquad(QMS_Vertical), DelQuad);
0650     <span class="keyword">else</span>
0651         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM00, HCMDev, 0);
0652         <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM00, VCMDev, 0);
0653         setquad(QMS_Vertical, QUAD0, 0);
0654         cd(DirStart);
0655         error(<span class="string">'Unknown ModulationMethod in the QMS input structure (likely a problem with quadcenterinit)'</span>);
0656     <span class="keyword">end</span>
0657     pause(0);
0658     
0659     
0660     <span class="comment">% Establish a hysteresis loop (if not already done, or if the horizontal plane was sweep)</span>
0661     <span class="keyword">if</span> XYPlane == 2 || strcmpi(QMS_Horizontal.ModulationMethod, <span class="string">'sweep'</span>)
0662         <span class="keyword">if</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'bipolar'</span>)
0663             fprintf(<span class="string">'   Establishing a hysteresis loop on the quadrupole (bi-polar case)\n'</span>); pause(0);
0664             setquad(QMS_Vertical, DelQuad+QUAD0, -1);
0665             setquad(QMS_Vertical,-DelQuad+QUAD0, -1);
0666             setquad(QMS_Vertical, DelQuad+QUAD0, -1);
0667             setquad(QMS_Vertical,-DelQuad+QUAD0, -1);
0668             setquad(QMS_Vertical,         QUAD0, -1);
0669         <span class="keyword">elseif</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'unipolar'</span>)
0670             fprintf(<span class="string">'   Establishing a hysteresis loop on the quadrupole (uni-polar case)\n'</span>); pause(0);
0671             setquad(QMS_Vertical, DelQuad+QUAD0, -1);
0672             setquad(QMS_Vertical,         QUAD0, -1);
0673             setquad(QMS_Vertical, DelQuad+QUAD0, -1);
0674             setquad(QMS_Vertical,         QUAD0, -1);
0675         <span class="keyword">end</span>
0676     <span class="keyword">end</span>
0677     
0678 
0679     <span class="comment">% Corrector step size</span>
0680     CorrStep = 2 * DelVCM / (N-1);
0681 
0682     
0683     <span class="comment">% Start the corrector a little lower first for hysteresis reasons</span>
0684     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(VCMFamily, -1.2*DelVCM, VCMDev, -1);
0685     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(VCMFamily,   .2*DelVCM, VCMDev, WaitFlag);
0686 
0687 
0688 <span class="comment">%     Debug</span>
0689 <span class="comment">%     setquad(QMS_Vertical, DelQuad+QUAD0, WaitFlag);</span>
0690 <span class="comment">%     QUAD0 = getquad(QMS_Vertical);</span>
0691 <span class="comment">%     Xstart = getam(BPMxFamily, BPMxDev)</span>
0692     
0693 
0694     clear DCCT
0695     <span class="keyword">for</span> i = 1:N
0696 
0697         <span class="comment">% Step the vertical orbit</span>
0698         <span class="keyword">if</span> i ~= 1
0699             <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(VCMFamily, CorrStep, VCMDev, WaitFlag);
0700         <span class="keyword">end</span>
0701 
0702         fprintf(<span class="string">'   %d. %s(%d,%d) sp/am = %+.4f/%+.4f, %s(%d,%d) = %+.5f %s\n'</span>, i, VCMFamily, VCMDev(1,:), <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMDev(1,:)), <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(VCMFamily, VCMDev(1,:)),  BPMyFamily, BPMyDev, <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDev), QMS_Vertical.Orbit0.UnitsString); pause(0);
0703         
0704         
0705         <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0706         <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0707            <span class="comment">% Correct the horizontal orbit</span>
0708            <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0709         <span class="keyword">end</span>
0710 
0711                
0712         <span class="keyword">if</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'sweep'</span>)
0713             <span class="comment">% One dimensional sweep of the quadrupole</span>
0714             sleep(ExtraDelay);
0715             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0716             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0717             x0(:,i) = x1(:,i);
0718             y0(:,i) = y1(:,i);
0719             
0720             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0721                 QMS_Vertical.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0722             <span class="keyword">end</span>
0723 
0724             setquad(QMS_Vertical, i*DelQuad+QUAD0, WaitFlag);
0725             sleep(ExtraDelay);
0726 
0727             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0728             <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0729                 <span class="comment">% Correct the horizontal orbit</span>
0730                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0731                 sleep(ExtraDelay);
0732             <span class="keyword">end</span>
0733 
0734             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0735             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0736             
0737             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0738                 QMS_Vertical.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0739             <span class="keyword">end</span>
0740 
0741         <span class="keyword">elseif</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'bipolar'</span>)
0742             <span class="comment">% Modulate the quadrupole</span>
0743             sleep(ExtraDelay);
0744             x0(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0745             y0(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0746             setquad(QMS_Vertical, DelQuad+QUAD0, WaitFlag);
0747             sleep(ExtraDelay);
0748 
0749             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0750             <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0751                 <span class="comment">% Correct the horizontal orbit</span>
0752                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0753                 sleep(ExtraDelay);
0754             <span class="keyword">end</span>
0755 
0756             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0757             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0758             
0759             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0760                 QMS_Vertical.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0761             <span class="keyword">end</span>
0762 
0763             setquad(QMS_Vertical,-DelQuad+QUAD0, WaitFlag);
0764             sleep(ExtraDelay);
0765 
0766             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0767             <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0768                 <span class="comment">% Correct the horizontal orbit</span>
0769                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0770                 sleep(ExtraDelay);
0771             <span class="keyword">end</span>
0772 
0773             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0774             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0775             
0776             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0777                 QMS_Vertical.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0778             <span class="keyword">end</span>
0779 
0780             setquad(QMS_Vertical, QUAD0, WaitFlag);
0781             
0782         <span class="keyword">elseif</span> strcmpi(QMS_Vertical.ModulationMethod, <span class="string">'unipolar'</span>)
0783             <span class="comment">% Modulate the quadrupole</span>
0784             sleep(ExtraDelay);
0785             x1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0786             y1(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0787             x0(:,i) = x1(:,i);
0788             y0(:,i) = y1(:,i);
0789             
0790             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0791                 QMS_Vertical.Tune1(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0792             <span class="keyword">end</span>
0793 
0794             setquad(QMS_Vertical, DelQuad+QUAD0, WaitFlag);
0795             sleep(ExtraDelay);
0796 
0797             <span class="comment">% If correcting the orbit, then recorrect the horizontal center now</span>
0798             <span class="keyword">if</span> strcmpi(QMS_Vertical.CorrectOrbit, <span class="string">'yes'</span>)
0799                 <span class="comment">% Correct the horizontal orbit</span>
0800                 <a href="#_sub1" class="code" title="subfunction OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)">OrbitCorrection</a>(Xoffset, BPMxFamily, BPMxDev, HCMFamily, HCMDev, 4);
0801                 sleep(ExtraDelay);
0802             <span class="keyword">end</span>
0803 
0804             x2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxDevList);
0805             y2(:,i) = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyDevList);
0806             
0807             <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0808                 QMS_Vertical.Tune2(:,i) = <a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>;
0809             <span class="keyword">end</span>
0810 
0811             setquad(QMS_Vertical, QUAD0, WaitFlag);
0812         <span class="keyword">end</span>
0813         
0814         DCCT(i) = <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>;
0815     <span class="keyword">end</span>
0816 
0817     <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM0, VCMDev, -1);
0818 
0819     
0820     <span class="comment">% Get the vertical data filename and save the data</span>
0821     <span class="comment">% Append data and time</span>
0822     FileName = [<span class="string">'s'</span>, num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), <span class="string">'v1'</span>];
0823     FileName = appendtimestamp(FileName, clock);
0824 
0825     <span class="comment">%% Append version number</span>
0826     <span class="comment">%i=1;</span>
0827     <span class="comment">%FileName = ['s', num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), 'v', num2str(i)];</span>
0828     <span class="comment">%while exist([FileName,'.mat'], 'file')</span>
0829     <span class="comment">%    i = i + 1;</span>
0830     <span class="comment">%    FileName = ['s', num2str(QuadDev(1,1)), QuadFamily, num2str(QuadDev(1,2)), 'v', num2str(i)];</span>
0831     <span class="comment">%end</span>
0832 
0833     QMS = QMS_Vertical;
0834     QMS.QuadPlane = 2;
0835 
0836     QMS.OldCenter = Yoffset;
0837     QMS.XOffsetOld = XoffsetOld;
0838     QMS.YOffsetOld = YoffsetOld;
0839     
0840     QMS.xstart = xstart;
0841     QMS.ystart = ystart;
0842     QMS.x0 = x0;
0843     QMS.x1 = x1;
0844     QMS.x2 = x2;
0845     QMS.y0 = y0;
0846     QMS.y1 = y1;
0847     QMS.y2 = y2;
0848     QMS.Xerr = Xerr;
0849     QMS.Yerr = Yerr;
0850     QMS.TimeStamp = clock;
0851     QMS.DCCT = DCCT;
0852     QMS.DataDescriptor = <span class="string">'Quadrupole Center'</span>;
0853     QMS.CreatedBy = <span class="string">'quadcenter'</span>;
0854 
0855     <span class="comment">% Get and store the BPM status and standard deviation (to be used by the center calculation routine)</span>
0856     QMS.BPMStatus = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(BPMyFamily, BPMyDevList);
0857     N = getbpmaverages(BPMyDevList);
0858     QMS.BPMSTD = <a href="getsigma.html" class="code" title="function [Data, FileName] = getsigma(varargin)">getsigma</a>(BPMyFamily, BPMyDevList, N);
0859 
0860     
0861     <span class="comment">% Set up figures, plot and find vertical center</span>
0862     <span class="keyword">if</span> isempty(FigureHandle)
0863         QMS = <a href="quadplot.html" class="code" title="function [QMS, WarningString] = quadplot(Input1, FigureHandle, sigmaBPM)">quadplot</a>(QMS);
0864     <span class="keyword">else</span>
0865         QMS = <a href="quadplot.html" class="code" title="function [QMS, WarningString] = quadplot(Input1, FigureHandle, sigmaBPM)">quadplot</a>(QMS, FigureHandle);
0866     <span class="keyword">end</span>
0867     drawnow;
0868 
0869     <span class="keyword">if</span> XYPlane==0
0870         QMS2 = QMS;
0871     <span class="keyword">else</span>
0872         QMS1 = QMS;
0873     <span class="keyword">end</span>
0874     
0875     
0876     <span class="comment">% Save the vertical data</span>
0877     <span class="keyword">if</span> isfield(QMS_Vertical,<span class="string">'DataDirectory'</span>)  
0878         [FinalDir, ErrorFlag] = gotodirectory(QMS_Vertical.DataDirectory);
0879     <span class="keyword">end</span>
0880     QMS.DataDirectory = pwd;    
0881     save(FileName, <span class="string">'QMS'</span>);
0882     fprintf(<span class="string">'   Data saved to file %s in directory %s\n\n'</span>, FileName, QMS.DataDirectory);
0883     
0884     <span class="comment">% Output data to log file</span>
0885     fid1 = fopen(<span class="string">'quadcenter.log'</span>,<span class="string">'at'</span>);
0886     time=clock;
0887     fprintf(fid1, <span class="string">'%s   %d:%d:%2.0f \n'</span>, date, time(4),time(5),time(6));
0888     fprintf(fid1, <span class="string">'Data saved to file %s (%s)\n'</span>, FileName, QMS.DataDirectory);
0889     fprintf(fid1, <span class="string">'%s(%d,%d) %s(%d,%d) = %f (+/- %f) [%s]\n\n'</span>, QuadFamily, QuadDev, BPMyFamily, BPMyDev, QMS.Center, QMS.CenterSTD);
0890     fclose(fid1);
0891     cd(DirStart);
0892 
0893     <span class="keyword">if</span> (GetTuneFlag || strcmpi(Mode, <span class="string">'Simulator'</span>)) &amp;&amp; <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(<span class="string">'TUNE'</span>)
0894         <span class="comment">% Print the tune information</span>
0895         fprintf(<span class="string">'   Tune and tune difference for the 1st points in the merit function (QMS.Tune1): \n'</span>);
0896         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune1(1,:));
0897         fprintf(<span class="string">'  Horizontal\n'</span>);
0898         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune1(2,:));
0899         fprintf(<span class="string">'  Vertical\n'</span>);
0900         fprintf(<span class="string">'   ===================================================\n'</span>);
0901         fprintf(<span class="string">'   %8.5f'</span>, diff(QMS.Tune1));
0902         fprintf(<span class="string">'  Difference \n\n'</span>);
0903         
0904         fprintf(<span class="string">'   Tune and tune difference for the 2nd points in the merit function (QMS.Tune2): \n'</span>);
0905         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune2(1,:));
0906         fprintf(<span class="string">'  Horizontal\n'</span>);
0907         fprintf(<span class="string">'   %8.5f'</span>, QMS.Tune2(2,:));
0908         fprintf(<span class="string">'  Vertical\n'</span>);
0909         fprintf(<span class="string">'   ===================================================\n'</span>);
0910         fprintf(<span class="string">'   %8.5f'</span>, diff(QMS.Tune2));
0911         fprintf(<span class="string">'  Difference\n\n'</span>);
0912 
0913         dTune1 = diff(QMS.Tune1);
0914         dTune2 = diff(QMS.Tune2);
0915         
0916         <span class="keyword">if</span> any(sign(dTune1/dTune1(1))==-1)
0917             fprintf(<span class="string">'   Tune change sign!!!\n'</span>);            
0918         <span class="keyword">end</span>
0919         
0920         <span class="keyword">if</span> any(abs(dTune1) &lt; .025) || any(abs(dTune2) &lt; .025)
0921             fprintf(<span class="string">'   Horizontal and vertical tunes seem too close.\n'</span>);
0922         <span class="keyword">end</span>
0923     <span class="keyword">end</span>
0924 <span class="keyword">end</span>
0925 
0926 
0927 <span class="comment">% Restore magnets their starting points</span>
0928 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(HCMFamily, HCM00, HCMDev, 0);
0929 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(VCMFamily, VCM00, VCMDev, 0);
0930 setquad(QMS_Horizontal, QUAD0, 0);
0931 
0932 
0933 <span class="comment">% Restore the MML error warning level</span>
0934 <a href="setfamilydata.html" class="code" title="function setfamilydata(Data, Family, Field1, Field2, DeviceList)">setfamilydata</a>(ErrorWarningLevel, <span class="string">'ErrorWarningLevel'</span>);
0935 
0936 
0937 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0938 <span class="comment">% End Main Function %</span>
0939 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
0940 
0941 
0942 
0943 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0944 <span class="comment">% Sub-Functions %</span>
0945 <span class="comment">%%%%%%%%%%%%%%%%%</span>
0946 
0947 <a name="_sub1" href="#_subfunctions" class="code">function OrbitCorrection(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, Iter)</a>
0948 
0949 WaitFlag = -2;
0950 
0951 <span class="keyword">if</span> nargin &lt; 6
0952     Iter = 3;
0953 <span class="keyword">end</span>
0954 
0955 <span class="keyword">if</span> size(CMDevList,1) &gt; 1
0956     <span class="comment">% Pick the corrector based on the most effective corrector in the response matrix</span>
0957     <span class="comment">% This routine does not handle local bumps at the moment</span>
0958     R = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(BPMFamily, BPMDevList, CMFamily, [], <span class="string">'Struct'</span>, <span class="string">'Physics'</span>);
0959     [i, iNotFound] = findrowindex(BPMDevList, R.Monitor.DeviceList);
0960     m = R.Data(i,:);
0961     [MaxValue, j] = max(abs(m));
0962     CMDevList = R.Actuator.DeviceList(j,:);
0963 <span class="keyword">end</span>
0964 
0965 s = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(BPMFamily, BPMDevList, CMFamily, CMDevList);
0966 <span class="keyword">if</span> any(any(isnan(s)))
0967     error(<span class="string">'Response matrix has a NaN'</span>);
0968 <span class="keyword">end</span>
0969 
0970 
0971 <span class="keyword">for</span> i = 1:Iter
0972     x = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMFamily, BPMDevList) - GoalOrbit;
0973     
0974     CorrectorSP = -(x./s);
0975     CorrectorSP = CorrectorSP(:);
0976     
0977     <span class="comment">% Check limits</span>
0978     MinSP = <a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>(CMFamily, CMDevList);
0979     MaxSP = <a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>(CMFamily, CMDevList);
0980     <span class="keyword">if</span> any(<a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(CMFamily,CMDevList)+CorrectorSP &gt; MaxSP-5) 
0981         fprintf(<span class="string">'   Orbit not corrected because a maximum power supply limit would have been exceeded!\n'</span>);
0982         <span class="keyword">return</span>;
0983     <span class="keyword">end</span>
0984     <span class="keyword">if</span> any(<a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(CMFamily,CMDevList)+CorrectorSP &lt; MinSP+5) 
0985         fprintf(<span class="string">'   Orbit not corrected because a minimum power supply limit would have been exceeded!\n'</span>);
0986         <span class="keyword">return</span>;
0987     <span class="keyword">end</span>
0988     
0989     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(CMFamily, CorrectorSP, CMDevList, WaitFlag);
0990     
0991     <span class="comment">%x = getam(BPMFamily, BPMDevList) - GoalOrbit</span>
0992 <span class="keyword">end</span>
0993 
0994 
0995 
0996 
0997 <span class="comment">% function AM = getquad(QMS)</span>
0998 <span class="comment">% % AM = getquad(QMS)</span>
0999 <span class="comment">%</span>
1000 <span class="comment">% QuadFamily = QMS.QuadFamily;</span>
1001 <span class="comment">% QuadDev = QMS.QuadDev;</span>
1002 <span class="comment">%</span>
1003 <span class="comment">% % Check operational mode</span>
1004 <span class="comment">% %mode = getfamilydata(QuadFamily, 'Setpoint', 'Mode', QuadDev);</span>
1005 <span class="comment">%</span>
1006 <span class="comment">% AM = getam(QuadFamily, QuadDev);</span>
1007 
1008 
1009 <span class="comment">% function setquad(QMS, QuadSetpoint, WaitFlag)</span>
1010 <span class="comment">% % setquad(QMS, QuadSetpoint, WaitFlag)</span>
1011 <span class="comment">%</span>
1012 <span class="comment">% if nargin &lt; 3</span>
1013 <span class="comment">%     WaitFlag = -2;</span>
1014 <span class="comment">% end</span>
1015 <span class="comment">%</span>
1016 <span class="comment">% QuadFamily = QMS.QuadFamily;</span>
1017 <span class="comment">% QuadDev = QMS.QuadDev;</span>
1018 <span class="comment">%</span>
1019 <span class="comment">% setsp(QuadFamily, QuadSetpoint, QuadDev, WaitFlag);</span>
1020 
1021 
1022</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>