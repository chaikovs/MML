<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of measlocodata</title>
  <meta name="keywords" content="measlocodata">
  <meta name="description" content="MEASLOCODATA - Measures a set of LOCO data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; measlocodata.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>measlocodata
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>MEASLOCODATA - Measures a set of LOCO data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function measlocodata(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">MEASLOCODATA - Measures a set of LOCO data

  measlocodata(DirectoryName, DisplayFlag)

  INPUTS
  1. DirectoryName - Directory name for where to write the LOCO data files.
                     If empty and DisplayFlag is on, then a dialog box will be used to select a directory.
                     If empty and DisplayFlag is off, then the directory will chosen based on the date &amp; time.

  2. DisplayFlag -   'Display' - Dialog boxes will ask questions for what to measure, orbit correction, and pause 
                                 before starting the measurement.  {'Display' is the default behavior} 
                   'NoDisplay' - No questions will be asked.  The behavior for 'NoDisplay' is,
                                 a. Measure dispersion
                                 b. Measure the BPM response matrix
                                 c. Measure the BPM noise (sigma)
                                 d. Do not correct the orbit (the use should already have the proper orbit loaded)

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>	MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</li><li><a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>	MEASDISP - Measures the dispersion function</li><li><a href="plotbpmresp.html" class="code" title="function plotbpmresp(varargin)">plotbpmresp</a>	PLOTBPMRESP - Plots the orbit response matrix in various ways</li><li><a href="plotdisp.html" class="code" title="function [DxOut, DyOut, FileName] = plotdisp(varargin)">plotdisp</a>	PLOTDISP - Plots the dispersion function</li><li><a href="plotorbit.html" class="code" title="function plotorbit(varargin)">plotorbit</a>	PLOTORBIT - Plot the present orbit w.r.t. the golden or offset orbit</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function measlocodata(varargin)</a>
0002 <span class="comment">%MEASLOCODATA - Measures a set of LOCO data</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  measlocodata(DirectoryName, DisplayFlag)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  INPUTS</span>
0007 <span class="comment">%  1. DirectoryName - Directory name for where to write the LOCO data files.</span>
0008 <span class="comment">%                     If empty and DisplayFlag is on, then a dialog box will be used to select a directory.</span>
0009 <span class="comment">%                     If empty and DisplayFlag is off, then the directory will chosen based on the date &amp; time.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%  2. DisplayFlag -   'Display' - Dialog boxes will ask questions for what to measure, orbit correction, and pause</span>
0012 <span class="comment">%                                 before starting the measurement.  {'Display' is the default behavior}</span>
0013 <span class="comment">%                   'NoDisplay' - No questions will be asked.  The behavior for 'NoDisplay' is,</span>
0014 <span class="comment">%                                 a. Measure dispersion</span>
0015 <span class="comment">%                                 b. Measure the BPM response matrix</span>
0016 <span class="comment">%                                 c. Measure the BPM noise (sigma)</span>
0017 <span class="comment">%                                 d. Do not correct the orbit (the use should already have the proper orbit loaded)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%  Written by Greg Portmann</span>
0020 
0021 
0022 <span class="comment">% Minimum beam current to make measurement</span>
0023 MinCurrent = .1;
0024 
0025 
0026 <span class="comment">% Input checking</span>
0027 DirectoryName = <span class="string">''</span>;
0028 DisplayFlag = 1;
0029 <span class="keyword">for</span> i = length(varargin):-1:1
0030     <span class="keyword">if</span> isstruct(varargin{i})
0031         <span class="comment">% Ignor structures</span>
0032     <span class="keyword">elseif</span> iscell(varargin{i})
0033         <span class="comment">% Ignor cells</span>
0034     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0035         DisplayFlag = 1;
0036         varargin(i) = [];
0037     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0038         DisplayFlag = 0;
0039         varargin(i) = [];
0040     <span class="keyword">end</span>
0041 <span class="keyword">end</span>
0042 
0043 
0044 <span class="keyword">if</span> length(varargin) &gt;=1 
0045     DirectoryName = varargin{1};
0046 <span class="keyword">end</span>
0047 
0048 
0049 
0050 <span class="comment">% Get the directory location</span>
0051 <span class="keyword">if</span> isempty(DirectoryName)
0052     c = clock;
0053     DirectoryName = [<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'DataRoot'</span>), <span class="string">'LOCO'</span>, filesep];
0054     DirectoryName = sprintf(<span class="string">'%s%s'</span>, DirectoryName, datestr(c,29));  <span class="comment">% Year-Month-Day</span>
0055     DirectoryName = [DirectoryName, filesep, sprintf(<span class="string">'%02d-%02d-%02.0f'</span>, c(4), c(5), c(6))];  <span class="comment">% Hour-Minute-Second</span>
0056 
0057     <span class="keyword">if</span> DisplayFlag
0058         AnswerString = questdlg(strvcat(strvcat(strvcat(strvcat(strvcat( <span class="keyword">...</span>
0059             <span class="string">'Choose directory where all the LOCO data is written.'</span>, <span class="keyword">...</span>
0060             <span class="string">'The default directory location is:'</span>), <span class="keyword">...</span>
0061             sprintf(<span class="string">'%s\n'</span>,DirectoryName)),<span class="string">' '</span>), <span class="keyword">...</span>
0062             <span class="string">'Yes - Use this directory'</span>),<span class="string">'No - Select a new directory'</span>), <span class="keyword">...</span>
0063             <span class="string">'LOCO Mesurement Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0064 
0065         <span class="keyword">if</span> strcmp(AnswerString,<span class="string">'No'</span>)
0066             DirectoryName = [<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'DataRoot'</span>), <span class="string">'LOCO'</span>, filesep];
0067             DirectoryName = uigetdir(DirectoryName, <span class="string">'Select a directory to put the LOCO data'</span>);
0068             <span class="keyword">if</span> DirectoryName == 0
0069                 fprintf(<span class="string">'   LOCO data measurement cancelled\n'</span>);
0070                 <span class="keyword">return</span>
0071             <span class="keyword">end</span>
0072         <span class="keyword">end</span>
0073     <span class="keyword">end</span>
0074 <span class="keyword">end</span>
0075 
0076 
0077 <span class="comment">% Create the directory</span>
0078 DirStart = pwd;
0079 [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
0080 cd(DirStart);
0081        
0082 
0083 
0084 <span class="keyword">if</span> DisplayFlag
0085     DispersionString   = questdlg({<span class="string">'A Dispersion function measurement is needed for LOCO.'</span>, <span class="string">' '</span>,<span class="string">'Should this function measure a Dispersion function?'</span>},<span class="string">'LOCO Mesurement Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0086     BPMSigmaString     = questdlg({<span class="string">'A BPM Sigma measurement is needed for LOCO.'</span>, <span class="string">' '</span>,<span class="string">'Should this function measure the BPM Sigma?'</span>},<span class="string">'LOCO Mesurement Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0087     BPMResponseMatrix  = questdlg({<span class="string">'A BPM Response Matrix measurement is needed for LOCO.'</span>, <span class="string">' '</span>,<span class="string">'Should this function measure the BPM Response Matrix?'</span>},<span class="string">'LOCO Mesurement Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0088     CorrectorOrbitFlag = <span class="string">'No'</span>; <span class="comment">%questdlg({'The proper orbit can be important for a LOCO measurement.', ' ','Should this function correct the orbit (using setorbitdefault) at the start?'},'LOCO Mesurement Setup','Yes','No','No');</span>
0089 
0090     <span class="comment">%StartFlag = questdlg('Start the LOCO measurement?','LOCO Mesurement','Yes','No','Yes');</span>
0091     StartFlag = questdlg({<span class="string">'Start the LOCO measurement?'</span>,<span class="string">' '</span>,<span class="string">'(Make sure the orbit is ok.)'</span>},<span class="string">'LOCO Mesurement'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0092     <span class="keyword">if</span> ~strcmpi(StartFlag, <span class="string">'Yes'</span>)
0093         fprintf(<span class="string">'   LOCO data measurement cancelled\n'</span>);
0094         <span class="keyword">return</span>
0095     <span class="keyword">end</span>
0096 <span class="keyword">else</span>
0097     DispersionString = <span class="string">'Yes'</span>;
0098     BPMSigmaString = <span class="string">'Yes'</span>;
0099     BPMResponseMatrix = <span class="string">'Yes'</span>;
0100     CorrectorOrbitFlag = <span class="string">'No'</span>;
0101 <span class="keyword">end</span>
0102 
0103 
0104 TimeStart = gettime;
0105 [N, T] = getbpmaverages;
0106 T = max(T);
0107 
0108 
0109 <span class="comment">% Correct the orbit</span>
0110 <span class="keyword">if</span> strcmpi(CorrectorOrbitFlag, <span class="string">'Yes'</span>)
0111     <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; MinCurrent
0112         fprintf(<span class="string">'   LOCO measurement stopped due to beam current &lt; %f mAmps\n'</span>, MinCurrent);
0113         <span class="keyword">return</span>
0114     <span class="keyword">end</span>
0115     <span class="keyword">try</span>
0116         fprintf(<span class="string">'   Correcting the orbit\n'</span>);
0117         setorbitdefault(<span class="string">'NoDisplay'</span>);
0118         pause(T * 2.5);
0119         clf reset
0120         <a href="plotorbit.html" class="code" title="function plotorbit(varargin)">plotorbit</a>;
0121         drawnow;
0122         fprintf(<span class="string">'   Orbit correction complete\n\n'</span>);
0123 
0124         <span class="keyword">if</span> DisplayFlag
0125             ContinueFlag = questdlg(strvcat(strvcat(<span class="string">'The orbit has been corrected using the setorbitdefault function.'</span>, <span class="string">' '</span>),<span class="string">'Check that the orbit is good before continuing.  Continue?'</span>),<span class="string">'LOCO Mesurement Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
0126             <span class="keyword">if</span> ~strcmpi(ContinueFlag, <span class="string">'Yes'</span>)
0127                 fprintf(<span class="string">'   LOCO data measurement cancelled\n'</span>);
0128                 <span class="keyword">return</span>
0129             <span class="keyword">end</span>
0130         <span class="keyword">end</span>
0131     <span class="keyword">catch</span>
0132         ErrorString = questdlg(strvcat(<span class="string">'There was a problem correcting the orbit.'</span>,<span class="string">'Do you want to continue taking LOCO data?'</span>),<span class="string">'LOCO'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0133         <span class="keyword">if</span> ~strcmpi(ErrorString, <span class="string">'Yes'</span>)
0134             fprintf(<span class="string">'   LOCO data measurement cancelled\n'</span>);
0135             <span class="keyword">return</span>
0136         <span class="keyword">end</span>
0137     <span class="keyword">end</span>
0138 <span class="keyword">end</span>
0139 
0140 
0141 <span class="comment">% Measure dispersion</span>
0142 <span class="keyword">if</span> strcmpi(DispersionString, <span class="string">'Yes'</span>)
0143     <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; MinCurrent
0144         fprintf(<span class="string">'   LOCO measurement stopped due to beam current &lt; %f mAmps\n'</span>, MinCurrent);
0145         <span class="keyword">return</span>
0146     <span class="keyword">end</span>
0147     fprintf(<span class="string">'   Measuring dispersion\n'</span>);
0148     [Dx, Dy, FileName] = <a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin);">measdisp</a>(<span class="string">'Struct'</span>,<span class="string">'Archive'</span>,<span class="string">'Display'</span>);
0149     copyfile(FileName, DirectoryName);
0150     <span class="keyword">try</span>
0151         clf reset
0152         <a href="plotdisp.html" class="code" title="function [DxOut, DyOut, FileName] = plotdisp(varargin)">plotdisp</a>(Dx, Dy, <span class="string">'Physics'</span>);
0153         drawnow;
0154     <span class="keyword">catch</span>
0155         fprintf(<span class="string">'\n   There was a problem plotting the dispersion function.\n'</span>);
0156         fprintf(  <span class="string">'   Take a good look at the dispersion data before using it.\n'</span>);
0157     <span class="keyword">end</span>
0158     fprintf(<span class="string">'   Dispersion measurement complete\n\n'</span>);
0159 <span class="keyword">end</span>
0160 
0161 
0162 <span class="comment">% Measure BPM response matrix</span>
0163 <span class="keyword">if</span> strcmpi(BPMResponseMatrix, <span class="string">'Yes'</span>)
0164     <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; MinCurrent
0165         fprintf(<span class="string">'   LOCO measurement stopped due to beam current &lt; %f mAmps\n'</span>, MinCurrent);
0166         <span class="keyword">return</span>
0167     <span class="keyword">end</span>
0168     FileName = [<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'BPMResponse'</span>), <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Default'</span>, <span class="string">'BPMRespFile'</span>)];
0169     FileName = appendtimestamp(FileName);
0170     [Rmat, FileName] = <a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>(<span class="string">'Archive'</span>, FileName);
0171     <span class="comment">%[Rmat, FileName] = measbpmresp;</span>
0172     copyfile(FileName, DirectoryName);
0173 
0174     <span class="keyword">try</span>
0175         clf reset
0176         <a href="plotbpmresp.html" class="code" title="function plotbpmresp(varargin)">plotbpmresp</a>(FileName);
0177         drawnow;
0178     <span class="keyword">catch</span>
0179         fprintf(<span class="string">'\n   There was a problem plotting the BPM response matrix.\n'</span>);
0180         fprintf(  <span class="string">'   Take a good look at the data before using it.\n'</span>);
0181     <span class="keyword">end</span>
0182     fprintf(<span class="string">'   BPM response matrix measurement complete\n\n'</span>);
0183 <span class="keyword">end</span>
0184 
0185 
0186 <span class="comment">% Measure BPM sigma</span>
0187 <span class="keyword">if</span> strcmpi(BPMSigmaString, <span class="string">'Yes'</span>)
0188     <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; MinCurrent
0189         fprintf(<span class="string">'   LOCO measurement stopped due to beam current &lt; %f mAmps\n'</span>, MinCurrent);
0190         <span class="keyword">return</span>
0191     <span class="keyword">end</span>
0192     fprintf(<span class="string">'   Measuring BPM sigma\n'</span>);
0193     <span class="keyword">if</span> T == 0 
0194         T = .5;
0195     <span class="keyword">end</span>
0196     [BPMx, BPMy, FileName] = monbpm(0:T:3*60, <span class="string">'Struct'</span>, <span class="string">'Archive'</span>);
0197     copyfile(FileName, DirectoryName);
0198     fprintf(<span class="string">'   BPM noise measurement complete\n\n'</span>);
0199 <span class="keyword">end</span>
0200 
0201 fprintf(<span class="string">'   The total measurement time was %.2f minutes.\n'</span>, (gettime-TimeStart)/60);
0202 fprintf(<span class="string">'   LOCO measurement complete\n\n'</span>);
0203 
0204 
0205</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>