<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of measbpmresp</title>
  <meta name="keywords" content="measbpmresp">
  <meta name="description" content="MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; measbpmresp.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>measbpmresp
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [Rmat, OutputFileName] = measbpmresp(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes

  For family name, device list inputs:
  [R, FileName] = measbpmresp(BPMxFamily, BPMxList, BPMyFamily, BPMyList, HCMFamily, HCMList, VCMFamily, VCMList, HCMKicks, VCMKicks, ModulationMethod, WaitFlag, FileName, DirectoryName, ExtraDelay)

  For data structure inputs: 
  [R, FileName] = measbpmresp(BPMxStruct, BPMyStruct, HCMStruct, VCMStruct, HCMKicks, VCMKicks, ModulationMethod, WaitFlag, FileName, DirectoryName, ExtraDelay)

  INPUTS
  1. BPMxFamily       - BPMx family name {Default: gethbpmfamily}
     BPMxDeviceList   - BPMx device list {Default: all devices with good status}
     or 
     BPMxStruct can replace BPMxFamily and BPMxList

  2. BPMyFamily       - BPMy family name {Default: getvbpmfamily}
     BPMyDeviceList   - BPMy device list {Default: all devices with good status}
     or 
     BPMyStruct can replace BPMyFamily and BPMyList

  3. HCMFamily       - HCM family name {Default: gethcmfamily}
     HCMDeviceList   - HCM device list {Default: all devices with good status}
     or 
     HCMStruct can replace HCMFamily and HCMList

  4. VCMFamily       - VCM family name {Default: getvcmfamily}
     VCMDeviceList   - VCM device list {Default: all devices with good status}
     or 
     VCMStruct can replace VCMFamily and VCMList

  5. HCMKicks - Change in HCM correctors {Default: getfamilydata(HCMFamily,'Setpoint','DeltaRespMat',HCMDeviceList), then .05 mrad}
  6. VCMKicks - Change in VCM correctors {Default: getfamilydata(VCMFamily,'Setpoint','DeltaRespMat',VCMDeviceList), then .05 mrad}

  7. ModulationMethod - Method for changing the ActuatorFamily
                       'bipolar' changes the ActuatorFamily by +/- ActuatorDelta/2 on each step {Default}
                       'unipolar' changes the ActuatorFamily from 0 to ActuatorDelta on each step

  8. WaitFlag - (see setpv for WaitFlag definitions) {Default: []}
                WaitFlag = -5 will override gets to manual mode

  9. Optional input to change the default filename and directory
     FileName - Filename for the response matrix data
                (Empty prompts for a filename)  
     DirectoryName - Directory name to store the response matrix data file 
     Note: a. FileName can include the path if DirectoryName is not used
           b. For model response matrices, FileName must exist for a file save
           c. The 'Achive' flag is another way to input the filename

  10. ExtraDelay - extra time delay [seconds] after a setpoint change

  11. 'Struct'  - Output will be a response matrix structure {Default for     data structure inputs}
      'Numeric' - Output will be a numeric matrix            {Default for non-data structure inputs}

  12. Optional override of the units:
      'Physics'  - Use physics  units
      'Hardware' - Use hardware units

  13. Optional override of the mode:
      'Online'    - Set/Get data online  
      'Model'     - Set/Get data directly from AT (uses locoresponsematrix)
      'Simulator' - Set/Get data on the simulated accelerator using AT (ie, same commands as 'Online')
      'Manual'    - Set/Get data manually

  14. 'Display'   - Prints status information to the command window {Default}
      'NoDisplay' - Nothing is printed to the command window

  15. 'NoArchive' - No file archive
      'Archive'   - Save the response matrix data to \&lt;Directory.BPMResponse&gt;\&lt;BPMRespFile&gt;&lt;Date&gt;&lt;Time&gt;.mat
                    To change the filename, included the filename after the 'Archive', '' to browse

  16. 'MinimumBeamCurrent' - Minimum beam current before prompting for a refill
                             The current (as returned by getdcct) must follow the flag. 
                             measbpmresp('MinimumBeamCurrent', 32.1) 
                             will pause at a beam current of 32.1 and prompt for a refill.

  17. Optional inputs when computing model response matrices:
      'FixedPathLength' or 'FixedMomentum' - hold the path length or momentum fixed  {Default: 'FixedPathLength'}
      'Full' or 'Linear' - use full nonlinear model or linear approximation (faster) {Default: 'Linear'}
      Note: The ModulationMethod input (7) is also used for the model calculation.

  OUTPUTS
  1. R = Orbit response matrix (delta(orbit)/delta(Kick))

     Numeric Output:
       R = [xx xy
            yx yy]

     Stucture Output:
     R(BPM Plane, Corrector Plane) - 2x2 struct array
     R(1,1).Data=xx;  % Kick x, look x
     R(2,1).Data=yx;  % Kick x, look y
     R(1,2).Data=xy;  % Kick y, look x
     R(2,2).Data=yy;  % Kick y, look y
           
     R(Monitor, Actuator).Data - Response matrix
                         .Monitor  - BPM data structure (starting orbit)
                         .Monitor1 - BPM matrix (first  data point)
                         .Monitor2 - BPM matrix (second data point)
                         .Actuator - Corrector data structure
                         .ActuatorDelta - Corrector kick vector
                         .GeV - Electron beam energy
                         .ModulationMethod - 'unipolar' or 'bipolar'
                         .WaitFlag - Wait flag used when acquiring data
                         .ExtraDelay - Extra time delay 
                         .TimeStamp
                         .CreatedBy
                         .DCCT

  2. FileName = File name (including directory) where the data was saved (if applicable)
                (a machine configuration structure is saved in the data file as well)

  NOTES
  1. [] can be used on any input to obtain the default setting.
     However, most inputs can be left out altogether to get the default.
  2. For Mode = 'Model':
     a. AT family names (or 'All') can be used and DeviceList is ignored
     b. There is a lot of flexibility for getting response matrices, for instance,
        R = measbpmresp('QF', 'QD', 'HCM', 'VCM', 'Model', 'Physics');
        is the response matrix from the correctors to orbit at the sextupoles.
        The units when using nonstandard families for BPMs is always 'physics', meter/radian.  
  3. Cell inputs are not allowed.
  4. BPM roll and crunch and corrector magnet roll errors are included only if they are 
     in the AT model (field .GCR for BPMs and .Roll for correctors). 
     BPM and corrector magnet gains are included in hardware units (not physics units). 
  5. This function measures response matrices from 2 BPM families to 2 corrector families.  
     If only one family is needed then use measrespmat.

  EXAMPLES
  1. Default:
       R = measbpmresp;
       is the same as,
       R = measbpmresp('BPMx', 'BPMy', 'HCM', 'VCM', 'Online', 'Bipolar', 'Numeric', 'Archive');

  2. Default using the model:
       R = measbpmresp('Model');
       is the same as,
       R = measbpmresp('BPMx', 'BPMy', 'HCM', 'VCM', 'Model', 'Bipolar', 'Numeric', 'NoArchive', 'FixedPathLength', 'Linear');

  3. Compare measured (or Default) and model BPM response
     Rmeas  = getbpmresp;
     Rmodel = measbpmresp('Model');
     subplot(2,1,1);
     surf(Rmeas);  title('Default BPM Response'); xlabel('BPM #'); ylabel('CM #'); zlabel('[mm/amp]');
     subplot(2,1,2);
     surf(Rmeas-Rmodel);  title('Default - Model BPM Response'); xlabel('BPM #'); ylabel('CM #'); zlabel('[mm/amp]');

  See also <a href="getbpmresp.html" class="code" title="function [S, FileName] = getbpmresp(varargin)">getbpmresp</a>, <a href="measrespmat.html" class="code" title="function S = measrespmat(varargin)">measrespmat</a>, <a href="meastuneresp.html" class="code" title="function [Rmat, OutputFileName] = meastuneresp(varargin)">meastuneresp</a>, <a href="measchroresp.html" class="code" title="function [Rmat, OutputFileName] = measchroresp(varargin)">measchroresp</a>

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>	GETAM - Gets monitor channels</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getmachineconfig.html" class="code" title="function [ConfigSetpoint, ConfigMonitor, FileName] = getmachineconfig(varargin)">getmachineconfig</a>	GETMACHINECONFIG - Returns or saves to file the present storage ring setpoints and monitors</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>	GETSPOS - Returns the longitudinal position in meters</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>	ISMEMBEROF - Returns turn if the membership information of a family (cell of strings)</li><li><a href="isstoragering.html" class="code" title="function Test = isstoragering">isstoragering</a>	ISSTORAGERING - Is this a storage ring?</li><li><a href="istransport.html" class="code" title="function Test = istransport">istransport</a>	ISTRANSPORT - Is this a transport line?</li><li><a href="measrespmat.html" class="code" title="function S = measrespmat(varargin)">measrespmat</a>	MEASRESPMAT - Measure a response matrix</li><li><a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>	PHYSICS2HW - Converts from 'Physics' units to 'Hardware' units</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="bpmresp2loco.html" class="code" title="function [R, Data, DataMM] = bpmresp2loco(R)">bpmresp2loco</a>	BPMRESP2LOCO - Convert a MML response matrix to LOCO units</li><li><a href="buildopsdatafiles.html" class="code" title="function buildopsdatafiles">buildopsdatafiles</a>	BUILDOPSDATAFILES - Builds the files for the OpsData directory from the model</li><li><a href="getbpmresp.html" class="code" title="function [S, FileName] = getbpmresp(varargin)">getbpmresp</a>	GETBPMRESP - Returns the BPM response matrix in the horizontal and vertical planes</li><li><a href="measlocodata.html" class="code" title="function measlocodata(varargin)">measlocodata</a>	MEASLOCODATA - Measures a set of LOCO data</li><li><a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>	ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</li><li><a href="plotbpmresp.html" class="code" title="function plotbpmresp(varargin)">plotbpmresp</a>	PLOTBPMRESP - Plots the orbit response matrix in various ways</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Rmat, OutputFileName] = measbpmresp(varargin)</a>
0002 <span class="comment">%MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  For family name, device list inputs:</span>
0005 <span class="comment">%  [R, FileName] = measbpmresp(BPMxFamily, BPMxList, BPMyFamily, BPMyList, HCMFamily, HCMList, VCMFamily, VCMList, HCMKicks, VCMKicks, ModulationMethod, WaitFlag, FileName, DirectoryName, ExtraDelay)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  For data structure inputs:</span>
0008 <span class="comment">%  [R, FileName] = measbpmresp(BPMxStruct, BPMyStruct, HCMStruct, VCMStruct, HCMKicks, VCMKicks, ModulationMethod, WaitFlag, FileName, DirectoryName, ExtraDelay)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  INPUTS</span>
0011 <span class="comment">%  1. BPMxFamily       - BPMx family name {Default: gethbpmfamily}</span>
0012 <span class="comment">%     BPMxDeviceList   - BPMx device list {Default: all devices with good status}</span>
0013 <span class="comment">%     or</span>
0014 <span class="comment">%     BPMxStruct can replace BPMxFamily and BPMxList</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%  2. BPMyFamily       - BPMy family name {Default: getvbpmfamily}</span>
0017 <span class="comment">%     BPMyDeviceList   - BPMy device list {Default: all devices with good status}</span>
0018 <span class="comment">%     or</span>
0019 <span class="comment">%     BPMyStruct can replace BPMyFamily and BPMyList</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%  3. HCMFamily       - HCM family name {Default: gethcmfamily}</span>
0022 <span class="comment">%     HCMDeviceList   - HCM device list {Default: all devices with good status}</span>
0023 <span class="comment">%     or</span>
0024 <span class="comment">%     HCMStruct can replace HCMFamily and HCMList</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  4. VCMFamily       - VCM family name {Default: getvcmfamily}</span>
0027 <span class="comment">%     VCMDeviceList   - VCM device list {Default: all devices with good status}</span>
0028 <span class="comment">%     or</span>
0029 <span class="comment">%     VCMStruct can replace VCMFamily and VCMList</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%  5. HCMKicks - Change in HCM correctors {Default: getfamilydata(HCMFamily,'Setpoint','DeltaRespMat',HCMDeviceList), then .05 mrad}</span>
0032 <span class="comment">%  6. VCMKicks - Change in VCM correctors {Default: getfamilydata(VCMFamily,'Setpoint','DeltaRespMat',VCMDeviceList), then .05 mrad}</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%  7. ModulationMethod - Method for changing the ActuatorFamily</span>
0035 <span class="comment">%                       'bipolar' changes the ActuatorFamily by +/- ActuatorDelta/2 on each step {Default}</span>
0036 <span class="comment">%                       'unipolar' changes the ActuatorFamily from 0 to ActuatorDelta on each step</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%  8. WaitFlag - (see setpv for WaitFlag definitions) {Default: []}</span>
0039 <span class="comment">%                WaitFlag = -5 will override gets to manual mode</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%  9. Optional input to change the default filename and directory</span>
0042 <span class="comment">%     FileName - Filename for the response matrix data</span>
0043 <span class="comment">%                (Empty prompts for a filename)</span>
0044 <span class="comment">%     DirectoryName - Directory name to store the response matrix data file</span>
0045 <span class="comment">%     Note: a. FileName can include the path if DirectoryName is not used</span>
0046 <span class="comment">%           b. For model response matrices, FileName must exist for a file save</span>
0047 <span class="comment">%           c. The 'Achive' flag is another way to input the filename</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%  10. ExtraDelay - extra time delay [seconds] after a setpoint change</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%  11. 'Struct'  - Output will be a response matrix structure {Default for     data structure inputs}</span>
0052 <span class="comment">%      'Numeric' - Output will be a numeric matrix            {Default for non-data structure inputs}</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%  12. Optional override of the units:</span>
0055 <span class="comment">%      'Physics'  - Use physics  units</span>
0056 <span class="comment">%      'Hardware' - Use hardware units</span>
0057 <span class="comment">%</span>
0058 <span class="comment">%  13. Optional override of the mode:</span>
0059 <span class="comment">%      'Online'    - Set/Get data online</span>
0060 <span class="comment">%      'Model'     - Set/Get data directly from AT (uses locoresponsematrix)</span>
0061 <span class="comment">%      'Simulator' - Set/Get data on the simulated accelerator using AT (ie, same commands as 'Online')</span>
0062 <span class="comment">%      'Manual'    - Set/Get data manually</span>
0063 <span class="comment">%</span>
0064 <span class="comment">%  14. 'Display'   - Prints status information to the command window {Default}</span>
0065 <span class="comment">%      'NoDisplay' - Nothing is printed to the command window</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%  15. 'NoArchive' - No file archive</span>
0068 <span class="comment">%      'Archive'   - Save the response matrix data to \&lt;Directory.BPMResponse&gt;\&lt;BPMRespFile&gt;&lt;Date&gt;&lt;Time&gt;.mat</span>
0069 <span class="comment">%                    To change the filename, included the filename after the 'Archive', '' to browse</span>
0070 <span class="comment">%</span>
0071 <span class="comment">%  16. 'MinimumBeamCurrent' - Minimum beam current before prompting for a refill</span>
0072 <span class="comment">%                             The current (as returned by getdcct) must follow the flag.</span>
0073 <span class="comment">%                             measbpmresp('MinimumBeamCurrent', 32.1)</span>
0074 <span class="comment">%                             will pause at a beam current of 32.1 and prompt for a refill.</span>
0075 <span class="comment">%</span>
0076 <span class="comment">%  17. Optional inputs when computing model response matrices:</span>
0077 <span class="comment">%      'FixedPathLength' or 'FixedMomentum' - hold the path length or momentum fixed  {Default: 'FixedPathLength'}</span>
0078 <span class="comment">%      'Full' or 'Linear' - use full nonlinear model or linear approximation (faster) {Default: 'Linear'}</span>
0079 <span class="comment">%      Note: The ModulationMethod input (7) is also used for the model calculation.</span>
0080 <span class="comment">%</span>
0081 <span class="comment">%  OUTPUTS</span>
0082 <span class="comment">%  1. R = Orbit response matrix (delta(orbit)/delta(Kick))</span>
0083 <span class="comment">%</span>
0084 <span class="comment">%     Numeric Output:</span>
0085 <span class="comment">%       R = [xx xy</span>
0086 <span class="comment">%            yx yy]</span>
0087 <span class="comment">%</span>
0088 <span class="comment">%     Stucture Output:</span>
0089 <span class="comment">%     R(BPM Plane, Corrector Plane) - 2x2 struct array</span>
0090 <span class="comment">%     R(1,1).Data=xx;  % Kick x, look x</span>
0091 <span class="comment">%     R(2,1).Data=yx;  % Kick x, look y</span>
0092 <span class="comment">%     R(1,2).Data=xy;  % Kick y, look x</span>
0093 <span class="comment">%     R(2,2).Data=yy;  % Kick y, look y</span>
0094 <span class="comment">%</span>
0095 <span class="comment">%     R(Monitor, Actuator).Data - Response matrix</span>
0096 <span class="comment">%                         .Monitor  - BPM data structure (starting orbit)</span>
0097 <span class="comment">%                         .Monitor1 - BPM matrix (first  data point)</span>
0098 <span class="comment">%                         .Monitor2 - BPM matrix (second data point)</span>
0099 <span class="comment">%                         .Actuator - Corrector data structure</span>
0100 <span class="comment">%                         .ActuatorDelta - Corrector kick vector</span>
0101 <span class="comment">%                         .GeV - Electron beam energy</span>
0102 <span class="comment">%                         .ModulationMethod - 'unipolar' or 'bipolar'</span>
0103 <span class="comment">%                         .WaitFlag - Wait flag used when acquiring data</span>
0104 <span class="comment">%                         .ExtraDelay - Extra time delay</span>
0105 <span class="comment">%                         .TimeStamp</span>
0106 <span class="comment">%                         .CreatedBy</span>
0107 <span class="comment">%                         .DCCT</span>
0108 <span class="comment">%</span>
0109 <span class="comment">%  2. FileName = File name (including directory) where the data was saved (if applicable)</span>
0110 <span class="comment">%                (a machine configuration structure is saved in the data file as well)</span>
0111 <span class="comment">%</span>
0112 <span class="comment">%  NOTES</span>
0113 <span class="comment">%  1. [] can be used on any input to obtain the default setting.</span>
0114 <span class="comment">%     However, most inputs can be left out altogether to get the default.</span>
0115 <span class="comment">%  2. For Mode = 'Model':</span>
0116 <span class="comment">%     a. AT family names (or 'All') can be used and DeviceList is ignored</span>
0117 <span class="comment">%     b. There is a lot of flexibility for getting response matrices, for instance,</span>
0118 <span class="comment">%        R = measbpmresp('QF', 'QD', 'HCM', 'VCM', 'Model', 'Physics');</span>
0119 <span class="comment">%        is the response matrix from the correctors to orbit at the sextupoles.</span>
0120 <span class="comment">%        The units when using nonstandard families for BPMs is always 'physics', meter/radian.</span>
0121 <span class="comment">%  3. Cell inputs are not allowed.</span>
0122 <span class="comment">%  4. BPM roll and crunch and corrector magnet roll errors are included only if they are</span>
0123 <span class="comment">%     in the AT model (field .GCR for BPMs and .Roll for correctors).</span>
0124 <span class="comment">%     BPM and corrector magnet gains are included in hardware units (not physics units).</span>
0125 <span class="comment">%  5. This function measures response matrices from 2 BPM families to 2 corrector families.</span>
0126 <span class="comment">%     If only one family is needed then use measrespmat.</span>
0127 <span class="comment">%</span>
0128 <span class="comment">%  EXAMPLES</span>
0129 <span class="comment">%  1. Default:</span>
0130 <span class="comment">%       R = measbpmresp;</span>
0131 <span class="comment">%       is the same as,</span>
0132 <span class="comment">%       R = measbpmresp('BPMx', 'BPMy', 'HCM', 'VCM', 'Online', 'Bipolar', 'Numeric', 'Archive');</span>
0133 <span class="comment">%</span>
0134 <span class="comment">%  2. Default using the model:</span>
0135 <span class="comment">%       R = measbpmresp('Model');</span>
0136 <span class="comment">%       is the same as,</span>
0137 <span class="comment">%       R = measbpmresp('BPMx', 'BPMy', 'HCM', 'VCM', 'Model', 'Bipolar', 'Numeric', 'NoArchive', 'FixedPathLength', 'Linear');</span>
0138 <span class="comment">%</span>
0139 <span class="comment">%  3. Compare measured (or Default) and model BPM response</span>
0140 <span class="comment">%     Rmeas  = getbpmresp;</span>
0141 <span class="comment">%     Rmodel = measbpmresp('Model');</span>
0142 <span class="comment">%     subplot(2,1,1);</span>
0143 <span class="comment">%     surf(Rmeas);  title('Default BPM Response'); xlabel('BPM #'); ylabel('CM #'); zlabel('[mm/amp]');</span>
0144 <span class="comment">%     subplot(2,1,2);</span>
0145 <span class="comment">%     surf(Rmeas-Rmodel);  title('Default - Model BPM Response'); xlabel('BPM #'); ylabel('CM #'); zlabel('[mm/amp]');</span>
0146 <span class="comment">%</span>
0147 <span class="comment">%  See also getbpmresp, measrespmat, meastuneresp, measchroresp</span>
0148 <span class="comment">%</span>
0149 <span class="comment">%  Written by Greg Portmann</span>
0150 
0151 
0152 <span class="comment">% Initialize defaults</span>
0153 BPMxFamily = <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>; 
0154 <span class="keyword">if</span> isempty(BPMxFamily)
0155     error(<span class="string">'&quot;BPMx&quot; needs to be a MemberOf some family.'</span>);
0156 <span class="keyword">end</span>
0157 BPMxList = [];
0158 
0159 BPMyFamily = <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>;
0160 <span class="keyword">if</span> isempty(BPMyFamily)
0161     error(<span class="string">'&quot;BPMy&quot; needs to be a MemberOf some family.'</span>);
0162 <span class="keyword">end</span>
0163 BPMyList = [];
0164 
0165 HCMFamily = <a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily">gethcmfamily</a>;
0166 <span class="keyword">if</span> isempty(HCMFamily)
0167     error(<span class="string">'&quot;HCM&quot; needs to be a MemberOf some family.'</span>);
0168 <span class="keyword">end</span>
0169 HCMList = [];
0170 HCMKicks = [];
0171 Default2HCMKick = .05e-3;  <span class="comment">% Radians, if getfamilydata(HCMFamily,'Setpoint','DeltaRespMat') is empty</span>
0172 
0173 VCMFamily = <a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily">getvcmfamily</a>;
0174 <span class="keyword">if</span> isempty(VCMFamily)
0175     error(<span class="string">'&quot;VCM&quot; needs to be a MemberOf some family.'</span>);
0176 <span class="keyword">end</span>
0177 VCMList = [];
0178 VCMKicks = [];
0179 Default2VCMKick = .05e-3;  <span class="comment">% Radians, if getfamilydata(VCMFamily,'Setpoint','DeltaRespMat') is empty</span>
0180 ModulationMethod = <span class="string">'bipolar'</span>;
0181 
0182 <span class="comment">% Map MML to LOCO naming</span>
0183 <span class="keyword">if</span> strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0184     LOCORespFlags.ResponseMatrixMeasurement = <span class="string">'Bidirectional'</span>;   <span class="comment">% 'oneway'' or ''bidirectional'</span>
0185 <span class="keyword">else</span>
0186     LOCORespFlags.DispersionMeasurement     = <span class="string">'Bidirectional'</span>;
0187 <span class="keyword">end</span>
0188 <span class="keyword">if</span> <a href="isstoragering.html" class="code" title="function Test = isstoragering">isstoragering</a>
0189     LOCORespFlags.ResponseMatrixCalculator  = <span class="string">'Linear'</span>;
0190     LOCORespFlags.ClosedOrbitType           = <span class="string">'fixedpathlength'</span>;
0191     LOCORespFlags.MachineType               = <span class="string">'StorageRing'</span>;
0192 <span class="keyword">else</span>
0193     <span class="comment">% Full is usually as fast as Linear for transport lines</span>
0194     LOCORespFlags.ResponseMatrixCalculator  = <span class="string">'full'</span>;
0195     LOCORespFlags.ClosedOrbitType           = <span class="string">'fixedmomentum'</span>;
0196     LOCORespFlags.MachineType               = <span class="string">'Transport'</span>;
0197 <span class="keyword">end</span>
0198 
0199 WaitFlag = -2;
0200 ExtraDelay = 0; 
0201 StructOutputFlag = 0;
0202 NumericOutputFlag = 0;
0203 DisplayFlag = -1;
0204 ArchiveFlag = -1;
0205 FileName = -1;
0206 DirectoryName = <span class="string">''</span>;
0207 ModeFlag = <span class="string">''</span>;  <span class="comment">% model, online, manual, or '' for default mode</span>
0208 UnitsFlag = <span class="string">''</span>; <span class="comment">% hardware, physics, or '' for default units</span>
0209 
0210 InputFlags = {};
0211 DCCTFlag = {};
0212 <span class="keyword">for</span> i = length(varargin):-1:1
0213     <span class="keyword">if</span> isstruct(varargin{i})
0214         <span class="comment">% Ignore structures</span>
0215     <span class="keyword">elseif</span> iscell(varargin{i})
0216         <span class="comment">% Ignore cells</span>
0217     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0218         StructOutputFlag = 1;
0219         varargin(i) = [];
0220     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0221         StructOutputFlag = 0;
0222         NumericOutputFlag = 1;
0223         varargin(i) = [];
0224     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Model'</span>)
0225         ModeFlag = varargin{i};
0226         InputFlags = [InputFlags varargin(i)];
0227         varargin(i) = [];
0228     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>)
0229         ModeFlag = varargin{i};
0230         InputFlags = [InputFlags varargin(i)];
0231         varargin(i) = [];
0232     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0233         ModeFlag = varargin{i};
0234         InputFlags = [InputFlags varargin(i)];
0235         varargin(i) = [];
0236     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0237         ModeFlag = varargin{i};
0238         InputFlags = [InputFlags varargin(i)];
0239         varargin(i) = [];
0240     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Physics'</span>)
0241         UnitsFlag = varargin{i};
0242         InputFlags = [InputFlags varargin(i)];
0243         varargin(i) = [];
0244     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Hardware'</span>)
0245         UnitsFlag = varargin{i};
0246         InputFlags = [InputFlags varargin(i)];
0247         varargin(i) = [];
0248     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Archive'</span>)
0249         ArchiveFlag = 1;
0250         <span class="keyword">if</span> length(varargin) &gt; i
0251             <span class="comment">% Look for a filename as the next input</span>
0252             <span class="keyword">if</span> ischar(varargin{i+1})
0253                 FileName = varargin{i+1};
0254                 varargin(i+1) = [];
0255             <span class="keyword">end</span>
0256         <span class="keyword">end</span>
0257         varargin(i) = [];
0258     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoArchive'</span>)
0259         ArchiveFlag = 0;
0260         varargin(i) = [];
0261     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>)
0262         DisplayFlag = 0;
0263         InputFlags = [InputFlags varargin(i)];
0264         varargin(i) = [];
0265     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0266         DisplayFlag = 1;
0267         InputFlags = [InputFlags varargin(i)];
0268         varargin(i) = [];
0269 
0270     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'unipolar'</span>) || strcmpi(varargin{i},<span class="string">'oneway'</span>)
0271         ModulationMethod = <span class="string">'unipolar'</span>;
0272         LOCORespFlags.ResponseMatrixMeasurement = <span class="string">'oneway'</span>;
0273         varargin(i) = [];
0274     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'bipolar'</span>) || strcmpi(varargin{i},<span class="string">'bidirectional'</span>)
0275         ModulationMethod = <span class="string">'bipolar'</span>;
0276         LOCORespFlags.ResponseMatrixMeasurement = <span class="string">'bidirectional'</span>;
0277         varargin(i) = [];
0278 
0279     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'FixedPathLength'</span>)
0280         LOCORespFlags.ClosedOrbitType = <span class="string">'FixedPathLength'</span>;
0281         varargin(i) = [];
0282     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'FixedMomentum'</span>)
0283         LOCORespFlags.ClosedOrbitType = <span class="string">'FixedMomentum'</span>;
0284         varargin(i) = [];
0285     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Linear'</span>)
0286         LOCORespFlags.ResponseMatrixCalculator = <span class="string">'Linear'</span>;
0287         varargin(i) = [];
0288     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Full'</span>)
0289         LOCORespFlags.ResponseMatrixCalculator = <span class="string">'Full'</span>;
0290         varargin(i) = [];
0291 
0292     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'MinimumBeamCurrent'</span>)
0293         DCCTFlag = [varargin(i) varargin(i+1)];
0294         varargin(i+1) = [];
0295         varargin(i)   = [];
0296     <span class="keyword">end</span>
0297 <span class="keyword">end</span>
0298 
0299 <span class="comment">%%%%%%%%%%%%%%%%</span>
0300 <span class="comment">% Parse Inputs %</span>
0301 <span class="comment">%%%%%%%%%%%%%%%%</span>
0302 
0303 <span class="comment">% Look for BPMx family info</span>
0304 <span class="keyword">if</span> length(varargin) &gt;= 1
0305     <span class="keyword">if</span> isstruct(varargin{1})
0306         BPMxFamily = varargin{1}.FamilyName;
0307         BPMxList = varargin{1}.DeviceList;
0308 
0309         <span class="comment">% For structure inputs, units are determined by the first input</span>
0310         <span class="keyword">if</span> isempty(UnitsFlag)
0311             UnitsFlag = varargin{1}.Units;
0312         <span class="keyword">end</span>
0313 
0314         varargin(1) = [];
0315         
0316         <span class="comment">% Only change StructOutputFlag if 'Numeric' is not on the input line</span>
0317         <span class="keyword">if</span> ~NumericOutputFlag
0318             StructOutputFlag = 1;
0319         <span class="keyword">end</span>
0320     <span class="keyword">elseif</span> ischar(varargin{1})
0321         BPMxFamily = varargin{1};
0322         varargin(1) = [];
0323         <span class="keyword">if</span> length(varargin) &gt;= 1
0324             <span class="keyword">if</span> isnumeric(varargin{1})
0325                 BPMxList = varargin{1};
0326                 varargin(1) = [];
0327             <span class="keyword">end</span>
0328         <span class="keyword">end</span>
0329     <span class="keyword">elseif</span> isnumeric(varargin{1})
0330         BPMxList = varargin{1};
0331         varargin(1) = [];
0332     <span class="keyword">end</span>
0333 <span class="keyword">end</span>
0334 <span class="keyword">if</span> isempty(BPMxList)
0335     BPMxList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(BPMxFamily, 1);
0336 <span class="keyword">end</span>
0337 
0338 <span class="comment">% Look for BPMy family info</span>
0339 <span class="keyword">if</span> length(varargin) &gt;= 1
0340     <span class="keyword">if</span> isstruct(varargin{1})
0341         BPMyFamily = varargin{1}.FamilyName;
0342         BPMyList = varargin{1}.DeviceList;
0343         varargin(1) = [];
0344         <span class="keyword">if</span> ~NumericOutputFlag
0345             StructOutputFlag = 1; <span class="comment">% Only change StructOutputFlag if 'Numeric' is not on the input line</span>
0346         <span class="keyword">end</span>
0347     <span class="keyword">elseif</span> ischar(varargin{1})
0348         BPMyFamily = varargin{1};
0349         varargin(1) = [];
0350         <span class="keyword">if</span> length(varargin) &gt;= 1
0351             <span class="keyword">if</span> isnumeric(varargin{1})
0352                 BPMyList = varargin{1};
0353                 varargin(1) = [];
0354             <span class="keyword">end</span>
0355         <span class="keyword">end</span>
0356     <span class="keyword">elseif</span> isnumeric(varargin{1})
0357         BPMyList = varargin{1};
0358         varargin(1) = [];
0359     <span class="keyword">end</span>
0360 <span class="keyword">end</span>
0361 <span class="keyword">if</span> isempty(BPMyList)
0362     BPMyList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(BPMyFamily, 1);
0363 <span class="keyword">end</span>
0364 
0365 <span class="comment">% Look for HCM family info</span>
0366 <span class="keyword">if</span> length(varargin) &gt;= 1
0367     <span class="keyword">if</span> isstruct(varargin{1})
0368         HCMFamily = varargin{1}.FamilyName;
0369         HCMList = varargin{1}.DeviceList;
0370         varargin(1) = [];
0371         <span class="keyword">if</span> ~NumericOutputFlag
0372             StructOutputFlag = 1; <span class="comment">% Only change StructOutputFlag if 'Numeric' is not on the input line</span>
0373         <span class="keyword">end</span>
0374     <span class="keyword">elseif</span> ischar(varargin{1})
0375         HCMFamily = varargin{1};
0376         varargin(1) = [];
0377         <span class="keyword">if</span> length(varargin) &gt;= 1
0378             <span class="keyword">if</span> isnumeric(varargin{1})
0379                 HCMList = varargin{1};
0380                 varargin(1) = [];
0381             <span class="keyword">end</span>
0382         <span class="keyword">end</span>
0383     <span class="keyword">elseif</span> isnumeric(varargin{1})
0384         HCMList = varargin{1};
0385         varargin(1) = [];
0386     <span class="keyword">end</span>
0387 <span class="keyword">end</span>
0388 <span class="keyword">if</span> isempty(HCMList)
0389     HCMList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(HCMFamily, 1);
0390 <span class="keyword">end</span>
0391 
0392 <span class="comment">% Look for VCM family info</span>
0393 <span class="keyword">if</span> length(varargin) &gt;= 1
0394     <span class="keyword">if</span> isstruct(varargin{1})
0395         VCMFamily = varargin{1}.FamilyName;
0396         VCMList = varargin{1}.DeviceList;
0397         varargin(1) = [];
0398         <span class="keyword">if</span> ~NumericOutputFlag
0399             StructOutputFlag = 1; <span class="comment">% Only change StructOutputFlag if 'Numeric' is not on the input line</span>
0400         <span class="keyword">end</span>
0401     <span class="keyword">elseif</span> ischar(varargin{1})
0402         VCMFamily = varargin{1};
0403         varargin(1) = [];
0404         <span class="keyword">if</span> length(varargin) &gt;= 1
0405             <span class="keyword">if</span> isnumeric(varargin{1})
0406                 VCMList = varargin{1};
0407                 varargin(1) = [];
0408             <span class="keyword">end</span>
0409         <span class="keyword">end</span>
0410     <span class="keyword">elseif</span> isnumeric(varargin{1})
0411         VCMList = varargin{1};
0412         varargin(1) = [];
0413     <span class="keyword">end</span>
0414 <span class="keyword">end</span>
0415 <span class="keyword">if</span> isempty(VCMList)
0416     VCMList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(VCMFamily, 1);
0417 <span class="keyword">end</span>
0418 
0419 <span class="comment">% Look for HCMKicks</span>
0420 <span class="keyword">if</span> length(varargin) &gt;= 1
0421     <span class="keyword">if</span> isempty(varargin{1})
0422         <span class="comment">% Use default</span>
0423         varargin(1) = [];
0424     <span class="keyword">elseif</span> isnumeric(varargin{1})
0425         HCMKicks = varargin{1};
0426         varargin(1) = [];
0427     <span class="keyword">end</span>
0428 <span class="keyword">end</span>
0429 
0430 <span class="comment">% Look for VCMKicks</span>
0431 <span class="keyword">if</span> length(varargin) &gt;= 1
0432     <span class="keyword">if</span> isempty(varargin{1})
0433         <span class="comment">% Use default</span>
0434         varargin(1) = [];
0435     <span class="keyword">elseif</span> isnumeric(varargin{1})
0436         VCMKicks = varargin{1};
0437         varargin(1) = [];
0438     <span class="keyword">end</span>
0439 <span class="keyword">end</span>
0440 
0441 <span class="comment">% ModulationMethod has already been searched for</span>
0442 <span class="comment">% % Look for ModulationMethod</span>
0443 <span class="comment">% if length(varargin) &gt;= 1</span>
0444 <span class="comment">%     if isempty(varargin{1})</span>
0445 <span class="comment">%         % Use default</span>
0446 <span class="comment">%         varargin(1) = [];</span>
0447 <span class="comment">%     end</span>
0448 <span class="comment">%     if ischar(varargin{1})</span>
0449 <span class="comment">%         ModulationMethod = varargin{1};</span>
0450 <span class="comment">%         varargin(1) = [];</span>
0451 <span class="comment">%     end</span>
0452 <span class="comment">% end</span>
0453 <span class="keyword">if</span> ~strcmpi(ModulationMethod, <span class="string">'unipolar'</span>) &amp;&amp; ~strcmpi(ModulationMethod, <span class="string">'bipolar'</span>)
0454     error(<span class="string">'ModulationMethod must be ''unipolar'' or ''bipolar'''</span>);
0455 <span class="keyword">end</span>
0456 
0457 
0458 <span class="comment">% Look for WaitFlag</span>
0459 <span class="keyword">if</span> length(varargin) &gt;= 1
0460     <span class="keyword">if</span> isempty(varargin{1})
0461         <span class="comment">% Use default</span>
0462         varargin(1) = [];
0463     <span class="keyword">end</span>
0464     <span class="keyword">if</span> isnumeric(varargin{1})
0465         WaitFlag = varargin{1};
0466         varargin(1) = [];
0467     <span class="keyword">end</span>
0468 <span class="keyword">end</span>
0469 
0470 <span class="comment">% FileName and DirectoryName</span>
0471 <span class="keyword">if</span> length(varargin) &gt;= 1
0472     <span class="keyword">if</span> isempty(varargin{1})
0473         <span class="comment">% Use default</span>
0474         FileName = <span class="string">''</span>;
0475         varargin(1) = [];
0476     <span class="keyword">end</span>
0477     <span class="keyword">if</span> ischar(varargin{1})
0478         FileName = varargin{1};
0479         varargin(1) = [];
0480     <span class="keyword">end</span>
0481 <span class="keyword">end</span>
0482 <span class="keyword">if</span> length(varargin) &gt;= 1
0483     <span class="keyword">if</span> isempty(varargin{1})
0484         <span class="comment">% Use default</span>
0485         DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'BPMResponse'</span>);
0486         FileName = [DirectoryName, FileName];
0487         varargin(1) = [];
0488     <span class="keyword">elseif</span> ischar(varargin{1})
0489         DirectoryName = varargin{1};
0490         <span class="keyword">if</span> strcmp(DirectoryName, filesep)
0491             FileName = [DirectoryName, FileName];
0492         <span class="keyword">else</span>
0493             FileName = [DirectoryName, filesep, FileName];
0494         <span class="keyword">end</span>
0495         varargin(1) = [];
0496     <span class="keyword">end</span>
0497 <span class="keyword">end</span>
0498 
0499 <span class="comment">% Look for ExtraDelay</span>
0500 <span class="keyword">if</span> length(varargin) &gt;= 1
0501     <span class="keyword">if</span> isempty(varargin{1})
0502         <span class="comment">% Use default</span>
0503         varargin(1) = [];
0504     <span class="keyword">end</span>
0505     <span class="keyword">if</span> isnumeric(varargin{1})
0506         ExtraDelay = varargin{1};
0507         varargin(1) = [];
0508     <span class="keyword">end</span>
0509 <span class="keyword">end</span>
0510 
0511 <span class="comment">% Check units</span>
0512 <span class="keyword">if</span> isempty(UnitsFlag)
0513     <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMxFamily,<span class="string">'Monitor'</span>,<span class="string">'Units'</span>), <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMyFamily,<span class="string">'Monitor'</span>,<span class="string">'Units'</span>))
0514         UnitsFlag = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMxFamily,<span class="string">'Monitor'</span>,<span class="string">'Units'</span>);
0515     <span class="keyword">else</span>
0516         error(<span class="string">'Mixed Units for orbits'</span>);
0517     <span class="keyword">end</span>
0518 <span class="keyword">end</span>
0519 <span class="keyword">if</span> isempty(UnitsFlag)
0520     error(<span class="string">'Unknown Units'</span>);
0521 <span class="keyword">end</span>
0522 
0523 <span class="comment">% Check mode</span>
0524 <span class="keyword">if</span> isempty(ModeFlag)
0525     <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMxFamily,<span class="string">'Monitor'</span>,<span class="string">'Mode'</span>), <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMyFamily,<span class="string">'Monitor'</span>,<span class="string">'Mode'</span>))
0526         <span class="comment">%ModeFlag = getfamilydata(BPMxFamily,'Monitor','Mode');</span>
0527     <span class="keyword">else</span>
0528         error(<span class="string">'Mixed Mode for orbits'</span>);
0529     <span class="keyword">end</span>
0530     <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(HCMFamily,<span class="string">'Monitor'</span>,<span class="string">'Mode'</span>), <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(VCMFamily,<span class="string">'Monitor'</span>,<span class="string">'Mode'</span>))
0531         ModeFlag = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(HCMFamily,<span class="string">'Monitor'</span>,<span class="string">'Mode'</span>);
0532     <span class="keyword">else</span>
0533         error(<span class="string">'Mixed Mode for correctors'</span>);
0534     <span class="keyword">end</span>
0535 <span class="keyword">end</span>
0536 <span class="keyword">if</span> isempty(ModeFlag)
0537     error(<span class="string">'Unknown Mode'</span>);
0538 <span class="keyword">end</span>
0539 <span class="comment">% Input parsing complete</span>
0540 
0541 
0542 <span class="comment">% Starting time</span>
0543 TimeStart = gettime;
0544 
0545 
0546 <span class="comment">% Change defaults for the model (note: simulator mode mimics online)</span>
0547 <span class="keyword">if</span> strcmpi(ModeFlag,<span class="string">'Model'</span>)
0548     <span class="comment">% Only archive data if ArchiveFlag==1 or FileName~=[]</span>
0549     <span class="keyword">if</span> ischar(FileName) || ArchiveFlag == 1
0550         ArchiveFlag = 1;    
0551     <span class="keyword">else</span>
0552         ArchiveFlag = 0;            
0553     <span class="keyword">end</span>
0554     
0555     <span class="comment">% Only display is it was turned on at the command line</span>
0556     <span class="keyword">if</span> DisplayFlag == 1
0557         <span class="comment">% Keep DisplayFlag = 1</span>
0558     <span class="keyword">else</span>
0559         DisplayFlag = 0;
0560     <span class="keyword">end</span>
0561 <span class="keyword">else</span>
0562     <span class="comment">% Online or Simulator: Archive unless ArchiveFlag was forced to zero</span>
0563     <span class="keyword">if</span> ArchiveFlag ~= 0
0564         ArchiveFlag = 1;
0565         <span class="keyword">if</span> FileName == -1
0566             FileName = <span class="string">''</span>;
0567         <span class="keyword">end</span>
0568     <span class="keyword">end</span>    
0569 <span class="keyword">end</span>
0570 
0571 <span class="comment">% % Print setup information</span>
0572 <span class="comment">% if DisplayFlag</span>
0573 <span class="comment">%     if ~strcmpi(ModeFlag,'Model')</span>
0574 <span class="comment">%         fprintf('\n');</span>
0575 <span class="comment">%         fprintf('   MEASBPMRESP measures the BPM response matrix for both HCM &amp; VCM corrector families.\n');</span>
0576 <span class="comment">%         fprintf('   The storage ring lattice and hardware should be setup for accurate orbit measurements.\n');</span>
0577 <span class="comment">%         fprintf('   Make sure the following information is correct:\n');</span>
0578 <span class="comment">%         fprintf('   1.  Proper magnet lattice\n');</span>
0579 <span class="comment">%         fprintf('   2.  Proper electron beam energy\n');</span>
0580 <span class="comment">%         fprintf('   3.  Proper electron bunch pattern\n');</span>
0581 <span class="comment">%         fprintf('   4.  BPMs are functioning properly (calibrated, sample rate, etc.)\n');</span>
0582 <span class="comment">%         fprintf('   5.  Corrector magnets are working\n');</span>
0583 <span class="comment">%         fprintf('   6.  The injection bump magnets off\n');</span>
0584 <span class="comment">%         fprintf('   7.  Corrector Settle Time WaitFlag=%f, Extra BPM Delay=%f\n', WaitFlag, ExtraDelay);</span>
0585 <span class="comment">%         fprintf('   9.  Modulation Method: %s\n', ModulationMethod);</span>
0586 <span class="comment">%     end</span>
0587 <span class="comment">% end</span>
0588 
0589 
0590 <span class="keyword">if</span> ArchiveFlag
0591     <span class="keyword">if</span> isempty(FileName)
0592         FileName = appendtimestamp(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Default'</span>, <span class="string">'BPMRespFile'</span>));
0593         DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'BPMResponse'</span>);
0594         <span class="keyword">if</span> isempty(DirectoryName)
0595             DirectoryName = [<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>,<span class="string">'DataRoot'</span>), <span class="string">'Response'</span>, filesep, <span class="string">'BPM'</span>, filesep];
0596         <span class="keyword">else</span>
0597             <span class="comment">% Make sure default directory exists</span>
0598             DirStart = pwd;
0599             [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
0600             cd(DirStart);
0601         <span class="keyword">end</span>
0602         [FileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Select a BPM Response File (&quot;Save&quot; starts measurement)'</span>, [DirectoryName FileName]);
0603         drawnow;
0604         <span class="keyword">if</span> FileName == 0 
0605             ArchiveFlag = 0;
0606             disp(<span class="string">'   BPM response measurement canceled.'</span>);
0607             Rmat = []; OutputFileName=<span class="string">''</span>;
0608             <span class="keyword">return</span>
0609         <span class="keyword">end</span>
0610         FileName = [DirectoryName, FileName];
0611     <span class="keyword">elseif</span> FileName == -1
0612         FileName = appendtimestamp(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Default'</span>, <span class="string">'BPMRespFile'</span>));
0613         DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'BPMResponse'</span>);
0614         <span class="keyword">if</span> isempty(DirectoryName)
0615             DirectoryName = [<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>,<span class="string">'DataRoot'</span>), <span class="string">'Response'</span>, filesep, <span class="string">'BPM'</span>, filesep];
0616         <span class="keyword">end</span>
0617         FileName = [DirectoryName, FileName];
0618     <span class="keyword">end</span>
0619     
0620     <span class="comment">% Acquire initial data</span>
0621     MachineConfig = <a href="getmachineconfig.html" class="code" title="function [ConfigSetpoint, ConfigMonitor, FileName] = getmachineconfig(varargin)">getmachineconfig</a>(InputFlags{:}); 
0622 <span class="keyword">end</span>
0623 
0624 
0625 <span class="comment">% Get the response matrices</span>
0626 <span class="keyword">if</span> strcmpi(ModeFlag,<span class="string">'Model'</span>)
0627     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0628     <span class="comment">% Model Response Matrix - Use LOCO Method %</span>
0629     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0630 
0631     <span class="comment">% Just to make sure the proper AT model is the currrent model, do a get on one of the correctors</span>
0632     <span class="comment">% (This is needed because locoresponsematrix does not check the .AT.ATModel field)</span>
0633     <span class="keyword">if</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(HCMFamily)
0634         tmp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList);
0635     <span class="keyword">end</span>
0636 
0637 
0638     <span class="comment">% % Mask bpms and correctors for status</span>
0639     <span class="comment">% BPMxStatus = getfamilydata(BPMxFamily,'Status', BPMxList);</span>
0640     <span class="comment">% BPMxGoodIndex = find(BPMxStatus);</span>
0641     <span class="comment">% BPMxList = BPMxList(BPMxGoodIndex,:);</span>
0642     <span class="comment">%</span>
0643     <span class="comment">% BPMyStatus = getfamilydata(BPMyFamily,'Status', BPMyList);</span>
0644     <span class="comment">% BPMyGoodIndex = find(BPMyStatus);</span>
0645     <span class="comment">% BPMyList = BPMyList(BPMyGoodIndex,:);</span>
0646     <span class="comment">%</span>
0647     <span class="comment">% HCMStatus = getfamilydata(HCMFamily,'Status', HCMList);</span>
0648     <span class="comment">% HCMGoodIndex = find(HCMStatus);</span>
0649     <span class="comment">% HCMList = HCMList(HCMGoodIndex,:);</span>
0650     <span class="comment">% HCMKicks = HCMKicks(HCMGoodIndex);</span>
0651     <span class="comment">%</span>
0652     <span class="comment">% VCMStatus = getfamilydata(VCMFamily,'Status', VCMList);</span>
0653     <span class="comment">% VCMGoodIndex = find(VCMStatus);</span>
0654     <span class="comment">% VCMList = VCMList(VCMGoodIndex,:);</span>
0655     <span class="comment">% VCMKicks = VCMKicks(VCMGoodIndex);</span>
0656     
0657     <span class="comment">% Use AT (LOCO method)</span>
0658     
0659     <span class="comment">% 1. AT MODEL</span>
0660     <span class="keyword">global</span> THERING
0661     <span class="comment">%setcavity off;</span>
0662     RINGData.Lattice = THERING;
0663     iCavity = findcells(THERING, <span class="string">'Frequency'</span>);
0664     <span class="keyword">if</span> isempty(iCavity)
0665         <span class="keyword">if</span> <a href="isstoragering.html" class="code" title="function Test = isstoragering">isstoragering</a>
0666             RINGData.CavityFrequency  = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Model'</span>, <span class="string">'Physics'</span>);
0667             RINGData.CavityHarmNumber = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'HarmonicNumber'</span>);
0668         <span class="keyword">else</span>
0669             RINGData.CavityFrequency  = [];
0670             RINGData.CavityHarmNumber = [];
0671         <span class="keyword">end</span>
0672     <span class="keyword">else</span>
0673         RINGData.CavityFrequency  = THERING{iCavity(1)}.Frequency;
0674         RINGData.CavityHarmNumber = THERING{iCavity(1)}.HarmNumber;
0675     <span class="keyword">end</span>
0676     
0677     
0678     <span class="comment">% 2. BPM STRUCTURE</span>
0679     <span class="comment">% FamName and BPMIndex tells the findorbitrespm function which BPMs are needed in the response matrix</span>
0680     <span class="comment">% HBPMIndex/VBPMIndex is the sub-index of BPMIndex which correspond to the measured response matrix</span>
0681     <span class="keyword">if</span> strcmpi(BPMxFamily,<span class="string">'All'</span>) 
0682         BPMxATIndex = 1:length(THERING);
0683     <span class="keyword">elseif</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(BPMxFamily)
0684         BPMxATIndex = family2atindex(BPMxFamily, BPMxList);
0685     <span class="keyword">else</span>
0686         BPMxATIndex = findcells(THERING, <span class="string">'FamName'</span>, BPMxFamily);
0687     <span class="keyword">end</span>
0688     <span class="keyword">if</span> isempty(BPMxATIndex)
0689         error(sprintf(<span class="string">'BPMxFamily=%s could not be found in the AO or AT deck'</span>, BPMxFamily));
0690     <span class="keyword">else</span>
0691         BPMxATIndex = BPMxATIndex(:)';    <span class="comment">% Row vector</span>
0692     <span class="keyword">end</span>
0693     
0694     <span class="keyword">if</span> strcmpi(BPMyFamily,<span class="string">'All'</span>) 
0695         BPMyATIndex = 1:length(THERING);
0696     <span class="keyword">elseif</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(BPMyFamily)
0697         BPMyATIndex = family2atindex(BPMyFamily, BPMyList);
0698     <span class="keyword">else</span>
0699         BPMyATIndex = findcells(THERING, <span class="string">'FamName'</span>, BPMyFamily);
0700     <span class="keyword">end</span>
0701     <span class="keyword">if</span> isempty(BPMyATIndex)
0702         error(sprintf(<span class="string">'BPMyFamily=%s could not be found in the AO or AT deck'</span>, BPMyFamily));
0703     <span class="keyword">else</span>
0704         BPMyATIndex = BPMyATIndex(:)';    <span class="comment">% Row vector</span>
0705     <span class="keyword">end</span>
0706     
0707     BPMData.BPMIndex = unique([BPMxATIndex BPMyATIndex]);
0708     BPMData.HBPMIndex = findrowindex(BPMxATIndex', BPMData.BPMIndex');  <span class="comment">% Only used after locoresponsematrix is called</span>
0709     BPMData.VBPMIndex = findrowindex(BPMyATIndex', BPMData.BPMIndex');  <span class="comment">% Only used after locoresponsematrix is called</span>
0710         
0711     
0712     <span class="comment">% 3. CORRECTOR MAGNET STRUCTURE</span>
0713     <span class="comment">% FamName and HCMIndex/VCMIndex tells the findorbitrespm function which corrector magnets are in the response matrix</span>
0714     <span class="comment">% CMData.HCMKicks = starting value for the horizontal kicks in milliradian</span>
0715     <span class="comment">% CMData.VCMKicks = starting value for the vertical   kicks in milliradian</span>
0716     <span class="comment">% CMData.HCMCoupling = starting value for the horizontal coupling (default: zeros)</span>
0717     <span class="comment">% CMData.VCMCoupling = starting value for the vertical   coupling (default: zeros)</span>
0718     <span class="comment">% Note:  The kick strength should match the measured response matrix as best as possible</span>
0719     <span class="comment">% Note:  The kicks and Coupling are used all the time (fit or not!)</span>
0720     
0721     <span class="comment">% Note the different units between AT and LOCO</span>
0722     <span class="keyword">if</span> strcmpi(HCMFamily,<span class="string">'All'</span>) 
0723         ATIndex = 1:length(THERING);
0724     <span class="keyword">elseif</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(HCMFamily)
0725         ATIndex = family2atindex(HCMFamily, HCMList);
0726     <span class="keyword">else</span>
0727         ATIndex = findcells(THERING, <span class="string">'FamName'</span>, HCMFamily);
0728     <span class="keyword">end</span>
0729     <span class="keyword">if</span> isempty(ATIndex)
0730         error(sprintf(<span class="string">'HCMFamily=%s could not be found in the middle layer or AT model'</span>, HCMFamily));
0731     <span class="keyword">else</span>
0732         ATIndex = ATIndex(:)';    <span class="comment">% Row vector</span>
0733     <span class="keyword">end</span>
0734     CMData.HCMIndex = ATIndex;
0735     
0736     <span class="keyword">if</span> strcmpi(VCMFamily,<span class="string">'All'</span>) 
0737         ATIndex = 1:length(THERING);
0738     <span class="keyword">elseif</span> <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(VCMFamily)
0739         ATIndex = family2atindex(VCMFamily, VCMList);
0740     <span class="keyword">else</span>
0741         ATIndex = findcells(THERING, <span class="string">'FamName'</span>, VCMFamily);
0742     <span class="keyword">end</span>
0743     <span class="keyword">if</span> isempty(ATIndex)
0744         error(sprintf(<span class="string">'VCMFamily=%s could not be found in the middle layer or AT model'</span>, VCMFamily));
0745     <span class="keyword">else</span>
0746         ATIndex = ATIndex(:)';    <span class="comment">% Row vector</span>
0747     <span class="keyword">end</span>
0748     CMData.VCMIndex = ATIndex;
0749     
0750     <span class="comment">% Kicks must be in Physics units</span>
0751     
0752     <span class="comment">% Default kicks</span>
0753     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(HCMFamily,<span class="string">'COR'</span>)
0754         <span class="keyword">if</span> isempty(HCMKicks)
0755             HCMKicks = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(HCMFamily, <span class="string">'Setpoint'</span>, <span class="string">'DeltaRespMat'</span>, HCMList);
0756             <span class="keyword">if</span> isempty(HCMKicks)
0757                 CMData.HCMKicks = Default2HCMKick;
0758             <span class="keyword">else</span>
0759                 <span class="comment">%if strcmpi(getfamilydata(HCMFamily, 'Setpoint', 'Units'), 'Hardware')</span>
0760                     HCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
0761                     CMData.HCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp+HCMKicks, HCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp, HCMList);
0762                 <span class="comment">%else</span>
0763                 <span class="comment">%    CMData.HCMKicks = HCMKicks;</span>
0764                 <span class="comment">%end</span>
0765             <span class="keyword">end</span>
0766         <span class="keyword">else</span>
0767             <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0768                 <span class="comment">% Change to AT units [radian]</span>
0769                 HCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
0770                 CMData.HCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp+HCMKicks, HCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp, HCMList);
0771             <span class="keyword">else</span>
0772                 CMData.HCMKicks = HCMKicks;
0773             <span class="keyword">end</span>
0774         <span class="keyword">end</span>
0775     <span class="keyword">else</span>
0776         <span class="comment">% Not a corrector magnet location</span>
0777         <span class="keyword">if</span> isempty(HCMKicks)
0778             CMData.HCMKicks = Default2HCMKick; 
0779         <span class="keyword">else</span>
0780             <span class="comment">% The kick must be in physics units</span>
0781             <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0782                 fprintf(<span class="string">'\n   You are using a non-corrector magnet actuator type and using hardware units.\n'</span>);
0783                 fprintf(<span class="string">'   Unknown conversion method from hardware to physics.\n\n'</span>);
0784                 fprintf(<span class="string">'   Change to a physics units input scheme.\n'</span>);
0785                 error(<span class="string">'Hardware to physics conversion error'</span>);
0786             <span class="keyword">else</span>
0787                 CMData.HCMKicks = HCMKicks;    
0788             <span class="keyword">end</span>
0789         <span class="keyword">end</span>
0790     <span class="keyword">end</span>
0791     
0792     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(VCMFamily,<span class="string">'COR'</span>)
0793         <span class="keyword">if</span> isempty(VCMKicks)
0794             VCMKicks = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(VCMFamily, <span class="string">'Setpoint'</span>, <span class="string">'DeltaRespMat'</span>, VCMList);
0795             <span class="keyword">if</span> isempty(VCMKicks)
0796                 CMData.VCMKicks = Default2VCMKick;
0797             <span class="keyword">else</span>
0798                 <span class="comment">%if strcmpi(getfamilydata(VCMFamily, 'Setpoint', 'Units'), 'Hardware')</span>
0799                     VCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
0800                     CMData.VCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp+VCMKicks, VCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp, VCMList);
0801                 <span class="comment">%else</span>
0802                 <span class="comment">%    CMData.VCMKicks = VCMKicks;</span>
0803                 <span class="comment">%end</span>
0804             <span class="keyword">end</span>
0805         <span class="keyword">else</span>
0806             <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0807                 <span class="comment">% Change to AT units [radian]</span>
0808                 VCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
0809                 CMData.VCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp+VCMKicks, VCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp, VCMList);
0810             <span class="keyword">else</span>
0811                 CMData.VCMKicks = VCMKicks;
0812             <span class="keyword">end</span>
0813         <span class="keyword">end</span>
0814     <span class="keyword">else</span>
0815         <span class="comment">% Not a corrector magnet location</span>
0816         <span class="keyword">if</span> isempty(VCMKicks)
0817             CMData.VCMKicks = Default2VCMKick;
0818         <span class="keyword">else</span>
0819             <span class="comment">% The kick must be in physics units</span>
0820             <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
0821                 fprintf(<span class="string">'\n   You are using a non-corrector magnet actuator type and using hardware units.\n'</span>);
0822                 fprintf(<span class="string">'   Unknown conversion method from hardware to physics!\n\n'</span>);
0823                 fprintf(<span class="string">'   Change to a physics units input scheme.\n'</span>);
0824                 error(<span class="string">'Hardware to physics conversion error'</span>);
0825             <span class="keyword">else</span>
0826                 CMData.VCMKicks = VCMKicks;    
0827             <span class="keyword">end</span>
0828         <span class="keyword">end</span>
0829     <span class="keyword">end</span>
0830     
0831     CMData.HCMKicks = CMData.HCMKicks(:);
0832     <span class="keyword">if</span> length(CMData.HCMKicks) == 1
0833         CMData.HCMKicks = CMData.HCMKicks * ones(length(CMData.HCMIndex),1); 
0834     <span class="keyword">end</span>
0835     CMData.VCMKicks = CMData.VCMKicks(:);
0836     <span class="keyword">if</span> length(CMData.VCMKicks) == 1
0837         CMData.VCMKicks = CMData.VCMKicks * ones(length(CMData.VCMIndex),1); 
0838     <span class="keyword">end</span>
0839     
0840     <span class="comment">% Corrector gain error have been taken into account by hw2physics</span>
0841     <span class="comment">% If the model has corrector rolls, adjust the kicks now.</span>
0842     
0843     <span class="keyword">for</span> i = 1:length(CMData.HCMIndex)
0844         <span class="keyword">if</span> isfield(THERING{CMData.HCMIndex(i)}, <span class="string">'Roll'</span>)            
0845             Roll = THERING{CMData.HCMIndex(i)}.Roll;
0846         <span class="keyword">else</span>
0847             Roll = [0 0];  <span class="comment">% [Rollx Rolly]</span>
0848         <span class="keyword">end</span>
0849         HCMRoll(i,1) = Roll(1); 
0850     <span class="keyword">end</span>
0851     <span class="comment">%HCMRoll = getroll(HCMFamily, HCMList);</span>
0852     
0853     <span class="keyword">for</span> i = 1:length(CMData.VCMIndex)
0854         <span class="keyword">if</span> isfield(THERING{CMData.VCMIndex(i)}, <span class="string">'Roll'</span>)            
0855             Roll = THERING{CMData.VCMIndex(i)}.Roll;
0856         <span class="keyword">else</span>
0857             Roll = [0 0];  <span class="comment">% [Rollx Rolly]</span>
0858         <span class="keyword">end</span>
0859         VCMRoll(i,1) = Roll(2); 
0860     <span class="keyword">end</span>
0861     <span class="comment">%VCMRoll = getroll(VCMFamily, VCMList);</span>
0862 
0863     <span class="comment">% The kicks need to be adjusted for roll (model coordinates)</span>
0864     HCMKicks = CMData.HCMKicks;
0865     VCMKicks = CMData.VCMKicks;
0866     CMData.HCMKicks = CMData.HCMKicks .* cos(HCMRoll);
0867     CMData.VCMKicks = CMData.VCMKicks .* cos(VCMRoll);
0868     
0869     
0870     <span class="comment">% Coupling term (convert from ML to LOCO coordinates)</span>
0871     <span class="comment">% The ./cos term is needed because LOCO coupling is scaling the unrolled kick</span>
0872     CMData.HCMCoupling =  sin(HCMRoll) ./ cos(HCMRoll);
0873     CMData.VCMCoupling = -sin(VCMRoll) ./ cos(VCMRoll);
0874     
0875 
0876     <span class="comment">% Generate a response matrix ('FixedPathLength' or 'FixedMomentum', 'Linear' or 'Full')</span>
0877     <span class="comment">% Flags is empty then the locoresponsematrix defaults are used (which was fix path length, linear the last time I checked)</span>
0878     R0 = locoresponsematrix(RINGData, BPMData, CMData, LOCORespFlags);
0879 
0880     
0881     <span class="comment">% Coupling correction</span>
0882     <span class="comment">% Convert the ML gain/rolls to LOCO gain/coupling</span>
0883     <span class="comment">% for i = 1:length(BPMData.BPMIndex)</span>
0884     <span class="comment">%     if isfield(THERING{BPMData.BPMIndex(i)}, 'GCR')</span>
0885     <span class="comment">%         GCR = THERING{BPMData.BPMIndex(i)}.GCR;</span>
0886     <span class="comment">%     else</span>
0887     <span class="comment">%         GCR = [1 1 0 0];  % [Gx Gy Crunch Roll]</span>
0888     <span class="comment">%     end</span>
0889     <span class="comment">%</span>
0890     <span class="comment">%     M = gcr2loco(GCR(1), GCR(2), GCR(3), GCR(4));</span>
0891     <span class="comment">%     BPMxGainLOCO(i,1)     = M(1,1);</span>
0892     <span class="comment">%     BPMxCouplingLOCO(i,1) = M(1,2);</span>
0893     <span class="comment">%     BPMyGainLOCO(i,1)     = M(2,2);</span>
0894     <span class="comment">%     BPMyCouplingLOCO(i,1) = M(2,1);</span>
0895     <span class="comment">% end</span>
0896     <span class="comment">%</span>
0897     <span class="comment">%</span>
0898     <span class="comment">% % Build a rotation matrix</span>
0899     <span class="comment">% C = [diag(BPMxGainLOCO)      diag(BPMxCouplingLOCO)</span>
0900     <span class="comment">%      diag(BPMyCouplingLOCO)  diag(BPMyGainLOCO)];</span>
0901 
0902     
0903     <span class="comment">% BPM coupling correction (only roll, crunch correction, gain is done in physics2hw (via real2raw))</span>
0904     <span class="comment">% Still in physics units, just rotate and crunch.</span>
0905     NBPM = length(BPMData.BPMIndex);
0906     <span class="keyword">for</span> i = 1:NBPM
0907         <span class="keyword">if</span> isfield(THERING{BPMData.BPMIndex(i)}, <span class="string">'GCR'</span>)            
0908             GCR = THERING{BPMData.BPMIndex(i)}.GCR;
0909         <span class="keyword">else</span>
0910             GCR = [1 1 0 0];  <span class="comment">% [Gx Gy Crunch Roll]</span>
0911         <span class="keyword">end</span>
0912         <span class="comment">%Gx = GCR(1);  % Not used</span>
0913         <span class="comment">%Gy = GCR(2);  % Not used</span>
0914         Crunch = GCR(3);
0915         Roll = GCR(4);
0916         
0917         a(i,1) = ( Crunch * sin(Roll) + cos(Roll)) / sqrt(1 - Crunch^2);
0918         b(i,1) = (-Crunch * cos(Roll) + sin(Roll)) / sqrt(1 - Crunch^2);
0919         c(i,1) = (-Crunch * cos(Roll) - sin(Roll)) / sqrt(1 - Crunch^2);
0920         d(i,1) = (-Crunch * sin(Roll) + cos(Roll)) / sqrt(1 - Crunch^2);
0921 
0922         <span class="comment">% Same as:</span>
0923         <span class="comment">%%m = gcr2loco(GCR(1), GCR(2), GCR(3), GCR(4));</span>
0924         <span class="comment">%m = gcr2loco(1, 1, GCR(3), GCR(4));</span>
0925         <span class="comment">%a(i,1)= m(1,1);</span>
0926         <span class="comment">%b(i,1)= m(1,2);</span>
0927         <span class="comment">%c(i,1)= m(2,1);</span>
0928         <span class="comment">%d(i,1)= m(2,2);</span>
0929     <span class="keyword">end</span>
0930   
0931     <span class="comment">% Build a rotation matrix</span>
0932     C = [diag(a)  diag(b)
0933          diag(c)  diag(d)];
0934 
0935     <span class="comment">% Rotate &amp; crunch the AT model response matrix</span>
0936     R0 = C * R0;
0937     
0938 
0939     <span class="comment">% Split up R0 into an array</span>
0940     Rmat(1,1).Data = R0(                         BPMData.HBPMIndex , 1:length(CMData.HCMIndex));
0941     Rmat(2,1).Data = R0(length(BPMData.BPMIndex)+BPMData.VBPMIndex , 1:length(CMData.HCMIndex));
0942     Rmat(1,2).Data = R0(                         BPMData.HBPMIndex , length(CMData.HCMIndex)+(1:length(CMData.VCMIndex)));
0943     Rmat(2,2).Data = R0(length(BPMData.BPMIndex)+BPMData.VBPMIndex , length(CMData.HCMIndex)+(1:length(CMData.VCMIndex)));
0944     
0945     
0946     <span class="comment">% Convert to meters/radian (don't use the rolled kick strength)</span>
0947     <span class="keyword">for</span> i = 1:length(CMData.HCMKicks)
0948         Rmat(1,1).Data(:,i) = Rmat(1,1).Data(:,i) / HCMKicks(i);
0949         Rmat(2,1).Data(:,i) = Rmat(2,1).Data(:,i) / HCMKicks(i);
0950     <span class="keyword">end</span>
0951     
0952     <span class="keyword">for</span> i = 1:length(CMData.VCMKicks)
0953         Rmat(1,2).Data(:,i) = Rmat(1,2).Data(:,i) / VCMKicks(i);
0954         Rmat(2,2).Data(:,i) = Rmat(2,2).Data(:,i) / VCMKicks(i);
0955     <span class="keyword">end</span>
0956     
0957     
0958     <span class="comment">% Build the rest of the response matrix structure in 'Physics' units</span>
0959     
0960     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(BPMxFamily,<span class="string">'BPM'</span>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(BPMyFamily,<span class="string">'BPM'</span>)
0961         <span class="comment">% getpvmodel is better because crunch and roll are included</span>
0962         Xat = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMxFamily, BPMxList, <span class="string">'Physics'</span>);
0963         Yat = <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>(BPMyFamily, BPMyList, <span class="string">'Physics'</span>);
0964     <span class="keyword">else</span>
0965         <span class="comment">% The orbit does not have to be at the BPMs so use modeltwiss</span>
0966         [Xat, Yat, Sx, Sy] = modeltwiss(<span class="string">'ClosedOrbit'</span>, BPMxFamily, BPMxList, BPMyFamily, BPMyList);
0967     <span class="keyword">end</span>
0968     X.Data = Xat(:);
0969     Y.Data = Yat(:);
0970     X.FamilyName = BPMxFamily;
0971     Y.FamilyName = BPMyFamily;
0972     X.Field = <span class="string">'Monitor'</span>;
0973     Y.Field = <span class="string">'Monitor'</span>;
0974     X.DeviceList = BPMxList;
0975     Y.DeviceList = BPMyList;
0976     X.Status = ones(length(Xat),1);
0977     Y.Status = ones(length(Yat),1);
0978     X.Mode = <span class="string">'Model'</span>;
0979     Y.Mode = <span class="string">'Model'</span>;
0980     X.t = 0;
0981     Y.t = 0;
0982     X.tout = 0;
0983     Y.tout = 0;
0984     X.TimeStamp = clock;
0985     Y.TimeStamp = X.TimeStamp;
0986     X.Units = <span class="string">'Physics'</span>;
0987     Y.Units = <span class="string">'Physics'</span>;
0988     X.UnitsString = <span class="string">'m'</span>;
0989     Y.UnitsString = <span class="string">'m'</span>;
0990     X.DataDescriptor = <span class="string">'Horizontal Orbit'</span>;
0991     Y.DataDescriptor = <span class="string">'Vertical Orbit'</span>;
0992     X.CreatedBy = <span class="string">'getpv'</span>;
0993     Y.CreatedBy = <span class="string">'getpv'</span>;
0994     
0995     HCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList, <span class="string">'Struct'</span>, ModeFlag, <span class="string">'Physics'</span>);
0996     VCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMList, <span class="string">'Struct'</span>, ModeFlag, <span class="string">'Physics'</span>);
0997     Rmat(1,1).Monitor = X;
0998     Rmat(1,1).Actuator = HCMsp;
0999     Rmat(1,2).Monitor = X;
1000     Rmat(1,2).Actuator = VCMsp;
1001     Rmat(2,1).Monitor = Y;
1002     Rmat(2,1).Actuator = HCMsp;
1003     Rmat(2,2).Monitor = Y;
1004     Rmat(2,2).Actuator = VCMsp;
1005     
1006     Rmat(1,1).ActuatorDelta = HCMKicks;  <span class="comment">%CMData.HCMKicks;</span>
1007     Rmat(2,1).ActuatorDelta = HCMKicks;  <span class="comment">%CMData.HCMKicks;</span>
1008     Rmat(1,2).ActuatorDelta = VCMKicks;  <span class="comment">%CMData.VCMKicks;</span>
1009     Rmat(2,2).ActuatorDelta = VCMKicks;  <span class="comment">%CMData.VCMKicks;</span>
1010     
1011     <span class="keyword">for</span> i = 1:2
1012         <span class="keyword">for</span> j = 1:2
1013             Rmat(i,j).GeV = getenergymodel;
1014             Rmat(i,j).TimeStamp = X.TimeStamp;
1015             Rmat(i,j).DCCT = [];
1016             Rmat(i,j).ModulationMethod = ModulationMethod;
1017             Rmat(i,j).WaitFlag = WaitFlag;
1018             Rmat(i,j).ExtraDelay = ExtraDelay;
1019             Rmat(i,j).Units = <span class="string">'Physics'</span>;
1020             Rmat(i,j).UnitsString = [Rmat(1,1).Monitor.UnitsString, <span class="string">'/'</span>, Rmat(1,1).Actuator.UnitsString];
1021             Rmat(i,j).DataDescriptor = <span class="string">'Response Matrix'</span>;
1022             Rmat(i,j).CreatedBy = <span class="string">'measbpmresp'</span>;
1023             Rmat(i,j).OperationalMode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'OperationalMode'</span>);
1024         <span class="keyword">end</span>
1025     <span class="keyword">end</span>
1026             
1027     <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>)
1028         <span class="comment">% Change to hardware units [mm/amp]</span>
1029         <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(BPMxFamily,<span class="string">'BPM'</span>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(BPMyFamily,<span class="string">'BPM'</span>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(HCMFamily,<span class="string">'COR'</span>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(VCMFamily,<span class="string">'COR'</span>)
1030             Rmat = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(Rmat, getenergymodel);
1031         <span class="keyword">else</span>
1032             fprintf(<span class="string">'\n   You are asking for hardware units, but a nonstandard monitor and/or\n'</span>);
1033             fprintf(<span class="string">'   actuator was used.  The response matrix will stay in physics units!\n\n'</span>);
1034         <span class="keyword">end</span>
1035     <span class="keyword">end</span>
1036 
1037 <span class="keyword">else</span>
1038     
1039     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1040     <span class="comment">% Online or Simulated Response Matrix %</span>
1041     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1042     
1043     <span class="comment">% Default kicks</span>
1044     <span class="keyword">if</span> isempty(HCMKicks)
1045         HCMKicks = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(HCMFamily, <span class="string">'Setpoint'</span>, <span class="string">'DeltaRespMat'</span>, HCMList);
1046         KickUnits = <span class="string">'Hardware'</span>; <span class="comment">%getfamilydata(HCMFamily, 'Setpoint', 'Units');</span>
1047         <span class="keyword">if</span> isempty(HCMKicks)
1048             HCMKicks = Default2HCMKick;
1049             KickUnits = <span class="string">'Physics'</span>;
1050         <span class="keyword">end</span>
1051         <span class="keyword">if</span> isempty(KickUnits)
1052             error(<span class="string">'Units for the kick strength are unknown.  Try inputing units directly.'</span>);
1053         <span class="keyword">end</span>
1054         <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Physics'</span>) &amp;&amp; strcmpi(KickUnits, <span class="string">'Hardware'</span>) 
1055             HCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
1056             HCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp+HCMKicks, HCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp, HCMList);
1057         <span class="keyword">elseif</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>) &amp;&amp; strcmpi(KickUnits, <span class="string">'Physics'</span>) 
1058             HCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(HCMFamily, HCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Physics'</span>);
1059             HCMKicks = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp+HCMKicks, HCMList) - <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(HCMFamily, <span class="string">'Setpoint'</span>, HCMsp, HCMList);
1060         <span class="keyword">end</span>
1061     <span class="keyword">end</span>
1062     <span class="keyword">if</span> isempty(VCMKicks)
1063         VCMKicks = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(VCMFamily, <span class="string">'Setpoint'</span>, <span class="string">'DeltaRespMat'</span>, VCMList);
1064         KickUnits = <span class="string">'Hardware'</span>; <span class="comment">%getfamilydata(VCMFamily, 'Setpoint', 'Units');</span>
1065         <span class="keyword">if</span> isempty(VCMKicks)
1066             VCMKicks = Default2VCMKick;
1067             KickUnits = <span class="string">'Physics'</span>;
1068         <span class="keyword">end</span>
1069         <span class="keyword">if</span> isempty(KickUnits)
1070             error(<span class="string">'Units for the kick strength are unknown.  Try inputing units directly.'</span>);
1071         <span class="keyword">end</span>
1072         <span class="keyword">if</span> strcmpi(UnitsFlag, <span class="string">'Physics'</span>) &amp;&amp; strcmpi(KickUnits, <span class="string">'Hardware'</span>) 
1073             VCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Hardware'</span>);
1074             VCMKicks = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp+VCMKicks, VCMList) - <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp, VCMList);
1075         <span class="keyword">elseif</span> strcmpi(UnitsFlag, <span class="string">'Hardware'</span>) &amp;&amp; strcmpi(KickUnits, <span class="string">'Physics'</span>) 
1076             VCMsp = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(VCMFamily, VCMList, <span class="string">'Numeric'</span>, ModeFlag, <span class="string">'Physics'</span>);
1077             VCMKicks = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp+VCMKicks, VCMList) - <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(VCMFamily, <span class="string">'Setpoint'</span>, VCMsp, VCMList);
1078         <span class="keyword">end</span>
1079     <span class="keyword">end</span>
1080     
1081     <span class="comment">%% Query to begin measurement</span>
1082     <span class="comment">%if DisplayFlag</span>
1083     <span class="comment">%    tmp = questdlg('Begin response matrix measurement?','Response Matrix Measurement','Yes','No','No');</span>
1084     <span class="comment">%    if strcmpi(tmp,'No')</span>
1085     <span class="comment">%        fprintf('   Response matrix measurement aborted\n');</span>
1086     <span class="comment">%        Rmat = [];</span>
1087     <span class="comment">%        return</span>
1088     <span class="comment">%    end</span>
1089     <span class="comment">%end</span>
1090     
1091     <span class="comment">% Mask bpms and correctors for status</span>
1092     BPMxStatus = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMxFamily,<span class="string">'Status'</span>, BPMxList);
1093     BPMxGoodIndex = find(BPMxStatus);
1094     BPMxList = BPMxList(BPMxGoodIndex,:);
1095     
1096     BPMyStatus = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(BPMyFamily,<span class="string">'Status'</span>, BPMyList);
1097     BPMyGoodIndex = find(BPMyStatus);
1098     BPMyList = BPMyList(BPMyGoodIndex,:);
1099     
1100     HCMStatus = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(HCMFamily,<span class="string">'Status'</span>, HCMList);
1101     HCMGoodIndex = find(HCMStatus);
1102     HCMList = HCMList(HCMGoodIndex,:);
1103     <span class="keyword">if</span> length(HCMKicks) == 1
1104         HCMKicks = HCMKicks * ones(length(HCMGoodIndex),1);
1105     <span class="keyword">else</span>
1106         HCMKicks = HCMKicks(HCMGoodIndex);
1107     <span class="keyword">end</span>
1108 
1109     VCMStatus = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(VCMFamily,<span class="string">'Status'</span>, VCMList);
1110     VCMGoodIndex = find(VCMStatus);
1111     VCMList = VCMList(VCMGoodIndex,:);
1112     <span class="keyword">if</span> length(VCMKicks) == 1
1113         VCMKicks = VCMKicks * ones(length(VCMGoodIndex),1);
1114     <span class="keyword">else</span>
1115         VCMKicks = VCMKicks(VCMGoodIndex);
1116     <span class="keyword">end</span>
1117     
1118     <span class="comment">% Measure response matrix of all planes at once</span>
1119     <span class="comment">% (One advantage of this is the limits of all planes get checked before the measurement starts)</span>
1120     <span class="keyword">if</span> DisplayFlag
1121         fprintf(<span class="string">'   Begin BPM response matrix measurement\n'</span>);
1122     <span class="keyword">end</span>
1123     
1124     <span class="comment">%if strcmpi(getfamilydata('Machine'), 'ALS')</span>
1125     <span class="comment">%    fprintf('   Using measrespmat_als (with orbit correction)\n');</span>
1126     <span class="comment">%    Rcell = measrespmat_als({BPMxFamily,BPMyFamily}, {BPMxList,BPMyList}, {HCMFamily,VCMFamily}, {HCMList,VCMList}, {HCMKicks,VCMKicks}, 'Struct', ModulationMethod, WaitFlag, ExtraDelay, InputFlags{:}, DCCTFlag{:});</span>
1127     <span class="comment">%else</span>
1128         Rcell = <a href="measrespmat.html" class="code" title="function S = measrespmat(varargin)">measrespmat</a>({BPMxFamily,BPMyFamily}, {BPMxList,BPMyList}, {HCMFamily,VCMFamily}, {HCMList,VCMList}, {HCMKicks,VCMKicks}, <span class="string">'Struct'</span>, ModulationMethod, WaitFlag, ExtraDelay, InputFlags{:}, DCCTFlag{:});
1129     <span class="comment">%end</span>
1130     <span class="keyword">if</span> DisplayFlag
1131         fprintf(<span class="string">'   Measurement complete.\n\n'</span>);
1132     <span class="keyword">end</span>
1133 
1134     <span class="comment">% Convert cell array to a struct array</span>
1135     <span class="comment">% (We only did this because struct arrays were more familiar to people)</span>
1136     <span class="comment">% Rmat(1,1) = Rcell{1,1};  % Kick x, look x</span>
1137     <span class="comment">% Rmat(2,1) = Rcell{2,1};  % Kick x, look y</span>
1138     <span class="comment">% Rmat(2,2) = Rcell{2,2};  % Kick y, look y</span>
1139     <span class="comment">% Rmat(1,2) = Rcell{1,2};  % Kick y, look x</span>
1140     <span class="keyword">for</span> i = 1:size(Rcell,1)
1141         <span class="keyword">for</span> j = 1:size(Rcell,2)
1142             <span class="keyword">if</span> <a href="istransport.html" class="code" title="function Test = istransport">istransport</a>
1143                 <span class="comment">% For transport line zero the BPM noise for upstream BPMs</span>
1144                 <span class="keyword">for</span> k = 1:size(Rcell{i,j}.Data,2)
1145                     CMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(Rcell{i,j}.Actuator.FamilyName, Rcell{i,j}.Actuator.DeviceList(k,:));
1146                     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(Rcell{i,j}.Monitor);
1147                     iUpStream = find(BPMpos &lt; CMpos);
1148                     <span class="keyword">if</span> ~isempty(iUpStream)
1149                         Rcell{i,j}.Data(iUpStream,k) = 0;
1150                     <span class="keyword">end</span>
1151                 <span class="keyword">end</span>
1152             <span class="keyword">end</span>
1153             Rmat(i,j) = Rcell{i,j};
1154         <span class="keyword">end</span>
1155     <span class="keyword">end</span>
1156     
1157     
1158     <span class="comment">% % Horizontal corrector plane</span>
1159     <span class="comment">% if DisplayFlag</span>
1160     <span class="comment">%     fprintf('   Begin Horizontal plane measurement ...\n');</span>
1161     <span class="comment">% end</span>
1162     <span class="comment">% mat = measrespmat('Struct', {BPMxFamily, BPMyFamily}, {BPMxList, BPMyList}, HCMFamily, HCMList, HCMKicks, ModulationMethod, WaitFlag, ExtraDelay, InputFlags{:});</span>
1163     <span class="comment">% if DisplayFlag</span>
1164     <span class="comment">%     fprintf('   Horizontal plane complete.\n\n');</span>
1165     <span class="comment">% end</span>
1166     <span class="comment">%</span>
1167     <span class="comment">% % Make a response matrix array</span>
1168     <span class="comment">% Rmat(1,1) = mat{1};  % Kick x, look x</span>
1169     <span class="comment">% Rmat(2,1) = mat{2};  % Kick x, look y</span>
1170     <span class="comment">%</span>
1171     <span class="comment">%</span>
1172     <span class="comment">% % Vertical corrector plane</span>
1173     <span class="comment">% if DisplayFlag</span>
1174     <span class="comment">%     fprintf('   Begin Vertical plane measurement...\n');</span>
1175     <span class="comment">% end</span>
1176     <span class="comment">% mat = measrespmat('Struct', {BPMxFamily, BPMyFamily}, {BPMxList, BPMyList}, VCMFamily, VCMList, VCMKicks, ModulationMethod, WaitFlag, ExtraDelay, InputFlags{:});</span>
1177     <span class="comment">% if DisplayFlag</span>
1178     <span class="comment">%     fprintf('   Vertical plane complete.\n\n');</span>
1179     <span class="comment">% end</span>
1180     <span class="comment">%</span>
1181     <span class="comment">% Rmat(2,2) = mat{2};  % Kick y, look y</span>
1182     <span class="comment">% Rmat(1,2) = mat{1};  % Kick y, look x</span>
1183 <span class="keyword">end</span>
1184 
1185 <span class="comment">% Save data in the proper directory</span>
1186 <span class="keyword">if</span> ArchiveFlag || ischar(FileName)
1187     [DirectoryName, FileName, Ext] = fileparts(FileName);
1188     DirStart = pwd;
1189     [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
1190     <span class="keyword">if</span> ErrorFlag
1191         fprintf(<span class="string">'\n   There was a problem getting to the proper directory!\n\n'</span>);
1192     <span class="keyword">end</span>
1193     save(FileName, <span class="string">'Rmat'</span>,<span class="string">'MachineConfig'</span>);
1194     cd(DirStart);
1195     OutputFileName = [DirectoryName, FileName, <span class="string">'.mat'</span>];
1196     
1197     <span class="keyword">if</span> DisplayFlag
1198         fprintf(<span class="string">'   BPM response matrix data structure ''Rmat'' saved to disk\n'</span>);
1199         fprintf(<span class="string">'   Filename: %s\n'</span>, OutputFileName);
1200         fprintf(<span class="string">'   The total response matrix measurement time was %.2f minutes.\n'</span>, (gettime-TimeStart)/60);
1201     <span class="keyword">end</span>
1202 <span class="keyword">else</span>
1203     OutputFileName = <span class="string">''</span>;
1204 <span class="keyword">end</span>
1205 
1206 
1207 <span class="keyword">if</span> ~StructOutputFlag
1208     <span class="comment">% Return a matrix</span>
1209     <span class="comment">% Rmat = [Rmat(1,1).Data Rmat(1,2).Data;</span>
1210     <span class="comment">%         Rmat(2,1).Data Rmat(2,2).Data];</span>
1211     RmatData = [];
1212     <span class="keyword">for</span> i = 1:size(Rmat,1)
1213         Rrow = [];
1214         <span class="keyword">for</span> j = 1:size(Rmat,2)
1215             Rrow = [Rrow Rmat(i,j).Data];
1216         <span class="keyword">end</span>
1217         RmatData = [RmatData; Rrow];
1218     <span class="keyword">end</span>
1219     
1220     Rmat = RmatData;
1221 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>