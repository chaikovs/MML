<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of getpv</title>
  <meta name="keywords" content="getpv">
  <meta name="description" content="GETPV - Returns a variable from the online system or the model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; getpv.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>getpv
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>GETPV - Returns a variable from the online system or the model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [AM, tout, DataTime, ErrorFlag] = getpv(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">GETPV - Returns a variable from the online system or the model

  FamilyName/DeviceList Method
  [AM, tout, DataTime] = getpv(Family, Field, DeviceList, t, FreshDataFlag, TimeOutPeriod)

  Data Structure
  [AM, tout, DataTime] = getpv(DataStructure, t, FreshDataFlag, TimeOutPeriod)

  TangoName or ChannelName Method
  [AM, tout, DataTime, ErrorFlag] = getpv(TangoName, t, FreshDataFlag, TimeOutPeriod)

  CommonName Method (Family can be '' to search all families, Field is optional)
  [AM, tout, DataTime] = getpv(CommonName, Field, t, FreshDataFlag, TimeOutPeriod)
  [AM, tout, DataTime] = getpv(Family, Field, CommonName, t, FreshDataFlag, TimeOutPeriod)

  INPUTS
  1. Family - Family Name 
              Data Structure
              Channel Name 
              TangoName
              Accelerator Object
              For CommonNames, Family=[] searches all families
              (or Cell Array of inputs)

  2. Field - Subfield name of an accelerator family ('Monitor', 'Setpoint', etc)  
             {Default: 'Monitor' or '' or ChannelName method}
             (For non-Family subfields, Field is added as .Field, see Note #8 below for more information.)

  3. DeviceList - [Sector Device #] or [element #] list {Default or empty list: Entire family}
                  Note: if input 1 is a cell array then DeviceList must be a cell array
     CommonName - Common name can replace a DeviceList (scalar or vector outputs)

  4. t - Time vector of when to start taking data (t can not be a cell) {Default: 0}

  5. FreshDataFlag -  0   -&gt; Return after first measurement {Default}
                     else -&gt; Return after FreshDataFlag number of new measurements have been read
                     Ie, getpv('BPMx',[1 1],0,2) measures the orbit then continues to read the orbit
                         until 2 new orbits have been measured and returns the last measurement.
                     Note: 1. t can only be a scalar when using the FreshDataFlag.
                           2. FreshDataFlag cannot be used with 'Matrix' data types. 

  6. TimeOutPeriod - Time-out period when waiting for fresh data {Default: 10 seconds}

  7. 'Struct'  - Return a data structure {Default for data structure inputs}
     'Numeric' - Return numeric outputs  {Default for non-data structure inputs}
     'Object'  - Return a accelerator object (AccObj)

  8. Units flag overrides
     'Physics'  - Use physics  units
     'Hardware' - Use hardware units

  9. Mode flag overrides
     'Online' - Get data online 
     'Model'  - get data on the model
     'Manual' - Get data manually

  10. 'Double' - The output will be a double {Default}
      'String' - The output will be a string


  OUTPUTS
  1. AM   - Monitor values (Column vector or matrix where each column is a data point in time)

  2. tout - Time when measurement was completed according to the computer time (Matlab time) (row vector)
            tout-t is the time it took to make the measurement.  diff(t) can be arbitarily small, but tout will 
            report the actual completion time.  

  3. DataTime - Time when the data was measured (as report by the hardware)
                Time since 00:00:00, Jan 1, 1970 in days (in the present time zone)
                Units are in Matlab &quot;serial day number&quot; format (days) to be compatible with 
                timing functions like datevec, datenum, datetick, etc.  
                For exemple, [d,t,datatime] = getam('BPMx',[],0:.5:10);
                            plot(datatime, d); datetick x
                When using the model, the datatime is the same a the computer time (Matlab time).

  NOTES
  1. The output will be a data structure if the word 'struct' appears somewhere on the input line 
     or if the input is a data structure and 'numeric' is not on the input line.

  2. For data structure inputs:
     Family     - DataStructure.FamilyName (This field must exist)
     Field      - DataStructure.Field      (Field can be overridden on the input line)
     DeviceList - DataStructure.DeviceList (DeviceList can be overridden on the input line)
     Units      - DataStructure.Units      (Units can be overridden on the input line)
     (The Mode field is ignored!)

  3. For data structure outputs:
     TimeStamp  - Time (Matlab clock) at the start of the function
     tout       - Delta time vector at the end of each measurement (relative to TimeStamp)

  4. diff(t) should not be too small.  If the desired time to collect the data is too 
     short then the data collecting will not be able to keep up.  Always check tout. 
     (t - tout) is the time it took to collect the data on each iteration.   
 
  5. An easy way to averaged 10 monitors is:
     PVmean = mean(getpv(Family,DeviceList,0:.5:4.5)')';   % .5 second between measurements

  6. Channel name method is always Online!

  7. It is often useful to measure the update rate of a set of channel by using a very
     small time between measurements.
     For exmple, [d, tout] = getpv('BPMx', 'Monitor', [], 0:eps:100*eps);
                 plot(tout(1:end-1), 1./diff(tout),'.-'); % Point-wise data rate
                 If the update rate of the hardware is slower then the control system, then
                 hardware data rate can be visually inspected by plotting,
                 plot(tout, d,'.-'); 

  8. For cell array inputs:
     a. Input 1 defines the size of all cells
     b. All of the cell array inputs must be the same size
     c. Field does not have to be a cell array but DeviceList does (if they exist)
     d. t, FreshDataFlag, TimeOutPeriod can not be cell arrays
     e. Waveforms do not work with cell arrays.

  8. The Field input can be used for getting the &quot;dot&quot; EPICS field.  For instance, at the ALS
     getpv('BPMx','SCAN',[1 2],'String') will return SR01S___IBPM2X_AM02.SCAN as a string.
     (Note: at Spear ':' is used instead of '.')

  10. Error flaga are not used at the moment since all errors cause a Matlab error.
      Use try;catch statements to catch errors.

  12. If say Golden is a software field in the MML structure in the BPMx family, then 
      getpv('BPMx','Golden', DeviceList) will return the data in that field.

  See also <a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>, <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>, <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>, <a href="steppv.html" class="code" title="function ErrorFlag = steppv(varargin)">steppv</a>

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>	COMMON2DEV - Converts a common name to a device list</li><li><a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>	ELEM2DEV - Converts a device list to an element list</li><li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>	GETMODE - Returns the present family mode ('Online', 'Simulator', 'Manual', 'Special', etc)</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getunits.html" class="code" title="function [Units, UnitsString] = getunits(Family, Field)">getunits</a>	GETUNITS - Return the present family units and units string</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>	ISFAMILY - True for family names</li><li><a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>	PHYSICS2HW - Converts from 'Physics' units to 'Hardware' units</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getam.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getam(varargin)">getam</a>	GETAM - Gets monitor channels</li><li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getmachineconfig.html" class="code" title="function [ConfigSetpoint, ConfigMonitor, FileName] = getmachineconfig(varargin)">getmachineconfig</a>	GETMACHINECONFIG - Returns or saves to file the present storage ring setpoints and monitors</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getramprate.html" class="code" title="function RampRate = getramprate(varargin)">getramprate</a>	GETRAMPRATE - Returns the ramp rate for a family</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getrunflag.html" class="code" title="function [RunFlag, Delta, Tol] = getrunflag(varargin)">getrunflag</a>	GETRUNFLAG - Returns position if the device is in the process of changing a setpoint</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="gettune.html" class="code" title="function [Tune, tout, DataTime, ErrorFlag] = gettune(varargin)">gettune</a>	GETTUNE - Returns the betatron tunes</li><li><a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>	GETX - Returns the horizontal orbit</li><li><a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>	GETY - Returns the vertical orbit</li><li><a href="measidfftable.html" class="code" title="function ffgettbl(Sector, BPMFlag)">measidfftable</a>	FFGETTBL - Measures an insertion device feed forward table for the vertical gap</li><li><a href="plotwaveform.html" class="code" title="function plotwaveform()">plotwaveform</a>	PJ BOussina waveform loader September 11, 2006</li><li><a href="rmgolden.html" class="code" title="function Data = rmgolden(varargin)">rmgolden</a>	RMGOLDEN - Remove the golden values for data set</li><li><a href="rmoffset.html" class="code" title="function Data = rmoffset(varargin)">rmoffset</a>	RMOFFSET - Remove the offset values for data set</li><li><a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>	SETORBIT - Orbit correction function</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [AM, tout, DataTime, DeviceList, ErrorFlag] = getbycommonname(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, varargin)</a></li><li><a href="#_sub2" class="code">function [AM, tout, DataTime, ErrorFlag] = local_getbyname(ChannelName, OutputDataType, N, t, FreshDataFlag, TimeOutPeriod)</a></li><li><a href="#_sub3" class="code">function [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_getpv(AO, Field, DeviceList, OutputDataType, t, FreshDataFlag, TimeOutPeriod)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)</a>
0002 <span class="comment">%GETPV - Returns a variable from the online system or the model</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  FamilyName/DeviceList Method</span>
0005 <span class="comment">%  [AM, tout, DataTime] = getpv(Family, Field, DeviceList, t, FreshDataFlag, TimeOutPeriod)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  Data Structure</span>
0008 <span class="comment">%  [AM, tout, DataTime] = getpv(DataStructure, t, FreshDataFlag, TimeOutPeriod)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  TangoName or ChannelName Method</span>
0011 <span class="comment">%  [AM, tout, DataTime, ErrorFlag] = getpv(TangoName, t, FreshDataFlag, TimeOutPeriod)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%  CommonName Method (Family can be '' to search all families, Field is optional)</span>
0014 <span class="comment">%  [AM, tout, DataTime] = getpv(CommonName, Field, t, FreshDataFlag, TimeOutPeriod)</span>
0015 <span class="comment">%  [AM, tout, DataTime] = getpv(Family, Field, CommonName, t, FreshDataFlag, TimeOutPeriod)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  INPUTS</span>
0018 <span class="comment">%  1. Family - Family Name</span>
0019 <span class="comment">%              Data Structure</span>
0020 <span class="comment">%              Channel Name</span>
0021 <span class="comment">%              TangoName</span>
0022 <span class="comment">%              Accelerator Object</span>
0023 <span class="comment">%              For CommonNames, Family=[] searches all families</span>
0024 <span class="comment">%              (or Cell Array of inputs)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  2. Field - Subfield name of an accelerator family ('Monitor', 'Setpoint', etc)</span>
0027 <span class="comment">%             {Default: 'Monitor' or '' or ChannelName method}</span>
0028 <span class="comment">%             (For non-Family subfields, Field is added as .Field, see Note #8 below for more information.)</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%  3. DeviceList - [Sector Device #] or [element #] list {Default or empty list: Entire family}</span>
0031 <span class="comment">%                  Note: if input 1 is a cell array then DeviceList must be a cell array</span>
0032 <span class="comment">%     CommonName - Common name can replace a DeviceList (scalar or vector outputs)</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%  4. t - Time vector of when to start taking data (t can not be a cell) {Default: 0}</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%  5. FreshDataFlag -  0   -&gt; Return after first measurement {Default}</span>
0037 <span class="comment">%                     else -&gt; Return after FreshDataFlag number of new measurements have been read</span>
0038 <span class="comment">%                     Ie, getpv('BPMx',[1 1],0,2) measures the orbit then continues to read the orbit</span>
0039 <span class="comment">%                         until 2 new orbits have been measured and returns the last measurement.</span>
0040 <span class="comment">%                     Note: 1. t can only be a scalar when using the FreshDataFlag.</span>
0041 <span class="comment">%                           2. FreshDataFlag cannot be used with 'Matrix' data types.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%  6. TimeOutPeriod - Time-out period when waiting for fresh data {Default: 10 seconds}</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%  7. 'Struct'  - Return a data structure {Default for data structure inputs}</span>
0046 <span class="comment">%     'Numeric' - Return numeric outputs  {Default for non-data structure inputs}</span>
0047 <span class="comment">%     'Object'  - Return a accelerator object (AccObj)</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%  8. Units flag overrides</span>
0050 <span class="comment">%     'Physics'  - Use physics  units</span>
0051 <span class="comment">%     'Hardware' - Use hardware units</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%  9. Mode flag overrides</span>
0054 <span class="comment">%     'Online' - Get data online</span>
0055 <span class="comment">%     'Model'  - get data on the model</span>
0056 <span class="comment">%     'Manual' - Get data manually</span>
0057 <span class="comment">%</span>
0058 <span class="comment">%  10. 'Double' - The output will be a double {Default}</span>
0059 <span class="comment">%      'String' - The output will be a string</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%</span>
0062 <span class="comment">%  OUTPUTS</span>
0063 <span class="comment">%  1. AM   - Monitor values (Column vector or matrix where each column is a data point in time)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">%  2. tout - Time when measurement was completed according to the computer time (Matlab time) (row vector)</span>
0066 <span class="comment">%            tout-t is the time it took to make the measurement.  diff(t) can be arbitarily small, but tout will</span>
0067 <span class="comment">%            report the actual completion time.</span>
0068 <span class="comment">%</span>
0069 <span class="comment">%  3. DataTime - Time when the data was measured (as report by the hardware)</span>
0070 <span class="comment">%                Time since 00:00:00, Jan 1, 1970 in days (in the present time zone)</span>
0071 <span class="comment">%                Units are in Matlab &quot;serial day number&quot; format (days) to be compatible with</span>
0072 <span class="comment">%                timing functions like datevec, datenum, datetick, etc.</span>
0073 <span class="comment">%                For exemple, [d,t,datatime] = getam('BPMx',[],0:.5:10);</span>
0074 <span class="comment">%                            plot(datatime, d); datetick x</span>
0075 <span class="comment">%                When using the model, the datatime is the same a the computer time (Matlab time).</span>
0076 <span class="comment">%</span>
0077 <span class="comment">%  NOTES</span>
0078 <span class="comment">%  1. The output will be a data structure if the word 'struct' appears somewhere on the input line</span>
0079 <span class="comment">%     or if the input is a data structure and 'numeric' is not on the input line.</span>
0080 <span class="comment">%</span>
0081 <span class="comment">%  2. For data structure inputs:</span>
0082 <span class="comment">%     Family     - DataStructure.FamilyName (This field must exist)</span>
0083 <span class="comment">%     Field      - DataStructure.Field      (Field can be overridden on the input line)</span>
0084 <span class="comment">%     DeviceList - DataStructure.DeviceList (DeviceList can be overridden on the input line)</span>
0085 <span class="comment">%     Units      - DataStructure.Units      (Units can be overridden on the input line)</span>
0086 <span class="comment">%     (The Mode field is ignored!)</span>
0087 <span class="comment">%</span>
0088 <span class="comment">%  3. For data structure outputs:</span>
0089 <span class="comment">%     TimeStamp  - Time (Matlab clock) at the start of the function</span>
0090 <span class="comment">%     tout       - Delta time vector at the end of each measurement (relative to TimeStamp)</span>
0091 <span class="comment">%</span>
0092 <span class="comment">%  4. diff(t) should not be too small.  If the desired time to collect the data is too</span>
0093 <span class="comment">%     short then the data collecting will not be able to keep up.  Always check tout.</span>
0094 <span class="comment">%     (t - tout) is the time it took to collect the data on each iteration.</span>
0095 <span class="comment">%</span>
0096 <span class="comment">%  5. An easy way to averaged 10 monitors is:</span>
0097 <span class="comment">%     PVmean = mean(getpv(Family,DeviceList,0:.5:4.5)')';   % .5 second between measurements</span>
0098 <span class="comment">%</span>
0099 <span class="comment">%  6. Channel name method is always Online!</span>
0100 <span class="comment">%</span>
0101 <span class="comment">%  7. It is often useful to measure the update rate of a set of channel by using a very</span>
0102 <span class="comment">%     small time between measurements.</span>
0103 <span class="comment">%     For exmple, [d, tout] = getpv('BPMx', 'Monitor', [], 0:eps:100*eps);</span>
0104 <span class="comment">%                 plot(tout(1:end-1), 1./diff(tout),'.-'); % Point-wise data rate</span>
0105 <span class="comment">%                 If the update rate of the hardware is slower then the control system, then</span>
0106 <span class="comment">%                 hardware data rate can be visually inspected by plotting,</span>
0107 <span class="comment">%                 plot(tout, d,'.-');</span>
0108 <span class="comment">%</span>
0109 <span class="comment">%  8. For cell array inputs:</span>
0110 <span class="comment">%     a. Input 1 defines the size of all cells</span>
0111 <span class="comment">%     b. All of the cell array inputs must be the same size</span>
0112 <span class="comment">%     c. Field does not have to be a cell array but DeviceList does (if they exist)</span>
0113 <span class="comment">%     d. t, FreshDataFlag, TimeOutPeriod can not be cell arrays</span>
0114 <span class="comment">%     e. Waveforms do not work with cell arrays.</span>
0115 <span class="comment">%</span>
0116 <span class="comment">%  8. The Field input can be used for getting the &quot;dot&quot; EPICS field.  For instance, at the ALS</span>
0117 <span class="comment">%     getpv('BPMx','SCAN',[1 2],'String') will return SR01S___IBPM2X_AM02.SCAN as a string.</span>
0118 <span class="comment">%     (Note: at Spear ':' is used instead of '.')</span>
0119 <span class="comment">%</span>
0120 <span class="comment">%  10. Error flaga are not used at the moment since all errors cause a Matlab error.</span>
0121 <span class="comment">%      Use try;catch statements to catch errors.</span>
0122 <span class="comment">%</span>
0123 <span class="comment">%  12. If say Golden is a software field in the MML structure in the BPMx family, then</span>
0124 <span class="comment">%      getpv('BPMx','Golden', DeviceList) will return the data in that field.</span>
0125 <span class="comment">%</span>
0126 <span class="comment">%  See also getam, getsp, setpv, steppv</span>
0127 <span class="comment">%</span>
0128 <span class="comment">%  Written by Greg Portmann</span>
0129 
0130 
0131 <span class="comment">% Starting time</span>
0132 t0 = clock;
0133 
0134 
0135 <span class="comment">% Defaults</span>
0136 FieldDefault = <span class="string">'Monitor'</span>;
0137 Field = FieldDefault;
0138 DeviceList = [];
0139 t = 0;
0140 FreshDataFlag = 0;
0141 TimeOutPeriod = 10;
0142 ErrorFlag = 0;
0143 
0144 StructOutputFlag = 0;
0145 NumericOutputFlag = 0;
0146 ObjectOutputFlag = 0;
0147 ModeFlag = <span class="string">''</span>;
0148 UnitsFlag = <span class="string">''</span>;
0149 OutputDataType = <span class="string">'Double'</span>;
0150 
0151 
0152 <span class="comment">% Look if 'struct' or 'numeric' in on the input line</span>
0153 InputFlags = {};
0154 <span class="keyword">for</span> i = length(varargin):-1:1
0155     <span class="keyword">if</span> isstruct(varargin{i})
0156         <span class="comment">% Ignor structures</span>
0157     <span class="keyword">elseif</span> iscell(varargin{i})
0158         <span class="comment">% Ignor cells</span>
0159     <span class="keyword">elseif</span> isa(varargin{i},<span class="string">'AccObj'</span>)
0160         AccObj1 = struct(varargin{i});
0161         Families = fieldnames(AccObj1);
0162         j = 0;
0163         <span class="keyword">for</span> k = 1:length(Families)
0164             <span class="keyword">if</span> ~isempty(AccObj1.(Families{k}))
0165                 j = j + 1;
0166                 tmpcell{j} = AccObj1.(Families{k});
0167             <span class="keyword">end</span>
0168         <span class="keyword">end</span>
0169         <span class="keyword">if</span> length(tmpcell) == 1
0170             varargin{i} = tmpcell{1};
0171         <span class="keyword">else</span>
0172             varargin{i} = tmpcell;
0173         <span class="keyword">end</span>
0174         <span class="keyword">if</span> ~NumericOutputFlag
0175             ObjectOutputFlag = 1;
0176             StructOutputFlag = 1;
0177         <span class="keyword">end</span>
0178     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'struct'</span>)
0179         StructOutputFlag = 1;
0180         ObjectOutputFlag = 0;
0181         varargin(i) = [];
0182     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'numeric'</span>)
0183         NumericOutputFlag = 1;
0184         StructOutputFlag = 0;
0185         ObjectOutputFlag = 0;
0186         varargin(i) = [];
0187     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'simulator'</span>) || strcmpi(varargin{i},<span class="string">'model'</span>)
0188         ModeFlag = <span class="string">'SIMULATOR'</span>;
0189         InputFlags = [InputFlags varargin(i)];
0190         varargin(i) = [];
0191     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0192         ModeFlag = <span class="string">'Online'</span>;
0193         InputFlags = [InputFlags varargin(i)];
0194         varargin(i) = [];
0195     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0196         ModeFlag = <span class="string">'Manual'</span>;
0197         InputFlags = [InputFlags varargin(i)];
0198         varargin(i) = [];
0199     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Special'</span>)
0200         ModeFlag = <span class="string">'Special'</span>;
0201         InputFlags = [InputFlags varargin(i)];
0202         varargin(i) = [];
0203     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'physics'</span>)
0204         UnitsFlag = <span class="string">'Physics'</span>;
0205         InputFlags = [InputFlags varargin(i)];
0206         varargin(i) = [];
0207     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0208         UnitsFlag = <span class="string">'Hardware'</span>;
0209         InputFlags = [InputFlags varargin(i)];
0210         varargin(i) = [];
0211     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'archive'</span>)
0212         <span class="comment">% Just remove</span>
0213         varargin(i) = [];
0214     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'noarchive'</span>)
0215         <span class="comment">% Just remove</span>
0216         varargin(i) = [];
0217     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'String'</span>)
0218         OutputDataType = <span class="string">'String'</span>;
0219         InputFlags = [InputFlags varargin(i)];
0220         varargin(i) = [];
0221     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Double'</span>)
0222         OutputDataType = <span class="string">'Double'</span>;
0223         InputFlags = [InputFlags varargin(i)];
0224         varargin(i) = [];
0225     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'WaveForm'</span>) || strcmpi(varargin{i},<span class="string">'Matrix'</span>)
0226         OutputDataType = <span class="string">'Matrix'</span>;
0227         InputFlags = [InputFlags varargin(i)];
0228         varargin(i) = [];
0229     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Object'</span>)
0230         ObjectOutputFlag = 1;
0231         StructOutputFlag = 1;
0232         varargin(i) = [];
0233     <span class="keyword">end</span>
0234 <span class="keyword">end</span>
0235 
0236 <span class="keyword">if</span> isempty(varargin)
0237     error(<span class="string">'Must have at least one input (Family, Data structure, or Channel Name).'</span>);
0238 <span class="keyword">end</span>
0239 
0240 
0241 
0242 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0243 <span class="comment">% CELL OR CELL ARRAY INPUT %</span>
0244 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0245 <span class="keyword">if</span> iscell(varargin{1})
0246     <span class="comment">%if strcmpi(ModeFlag, 'Online') | (isempty(ModeFlag) &amp; strcmpi(getmode(varargin{1}{1}), 'Online'))</span>
0247     <span class="comment">%     % Unfortunately the following code using channelnames is not much of a speed improvement over</span>
0248     <span class="comment">%     % interating over cell arrays (which is needed for simulator mode)</span>
0249     <span class="comment">%</span>
0250     <span class="comment">%     % Online cell arrays</span>
0251     <span class="comment">%     %</span>
0252     <span class="comment">%     % Online cell arrays are treated differently because to the desired for speed.</span>
0253     <span class="comment">%     % By loading all the channel names into one array then sending to the c-function</span>
0254     <span class="comment">%     % with the t-vector, the total time is greatly sped up.  However, using channel names</span>
0255     <span class="comment">%     % only works in online mode.  The one problem is all output have to scalars.</span>
0256     <span class="comment">%</span>
0257     <span class="comment">%</span>
0258     <span class="comment">%     % Count the number of inputs which are cells (Family or DeviceList) or strings (possibly Field)</span>
0259     <span class="comment">%     NCellOrString = 1;</span>
0260     <span class="comment">%     for i = 2:length(varargin)</span>
0261     <span class="comment">%         if ~iscell(varargin{i})</span>
0262     <span class="comment">%             if ~ischar(varargin{i})</span>
0263     <span class="comment">%                 break;</span>
0264     <span class="comment">%             else</span>
0265     <span class="comment">%                 NCellOrString = NCellOrString + 1;</span>
0266     <span class="comment">%             end</span>
0267     <span class="comment">%         else</span>
0268     <span class="comment">%             NCellOrString = NCellOrString + 1;</span>
0269     <span class="comment">%             %if length(varargin{1})~=length(varargin{NCellOrString}) | length(varargin{NCellOrString})==1</span>
0270     <span class="comment">%             %    error('When using cell, all the cells must be the same size as input 1 or be length one.');</span>
0271     <span class="comment">%             %end</span>
0272     <span class="comment">%         end</span>
0273     <span class="comment">%     end</span>
0274     <span class="comment">%</span>
0275     <span class="comment">%     % t (if it exists) should be the next input</span>
0276     <span class="comment">%     if length(varargin) &gt;= NCellOrString+1</span>
0277     <span class="comment">%         if iscell(varargin{NCellOrString+1})</span>
0278     <span class="comment">%             error(sprintf('Expecting input #%d to be a time vector not a cell', NCellOrString+1));</span>
0279     <span class="comment">%         end</span>
0280     <span class="comment">%         if ischar(varargin{NCellOrString+1})</span>
0281     <span class="comment">%             error(sprintf('Expecting input #%d to be a time vector not a string', NCellOrString+1));</span>
0282     <span class="comment">%         end</span>
0283     <span class="comment">%         t = varargin{NCellOrString+1};</span>
0284     <span class="comment">%         varargin{NCellOrString+1} = [];</span>
0285     <span class="comment">%         if isempty(t)</span>
0286     <span class="comment">%             t = 0;</span>
0287     <span class="comment">%         end</span>
0288     <span class="comment">%     end</span>
0289     <span class="comment">%</span>
0290     <span class="comment">%     % FreshDataFlag (if it exists) should be the next input</span>
0291     <span class="comment">%     if length(varargin) &gt;= NCellOrString+1</span>
0292     <span class="comment">%         if iscell(varargin{NCellOrString+1})</span>
0293     <span class="comment">%             error(sprintf('Expecting input #%d to be FreshDataFlag not a cell', NCellOrString+2));</span>
0294     <span class="comment">%         end</span>
0295     <span class="comment">%         if ischar(varargin{NCellOrString+1})</span>
0296     <span class="comment">%             error(sprintf('Expecting input #%d to be FreshDataFlag not a string', NCellOrString+2));</span>
0297     <span class="comment">%         end</span>
0298     <span class="comment">%         FreshDataFlag = varargin{NCellOrString+1};</span>
0299     <span class="comment">%         varargin{NCellOrString+1} = [];</span>
0300     <span class="comment">%     end</span>
0301     <span class="comment">%</span>
0302     <span class="comment">%     % TimeOutPeriod (if it exists) should be the next input</span>
0303     <span class="comment">%     if length(varargin) &gt;= NCellOrString+1</span>
0304     <span class="comment">%         if iscell(varargin{NCellOrString+1})</span>
0305     <span class="comment">%             error(sprintf('Expecting input #%d to be TimeOutPeriod not a cell', NCellOrString+2));</span>
0306     <span class="comment">%         end</span>
0307     <span class="comment">%         if ischar(varargin{NCellOrString+1})</span>
0308     <span class="comment">%             error(sprintf('Expecting input #%d to be TimeOutPeriod not a string', NCellOrString+2));</span>
0309     <span class="comment">%         end</span>
0310     <span class="comment">%         TimeOutPeriod = varargin{NCellOrString+1};</span>
0311     <span class="comment">%         varargin{NCellOrString+1} = [];</span>
0312     <span class="comment">%     end</span>
0313     <span class="comment">%</span>
0314     <span class="comment">%     % Build the channel name matrix</span>
0315     <span class="comment">%     ChannelNames = [];</span>
0316     <span class="comment">%     for i = 1:size(varargin{1},1)</span>
0317     <span class="comment">%         for j = 1:size(varargin{1},2)</span>
0318     <span class="comment">%             if NCellOrString == 1</span>
0319     <span class="comment">%                 NewNames = family2channel(varargin{1}{i,j});</span>
0320     <span class="comment">%             elseif NCellOrString == 2</span>
0321     <span class="comment">%                 if iscell(varargin{2})</span>
0322     <span class="comment">%                     NewNames = family2channel(varargin{1}{i,j}, varargin{2}{i,j});</span>
0323     <span class="comment">%                 else</span>
0324     <span class="comment">%                     NewNames = family2channel(varargin{1}{i,j}, varargin{2});</span>
0325     <span class="comment">%                 end</span>
0326     <span class="comment">%             elseif NCellOrString == 3</span>
0327     <span class="comment">%                 if iscell(varargin{2})</span>
0328     <span class="comment">%                     NewNames = family2channel(varargin{1}{i,j}, varargin{2}{i,j}, varargin{3}{i,j});</span>
0329     <span class="comment">%                 else</span>
0330     <span class="comment">%                     NewNames = family2channel(varargin{1}{i,j}, varargin{2}, varargin{3}{i,j});</span>
0331     <span class="comment">%                 end</span>
0332     <span class="comment">%             end</span>
0333     <span class="comment">%             ChannelNames = strvcat(ChannelNames, NewNames);</span>
0334     <span class="comment">%             NameSize(i,j) = size(NewNames,1);</span>
0335     <span class="comment">%         end</span>
0336     <span class="comment">%     end</span>
0337     <span class="comment">%</span>
0338     <span class="comment">%     ExtraTimeDelay = etime(clock, t0);</span>
0339     <span class="comment">%</span>
0340     <span class="comment">%     %if nargout &gt;= 3</span>
0341     <span class="comment">%     [AMtmp, tout, DataTimetmp, ErrorFlag] = local_getbyname(ChannelNames, 'Double', 1, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);</span>
0342     <span class="comment">%     %else</span>
0343     <span class="comment">%     %    [AMtmp, tout] = local_getbyname(ChannelNames, 'Double', 1, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod)</span>
0344     <span class="comment">%     %end</span>
0345     <span class="comment">%</span>
0346     <span class="comment">%     %if StructOutputFlag | nargout &gt;= 3</span>
0347     <span class="comment">%     % .DataTime is the time on computer taking the data but</span>
0348     <span class="comment">%     % reference it w.r.t. the time zone where Matlab is running</span>
0349     <span class="comment">%     DateNumber1970 = 719529;  %datenum('1-Jan-1970');</span>
0350     <span class="comment">%     days = datenum(t0(1:3)) - DateNumber1970;</span>
0351     <span class="comment">%     t0_sec = 24*60*60*days + 60*60*t0(4) + 60*t0(5) + t0(6);</span>
0352     <span class="comment">%     TimeZoneDiff = round((t0_sec - real(DataTimetmp(1,1)))/60/60);</span>
0353     <span class="comment">%     DataTimetmp = (real(DataTimetmp)/60/60 + TimeZoneDiff)/24 + DateNumber1970 + imag(DataTimetmp)/(1e9 * 60 * 60 * 24);</span>
0354     <span class="comment">%</span>
0355     <span class="comment">%     % No time zone adjustment (UTC 00:00:00 Jan 1, 1970)</span>
0356     <span class="comment">%     %DataTime = real(DataTime)/60/60/24 + imag(DataTime)/(1e9 * 60 * 60 * 24);</span>
0357     <span class="comment">%     %end</span>
0358     <span class="comment">%</span>
0359     <span class="comment">%     for i = 1:size(varargin{1},1)</span>
0360     <span class="comment">%         for j = 1:size(varargin{1},2)</span>
0361     <span class="comment">%             AM{i,j} = AMtmp(1:NameSize(i,j),:);</span>
0362     <span class="comment">%             AMtmp(1:NameSize(i,j),:) = [];</span>
0363     <span class="comment">%             %if nargout &gt;= 3</span>
0364     <span class="comment">%             DataTime{i,j} = DataTimetmp(1:NameSize(i,j),:);</span>
0365     <span class="comment">%             DataTimetmp(1:NameSize(i,j),:) = [];</span>
0366     <span class="comment">%             %end</span>
0367     <span class="comment">%</span>
0368     <span class="comment">%             % If input is a data structure, only change StructOutputFlag if 'numeric' is not on the input line</span>
0369     <span class="comment">%             StructOutputFlagStart = StructOutputFlag;</span>
0370     <span class="comment">%             if isstruct(varargin{1}{i,j})</span>
0371     <span class="comment">%                 if isfield(varargin{1}{i,j},'Field')</span>
0372     <span class="comment">%                     if ~NumericOutputFlag</span>
0373     <span class="comment">%                         StructOutputFlag = 1;</span>
0374     <span class="comment">%                     end</span>
0375     <span class="comment">%                 end</span>
0376     <span class="comment">%             end</span>
0377     <span class="comment">%</span>
0378     <span class="comment">%             if StructOutputFlag</span>
0379     <span class="comment">%                 Datatmp = AM{i,j};</span>
0380     <span class="comment">%                 DataTimetmp = DataTime{i,j};</span>
0381     <span class="comment">%                 if NCellOrString == 1</span>
0382     <span class="comment">%                     if isempty(UnitsFlag)</span>
0383     <span class="comment">%                         AM{i,j} = family2datastruct(varargin{1}{i,j});</span>
0384     <span class="comment">%                     else</span>
0385     <span class="comment">%                         AM{i,j} = family2datastruct(varargin{1}{i,j}, UnitsFlag);</span>
0386     <span class="comment">%                     end</span>
0387     <span class="comment">%                 elseif NCellOrString == 2</span>
0388     <span class="comment">%                     if iscell(varargin{2})</span>
0389     <span class="comment">%                         if isempty(UnitsFlag)</span>
0390     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}{i,j});</span>
0391     <span class="comment">%                         else</span>
0392     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}{i,j}, UnitsFlag);</span>
0393     <span class="comment">%                         end</span>
0394     <span class="comment">%                     else</span>
0395     <span class="comment">%                         if isempty(UnitsFlag)</span>
0396     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2});</span>
0397     <span class="comment">%                         else</span>
0398     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}, UnitsFlag);</span>
0399     <span class="comment">%                         end</span>
0400     <span class="comment">%                     end</span>
0401     <span class="comment">%                 elseif NCellOrString == 3</span>
0402     <span class="comment">%                     if iscell(varargin{2})</span>
0403     <span class="comment">%                         if isempty(UnitsFlag)</span>
0404     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}{i,j}, varargin{3}{i,j});</span>
0405     <span class="comment">%                         else</span>
0406     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}{i,j}, varargin{3}{i,j}, UnitsFlag);</span>
0407     <span class="comment">%                         end</span>
0408     <span class="comment">%                     else</span>
0409     <span class="comment">%                         if isempty(UnitsFlag)</span>
0410     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}, varargin{3}{i,j});</span>
0411     <span class="comment">%                         else</span>
0412     <span class="comment">%                             AM{i,j} = family2datastruct(varargin{1}{i,j}, varargin{2}, varargin{3}{i,j}, UnitsFlag);</span>
0413     <span class="comment">%                         end</span>
0414     <span class="comment">%                     end</span>
0415     <span class="comment">%                 end</span>
0416     <span class="comment">%                 AM{i,j}.Data = Datatmp;</span>
0417     <span class="comment">%                 AM{i,j}.t = t;</span>
0418     <span class="comment">%                 AM{i,j}.tout = tout;</span>
0419     <span class="comment">%                 AM{i,j}.DataTime = DataTimetmp;</span>
0420     <span class="comment">%                 AM{i,j}.Mode = 'Online';</span>
0421     <span class="comment">%                 AM{i,j}.CreatedBy = 'getpv';</span>
0422     <span class="comment">%             end</span>
0423     <span class="comment">%             StructOutputFlag = StructOutputFlagStart;</span>
0424     <span class="comment">%         end</span>
0425     <span class="comment">%     end</span>
0426     <span class="comment">%</span>
0427     <span class="comment">%     return</span>
0428     <span class="comment">%</span>
0429     <span class="comment">%else</span>
0430 
0431     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0432     <span class="comment">% CELL OR CELL ARRAY INPUT %</span>
0433     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0434     <span class="comment">% Iterate on each cell with special attention to the t vector input</span>
0435 
0436     <span class="comment">% For an empty input, return empty</span>
0437     <span class="keyword">if</span> isempty(varargin{1})
0438         AM =[]; tout = []; DataTime = []; ErrorFlag = 0;
0439         <span class="keyword">return</span>
0440     <span class="keyword">end</span>
0441 
0442     <span class="comment">% If input is a data structure, only change StructOutputFlag if 'numeric' is not on the input line</span>
0443     <span class="keyword">if</span> isstruct(varargin{1}{1}) &amp;&amp; isfield(varargin{1}{1},<span class="string">'Field'</span>)
0444         <span class="keyword">if</span> ~NumericOutputFlag
0445             StructOutputFlag = 1;
0446         <span class="keyword">end</span>
0447     <span class="keyword">end</span>
0448 
0449     
0450     <span class="comment">% Count the number of inputs which are cells (Family or DeviceList) or strings (possibly Field)</span>
0451     NCellOrString = 1;
0452     <span class="keyword">for</span> i = 2:length(varargin)
0453         <span class="keyword">if</span> ~iscell(varargin{i})
0454             <span class="keyword">if</span> ~ischar(varargin{i})
0455                 <span class="keyword">break</span>;
0456             <span class="keyword">else</span>
0457                 NCellOrString = NCellOrString + 1;
0458             <span class="keyword">end</span>
0459         <span class="keyword">else</span>
0460             NCellOrString = NCellOrString + 1;
0461             <span class="comment">%if length(varargin{1})~=length(varargin{NCellOrString}) | length(varargin{NCellOrString})==1</span>
0462             <span class="comment">%    error('When using cell, all the cells must be the same size as input 1 or be length one.');</span>
0463             <span class="comment">%end</span>
0464         <span class="keyword">end</span>
0465     <span class="keyword">end</span>
0466 
0467     <span class="comment">% t (if it exists) should be the next input.  Save it then zero it in varargin</span>
0468     <span class="keyword">if</span> length(varargin) &gt;= NCellOrString+1
0469         <span class="keyword">if</span> iscell(varargin{NCellOrString+1})
0470             error(sprintf(<span class="string">'Expecting input #%d to be a time vector not a cell'</span>, NCellOrString+1));
0471         <span class="keyword">end</span>
0472         <span class="keyword">if</span> ischar(varargin{NCellOrString+1})
0473             error(sprintf(<span class="string">'Expecting input #%d to be a time vector not a string'</span>, NCellOrString+1));
0474         <span class="keyword">end</span>
0475         t = varargin{NCellOrString+1};
0476         varargin{NCellOrString+1} = 0;
0477     <span class="keyword">end</span>
0478 
0479 
0480     ExtraTimeDelay = etime(clock, t0);
0481     t = t - ExtraTimeDelay;
0482 
0483     <span class="comment">% Loop according to t</span>
0484     <span class="keyword">for</span> itime = 1:length(t)
0485         T = t(itime)-etime(clock, t0);
0486         <span class="keyword">if</span> T &gt; 0
0487             pause(T);
0488         <span class="keyword">end</span>
0489 
0490         <span class="keyword">for</span> i = 1:size(varargin{1},1)
0491             <span class="keyword">for</span> j = 1:size(varargin{1},2)
0492 
0493                 <span class="comment">% Build the input line</span>
0494                 <span class="keyword">for</span> k = 1:length(varargin)
0495                     <span class="keyword">if</span> ~iscell(varargin{k})
0496                         Inputs1{1,k} = varargin{k};
0497                     <span class="keyword">elseif</span> length(varargin{k}) == 1
0498                         Inputs1{1,k} = varargin{k}{1};
0499                     <span class="keyword">elseif</span> (size(varargin{k},1) == size(varargin{1},1)) &amp;&amp; (size(varargin{k},2) == size(varargin{1},2))
0500                         Inputs1{1,k} = varargin{k}{i,j};
0501                     <span class="keyword">else</span>
0502                         error(<span class="string">'When using cells, all the cells must be the same size or length 1 (repeated).'</span>);
0503                     <span class="keyword">end</span>
0504                 <span class="keyword">end</span>
0505 
0506                 <span class="keyword">if</span> StructOutputFlag
0507                     <span class="keyword">if</span> itime == 1
0508                         <span class="comment">% Form the structure on the first time</span>
0509                         [AM{i,j}, tout(1,itime), DataTime{i,j}, ErrorFlagNew] = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Inputs1{:}, <span class="string">'Struct'</span>, InputFlags{:});
0510                     <span class="keyword">else</span>
0511                         <span class="comment">% Add to the Data and time fields</span>
0512                         [AM{i,j}.Data(:,itime), tmp, AM{i,j}.DataTime(:,itime), ErrorFlagNew] = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Inputs1{:}, <span class="string">'Numeric'</span>, InputFlags{:});
0513                         AM{i,j}.t(1,itime) = t(itime);
0514                         AM{i,j}.tout(1,itime) = etime(clock, t0);
0515                         DataTime{i,j}(:,itime) = AM{i,j}.DataTime(:,itime);
0516                     <span class="keyword">end</span>
0517                 <span class="keyword">else</span>
0518                     [AM{i,j}(:,itime), tmp, DataTime{i,j}(:,itime), ErrorFlagNew] = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Inputs1{:}, <span class="string">'Numeric'</span>, InputFlags{:});
0519                 <span class="keyword">end</span>
0520                 ErrorFlag = ErrorFlag | any(ErrorFlagNew);
0521             <span class="keyword">end</span>
0522             tout(itime) = etime(clock, t0);
0523         <span class="keyword">end</span>
0524     <span class="keyword">end</span>
0525 
0526     <span class="comment">% Make the output an AccObj object</span>
0527     <span class="keyword">if</span> ObjectOutputFlag
0528         AM = AccObj(AM);
0529     <span class="keyword">end</span>
0530 
0531     <span class="keyword">return</span>
0532 <span class="keyword">end</span>
0533 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0534 <span class="comment">% End cell input %</span>
0535 <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0536 
0537 
0538 
0539 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0540 <span class="comment">% COMMONNAME - Commonname input with no family input %</span>
0541 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0542 <span class="keyword">if</span> isempty(varargin{1})
0543     <span class="keyword">if</span> length(varargin) &gt;= 2
0544         <span class="keyword">if</span> ischar(varargin{2})
0545             Field = varargin{2};
0546             varargin(2) = [];
0547         <span class="keyword">end</span>
0548     <span class="keyword">else</span>
0549         <span class="comment">% For an empty input, return empty</span>
0550         <span class="keyword">if</span> isempty(varargin{1})
0551             AM =[]; tout = []; DataTime = []; ErrorFlag = 0;
0552             <span class="keyword">return</span>
0553         <span class="keyword">end</span>
0554     <span class="keyword">end</span>
0555     <span class="keyword">if</span> isempty(Field)
0556         Field = FieldDefault;
0557     <span class="keyword">end</span>
0558     <span class="keyword">if</span> length(varargin) &gt;= 2
0559         CommonNames = varargin{2};
0560     <span class="keyword">else</span>
0561         error(<span class="string">'Common names not found on the input line.'</span>);
0562     <span class="keyword">end</span>
0563     <span class="keyword">if</span> length(varargin) &gt;= 3
0564         t = varargin{3};
0565     <span class="keyword">end</span>
0566     <span class="keyword">if</span> length(varargin) &gt;= 4
0567         FreshDataFlag = varargin{4};
0568     <span class="keyword">end</span>
0569     <span class="keyword">if</span> length(varargin) &gt;= 5
0570         TimeOutPeriod = varargin{5};
0571     <span class="keyword">end</span>
0572 
0573 
0574     <span class="comment">% Common names with no family name</span>
0575     <span class="keyword">if</span> ~ischar(CommonNames)
0576         error(<span class="string">'If Family=[], then DeviceList must be a string of common names.'</span>)
0577     <span class="keyword">end</span>
0578     [AM, tout, DataTime, DeviceList, ErrorFlag] = <a href="#_sub1" class="code" title="subfunction [AM, tout, DataTime, DeviceList, ErrorFlag] = getbycommonname(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, varargin)">getbycommonname</a>(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, InputFlags{:});
0579     <span class="keyword">if</span> ErrorFlag
0580         <span class="keyword">return</span>;
0581     <span class="keyword">end</span>
0582 
0583     <span class="keyword">if</span> StructOutputFlag || nargout &gt;= 3
0584         <span class="comment">% .DataTime is the time on computer taking the data but</span>
0585         <span class="comment">% reference it w.r.t. the time zone where Matlab is running</span>
0586         DateNumber1970 = 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0587         days = datenum(t0(1:3)) - DateNumber1970;
0588         t0_sec = 24*60*60*days + 60*60*t0(4) + 60*t0(5) + t0(6);
0589         TimeZoneDiff = round((t0_sec - real(DataTime(1,1)))/60/60);
0590         DataTime = (real(DataTime)/60/60 + TimeZoneDiff)/24 + DateNumber1970 + imag(DataTime)/(1e9 * 60 * 60 * 24);
0591     <span class="keyword">end</span>
0592 
0593     <span class="comment">% Structure output</span>
0594     <span class="keyword">if</span> StructOutputFlag
0595         AM = struct(<span class="string">'Data'</span>, AM);
0596         AM.FamilyName = CommonNames;
0597         AM.Field = Field;
0598         AM.DeviceList = DeviceList;
0599         AM.Status = [];
0600         AM.t = t;
0601         AM.tout = tout;
0602         AM.DataTime = DataTime;
0603         AM.TimeStamp = t0;
0604         [DeviceList1, Family1] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(CommonNames(1,:));
0605         AM.Mode = <a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(Family1);                      <span class="comment">% Base on just the first common name</span>
0606         [AM.Units, AM.UnitsString] = <a href="getunits.html" class="code" title="function [Units, UnitsString] = getunits(Family, Field)">getunits</a>(Family1);  <span class="comment">% Base on just the first common name</span>
0607         AM.DataDescriptor = <span class="string">'Get by Common Name'</span>;
0608         AM.CreatedBy = <span class="string">'getpv'</span>;
0609 
0610         <span class="comment">% Make the output an AccObj object</span>
0611         <span class="keyword">if</span> ObjectOutputFlag
0612             AM = AccObj(AM);
0613         <span class="keyword">end</span>
0614     <span class="keyword">end</span>
0615 
0616     <span class="keyword">return</span>
0617 <span class="keyword">end</span>
0618 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0619 <span class="comment">% End CommonName input with no family input %</span>
0620 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0621 
0622 
0623 
0624 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0625 <span class="comment">% Parce inputs depending on Data structure, AO structure, Family, ChannelName method %</span>
0626 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0627 <span class="keyword">if</span> isstruct(varargin{1})
0628     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0629     <span class="comment">% STRUCTURE INPUTS - Data structure or AO structure %</span>
0630     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0631     <span class="keyword">if</span> isfield(varargin{1},<span class="string">'FamilyName'</span>) &amp;&amp; isfield(varargin{1},<span class="string">'Field'</span>)
0632         <span class="comment">% Data structure - select FamilyName, DeviceList, Units  from the structure (.Mode flag???)</span>
0633         <span class="comment">% [AM, tout, DataTime, ErrorFlag] = getpv(DataStruct, Field {opt}, t, FreshDataFlag, TimeOutPeriod)</span>
0634 
0635         <span class="comment">% Only change StructOutputFlag if 'numeric' is not on the input line</span>
0636         <span class="keyword">if</span> ~NumericOutputFlag
0637             StructOutputFlag = 1;
0638         <span class="keyword">end</span>
0639 
0640         Family = varargin{1}.FamilyName;
0641 
0642         Field = varargin{1}.Field;
0643         <span class="keyword">if</span> length(varargin) &gt;= 2
0644             <span class="keyword">if</span> ischar(varargin{2})
0645                 Field = varargin{2};
0646                 varargin(2) = [];
0647             <span class="keyword">end</span>
0648         <span class="keyword">end</span>
0649 
0650         DeviceList = varargin{1}.DeviceList;
0651 
0652         <span class="keyword">if</span> length(varargin) &gt;= 2
0653             <span class="comment">% If the input exists use it</span>
0654             t = varargin{2};
0655         <span class="keyword">else</span>
0656             <span class="comment">% Else, get it from the structure if the field exists</span>
0657             <span class="keyword">if</span> isfield(varargin{1},<span class="string">'t'</span>)
0658                 t = varargin{1}.t;
0659             <span class="keyword">end</span>
0660         <span class="keyword">end</span>
0661         <span class="keyword">if</span> length(varargin) &gt;= 3
0662             FreshDataFlag = varargin{3};
0663         <span class="keyword">end</span>
0664         <span class="keyword">if</span> length(varargin) &gt;= 4
0665             TimeOutPeriod = varargin{4};
0666         <span class="keyword">end</span>
0667 
0668         [FamilyIndex, AO] = <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(Family);
0669 
0670         <span class="comment">% Change Units to the data structure units</span>
0671         <span class="keyword">if</span> isfield(AO, Field)
0672             AO.(Field).Units = varargin{1}.Units;
0673         <span class="keyword">end</span>
0674 
0675     <span class="keyword">elseif</span> isfield(varargin{1},<span class="string">'FamilyName'</span>)
0676         <span class="comment">% AO structure - use the AO structure directly</span>
0677         <span class="comment">%  [AM, tout, DataTime, ErrorFlag] = getpv(AO, Field, DeviceList, t, FreshDataFlag, TimeOutPeriod)</span>
0678         FamilyIndex = 1;
0679         AO = varargin{1};
0680         Family = varargin{1}.FamilyName;
0681 
0682         Field = <span class="string">''</span>;
0683         <span class="keyword">if</span> length(varargin) &gt;= 2
0684             <span class="keyword">if</span> ischar(varargin{2})
0685                 Field = varargin{2};
0686                 varargin(2) = [];
0687             <span class="keyword">end</span>
0688         <span class="keyword">end</span>
0689         <span class="keyword">if</span> length(varargin) &gt;= 2
0690             DeviceList = varargin{2};
0691         <span class="keyword">else</span>
0692             DeviceList = AO.DeviceList;
0693             iStatus = find(varargin{1}.Status == 0);
0694             DeviceList(iStatus,:) = [];
0695         <span class="keyword">end</span>
0696         <span class="keyword">if</span> length(varargin) &gt;= 3
0697             t = varargin{3};
0698         <span class="keyword">end</span>
0699         <span class="keyword">if</span> length(varargin) &gt;= 4
0700             FreshDataFlag = varargin{4};
0701         <span class="keyword">end</span>
0702         <span class="keyword">if</span> length(varargin) &gt;= 5
0703             TimeOutPeriod = varargin{5};
0704         <span class="keyword">end</span>
0705     <span class="keyword">else</span>
0706         error(<span class="string">'Input #1 of unknown type'</span>);
0707     <span class="keyword">end</span>
0708     
0709 <span class="keyword">else</span>
0710 
0711     <span class="comment">% Family, ChannelName, or Common name are still left</span>
0712     [FamilyIndex, AO] = <a href="isfamily.html" class="code" title="function  [FamilyFlag, AO] = isfamily(Family, Field)">isfamily</a>(varargin{1});
0713 
0714     <span class="keyword">if</span> FamilyIndex
0715 
0716         <span class="comment">%%%%%%%%%%%%%%%%</span>
0717         <span class="comment">% FAMILY INPUT %</span>
0718         <span class="comment">%%%%%%%%%%%%%%%%</span>
0719         <span class="comment">%  [AM, tout, DataTime, ErrorFlag] = getpv(Family, Field {opt}, DeviceList, t, FreshDataFlag, TimeOutPeriod)</span>
0720         Family = varargin{1};
0721         <span class="keyword">if</span> length(varargin) &gt;= 2
0722             <span class="keyword">if</span> ischar(varargin{2})
0723                 Field = varargin{2};
0724                 varargin(2) = [];
0725             <span class="keyword">end</span>
0726         <span class="keyword">end</span>
0727         <span class="keyword">if</span> isempty(Field)
0728             Field = FieldDefault;
0729         <span class="keyword">end</span>
0730         <span class="keyword">if</span> length(varargin) &gt;= 2
0731             DeviceList = varargin{2};
0732         <span class="keyword">end</span>
0733         <span class="keyword">if</span> length(varargin) &gt;= 3
0734             t = varargin{3};
0735         <span class="keyword">end</span>
0736         <span class="keyword">if</span> length(varargin) &gt;= 4
0737             FreshDataFlag = varargin{4};
0738         <span class="keyword">end</span>
0739         <span class="keyword">if</span> length(varargin) &gt;= 5
0740             TimeOutPeriod = varargin{5};
0741         <span class="keyword">end</span>
0742         
0743     <span class="keyword">else</span>
0744         
0745         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0746         <span class="comment">% CHANNEL NAME OR COMMON NAME INPUT %</span>
0747         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0748         
0749         <span class="comment">% Just do input parsing here</span>
0750         Family = varargin{1};
0751         
0752         <span class="comment">% Default field is '' for channel names or it would be added as ChannelName.Field</span>
0753         <span class="comment">% But for common names it needs to be 'Monitor'</span>
0754         Field = <span class="string">''</span>;
0755         <span class="keyword">if</span> length(varargin) &gt;= 2
0756             <span class="keyword">if</span> ~isnumeric(varargin{2})
0757                 Field = varargin{2};
0758                 varargin(2) = [];
0759             <span class="keyword">end</span>
0760         <span class="keyword">end</span>
0761         <span class="keyword">if</span> length(varargin) &gt;= 2
0762             t = varargin{2};
0763         <span class="keyword">end</span>
0764         <span class="keyword">if</span> length(varargin) &gt;= 3
0765             FreshDataFlag = varargin{3};
0766         <span class="keyword">end</span>
0767         <span class="keyword">if</span> length(varargin) &gt;= 4
0768             TimeOutPeriod = varargin{4};
0769         <span class="keyword">end</span> 
0770     <span class="keyword">end</span>
0771 <span class="keyword">end</span>
0772 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0773 <span class="comment">% End selection of inputs depending on Family, Data Structure, AO structure, or ChannelName method %</span>
0774 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0775 
0776 
0777 
0778 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0779 <span class="comment">% AO, ChannelName, or CommonName %</span>
0780 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0781 <span class="keyword">if</span> isempty(t)
0782     t = 0;
0783 <span class="keyword">end</span>
0784 <span class="keyword">if</span> FamilyIndex 
0785     <span class="comment">%%%%%%%%%%%%%%%%%</span>
0786     <span class="comment">% FAMILY INPUTS %</span>
0787     <span class="comment">%%%%%%%%%%%%%%%%%</span>
0788 
0789     <span class="comment">% All ready done</span>
0790     <span class="comment">%if isempty(Field)</span>
0791     <span class="comment">%    Field = 'Monitor';</span>
0792     <span class="comment">%end</span>
0793 
0794     <span class="keyword">if</span> isempty(DeviceList)
0795         DeviceList = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin);">family2dev</a>(Family);     <span class="comment">% Default behavior comes from family2dev</span>
0796         <span class="comment">%DeviceList = family2dev(Family,1);  % Good status only</span>
0797         <span class="comment">%DeviceList = AO.DeviceList;         % All devices</span>
0798     <span class="keyword">end</span>
0799     <span class="keyword">if</span> ischar(DeviceList)
0800         <span class="comment">% Convert common name to a DeviceList</span>
0801         DeviceList = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(DeviceList, AO);
0802     <span class="keyword">end</span>
0803     <span class="keyword">if</span> (size(DeviceList,2) == 1) 
0804         DeviceList = <a href="elem2dev.html" class="code" title="function Output = elem2dev(Family, ElementList)">elem2dev</a>(Family, DeviceList);
0805     <span class="keyword">end</span>
0806 
0807 
0808     <span class="comment">% Look for command-line over-rides</span>
0809     <span class="keyword">if</span> isfield(AO, Field)
0810         <span class="keyword">if</span> ~isempty(UnitsFlag)
0811             AO.(Field).Units = UnitsFlag;
0812         <span class="keyword">end</span>
0813         <span class="keyword">if</span> ~isempty(ModeFlag)
0814             <span class="keyword">if</span> strcmp(ModeFlag, <span class="string">'Online'</span>) &amp;&amp; strcmp(AO.(Field).Mode, <span class="string">'Special'</span>)
0815                 <span class="comment">% For Online over-rides, look for Special mode first</span>
0816                 AO.(Field).Mode = <span class="string">'Special'</span>;
0817             <span class="keyword">else</span>
0818                 AO.(Field).Mode = ModeFlag;
0819             <span class="keyword">end</span>
0820         <span class="keyword">end</span>
0821     <span class="keyword">end</span>
0822 
0823     
0824     <span class="comment">% Get data</span>
0825     ExtraTimeDelay = etime(clock, t0);
0826     <span class="keyword">if</span> StructOutputFlag || nargout &gt;= 3
0827         [AM, tout, DataTime, ErrorFlag, DeviceIndex] = <a href="#_sub3" class="code" title="subfunction [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_getpv(AO, Field, DeviceList, OutputDataType, t, FreshDataFlag, TimeOutPeriod)">local_getpv</a>(AO, Field, DeviceList, OutputDataType, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0828     <span class="keyword">else</span>
0829         [AM, tout] = <a href="#_sub3" class="code" title="subfunction [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_getpv(AO, Field, DeviceList, OutputDataType, t, FreshDataFlag, TimeOutPeriod)">local_getpv</a>(AO, Field, DeviceList, OutputDataType, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0830     <span class="keyword">end</span>
0831     tout = tout + ExtraTimeDelay;
0832 
0833     
0834     <span class="keyword">if</span> StructOutputFlag
0835         <span class="comment">% Structure output</span>
0836         AM = struct(<span class="string">'Data'</span>, AM);
0837         <span class="comment">%AM.Data = AM;</span>
0838         AM.FamilyName = Family;
0839         AM.Field = Field;
0840         AM.DeviceList = DeviceList;
0841         <span class="keyword">if</span> length(AO.Status) == 1
0842             AM.Status = AO.Status * ones(size(DeviceIndex));
0843         <span class="keyword">else</span>
0844             <span class="comment">%AM.Status = family2status(Family, AM.DeviceList);</span>
0845             AM.Status = AO.Status(DeviceIndex);
0846         <span class="keyword">end</span>
0847         <span class="keyword">if</span> isfield(AO, Field)
0848             AM.Mode = AO.(Field).Mode;
0849             AM.Units = AO.(Field).Units;
0850             <span class="keyword">if</span> strcmpi(AM.Units,<span class="string">'hardware'</span>)
0851                 AM.UnitsString = AO.(Field).HWUnits;
0852             <span class="keyword">else</span>
0853                 AM.UnitsString = AO.(Field).PhysicsUnits;
0854             <span class="keyword">end</span>
0855             AM.DataDescriptor = <span class="string">'Get by FamilyName'</span>; 
0856         <span class="keyword">else</span>
0857             AM.Mode = <span class="string">'Online'</span>;
0858             AM.Units = <span class="string">''</span>;
0859             AM.UnitsString = <span class="string">''</span>;
0860             AM.DataDescriptor = <span class="string">'Get by Channel Name'</span>;
0861         <span class="keyword">end</span>
0862         AM.CreatedBy = <span class="string">'getpv'</span>;
0863     <span class="keyword">end</span>
0864 
0865 <span class="keyword">else</span>
0866 
0867     <span class="comment">% Look to see if it's a channel name or a common name</span>
0868     <span class="comment">% Just check the first name so it's a faster test</span>
0869     [DeviceListTest, FamilyTest] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(Family(1,:));
0870 
0871     <span class="keyword">if</span> ~isempty(FamilyTest)
0872         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0873         <span class="comment">% Common names where the family was the common name %</span>
0874         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0875         
0876         <span class="comment">% Field default will come from getbycommonname via another getpv call</span>
0877         <span class="comment">% The DeviceList does not matter (and should not be used)</span>
0878 
0879         CommonNames = Family;
0880         [AM, tout, DataTime, DeviceList, ErrorFlag] = <a href="#_sub1" class="code" title="subfunction [AM, tout, DataTime, DeviceList, ErrorFlag] = getbycommonname(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, varargin)">getbycommonname</a>(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, InputFlags{:});
0881         <span class="keyword">if</span> ErrorFlag
0882             <span class="keyword">return</span>;
0883         <span class="keyword">end</span>
0884 
0885         <span class="comment">% Structure output</span>
0886         <span class="keyword">if</span> StructOutputFlag
0887             AM = struct(<span class="string">'Data'</span>, AM);
0888             AM.FamilyName = CommonNames;
0889             AM.Field = Field;
0890             AM.DeviceList = DeviceList;
0891             AM.Status = [];
0892             AM.Mode = <a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(FamilyTest(1,:));                      <span class="comment">% Base on just the first common name</span>
0893             [AM.Units, AM.UnitsString] = <a href="getunits.html" class="code" title="function [Units, UnitsString] = getunits(Family, Field)">getunits</a>(FamilyTest(1,:));  <span class="comment">% Base on just the first common name</span>
0894             AM.DataDescriptor = <span class="string">'Get by Common Name'</span>;
0895             AM.CreatedBy = <span class="string">'getpv'</span>;
0896         <span class="keyword">end</span>
0897 
0898     <span class="keyword">else</span>
0899 
0900         <span class="comment">%%%%%%%%%%%%%%%%</span>
0901         <span class="comment">% CHANNEL NAME %</span>
0902         <span class="comment">%%%%%%%%%%%%%%%%</span>
0903 
0904         <span class="comment">% Can't use overrides with channel name method</span>
0905         <span class="keyword">if</span> ~isempty(UnitsFlag)
0906             error(<span class="string">'You cannot change the units when using tango names.'</span>)
0907         <span class="keyword">end</span>
0908         <span class="keyword">if</span> ~(isempty(ModeFlag) || strcmpi(ModeFlag, <span class="string">'Online'</span>))
0909             error(<span class="string">'Tango names only have an ''Online'' Mode.'</span>)
0910         <span class="keyword">end</span>
0911 
0912 
0913         <span class="comment">% Add Field to Family.Field</span>
0914         FamilyOld = Family;
0915         <span class="keyword">if</span> ~isempty(Field)
0916             Family = strcat(Family, [<span class="string">'.'</span>,Field]);
0917         <span class="keyword">end</span>
0918 
0919 
0920         ExtraTimeDelay = etime(clock, t0);
0921         <span class="keyword">if</span> strcmpi(OutputDataType,<span class="string">'String'</span>)
0922             <span class="comment">% Get data with strings output</span>
0923             <span class="keyword">if</span> StructOutputFlag || nargout &gt;= 3
0924                 [AM, tout, DataTime, ErrorFlag] = getpvonline(Family, <span class="string">'String'</span>, 0, t-ExtraTimeDelay);
0925             <span class="keyword">else</span>
0926                 [AM, tout] = getpvonline(Family, <span class="string">'String'</span>, 0, t-ExtraTimeDelay);
0927             <span class="keyword">end</span>
0928         <span class="keyword">else</span>
0929             <span class="comment">% Get data at every point in time vector, t</span>
0930             <span class="keyword">if</span> StructOutputFlag || nargout &gt;= 3
0931                 [AM, tout, DataTime, ErrorFlag] = <a href="#_sub2" class="code" title="subfunction [AM, tout, DataTime, ErrorFlag] = local_getbyname(ChannelName, OutputDataType, N, t, FreshDataFlag, TimeOutPeriod)">local_getbyname</a>(Family, OutputDataType, 0, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0932             <span class="keyword">else</span>
0933                 [AM, tout] = <a href="#_sub2" class="code" title="subfunction [AM, tout, DataTime, ErrorFlag] = local_getbyname(ChannelName, OutputDataType, N, t, FreshDataFlag, TimeOutPeriod)">local_getbyname</a>(Family, OutputDataType, 0, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
0934             <span class="keyword">end</span>
0935         <span class="keyword">end</span>
0936         tout = tout + ExtraTimeDelay;
0937 
0938 
0939         <span class="comment">% Structure output for channel name method</span>
0940         <span class="keyword">if</span> StructOutputFlag
0941             AM = struct(<span class="string">'Data'</span>, AM);
0942             <span class="comment">%AM.Data = AM;</span>
0943             AM.FamilyName = FamilyOld;
0944             AM.Field = Field;
0945             AM.DeviceList = [];
0946             AM.Status = [];
0947             AM.Mode = <span class="string">'Online'</span>;
0948             AM.Units = <span class="string">''</span>;
0949             AM.UnitsString = <span class="string">''</span>;
0950             AM.DataDescriptor = <span class="string">'Get by Channel Name'</span>;
0951             AM.CreatedBy = <span class="string">'getpv'</span>;
0952         <span class="keyword">end</span>
0953     <span class="keyword">end</span>
0954 <span class="keyword">end</span>
0955 
0956 
0957 <span class="keyword">if</span> StructOutputFlag || nargout &gt;= 3
0958     <span class="comment">% .DataTime is the time on computer taking the data but</span>
0959     <span class="comment">% reference it w.r.t. the time zone where Matlab is running</span>
0960     DateNumber1970 = 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
0961     days = datenum(t0(1:3)) - DateNumber1970;
0962     t0_sec = 24*60*60*days + 60*60*t0(4) + 60*t0(5) + t0(6);
0963     TimeZoneDiff = round((t0_sec - real(DataTime(1,1)))/60/60);
0964     DataTime = (real(DataTime)/60/60 + TimeZoneDiff)/24 + DateNumber1970 + imag(DataTime)/(1e9 * 60 * 60 * 24);
0965 
0966     <span class="comment">% No time zone adjustment (UTC 00:00:00 Jan 1, 1970)</span>
0967     <span class="comment">%DataTime = real(DataTime)/60/60/24 + imag(DataTime)/(1e9 * 60 * 60 * 24);</span>
0968 <span class="keyword">end</span>
0969 
0970 
0971 <span class="comment">% Structure output</span>
0972 <span class="keyword">if</span> StructOutputFlag
0973     <span class="comment">% Add time to structure</span>
0974     AM.t = t;
0975     AM.tout = tout;
0976     AM.DataTime = DataTime;
0977     AM.TimeStamp = t0;
0978 
0979     <span class="comment">% Make the output an AccObj object</span>
0980     <span class="keyword">if</span> ObjectOutputFlag
0981         AM = AccObj(AM);
0982     <span class="keyword">end</span>
0983 <span class="keyword">end</span>
0984 
0985 
0986 
0987 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0988 <span class="comment">%  Main Function for Getting Data Using Common Names  %</span>
0989 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0990 <a name="_sub1" href="#_subfunctions" class="code">function [AM, tout, DataTime, DeviceList, ErrorFlag] = getbycommonname(CommonNames, Field, t, t0, FreshDataFlag, TimeOutPeriod, varargin)</a>
0991 
0992 <span class="comment">% Convert all the common names to Family and Device lists</span>
0993 [DeviceList, Family, ErrorFlag] = <a href="common2dev.html" class="code" title="function [DeviceList, FamilyName, ErrorFlag] = common2dev(CommonNames, FamilyList)">common2dev</a>(CommonNames);
0994 
0995 <span class="keyword">if</span> ErrorFlag
0996     AM=[]; tout=[]; DataTime=[];
0997     <span class="keyword">return</span>;
0998 <span class="keyword">else</span>
0999 
1000     <span class="comment">% If all the families are the same then compress them</span>
1001     FamilyTest = unique(Family, <span class="string">'rows'</span>);
1002 
1003     <span class="keyword">if</span> size(FamilyTest, 1) == 1
1004         <span class="comment">% 1 Family, Multiple devices are ok</span>
1005         [AM, tout, DataTime, ErrorFlag] = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(FamilyTest, Field, DeviceList, t, FreshDataFlag, TimeOutPeriod, <span class="string">'Numeric'</span>, varargin{:});
1006     <span class="keyword">else</span>
1007         <span class="comment">% Multiple families (loop)</span>
1008         <span class="comment">% It has to be in a loop for the simulator and to pickup special functions</span>
1009 
1010         <span class="keyword">if</span> FreshDataFlag &gt;= 1
1011             error(<span class="string">'The FreshDataFlag is not programmed yet when when getting common names from multiple families (GJP).'</span>);
1012         <span class="keyword">end</span>
1013 
1014         <span class="comment">% Loop on the time vector (t0 has already been started)</span>
1015         <span class="keyword">for</span> itime = 1:length(t)
1016             T = t(itime)-etime(clock, t0);
1017             <span class="keyword">if</span> T &gt; 0
1018                 pause(T);
1019             <span class="keyword">end</span>
1020             <span class="keyword">for</span> i = 1:size(Family,1)
1021                 [AM(i,itime), tmp, DataTime(i,itime), ErrorFlag1] = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Family(i,:), Field, DeviceList(i,:), <span class="string">'Numeric'</span>, varargin{:});
1022                 tout(1,itime) = etime(clock, t0);
1023                 ErrorFlag = ErrorFlag | ErrorFlag1;
1024             <span class="keyword">end</span>
1025         <span class="keyword">end</span>
1026     <span class="keyword">end</span>
1027 <span class="keyword">end</span>
1028 
1029 
1030 
1031 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1032 <span class="comment">%  Main Function for Getting Data using the Channel Names  %</span>
1033 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1034 <a name="_sub2" href="#_subfunctions" class="code">function [AM, tout, DataTime, ErrorFlag] = local_getbyname(ChannelName, OutputDataType, N, t, FreshDataFlag, TimeOutPeriod)</a>
1035 
1036 t0 = clock;
1037 ErrorFlag = 0;
1038 
1039 
1040 <span class="keyword">if</span> nargout &lt; 3
1041     [AM, tout] = getpvonline(ChannelName, OutputDataType, N, t);
1042 <span class="keyword">else</span>
1043     [AM, tout, DataTime, ErrorFlag] = getpvonline(ChannelName, OutputDataType, N, t);
1044 <span class="keyword">end</span>
1045 
1046 
1047 <span class="comment">% FreshDataFlag</span>
1048 <span class="keyword">if</span> FreshDataFlag &amp;&amp; length(t) == 1
1049     <span class="comment">% Only use FreshDataFlag for scalar t</span>
1050     FreshDataCounter = FreshDataFlag;
1051     AM0 = AM;
1052     <span class="keyword">while</span> FreshDataCounter
1053         <span class="keyword">if</span> nargout &lt; 3
1054             [AM, tout] = getpvonline(ChannelName, OutputDataType, N);
1055         <span class="keyword">else</span>
1056             [AM, tout, DataTime, ErrorFlag] = getpvonline(ChannelName, OutputDataType, N);
1057         <span class="keyword">end</span>
1058 
1059         <span class="keyword">if</span> ~any((AM-AM0)==0)
1060             FreshDataCounter = FreshDataCounter - 1;
1061             AM0 = AM;
1062         <span class="keyword">end</span>
1063 
1064         <span class="keyword">if</span> etime(clock, t0) &gt; TimeOutPeriod
1065             k = find((AM-AM0)==0);
1066             <span class="keyword">for</span> j = 1:length(k)
1067                 fprintf(<span class="string">'%s not changing.\n'</span>, deblank(ChannelName(k(j),:)));
1068             <span class="keyword">end</span>
1069             error(<span class="string">'Timed out waiting for fresh data.'</span>);
1070         <span class="keyword">end</span>
1071     <span class="keyword">end</span>
1072     tout = etime(clock, t0);
1073 <span class="keyword">end</span>
1074 
1075 <span class="keyword">return</span>
1076 
1077 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1078 <span class="comment">%  Main Function for Getting Data using the Accelerator Object  %</span>
1079 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1080 <a name="_sub3" href="#_subfunctions" class="code">function [AM, tout, DataTime, ErrorFlag, DeviceIndex] = local_getpv(AO, Field, DeviceList, OutputDataType, t, FreshDataFlag, TimeOutPeriod)</a>
1081 <span class="comment">%  INPUTS</span>
1082 <span class="comment">%  1. AO - the ACCELERATOR_OBJECT structure for the called family</span>
1083 <span class="comment">%  2. Field - 'Monitor' or 'Setpoint'</span>
1084 <span class="comment">%  3. DeviceList - Device list</span>
1085 <span class="comment">%</span>
1086 <span class="comment">%  OUTPUTS</span>
1087 <span class="comment">%  1. AM - Vector a read values</span>
1088 <span class="comment">%  2. TimeStamp - timestamp when data collected</span>
1089 <span class="comment">%  3. ErrorFlag - 0 if OK, else 1</span>
1090 <span class="comment">%  4. DeviceIndex - List of status 1 devices</span>
1091 
1092 <span class="comment">%  Written by Gregory J. Portmann</span>
1093 <span class="comment">%  Modified by Laurent S. Nadolski</span>
1094 
1095 t0 = clock;
1096 ErrorFlag = 0;
1097 N = 0;  <span class="comment">% Output size</span>
1098 
1099 
1100 <span class="comment">% Find the index for where the desired data is in the total device list</span>
1101 DeviceListTotal = AO.DeviceList;
1102 [DeviceIndex, iNotFound] = findrowindex(DeviceList, DeviceListTotal);
1103 <span class="keyword">if</span> length(iNotFound) &gt; 0
1104     <span class="comment">% Device not found</span>
1105     <span class="keyword">for</span> i = 1:length(iNotFound)
1106         fprintf(<span class="string">'   No devices to get for Family %s(%d,%d)\n'</span>, AO.FamilyName, DeviceList(i,1), DeviceList(i,2));
1107     <span class="keyword">end</span>
1108     error(<span class="string">'%d Devices not found'</span>, length(iNotFound));
1109 <span class="keyword">end</span>
1110 
1111 <span class="comment">% Check the DeviceIndex</span>
1112 <span class="keyword">if</span> isempty(DeviceIndex)
1113     DataTime = 0 + 0*sqrt(-1);
1114     tout = etime(clock, t0);
1115     AM = [];
1116     <span class="comment">%fprintf('   WARNING:  No devices to get for Family %s (getpv)\n', AO.FamilyName);</span>
1117     <span class="keyword">return</span>;
1118 <span class="keyword">end</span>
1119 
1120 <span class="comment">%% TANGO specific part</span>
1121 
1122 <span class="comment">% Load Field sub-structure into AOField</span>
1123 <span class="keyword">if</span> ~isfield(AO, Field);
1124     <span class="comment">% Try to check it online or simulator</span>
1125     <span class="keyword">if</span> isfield(AO, <span class="string">'Setpoint'</span>)
1126         Mode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(AO.FamilyName, <span class="string">'Setpoint'</span>, <span class="string">'Mode'</span>);
1127     <span class="keyword">elseif</span> isfield(AO, <span class="string">'Monitor'</span>)
1128         Mode = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(AO.FamilyName, <span class="string">'Monitor'</span>, <span class="string">'Mode'</span>);
1129     <span class="keyword">else</span>
1130         Mode = <span class="string">''</span>;
1131     <span class="keyword">end</span>
1132     <span class="keyword">if</span> strcmpi(Mode,<span class="string">'Simulator'</span>) || strcmpi(Mode,<span class="string">'Model'</span>)
1133         ExtraTimeDelay = etime(clock, t0);
1134         [AM, tout, DataTime, ErrorFlag] = getpvmodel(AO.FamilyName, Field, DeviceList, t-ExtraTimeDelay, <span class="string">'Physics'</span>, <span class="string">'Numeric'</span>);
1135         tout = tout + ExtraTimeDelay;
1136         
1137         <span class="comment">% Since physics2hw conversions are not known for fields that are not families, just return</span>
1138         <span class="keyword">return</span>
1139     <span class="keyword">end</span>
1140     
1141     <span class="comment">% Try changing the suffix of the Monitor or Setpoint field</span>
1142     <span class="keyword">if</span> isfield(AO, <span class="string">'Setpoint'</span>)
1143         Tango = family2tango(AO, <span class="string">'Setpoint'</span>, DeviceList);
1144     <span class="keyword">elseif</span> isfield(AO, <span class="string">'Monitor'</span>)
1145         Tango = family2tango(AO, <span class="string">'Monitor'</span>, DeviceList);
1146     <span class="keyword">else</span>
1147         error(sprintf(<span class="string">'Field %s not found for Family %s'</span>, Field, AO.FamilyName));
1148     <span class="keyword">end</span>
1149     <span class="keyword">if</span> any(strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),{<span class="string">'spear3'</span>,<span class="string">'spear'</span>}))
1150         <span class="comment">% Spear likes to change the channel name after the ':'</span>
1151         
1152         <span class="comment">%i = findstr(Channel(1,:),':');</span>
1153         <span class="comment">%if ~isempty(i)</span>
1154         <span class="comment">%    Channel(:,i:end) = [];</span>
1155         <span class="comment">%end</span>
1156         <span class="comment">%Channel = strcat(Channel, [':',Field]);</span>
1157 
1158         <span class="comment">% Since the location of &quot;:&quot; can be different in each row, loop</span>
1159         ChannelMat = [];
1160         <span class="keyword">for</span> j = 1:size(Channel,1)
1161             i = findstr(Channel(j,:),<span class="string">':'</span>);
1162             <span class="keyword">if</span> isempty(i)
1163                 <span class="comment">% I'm not sure what to do if &quot;:&quot; is missing, I'm just add a &quot;:&quot;</span>
1164                 ChannelMat = strvcat(ChannelMat, [Channel(j,1:i), <span class="string">':'</span>, Field]);
1165             <span class="keyword">else</span>
1166                 ChannelMat = strvcat(ChannelMat, [Channel(j,1:i), Field]);
1167             <span class="keyword">end</span>
1168         <span class="keyword">end</span>
1169         Tango = strcat(Tango, [<span class="string">':'</span>,Field]);
1170     <span class="keyword">else</span>
1171         <span class="comment">% Add a .Field</span>
1172         Tango = strcat(Tango, [<span class="string">'.'</span>,Field]);
1173     <span class="keyword">end</span>
1174 
1175     ExtraTimeDelay = etime(clock, t0);
1176     <span class="keyword">if</span> nargout &lt; 3
1177         [AM, tout] = getpvonline(Tango, OutputDataType, N, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
1178     <span class="keyword">else</span>
1179         [AM, tout, DataTime, ErrorFlag] = getpvonline(Tango, OutputDataType, N, t-ExtraTimeDelay, FreshDataFlag, TimeOutPeriod);
1180     <span class="keyword">end</span>
1181     tout = tout + ExtraTimeDelay;
1182     <span class="keyword">return</span>
1183 <span class="keyword">end</span>
1184 
1185 
1186 AOField = AO.(Field);   <span class="comment">% Should I replace this????</span>
1187 
1188 <span class="comment">% If mode does not exist, force to online mode</span>
1189 <span class="keyword">if</span> isfield(AOField, <span class="string">'Mode'</span>)
1190     Mode = AOField.Mode;
1191 <span class="keyword">else</span>
1192     Mode = <span class="string">'Online'</span>;
1193 <span class="keyword">end</span>
1194 
1195 
1196 <span class="comment">% Check if Online should really be special</span>
1197 <span class="keyword">if</span> strcmpi(Mode, <span class="string">'Online'</span>)
1198    <span class="keyword">if</span> isfield(AO.(Field), <span class="string">'SpecialFunctionGet'</span>)
1199        Mode = <span class="string">'Special'</span>;
1200    <span class="keyword">end</span>
1201 <span class="keyword">end</span>
1202 
1203 
1204 <span class="keyword">if</span> ~isstruct(AO.(Field))
1205     <span class="comment">% If it's not a structure that just get the field</span>
1206     <span class="comment">% Hardward and physics get ignored</span>
1207     t1 = clock;
1208     [AM, ErrorFlag] = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(AO.FamilyName, Field, DeviceList);
1209     
1210     tout = etime(t1, t0);
1211     <span class="keyword">if</span> nargout &gt;= 3
1212         days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
1213         tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
1214         DataTime(1:size(AM,1),1:length(t)) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
1215     <span class="keyword">end</span>
1216     
1217 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'online'</span>)
1218     <span class="comment">% Online</span>
1219     <span class="keyword">if</span> strcmpi(AOField.DataType,<span class="string">'Scalar'</span>)
1220         N = 1;  <span class="comment">% Output size</span>
1221 
1222         ExtraTimeDelay = etime(clock, t0);
1223         <span class="keyword">if</span> nargout &lt; 3
1224             [AM, tout] = getpvonline(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N, t-ExtraTimeDelay);
1225         <span class="keyword">else</span>
1226             [AM, tout, DataTime, ErrorFlag] = getpvonline(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N, t-ExtraTimeDelay);
1227         <span class="keyword">end</span>
1228         tout = tout + ExtraTimeDelay;
1229 
1230         <span class="comment">% FreshDataFlag</span>
1231         <span class="keyword">if</span> FreshDataFlag &amp;&amp; length(t) == 1
1232             <span class="comment">% Only use FreshDataFlag for scalar t</span>
1233             FreshDataCounter = FreshDataFlag;
1234             AM0 = AM;
1235             <span class="keyword">while</span> FreshDataCounter
1236                 <span class="keyword">if</span> nargout &lt; 3
1237                     [AM, tout] = getpvonline(AOField.TangoNames(DeviceIndex,:), Field,OutputDataType, N);
1238                 <span class="keyword">else</span>
1239                     [AM, tout, DataTime, ErrorFlag] = getpvonline(AOField.TangoNames(DeviceIndex,:), Field, OutputDataType, N);
1240                 <span class="keyword">end</span>
1241 
1242                 <span class="keyword">if</span> ~any((AM-AM0)==0)
1243                     FreshDataCounter = FreshDataCounter - 1;
1244                     AM0 = AM;
1245                 <span class="keyword">end</span>
1246 
1247                 <span class="keyword">if</span> etime(clock, t0) &gt; TimeOutPeriod
1248                     k = find((AM-AM0)==0);
1249                     <span class="keyword">for</span> j = 1:length(k)
1250                         fprintf(<span class="string">'%s not changing.\n'</span>, deblank((AOField.TangoNames(DeviceIndex(k(j)),:))));
1251                     <span class="keyword">end</span>
1252                     error(<span class="string">'Timed out waiting for fresh data.'</span>);
1253                 <span class="keyword">end</span>
1254             <span class="keyword">end</span>
1255             tout = etime(clock, t0);
1256         <span class="keyword">end</span>
1257         
1258     <span class="keyword">elseif</span> strcmpi(AOField.DataType, <span class="string">'Vector'</span>)
1259 
1260 
1261         <span class="comment">% Output(DataTypeIndex) must be equal to the number of elements in the family</span>
1262         
1263         <span class="comment">% There can only be one Tango or channel name for DataType='Vector'</span>
1264         TangoNames = deblank(AOField.TangoNames(1,:));
1265 
1266 
1267 
1268         <span class="comment">% Get data at every point in time vector, t</span>
1269         AM = [];
1270         ExtraTimeDelay = etime(clock, t0);
1271         t = t - ExtraTimeDelay;
1272         <span class="keyword">for</span> itime = 1:length(t)
1273             T = t(itime)-etime(clock, t0);
1274             <span class="keyword">if</span> T &gt; 0
1275                 pause(T);
1276             <span class="keyword">end</span>
1277 
1278             <span class="comment">% Get data</span>
1279             <span class="keyword">if</span> nargout &gt;= 3
1280                 [tmp, tout, DataTime(:,itime), ErrorFlag] = getpvonline(TangoNames, <span class="string">'Vector'</span>, N);
1281             <span class="keyword">else</span>
1282                 tmp = getpvonline(TangoNames, <span class="string">'Vector'</span>, N);
1283             <span class="keyword">end</span>
1284             <span class="keyword">if</span> isfield(AOField, <span class="string">'DataTypeIndex'</span>)
1285                 tmp = tmp(AOField.DataTypeIndex);
1286             <span class="keyword">end</span>
1287             AM = [AM tmp(DeviceIndex,:)];
1288 
1289             tout(itime) = etime(clock, t0);
1290         <span class="keyword">end</span>
1291 
1292         <span class="comment">% FreshDataFlag</span>
1293         <span class="keyword">if</span> FreshDataFlag &amp; length(t) == 1
1294             <span class="comment">% Only use FreshDataFlag for scalar t</span>
1295             FreshDataCounter = FreshDataFlag;
1296             AM0 = AM;
1297             <span class="keyword">while</span> FreshDataCounter
1298                 <span class="keyword">if</span> nargout &gt;= 3
1299                     [AM, tout, DataTime, ErrorFlag] = getpvonline(TangoNames, <span class="string">'Vector'</span>, N);
1300                 <span class="keyword">else</span>
1301                     AM = getpvonline(TangoNames, <span class="string">'Vector'</span>, N);
1302                 <span class="keyword">end</span>
1303                 <span class="keyword">if</span> isfield(AOField, <span class="string">'DataTypeIndex'</span>)
1304                     AM = AM(AOField.DataTypeIndex);
1305                 <span class="keyword">end</span>
1306                 AM = AM(DeviceIndex,:);
1307 
1308                 <span class="keyword">if</span> ~any((AM-AM0)==0)
1309                     FreshDataCounter = FreshDataCounter - 1;
1310                     AM0 = AM;
1311                 <span class="keyword">end</span>
1312 
1313                 <span class="keyword">if</span> etime(clock, t0) &gt; TimeOutPeriod
1314                     k = find((AM-AM0)==0);
1315                     <span class="keyword">for</span> j = 1:length(k)
1316                         fprintf(<span class="string">'%s[%d,%d] not changing.\n'</span>, AO.FamilyName, DeviceList(k(j),1), DeviceList(k(j),2));
1317                     <span class="keyword">end</span>
1318                     error(<span class="string">'Timed out waiting for fresh data.'</span>);
1319                 <span class="keyword">end</span>
1320             <span class="keyword">end</span>
1321             tout = etime(clock, t0);
1322         <span class="keyword">end</span>
1323 
1324     <span class="keyword">elseif</span> strcmpi(AOField.DataType,<span class="string">'Matrix'</span>)
1325 
1326         <span class="keyword">for</span> iDev = 1:length(DeviceIndex)
1327             <span class="comment">%AM(iDev,:) = rand(1,10); DataTime(iDev,:) = now; ErrorFlag(iDev,:)=0;</span>
1328             [AM(iDev,:), tout, DataTime(iDev,:), ErrorFlag(iDev,1)] = getpvonline(AOField.TangoNames(DeviceIndex(iDev),:), <span class="string">'Matrix'</span>, N);
1329         <span class="keyword">end</span>
1330         ErrorFlag = any(ErrorFlag);
1331         tout = etime(clock, t0);
1332 
1333     <span class="keyword">else</span>
1334         error(sprintf(<span class="string">'Unknown DataType for family %s.'</span>, AO.FamilyName));
1335     <span class="keyword">end</span>
1336 
1337     <span class="comment">% Change to physics units if Units = 'physics'</span>
1338     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
1339         <span class="comment">% Change to physics units</span>
1340         AM = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(AO.FamilyName, Field, AM, DeviceList);
1341     <span class="keyword">end</span>
1342 
1343 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Special'</span>)
1344 
1345     <span class="keyword">if</span> isfield(AOField, <span class="string">'SpecialFunctionGet'</span>)
1346         SpecialFunction = AOField.SpecialFunctionGet;
1347     <span class="keyword">elseif</span> isfield(AOField, <span class="string">'SpecialFunction'</span>)
1348         SpecialFunction = AOField.SpecialFunction;
1349     <span class="keyword">else</span>
1350         error(sprintf(<span class="string">'No special function specified for Family %s (getpv).'</span>, AO.FamilyName));
1351     <span class="keyword">end</span>
1352 
1353     <span class="comment">% Get data at every point in time vector, t</span>
1354     ExtraTimeDelay = etime(clock, t0);
1355     t = t - ExtraTimeDelay;
1356     [AM, tout, DataTime, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
1357     t1 = clock;
1358     <span class="keyword">if</span> isempty(tout)
1359         tout = etime(t1, t0);
1360     <span class="keyword">end</span>
1361     <span class="keyword">if</span> nargout &gt;= 3 &amp;&amp; isempty(DataTime)
1362         days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
1363         tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
1364         DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
1365     <span class="keyword">end</span>
1366     <span class="keyword">if</span> length(t) &gt; length(tout)
1367         <span class="keyword">for</span> itime = 2:length(t)
1368             T = t(itime)-etime(clock, t0);
1369             <span class="keyword">if</span> T &gt; 0
1370                 pause(T);
1371             <span class="keyword">end</span>
1372 
1373             <span class="comment">% Get data</span>
1374             [Tmp, toutTmp, DataTimeTmp, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
1375             
1376             AM = [AM Tmp];
1377             DataTime = [DataTime DataTimeTmp];
1378 
1379             t1 = clock;
1380             tout(1,itime) = etime(t1, t0);
1381             <span class="keyword">if</span> nargout &gt;= 3 &amp;&amp; isempty(DataTimeTmp)
1382                 days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
1383                 tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
1384                 DataTime(1:size(AM,1),itime) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
1385             <span class="keyword">end</span>
1386         <span class="keyword">end</span>
1387     <span class="keyword">end</span>
1388 
1389     <span class="comment">% FreshDataFlag</span>
1390     <span class="keyword">if</span> FreshDataFlag &amp;&amp; length(t) == 1
1391         <span class="comment">% Only use FreshDataFlag for scalar t</span>
1392         FreshDataCounter = FreshDataFlag;
1393         AM0 = AM;
1394         <span class="keyword">while</span> FreshDataCounter
1395             <span class="comment">% Get data</span>
1396             [AM, tout, DataTime, ErrorFlag] = feval(SpecialFunction, AO.FamilyName, Field, DeviceList, t);
1397 
1398             <span class="keyword">if</span> ~any((AM-AM0)==0)
1399                 FreshDataCounter = FreshDataCounter - 1;
1400                 AM0 = AM;
1401             <span class="keyword">end</span>
1402 
1403             t1 = clock;
1404             <span class="keyword">if</span> etime(t1, t0) &gt; TimeOutPeriod
1405                 k = find((AM-AM0)==0);
1406                 <span class="keyword">for</span> j = 1:length(k)
1407                     fprintf(<span class="string">'%s[%d,%d] not changing.\n'</span>, AO.FamilyName, DeviceList(k(j),1), DeviceList(k(j),2));
1408                 <span class="keyword">end</span>
1409                 error(<span class="string">'Timed out waiting for fresh data.'</span>);
1410             <span class="keyword">end</span>
1411         <span class="keyword">end</span>
1412         tout = etime(t1, t0);
1413 
1414         <span class="keyword">if</span> nargout &gt;= 3 &amp;&amp; isempty(DataTime)
1415             days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
1416             tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
1417             DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
1418         <span class="keyword">end</span>
1419     <span class="keyword">end</span>
1420 
1421     <span class="comment">% Change to physics units if Units = 'physics'</span>
1422     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
1423         <span class="comment">% Change to physics units</span>
1424         AM = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(AO.FamilyName, Field, AM, DeviceList);
1425     <span class="keyword">end</span>
1426 
1427 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'manual'</span>)
1428     <span class="comment">% Always return in hardware units (like connected to the IOC)</span>
1429     <span class="comment">% The conversion to physics in done at the end</span>
1430     t = 0;
1431     <span class="keyword">if</span> strcmp(AO.FamilyName, <span class="string">'TUNE'</span>)
1432         HarmNumber = [];
1433         RF = [];
1434         <span class="keyword">if</span> find(DeviceIndex == 1)
1435             AM(1,1) = input(sprintf(<span class="string">'   Input the horizontal tune (fraction or Hz) = '</span>));
1436             <span class="keyword">if</span> AM(1,1) &gt; 1
1437                 HarmNumber = getharmonicnumber;
1438                 RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>);
1439                 <span class="keyword">if</span> strcmpi(RF.UnitsString,<span class="string">'MHz'</span>)
1440                     FundFreq = 1e6*RF.Data / HarmNumber;
1441                 <span class="keyword">elseif</span> strcmpi(RF.UnitsString,<span class="string">'Hz'</span>)
1442                     FundFreq = RF.Data / HarmNumber;
1443                 <span class="keyword">else</span>
1444                     error(<span class="string">'RF units in not known.'</span>);
1445                 <span class="keyword">end</span>
1446                 <span class="comment">%AM(1,1) = (AM(1,1)- RF) / FundFreq;</span>
1447                 AM(1,1) = AM(1,1) / FundFreq;
1448                 fprintf(<span class="string">'   Horizontal fraction tune computed to be %f\n\n'</span>, AM(1,1));
1449             <span class="keyword">end</span>
1450         <span class="keyword">end</span>
1451         <span class="keyword">if</span> find(DeviceIndex == 2)
1452             AM(2,1) = input(sprintf(<span class="string">'   Input the vertical   tune (fraction or Hz) = '</span>));
1453             <span class="keyword">if</span> AM(2,1) &gt; 1
1454                 <span class="keyword">if</span> isempty(HarmNumber)
1455                     HarmNumber = getharmonicnumber;
1456                 <span class="keyword">end</span>
1457                 <span class="keyword">if</span> isempty(RF)
1458                     RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>);
1459                 <span class="keyword">end</span>
1460                 <span class="keyword">if</span> strcmpi(RF.UnitsString,<span class="string">'MHz'</span>)
1461                     FundFreq = 1e6*RF.Data / HarmNumber;
1462                 <span class="keyword">elseif</span> strcmpi(RF.UnitsString,<span class="string">'Hz'</span>)
1463                     FundFreq = RF.Data / HarmNumber;
1464                 <span class="keyword">else</span>
1465                     error(<span class="string">'RF units in not known.'</span>);
1466                 <span class="keyword">end</span>
1467                 AM(2,1) = AM(2,1)/FundFreq;
1468                 <span class="comment">%AM(2,1) = (AM(2,1) - HarmNumber * FundFreq)/FundFreq;</span>
1469                 fprintf(<span class="string">'   Vertical   fraction tune computed to be %f\n\n'</span>, AM(2,1));
1470             <span class="keyword">end</span>
1471         <span class="keyword">end</span>
1472         <span class="keyword">if</span> find(DeviceIndex == 3)
1473             AM(2,1) = input(<span class="string">'   Input the synchrotron tune = '</span>);
1474         <span class="keyword">end</span>
1475     <span class="keyword">elseif</span> strcmp(AO.FamilyName, <span class="string">'RF'</span>)
1476         <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Hardware'</span>)
1477             AM(1) = input(sprintf(<span class="string">'   Input the RF frequency [%s] = '</span>, AO.(Field).HWUnits));
1478         <span class="keyword">else</span>
1479             AM(1) = input(sprintf(<span class="string">'   Input the RF frequency [%s] = '</span>, AO.(Field).PhysicsUnits));
1480             AM = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(AO.FamilyName, Field, AM, [1 1]);
1481         <span class="keyword">end</span>
1482     <span class="keyword">else</span>
1483         <span class="keyword">for</span> i = 1:length(DeviceIndex)
1484             <span class="keyword">if</span> strcmpi(AO.(Field).Units, <span class="string">'Hardware'</span>)
1485                 AM(i,:) = input(sprintf(<span class="string">'   Manual input:  %s(%d,%d) [%s] = '</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), AO.(Field).HWUnits));
1486             <span class="keyword">else</span>
1487                 AM(i,:) = input(sprintf(<span class="string">'   Manual input:  %s(%d,%d) [%s] = '</span>, AO.FamilyName, AO.DeviceList(DeviceIndex(i),1), AO.DeviceList(DeviceIndex(i),2), AO.(Field).PhysicsUnits));
1488                 AM(i,:) = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(AO.FamilyName, Field, AM(i,:), AO.DeviceList(DeviceIndex(i),:));
1489             <span class="keyword">end</span>
1490         <span class="keyword">end</span>
1491     <span class="keyword">end</span>
1492     
1493     t1 = clock;
1494     tout = etime(t1, t0);
1495     days = datenum(t1(1:3)) - 719529;  <span class="comment">%datenum('1-Jan-1970');</span>
1496     tt = 24*60*60*days + 60*60*t1(4) + 60*t1(5) + t1(6);
1497     DataTime(1:size(AM,1),1) = fix(tt) + rem(tt,1)*1e9*sqrt(-1);
1498 
1499     <span class="comment">% Change to physics units if Units = 'physics'</span>
1500     <span class="keyword">if</span> strcmpi(AO.(Field).Units,<span class="string">'physics'</span>)
1501         <span class="comment">% Change to physics units</span>
1502         AM = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(AO.FamilyName, Field, AM, DeviceList);
1503     <span class="keyword">end</span>
1504 
1505 
1506 <span class="keyword">elseif</span> strcmpi(Mode,<span class="string">'Simulator'</span>) || strcmpi(Mode,<span class="string">'Model'</span>)
1507 
1508     ExtraTimeDelay = etime(clock, t0);
1509     <span class="comment">%[AM, tout, DataTime, ErrorFlag] = getpvmodel(AO, Field, DeviceList, t-ExtraTimeDelay, 'Physics', 'Numeric');</span>
1510     [AM, tout, DataTime, ErrorFlag] = getpvmodel(AO, Field, DeviceList, t-ExtraTimeDelay, AO.(Field).Units, <span class="string">'Numeric'</span>);
1511     tout = tout + ExtraTimeDelay;
1512 
1513 
1514     <span class="keyword">if</span> strcmpi(OutputDataType, <span class="string">'String'</span>)
1515         AM = num2str(AM);
1516     <span class="keyword">end</span>
1517         
1518     <span class="comment">% Change to physics units if Units = 'physics'</span>
1519     <span class="comment">%if strcmpi(AO.(Field).Units,'Hardware')</span>
1520     <span class="comment">%    % Change to physics units</span>
1521     <span class="comment">%    AM = physics2hw(AO.FamilyName, Field, AM, DeviceList, getenergymodel);</span>
1522     <span class="comment">%end</span>
1523 
1524 <span class="keyword">else</span>
1525     error(sprintf(<span class="string">'Unknown mode for family %s.'</span>, AO.FamilyName));
1526 <span class="keyword">end</span>
1527 
1528 
1529</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>