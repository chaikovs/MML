<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of quadcenterfit</title>
  <meta name="keywords" content="quadcenterfit">
  <meta name="description" content="BBASEARCH - Model search method to find a quarupole center">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; quadcenterfit.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>quadcenterfit
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>BBASEARCH - Model search method to find a quarupole center</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [XOffset, YOffset] = quadcenterfit(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">BBASEARCH - Model search method to find a quarupole center

  This function is under development

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>	GETOFFSET - Returns the offset values for a family</li><li><a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>	GETSPOS - Returns the longitudinal position in meters</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>	GETX - Returns the horizontal orbit</li><li><a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>	GETY - Returns the vertical orbit</li><li><a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>	SETORBITBUMP - Local bump program (uses setorbit)</li><li><a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>	SETSP - Makes an absolute setpoint change to the 'Setpoint' field</li><li><a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>	STEPSP - Step the setpoint for family</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [XOffset, YOffset] = quadcenterfit(varargin)</a>
0002 <span class="comment">%BBASEARCH - Model search method to find a quarupole center</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  This function is under development</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  Written by Greg Portmann</span>
0007 
0008 <span class="keyword">global</span> THERING
0009 
0010 BPMxFamily = <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily">gethbpmfamily</a>;
0011 BPMyFamily = <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily">getvbpmfamily</a>;
0012 
0013 <span class="comment">% Planes to fit</span>
0014 XFlag = 1;
0015 YFlag = 1;
0016 
0017 <span class="comment">% Deltas for the gradient</span>
0018 DeltaBump1 = .002;
0019 DeltaBump2 = 10 * DeltaBump1;
0020 
0021 
0022 FileName = <span class="string">''</span>;
0023 <span class="keyword">if</span> nargin &gt;= 1
0024     FileName = varargin{1};
0025 <span class="keyword">end</span>
0026 
0027 <span class="keyword">if</span> isempty(FileName)
0028     <span class="comment">%[FileName, PathName] = uigetfile('*.mat', 'Select a Quadrupole Center File', [getfamilydata('Directory','DataRoot'), 'QMS', filesep]);</span>
0029     [FileName, PathName] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a Quadrupole Center File'</span>);
0030     drawnow;
0031     <span class="keyword">if</span> ~isstr(FileName)
0032         XOffset = [];
0033         YOffset = [];
0034         <span class="keyword">return</span>
0035     <span class="keyword">else</span>
0036         FileName = [PathName,FileName];
0037         load(FileName);
0038     <span class="keyword">end</span>
0039 <span class="keyword">else</span>
0040     load(FileName);
0041 <span class="keyword">end</span>
0042 
0043 
0044 <span class="keyword">if</span> exist(<span class="string">'QMS'</span>,<span class="string">'var'</span>)
0045 
0046     QuadFamily = QMS.QuadFamily;
0047     QuadDev = QMS.QuadDev;
0048     QuadDelta = QMS.QuadDelta;
0049     BPMFamily = QMS.BPMFamily;
0050     BPMDev  = QMS.BPMDev;
0051     Orbit0 = QMS.Orbit0;
0052     iBPM = findrowindex(BPMDev, QMS.Orbit0.DeviceList);
0053     ModulationMethod = QMS.ModulationMethod;
0054 
0055     <span class="keyword">if</span> nargin &gt;= 2
0056         i = varargin{2};
0057     <span class="keyword">else</span>
0058         <span class="comment">% i = 3;</span>
0059         <span class="keyword">for</span> i = 1:size(QMS.x1,2)
0060             <span class="comment">%[XOffset(i), YOffset(i)] = quadcenterfit(FileName, i);</span>
0061             [XOffset(i), YOffset(i)] = feval(mfilename, FileName, i);
0062         <span class="keyword">end</span>
0063         <span class="keyword">return</span>;
0064     <span class="keyword">end</span>
0065 
0066     <span class="keyword">if</span> isfield(QMS, <span class="string">'XOffsetOld'</span>)
0067         x0 = QMS.x0(:,i);
0068         y0 = QMS.y0(:,i);
0069     <span class="keyword">else</span>
0070         <span class="keyword">if</span> strcmpi(lower(ModulationMethod), <span class="string">'bipolar'</span>)
0071             x0 = (QMS.x1(:,i)+QMS.x2(:,i))/2;
0072             y0 = (QMS.y1(:,i)+QMS.y2(:,i))/2;
0073         <span class="keyword">else</span>
0074             x0 = QMS.x1(:,i);
0075             y0 = QMS.y1(:,i);
0076         <span class="keyword">end</span>
0077     <span class="keyword">end</span>
0078     x1 = QMS.x1(:,i);
0079     x2 = QMS.x2(:,i);
0080 
0081     y1 = QMS.y1(:,i);
0082     y2 = QMS.y2(:,i);
0083 
0084     MeasData = [QMS.x2(:,i)-QMS.x1(:,i)  QMS.y2(:,i)-QMS.y1(:,i)];
0085 
0086     fprintf(<span class="string">'   Bow tie method offset %s(%d,%d)= %f (%s)\n'</span>,  QMS.BPMFamily, QMS.BPMDev, QMS.Center, FileName);
0087 
0088     <span class="comment">% Note: this must be the offset when the data was taken</span>
0089     <span class="keyword">if</span> isfield(QMS, <span class="string">'XOffsetOld'</span>)
0090         XOffsetOld = QMS.XOffsetOld; <span class="comment">%QMS.x0(iBPM) - QMS.Xerr; %getoffset(BPMxFamily, BPMDev);</span>
0091         YOffsetOld = QMS.YOffsetOld; <span class="comment">%QMS.y0(iBPM) - QMS.Yerr; %QMS.OldCenter; %getoffset(BPMyFamily, BPMDev);</span>
0092     <span class="keyword">else</span>
0093         XOffsetOld = QMS.x0(iBPM) - QMS.Xerr; <span class="comment">%getoffset(BPMxFamily, BPMDev);</span>
0094         YOffsetOld = QMS.y0(iBPM) - QMS.Yerr; <span class="comment">%QMS.OldCenter; %getoffset(BPMyFamily, BPMDev);</span>
0095     <span class="keyword">end</span>
0096 
0097 <span class="keyword">else</span>
0098     
0099     <span class="comment">%load QF71test1</span>
0100     <span class="comment">%load QF71simxbump</span>
0101     <span class="comment">%load QF71simybump</span>
0102 
0103     <span class="comment">%QuadFamily = 'QF';</span>
0104     <span class="comment">%QuadDev = [7 1];</span>
0105     <span class="comment">%BPMFamily = BPMxFamily;</span>
0106     <span class="comment">%BPMDev  = [7 2];</span>
0107     Orbit0 = y00;
0108     BPMDevTotal = y00.DeviceList;
0109     iBPM = findrowindex(BPMDev, y00.DeviceList);
0110 
0111     i = 3;
0112     <span class="comment">%Yavg = (y2(iBPM,i)+y1(iBPM,i))/2;</span>
0113     MeasData = [x2(:,i)-x1(:,i)  y2(:,i)-y1(:,i)];
0114     x0 = x0(:,i);
0115     y0 = y0(:,i);
0116     x1 = x1(:,i);
0117     y1 = y1(:,i);
0118     x2 = x2(:,i);
0119     y2 = y2(:,i);
0120 
0121     <span class="comment">% Note: this must be the offset when the data was taken</span>
0122     XOffsetOld = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMxFamily, BPMDev);
0123     YOffsetOld = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMyFamily, BPMDev);
0124     
0125 <span class="keyword">end</span>
0126 
0127 <span class="comment">% Model index</span>
0128 ATIndexQuad = family2atindex(QuadFamily, QuadDev);
0129 ATIndexBPM  = family2atindex(BPMxFamily, BPMDev);
0130 s = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(Orbit0);
0131 
0132 
0133 <span class="comment">% Reset the model</span>
0134 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(<span class="string">'HCM'</span>, 0, <span class="string">'Physics'</span>, <span class="string">'Model'</span>);
0135 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(<span class="string">'VCM'</span>, 0, <span class="string">'Physics'</span>, <span class="string">'Model'</span>);
0136 setshift(ATIndexQuad, 0, 0);
0137 PolynomA = THERING{ATIndexQuad}.PolynomA;
0138 PolynomB = THERING{ATIndexQuad}.PolynomB;
0139 K = THERING{ATIndexQuad}.K;
0140 THERING{ATIndexQuad}.PolynomA(1) = 0;
0141 THERING{ATIndexQuad}.PolynomB(1) = 0;
0142 
0143 
0144 <span class="comment">% Add any known orbit change to the model</span>
0145 <span class="keyword">if</span> exist(<span class="string">'QMS'</span>,<span class="string">'var'</span>)
0146     <span class="keyword">if</span> strcmpi(lower(ModulationMethod), <span class="string">'sweep'</span>)
0147         <span class="comment">% One directional sweep of the quadrupole</span>
0148         <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(QuadFamily, QuadDelta * (i-1), QuadDev, 0, <span class="string">'Model'</span>);
0149     <span class="keyword">end</span>
0150 
0151 
0152     <span class="comment">% 1-magnet &quot;bump&quot;</span>
0153     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(QMS.CorrFamily, -QMS.CorrDelta, QMS.CorrDevList, 0, <span class="string">'Model'</span>);
0154 
0155     <span class="comment">% Corrector step size</span>
0156     N = abs(round(QMS.NumberOfPoints));
0157     CorrStep = 2 * QMS.CorrDelta / (N-1);
0158     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(QMS.CorrFamily, CorrStep*(i-1), QMS.CorrDevList, 0, <span class="string">'Model'</span>);
0159 
0160     <span class="comment">% Starting Quadrupole displacement</span>
0161     XBump = 0; <span class="comment">%x0(iBPM) - XOffsetOld;</span>
0162     YBump = 0; <span class="comment">%y0(iBPM) - YOffsetOld;</span>
0163 
0164 <span class="keyword">else</span>
0165 
0166     <span class="keyword">if</span> i &gt; 1
0167         <span class="comment">% Local bump</span>
0168         <span class="comment">%[OCS, RF, OCS0] = setorbitbump(BPMxFamily, [7 2], .5*(i-1), 'HCM', [-2 -1 1 2], 4, 'Model', 'NoDisplay');</span>
0169         [OCS, RF, OCS0] = <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>(BPMyFamily, [7 2], .5*(i-1), <span class="string">'VCM'</span>, [-2 -1 1 2], 4, <span class="string">'Model'</span>, <span class="string">'NoDisplay'</span>);
0170 
0171         <span class="comment">% Starting Quadrupole displacement</span>
0172         XBump = 0; <span class="comment">%x0(iBPM) - XOffsetOld;</span>
0173         YBump = 0; <span class="comment">%y0(iBPM) - YOffsetOld;</span>
0174     <span class="keyword">else</span>
0175         <span class="comment">% Starting Quadrupole displacement</span>
0176         XBump = x0(iBPM) - XOffsetOld;
0177         YBump = y0(iBPM) - YOffsetOld;
0178     <span class="keyword">end</span>
0179 <span class="keyword">end</span>
0180 
0181 <span class="comment">% Starting model orbit</span>
0182 XStart = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(BPMDev, <span class="string">'Model'</span>)-<a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMxFamily,BPMDev);
0183 YStart = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(BPMDev, <span class="string">'Model'</span>)-<a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(BPMyFamily,BPMDev);
0184 
0185 fprintf(<span class="string">'       XOffsetOld = %7.4f   YOffsetOld = %7.4f\n'</span>, XOffsetOld, YOffsetOld);
0186 
0187 j = 0;
0188 XBumpOld = Inf;
0189 YBumpOld = Inf;
0190 XQuadShift = 0;
0191 YQuadShift = 0;
0192 <span class="keyword">while</span> (XFlag==1 &amp; abs(XBump-XBumpOld)&gt;.0005) | (YFlag==1 &amp; abs(YBump-YBumpOld)&gt;.0005)
0193     j = j + 1;
0194     
0195     <span class="keyword">if</span> XFlag
0196         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0197         XQuadShift = -DeltaBump2/2 - DeltaBump1/2 + XBump;
0198         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0199         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0200         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0201         [MeritXa, MeritYa] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0202         xa = XQuadShift;
0203 
0204         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0205         XQuadShift = -DeltaBump2/2 + DeltaBump1/2 + XBump;
0206         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0207         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0208         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0209         [MeritXb, MeritYb] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0210         xb = XQuadShift;
0211 
0212 
0213         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0214         XQuadShift = DeltaBump2/2 - DeltaBump1/2 + XBump;
0215         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0216         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0217         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0218         [MeritXc, MeritYc, xm1, xm2, ym1, ym2] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0219         xc = XQuadShift;
0220 
0221         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0222         XQuadShift = DeltaBump2/2  + DeltaBump1/2 + XBump;
0223         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0224         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0225         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0226         [MeritXd, MeritYd] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0227         xd = XQuadShift;
0228 
0229         m1 = (MeritXb - MeritXa) / (xb-xa);
0230         m2 = (MeritXd - MeritXc) / (xd-xc);
0231         DelSlope = (m2-m1) / ((xc+xd)/2 - (xa+xb)/2);
0232 
0233         XBumpOld = XBump;
0234         XBump = XBump - (m1+m2)/2 / DelSlope;
0235     <span class="keyword">end</span>
0236 
0237     <span class="keyword">if</span> YFlag
0238         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0239         YQuadShift = -DeltaBump2/2 - DeltaBump1/2 + YBump;
0240         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0241         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0242         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0243         [MeritXa, MeritYa] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0244         ya = YQuadShift;
0245 
0246         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0247         YQuadShift = -DeltaBump2/2 + DeltaBump1/2 + YBump;
0248         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0249         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0250         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0251         [MeritXb, MeritYb] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0252         yb = YQuadShift;
0253 
0254 
0255         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0256         YQuadShift = DeltaBump2/2 - DeltaBump1/2 + YBump;
0257         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0258         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0259         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0260         [MeritXc, MeritYc, xm1, xm2, ym1, ym2] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0261         yc = YQuadShift;
0262 
0263         <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0264         YQuadShift = DeltaBump2/2 + DeltaBump1/2 + YBump;
0265         setshift(ATIndexQuad, -XQuadShift/1000, -YQuadShift/1000);
0266         THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0267         THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0268         [MeritXd, MeritYd] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0269         yd = YQuadShift;
0270 
0271         m1 = (MeritYb - MeritYa) / (yb-ya);
0272         m2 = (MeritYd - MeritYc) / (yd-yc);
0273         DelSlope = (m2-m1) / ((yc+yd)/2 - (ya+yb)/2);
0274 
0275         YBumpOld = YBump;
0276         YBump = YBump - (m1+m2)/2 / DelSlope;
0277     <span class="keyword">end</span>
0278 
0279 
0280     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0281     <span class="comment">% Get the merit function at the predicted minimum %</span>
0282     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0283 
0284     <span class="comment">% Shift the quadrupole without changing the orbit (-shift is up)</span>
0285     XQuadShift = XBump;
0286     YQuadShift = YBump;
0287     setshift(ATIndexQuad,  -XQuadShift/1000, -YQuadShift/1000);
0288     THERING{ATIndexQuad}.PolynomB(1) = THERING{ATIndexQuad}.PolynomB(2) * (-XQuadShift/1000);
0289     THERING{ATIndexQuad}.PolynomA(1) = THERING{ATIndexQuad}.PolynomB(2) * (-YQuadShift/1000);
0290     [MeritX, MeritY, xm1, xm2, ym1, ym2] = <a href="#_sub1" class="code" title="subfunction [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)">bbaquadchangemodel</a>(QuadFamily, QuadDelta, QuadDev, MeasData, ModulationMethod);
0291 
0292     Merit(:,j) = [MeritX; MeritY];
0293     Bumps(:,j) = [XBump; YBump];
0294 
0295 
0296     <span class="keyword">if</span> XFlag
0297         XOffset = XBump + XStart - (x0(iBPM)-XOffsetOld) + XOffsetOld;
0298     <span class="keyword">else</span>
0299         XOffset = XOffsetOld;
0300     <span class="keyword">end</span>
0301     <span class="keyword">if</span> YFlag
0302         YOffset = YBump + YStart - (y0(iBPM)-YOffsetOld) + YOffsetOld;
0303     <span class="keyword">else</span>
0304         YOffset = YOffsetOld;
0305     <span class="keyword">end</span>
0306 
0307     fprintf(<span class="string">'   %d.  XOffsetNew = %7.4f   YOffsetNew = %7.4f   XMerit = %.5g   YMerit = %.5g\n'</span>, j, XOffset, YOffset, Merit(1,j), Merit(2,j));
0308 
0309 <span class="keyword">end</span>
0310 fprintf(<span class="string">'        New - Old = %7.4f    New - Old = %7.4f\n'</span>, XOffset-XOffsetOld, YOffset-YOffsetOld);
0311 
0312 
0313 
0314 <span class="comment">% Reset the model</span>
0315 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(<span class="string">'HCM'</span>, 0, <span class="string">'Physics'</span>, <span class="string">'Model'</span>);
0316 <a href="setsp.html" class="code" title="function ErrorFlag = setsp(Family, varargin)">setsp</a>(<span class="string">'VCM'</span>, 0, <span class="string">'Physics'</span>, <span class="string">'Model'</span>);
0317 setshift(ATIndexQuad, 0, 0);
0318 THERING{ATIndexQuad}.PolynomA = PolynomA;
0319 THERING{ATIndexQuad}.PolynomB = PolynomB;
0320 THERING{ATIndexQuad}.K = K;
0321 <span class="comment">%THERING{ATIndexQuad}.PolynomA(1) = 0;</span>
0322 <span class="comment">%THERING{ATIndexQuad}.PolynomB(1) = 0;</span>
0323 
0324 
0325 <span class="comment">% Find the average orbit change at the quadrupole</span>
0326 [xAT,yAT] = modeltwiss(<span class="string">'x'</span>,<span class="string">'All'</span>,<span class="string">'All'</span>);
0327 yQF = 1000*(yAT(ATIndexQuad)+yAT(ATIndexQuad+1))/2;
0328 
0329 [mux,muy] = modeltwiss(<span class="string">'Phase'</span>,<span class="string">'All'</span>,<span class="string">'All'</span>);
0330 BPM2QuadPhase = 180*( (muy(ATIndexQuad)+muy(ATIndexQuad+1))/2 - muy(ATIndexBPM)) /pi;  <span class="comment">% phase in degrees</span>
0331 fprintf(<span class="string">'   BPM2QuadPhase=%.3f [degrees]\n\n'</span>, BPM2QuadPhase);
0332 
0333 
0334 <span class="comment">% figure(1);</span>
0335 <span class="comment">% clf reset</span>
0336 <span class="comment">% %plot(s, y2-y1, '.-');</span>
0337 <span class="comment">% plot(s, y2-y1, '.-');</span>
0338 <span class="comment">% hold on;</span>
0339 
0340 <span class="comment">%fprintf('   YBump    = %f\n', YBump);</span>
0341 <span class="comment">%fprintf('   Yoffset = %f\n', Yoffset);</span>
0342 <span class="comment">%fprintf('   Y0      = %f\n', y0.Data(iBPM));</span>
0343 
0344 
0345 
0346 
0347 <a name="_sub1" href="#_subfunctions" class="code">function [Meritx, Merity, x1, x2, y1, y2] = bbaquadchangemodel(Family, Delta, DeviceList, MeasData, ModulationMethod)</a>
0348 
0349 
0350 
0351 <span class="keyword">if</span> strcmpi(lower(ModulationMethod), <span class="string">'sweep'</span>)
0352     <span class="comment">% One directional sweep of the quadrupole</span>
0353     x1 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0354     y1 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0355     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, Delta, DeviceList, 0, <span class="string">'Model'</span>);
0356     x2 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0357     y2 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0358     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family,-Delta, DeviceList, 0, <span class="string">'Model'</span>);
0359 <span class="keyword">elseif</span> strcmpi(lower(ModulationMethod), <span class="string">'bipolar'</span>)
0360     <span class="comment">% Modulate the quadrupole</span>
0361     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, Delta, DeviceList, 0, <span class="string">'Model'</span>);
0362     x1 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0363     y1 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0364     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, -2*Delta, DeviceList, 0, <span class="string">'Model'</span>);
0365     x2 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0366     y2 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0367     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, Delta, DeviceList, 0, <span class="string">'Model'</span>);
0368 <span class="keyword">elseif</span> strcmpi(lower(ModulationMethod), <span class="string">'unipolar'</span>)
0369     <span class="comment">% Modulate the quadrupole</span>
0370     x1 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0371     y1 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0372     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, Delta, DeviceList, 0, <span class="string">'Model'</span>);
0373     x2 = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Model'</span>);
0374     y2 = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Model'</span>);
0375     <a href="stepsp.html" class="code" title="function ErrorFlag = stepsp(Family, varargin)">stepsp</a>(Family, -Delta, DeviceList, 0, <span class="string">'Model'</span>);
0376 <span class="keyword">end</span>
0377 
0378 
0379 Meritx = sum((MeasData(:,1) - (x2-x1)).^2);
0380 Merity = sum((MeasData(:,2) - (y2-y1)).^2);
0381 
0382 
0383</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:29:18 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>