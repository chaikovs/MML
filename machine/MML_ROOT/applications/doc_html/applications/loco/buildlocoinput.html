<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of buildlocoinput</title>
  <meta name="keywords" content="buildlocoinput">
  <meta name="description" content="BUILDLOCOINPUT - Matlab Middlelayer (MML) method for building a LOCO input file.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">applications</a> &gt; <a href="index.html">loco</a> &gt; buildlocoinput.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for applications/loco&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>buildlocoinput
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>BUILDLOCOINPUT - Matlab Middlelayer (MML) method for building a LOCO input file.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [LocoMeasData, BPMData, CMData, RINGData, FitParameters, LocoFlags] = buildlocoinput(OutputFileName) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">BUILDLOCOINPUT - Matlab Middlelayer (MML) method for building a LOCO input file.
                 Combines response matrix, BPM standard deviation, and 
                 dispersion files (or measurements) into a LOCO input file.
                 The fit parameters are added if a buildlocofitparameters file is on the path.

  [LocoMeasData, BPMData, CMData, RINGData, FitParameters, LocoFlags] = buildlocoinput(OutputFileName)

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="locofilecheck.html" class="code" title="function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)">locofilecheck</a>	LOCOFILECHECK - Consistence check for the LOCO input file</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [LocoMeasData, BPMData, CMData, RINGData, FitParameters, LocoFlags] = buildlocoinput(OutputFileName)</a>
0002 <span class="comment">%BUILDLOCOINPUT - Matlab Middlelayer (MML) method for building a LOCO input file.</span>
0003 <span class="comment">%                 Combines response matrix, BPM standard deviation, and</span>
0004 <span class="comment">%                 dispersion files (or measurements) into a LOCO input file.</span>
0005 <span class="comment">%                 The fit parameters are added if a buildlocofitparameters file is on the path.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  [LocoMeasData, BPMData, CMData, RINGData, FitParameters, LocoFlags] = buildlocoinput(OutputFileName)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  Written by Greg Portmann</span>
0010 
0011 
0012 <span class="comment">% % In order to iterate loco uses arrays of structures all the fields in the structure must be present</span>
0013 <span class="comment">% LocoFlags = struct('SVmethod',[], 'Dispersion',[], 'Coupling',[], 'Normalize',[], 'Linear',[], 'SVDDataFileName',[]);</span>
0014 <span class="comment">% LocoModel = struct('M',[], 'OutlierIndex',[], 'Eta',[], 'EtaOutlierIndex',[], 'SValues',[], 'SValuesIndex',[], 'ChiSquare',[]);</span>
0015 <span class="comment">% BPMData = struct('FamName',[], 'BPMIndex',[], 'HBPMIndex',[], 'VBPMIndex',[], 'HBPMGoodDataIndex',[], 'VBPMGoodDataIndex',[], 'HBPMGain',[], 'VBPMGain',[], 'HBPMCoupling',[], 'VBPMCoupling',[], 'HBPMGainSTD',[], 'VBPMGainSTD',[],'HBPMCouplingSTD',[],'VBPMCouplingSTD',[],'FitGains',[],'FitCoupling',[]);</span>
0016 <span class="comment">% CMData = struct('FamName',[], 'HCMIndex',[], 'VCMIndex',[], 'HCMGoodDataIndex',[], 'VCMGoodDataIndex',[], 'HCMKicks',[], 'VCMKicks',[], 'HCMCoupling',[], 'VCMCoupling',[], 'HCMKicksSTD',[], 'VCMKicksSTD',[],'HCMCouplingSTD',[],'VCMCouplingSTD',[],'FitKicks',[],'FitCoupling',[]);</span>
0017 <span class="comment">% FitParameters = struct('Params',[], 'Values',[], 'ValuesSTD',[], 'Deltas',[], 'DeltaRF',[], 'FitRFFrequency',[], 'DeltaRFSTD',[]);</span>
0018 
0019 FitParameters = [];
0020 
0021 
0022 <span class="comment">% Family Setup</span>
0023 BPMxFamily = gethbpmfamily;
0024 BPMyFamily = getvbpmfamily;
0025 
0026 HCMFamily = gethcmfamily; 
0027 VCMFamily = getvcmfamily; 
0028 
0029 
0030 <span class="comment">% Should probably get these from the response matrix???</span>
0031 <span class="keyword">if</span> isempty(BPMxFamily)
0032     BPMxFamily = <span class="string">'BPMx'</span>;   
0033 <span class="keyword">end</span>
0034 <span class="keyword">if</span> isempty(BPMyFamily)
0035     BPMyFamily = <span class="string">'BPMy'</span>;   
0036 <span class="keyword">end</span>
0037 <span class="keyword">if</span> isempty(HCMFamily)
0038     HCMFamily = <span class="string">'HCM'</span>;   
0039 <span class="keyword">end</span>
0040 <span class="keyword">if</span> isempty(VCMFamily)
0041     VCMFamily = <span class="string">'VCM'</span>;   
0042 <span class="keyword">end</span>
0043 
0044 
0045 <span class="comment">% BPMs to remove</span>
0046 RemoveBPMDeviceList = [];
0047 RemoveHCMDeviceList = [];
0048 RemoveVCMDeviceList = [];
0049 
0050 
0051 <span class="keyword">if</span> nargin == 0
0052     [OutputFileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'New LOCO Input File Name?'</span>);
0053     <span class="keyword">if</span> OutputFileName == 0
0054         <span class="keyword">return</span>
0055     <span class="keyword">end</span>
0056     OutputFileName = [DirectoryName OutputFileName];
0057 <span class="keyword">end</span>
0058 
0059 DirStart = [getfamilydata(<span class="string">'Directory'</span>, <span class="string">'DataRoot'</span>), <span class="string">'LOCO'</span>, filesep];
0060 
0061 
0062 <span class="comment">% To start with nominal gains (1) and coupling (0)</span>
0063 <span class="comment">%ButtonName = questdlg('Gains and Coupling?','LOCO STARTING POINT','Use Present Setting','Nominal Gain=1, Coupling=0','Use Present Setting');</span>
0064 <span class="comment">%switch ButtonName,</span>
0065 <span class="comment">%    case 'Nominal Gain=1, Coupling=0'</span>
0066         setlocodata(<span class="string">'Nominal'</span>);
0067         fprintf(<span class="string">'   May need to run setoperationmode (or aoinit) to restore the proper gains &amp; rolls.\n'</span>);
0068 <span class="comment">%end</span>
0069 
0070 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0071 <span class="comment">% 1. Build the AT MODEL %</span>
0072 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0073 LocoModel = [];
0074 
0075 <span class="comment">% Save THERING and restore on exit so that this function does not change the model</span>
0076 <span class="keyword">global</span> THERING
0077 THERINGsave = THERING;
0078 
0079 AO_ATModel = getfamilydata(<span class="string">'ATModel'</span>);
0080 [DirectoryName, ATModel, Ext] = fileparts(which(AO_ATModel));
0081 [ATModel, DirectoryName] = uigetfile(<span class="string">'*.*'</span>, <span class="string">'AT Model (Cancel to use the present model)?'</span>, [DirectoryName, filesep, ATModel, Ext]);
0082 <span class="keyword">if</span> ATModel == 0
0083     <span class="keyword">if</span> isempty(THERING)
0084         fprintf(<span class="string">'   No AT model found.  Buildlocoinput canceled.\n'</span>);
0085         <span class="keyword">return</span>;
0086     <span class="keyword">end</span>
0087 <span class="keyword">else</span>
0088     run([DirectoryName, ATModel]);
0089     <span class="comment">%updateatindex; % Purpose ?</span>
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">% Cavity and radiation should be off for response and dispersion generation</span>
0093 setcavity off;
0094 setradiation off;
0095 
0096 <span class="comment">% Set the model energy</span>
0097 setenergymodel(getfamilydata(<span class="string">'Energy'</span>));
0098 
0099 RINGData.Lattice = THERING;
0100 RINGData.CavityFrequency  = getrf(<span class="string">'Model'</span>, <span class="string">'Physics'</span>);
0101 RINGData.CavityHarmNumber = getharmonicnumber; 
0102 
0103 
0104 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0105 <span class="comment">% 2. MEASURED DATA STRUCTURE                %</span>
0106 <span class="comment">% LocoMeasData.M          [mm]              %</span>
0107 <span class="comment">% LocoMeasData.BPMSTD     [mm]              %</span>
0108 <span class="comment">% LocoMeasData.DeltaAmps  [Amps] (Optional) %</span>
0109 <span class="comment">% LocoMeasData.Eta        [mm]              %</span>
0110 <span class="comment">% LocoMeasData.RF         [Hz]              %</span>
0111 <span class="comment">% LocoMeasData.DeltaRF    [Hz]              %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 
0114 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0115 <span class="comment">% BPM Response Matrix %</span>
0116 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0117 <span class="comment">% Rmat(BPM,COR)</span>
0118 <span class="comment">% Rmat(1,1).Data=xx;  %Kick x, look x</span>
0119 <span class="comment">% Rmat(2,1).Data=yx;  %Kick x, look y</span>
0120 <span class="comment">% Rmat(1,2).Data=xy;  %Kick y, look x</span>
0121 <span class="comment">% Rmat(2,2).Data=yy;  %Kick y, look y</span>
0122 
0123 ButtonName = questdlg(<span class="string">'LOCO response matrix?'</span>,<span class="string">'RESPONSE MATRIX'</span>,<span class="string">'Use Default'</span>,<span class="string">'Measure'</span>,<span class="string">'Get From File'</span>,<span class="string">'Get From File'</span>);
0124 drawnow;
0125 <span class="keyword">switch</span> ButtonName,
0126     <span class="keyword">case</span> <span class="string">'Get From File'</span>
0127         [BPMRespFile, BPMRespDirectory] = uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Select a BPM Response Matrix File'</span>, DirStart);
0128         <span class="keyword">if</span> BPMRespFile == 0
0129             fprintf(<span class="string">'   buildlocoinput canceled.\n'</span>);
0130             <span class="keyword">return</span>
0131         <span class="keyword">end</span>
0132         DirStart = BPMRespDirectory;
0133 
0134         <span class="comment">% Variable MachineConfig is the lattice at the time when the response matrix was generated</span>
0135         <span class="keyword">try</span>
0136             load([BPMRespDirectory BPMRespFile], <span class="string">'MachineConfig'</span>);
0137         <span class="keyword">catch</span>
0138             fprintf(<span class="string">'   Lattice configuration not found in the response matrix file.  You don''t need it but it''s nice to have.\n'</span>);
0139         <span class="keyword">end</span>
0140         
0141         Rmat(1,1) = getrespmat(BPMxFamily, [], HCMFamily, [], [BPMRespDirectory BPMRespFile], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0142         Rmat(1,2) = getrespmat(BPMxFamily, [], VCMFamily, [], [BPMRespDirectory BPMRespFile], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0143         Rmat(2,1) = getrespmat(BPMyFamily, [], HCMFamily, [], [BPMRespDirectory BPMRespFile], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0144         Rmat(2,2) = getrespmat(BPMyFamily, [], VCMFamily, [], [BPMRespDirectory BPMRespFile], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0145         
0146     <span class="keyword">case</span> <span class="string">'Use Default'</span>
0147         Rmat(1,1) = getrespmat(BPMxFamily, [], HCMFamily, [], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0148         Rmat(1,2) = getrespmat(BPMxFamily, [], VCMFamily, [], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0149         Rmat(2,1) = getrespmat(BPMyFamily, [], HCMFamily, [], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0150         [Rmat(2,2), FileName] = getrespmat(BPMyFamily, [], VCMFamily, [], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0151         
0152         <span class="comment">% Variable MachineConfig is the lattice at the time when the response matrix was generated</span>
0153         load(FileName,<span class="string">'MachineConfig'</span>);
0154         
0155     <span class="keyword">case</span> <span class="string">'Measure'</span>
0156         Rmat = measbpmresp(<span class="string">'Struct'</span>, <span class="string">'Hardware'</span>);
0157 
0158         <span class="comment">% Variable MachineConfig is the lattice at the time when the response matrix was generated</span>
0159         MachineConfig = getmachineconfig;
0160         
0161     <span class="keyword">otherwise</span>
0162         fprintf(<span class="string">'   LOCO build canceled.\n'</span>);
0163         <span class="keyword">return</span>
0164 <span class="keyword">end</span>
0165 
0166 <span class="keyword">if</span> exist(<span class="string">'MachineConfig'</span>,<span class="string">'var'</span>)
0167     LocoMeasData.MachineConfig = MachineConfig;  <span class="comment">% Extra (not needed by LOCO but it's often nice to have it)</span>
0168 <span class="keyword">end</span>
0169 
0170 
0171 <span class="comment">% BPM remove list</span>
0172 i = findrowindex(RemoveBPMDeviceList, Rmat(1,1).Monitor.DeviceList);
0173 Rmat(1,1).Data(i,:) = [];
0174 Rmat(1,1).Monitor1(i,:) = [];
0175 Rmat(1,1).Monitor2(i,:) = [];
0176 Rmat(1,1).Monitor.DeviceList(i,:) = [];
0177 Rmat(1,1).Monitor.Data(i,:) = [];
0178 Rmat(1,1).Monitor.Status(i,:) = [];
0179 
0180 i = findrowindex(RemoveBPMDeviceList, Rmat(1,2).Monitor.DeviceList);
0181 Rmat(1,2).Data(i,:) = [];
0182 Rmat(1,2).Monitor1(i,:) = [];
0183 Rmat(1,2).Monitor2(i,:) = [];
0184 Rmat(1,2).Monitor.DeviceList(i,:) = [];
0185 Rmat(1,2).Monitor.Data(i,:) = [];
0186 Rmat(1,2).Monitor.Status(i,:) = [];
0187 
0188 i = findrowindex(RemoveBPMDeviceList, Rmat(2,1).Monitor.DeviceList);
0189 Rmat(2,1).Data(i,:) = [];
0190 Rmat(2,1).Monitor1(i,:) = [];
0191 Rmat(2,1).Monitor2(i,:) = [];
0192 Rmat(2,1).Monitor.DeviceList(i,:) = [];
0193 Rmat(2,1).Monitor.Data(i,:) = [];
0194 Rmat(2,1).Monitor.Status(i,:) = [];
0195 
0196 i = findrowindex(RemoveBPMDeviceList, Rmat(2,2).Monitor.DeviceList);
0197 Rmat(2,2).Data(i,:) = [];
0198 Rmat(2,2).Monitor1(i,:) = [];
0199 Rmat(2,2).Monitor2(i,:) = [];
0200 Rmat(2,2).Monitor.DeviceList(i,:) = [];
0201 Rmat(2,2).Monitor.Data(i,:) = [];
0202 Rmat(2,2).Monitor.Status(i,:) = [];
0203 
0204 
0205 <span class="comment">% CM remove list</span>
0206 i = findrowindex(RemoveHCMDeviceList, Rmat(1,1).Actuator.DeviceList);
0207 Rmat(1,1).Data(:,i) = [];
0208 Rmat(1,1).ActuatorDelta(i,:) = [];
0209 Rmat(1,1).Actuator.DeviceList(i,:) = [];
0210 Rmat(1,1).Actuator.Data(i,:) = [];
0211 Rmat(1,1).Actuator.Status(i,:) = [];
0212 
0213 i = findrowindex(RemoveVCMDeviceList, Rmat(1,2).Actuator.DeviceList);
0214 Rmat(1,2).Data(:,i) = [];
0215 Rmat(1,2).ActuatorDelta(i,:) = [];
0216 Rmat(1,2).Actuator.DeviceList(i,:) = [];
0217 Rmat(1,2).Actuator.Data(i,:) = [];
0218 Rmat(1,2).Actuator.Status(i,:) = [];
0219 
0220 i = findrowindex(RemoveHCMDeviceList, Rmat(2,1).Actuator.DeviceList);
0221 Rmat(2,1).Data(:,i) = [];
0222 Rmat(2,1).ActuatorDelta(i,:) = [];
0223 Rmat(2,1).Actuator.DeviceList(i,:) = [];
0224 Rmat(2,1).Actuator.Data(i,:) = [];
0225 Rmat(2,1).Actuator.Status(i,:) = [];
0226 
0227 i = findrowindex(RemoveVCMDeviceList, Rmat(2,2).Actuator.DeviceList);
0228 Rmat(2,2).Data(:,i) = [];
0229 Rmat(2,2).ActuatorDelta(i,:) = [];
0230 Rmat(2,2).Actuator.DeviceList(i,:) = [];
0231 Rmat(2,2).Actuator.Data(i,:) = [];
0232 Rmat(2,2).Actuator.Status(i,:) = [];
0233 
0234 
0235 <span class="comment">% LOCO uses mm, not mm/amp</span>
0236 R11 = (ones(size(Rmat(1,1).Data,1),1) * Rmat(1,1).ActuatorDelta(:)') .* Rmat(1,1).Data;
0237 R12 = (ones(size(Rmat(1,2).Data,1),1) * Rmat(1,2).ActuatorDelta(:)') .* Rmat(1,2).Data;
0238 R21 = (ones(size(Rmat(2,1).Data,1),1) * Rmat(2,1).ActuatorDelta(:)') .* Rmat(2,1).Data;
0239 R22 = (ones(size(Rmat(2,2).Data,1),1) * Rmat(2,2).ActuatorDelta(:)') .* Rmat(2,2).Data;
0240 
0241 
0242 <span class="comment">% Add energy to the RINGData (not needed for LOCO)</span>
0243 RINGData.Energy = Rmat(1,1).GeV;
0244 
0245 <span class="comment">% Build non-structure response matrix</span>
0246 LocoMeasData.M = [R11 R12; R21 R22];   <span class="comment">% [mm]</span>
0247 LocoMeasData.DeltaAmps = [Rmat(1,1).ActuatorDelta(:); Rmat(2,2).ActuatorDelta(:)];
0248 
0249 <span class="comment">% Extra variables to add to the measured structure</span>
0250 LocoMeasData.HBPM = Rmat(1,1).Monitor;
0251 LocoMeasData.VBPM = Rmat(2,2).Monitor;
0252 LocoMeasData.HCM  = Rmat(1,1).Actuator;
0253 LocoMeasData.VCM  = Rmat(2,2).Actuator;
0254 
0255 <span class="comment">% Needed for computing the new gain</span>
0256 LocoMeasData.HCMGain = getgain(HCMFamily, Rmat(1,1).Actuator.DeviceList);
0257 LocoMeasData.VCMGain = getgain(VCMFamily, Rmat(2,2).Actuator.DeviceList);
0258 LocoMeasData.HCMRoll = getroll(HCMFamily, Rmat(1,1).Actuator.DeviceList);
0259 LocoMeasData.VCMRoll = getroll(VCMFamily, Rmat(2,2).Actuator.DeviceList);
0260 
0261 
0262 <span class="keyword">if</span> ~exist(<span class="string">'RINGData'</span>,<span class="string">'var'</span>)
0263     <span class="comment">% Kick strength in milliradian</span>
0264     HCMKicks = 1000 * hw2physics(HCMFamily, <span class="string">'Setpoint'</span>, Rmat(1,1).ActuatorDelta, Rmat(1,1).Actuator.DeviceList);  
0265     VCMKicks = 1000 * hw2physics(VCMFamily, <span class="string">'Setpoint'</span>, Rmat(2,2).ActuatorDelta, Rmat(2,2).Actuator.DeviceList);
0266     fprintf(<span class="string">'   Note: Without an AT model BPMData and CMData variables cannot be determined.\n'</span>);
0267     fprintf(<span class="string">'         Variables HCMKicks and VCMKicks will be saved to the data file.\n'</span>);
0268     save(OutputFileName, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoModel'</span>, <span class="string">'HCMKicks'</span>, <span class="string">'VCMKicks'</span>);
0269     <span class="keyword">return</span>
0270 <span class="keyword">end</span>
0271 
0272 
0273 
0274 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0275 <span class="comment">% GET DISPERSION INFO %</span>
0276 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0277 ButtonName = questdlg({<span class="string">'LOCO Dispersion &amp; RF Frequency?'</span>,<span class="string">'(Close dialog box to not include dispersion)'</span>},<span class="string">'DISPERSION'</span>,<span class="string">'Use Default'</span>,<span class="string">'Measure'</span>,<span class="string">'Get From File'</span>,<span class="string">'Get From File'</span>);
0278 drawnow;
0279 <span class="keyword">switch</span> ButtonName
0280     <span class="keyword">case</span> <span class="string">'Use Default'</span>
0281         DISPx = getdisp(BPMxFamily, Rmat(1,1).Monitor.DeviceList, <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>);
0282         DISPy = getdisp(BPMyFamily, Rmat(2,2).Monitor.DeviceList, <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>);
0283         RF = DISPx.Actuator.Data;
0284         DeltaRF = DISPx.ActuatorDelta;
0285         DISPx = DeltaRF * DISPx.Data;
0286         DISPy = DeltaRF * DISPy.Data;
0287 
0288     <span class="keyword">case</span> <span class="string">'Get From File'</span>
0289         [DISPFile, DISPDirectory] = uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Select a Dispersion File'</span>, DirStart);
0290         <span class="keyword">if</span> DISPFile == 0
0291             fprintf(<span class="string">'   buildlocoinput canceled.\n'</span>);
0292             <span class="keyword">return</span>
0293         <span class="keyword">end</span>
0294         DirStart = DISPDirectory;
0295 
0296         DISPx = getrespmat(BPMxFamily, Rmat(1,1).Monitor.DeviceList, <span class="string">'RF'</span>, [], [DISPDirectory DISPFile], <span class="string">'Struct'</span>, <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0297         RF = DISPx.Actuator.Data;
0298         DeltaRF = DISPx.ActuatorDelta;
0299         DISPx = DeltaRF * DISPx.Data;
0300         DISPy = DeltaRF * getrespmat(BPMyFamily, Rmat(2,2).Monitor.DeviceList, <span class="string">'RF'</span>, [], [DISPDirectory DISPFile], <span class="string">'Hardware'</span>, <span class="string">'NoEnergyScaling'</span>);
0301         
0302     <span class="keyword">case</span> <span class="string">'Measure'</span>
0303         [Dx, Dy] = measdisp(BPMxFamily, Rmat(1,1).Monitor.DeviceList, BPMyFamily, Rmat(2,2).Monitor.DeviceList, <span class="string">'Struct'</span>, <span class="string">'Archive'</span>, <span class="string">'Hardware'</span>);
0304         RF = Dx.Actuator.Data;
0305         DeltaRF = Dx.ActuatorDelta;
0306         DISPx = DeltaRF * Dx.Data;
0307         DISPy = DeltaRF * Dy.Data;
0308     <span class="keyword">case</span> <span class="string">''</span>
0309         fprintf(<span class="string">'   Dispersion will not be included in the LOCO file.\n'</span>);
0310 <span class="keyword">end</span>
0311 
0312 <span class="keyword">if</span> isempty(ButtonName)
0313     LocoMeasData.RF      = [];
0314     LocoMeasData.DeltaRF = [];
0315     LocoMeasData.Eta = [];
0316 <span class="keyword">else</span>
0317     <span class="comment">%LocoMeasData.RF      = 1e6 * RF;             % [Hz]</span>
0318     <span class="comment">%LocoMeasData.DeltaRF = 1e6 * DeltaRF;        % [Hz]</span>
0319     LocoMeasData.RF      = hw2physics(<span class="string">'RF'</span>, <span class="string">'Setpoint'</span>, RF);        <span class="comment">% [Hz]</span>
0320     LocoMeasData.DeltaRF = hw2physics(<span class="string">'RF'</span>, <span class="string">'Setpoint'</span>, DeltaRF);   <span class="comment">% [Hz]</span>
0321     LocoMeasData.DeltaRF = LocoMeasData.DeltaRF(1);
0322     LocoMeasData.Eta = [DISPx(:); DISPy(:)];      <span class="comment">% [mm]</span>
0323 <span class="keyword">end</span>
0324 
0325 
0326 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0327 <span class="comment">% GET BPM STANDARD DEVIATION INFO %</span>
0328 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0329 ButtonName = questdlg(<span class="string">'LOCO BPM Sigma?'</span>,<span class="string">'BPM SIGMA'</span>,<span class="string">'Use Default'</span>,<span class="string">'Measure'</span>,<span class="string">'Get From File'</span>,<span class="string">'Get From File'</span>);
0330 drawnow;
0331 <span class="keyword">switch</span> ButtonName,
0332     <span class="keyword">case</span> <span class="string">'Get From File'</span>
0333         [BPMSigmaFile, BPMSigmaDirectory] = uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Select a BPM Sigma File'</span>, DirStart);
0334         drawnow;
0335         <span class="keyword">if</span> BPMSigmaFile == 0
0336             fprintf(<span class="string">'   buildlocoinput canceled.\n'</span>);
0337             <span class="keyword">return</span>
0338         <span class="keyword">end</span>
0339         DirStart = BPMSigmaDirectory;
0340 
0341         <span class="comment">%BPMxSTD = getdata(BPMxFamily, Rmat(1,1).Monitor.DeviceList, [BPMSigmaDirectory BPMSigmaFile], 'Hardware');</span>
0342         <span class="comment">%BPMySTD = getdata(BPMyFamily, Rmat(2,2).Monitor.DeviceList, [BPMSigmaDirectory BPMSigmaFile], 'Hardware');</span>
0343         BPMxSTD = getsigma(BPMxFamily, Rmat(1,1).Monitor.DeviceList, [], [BPMSigmaDirectory BPMSigmaFile], <span class="string">'Hardware'</span>);
0344         BPMySTD = getsigma(BPMyFamily, Rmat(2,2).Monitor.DeviceList, [], [BPMSigmaDirectory BPMSigmaFile], <span class="string">'Hardware'</span>);
0345         
0346     <span class="keyword">case</span> <span class="string">'Use Default'</span>
0347         BPMxSTD = getsigma(BPMxFamily, Rmat(1,1).Monitor.DeviceList, <span class="string">'Hardware'</span>);
0348         BPMySTD = getsigma(BPMyFamily, Rmat(2,2).Monitor.DeviceList, <span class="string">'Hardware'</span>);
0349 
0350     <span class="keyword">case</span> <span class="string">'Measure'</span>
0351         [BPMx, BPMy, tout, DCCT, BPMxSTD, BPMySTD] = monbpm(0:.5:60*3, BPMxFamily, Rmat(1,1).Monitor.DeviceList, BPMyFamily, Rmat(2,2).Monitor.DeviceList, <span class="string">'Archive'</span>, <span class="string">'Hardware'</span>);
0352 <span class="keyword">end</span>
0353 
0354 <span class="comment">% sqrt(2) is needed because LOCO standard deviation is for difference orbits</span>
0355 LocoMeasData.BPMSTD = sqrt(2) * [BPMxSTD(:); BPMySTD(:)];    <span class="comment">% [mm]</span>
0356 
0357 
0358 <span class="comment">% % Check for a zero standard deviation (this is done in lococheckfile)</span>
0359 <span class="comment">% i = find(BPMxSTD==0);</span>
0360 <span class="comment">% if ~isempty(i)</span>
0361 <span class="comment">%     for k = 1:length(i)</span>
0362 <span class="comment">%         fprintf('   %s(%d,%d) or %s(%d) has a zero standard deviation\n', BPMxFamily, Rmat(1,1).Monitor.DeviceList(i(k),:), BPMxFamily, i(k));</span>
0363 <span class="comment">%     end</span>
0364 <span class="comment">% end</span>
0365 <span class="comment">%</span>
0366 <span class="comment">% % Check for a zero standard deviation</span>
0367 <span class="comment">% j = find(BPMySTD==0);</span>
0368 <span class="comment">% if ~isempty(j)</span>
0369 <span class="comment">%     for k = 1:length(j)</span>
0370 <span class="comment">%         fprintf('   %s(%d,%d) or %s(%d) has a zero standard deviation\n', BPMyFamily, Rmat(2,2).Monitor.DeviceList(j(k),:), BPMyFamily, j(k));</span>
0371 <span class="comment">%     end</span>
0372 <span class="comment">% end</span>
0373 <span class="comment">% if ~isempty(i) || ~isempty(j)</span>
0374 <span class="comment">%     fprintf('   WARNING:  LOCO can''t handle zero standard deviations.\n');</span>
0375 <span class="comment">% end</span>
0376 
0377 
0378 
0379 <span class="comment">% 3. BPM AND CORRECTOR MAGNET STRUCTURES</span>
0380 <span class="comment">% FamName and BPMIndex tells the findorbitrespm function which BPMs are needed in the response matrix</span>
0381 <span class="comment">% HBPMIndex/VBPMIndex is the sub-index of BPMIndex which correspond to the measured response matrix</span>
0382 <span class="comment">% BPMData.HBPMGain = starting value for the horizontal BPM gains (default: ones)</span>
0383 <span class="comment">% BPMData.VBPMGain = starting value for the vertical   BPM gains (default: ones)</span>
0384 <span class="comment">% BPMData.HBPMCoupling = starting value for the horizontal BPM coupling (default: zeros)</span>
0385 <span class="comment">% BPMData.VBPMCoupling = starting value for the vertical   BPM coupling (default: zeros)</span>
0386 <span class="comment">% BPMData.FitGains    = 'Yes'/'No' to fitting the BPM gain     (set in locogui)</span>
0387 <span class="comment">% BPMData.FitCoupling = 'Yes'/'No' to fitting the BPM coupling (set in locogui)</span>
0388 <span class="comment">% Note that gains and coupling are used all the time (fit or not!)</span>
0389 
0390 BPMData.FamName = <span class="string">'BPM'</span>;
0391 BPMData.FitGains    = <span class="string">'Yes'</span>;
0392 BPMData.FitCoupling = <span class="string">'Yes'</span>;
0393 
0394 <span class="keyword">if</span> 1
0395     <span class="comment">% Get the AT indexes from the AT model</span>
0396     <span class="comment">% The model should have the same number of devices as the total device list in the AO.</span>
0397     <span class="comment">% Then index based on the DeviceList saved with the response matrix</span>
0398     BPMData.BPMIndex = findcells(THERING, <span class="string">'FamName'</span>, BPMData.FamName)';
0399     tempindex = BPMData.BPMIndex;
0400     
0401     BPMxListTotal0 = family2dev(Rmat(1,1).Monitor.FamilyName,0);
0402     <span class="comment">%BPMxListTotal = getlist(Rmat(1,1).Monitor.FamilyName);</span>
0403     BPMxListTotal = Rmat(1,1).Monitor.DeviceList;
0404     subindex = findrowindex([BPMxListTotal; zeros(length(BPMxListTotal0)-length(BPMxListTotal),2)],BPMxListTotal0); 
0405         
0406     BPMData.BPMIndex = BPMData.BPMIndex(subindex);    
0407     <span class="keyword">if</span> length(BPMData.BPMIndex) == size(BPMxListTotal,1)
0408         <span class="comment">%BPMData.HBPMIndex = 1:length(BPMData.BPMIndex);</span>
0409         
0410         <span class="comment">% Only include the good BPMs (Status = 1)</span>
0411         BPMData.HBPMIndex = findrowindex(Rmat(1,1).Monitor.DeviceList, BPMxListTotal); 
0412     <span class="keyword">else</span>
0413         error(<span class="string">'BPM family in the AT model has more BPMs then the actual accelerator (horizontally)'</span>);
0414     <span class="keyword">end</span>     
0415     
0416     BPMyListTotal = Rmat(2,2).Monitor.DeviceList;
0417     
0418     <span class="keyword">if</span> length(BPMData.BPMIndex) == size(BPMyListTotal,1)
0419         <span class="comment">% Only include the good BPMs (Status = 1)</span>
0420         BPMData.VBPMIndex = findrowindex(Rmat(2,2).Monitor.DeviceList, BPMyListTotal); 
0421     <span class="keyword">else</span>
0422         error(<span class="string">'BPM family in the AT model has more BPMs then the actual accelerator (vertically)'</span>);
0423     <span class="keyword">end</span>     
0424     
0425 <span class="keyword">else</span>
0426     <span class="comment">% Get the AT indexes from the AO</span>
0427     BPM1Index = family2atindex(Rmat(1,1).Monitor.FamilyName, Rmat(1,1).Monitor.DeviceList);    <span class="comment">% Must match the response matrix</span>
0428     BPM2Index = family2atindex(Rmat(2,2).Monitor.FamilyName, Rmat(2,2).Monitor.DeviceList);    <span class="comment">% Must match the response matrix</span>
0429     BPMData.FamName = THERING{BPM1Index(1)};
0430     
0431     BPMData.BPMIndex = unique([BPM1Index(:); BPM2Index(:)]);
0432     BPMData.HBPMIndex = findrowindex(BPM1Index, BPMData.BPMIndex);          <span class="comment">% Must match the response matrix</span>
0433     BPMData.VBPMIndex = findrowindex(BPM2Index, BPMData.BPMIndex);          <span class="comment">% Must match the response matrix</span>
0434 <span class="keyword">end</span>
0435 
0436 <span class="keyword">if</span> 1
0437     <span class="comment">% Starting with the present GCR</span>
0438     <span class="keyword">for</span> i = 1:length(Rmat(1,1).Monitor.DeviceList)
0439         m = gcr2loco(getgain(BPMxFamily, Rmat(1,1).Monitor.DeviceList(i,:)), getgain(BPMyFamily, Rmat(1,1).Monitor.DeviceList(i,:)), getcrunch(BPMxFamily, Rmat(1,1).Monitor.DeviceList(i,:)), getroll(BPMxFamily, Rmat(1,1).Monitor.DeviceList(i,:)));
0440         BPMData.HBPMGain(i,1) = m(1,1);
0441         BPMData.HBPMCoupling(i,1) = m(1,2);
0442     <span class="keyword">end</span>
0443 
0444     <span class="keyword">for</span> i = 1:length(Rmat(2,2).Monitor.DeviceList)
0445         m = gcr2loco(getgain(BPMxFamily, Rmat(2,2).Monitor.DeviceList(i,:)), getgain(BPMyFamily, Rmat(2,2).Monitor.DeviceList(i,:)), getcrunch(BPMyFamily, Rmat(2,2).Monitor.DeviceList(i,:)), getroll(BPMyFamily, Rmat(2,2).Monitor.DeviceList(i,:)));
0446         BPMData.VBPMGain(i,1) = m(2,2);
0447         BPMData.VBPMCoupling(i,1) = m(2,1);
0448     <span class="keyword">end</span>
0449 <span class="keyword">else</span>
0450     <span class="comment">% Starting with nominal gains</span>
0451     BPMData.HBPMGain = ones(length(BPMData.HBPMIndex), 1);
0452     BPMData.VBPMGain = ones(length(BPMData.VBPMIndex), 1);
0453 <span class="keyword">end</span>
0454 
0455 
0456 
0457 <span class="comment">% FamName and HCMIndex/VCMIndex tells the findorbitrespm function which corrector magnets are in the response matrix</span>
0458 <span class="comment">% CMData.FitKicks = 'Yes'/'No' to fitting the corrector magnet gain (set in locogui)</span>
0459 <span class="comment">% CMData.FitCoupling = 'Yes'/'No' to fitting the corrector magnet coupling (set in locogui)</span>
0460 <span class="comment">% CMData.HCMKicks = starting value for the horizontal kicks in milliradian</span>
0461 <span class="comment">% CMData.VCMKicks = starting value for the vertical   kicks in milliradian</span>
0462 <span class="comment">% CMData.HCMCoupling = starting value for the horizontal coupling (default: zeros)</span>
0463 <span class="comment">% CMData.VCMCoupling = starting value for the vertical   coupling (default: zeros)</span>
0464 <span class="comment">% Note:  The kick strength should match the measured response matrix as best as possible</span>
0465 <span class="comment">% Note:  The kicks and Coupling are used all the time (fit or not!)</span>
0466 
0467 <span class="comment">% Get the AT indexes from the AT model</span>
0468 CMData.FitKicks    = <span class="string">'Yes'</span>;
0469 CMData.FitCoupling = <span class="string">'Yes'</span>;
0470 CMData.FitHCMEnergyShift = <span class="string">'No'</span>;
0471 CMData.FitVCMEnergyShift = <span class="string">'No'</span>;
0472 
0473 <span class="comment">% Get the AT indexes from the AO</span>
0474 CMData.HCMIndex = family2atindex(Rmat(1,1).Actuator.FamilyName, Rmat(1,1).Actuator.DeviceList);    <span class="comment">% Must match the response matrix</span>
0475 CMData.VCMIndex = family2atindex(Rmat(2,2).Actuator.FamilyName, Rmat(2,2).Actuator.DeviceList);    <span class="comment">% Must match the response matrix</span>
0476 CMData.FamName = THERING{CMData.HCMIndex(1)}.FamName;
0477 
0478 <span class="comment">% Kick strength in milliradian</span>
0479 CMData.HCMKicks = 1000 * hw2physics(HCMFamily, <span class="string">'Setpoint'</span>, Rmat(1,1).ActuatorDelta, Rmat(1,1).Actuator.DeviceList);  
0480 CMData.VCMKicks = 1000 * hw2physics(VCMFamily, <span class="string">'Setpoint'</span>, Rmat(2,2).ActuatorDelta, Rmat(2,2).Actuator.DeviceList);
0481 
0482 <span class="comment">% The kicks need to be adjusted for roll (model coordinates)</span>
0483 CMData.HCMKicks = CMData.HCMKicks .* cos(getroll(HCMFamily,Rmat(1,1).Actuator.DeviceList));
0484 CMData.VCMKicks = CMData.VCMKicks .* cos(getroll(VCMFamily,Rmat(2,2).Actuator.DeviceList));
0485 
0486 <span class="comment">% Coupling term: Cloco/Gloco  = gain(ML)*sin(Roll)/(gain(ML)*cos(Roll)) = tan(Roll)</span>
0487 <span class="comment">%CMData.HCMCoupling =  getgain(HCMFamily, Rmat(1,1).Actuator.DeviceList) .* sin(getroll(HCMFamily,Rmat(1,1).Actuator.DeviceList));</span>
0488 <span class="comment">%CMData.VCMCoupling = -getgain(VCMFamily, Rmat(2,2).Actuator.DeviceList) .* sin(getroll(VCMFamily,Rmat(2,2).Actuator.DeviceList));</span>
0489 CMData.HCMCoupling =  tan(getroll(HCMFamily,Rmat(1,1).Actuator.DeviceList));
0490 CMData.VCMCoupling = -tan(getroll(VCMFamily,Rmat(2,2).Actuator.DeviceList));
0491 
0492 
0493 
0494 <span class="comment">%%%%%%%%%%%%%</span>
0495 <span class="comment">% LocoFlags %</span>
0496 <span class="comment">%%%%%%%%%%%%%</span>
0497 <span class="comment">% LocoFlags can be created or just take the defaults with locogui (or locofilecheck)</span>
0498 <span class="comment">% LocoFlags = [];</span>
0499 LocoFlags.Threshold = 1e-006;
0500 LocoFlags.OutlierFactor = 10;
0501 LocoFlags.SVmethod = 1e-005;
0502 LocoFlags.HorizontalDispersionWeight = 12.5;
0503 LocoFlags.VerticalDispersionWeight = 12.5;
0504 LocoFlags.AutoCorrectDelta = <span class="string">'Yes'</span>;
0505 LocoFlags.Coupling = <span class="string">'Yes'</span>;
0506 LocoFlags.Normalize = <span class="string">'Yes'</span>;
0507 LocoFlags.Dispersion = <span class="string">'Yes'</span>;
0508 LocoFlags.ResponseMatrixCalculatorFlag1 = <span class="string">'Linear'</span>;
0509 LocoFlags.ResponseMatrixCalculatorFlag2 = <span class="string">'FixedPathLength'</span>;
0510 
0511 
0512 
0513 <span class="comment">%%%%%%%%%%%%%</span>
0514 <span class="comment">% Save file %</span>
0515 <span class="comment">%%%%%%%%%%%%%</span>
0516 
0517 <span class="comment">% File check</span>
0518 [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = <a href="locofilecheck.html" class="code" title="function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)">locofilecheck</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0519 
0520 
0521 <span class="comment">% Save</span>
0522 save(OutputFileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0523 
0524 
0525 <span class="comment">% Restore the old AT model</span>
0526 THERING = THERINGsave;
0527 
0528 
0529 
0530 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0531 <span class="comment">% Add the machine dependent stuff %</span>
0532 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0533 
0534 
0535 <span class="keyword">if</span> exist(<span class="string">'buildlocofitparameters'</span>, <span class="string">'file'</span>)
0536     buildlocofitparameters(OutputFileName);
0537 <span class="keyword">else</span>
0538     fprintf(<span class="string">'   buildlocofitparameters.m was not found so the FitParameters variable still needs to be created.\n'</span>);
0539 <span class="keyword">end</span>
0540 
0541 
0542</pre></div>
<hr><address>Generated on Mon 21-May-2007 15:32:41 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>