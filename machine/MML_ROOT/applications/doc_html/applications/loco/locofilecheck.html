<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of locofilecheck</title>
  <meta name="keywords" content="locofilecheck">
  <meta name="description" content="LOCOFILECHECK - Consistence check for the LOCO input file">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">applications</a> &gt; <a href="index.html">loco</a> &gt; locofilecheck.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for applications/loco&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>locofilecheck
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>LOCOFILECHECK - Consistence check for the LOCO input file</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">LOCOFILECHECK - Consistence check for the LOCO input file
  [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)
            or
  [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData})
                                      
  Checks the LOCO inputs and adds the defauls is inputs are missing.

  Written by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="buildlocoinput.html" class="code" title="function [LocoMeasData, BPMData, CMData, RINGData, FitParameters, LocoFlags] = buildlocoinput(OutputFileName)">buildlocoinput</a>	BUILDLOCOINPUT - Matlab Middlelayer (MML) method for building a LOCO input file.</li><li><a href="loco.html" class="code" title="function [LocoModel, BPMData, CMData, FitParameters, LocoFlags, RINGData] = loco(LocoMeasData, BPMData, CMData, FitParameters, LocoFlags, RINGData)">loco</a>	LOCO - Main routine for the LOCO algorithm</li><li><a href="locogui.html" class="code" title="function varargout = locogui(varargin)">locogui</a>	LOCOGUI - Graphical interface for running the LOCO algorithm</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)</a>
0002 <span class="comment">%LOCOFILECHECK - Consistence check for the LOCO input file</span>
0003 <span class="comment">%  [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)</span>
0004 <span class="comment">%            or</span>
0005 <span class="comment">%  [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData})</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  Checks the LOCO inputs and adds the defauls is inputs are missing.</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  Written by Greg Portmann</span>
0010 
0011 
0012 <span class="comment">% Default parameters</span>
0013 Defaults_Threshold = 1e-6;
0014 Defaults_OutlierFactor = 5;
0015 Defaults_HorizontalDispersionWeight = 1;
0016 Defaults_VerticalDispersionWeight = 1;
0017 Defaults_AutoCorrectDelta  = <span class="string">'Yes'</span>;
0018 Defaults_ResponseMatrixCalculator = <span class="string">'Linear'</span>;          <span class="comment">% 'Linear' or 'Full'</span>
0019 Defaults_ClosedOrbitType = <span class="string">'FixedPathLength'</span>;          <span class="comment">% 'FixedPathLength' or 'FixedMomentum';</span>
0020 Defaults_ResponseMatrixMeasurement = <span class="string">'BiDirectional'</span>;  <span class="comment">% 'OneWay' or 'BiDirectional'</span>
0021 Defaults_DispersionMeasurement     = <span class="string">'BiDirectional'</span>;  <span class="comment">% 'OneWay' or 'BiDirectional'</span>
0022 Defaults_Normalize = <span class="string">'Yes'</span>;
0023 Defaults_Coupling =<span class="string">'No'</span>;
0024 Defaults_Dispersion = <span class="string">'Yes'</span>;
0025 Defaults_FitHCMEnergyShift = <span class="string">'No'</span>;
0026 Defaults_FitVCMEnergyShift = <span class="string">'No'</span>;
0027 Defaults_FitRFFrequency = <span class="string">'No'</span>;
0028 Defaults_CMFitKicks  = <span class="string">'Yes'</span>;
0029 Defaults_CMFitCoupling = <span class="string">'No'</span>;
0030 Defaults_BPMFitGains = <span class="string">'Yes'</span>;
0031 Defaults_BPMFitCoupling = <span class="string">'No'</span>;
0032 Defaults_SinglePrecision = <span class="string">'No'</span>;
0033 Defaults_CalculateSigma = <span class="string">'Yes'</span>;
0034 
0035 
0036 <span class="keyword">if</span> nargin == 0
0037     [FileName, DirectoryName, FilterIndex] = uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Select a LOCO input file'</span>);
0038     <span class="keyword">if</span> FilterIndex == 0
0039         <span class="keyword">return</span>;
0040     <span class="keyword">end</span>
0041     FileName = [DirectoryName, FileName];
0042 <span class="keyword">end</span>
0043 
0044 
0045 <span class="keyword">if</span> iscell(FileName)
0046     BPMData       = FileName{1};
0047     CMData        = FileName{2};
0048     LocoMeasData  = FileName{3};
0049     LocoModel     = FileName{4};
0050     FitParameters = FileName{5};
0051     LocoFlags     = FileName{6};
0052     RINGData      = FileName{7};
0053 <span class="keyword">elseif</span> ischar(FileName)    
0054     <span class="keyword">try</span>
0055         load(FileName);
0056     <span class="keyword">catch</span>
0057         error(<span class="string">'File does not exist or is not a *.mat file type.\n'</span>);
0058     <span class="keyword">end</span>    
0059 <span class="keyword">else</span>
0060     error(<span class="string">'Input problem'</span>);
0061 <span class="keyword">end</span>
0062 
0063 
0064 <span class="comment">% Make sure LocoModel exists (this is mainly for locogui)</span>
0065 <span class="keyword">if</span> ~exist(<span class="string">'LocoModel'</span>,<span class="string">'var'</span>)
0066     LocoModel(length(CMData)) = struct(<span class="string">'M'</span>,[], <span class="string">'OutlierIndex'</span>,[], <span class="string">'Eta'</span>,[], <span class="string">'EtaOutlierIndex'</span>,[], <span class="string">'SValues'</span>,[], <span class="string">'SValuesIndex'</span>,[], <span class="string">'ChiSquare'</span>,[]);
0067 <span class="keyword">end</span>
0068 <span class="keyword">if</span> isempty(LocoModel)
0069     clear LocoModel
0070     LocoModel(length(CMData)) = struct(<span class="string">'M'</span>,[], <span class="string">'OutlierIndex'</span>,[], <span class="string">'Eta'</span>,[], <span class="string">'EtaOutlierIndex'</span>,[], <span class="string">'SValues'</span>,[], <span class="string">'SValuesIndex'</span>,[], <span class="string">'ChiSquare'</span>,[]);
0071 <span class="keyword">end</span>
0072 
0073 
0074 <span class="comment">% Make sure LocoFlags exists and is not empty</span>
0075 <span class="keyword">if</span> ~exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>)
0076     LocoFlags.Threshold = Defaults_Threshold;
0077     <span class="comment">% The rest will be created in the for loop</span>
0078 <span class="keyword">end</span>
0079 <span class="keyword">if</span> isempty(LocoFlags)
0080     LocoFlags.Threshold = Defaults_Threshold;
0081     <span class="comment">% The rest will be created in the for loop</span>
0082 <span class="keyword">end</span>
0083 
0084 
0085 <span class="comment">% Make sure FitParameters exists and is not empty</span>
0086 <span class="keyword">if</span> ~exist(<span class="string">'FitParameters'</span>,<span class="string">'var'</span>)
0087     FitParameters = [];
0088 <span class="keyword">end</span>
0089 <span class="comment">%if isempty(FitParameters)</span>
0090 <span class="comment">%    FitParameters.Values = [];</span>
0091 <span class="comment">%end</span>
0092 
0093 
0094 <span class="comment">% Make sure CMData exists and is not empty</span>
0095 <span class="keyword">if</span> ~exist(<span class="string">'CMData'</span>,<span class="string">'var'</span>)
0096     error(<span class="string">'CMData must exist.'</span>);
0097 <span class="keyword">end</span>
0098 <span class="keyword">if</span> isempty(CMData)
0099     error(<span class="string">'CMData can not be empty.'</span>);
0100 <span class="keyword">end</span>
0101 
0102 
0103 <span class="comment">% Make sure BPMData exists and is not empty</span>
0104 <span class="keyword">if</span> ~exist(<span class="string">'BPMData'</span>,<span class="string">'var'</span>)
0105     error(<span class="string">'BPMData must exist.'</span>);
0106 <span class="keyword">end</span>
0107 <span class="keyword">if</span> isempty(BPMData)
0108     error(<span class="string">'BPMData can not be empty.'</span>);
0109 <span class="keyword">end</span>
0110 
0111 
0112 <span class="comment">% Measured data checks</span>
0113 <span class="keyword">if</span> ~exist(<span class="string">'LocoMeasData'</span>,<span class="string">'var'</span>)
0114     error(<span class="string">' LocoMeasData variable does not exist.'</span>);
0115 <span class="keyword">end</span>  
0116 <span class="keyword">if</span> ~isfield(LocoMeasData, <span class="string">'M'</span>);
0117     error(<span class="string">'The response matrix (LocoMeasData.M) must exist.'</span>);
0118 <span class="keyword">end</span>
0119 <span class="keyword">if</span> isempty(LocoMeasData.M);
0120     error(<span class="string">'The response matrix (LocoMeasData.M) must exist.'</span>);
0121 <span class="keyword">end</span>
0122 
0123 <span class="keyword">if</span> ~isfield(LocoMeasData, <span class="string">'BPMSTD'</span>);
0124     error(<span class="string">'The response matrix stardard deviations (LocoMeasData.BPMSTD) must exist.'</span>);
0125 <span class="keyword">end</span>
0126 <span class="keyword">if</span> isempty(LocoMeasData.BPMSTD);
0127     error(<span class="string">'The response matrix stardard deviations (LocoMeasData.BPMSTD) must exist.'</span>);
0128 <span class="keyword">end</span>
0129 LocoMeasData.BPMSTD = LocoMeasData.BPMSTD(:);
0130 
0131 <span class="keyword">if</span> ~isfield(LocoMeasData, <span class="string">'DeltaRF'</span>);
0132     LocoMeasData.DeltaRF = [];
0133 <span class="keyword">end</span>
0134 <span class="keyword">if</span> isempty(LocoMeasData.DeltaRF);
0135     fprintf(<span class="string">'   Measured delta RF (LocoMeasData.DeltaRF) does not exist.  It is required when using the fix momentum response matrix calculator and when including dispersion.\n'</span>);
0136 <span class="keyword">end</span>
0137 
0138 <span class="keyword">if</span> ~isfield(LocoMeasData, <span class="string">'Eta'</span>);
0139     LocoMeasData.Eta = [];
0140 <span class="keyword">end</span>
0141 <span class="keyword">if</span> isempty(LocoMeasData.Eta);
0142     fprintf(<span class="string">'   Measured dispersion (LocoMeasData.Eta) does not exist.  It is required when using the fix momentum response matrix calculator and when including dispersion.\n'</span>);
0143 <span class="keyword">end</span>
0144 LocoMeasData.Eta = LocoMeasData.Eta(:);
0145 
0146 <span class="keyword">if</span> ~isfield(LocoMeasData, <span class="string">'RF'</span>);
0147     LocoMeasData.RF = [];
0148 <span class="keyword">end</span>
0149 <span class="keyword">if</span> isempty(LocoMeasData.RF);
0150     fprintf(<span class="string">'   Measured RF frequency (LocoMeasData.RF) does not exist.  It is required when using the fixed momentum response matrix calculator.\n'</span>);
0151 <span class="keyword">end</span>
0152 
0153 
0154 <span class="comment">% Check every iteration</span>
0155 <span class="keyword">for</span> i = 1:length(CMData)
0156  
0157     <span class="comment">% LocoFlags checks</span>
0158     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'OutlierFactor'</span>)
0159         LocoFlags(i).OutlierFactor  = Defaults_OutlierFactor;
0160     <span class="keyword">end</span>
0161     <span class="keyword">if</span> isempty(LocoFlags(i).OutlierFactor)
0162         LocoFlags(i).OutlierFactor  = Defaults_OutlierFactor;
0163     <span class="keyword">end</span>
0164 
0165     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'Threshold'</span>)
0166         LocoFlags(i).Threshold  = Defaults_Threshold;
0167     <span class="keyword">end</span>
0168     <span class="keyword">if</span> isempty(LocoFlags(i).Threshold)
0169         LocoFlags(i).Threshold  = Defaults_Threshold;
0170     <span class="keyword">end</span>
0171     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'SVmethod'</span>)
0172         LocoFlags(i).SVmethod  = LocoFlags(i).Threshold;
0173     <span class="keyword">end</span>
0174     
0175     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'HorizontalDispersionWeight'</span>)
0176         LocoFlags(i).HorizontalDispersionWeight = Defaults_HorizontalDispersionWeight;
0177     <span class="keyword">end</span>
0178     <span class="keyword">if</span> isempty(LocoFlags(i).HorizontalDispersionWeight)
0179         LocoFlags(i).HorizontalDispersionWeight = Defaults_HorizontalDispersionWeight;
0180     <span class="keyword">end</span>
0181 
0182     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'VerticalDispersionWeight'</span>)
0183         LocoFlags(i).VerticalDispersionWeight = Defaults_VerticalDispersionWeight;
0184     <span class="keyword">end</span>
0185     <span class="keyword">if</span> isempty(LocoFlags(i).VerticalDispersionWeight)
0186         LocoFlags(i).VerticalDispersionWeight = Defaults_VerticalDispersionWeight;
0187     <span class="keyword">end</span>
0188         
0189     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'AutoCorrectDelta'</span>)
0190         LocoFlags(i).AutoCorrectDelta  = Defaults_AutoCorrectDelta;
0191     <span class="keyword">end</span>
0192     <span class="keyword">if</span> isempty(LocoFlags(i).AutoCorrectDelta)
0193         LocoFlags(i).AutoCorrectDelta  = Defaults_AutoCorrectDelta;
0194     <span class="keyword">end</span>
0195     
0196     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'Coupling'</span>)
0197         LocoFlags(i).Coupling  = Defaults_Coupling;
0198     <span class="keyword">end</span>
0199     <span class="keyword">if</span> isempty(LocoFlags(i).Coupling)
0200         LocoFlags(i).Coupling = Defaults_Coupling;
0201     <span class="keyword">end</span>
0202     
0203     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'Normalize'</span>)
0204         LocoFlags(i).Normalize = Defaults_Normalize;
0205     <span class="keyword">end</span>
0206     <span class="keyword">if</span> isempty(LocoFlags(i).Normalize)
0207         LocoFlags(i).Normalize = Defaults_Normalize;
0208     <span class="keyword">end</span>
0209     
0210     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'Dispersion'</span>)
0211         LocoFlags(i).Dispersion = Defaults_Dispersion;
0212     <span class="keyword">end</span>
0213     <span class="keyword">if</span> isempty(LocoFlags(i).Dispersion)
0214         LocoFlags(i).Dispersion = Defaults_Dispersion;
0215     <span class="keyword">end</span>    
0216     
0217     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'ResponseMatrixCalculator'</span>)
0218         <span class="comment">% First check old field name</span>
0219         <span class="keyword">if</span> isfield(LocoFlags(i), <span class="string">'ResponseMatrixCalculatorFlag1'</span>)
0220             <span class="keyword">for</span> j = 1:length(LocoFlags)
0221                 LocoFlags(j).ResponseMatrixCalculator = LocoFlags(j).ResponseMatrixCalculatorFlag1;
0222             <span class="keyword">end</span>
0223         <span class="keyword">else</span>
0224             LocoFlags(i).ResponseMatrixCalculator = Defaults_ResponseMatrixCalculator;
0225         <span class="keyword">end</span>
0226     <span class="keyword">end</span>
0227     <span class="keyword">if</span> isempty(LocoFlags(i).ResponseMatrixCalculator)
0228         LocoFlags(i).ResponseMatrixCalculator = Defaults_ResponseMatrixCalculator;
0229     <span class="keyword">end</span>
0230     
0231     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'ClosedOrbitType'</span>)
0232         <span class="comment">% First check old field name</span>
0233         <span class="keyword">if</span> isfield(LocoFlags(i), <span class="string">'ResponseMatrixCalculatorFlag2'</span>)
0234             <span class="keyword">for</span> j = 1:length(LocoFlags)
0235                 LocoFlags(j).ClosedOrbitType = LocoFlags(j).ResponseMatrixCalculatorFlag2;
0236             <span class="keyword">end</span>
0237         <span class="keyword">else</span>
0238             LocoFlags(i).ClosedOrbitType = Defaults_ClosedOrbitType;
0239         <span class="keyword">end</span>
0240     <span class="keyword">end</span>
0241     <span class="keyword">if</span> isempty(LocoFlags(i).ClosedOrbitType)
0242         LocoFlags(i).ClosedOrbitType = Defaults_ClosedOrbitType;
0243     <span class="keyword">end</span>
0244     
0245     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'ResponseMatrixMeasurement'</span>)
0246         LocoFlags(i).ResponseMatrixMeasurement = Defaults_ResponseMatrixMeasurement;
0247     <span class="keyword">end</span>
0248     <span class="keyword">if</span> isempty(LocoFlags(i).ResponseMatrixMeasurement)
0249         LocoFlags(i).ResponseMatrixMeasurement = Defaults_ResponseMatrixMeasurement;
0250     <span class="keyword">end</span>
0251     
0252     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'DispersionMeasurement'</span>)
0253         LocoFlags(i).DispersionMeasurement = Defaults_DispersionMeasurement;
0254     <span class="keyword">end</span>
0255     <span class="keyword">if</span> isempty(LocoFlags(i).DispersionMeasurement)
0256         LocoFlags(i).DispersionMeasurement = Defaults_DispersionMeasurement;
0257     <span class="keyword">end</span>
0258 
0259     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'SinglePrecision'</span>)
0260         LocoFlags(i).SinglePrecision = Defaults_SinglePrecision;
0261     <span class="keyword">end</span>
0262     <span class="keyword">if</span> isempty(LocoFlags(i).SinglePrecision)
0263         LocoFlags(i).SinglePrecision = Defaults_SinglePrecision;
0264     <span class="keyword">end</span>
0265 
0266     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'CalculateSigma'</span>)
0267         LocoFlags(i).CalculateSigma = Defaults_CalculateSigma;
0268     <span class="keyword">end</span>
0269     <span class="keyword">if</span> isempty(LocoFlags(i).CalculateSigma)
0270         LocoFlags(i).CalculateSigma = Defaults_CalculateSigma;
0271     <span class="keyword">end</span>
0272 
0273     <span class="keyword">if</span> ~isfield(LocoFlags(i), <span class="string">'SVDDataFileName'</span>)
0274         LocoFlags(i).SVDDataFileName = <span class="string">''</span>;
0275     <span class="keyword">end</span>
0276     <span class="keyword">if</span> isempty(LocoFlags(i).SVDDataFileName)
0277         LocoFlags(i).SVDDataFileName = <span class="string">''</span>;
0278     <span class="keyword">end</span>
0279 
0280     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'FitHCMEnergyShift'</span>)
0281         CMData(i).FitHCMEnergyShift = Defaults_FitHCMEnergyShift;
0282     <span class="keyword">end</span>
0283     <span class="keyword">if</span> isempty(CMData(i).FitHCMEnergyShift)
0284         CMData(i).FitHCMEnergyShift = Defaults_FitHCMEnergyShift;
0285     <span class="keyword">end</span>
0286 
0287     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'FitVCMEnergyShift'</span>)
0288         CMData(i).FitVCMEnergyShift = Defaults_FitVCMEnergyShift;
0289     <span class="keyword">end</span>
0290     <span class="keyword">if</span> isempty(CMData(i).FitHCMEnergyShift)
0291         CMData(i).FitVCMEnergyShift = Defaults_FitVCMEnergyShift;
0292     <span class="keyword">end</span>
0293 
0294 
0295     <span class="comment">% FitParameters checks</span>
0296     <span class="keyword">if</span> ~isempty(FitParameters)
0297         <span class="comment">% Only check the FitParameters if the whole thing is not empty</span>
0298         <span class="keyword">if</span> ~isfield(FitParameters(i), <span class="string">'Values'</span>)
0299             <span class="comment">%error('FitParameters.Values must exist.');</span>
0300             FitParameters(i).Values = [];
0301         <span class="keyword">else</span>
0302             <span class="comment">% Column vector</span>
0303             FitParameters(i).Values = FitParameters(i).Values(:);
0304         <span class="keyword">end</span>
0305         <span class="comment">%if isempty(FitParameters(i).Values)</span>
0306         <span class="comment">%    error('FitParameters.Values cannot be empty.');</span>
0307         <span class="comment">%end</span>
0308 
0309         <span class="keyword">if</span> ~isfield(FitParameters(i),<span class="string">'ValuesSTD'</span>)
0310             FitParameters(i).ValuesSTD = [];
0311         <span class="keyword">end</span>
0312 
0313         <span class="keyword">if</span> ~isfield(FitParameters(i), <span class="string">'Deltas'</span>)
0314             FitParameters(i).Deltas = NaN * ones(size(FitParameters(i).Values));
0315         <span class="keyword">else</span>
0316             <span class="comment">% Column vector</span>
0317             FitParameters(i).Deltas = FitParameters(i).Deltas(:);
0318         <span class="keyword">end</span>
0319         <span class="keyword">if</span> isempty(FitParameters(i).Deltas)
0320             FitParameters(i).Deltas = NaN * ones(size(FitParameters(i).Values));
0321         <span class="keyword">end</span>
0322 
0323         <span class="keyword">if</span> ~isfield(FitParameters(i), <span class="string">'Params'</span>)
0324             FitParameters(i).Params = NaN * ones(size(FitParameters(i).Values));
0325         <span class="keyword">end</span>
0326         <span class="keyword">if</span> isempty(FitParameters(i).Params)
0327             FitParameters(i).Params = NaN * ones(size(FitParameters(i).Values));
0328         <span class="keyword">end</span>
0329 
0330         <span class="keyword">if</span> ~isfield(FitParameters(i), <span class="string">'FitRFFrequency'</span>)
0331             FitParameters(i).FitRFFrequency  = Defaults_FitRFFrequency;
0332         <span class="keyword">end</span>
0333         <span class="keyword">if</span> isempty(FitParameters(i).FitRFFrequency)
0334             FitParameters(i).FitRFFrequency  = Defaults_FitRFFrequency;
0335         <span class="keyword">end</span>
0336 
0337         <span class="keyword">if</span> ~isfield(FitParameters(i), <span class="string">'DeltaRF'</span>)
0338             <span class="comment">%error('Model delta RF (FitParameters.DeltaRF) needs to exist.');</span>
0339             <span class="comment">%FitParameters(i).DeltaRF = NaN;</span>
0340             FitParameters.DeltaRF = LocoMeasData.DeltaRF;
0341             fprintf(<span class="string">'   The model delta RF (FitParameters.DeltaRF) does not exist so it is being set to LocoMeasData.DeltaRF.\n'</span>);
0342         <span class="keyword">else</span>
0343             <span class="keyword">if</span> isempty(FitParameters(i).DeltaRF)
0344                 <span class="comment">%error('Model delta RF (FitParameters.DeltaRF) needs to exist.');</span>
0345                 <span class="comment">%FitParameters(i).DeltaRF = NaN;</span>
0346                 FitParameters.DeltaRF = LocoMeasData.DeltaRF;
0347                 fprintf(<span class="string">'   The model delta RF (FitParameters.DeltaRF) does not exist so it is being set to LocoMeasData.DeltaRF.\n'</span>);
0348             <span class="keyword">end</span>
0349         <span class="keyword">end</span>
0350         <span class="keyword">if</span> isempty(FitParameters(i).DeltaRF);
0351             fprintf(<span class="string">'   FitParameter.DeltaRF is empty so don''t use anything that requires dispersion.\n'</span>);
0352         <span class="keyword">end</span>
0353 
0354         <span class="keyword">if</span> ~isfield(FitParameters(i),<span class="string">'DeltaRFSTD'</span>)
0355             FitParameters(i).DeltaRFSTD = [];
0356         <span class="keyword">end</span>
0357         <span class="keyword">if</span> isempty(FitParameters(i).DeltaRFSTD)
0358             FitParameters(i).DeltaRFSTD = [];
0359         <span class="keyword">end</span>
0360         
0361         <span class="comment">% Vector length checks</span>
0362         <span class="keyword">if</span> length(FitParameters(i).Params) ~= length(FitParameters(i).Values)
0363             fprintf(<span class="string">'   The number of fit parameters (FitParameters(%d).Params) must equal the number of\n'</span>, i);
0364             fprintf(<span class="string">'   fit values (FitParameters(%d).Values).\n'</span>, i);
0365             error(<span class="string">' '</span>);
0366         <span class="keyword">end</span>
0367         <span class="keyword">if</span> length(FitParameters(i).Params) ~= length(FitParameters(i).Deltas)
0368             fprintf(<span class="string">'   The number of fit parameters (FitParameters(%d).Params) must equal the number fit\n'</span>, i);
0369             fprintf(<span class="string">'   deltas (FitParameters(%d).LocoDeltas).  Or leave LocoDeltas field blank.\n'</span>, i);
0370             error(<span class="string">' '</span>);
0371         <span class="keyword">end</span>
0372     <span class="keyword">end</span>
0373 
0374     
0375     <span class="comment">% BPMData checks</span>
0376     <span class="comment">%if ~isfield(BPMData(i), 'FamName')</span>
0377     <span class="comment">%    error('BPMData field FamName must exist.');</span>
0378     <span class="comment">%end</span>
0379     <span class="comment">%if isempty(BPMData(i).FamName)</span>
0380     <span class="comment">%    error('BPMData field FamName must exist.');</span>
0381     <span class="comment">%end</span>
0382     
0383     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'HBPMIndex'</span>)
0384         error(<span class="string">'BPMData field HBPMIndex must exist.'</span>);
0385     <span class="keyword">end</span>
0386     <span class="keyword">if</span> isempty(BPMData(i).HBPMIndex)
0387         error(<span class="string">'BPMData field HBPMIndex must exist.'</span>);
0388     <span class="keyword">end</span>
0389     BPMData(i).HBPMIndex = BPMData(i).HBPMIndex(:);
0390     
0391     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'VBPMIndex'</span>)
0392         error(<span class="string">'BPMData field VBPMIndex must exist.'</span>);
0393     <span class="keyword">end</span>
0394     <span class="keyword">if</span> isempty(BPMData(i).VBPMIndex)
0395         error(<span class="string">'BPMData field VBPMIndex must exist.'</span>);
0396     <span class="keyword">end</span>
0397     BPMData(i).VBPMIndex = BPMData(i).VBPMIndex(:);
0398 
0399     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'FitGains'</span>)
0400         BPMData(i).FitGains = Defaults_BPMFitGains;
0401     <span class="keyword">end</span>
0402     <span class="keyword">if</span> isempty(BPMData(i).FitGains)
0403         BPMData(i).FitGains = Defaults_BPMFitGains;
0404     <span class="keyword">end</span>
0405     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'FitCoupling'</span>)
0406         BPMData(i).FitCoupling = Defaults_BPMFitCoupling;
0407     <span class="keyword">end</span>
0408     <span class="keyword">if</span> isempty(BPMData(i).FitCoupling)
0409         BPMData(i).FitCoupling = Defaults_BPMFitCoupling;
0410     <span class="keyword">end</span>
0411     
0412     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'HBPMGoodDataIndex'</span>)
0413         BPMData(i).HBPMGoodDataIndex = 1:length(BPMData(i).HBPMIndex);
0414     <span class="keyword">end</span>
0415     BPMData(i).HBPMGoodDataIndex = BPMData(i).HBPMGoodDataIndex(:)';
0416     
0417     <span class="keyword">if</span> ~isfield(BPMData(i), <span class="string">'VBPMGoodDataIndex'</span>)
0418         BPMData(i).VBPMGoodDataIndex = 1:length(BPMData(i).VBPMIndex);
0419     <span class="keyword">end</span>
0420     BPMData(i).VBPMGoodDataIndex = BPMData(i).VBPMGoodDataIndex(:)';
0421 
0422     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'HBPMGain'</span>)
0423         BPMData(i).HBPMGain = ones(length(BPMData(i).HBPMIndex),1);
0424     <span class="keyword">end</span>
0425     <span class="keyword">if</span> isempty(BPMData(i).HBPMGain)
0426         BPMData(i).HBPMGain = ones(length(BPMData(i).HBPMIndex),1);
0427     <span class="keyword">end</span>
0428     BPMData(i).HBPMGain = BPMData(i).HBPMGain(:);
0429     
0430     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'VBPMGain'</span>)
0431         BPMData(i).VBPMGain = ones(length(BPMData(i).VBPMIndex),1);
0432     <span class="keyword">end</span>
0433     <span class="keyword">if</span> isempty(BPMData(i).VBPMGain)
0434         BPMData(i).VBPMGain = ones(length(BPMData(i).VBPMIndex),1);
0435     <span class="keyword">end</span>
0436     BPMData(i).VBPMGain = BPMData(i).VBPMGain(:);
0437     
0438     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'HBPMGainSTD'</span>)
0439         BPMData(i).HBPMGainSTD = NaN * ones(length(BPMData(i).HBPMIndex),1);
0440     <span class="keyword">end</span>
0441     <span class="keyword">if</span> isempty(BPMData(i).HBPMGainSTD)
0442         BPMData(i).HBPMGainSTD = NaN * ones(length(BPMData(i).HBPMIndex),1);
0443     <span class="keyword">end</span>
0444     BPMData(i).HBPMGainSTD = BPMData(i).HBPMGainSTD(:);
0445     
0446     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'VBPMGainSTD'</span>)
0447         BPMData(i).VBPMGainSTD = NaN * ones(length(BPMData(i).VBPMIndex),1);
0448     <span class="keyword">end</span>
0449     <span class="keyword">if</span> isempty(BPMData(i).VBPMGainSTD)
0450         BPMData(i).VBPMGainSTD = NaN * ones(length(BPMData(i).VBPMIndex),1);
0451     <span class="keyword">end</span>
0452     BPMData(i).VBPMGainSTD = BPMData(i).VBPMGainSTD(:);
0453 
0454     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'HBPMCoupling'</span>)
0455         BPMData(i).HBPMCoupling = zeros(length(BPMData(i).HBPMIndex),1);
0456     <span class="keyword">end</span>
0457     <span class="keyword">if</span> isempty(BPMData(i).HBPMCoupling)
0458         BPMData(i).HBPMCoupling = zeros(length(BPMData(i).HBPMIndex),1);
0459     <span class="keyword">end</span>
0460     BPMData(i).HBPMCoupling = BPMData(i).HBPMCoupling(:);
0461     
0462     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'VBPMCoupling'</span>)
0463         BPMData(i).VBPMCoupling = zeros(length(BPMData(i).VBPMIndex),1);
0464     <span class="keyword">end</span>
0465     <span class="keyword">if</span> isempty(BPMData(i).VBPMCoupling)
0466         BPMData(i).VBPMCoupling = zeros(length(BPMData(i).VBPMIndex),1);
0467     <span class="keyword">end</span>
0468     BPMData(i).VBPMCoupling = BPMData(i).VBPMCoupling(:);
0469 
0470     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'HBPMCouplingSTD'</span>)
0471         BPMData(i).HBPMCouplingSTD = NaN * ones(length(BPMData(i).HBPMIndex),1);
0472     <span class="keyword">end</span>
0473     <span class="keyword">if</span> isempty(BPMData(i).HBPMCouplingSTD)
0474         BPMData(i).HBPMCouplingSTD = NaN * ones(length(BPMData(i).HBPMIndex),1);
0475     <span class="keyword">end</span>
0476     BPMData(i).HBPMCouplingSTD = BPMData(i).HBPMCouplingSTD(:);
0477 
0478     <span class="keyword">if</span> ~isfield(BPMData(i),<span class="string">'VBPMCouplingSTD'</span>)
0479         BPMData(i).VBPMCouplingSTD = NaN * ones(length(BPMData(i).VBPMIndex),1);
0480     <span class="keyword">end</span>
0481     <span class="keyword">if</span> isempty(BPMData(i).VBPMCouplingSTD)
0482         BPMData(i).VBPMCouplingSTD = NaN * ones(length(BPMData(i).VBPMIndex),1);
0483     <span class="keyword">end</span>
0484     BPMData(i).VBPMCouplingSTD = BPMData(i).VBPMCouplingSTD(:);
0485 
0486     
0487     <span class="comment">% CMData checks</span>
0488     <span class="comment">%if ~isfield(CMData(i), 'FamName')</span>
0489     <span class="comment">%    error('CMData field FamName must exist.');</span>
0490     <span class="comment">%end</span>
0491     <span class="comment">%if isempty(CMData(i).FamName)</span>
0492     <span class="comment">%    error('CMData field FamName must exist.');</span>
0493     <span class="comment">%end</span>
0494         
0495     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'HCMIndex'</span>)
0496         error(<span class="string">'CMData field HCMIndex must exist.'</span>);
0497     <span class="keyword">end</span>
0498     <span class="keyword">if</span> isempty(CMData(i).HCMIndex)
0499         error(<span class="string">'CMData field HCMIndex must exist.'</span>);
0500     <span class="keyword">end</span>
0501     CMData(i).HCMIndex = CMData(i).HCMIndex(:);
0502 
0503     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'VCMIndex'</span>)
0504         error(<span class="string">'CMData field VCMIndex must exist.'</span>);
0505     <span class="keyword">end</span>
0506     <span class="keyword">if</span> isempty(CMData(i).VCMIndex)
0507         error(<span class="string">'CMData field VCMIndex must exist.'</span>);
0508     <span class="keyword">end</span>
0509     CMData(i).VCMIndex = CMData(i).VCMIndex(:);
0510     
0511     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'HCMGoodDataIndex'</span>)
0512         CMData(i).HCMGoodDataIndex = 1:length(CMData(i).HCMIndex);
0513     <span class="keyword">end</span>
0514     <span class="keyword">if</span> isempty(CMData(i).HCMGoodDataIndex)
0515         fprintf(<span class="string">'   CMData(%d).HCMGoodDataIndex is empty (ie, no horizonal correctors are being used)\n'</span>,i);
0516     <span class="keyword">end</span>
0517     CMData(i).HCMGoodDataIndex = CMData(i).HCMGoodDataIndex(:)';
0518     
0519     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'VCMGoodDataIndex'</span>)
0520         CMData(i).VCMGoodDataIndex = 1:length(CMData(i).VCMIndex);
0521     <span class="keyword">end</span>
0522     <span class="keyword">if</span> isempty(CMData(i).VCMGoodDataIndex)
0523         fprintf(<span class="string">'   CMData(%d).VCMGoodDataIndex is empty (ie, no vertical correctors are being used)\n'</span>,i);
0524     <span class="keyword">end</span>
0525     CMData(i).VCMGoodDataIndex = CMData(i).VCMGoodDataIndex(:)';
0526     
0527     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'FitKicks'</span>)
0528         CMData(i).FitKicks  = Defaults_CMFitKicks;
0529     <span class="keyword">end</span>
0530     <span class="keyword">if</span> isempty(CMData(i).FitKicks)
0531         CMData(i).FitKicks  = Defaults_CMFitKicks;
0532     <span class="keyword">end</span>
0533 
0534     <span class="keyword">if</span> ~isfield(CMData(i), <span class="string">'FitCoupling'</span>)
0535         CMData(i).FitCoupling  = Defaults_CMFitCoupling;
0536     <span class="keyword">end</span> 
0537     <span class="keyword">if</span> isempty(CMData(i).FitCoupling)
0538         CMData(i).FitCoupling  = Defaults_CMFitCoupling;
0539     <span class="keyword">end</span> 
0540 
0541     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMKicks'</span>)
0542         CMData(i).HCMKicks = ones(length(CMData(i).HCMIndex),1);
0543     <span class="keyword">end</span>
0544     <span class="keyword">if</span> isempty(CMData(i).HCMKicks)
0545         CMData(i).HCMKicks = ones(length(CMData(i).HCMIndex),1);
0546     <span class="keyword">end</span>
0547     CMData(i).HCMKicks = CMData(i).HCMKicks(:);
0548 
0549     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMKicks'</span>)
0550         CMData(i).VCMKicks = ones(length(CMData(i).VCMIndex),1);
0551     <span class="keyword">end</span>
0552     <span class="keyword">if</span> isempty(CMData(i).VCMKicks)
0553         CMData(i).VCMKicks = ones(length(CMData(i).VCMIndex),1);
0554     <span class="keyword">end</span>
0555     CMData(i).VCMKicks = CMData(i).VCMKicks(:);
0556     
0557     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMEnergyShift'</span>)
0558         CMData(i).HCMEnergyShift = zeros(length(CMData(i).HCMIndex),1);
0559     <span class="keyword">end</span>
0560     <span class="keyword">if</span> isempty(CMData(i).HCMEnergyShift)
0561         CMData(i).HCMEnergyShift = zeros(length(CMData(i).HCMIndex),1);
0562     <span class="keyword">end</span>
0563     CMData(i).HCMEnergyShift = CMData(i).HCMEnergyShift(:);
0564     
0565     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMEnergyShift'</span>)
0566         CMData(i).VCMEnergyShift = zeros(length(CMData(i).VCMIndex),1);
0567     <span class="keyword">end</span>
0568     <span class="keyword">if</span> isempty(CMData(i).VCMEnergyShift)
0569         CMData(i).VCMEnergyShift = zeros(length(CMData(i).VCMIndex),1);
0570     <span class="keyword">end</span>
0571     CMData(i).VCMEnergyShift = CMData(i).VCMEnergyShift(:);
0572 
0573     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMEnergyShiftSTD'</span>)
0574         CMData(i).HCMEnergyShiftSTD = NaN * ones(length(CMData(i).HCMIndex),1);
0575     <span class="keyword">end</span>
0576     <span class="keyword">if</span> isempty(CMData(i).HCMEnergyShiftSTD)
0577         CMData(i).HCMEnergyShiftSTD = NaN * ones(length(CMData(i).HCMIndex),1);
0578     <span class="keyword">end</span>
0579     CMData(i).HCMEnergyShiftSTD = CMData(i).HCMEnergyShiftSTD(:);
0580 
0581     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMEnergyShiftSTD'</span>)
0582         CMData(i).VCMEnergyShiftSTD = NaN * ones(length(CMData(i).VCMIndex),1);
0583     <span class="keyword">end</span>
0584     <span class="keyword">if</span> isempty(CMData(i).HCMEnergyShiftSTD)
0585         CMData(i).VCMEnergyShiftSTD = NaN * ones(length(CMData(i).VCMIndex),1);
0586     <span class="keyword">end</span>
0587     CMData(i).VCMEnergyShiftSTD = CMData(i).VCMEnergyShiftSTD(:);
0588 
0589     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMCoupling'</span>)
0590         CMData(i).HCMCoupling = zeros(length(CMData(i).HCMIndex),1);
0591     <span class="keyword">end</span>
0592     <span class="keyword">if</span> isempty(CMData(i).HCMCoupling)
0593         CMData(i).HCMCoupling = zeros(length(CMData(i).HCMIndex),1);
0594     <span class="keyword">end</span>
0595     CMData(i).HCMCoupling = CMData(i).HCMCoupling(:);
0596 
0597     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMCoupling'</span>)
0598         CMData(i).VCMCoupling = zeros(length(CMData(i).VCMIndex),1);
0599     <span class="keyword">end</span>
0600     <span class="keyword">if</span> isempty(CMData(i).VCMCoupling)
0601         CMData(i).VCMCoupling = zeros(length(CMData(i).VCMIndex),1);
0602     <span class="keyword">end</span>
0603     CMData(i).VCMCoupling = CMData(i).VCMCoupling(:);
0604 
0605     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMKicksSTD'</span>)
0606         CMData(i).HCMKicksSTD = NaN * ones(length(CMData(i).HCMIndex),1);
0607     <span class="keyword">end</span>
0608     <span class="keyword">if</span> isempty(CMData(i).HCMKicksSTD)
0609         CMData(i).HCMKicksSTD = NaN * ones(length(CMData(i).HCMIndex),1);
0610     <span class="keyword">end</span>
0611     CMData(i).HCMKicksSTD =CMData(i).HCMKicksSTD(:);
0612 
0613     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMKicksSTD'</span>)
0614         CMData(i).VCMKicksSTD = NaN * ones(length(CMData(i).VCMIndex),1);
0615     <span class="keyword">end</span>
0616     <span class="keyword">if</span> isempty(CMData(i).VCMKicksSTD)
0617         CMData(i).VCMKicksSTD = NaN * ones(length(CMData(i).VCMIndex),1);
0618     <span class="keyword">end</span>
0619     CMData(i).VCMKicksSTD =CMData(i).VCMKicksSTD(:);
0620 
0621     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'HCMCouplingSTD'</span>)
0622         CMData(i).HCMCouplingSTD = NaN * ones(length(CMData(i).HCMIndex),1);;
0623     <span class="keyword">end</span>
0624     <span class="keyword">if</span> isempty(CMData(i).HCMCouplingSTD)
0625         CMData(i).HCMCouplingSTD = NaN * ones(length(CMData(i).HCMIndex),1);;
0626     <span class="keyword">end</span>
0627     CMData(i).HCMCouplingSTD = CMData(i).HCMCouplingSTD(:);
0628     
0629     <span class="keyword">if</span> ~isfield(CMData(i),<span class="string">'VCMCouplingSTD'</span>)
0630         CMData(i).VCMCouplingSTD = NaN * ones(length(CMData(i).VCMIndex),1);;
0631     <span class="keyword">end</span>
0632     <span class="keyword">if</span> isempty(CMData(i).VCMCouplingSTD)
0633         CMData(i).VCMCouplingSTD = NaN * ones(length(CMData(i).VCMIndex),1);;
0634     <span class="keyword">end</span>
0635     CMData(i).VCMCouplingSTD = CMData(i).VCMCouplingSTD(:);
0636     
0637 
0638     <span class="comment">% LocoModel checks</span>
0639     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'M'</span>)
0640         LocoModel(i).M = [];
0641     <span class="keyword">end</span>
0642     
0643     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'Eta'</span>)
0644         LocoModel(i).Eta = [];
0645     <span class="keyword">end</span>
0646     LocoModel(i).Eta = LocoModel(i).Eta(:);
0647     
0648     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'SValues'</span>)
0649         LocoModel(i).SValues = [];
0650     <span class="keyword">end</span>
0651     
0652     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'SValuesIndex'</span>)
0653         LocoModel(i).SValuesIndex = [];
0654     <span class="keyword">end</span>
0655     
0656     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'OutlierIndex'</span>)
0657         LocoModel(i).OutlierIndex = [];
0658     <span class="keyword">end</span>
0659     
0660     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'EtaOutlierIndex'</span>)
0661         LocoModel(i).EtaOutlierIndex = [];
0662     <span class="keyword">end</span>
0663     
0664     <span class="keyword">if</span> ~isfield(LocoModel(i),<span class="string">'ChiSquare'</span>)
0665         LocoModel(i).ChiSquare = [];
0666     <span class="keyword">end</span>
0667     
0668      
0669     <span class="comment">% Checks response matrix size</span>
0670     <span class="keyword">if</span> size(LocoMeasData.M,1) ~= length(BPMData(i).HBPMIndex)+length(BPMData(i).VBPMIndex) 
0671         fprintf(<span class="string">'\n   LocoMeasData.M is size %d x %d\n'</span>, size(LocoMeasData.M)) 
0672         fprintf(<span class="string">'   NHBPM + NVBPM = %d + %d = %d\n'</span>, length(BPMData(i).HBPMIndex), length(BPMData(i).VBPMIndex), length(BPMData(i).HBPMIndex)+length(BPMData(i).VBPMIndex));
0673         fprintf(<span class="string">'   NHCM  +  NVCM = %d + %d = %d\n'</span>, length(CMData(i).HCMIndex), length(CMData(i).VCMIndex), length(CMData(i).HCMIndex)+length(CMData(i).VCMIndex));
0674         fprintf(<span class="string">'   The number of rows in the response matrix (LocoMeasData.M) must equal the\n'</span>);
0675         fprintf(<span class="string">'   number of BPMs in BPMData(%d) (length(BPMData.HBPMIndex)+length(BPMData.VBPMIndex))\n'</span>, i);
0676         fprintf(<span class="string">'   NOTE: the HBPMGoodDataIndex, VBPMGoodDataIndex, HCMGoodDataIndex, VCMGoodDataIndex do not matter.\n\n'</span>);
0677         error(<span class="string">' '</span>);
0678     <span class="keyword">end</span>
0679     
0680     <span class="keyword">if</span> size(LocoMeasData.M,2) ~= length(CMData(i).HCMIndex)+length(CMData(i).VCMIndex) 
0681         fprintf(<span class="string">'\n   LocoMeasData.M is size %d x %d\n'</span>, size(LocoMeasData.M)) 
0682         fprintf(<span class="string">'   NHBPM + NVBPM = %d + %d = %d\n'</span>, length(BPMData(i).HBPMIndex), length(BPMData(i).VBPMIndex), length(BPMData(i).HBPMIndex)+length(BPMData(i).VBPMIndex));
0683         fprintf(<span class="string">'   NHCM  +  NVCM = %d + %d = %d\n'</span>, length(CMData(i).HCMIndex), length(CMData(i).VCMIndex), length(CMData(i).HCMIndex)+length(CMData(i).VCMIndex));
0684         fprintf(<span class="string">'   The number of columns in the response matrix (LocoMeasData.M) must equal the\n'</span>);
0685         fprintf(<span class="string">'   number of correctors in CMData(%d) (length(CMData.HCMIndex)+length(CMData.VCMIndex))\n'</span>, i);
0686         fprintf(<span class="string">'   NOTE: the HBPMGoodDataIndex, VBPMGoodDataIndex, HCMGoodDataIndex, VCMGoodDataIndex do not matter.\n\n'</span>);
0687         error(<span class="string">' '</span>);
0688     <span class="keyword">end</span>
0689        
0690     
0691     <span class="comment">% Checks to add:</span>
0692     <span class="comment">% 1.  yes/no questions must be a yes or no answer</span>
0693     <span class="comment">% 2.  Indexing in the vectors must be in range</span>
0694     
0695 <span class="keyword">end</span>
0696 
0697 
0698 <span class="comment">% BPMSTD cannot be zero (only check good BPMs)</span>
0699 <span class="comment">%i = find(LocoMeasData.BPMSTD == 0);</span>
0700 <span class="comment">% Index = [BPMData.HBPMGoodDataIndex BPMData.VBPMGoodDataIndex];</span>
0701 <span class="comment">% i = find(LocoMeasData.BPMSTD(Index) == 0);</span>
0702 <span class="comment">% if ~isempty(i);</span>
0703 <span class="comment">%     fprintf('   %d of BPM standard deviations (LocoMeasData.BPMSTD) are zero.\n',length(i));</span>
0704 <span class="comment">% end</span>
0705 
0706 
0707 <span class="keyword">try</span>
0708     iBPM = 1:size(LocoMeasData.HBPM.DeviceList,1);
0709     iBPM = iBPM(BPMData(end).HBPMGoodDataIndex);
0710     i = find(LocoMeasData.BPMSTD(iBPM) == 0);
0711     <span class="keyword">if</span> ~isempty(i);
0712         <span class="keyword">if</span> length(i) &lt; 15
0713             <span class="keyword">for</span> j = 1:length(i)
0714                 fprintf(<span class="string">'   Zero standard deviation in horizontal BPM %d or device [%d,%d]  (LocoMeasData.BPMSTD)\n'</span>, iBPM(i(j)), LocoMeasData.HBPM.DeviceList(iBPM(i(j)),:));
0715             <span class="keyword">end</span>
0716         <span class="keyword">else</span>
0717             fprintf(<span class="string">'   %d of the horizontal BPM standard deviations (LocoMeasData.BPMSTD) are zero.\n'</span>, length(i));
0718         <span class="keyword">end</span>
0719         
0720         <span class="comment">% Remove from the good data index</span>
0721         fprintf(<span class="string">'   %d horizontal BPM removed from the HBPMGoodDataIndex.\n\n'</span>, length(i));
0722         iBPM = (1:size(LocoMeasData.HBPM.DeviceList,1))';
0723         i = find(LocoMeasData.BPMSTD(iBPM) == 0);
0724         k = findrowindex(i, BPMData(end).HBPMGoodDataIndex(:));
0725         BPMData(end).HBPMGoodDataIndex(k) = [];
0726     <span class="keyword">end</span>
0727 
0728     NHBPM = size(LocoMeasData.HBPM.DeviceList,1);
0729     iBPM = NHBPM + (1:size(LocoMeasData.VBPM.DeviceList,1));
0730     iBPM = iBPM(BPMData(end).VBPMGoodDataIndex);
0731     i = find(LocoMeasData.BPMSTD(iBPM) == 0);
0732     <span class="keyword">if</span> ~isempty(i);
0733         <span class="keyword">if</span> length(i) &lt; 15
0734             <span class="keyword">for</span> j = 1:length(i)
0735                 fprintf(<span class="string">'   Zero standard deviation in vertical BPM %d or device [%d,%d]  (LocoMeasData.BPMSTD)\n'</span>, iBPM(i(j))-NHBPM, LocoMeasData.VBPM.DeviceList(iBPM(i(j))-NHBPM,:));
0736             <span class="keyword">end</span>
0737         <span class="keyword">else</span>
0738             fprintf(<span class="string">'   %d of the vertical BPM standard deviations (LocoMeasData.BPMSTD) are zero.\n'</span>, length(i));
0739         <span class="keyword">end</span>
0740 
0741         <span class="comment">% Remove from the good data index</span>
0742         fprintf(<span class="string">'   %d vertical BPM removed from the VBPMGoodDataIndex.\n\n'</span>, length(i));
0743         iBPM = NHBPM + (1:size(LocoMeasData.VBPM.DeviceList,1))';
0744         i = find(LocoMeasData.BPMSTD(iBPM) == 0);
0745         k = findrowindex(i, BPMData(end).VBPMGoodDataIndex(:));
0746         BPMData(end).VBPMGoodDataIndex(k) = [];
0747     <span class="keyword">end</span>
0748 <span class="keyword">catch</span>
0749     i = find(LocoMeasData.BPMSTD == 0);
0750     <span class="keyword">if</span> ~isempty(i);
0751         fprintf(<span class="string">'   %d BPM standard deviations (LocoMeasData.BPMSTD) are zero.\n   A problem occurred trying to remove them.\n'</span>, length(i));
0752     <span class="keyword">end</span>
0753 <span class="keyword">end</span>
0754 
0755 
0756 <span class="comment">% Remove old variable names</span>
0757 <span class="keyword">if</span> isfield(LocoFlags, <span class="string">'ResponseMatrixCalculatorFlag1'</span>)
0758     LocoFlags = rmfield(LocoFlags,<span class="string">'ResponseMatrixCalculatorFlag1'</span>);
0759 <span class="keyword">end</span>
0760 <span class="keyword">if</span> isfield(LocoFlags, <span class="string">'ResponseMatrixCalculatorFlag2'</span>)
0761     LocoFlags = rmfield(LocoFlags,<span class="string">'ResponseMatrixCalculatorFlag2'</span>);
0762 <span class="keyword">end</span>
0763 
0764 
0765 <span class="comment">% Save</span>
0766 <span class="keyword">if</span> ischar(FileName)
0767     pause(.1);
0768     save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0769 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:32:41 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>