<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of bpmgui</title>
  <meta name="keywords" content="bpmgui">
  <meta name="description" content="function varargout = bpmgui(action, varargin)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">applications</a> &gt; <a href="index.html">orbit</a> &gt; bpmgui.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for applications/orbit&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>bpmgui
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function varargout = bpmgui(action, varargin)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function bpmgui(action, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> function varargout = bpmgui(action, varargin)
  bpmgui controls orbit manipulation and plotting
  graphics handles

 INPUT
 1. action possible among
 
 GetRef
 UpdateRef
 GetAct
 UpdateAct
 ylimits
 PlotRef_Init
 PlotRef
 PlotAct_Init
 PlotAct
 PlotFit_Init
 PlotFit
 PlotDes_Init
 PlotDes
 ClearOffsets
 PlotIcons_Init
 PlotBPMs
 PlotResp_Init
 PlotResp
 PlotEig_Init
 PlotEig
 BPMSelect
 BPMBar
 BPMDown
 ProcessBPM
 MoveBPM
 Up
 EditDesOrb
 EditBPMWeight
 SetBPMOff
 UpdateBPMBox
 BPMBox
 RePlot
 ClearPlots
 SelectAll
 SelectNone
 ToggleMode
 ToggleMode
 DragMode
 ShowBPMState</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>	function varargout = bpmgui(action, varargin)</li><li><a href="corgui.html" class="code" title="function corgui(action, varargin)">corgui</a>	CORGUI - controls corrector manipulation and plotting for orbit program</li><li><a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>	ORBGUI -- Contains routines to set up the main orbit control panel</li><li><a href="respgui.html" class="code" title="function respgui(action, varargin)">respgui</a>	RESPGUI - Part treating of the response matrice and the correction</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>	function varargout = bpmgui(action, varargin)</li><li><a href="corgui.html" class="code" title="function corgui(action, varargin)">corgui</a>	CORGUI - controls corrector manipulation and plotting for orbit program</li><li><a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>	ORBGUI -- Contains routines to set up the main orbit control panel</li><li><a href="readwrite.html" class="code" title="function readwrite(action, varargin)">readwrite</a>	READWRITE - Multipurpose read/write function for orbit correction applicaiton</li><li><a href="respgui.html" class="code" title="function respgui(action, varargin)">respgui</a>	RESPGUI - Part treating of the response matrice and the correction</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function bpmgui(action, varargin)</a>
0002 <span class="comment">% function varargout = bpmgui(action, varargin)</span>
0003 <span class="comment">%  bpmgui controls orbit manipulation and plotting</span>
0004 <span class="comment">%  graphics handles</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% INPUT</span>
0007 <span class="comment">% 1. action possible among</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% GetRef</span>
0010 <span class="comment">% UpdateRef</span>
0011 <span class="comment">% GetAct</span>
0012 <span class="comment">% UpdateAct</span>
0013 <span class="comment">% ylimits</span>
0014 <span class="comment">% PlotRef_Init</span>
0015 <span class="comment">% PlotRef</span>
0016 <span class="comment">% PlotAct_Init</span>
0017 <span class="comment">% PlotAct</span>
0018 <span class="comment">% PlotFit_Init</span>
0019 <span class="comment">% PlotFit</span>
0020 <span class="comment">% PlotDes_Init</span>
0021 <span class="comment">% PlotDes</span>
0022 <span class="comment">% ClearOffsets</span>
0023 <span class="comment">% PlotIcons_Init</span>
0024 <span class="comment">% PlotBPMs</span>
0025 <span class="comment">% PlotResp_Init</span>
0026 <span class="comment">% PlotResp</span>
0027 <span class="comment">% PlotEig_Init</span>
0028 <span class="comment">% PlotEig</span>
0029 <span class="comment">% BPMSelect</span>
0030 <span class="comment">% BPMBar</span>
0031 <span class="comment">% BPMDown</span>
0032 <span class="comment">% ProcessBPM</span>
0033 <span class="comment">% MoveBPM</span>
0034 <span class="comment">% Up</span>
0035 <span class="comment">% EditDesOrb</span>
0036 <span class="comment">% EditBPMWeight</span>
0037 <span class="comment">% SetBPMOff</span>
0038 <span class="comment">% UpdateBPMBox</span>
0039 <span class="comment">% BPMBox</span>
0040 <span class="comment">% RePlot</span>
0041 <span class="comment">% ClearPlots</span>
0042 <span class="comment">% SelectAll</span>
0043 <span class="comment">% SelectNone</span>
0044 <span class="comment">% ToggleMode</span>
0045 <span class="comment">% ToggleMode</span>
0046 <span class="comment">% DragMode</span>
0047 <span class="comment">% ShowBPMState</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%</span>
0050 
0051 <span class="comment">%</span>
0052 <span class="comment">% Written By Jeff Corbett</span>
0053 <span class="comment">% Modified by Laurent S. Nadolski, Soleil, April 2004</span>
0054 
0055 <span class="keyword">global</span> BPM COR RSP SYS
0056 orbfig = findobj(0,<span class="string">'tag'</span>,<span class="string">'orbfig'</span>);
0057 plane  = SYS.plane;
0058 
0059 <span class="comment">% BPMfamilies = {'BPMx','BPMz'};</span>
0060 
0061 <span class="keyword">switch</span> action
0062     <span class="comment">%...GetRef//YLimits</span>
0063     <span class="comment">%...PlotRef//PlotAct_Init//PlotAct//PlotFit_Init//PlotFit</span>
0064     <span class="comment">%...PlotDes_Init//Plot_Des//Plot_BPMs_Init//PlotBPMs</span>
0065     <span class="comment">%...PlotResp_Init//PlotResp//PlotEig_Init//PlotEig</span>
0066     <span class="comment">%...BPMDown//ProcessBPM//MoveBPMUp</span>
0067     <span class="comment">%...EditBPM//SetBPMOff//BPMBox//Up</span>
0068     <span class="comment">%...RePlot//ClearPlot</span>
0069     <span class="comment">%...SelectAll//SelectNone</span>
0070     <span class="comment">%...ToggleMode//DragMode//ShowBPMState</span>
0071 
0072     <span class="comment">%=============================================================</span>
0073     <span class="keyword">case</span> <span class="string">'GetRef'</span>                                 <span class="comment">% *** GetRef ***</span>
0074         <span class="comment">%=============================================================</span>
0075         <span class="comment">%load present orbit into .ref field of BPM structure</span>
0076 
0077         <span class="comment">% H-plane</span>
0078         BPM(1).ref = BPM(1).act;
0079         <span class="comment">% V-plane</span>
0080         BPM(2).ref = BPM(2).act;
0081         
0082         setappdata(0,<span class="string">'BPM'</span>,BPM);
0083 
0084         <span class="comment">%=============================================================</span>
0085     <span class="keyword">case</span> <span class="string">'UpdateRef'</span>                           <span class="comment">% *** UpdateRef ***</span>
0086         <span class="comment">%=============================================================</span>
0087         <span class="comment">%load a simulated or measured reference orbit into BPM structure</span>
0088         <span class="comment">%load a copy into the .des field</span>
0089         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'GetRef'</span>);  
0090         <span class="comment">%BPM=getappdata(0,'BPM');</span>
0091 
0092         <span class="comment">% H-plane</span>
0093         BPM(1).act = BPM(1).ref;
0094         BPM(1).des = BPM(1).ref;
0095         BPM(1).abs = BPM(1).ref;
0096         <span class="comment">% V-plane</span>
0097         BPM(2).act = BPM(2).ref;
0098         BPM(2).des = BPM(2).ref;
0099         BPM(2).abs = BPM(2).ref;
0100 
0101         <span class="keyword">if</span> SYS.relative == 1   <span class="comment">%absolute mode</span>
0102             BPM(1).abs = BPM(1).abs*0;
0103             BPM(2).abs = BPM(2).abs*0;
0104         <span class="keyword">end</span>
0105 
0106         setappdata(0,<span class="string">'BPM'</span>,BPM);
0107 
0108         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'LBox'</span>,<span class="string">' Refresh Reference Orbit: '</span>);
0109 
0110         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0111 
0112         <span class="comment">%=============================================================</span>
0113     <span class="keyword">case</span> <span class="string">'GetAct'</span>                             <span class="comment">% *** GetAct ***</span>
0114         <span class="comment">%=============================================================</span>
0115         <span class="comment">%acquire orbit, load into .act field</span>
0116 
0117         <span class="comment">% H-plane</span>
0118         val = getam(BPM(1).AOFamily,[],SYS.mode);
0119         BPM(1).act(BPM(1).status) = val;
0120         <span class="comment">% V-plane</span>
0121         val = getam(BPM(2).AOFamily,[],SYS.mode);
0122         BPM(2).act(BPM(2).status) = val;
0123 
0124         <span class="comment">%% Variable stored in the workspace memory</span>
0125         setappdata(0,<span class="string">'BPM'</span>,BPM);     
0126 
0127         <span class="comment">%=============================================================</span>
0128     <span class="keyword">case</span> <span class="string">'UpdateAct'</span>                           <span class="comment">% *** UpdateAct ***</span>
0129         <span class="comment">%=============================================================</span>
0130         <span class="comment">%read new orbit, update graphics</span>
0131 
0132         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'LBox'</span>,<span class="string">' Refresh Orbit '</span>);
0133         <span class="comment">%         disp('bpm acquisition');</span>
0134         <span class="comment">%         tic;</span>
0135         pause(2);
0136         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'GetAct'</span>);          <span class="comment">%loads both planes (300 ms in simulator)</span>
0137         <span class="comment">%         toc;</span>
0138 
0139         <span class="comment">%         disp('Corrector acquisition');</span>
0140         <span class="comment">%         tic;</span>
0141         <a href="corgui.html" class="code" title="function corgui(action, varargin)">corgui</a>(<span class="string">'GetAct'</span>);          <span class="comment">%loads both planes (200 ms in simulator)</span>
0142         <span class="comment">%         toc;</span>
0143 
0144         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0145 
0146         <span class="comment">%=============================================================</span>
0147     <span class="keyword">case</span> <span class="string">'ylimits'</span>                             <span class="comment">% *** ylimits ***</span>
0148         <span class="comment">%=============================================================</span>
0149         
0150         <span class="comment">%set vertical axis limits for BPM plot</span>
0151         <span class="keyword">if</span> BPM(plane).scalemode == 0
0152             <span class="keyword">return</span>; 
0153         <span class="keyword">end</span>  <span class="comment">%manual mode</span>
0154 
0155         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'AutoScaleBPMAxis'</span>);
0156 <span class="comment">%         mxref = max(abs(BPM(plane).ref(BPM(plane).status)-BPM(plane).abs(BPM(plane).status)));        %for ylimit calculation</span>
0157 <span class="comment">%         mxdes = max(abs(BPM(plane).des(BPM(plane).status)-BPM(plane).abs(BPM(plane).status)));        %for ylimit calculation</span>
0158 <span class="comment">%         mxact = max(abs(BPM(plane).act(BPM(plane).status)-BPM(plane).abs(BPM(plane).status)));        %for ylimit calculation</span>
0159 <span class="comment">%         mxfit = max(abs((BPM(plane).act(BPM(plane).avail)-BPM(plane).abs(BPM(plane).avail)+...</span>
0160 <span class="comment">%             BPM(plane).fit(BPM(plane).avail))));</span>
0161 <span class="comment">%</span>
0162 <span class="comment">%         ylim = max([mxref mxdes mxact mxfit])*1.1;</span>
0163 <span class="comment">%</span>
0164 <span class="comment">%         % TODO if limimit y-scale wanted</span>
0165 <span class="comment">%         %units are mm</span>
0166 <span class="comment">% %         if ylim &lt; 0.01 ylim = 0.01; end</span>
0167 <span class="comment">%</span>
0168 <span class="comment">%         ylim = ylim *BPM(plane).scale;</span>
0169 <span class="comment">%</span>
0170 <span class="comment">%         set(SYS.ahbpm,'YLim',ylim*[-1, 1]);</span>
0171 
0172         <span class="comment">%==========================================================</span>
0173     <span class="keyword">case</span> <span class="string">'PlotRef_Init'</span>                        <span class="comment">%...PlotRef_Init</span>
0174         <span class="comment">%==========================================================</span>
0175         <span class="comment">%red, solid line for reference orbit.</span>
0176         <span class="comment">%use .iref field</span>
0177         set(SYS.ahbpm,<span class="string">'Color'</span>,[1 1 1],<span class="string">'NextPlot'</span>,<span class="string">'add'</span>);
0178         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0179 
0180         yd = BPM(plane).ref(BPM(plane).iref)-BPM(plane).abs(BPM(plane).iref);
0181         yd = yd *BPM(plane).scale;
0182         
0183         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0184         xd = xd(BPM(plane).iref);
0185 
0186         SYS.lhref=    line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,xd, <span class="keyword">...</span>
0187             <span class="string">'YData'</span>,yd,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'Tag'</span>, <span class="string">'Ref'</span>);
0188         set(SYS.lhref,<span class="string">'ButtonDownFcn'</span>,<span class="string">'bpmgui(''BPMSelect'');'</span>);
0189 
0190         setappdata(0,<span class="string">'SYS'</span>,SYS);
0191 
0192         <span class="comment">%==========================================================</span>
0193     <span class="keyword">case</span> <span class="string">'PlotRef'</span>                        <span class="comment">%...PlotRef</span>
0194         <span class="comment">%==========================================================</span>
0195         <span class="comment">%red, solid, static line for reference orbit.</span>
0196         <span class="comment">%use .iref field</span>
0197         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0198         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0199 
0200         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0201         xd = xd(BPM(plane).iref);
0202 
0203         yd = BPM(plane).ref(BPM(plane).iref) - BPM(plane).abs(BPM(plane).iref);
0204         yd = yd*BPM(plane).scale;
0205         
0206         set(SYS.lhref,<span class="string">'LineWidth'</span>,1.25,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0207 
0208         setappdata(0,<span class="string">'SYS'</span>,SYS);
0209 
0210         <span class="comment">%==========================================================</span>
0211     <span class="keyword">case</span> <span class="string">'PlotAct_Init'</span>                        <span class="comment">%...PlotAct_Init</span>
0212         <span class="comment">%==========================================================</span>
0213         <span class="comment">%blue, solid dynamic line for actual orbit.</span>
0214         <span class="comment">%use .status field</span>
0215         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0216         set(SYS.ahbpm,<span class="string">'Color'</span>,[1 1 1],<span class="string">'NextPlot'</span>,<span class="string">'add'</span>);
0217         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0218 
0219         SYS.lhact = line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,[], <span class="keyword">...</span>
0220             <span class="string">'YData'</span>,[],<span class="string">'Color'</span>,<span class="string">'b'</span>,<span class="string">'ButtonDownFcn'</span>, <span class="keyword">...</span><span class="comment">,</span>
0221             <span class="string">'bpmgui(''BPMSelect'');'</span>,<span class="string">'Tag'</span>, <span class="string">'Act'</span>);
0222 
0223         setappdata(0,<span class="string">'SYS'</span>,SYS);
0224 
0225         <span class="comment">%==========================================================</span>
0226     <span class="keyword">case</span> <span class="string">'PlotAct'</span>                             <span class="comment">%...PlotAct</span>
0227         <span class="comment">%==========================================================</span>
0228         <span class="comment">%blue, solid dynamic line for actual orbit.</span>
0229         <span class="comment">%use .status field</span>
0230         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0231         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0232         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0233         xd = xd(BPM(plane).status);
0234 
0235         yd = BPM(plane).act(BPM(plane).status)-BPM(plane).abs(BPM(plane).status);
0236         yd = yd *BPM(plane).scale;
0237         
0238         set(SYS.lhact,<span class="string">'LineWidth'</span>,1.2,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0239 
0240         <span class="comment">%==========================================================</span>
0241     <span class="keyword">case</span> <span class="string">'PlotFit_Init'</span>                        <span class="comment">%...PlotFit_Init</span>
0242         <span class="comment">%==========================================================</span>
0243         <span class="comment">%blue, dashed line for orbit fit</span>
0244         <span class="comment">%use .avail field</span>
0245         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0246         set(SYS.ahbpm,<span class="string">'Color'</span>,[1,1,1],<span class="string">'NextPlot'</span>,<span class="string">'add'</span>);
0247         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0248         SYS.lhfit=    line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,[], <span class="keyword">...</span>
0249             <span class="string">'YData'</span>,[],<span class="string">'Color'</span>,<span class="string">'b'</span>,<span class="string">'LineStyle'</span>,<span class="string">':'</span>,<span class="string">'Tag'</span>, <span class="string">'Fit'</span>);
0250 
0251         setappdata(0,<span class="string">'SYS'</span>,SYS);
0252 
0253         <span class="comment">%==========================================================</span>
0254     <span class="keyword">case</span> <span class="string">'PlotFit'</span>                             <span class="comment">%...PlotFit</span>
0255         <span class="comment">%==========================================================</span>
0256         <span class="comment">%blue, dashed line for orbit fit</span>
0257         <span class="comment">%use .avail field</span>
0258         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0259 
0260         <span class="comment">%actual orbit plus the fitted solution from corrector change</span>
0261         <span class="comment">%yields the predicted orbit</span>
0262         yd = (BPM(plane).act(BPM(plane).avail) - <span class="keyword">...</span>
0263               BPM(plane).abs(BPM(plane).avail) + <span class="keyword">...</span><span class="comment"> %zero if absolute, ref else</span>
0264               BPM(plane).fit(BPM(plane).avail) + <span class="keyword">...</span>
0265               BPM(plane).rffit(BPM(plane).avail));
0266         yd = yd*BPM(plane).scale;
0267         
0268         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0269         xd = xd(BPM(plane).avail);
0270                
0271         <span class="comment">%% Update graph</span>
0272         set(SYS.lhfit,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0273         set(SYS.lhfit,<span class="string">'ButtonDownFcn'</span>,<span class="string">'bpmgui(''BPMSelect'');'</span>);
0274         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0275 
0276         <span class="comment">%==========================================================</span>
0277     <span class="keyword">case</span> <span class="string">'PlotDes_Init'</span>                        <span class="comment">%...PlotDes_Init</span>
0278         <span class="comment">%==========================================================</span>
0279         <span class="comment">%red, dashed dynamic line for offset orbit</span>
0280         <span class="comment">%use .avail field</span>
0281 
0282         yd = BPM(plane).des(BPM(plane).avail) - BPM(plane).abs(BPM(plane).avail);
0283         yd = yd*BPM(plane).scale;
0284         
0285         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0286         xd = xd(BPM(plane).avail);
0287         
0288         SYS.lhdes = line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,xd, <span class="keyword">...</span>
0289             <span class="string">'YData'</span>,yd,<span class="string">'Color'</span>,<span class="string">'r'</span>,<span class="string">'LineStyle'</span>,<span class="string">':'</span>,<span class="string">'Tag'</span>, <span class="string">'Des'</span>);
0290         set(SYS.lhdes,<span class="string">'ButtonDownFcn'</span>,<span class="string">'bpmgui(''BPMSelect'');'</span>);
0291 
0292         setappdata(0,<span class="string">'SYS'</span>,SYS);
0293 
0294         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0295 
0296         <span class="comment">%==========================================================</span>
0297     <span class="keyword">case</span> <span class="string">'PlotDes'</span>                                  <span class="comment">%...PlotDes</span>
0298         <span class="comment">%==========================================================</span>
0299         <span class="comment">% %red, dashed dynamic line for offset orbit</span>
0300         <span class="comment">%use .avail field</span>
0301 
0302         yd = BPM(plane).des(BPM(plane).avail) - BPM(plane).abs(BPM(plane).avail);
0303         yd = yd *BPM(plane).scale;
0304        
0305         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0306         xd = xd(BPM(plane).avail);
0307      
0308         set(SYS.lhdes,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0309         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0310 
0311         <span class="comment">%%==========================================================</span>
0312     <span class="keyword">case</span> <span class="string">'ClearOffsets'</span>                        <span class="comment">%...ClearOffsets</span>
0313         <span class="comment">%==========================================================</span>
0314         <span class="comment">%remove offsets in plane of interest</span>
0315         <span class="comment">%use .avail field</span>
0316 
0317         id = BPM(plane).avail(1:length(BPM(plane).avail));
0318         BPM(plane).des(id) = BPM(plane).ref(id)-BPM(plane).abs(id);
0319         
0320         <span class="comment">%moves the icon on screen</span>
0321         set(BPM(plane).hicon(id),{<span class="string">'YData'</span>},num2cell(BPM(plane).des)); 
0322 
0323 <span class="comment">%         for ii = 1:length(BPM(plane).avail)</span>
0324 <span class="comment">%             id                 = BPM(plane).avail(ii);</span>
0325 <span class="comment">%             BPM(plane).des(id) = BPM(plane).ref(id)-BPM(plane).abs(id);</span>
0326 <span class="comment">%             b                  = BPM(plane).hicon(id);</span>
0327 <span class="comment">%             set(b,'YData',BPM(plane).des(id));   %moves the icon on screen</span>
0328 <span class="comment">%         end</span>
0329 
0330         setappdata(0,<span class="string">'BPM'</span>,BPM);
0331 
0332         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0333 
0334         <span class="comment">%==========================================================</span>
0335     <span class="keyword">case</span> <span class="string">'PlotIcons_Init'</span>                       <span class="comment">%...PlotIcons_Init</span>
0336         <span class="comment">%==========================================================</span>
0337         <span class="comment">%draw initial 'hot' circles for each BPM - need to vectorize</span>
0338         selectbpm = <span class="string">'bpmgui(''BPMDown'');'</span>;
0339 
0340         <span class="comment">%present plane</span>
0341         plane = SYS.plane;
0342         xd    = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0343 
0344         <span class="comment">%black if not in status vector</span>
0345         <span class="keyword">for</span> kk = 1:size(BPM(plane).name,1)
0346             BPM(plane).hicon(kk) = line(<span class="string">'parent'</span>,SYS.ahbpm, <span class="keyword">...</span>
0347                 <span class="string">'Tag'</span>, [<span class="string">'b'</span> num2str(kk)],<span class="keyword">...</span>
0348                 <span class="string">'XData'</span>,xd(kk),<span class="keyword">...</span>
0349                 <span class="string">'YData'</span>,0,<span class="keyword">...</span>
0350                 <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>,5,<span class="string">'MarkerFaceColor'</span>,<span class="string">'k'</span>,<span class="keyword">...</span>
0351                 <span class="string">'ButtonDownFcn'</span>,selectbpm);
0352         <span class="keyword">end</span>
0353         BPM(plane).hicon          = BPM(plane).hicon(:);
0354         BPM(1+mod(plane,2)).hicon = BPM(plane).hicon;
0355 
0356         setappdata(0,<span class="string">'BPM'</span>,BPM);
0357 
0358         <span class="comment">%draw a vertical black line at selected BPM</span>
0359         ylim = get(SYS.ahbpm,<span class="string">'YLim'</span>);
0360         SYS.lhbid =    line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="keyword">...</span>
0361             <span class="string">'XData'</span>,[xd(BPM(plane).id),xd(BPM(plane).id) + 0.001],<span class="keyword">...</span>
0362             <span class="string">'YData'</span>,[ylim(1),ylim(2)],<span class="string">'Color'</span>,<span class="string">'k'</span>,<span class="string">'Tag'</span>, <span class="string">'Icons'</span>);
0363         set(SYS.lhbid, <span class="string">'ButtonDownFcn'</span>,<span class="string">'bpmgui(''BPMSelect'');'</span>);
0364 
0365         <span class="comment">%==========================================================</span>
0366     <span class="keyword">case</span> <span class="string">'PlotBPMs'</span>                             <span class="comment">%...PlotBPMs</span>
0367         <span class="comment">%==========================================================</span>
0368         <span class="comment">%green if BPM contained in BPM(plane).ifit, otherwise yellow</span>
0369         <span class="comment">%red if not available (no response matrix entry or no reference orbit)</span>
0370         <span class="comment">%default hot bpms to black</span>
0371 <span class="comment">%         yd = BPM(plane).des - BPM(plane).abs;</span>
0372         yd = BPM(plane).act(BPM(plane).status) - BPM(plane).abs(BPM(plane).status);
0373         yd = yd*BPM(plane).scale;
0374         
0375         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0376 
0377 <span class="comment">%         for kk = 1:size(BPM(plane).name,1)</span>
0378 <span class="comment">%             set(BPM(plane).hicon(kk),'Xdata',xd(kk),...</span>
0379 <span class="comment">%                 'YData',0,'MarkerSize',5,'MarkerFaceColor','k');</span>
0380 <span class="comment">%         end</span>
0381 <span class="comment">%         set(BPM(plane).hicon,'YData',0,'MarkerFaceColor','k');</span>
0382         
0383         nstat = length(BPM(plane).status);
0384         kk = (1:nstat)';
0385         colorcell = repmat({<span class="string">'g'</span>},nstat,1); <span class="comment">%green for fit</span>
0386         colorcell(setdiff(kk,BPM(plane).ifit)) = {<span class="string">'y'</span>};  <span class="comment">%yellow for no fit</span>
0387         colorcell(setdiff(kk,BPM(plane).avail)) = {<span class="string">'r'</span>};  <span class="comment">%red for not available</span>
0388         
0389         <span class="comment">% set everything using cell structure instead of for-loop</span>
0390         set(BPM(plane).hicon,{<span class="string">'XData'</span>},num2cell(xd),{<span class="string">'YData'</span>},num2cell(yd), <span class="keyword">...</span>
0391             {<span class="string">'MarkerFaceColor'</span>},colorcell);
0392                
0393 <span class="comment">%         for kk = 1:nstat</span>
0394 <span class="comment">%             k     = BPM(plane).status(kk);   %double index, BPM.status is compressed</span>
0395 <span class="comment">%             color = 'r';                 %red for not available</span>
0396 <span class="comment">%             if ~isempty(find(BPM(plane).avail == k)), color = 'y'; end   %yellow for available</span>
0397 <span class="comment">%             if isempty(BPM(plane).ifit)</span>
0398 <span class="comment">%                 color = 'y'; %yellow for no fit</span>
0399 <span class="comment">%             elseif ~isempty(find(BPM(plane).ifit == k))</span>
0400 <span class="comment">%                 color = 'g'; %green for fit</span>
0401 <span class="comment">%             end</span>
0402 <span class="comment">%             set(BPM(plane).hicon(k),...</span>
0403 <span class="comment">%                 'XData',xd(k),'YData',yd(k),...</span>
0404 <span class="comment">%                 'MarkerSize',5,'MarkerEdgeColor','k','MarkerFaceColor',color);</span>
0405 <span class="comment">%         end</span>
0406 
0407         <span class="comment">%==========================================================</span>
0408     <span class="keyword">case</span> <span class="string">'PlotResp_Init'</span>                      <span class="comment">%...PlotResp_Init</span>
0409         <span class="comment">%==========================================================</span>
0410         <span class="comment">%black, solid dynamic line for response orbit</span>
0411         <span class="comment">%use .avail field</span>
0412         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0413         set(SYS.ahbpm,<span class="string">'Color'</span>,[1,1,1],<span class="string">'NextPlot'</span>,<span class="string">'add'</span>);
0414         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm);
0415         SYS.lhrsp =    line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,[], <span class="keyword">...</span>
0416             <span class="string">'YData'</span>,[],<span class="string">'Color'</span>,<span class="string">'k'</span>,<span class="string">'Tag'</span>, <span class="string">'Resp'</span>);
0417 
0418         setappdata(0,<span class="string">'SYS'</span>,SYS);
0419 
0420         <span class="comment">%==========================================================</span>
0421     <span class="keyword">case</span> <span class="string">'PlotResp'</span>                             <span class="comment">%...PlotResp</span>
0422         <span class="comment">%==========================================================</span>
0423         <span class="comment">%black, solid static line for column of response matrix</span>
0424         <span class="comment">%use .avail field</span>
0425 
0426         id = COR(plane).id;
0427 
0428         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0429 
0430         ylim = get(SYS.ahbpm,<span class="string">'YLim'</span>);
0431         
0432         <span class="comment">%scale column of response matrix</span>
0433         val  = 0.5*ylim(2)/max(abs(RSP(plane).Data(BPM(plane).avail,id))); 
0434                                   
0435         yd   = val*RSP(plane).Data(BPM(plane).avail,id);
0436         
0437         xd   = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0438 
0439         set(SYS.lhrsp,<span class="string">'LineWidth'</span>,1.5,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0440 
0441         <span class="comment">%==========================================================</span>
0442     <span class="keyword">case</span> <span class="string">'PlotEig_Init'</span>                        <span class="comment">%...PlotEig_Init</span>
0443         <span class="comment">%==========================================================</span>
0444         <span class="comment">%black, solid dynamic line for eigenvector orbit</span>
0445         <span class="comment">%use .iavail field for default</span>
0446         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0447         set(SYS.ahbpm,<span class="string">'Color'</span>,[1,1,1],<span class="string">'NextPlot'</span>,<span class="string">'add'</span>);
0448         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0449         SYS.lheig=    line(<span class="string">'parent'</span>,SYS.ahbpm,<span class="string">'XData'</span>,[], <span class="keyword">...</span>
0450             <span class="string">'YData'</span>,[],<span class="string">'Color'</span>,<span class="string">'k'</span>,<span class="string">'Tag'</span>, <span class="string">'Eig'</span>);
0451 
0452         setappdata(0,<span class="string">'SYS'</span>,SYS);
0453 
0454         <span class="comment">%==========================================================</span>
0455     <span class="keyword">case</span> <span class="string">'PlotEig'</span>                                  <span class="comment">%...PlotEig</span>
0456         <span class="comment">%==========================================================</span>
0457         <span class="comment">%black, solid static line for eigenvector orbit</span>
0458         <span class="comment">%use .ifit field</span>
0459 
0460         <span class="keyword">switch</span> SYS.algo
0461 
0462             <span class="keyword">case</span> <span class="string">'SVD'</span>
0463                 ieig = RSP(plane).nsvd;
0464 
0465                 <span class="keyword">if</span> ieig == 0, <span class="keyword">return</span>; <span class="keyword">end</span>
0466 
0467                 set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm);
0468 
0469                 ylim = get(SYS.ahbpm,<span class="string">'YLim'</span>);
0470                 val  = 0.5*ylim(2)/max(abs(RSP(plane).U(ieig,:)));   <span class="comment">%columns are .ifit bpms</span>
0471                 yd   = val*RSP(plane).U(ieig,:);                                
0472                 xd   = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0473                 set(SYS.lheig,<span class="string">'LineWidth'</span>,1.5,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);                
0474 
0475         <span class="keyword">end</span>   <span class="comment">%end case</span>
0476 
0477         <span class="comment">%=============================================================</span>
0478     <span class="keyword">case</span> <span class="string">'BPMSelect'</span>                          <span class="comment">% *** BPMSelect ***</span>
0479         <span class="comment">%=============================================================</span>
0480         <span class="comment">%used if mouse clicks anywhere in BPM window</span>
0481         <span class="comment">% Get mouse position</span>
0482         cpa = get(SYS.ahbpm,<span class="string">'CurrentPoint'</span>);
0483         pos = cpa(1);
0484 
0485         <span class="comment">%% Searchs closest BPM</span>
0486         
0487         <span class="keyword">switch</span> SYS.xscale
0488             <span class="keyword">case</span> <span class="string">'meter'</span>
0489                 id = find(min(abs(BPM(plane).s-pos)) == abs(BPM(plane).s-pos));
0490             <span class="keyword">case</span> <span class="string">'phase'</span>
0491                 id = find(min(abs(BPM(plane).phi-pos)) == abs(BPM(plane).phi-pos));
0492         <span class="keyword">end</span>
0493 
0494         BPM(plane).id = id;
0495 
0496         <span class="comment">%% Stores updated BPM structure</span>
0497         setappdata(0,<span class="string">'BPM'</span>,BPM);
0498 
0499         b = BPM(plane).hicon(id); <span class="comment">% handle for round symbol</span>
0500 
0501         <span class="comment">% Set black cross in the BPM window</span>
0502         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'BPMBar'</span>);
0503 
0504         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ProcessBPM'</span>,id,b);
0505 
0506         <span class="comment">%=============================================================</span>
0507     <span class="keyword">case</span> <span class="string">'BPMBar'</span>                              <span class="comment">% *** BPMBar ***</span>
0508         <span class="comment">%=============================================================</span>
0509         <span class="comment">%move black line in window to indicate selection</span>
0510         id   = BPM(plane).id;
0511         ylim = get(SYS.ahbpm,<span class="string">'YLim'</span>);
0512 
0513         <span class="keyword">if</span> isempty(find(BPM(plane).status == id,1))
0514             yd = ylim/4*BPM(plane).scale;
0515         <span class="keyword">else</span>
0516             yd = (BPM(plane).des(id) - BPM(plane).abs(id))*BPM(plane).scale <span class="keyword">...</span>
0517                 + ylim/4;
0518         <span class="keyword">end</span>
0519 
0520         xd = <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'GetAbscissa'</span>,SYS,<span class="string">'BPM'</span>);  <span class="comment">%horizontal coordinates for plotting</span>
0521         xd = [xd(id) xd(id) + 0.001];
0522        
0523         set(SYS.lhbid,<span class="string">'XData'</span>,xd,<span class="string">'YData'</span>,yd);
0524 
0525         <span class="comment">%=============================================================</span>
0526     <span class="keyword">case</span> <span class="string">'BPMDown'</span>                              <span class="comment">% *** BPMDown ***</span>
0527         <span class="comment">%=============================================================</span>
0528         <span class="comment">%used if mouse clicks directly on BPM</span>
0529         b     = gcbo;
0530         bptag = get(b,<span class="string">'tag'</span>);
0531         id    = str2double(bptag(2:length(bptag))); <span class="comment">%strip off 'b' to get the bpm index</span>
0532         BPM(plane).id = id;
0533 
0534         setappdata(0,<span class="string">'BPM'</span>,BPM);
0535 
0536         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ProcessBPM'</span>,id,b);
0537 
0538         <span class="comment">%=============================================================</span>
0539     <span class="keyword">case</span> <span class="string">'ProcessBPM'</span>                            <span class="comment">% *** ProcessBPM ***</span>
0540         <span class="comment">%=============================================================</span>
0541         <span class="comment">%put BPM data into text fields.</span>
0542         <span class="comment">%if BPM.mode=1, display, toggle</span>
0543         <span class="comment">%if BPM.mode=2, display, drag</span>
0544 
0545         <span class="comment">%identify BPM handle and number</span>
0546         id = varargin{1}; <span class="comment">%bpm number 'id'</span>
0547         b  = varargin{2}; <span class="comment">%bpm graphics handle 'b'</span>
0548 
0549         <span class="comment">%check to see if bpm available</span>
0550         <span class="keyword">if</span> isempty(find(BPM(plane).avail == id,1)) <span class="comment">%put fit value in offset box and in request box</span>
0551             <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'UpdateBPMBox'</span>);
0552             <span class="keyword">return</span>;
0553         <span class="keyword">end</span>
0554 
0555         <span class="comment">%====================</span>
0556         <span class="comment">%   TOGGLE MODE</span>
0557         <span class="comment">%====================</span>
0558         <span class="keyword">if</span> BPM(plane).mode == 1                                <span class="comment">%BPMs in toggle mode</span>
0559 
0560             <span class="keyword">if</span> isempty(BPM(plane).ifit)     <span class="comment">%no BPMs chosen yet, this is the first one</span>
0561                 BPM(plane).ifit(1) = id;
0562                 setappdata(0,<span class="string">'BPM'</span>,BPM);
0563                 set(b,<span class="string">'MarkerFaceColor'</span>,<span class="string">'g'</span>);
0564                 set(orbfig,<span class="string">'WindowButtonUpFcn'</span>,<span class="string">'bpmgui(''Up'')'</span>);
0565                 <span class="keyword">return</span>
0566             <span class="keyword">end</span>
0567 
0568             <span class="keyword">if</span> ~isempty(find(BPM(plane).ifit == id,1))                   <span class="comment">%BPM presently on for fit</span>
0569                 set(b,<span class="string">'MarkerFaceColor'</span>,<span class="string">'y'</span>);
0570                 BPM(plane).ifit(find(BPM(plane).ifit==id)) = 0;          <span class="comment">%set element in list to zero</span>
0571                 BPM(plane).ifit=BPM(plane).ifit(find(BPM(plane).ifit));  <span class="comment">%compress list</span>
0572                 BPM(plane).ifit=BPM(plane).ifit(:);                      <span class="comment">%create column vector</span>
0573                 setappdata(0,<span class="string">'BPM'</span>,BPM);
0574 
0575             <span class="keyword">elseif</span> isempty(find(BPM(plane).ifit == id, 1)) &amp;&amp; <span class="keyword">...</span>
0576                     ~isempty(find(BPM(plane).avail == id, 1))     <span class="comment">%BPM presently not on for fit</span>
0577                 set(b,<span class="string">'MarkerFaceColor'</span>,<span class="string">'g'</span>);
0578                 t=BPM(plane).ifit(:);
0579 
0580                 <span class="comment">%disp(['ID = ' num2str(id)]);</span>
0581                 t=sort([t; id]);
0582                 BPM(plane).ifit=t;
0583                 setappdata(0,<span class="string">'BPM'</span>,BPM);
0584             <span class="keyword">end</span>
0585             set(orbfig,<span class="string">'WindowButtonUpFcn'</span>,<span class="string">'bpmgui(''Up'')'</span>)
0586 
0587 
0588             <span class="comment">%====================</span>
0589             <span class="comment">%   DRAG MODE</span>
0590             <span class="comment">%====================</span>
0591         <span class="keyword">elseif</span> BPM(plane).mode == 2                                    <span class="comment">%BPMs in drag mode</span>
0592             selectbpm = [<span class="string">'bpmgui(''MoveBPM'','</span> num2str(b) <span class="string">', '</span> num2str(id) <span class="string">');'</span>];
0593             set(orbfig,<span class="string">'WindowButtonMotionFcn'</span>,selectbpm);
0594             set(orbfig,<span class="string">'WindowButtonUpFcn'</span>,<span class="string">'bpmgui(''Up'')'</span>);
0595         <span class="keyword">end</span>    <span class="comment">%...end mode=2 (drag) condition</span>
0596 
0597         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'UpdateBPMBox'</span>);
0598 
0599         <span class="comment">%=============================================================</span>
0600     <span class="keyword">case</span> <span class="string">'MoveBPM'</span>                              <span class="comment">% *** MoveBPM ***</span>
0601         <span class="comment">%=============================================================</span>
0602         <span class="comment">%This function is called each time the user moves the mouse in 'down' mode</span>
0603 
0604         <span class="comment">%reset the y coordinate of the data point on the dashed plot.</span>
0605         <span class="comment">%...plot_ydata = get(SYS.desorb, 'YData');</span>
0606         <span class="comment">%plot_ydata(ind) = pos(1,2);</span>
0607         <span class="comment">%the catch: note bpm tags have index progressing</span>
0608         <span class="comment">%linearly from start to finish independent of status.</span>
0609         <span class="comment">%But plot_ydata has index that skips bpms with bad status.</span>
0610         <span class="comment">%must look for position in status vector of the</span>
0611         <span class="comment">%bpm with index ind as chosen by the drag command.</span>
0612 
0613 <span class="comment">%         b  = varargin{1};</span>
0614         id = varargin{2};  
0615         b  = BPM(plane).hicon(id);    <span class="comment">%doesn't work without this line - round-off?</span>
0616 
0617 
0618         <span class="comment">%reposition icon for BPM</span>
0619         pos = get(SYS.ahbpm, <span class="string">'CurrentPoint'</span>);
0620         yd  = pos(1,2);
0621       
0622         <span class="comment">% Update ans save desired orbit</span>
0623         BPM(plane).des(id) = yd/BPM(plane).scale + BPM(plane).abs(id);
0624         setappdata(0,<span class="string">'BPM'</span>,BPM);
0625 
0626         set(b, <span class="string">'YData'</span>, yd);  <span class="comment">%move the BPM icon to mouse position</span>
0627 
0628         <span class="comment">%re-plot red dotted line (desired orbit)</span>
0629         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotDes'</span>);
0630         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'BPMBar'</span>);
0631         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'UpdateBPMBox'</span>);
0632 
0633 
0634         <span class="comment">%=============================================================</span>
0635     <span class="keyword">case</span> <span class="string">'Up'</span>                                  <span class="comment">% *** Up ***</span>
0636         <span class="comment">%=============================================================</span>
0637         <span class="comment">%mouse button is let up, don't respond to motion</span>
0638         set(orbfig,<span class="string">'WindowButtonMotionFcn'</span>,<span class="string">''</span>,<span class="keyword">...</span>
0639             <span class="string">'WindowButtonUpFcn'</span>,<span class="string">''</span>);
0640         <a href="respgui.html" class="code" title="function respgui(action, varargin)">respgui</a>(<span class="string">'SolveSystem'</span>);
0641         <a href="respgui.html" class="code" title="function respgui(action, varargin)">respgui</a>(<span class="string">'UpdateFit'</span>);
0642         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'UpdateBPMBox'</span>);
0643 
0644         <span class="comment">%=============================================================</span>
0645     <span class="keyword">case</span> <span class="string">'EditDesOrb'</span>                         <span class="comment">%***    EditDesOrb ***</span>
0646         <span class="comment">%=============================================================</span>
0647         h1 = SYS.bpmedit;   <span class="comment">%handle of BPM edit box</span>
0648         <span class="keyword">if</span> isempty(get(SYS.bpmname,<span class="string">'String'</span>))
0649             set(SYS.bpmedit,<span class="string">'String'</span>,num2str(0.0));
0650             <span class="keyword">return</span>;
0651         <span class="keyword">end</span>
0652         id = BPM(plane).id;
0653         b  = findobj(orbfig,<span class="string">'tag'</span>,[<span class="string">'b'</span> num2str(id)]);  <span class="comment">%handle of bpm</span>
0654         offset = str2double(get(h1,<span class="string">'String'</span>));
0655 
0656         <span class="keyword">if</span> isnan(offset) || ~isnumeric(offset) || ~length(offset) == 1
0657             <span class="comment">% flush the bad string out of the edit; replace with current value</span>
0658             offset = 0.0;
0659             set(h1,<span class="string">'String'</span>,num2str(offset));
0660             disp(<span class="string">'Warning: Invalid offset entry.'</span>);
0661             <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'LBox'</span>,<span class="string">'Warning: Invalid offset entry'</span>);
0662         <span class="keyword">end</span>
0663 
0664         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'SetBPMOff'</span>,id,b,offset);
0665 
0666         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0667 
0668         <span class="comment">%=============================================================</span>
0669     <span class="keyword">case</span> <span class="string">'EditBPMWeight'</span>                 <span class="comment">%***    EditBPMWeight ***</span>
0670         <span class="comment">%=============================================================</span>
0671         <span class="comment">%check if no BPM selected</span>
0672         h1 = SYS.editbpmweight;   <span class="comment">%handle of BPM weight edit box</span>
0673         <span class="keyword">if</span> isempty(get(SYS.bpmname,<span class="string">'String'</span>))
0674             set(SYS.editbpmweight,<span class="string">'String'</span>,num2str(1.0));
0675             <span class="keyword">return</span>;
0676         <span class="keyword">end</span>
0677 
0678         id     = BPM(plane).id;
0679 <span class="comment">%         b      = findobj(orbfig,'tag',['b' num2str(id)]);  %handle of bpm</span>
0680         weight = str2double(get(h1,<span class="string">'String'</span>));
0681 
0682         <span class="keyword">if</span> isnan(weight) || ~isnumeric(weight) || ~length(weight) == 1
0683             <span class="comment">% flush the bad string out of the edit; replace with current value</span>
0684             weight = 1.0;
0685             set(h1,<span class="string">'String'</span>,num2str(weight));
0686             disp(<span class="string">'Warning: Invalid weight entry.'</span>);
0687             <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'LBox'</span>,<span class="string">'Warning: Invalid weight entry'</span>);
0688         <span class="keyword">end</span>
0689 
0690         BPM(plane).wt(id) = weight;
0691         setappdata(0,<span class="string">'BPM'</span>,BPM);
0692 
0693         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0694 
0695         <span class="comment">%=============================================================</span>
0696     <span class="keyword">case</span> <span class="string">'SetBPMOff'</span>                         <span class="comment">%***    SetBPMOff ***</span>
0697         <span class="comment">%=============================================================</span>
0698         <span class="comment">%Callback of the BPM offset edit box.</span>
0699         <span class="comment">%resets the dashed red line and BPM icon position.</span>
0700         <span class="comment">%For details, see &quot;BPMmove&quot; above.</span>
0701         <span class="comment">%calling sequence:bpmgui('SetBPMOff',id,b,offset);</span>
0702 
0703         <span class="comment">%identify BPM handle and number</span>
0704         id     = varargin{1}; <span class="comment">%bpm number 'id' comes through varargin</span>
0705         b      = varargin{2}; <span class="comment">%bpm handle 'b' comes through varargin</span>
0706         offset = varargin{3}; <span class="comment">% offset value</span>
0707         
0708         <span class="comment">% update and save BPM</span>
0709         BPM(plane).des(id) = BPM(plane).ref(id)-BPM(plane).abs(id) <span class="keyword">...</span>
0710             + offset/BPM(plane).scale;      
0711         setappdata(0,<span class="string">'BPM'</span>,BPM); 
0712 
0713         <span class="comment">%moves the icon on screen</span>
0714         yd = BPM(plane).des(id);        
0715         set(b,<span class="string">'YData'</span>,yd);   
0716 
0717         <span class="comment">% replot Desired orbit</span>
0718         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotDes'</span>);
0719 
0720         <span class="comment">%=============================================================</span>
0721     <span class="keyword">case</span> <span class="string">'UpdateBPMBox'</span>                     <span class="comment">% *** UpdateBPMBox ***</span>
0722         <span class="comment">%=============================================================</span>
0723         <span class="comment">%update BPMBox</span>
0724         <span class="comment">%called from respgui(SVDSlide),respgui(SVDEdit)</span>
0725         id = BPM(plane).id;
0726         <span class="comment">%check to see if bpm available</span>
0727         <span class="keyword">if</span> isempty(find(BPM(plane).avail == id,1)) <span class="comment">%put fit value in offset box and in request box</span>
0728             <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'BPMBox'</span>,BPM(plane).name(id,:),BPM(plane).act(id),<span class="keyword">...</span>
0729                 0,0,0,0,0,0,id);
0730             <span class="keyword">return</span>;
0731         <span class="keyword">else</span>
0732             <span class="comment">%compute desired offset from reference orbit</span>
0733             offset       = BPM(plane).des(id) - BPM(plane).ref(id);
0734             <span class="comment">%compute predicted fitted value</span>
0735             predictedval = BPM(plane).fit(id) + <span class="keyword">...</span>
0736                 (BPM(plane).act(id) - BPM(plane).abs(id));
0737             <span class="comment">%compute orbit mean</span>
0738             meanV = mean(BPM(plane).act(BPM(plane).status)-BPM(plane).abs(BPM(plane).status));
0739             <span class="comment">%compute orbit rms</span>
0740             rms   = std(BPM(plane).act(BPM(plane).status)-BPM(plane).abs(BPM(plane).status));
0741             <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'BPMBox'</span>,BPM(plane).name(id,:),BPM(plane).act(id),<span class="keyword">...</span>
0742                 BPM(plane).ref(id),offset,BPM(plane).wt(id),BPM(plane).des(id),<span class="keyword">...</span>
0743                 predictedval, meanV, rms, id)
0744         <span class="keyword">end</span>
0745 
0746         <span class="comment">%=============================================================</span>
0747     <span class="keyword">case</span> <span class="string">'BPMBox'</span>                            <span class="comment">% *** BPMBox ***</span>
0748         <span class="comment">%=============================================================</span>
0749         <span class="comment">%bpmgui('BPMBox',BPM(plane).name(id,:),BPM(plane).act(id),...</span>
0750         <span class="comment">%                BPM(plane).ref(id),BPM(plane).des(id),fitval,id);</span>
0751         bpmname   = SYS.bpmname;
0752         actual    = SYS.bpmact;
0753         reference = SYS.bpmref;
0754         offedit   = SYS.bpmedit;
0755         wtedit    = SYS.editbpmweight;
0756         desire    = SYS.bpmdes;
0757         measval   = SYS.bpmmeas;
0758         rmsval    = SYS.bpmrms;
0759         meanval   = SYS.bpmmean;
0760 
0761         name = varargin{1};
0762         act  = varargin{2};
0763         ref  = varargin{3};
0764         off  = varargin{4};
0765         wt   = varargin{5};
0766         des  = varargin{6};
0767         meas = varargin{7};
0768         meanV= varargin{8};
0769         rms  = varargin{9};
0770         id   = varargin{10};
0771 
0772         <span class="comment">% conversion in device list</span>
0773         dev = elem2dev(BPM(plane).AOFamily,id);
0774         
0775         set(bpmname,  <span class="string">'String'</span>,[name <span class="string">'  ['</span>,num2str(dev(1)),<span class="string">' '</span>, <span class="keyword">...</span>
0776             num2str(dev(2)),<span class="string">']'</span>]);
0777         set(actual,   <span class="string">'String'</span>,num2str(act*BPM(plane).scale,  <span class="string">'%6.3f'</span>));
0778         set(reference,<span class="string">'String'</span>,num2str(ref*BPM(plane).scale,  <span class="string">'%6.3f'</span>));
0779         set(offedit,  <span class="string">'String'</span>,num2str(off*BPM(plane).scale,  <span class="string">'%6.3f'</span>));
0780         set(wtedit,   <span class="string">'String'</span>,num2str(wt,                    <span class="string">'%6.3f'</span>));
0781         set(desire,   <span class="string">'String'</span>,num2str(des*BPM(plane).scale,  <span class="string">'%6.3f'</span>));
0782         set(measval,  <span class="string">'String'</span>,num2str(meas*BPM(plane).scale, <span class="string">'%6.3f'</span>));
0783         set(rmsval,   <span class="string">'String'</span>,num2str(rms*BPM(plane).scale,  <span class="string">'%6.3f'</span>));
0784         set(meanval,  <span class="string">'String'</span>,num2str(meanV*BPM(plane).scale,<span class="string">'%6.3f'</span>));
0785         set(offedit,  <span class="string">'UserData'</span>,id);
0786 
0787         <span class="comment">%=============================================================</span>
0788     <span class="keyword">case</span> <span class="string">'RePlot'</span>                                 <span class="comment">% *** RePlot ***</span>
0789         <span class="comment">%=============================================================</span>
0790         <span class="comment">%plot reference, desired, actual, icons</span>
0791         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0792         <span class="comment">%could replace these calls with PlotRef, PlotAct, etc</span>
0793 
0794         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotRef'</span>);
0795         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotDes'</span>);
0796         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotAct'</span>);
0797         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotFit'</span>);
0798         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'PlotBPMs'</span>);  <span class="comment">%plots icons</span>
0799         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'ylimits'</span>);
0800         <a href="bpmgui.html" class="code" title="function bpmgui(action, varargin)">bpmgui</a>(<span class="string">'BPMBar'</span>);
0801 
0802         <span class="comment">%==========================================================</span>
0803     <span class="keyword">case</span> <span class="string">'ClearPlots'</span>                        <span class="comment">%...ClearPlots</span>
0804         <span class="comment">%==========================================================</span>
0805         <span class="comment">%clear columns of response matrix, orbit-eigenvectors and fit plots.</span>
0806 
0807         set(orbfig,<span class="string">'currentaxes'</span>,SYS.ahbpm)
0808         set(SYS.lhrsp,<span class="string">'XData'</span>,[],<span class="string">'YData'</span>,[]);
0809         set(SYS.lheig,<span class="string">'XData'</span>,[],<span class="string">'YData'</span>,[]);
0810         set(SYS.lhfit,<span class="string">'XData'</span>,[],<span class="string">'YData'</span>,[]);
0811 
0812         <span class="comment">%=============================================================</span>
0813     <span class="keyword">case</span> <span class="string">'SelectAll'</span>                           <span class="comment">% *** SelectAll ***</span>
0814         <span class="comment">%============================================================</span>
0815         BPM(plane).ifit=[];
0816         navail = length(BPM(plane).avail);
0817         
0818         set(BPM(plane).hicon(BPM(plane).avail),<span class="string">'MarkerFaceColor'</span>,<span class="string">'g'</span>);
0819         
0820         BPM(plane).ifit(1:navail) = BPM(plane).avail(1:navail);
0821         
0822         
0823 <span class="comment">%         for kk = 1:navail</span>
0824 <span class="comment">%             k    = BPM(plane).avail(kk);</span>
0825 <span class="comment">%             hbpm = BPM(plane).hicon(k);;</span>
0826 <span class="comment">%             set(hbpm,'MarkerFaceColor','g');</span>
0827 <span class="comment">%             BPM(plane).ifit(kk) = k;</span>
0828 <span class="comment">%         end</span>
0829 
0830         setappdata(0,<span class="string">'BPM'</span>,BPM);
0831 
0832         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0833 
0834         <span class="comment">%=============================================================</span>
0835     <span class="keyword">case</span> <span class="string">'SelectNone'</span>                           <span class="comment">% *** SelectNone ***</span>
0836         <span class="comment">%=============================================================</span>
0837         BPM(plane).ifit = [];
0838         
0839         set(BPM(plane).hicon(BPM(plane).avail),<span class="string">'MarkerFaceColor'</span>,<span class="string">'y'</span>);
0840                 
0841 <span class="comment">%         navail          = length(BPM(plane).avail);</span>
0842 <span class="comment">%         for kk = 1:navail</span>
0843 <span class="comment">%             k    = BPM(plane).avail(kk);</span>
0844 <span class="comment">%             hbpm = BPM(plane).hicon(k);</span>
0845 <span class="comment">%             set(hbpm,'MarkerFaceColor','y');</span>
0846 <span class="comment">%         end</span>
0847 
0848         setappdata(0,<span class="string">'BPM'</span>,BPM);
0849 
0850         <a href="orbgui.html" class="code" title="function varargout = orbgui(action, varargin)">orbgui</a>(<span class="string">'RefreshOrbGUI'</span>);
0851 
0852         <span class="comment">%respgui('FitOff',num2str(plane));</span>
0853 
0854         <span class="comment">%==========================================================</span>
0855     <span class="keyword">case</span> <span class="string">'ToggleMode'</span>                      <span class="comment">% *** ToggleMode ***</span>
0856         <span class="comment">%==========================================================</span>
0857         <span class="comment">%callback of the bpm toggle radio button</span>
0858         <span class="comment">%radio button toggles state and then executes callback</span>
0859         <span class="comment">%hence, this routine finds the new state</span>
0860 
0861         <span class="keyword">if</span> get(SYS.togglebpm,<span class="string">'Value'</span>) == 0 &amp;&amp;  <span class="keyword">...</span>
0862                 get(SYS.dragbpm,<span class="string">'Value'</span>) == 0
0863             BPM(plane).mode = 0;           <span class="comment">%'0' for display only</span>
0864         <span class="keyword">else</span>
0865             set(SYS.dragbpm,<span class="string">'Value'</span>,0);
0866             BPM(plane).mode = 1;           <span class="comment">%'1' for toggle mode</span>
0867         <span class="keyword">end</span>
0868 
0869         setappdata(0,<span class="string">'BPM'</span>,BPM);
0870 
0871         <span class="comment">%==========================================================</span>
0872     <span class="keyword">case</span> <span class="string">'DragMode'</span>                          <span class="comment">% *** DragMode ***</span>
0873         <span class="comment">%==========================================================</span>
0874         <span class="comment">%callback of the bpm drag radio button</span>
0875         <span class="comment">%radio button toggles state and then executes callback</span>
0876         <span class="comment">%hence, this routine finds the new state</span>
0877 
0878         <span class="keyword">if</span> get(SYS.togglebpm,<span class="string">'Value'</span>) == 0 &amp;&amp;  <span class="keyword">...</span>
0879                 get(SYS.dragbpm,<span class="string">'Value'</span>) == 0
0880             BPM(plane).mode = 0;           <span class="comment">%'0' for display only</span>
0881         <span class="keyword">else</span>
0882             set(SYS.togglebpm,<span class="string">'Value'</span>,0);
0883             BPM(plane).mode = 2;           <span class="comment">%'2' for drag mode</span>
0884         <span class="keyword">end</span>
0885 
0886         setappdata(0,<span class="string">'BPM'</span>,BPM);
0887 
0888         <span class="comment">%===========================================================</span>
0889     <span class="keyword">case</span> <span class="string">'ShowBPMState'</span>                    <span class="comment">%*** ShowBPMState ***</span>
0890         <span class="comment">%===========================================================</span>
0891         <span class="comment">% Show bpm settings</span>
0892         len = size(BPM(plane).name,1);
0893         tavail  = zeros(len,1);
0894         tfit    = zeros(len,1);
0895         tstatus = zeros(len,1);
0896       
0897         idx = intersect(BPM(plane).avail,1:len);
0898         tavail(idx) = idx;
0899         idx = intersect(BPM(plane).ifit,1:len);
0900         tfit(idx) = idx;
0901         idx = intersect(BPM(plane).status,1:len);
0902         tstatus(idx) = idx;
0903       
0904 <span class="comment">%         tic</span>
0905 <span class="comment">%         for ii = 1:size(BPM(plane).name,1)</span>
0906 <span class="comment">%             if ~isempty(find(BPM(plane).avail == ii))  tavail(ii)  = ii;  end</span>
0907 <span class="comment">%             if ~isempty(find(BPM(plane).ifit == ii))   tfit(ii)    = ii;  end</span>
0908 <span class="comment">%             if ~isempty(find(BPM(plane).status == ii)) tstatus(ii) = ii;  end</span>
0909 <span class="comment">%         end</span>
0910 <span class="comment">%         toc</span>
0911 
0912         ref  = BPM(plane).ref;
0913         des  = BPM(plane).des;
0914         babs = BPM(plane).abs;
0915         act  = BPM(plane).act;
0916         fit  = BPM(plane).fit;
0917         wt   = BPM(plane).wt;
0918 
0919         <span class="comment">%%% BUILD UP CELL TO DISPLAY</span>
0920         ivec = (1:len)';        
0921         Strcell = cell(11,len);
0922         Strcell(1,:) = num2cell(ivec);
0923         Strcell(2,:) = cellstr(BPM(plane).name(ivec,:))';
0924         Strcell(3:<span class="keyword">end</span>,:) = num2cell([tstatus(ivec),tavail(ivec),tfit(ivec),ref(ivec), <span class="keyword">...</span>
0925             des(ivec),babs(ivec),act(ivec),fit(ivec),wt(ivec) ])';
0926         
0927         <span class="comment">%% Speed issue</span>
0928         <span class="comment">% in a workspace : 2.3s</span>
0929         <span class="comment">% in a file : 0.04s</span>
0930         <span class="comment">% in a file and edit in matlab : 0.5s first time then 0.1</span>
0931         <span class="comment">% in a file and edit in nedit  : 0.06s</span>
0932         
0933         filename = [SYS.localdata <span class="string">'bpmdata.txt'</span>];
0934         fid = fopen(filename,<span class="string">'w'</span>);
0935         fprintf(fid,<span class="string">'%s\n'</span>,<span class="string">'index    name    stat  avail  ifit     ref        des          abs       act         fit       weight'</span>);
0936         fprintf(fid,<span class="string">'%3d %10s %5d %5d %5d %10.3f %10.3f %12.3f %10.3f %10.3f %10.3f\n'</span>,<span class="keyword">...</span>
0937             Strcell{:});
0938         fclose(fid)
0939         <span class="comment">% edit 'bpmdata.txt'</span>
0940         system([<span class="string">'nedit '</span>, filename, <span class="string">' &amp;'</span>]);  <span class="comment">% much faster</span>
0941             
0942 <span class="comment">%             tic</span>
0943 <span class="comment">%         for ii = 1:size(BPM(plane).name,1)</span>
0944 <span class="comment">%             fprintf(0,'%3d %10s %5d %5d %5d %10.3f %10.3f %12.3f %10.3f %10.3f %10.3f\n',...</span>
0945 <span class="comment">%                 ii, BPM(plane).name(ii,:),tstatus(ii),tavail(ii),tfit(ii),ref(ii), ...</span>
0946 <span class="comment">%                 des(ii),babs(ii),act(ii),fit(ii),wt(ii));</span>
0947 <span class="comment">%         end</span>
0948 <span class="comment">%         toc</span>
0949         <span class="comment">%===========================================================</span>
0950     <span class="keyword">otherwise</span>
0951         disp([<span class="string">'Warning: no CASE found in bpmgui: '</span> action]);
0952 <span class="keyword">end</span>  <span class="comment">%end switchyard</span></pre></div>
<hr><address>Generated on Mon 21-May-2007 15:32:41 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>